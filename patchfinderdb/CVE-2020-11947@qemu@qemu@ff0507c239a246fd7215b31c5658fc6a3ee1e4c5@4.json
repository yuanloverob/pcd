{
  "cve_id": "CVE-2020-11947",
  "cve_desc": "iscsi_aio_ioctl_cb in block/iscsi.c in QEMU 4.1.0 has a heap-based buffer over-read that may disclose unrelated information from process memory to an attacker.",
  "repo": "qemu/qemu",
  "patch_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
  "patch_info": {
    "commit_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "files": [
      "block/iscsi.c"
    ],
    "message": "block/iscsi:fix heap-buffer-overflow in iscsi_aio_ioctl_cb\n\nThere is an overflow, the source 'datain.data[2]' is 100 bytes,\n but the 'ss' is 252 bytes.This may cause a security issue because\n we can access a lot of unrelated memory data.\n\nThe len for sbp copy data should take the minimum of mx_sb_len and\n sb_len_wr, not the maximum.\n\nIf we use iscsi device for VM backend storage, ASAN show stack:\n\nREAD of size 252 at 0xfffd149dcfc4 thread T0\n    #0 0xaaad433d0d34 in __asan_memcpy (aarch64-softmmu/qemu-system-aarch64+0x2cb0d34)\n    #1 0xaaad45f9d6d0 in iscsi_aio_ioctl_cb /qemu/block/iscsi.c:996:9\n    #2 0xfffd1af0e2dc  (/usr/lib64/iscsi/libiscsi.so.8+0xe2dc)\n    #3 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #4 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #5 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #6 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #7 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #8 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #9 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #10 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #11 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #12 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #13 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #14 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #15 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #16 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #17 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\n0xfffd149dcfc4 is located 0 bytes to the right of 100-byte region [0xfffd149dcf60,0xfffd149dcfc4)\nallocated by thread T0 here:\n    #0 0xaaad433d1e70 in __interceptor_malloc (aarch64-softmmu/qemu-system-aarch64+0x2cb1e70)\n    #1 0xfffd1af0e254  (/usr/lib64/iscsi/libiscsi.so.8+0xe254)\n    #2 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #3 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #4 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #5 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #6 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #7 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #8 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #9 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #10 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #11 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #12 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #13 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #14 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #15 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #16 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Chen Qun <kuhn.chenqun@huawei.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nMessage-id: 20200418062602.10776-1-kuhn.chenqun@huawei.com\nReviewed-by: Daniel P. Berrang\u00e9 <berrange@redhat.com>\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
    "before_after_code_files": [
      "block/iscsi.c||block/iscsi.c"
    ]
  },
  "patch_diff": {
    "block/iscsi.c||block/iscsi.c": [
      "File: block/iscsi.c -> block/iscsi.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "991:         acb->ioh->driver_status |= SG_ERR_DRIVER_SENSE;",
      "993:         acb->ioh->sb_len_wr = acb->task->datain.size - 2;",
      "996:         memcpy(acb->ioh->sbp, &acb->task->datain.data[2], ss);",
      "997:     }",
      "",
      "[Removed Lines]",
      "994:         ss = (acb->ioh->mx_sb_len >= acb->ioh->sb_len_wr) ?",
      "995:              acb->ioh->mx_sb_len : acb->ioh->sb_len_wr;",
      "",
      "[Added Lines]",
      "994:         ss = MIN(acb->ioh->mx_sb_len, acb->ioh->sb_len_wr);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9b6abdcfae4401f8078f883d6eca6463c0bfbd68",
      "candidate_info": {
        "commit_hash": "9b6abdcfae4401f8078f883d6eca6463c0bfbd68",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/9b6abdcfae4401f8078f883d6eca6463c0bfbd68",
        "files": [
          "qom/qom-qmp-cmds.c"
        ],
        "message": "qom-qmp-cmds: fix two memleaks in qmp_object_add\n\n'type/id' forgot to free in qmp_object_add, this patch fix that.\n\nThe leak stack:\nDirect leak of 84 byte(s) in 6 object(s) allocated from:\n    #0 0x7fe2a5ebf768 in __interceptor_malloc (/lib64/libasan.so.5+0xef768)\n    #1 0x7fe2a5044445 in g_malloc (/lib64/libglib-2.0.so.0+0x52445)\n    #2 0x7fe2a505dd92 in g_strdup (/lib64/libglib-2.0.so.0+0x6bd92)\n    #3 0x56344954e692 in qmp_object_add /mnt/sdb/qemu-new/qemu_test/qemu/qom/qom-qmp-cmds.c:258\n    #4 0x563449960f5a in do_qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qmp-dispatch.c:132\n    #5 0x563449960f5a in qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qmp-dispatch.c:175\n    #6 0x563449498a30 in monitor_qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/monitor/qmp.c:145\n    #7 0x56344949a64f in monitor_qmp_bh_dispatcher /mnt/sdb/qemu-new/qemu_test/qemu/monitor/qmp.c:234\n    #8 0x563449a92a3a in aio_bh_call /mnt/sdb/qemu-new/qemu_test/qemu/util/async.c:136\n\nDirect leak of 54 byte(s) in 6 object(s) allocated from:\n    #0 0x7fe2a5ebf768 in __interceptor_malloc (/lib64/libasan.so.5+0xef768)\n    #1 0x7fe2a5044445 in g_malloc (/lib64/libglib-2.0.so.0+0x52445)\n    #2 0x7fe2a505dd92 in g_strdup (/lib64/libglib-2.0.so.0+0x6bd92)\n    #3 0x56344954e6c4 in qmp_object_add /mnt/sdb/qemu-new/qemu_test/qemu/qom/qom-qmp-cmds.c:267\n    #4 0x563449960f5a in do_qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qmp-dispatch.c:132\n    #5 0x563449960f5a in qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qmp-dispatch.c:175\n    #6 0x563449498a30 in monitor_qmp_dispatch /mnt/sdb/qemu-new/qemu_test/qemu/monitor/qmp.c:145\n    #7 0x56344949a64f in monitor_qmp_bh_dispatcher /mnt/sdb/qemu-new/qemu_test/qemu/monitor/qmp.c:234\n    #8 0x563449a92a3a in aio_bh_call /mnt/sdb/qemu-new/qemu_test/qemu/util/async.c:136\n\nFixes: 5f07c4d60d091320186e7b0edaf9ed2cc16b2d1e\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nMessage-Id: <20200310064640.5059-1-pannengyuan@huawei.com>\nReviewed-by: Daniel P. Berrang\u00e9 <berrange@redhat.com>\nAcked-by: Igor Mammedov <imammedo@redhat.com>\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>",
        "before_after_code_files": [
          "qom/qom-qmp-cmds.c||qom/qom-qmp-cmds.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "qom/qom-qmp-cmds.c||qom/qom-qmp-cmds.c": [
          "File: qom/qom-qmp-cmds.c -> qom/qom-qmp-cmds.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:     QDict *pdict;",
          "248:     Visitor *v;",
          "249:     Object *obj;",
          "254:     if (!type) {",
          "255:         error_setg(errp, QERR_MISSING_PARAMETER, \"qom-type\");",
          "256:         return;",
          "260:     }",
          "263:     if (!id) {",
          "264:         error_setg(errp, QERR_MISSING_PARAMETER, \"id\");",
          "265:         return;",
          "269:     }",
          "271:     props = qdict_get(qdict, \"props\");",
          "272:     if (props) {",
          "",
          "[Removed Lines]",
          "250:     const char *type;",
          "251:     const char *id;",
          "253:     type = qdict_get_try_str(qdict, \"qom-type\");",
          "257:     } else {",
          "258:         type = g_strdup(type);",
          "259:         qdict_del(qdict, \"qom-type\");",
          "262:     id = qdict_get_try_str(qdict, \"id\");",
          "266:     } else {",
          "267:         id = g_strdup(id);",
          "268:         qdict_del(qdict, \"id\");",
          "",
          "[Added Lines]",
          "250:     g_autofree char *type = NULL;",
          "251:     g_autofree char *id = NULL;",
          "253:     type = g_strdup(qdict_get_try_str(qdict, \"qom-type\"));",
          "258:     qdict_del(qdict, \"qom-type\");",
          "260:     id = g_strdup(qdict_get_try_str(qdict, \"id\"));",
          "265:     qdict_del(qdict, \"id\");",
          "",
          "---------------"
        ]
      }
    }
  ]
}