{
  "cve_id": "CVE-2021-29568",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can trigger undefined behavior by binding to null pointer in `tf.raw_ops.ParameterizedTruncatedNormal`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/3f6fe4dfef6f57e768260b48166c27d148f3015f/tensorflow/core/kernels/parameterized_truncated_normal_op.cc#L630) does not validate input arguments before accessing the first element of `shape`. If `shape` argument is empty, then `shape_tensor.flat<T>()` is an empty array. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "5e52ef5a461570cfb68f3bdbbebfe972cb4e0fd8",
  "patch_info": {
    "commit_hash": "5e52ef5a461570cfb68f3bdbbebfe972cb4e0fd8",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/5e52ef5a461570cfb68f3bdbbebfe972cb4e0fd8",
    "files": [
      "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
    ],
    "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
    "before_after_code_files": [
      "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
      "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "627:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
      "628:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
      "629:                                 shape_tensor.shape().DebugString()));",
      "630:     int32 num_batches = shape_tensor.flat<int32>()(0);",
      "632:     int32 samples_per_batch = 1;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "630:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
      "631:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
      "632:                                         shape_tensor.DebugString()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c3f314e584f26c7e608598ee9ad555aeedbeeb79",
      "candidate_info": {
        "commit_hash": "c3f314e584f26c7e608598ee9ad555aeedbeeb79",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c3f314e584f26c7e608598ee9ad555aeedbeeb79",
        "files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ],
        "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
        "before_after_code_files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "627:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
          "628:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
          "629:                                 shape_tensor.shape().DebugString()));",
          "630:     int32 num_batches = shape_tensor.flat<int32>()(0);",
          "632:     int32 samples_per_batch = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "630:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
          "631:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
          "632:                                         shape_tensor.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e458c49d3f9251dd0da911984598d063afb8a803",
      "candidate_info": {
        "commit_hash": "e458c49d3f9251dd0da911984598d063afb8a803",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e458c49d3f9251dd0da911984598d063afb8a803",
        "files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ],
        "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
        "before_after_code_files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "336:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
          "337:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
          "338:                                 shape_tensor.shape().DebugString()));",
          "339:     int32 num_batches = shape_tensor.flat<int32>()(0);",
          "341:     int32 samples_per_batch = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "339:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
          "340:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
          "341:                                         shape_tensor.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "46db3e762066c4154d6aafecfb5543382c4ea4a5",
      "candidate_info": {
        "commit_hash": "46db3e762066c4154d6aafecfb5543382c4ea4a5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/46db3e762066c4154d6aafecfb5543382c4ea4a5",
        "files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ],
        "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
        "before_after_code_files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "627:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
          "628:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
          "629:                                 shape_tensor.shape().DebugString()));",
          "630:     int32 num_batches = shape_tensor.flat<int32>()(0);",
          "632:     int32 samples_per_batch = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "630:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
          "631:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
          "632:                                         shape_tensor.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ff3eb559c89a7c5be081699abc179a6bfd0a88fb",
      "candidate_info": {
        "commit_hash": "ff3eb559c89a7c5be081699abc179a6bfd0a88fb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ff3eb559c89a7c5be081699abc179a6bfd0a88fb",
        "files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ],
        "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
        "before_after_code_files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "336:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
          "337:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
          "338:                                 shape_tensor.shape().DebugString()));",
          "339:     int32 num_batches = shape_tensor.flat<int32>()(0);",
          "341:     int32 samples_per_batch = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "339:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
          "340:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
          "341:                                         shape_tensor.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "65d8727e10873e9862b0fa9e8097b76804804a52",
      "candidate_info": {
        "commit_hash": "65d8727e10873e9862b0fa9e8097b76804804a52",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/65d8727e10873e9862b0fa9e8097b76804804a52",
        "files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ],
        "message": "Fix breakage in parameterized_truncated_normal_op.cc\n\nPiperOrigin-RevId: 372041718\nChange-Id: Iff79e77a2bb27032423eefcb84211627b27dfe81",
        "before_after_code_files": [
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "627:         ctx, TensorShapeUtils::IsVector(shape_tensor.shape()),",
          "628:         errors::InvalidArgument(\"Input shape should be a vector, got shape: \",",
          "629:                                 shape_tensor.shape().DebugString()));",
          "630:     int32 num_batches = shape_tensor.flat<int32>()(0);",
          "632:     int32 samples_per_batch = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "630:     OP_REQUIRES(ctx, shape_tensor.NumElements() > 0,",
          "631:                 errors::InvalidArgument(\"Shape tensor must not be empty, got \",",
          "632:                                         shape_tensor.DebugString()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}