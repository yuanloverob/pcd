{
  "cve_id": "CVE-2019-11935",
  "cve_desc": "Insufficient boundary checks when processing a string in mb_ereg_replace allows access to out-of-bounds memory. This issue affects HHVM versions prior to 3.30.12, all versions between 4.0.0 and 4.8.5, all versions between 4.9.0 and 4.23.1, as well as 4.24.0, 4.25.0, 4.26.0, 4.27.0, 4.28.0, and 4.28.1.",
  "repo": "facebook/hhvm",
  "patch_hash": "1c518555dba6ceb45d5ba61845b96e261219c3b7",
  "patch_info": {
    "commit_hash": "1c518555dba6ceb45d5ba61845b96e261219c3b7",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/1c518555dba6ceb45d5ba61845b96e261219c3b7",
    "files": [
      "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
      "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
    ],
    "message": "Fix buffer overflow in mb_ereg_replace\n\nSummary:\nThis diff has already been landed to release and to open-source branches. We're now landing it on master.\n\nCVE-2019-11935\n\nReviewed By: jjergus\n\nDifferential Revision: D18177934\n\nfbshipit-source-id: d108a59e38c67f5f5e835febd7255307605ba62c",
    "before_after_code_files": [
      "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
      "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
    ]
  },
  "patch_diff": {
    "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
      "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "3609:       while (i < replacement.size()) {",
      "3610:         int fwd = (int)php_mb_mbchar_bytes_ex(p, enc);",
      "3611:         n = -1;",
      "3614:           n = p[1] - '0';",
      "3615:         }",
      "3616:         if (n >= 0 && n < regs->num_regs) {",
      "",
      "[Removed Lines]",
      "3612:         if ((replacement.size() - i) >= 2 && fwd == 1 &&",
      "3613:           p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
      "",
      "[Added Lines]",
      "3612:         auto const remaining = replacement.size() - i;",
      "3613:         if (remaining >= 2 && fwd == 1 &&",
      "3614:             p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3621:           }",
      "3622:           p += 2;",
      "3623:           i += 2;",
      "3625:           out_buf.append(p, fwd);",
      "3626:           p += fwd;",
      "3627:           i += fwd;",
      "3628:         }",
      "3629:       }",
      "3630:       n = regs->end[0];",
      "",
      "[Removed Lines]",
      "3624:         } else {",
      "",
      "[Added Lines]",
      "3625:         } else if (remaining >= fwd) {",
      "3629:         } else {",
      "3630:           raise_warning(\"Replacement ends with unterminated %s: 0x%hhx\",",
      "3631:                         enc->name, *p);",
      "3632:           break;",
      "",
      "---------------"
    ],
    "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php": [
      "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?hh",
      "3: <<__EntryPoint>>",
      "4: function main(): void {",
      "5:   var_dump(mb_ereg_replace(\"\", \"\\xf1\", \"\", \"\"));",
      "6:   throw new Error(\"done\");",
      "7: }",
      "",
      "---------------"
    ],
    "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf": [
      "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: Warning: Replacement ends with unterminated UTF-8: 0xf1 in %s/mb_ereg_replace_invalid_replacement.php on line 5",
      "2: string(0) \"\"",
      "4: Fatal error: Uncaught Error: done in %s/mb_ereg_replace_invalid_replacement.php:6",
      "5: Stack trace:",
      "6: #0 (): main()",
      "7: #1 {main}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "54da225e098810fc8fc35e778c513bd9593c3d0d",
      "candidate_info": {
        "commit_hash": "54da225e098810fc8fc35e778c513bd9593c3d0d",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/54da225e098810fc8fc35e778c513bd9593c3d0d",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ],
        "message": "Fix buffer overflow in mb_ereg_replace\n\nSummary:\nWarn and return early when we discover that our replacement is invalid (given the specified encoding).\n\nCVE-2019-11935\n\nReviewed By: DhavalKapil\n\nDifferential Revision: D17653294",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3610:       while (i < replacement.size()) {",
          "3611:         int fwd = (int)php_mb_mbchar_bytes_ex(p, enc);",
          "3612:         n = -1;",
          "3615:           n = p[1] - '0';",
          "3616:         }",
          "3617:         if (n >= 0 && n < regs->num_regs) {",
          "",
          "[Removed Lines]",
          "3613:         if ((replacement.size() - i) >= 2 && fwd == 1 &&",
          "3614:           p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "[Added Lines]",
          "3613:         auto const remaining = replacement.size() - i;",
          "3614:         if (remaining >= 2 && fwd == 1 &&",
          "3615:             p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3622:           }",
          "3623:           p += 2;",
          "3624:           i += 2;",
          "3626:           out_buf.append(p, fwd);",
          "3627:           p += fwd;",
          "3628:           i += fwd;",
          "3629:         }",
          "3630:       }",
          "3631:       n = regs->end[0];",
          "",
          "[Removed Lines]",
          "3625:         } else {",
          "",
          "[Added Lines]",
          "3626:         } else if (remaining >= fwd) {",
          "3630:         } else {",
          "3631:           raise_warning(\"Replacement ends with unterminated %s: 0x%hhx\",",
          "3632:                         enc->name, *p);",
          "3633:           break;",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main(): void {",
          "5:   var_dump(mb_ereg_replace(\"\", \"\\xf1\", \"\", \"\"));",
          "6:   throw new Error(\"done\");",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Replacement ends with unterminated UTF-8: 0xf1 in %s/mb_ereg_replace_invalid_replacement.php on line 5",
          "2: string(0) \"\"",
          "4: Fatal error: Uncaught Error: done in %s/mb_ereg_replace_invalid_replacement.php:6",
          "5: Stack trace:",
          "6: #0 (): main()",
          "7: #1 {main}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5bbd04560b44d17d7f6f60b5e6787f5a291e9d91",
      "candidate_info": {
        "commit_hash": "5bbd04560b44d17d7f6f60b5e6787f5a291e9d91",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/5bbd04560b44d17d7f6f60b5e6787f5a291e9d91",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ],
        "message": "Fix buffer overflow in mb_ereg_replace\n\nSummary:\nWarn and return early when we discover that our replacement is invalid (given the specified encoding).\n\nCVE-2019-11935\n\nReviewed By: DhavalKapil\n\nDifferential Revision: D17653294",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3611:       while (i < replacement.size()) {",
          "3612:         int fwd = (int)php_mb_mbchar_bytes_ex(p, enc);",
          "3613:         n = -1;",
          "3616:           n = p[1] - '0';",
          "3617:         }",
          "3618:         if (n >= 0 && n < regs->num_regs) {",
          "",
          "[Removed Lines]",
          "3614:         if ((replacement.size() - i) >= 2 && fwd == 1 &&",
          "3615:           p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "[Added Lines]",
          "3614:         auto const remaining = replacement.size() - i;",
          "3615:         if (remaining >= 2 && fwd == 1 &&",
          "3616:             p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3623:           }",
          "3624:           p += 2;",
          "3625:           i += 2;",
          "3627:           out_buf.append(p, fwd);",
          "3628:           p += fwd;",
          "3629:           i += fwd;",
          "3630:         }",
          "3631:       }",
          "3632:       n = regs->end[0];",
          "",
          "[Removed Lines]",
          "3626:         } else {",
          "",
          "[Added Lines]",
          "3627:         } else if (remaining >= fwd) {",
          "3631:         } else {",
          "3632:           raise_warning(\"Replacement ends with unterminated %s: 0x%hhx\",",
          "3633:                         enc->name, *p);",
          "3634:           break;",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main(): void {",
          "5:   var_dump(mb_ereg_replace(\"\", \"\\xf1\", \"\", \"\"));",
          "6:   throw new Error(\"done\");",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Replacement ends with unterminated UTF-8: 0xf1 in %s/mb_ereg_replace_invalid_replacement.php on line 5",
          "2: string(0) \"\"",
          "4: Fatal error: Uncaught Error: done in %s/mb_ereg_replace_invalid_replacement.php:6",
          "5: Stack trace:",
          "6: #0 (): main()",
          "7: #1 {main}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c477212bc2a8c9b9d889282e079ea4698cbc9986",
      "candidate_info": {
        "commit_hash": "c477212bc2a8c9b9d889282e079ea4698cbc9986",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/c477212bc2a8c9b9d889282e079ea4698cbc9986",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ],
        "message": "Fix buffer overflow in mb_ereg_replace\n\nSummary:\nWarn and return early when we discover that our replacement is invalid (given the specified encoding).\n\nCVE-2019-11935\n\nReviewed By: DhavalKapil\n\nDifferential Revision: D17653294",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3609:       while (i < replacement.size()) {",
          "3610:         int fwd = (int)php_mb_mbchar_bytes_ex(p, enc);",
          "3611:         n = -1;",
          "3614:           n = p[1] - '0';",
          "3615:         }",
          "3616:         if (n >= 0 && n < regs->num_regs) {",
          "",
          "[Removed Lines]",
          "3612:         if ((replacement.size() - i) >= 2 && fwd == 1 &&",
          "3613:           p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "[Added Lines]",
          "3612:         auto const remaining = replacement.size() - i;",
          "3613:         if (remaining >= 2 && fwd == 1 &&",
          "3614:             p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3621:           }",
          "3622:           p += 2;",
          "3623:           i += 2;",
          "3625:           out_buf.append(p, fwd);",
          "3626:           p += fwd;",
          "3627:           i += fwd;",
          "3628:         }",
          "3629:       }",
          "3630:       n = regs->end[0];",
          "",
          "[Removed Lines]",
          "3624:         } else {",
          "",
          "[Added Lines]",
          "3625:         } else if (remaining >= fwd) {",
          "3629:         } else {",
          "3630:           raise_warning(\"Replacement ends with unterminated %s: 0x%hhx\",",
          "3631:                         enc->name, *p);",
          "3632:           break;",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main(): void {",
          "5:   var_dump(mb_ereg_replace(\"\", \"\\xf1\", \"\", \"\"));",
          "6:   throw new Error(\"done\");",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Replacement ends with unterminated UTF-8: 0xf1 in %s/mb_ereg_replace_invalid_replacement.php on line 5",
          "2: string(0) \"\"",
          "4: Fatal error: Uncaught Error: done in %s/mb_ereg_replace_invalid_replacement.php:6",
          "5: Stack trace:",
          "6: #0 (): main()",
          "7: #1 {main}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "af53be5cffb7d23ff33e4eb2842364c137954881",
      "candidate_info": {
        "commit_hash": "af53be5cffb7d23ff33e4eb2842364c137954881",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/af53be5cffb7d23ff33e4eb2842364c137954881",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ],
        "message": "Fix buffer overflow in mb_ereg_replace\n\nSummary:\nWarn and return early when we discover that our replacement is invalid (given the specified encoding).\n\nCVE-2019-11935\n\nReviewed By: DhavalKapil\n\nDifferential Revision: D17653294",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
            "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3609:       while (i < replacement.size()) {",
          "3610:         int fwd = (int)php_mb_mbchar_bytes_ex(p, enc);",
          "3611:         n = -1;",
          "3614:           n = p[1] - '0';",
          "3615:         }",
          "3616:         if (n >= 0 && n < regs->num_regs) {",
          "",
          "[Removed Lines]",
          "3612:         if ((replacement.size() - i) >= 2 && fwd == 1 &&",
          "3613:           p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "[Added Lines]",
          "3612:         auto const remaining = replacement.size() - i;",
          "3613:         if (remaining >= 2 && fwd == 1 &&",
          "3614:             p[0] == '\\\\' && p[1] >= '0' && p[1] <= '9') {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3621:           }",
          "3622:           p += 2;",
          "3623:           i += 2;",
          "3625:           out_buf.append(p, fwd);",
          "3626:           p += fwd;",
          "3627:           i += fwd;",
          "3628:         }",
          "3629:       }",
          "3630:       n = regs->end[0];",
          "",
          "[Removed Lines]",
          "3624:         } else {",
          "",
          "[Added Lines]",
          "3625:         } else if (remaining >= fwd) {",
          "3629:         } else {",
          "3630:           raise_warning(\"Replacement ends with unterminated %s: 0x%hhx\",",
          "3631:                         enc->name, *p);",
          "3632:           break;",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main(): void {",
          "5:   var_dump(mb_ereg_replace(\"\", \"\\xf1\", \"\", \"\"));",
          "6:   throw new Error(\"done\");",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf||hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf": [
          "File: hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf -> hphp/test/zend/good/ext/mbstring/mb_ereg_replace_invalid_replacement.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Replacement ends with unterminated UTF-8: 0xf1 in %s/mb_ereg_replace_invalid_replacement.php on line 5",
          "2: string(0) \"\"",
          "4: Fatal error: Uncaught Error: done in %s/mb_ereg_replace_invalid_replacement.php:6",
          "5: Stack trace:",
          "6: #0 (): main()",
          "7: #1 {main}",
          "",
          "---------------"
        ]
      }
    }
  ]
}