{
  "cve_id": "CVE-2022-0139",
  "cve_desc": "Use After Free in GitHub repository radareorg/radare2 prior to 5.6.0.",
  "repo": "radareorg/radare2",
  "patch_hash": "37897226a1a31f982bfefdc4aeefc2e50355c73c",
  "patch_info": {
    "commit_hash": "37897226a1a31f982bfefdc4aeefc2e50355c73c",
    "repo": "radareorg/radare2",
    "commit_url": "https://github.com/radareorg/radare2/commit/37897226a1a31f982bfefdc4aeefc2e50355c73c",
    "files": [
      "libr/io/io_bank.c"
    ],
    "message": "Fix use-after-free in iobank rbtree usage ##io\n\n* See havoc4 bin for reproducer\n* Reported via huntr.dev by 'Cen Zhang'",
    "before_after_code_files": [
      "libr/io/io_bank.c||libr/io/io_bank.c"
    ]
  },
  "patch_diff": {
    "libr/io/io_bank.c||libr/io/io_bank.c": [
      "File: libr/io/io_bank.c -> libr/io/io_bank.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "231:   RRBNode *next = r_rbnode_next (entry);",
      "234:   entry = next;",
      "235:  }",
      "236:  if (entry && r_io_submap_from (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
      "",
      "[Removed Lines]",
      "233:   r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
      "",
      "[Added Lines]",
      "233:   bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
      "234:   if (!a) {",
      "235:    break;",
      "236:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b5cb90b28ec71fda3504da04e3cc94a362807f5e",
      "candidate_info": {
        "commit_hash": "b5cb90b28ec71fda3504da04e3cc94a362807f5e",
        "repo": "radareorg/radare2",
        "commit_url": "https://github.com/radareorg/radare2/commit/b5cb90b28ec71fda3504da04e3cc94a362807f5e",
        "files": [
          "libr/io/io_bank.c",
          "libr/util/new_rbtree.c"
        ],
        "message": "Prefer memleak over usaf in io.bank's rbtree bug ##crash\n\n* That's a workaround, proper fix will come later\n* Reproducer: bins/fuzzed/iobank-crash\n* Reported by Akyne Choi via huntr.dev",
        "before_after_code_files": [
          "libr/io/io_bank.c||libr/io/io_bank.c",
          "libr/util/new_rbtree.c||libr/util/new_rbtree.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ],
          "candidate": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ]
        }
      },
      "candidate_diff": {
        "libr/io/io_bank.c||libr/io/io_bank.c": [
          "File: libr/io/io_bank.c -> libr/io/io_bank.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "226:   r_io_submap_set_to (bd, r_io_submap_from (sm) - 1);",
          "227:   entry = r_rbnode_next (entry);",
          "228:  }",
          "231:   RRBNode *next = r_rbnode_next (entry);",
          "233:   bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "234:   if (!a) {",
          "235:    break;",
          "236:   }",
          "237:   entry = next;",
          "",
          "[Removed Lines]",
          "229:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "",
          "[Added Lines]",
          "229:  ut64 smto = r_io_submap_to (sm);",
          "230:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= smto) {",
          "235:   void *smfree = bank->submaps->free;",
          "236:   bank->submaps->free = NULL;",
          "238:   bank->submaps->free = smfree;",
          "240:    entry = NULL;",
          "",
          "---------------"
        ],
        "libr/util/new_rbtree.c||libr/util/new_rbtree.c": [
          "File: libr/util/new_rbtree.c -> libr/util/new_rbtree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:  r_return_val_if_fail (tree && data && cmp, false);",
          "139:  bool inserted = false;",
          "142:   tree->root = _node_new (data, NULL);",
          "144:    return false;",
          "145:   }",
          "146:   inserted = true;",
          "",
          "[Removed Lines]",
          "141:  if (tree->root == NULL) {",
          "143:   if (tree->root == NULL) {",
          "",
          "[Added Lines]",
          "141:  if (!tree->root) {",
          "143:   if (!tree->root) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3345147916b9bb3da225248d571cdbac690c0c4d",
      "candidate_info": {
        "commit_hash": "3345147916b9bb3da225248d571cdbac690c0c4d",
        "repo": "radareorg/radare2",
        "commit_url": "https://github.com/radareorg/radare2/commit/3345147916b9bb3da225248d571cdbac690c0c4d",
        "files": [
          "libr/io/io_bank.c"
        ],
        "message": "Properly fix the UAF in r_io_bank_map_add_top ##crash\n\n* Associated with the CVE-2022-0559\n* Reported by alkyne Choi via huntr.dev",
        "before_after_code_files": [
          "libr/io/io_bank.c||libr/io/io_bank.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ],
          "candidate": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ]
        }
      },
      "candidate_diff": {
        "libr/io/io_bank.c||libr/io/io_bank.c": [
          "File: libr/io/io_bank.c -> libr/io/io_bank.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "227:   entry = r_rbnode_next (entry);",
          "228:  }",
          "229:  ut64 smto = r_io_submap_to (sm);",
          "242:   }",
          "244:  }",
          "245:  if (entry && r_io_submap_from (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "246:   bd = (RIOSubMap *)entry->data;",
          "",
          "[Removed Lines]",
          "230:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= smto) {",
          "232:   RRBNode *next = r_rbnode_next (entry);",
          "235:   void *smfree = bank->submaps->free;",
          "236:   bank->submaps->free = NULL;",
          "237:   bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "238:   bank->submaps->free = smfree;",
          "239:   if (!a) {",
          "240:    entry = NULL;",
          "241:    break;",
          "243:   entry = next;",
          "",
          "[Added Lines]",
          "230:  if (entry) {",
          "231:   ut64 ento = r_io_submap_to (((RIOSubMap*)entry->data));",
          "232:   while (entry && ento <= smto) {",
          "234:    RRBNode *next = r_rbnode_next (entry);",
          "237:    ento = r_io_submap_to (((RIOSubMap*)entry->data));",
          "238:    bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "239:    if (!a) {",
          "240:     next = NULL;",
          "241:    }",
          "242:    entry = next;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0dce1c7be516108ba8cbebdf306ba73868b80e5e",
      "candidate_info": {
        "commit_hash": "0dce1c7be516108ba8cbebdf306ba73868b80e5e",
        "repo": "radareorg/radare2",
        "commit_url": "https://github.com/radareorg/radare2/commit/0dce1c7be516108ba8cbebdf306ba73868b80e5e",
        "files": [
          "libr/include/r_io.h",
          "libr/io/io_bank.c"
        ],
        "message": "Imnplement r_io_bank_map_priorize (siol eternal) ##io",
        "before_after_code_files": [
          "libr/include/r_io.h||libr/include/r_io.h",
          "libr/io/io_bank.c||libr/io/io_bank.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ],
          "candidate": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ]
        }
      },
      "candidate_diff": {
        "libr/include/r_io.h||libr/include/r_io.h": [
          "File: libr/include/r_io.h -> libr/include/r_io.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "360: R_API void r_io_bank_fini(RIO *io);",
          "361: R_API RIOBank *r_io_bank_get(RIO *io, ut32 bankid);",
          "362: R_API bool r_io_bank_map_add_top(RIO *io, ut32 bankid, ut32 mapid);",
          "363: R_API bool r_io_bank_locate(RIO *io, ut32 bankid, const ut64 size, ut64 *addr);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "363: R_API bool r_io_bank_map_priorize (RIO *io, const ut32 bankid, const ut32 mapid);",
          "",
          "---------------"
        ],
        "libr/io/io_bank.c||libr/io/io_bank.c": [
          "File: libr/io/io_bank.c -> libr/io/io_bank.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "137:   free (sm);",
          "138:   return true;",
          "139:  }",
          "140:  if (r_io_submap_from (bd) < r_io_submap_from (sm) &&",
          "141:   r_io_submap_to (sm) < r_io_submap_to (bd)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "140:  if (r_io_submap_from (bd) < r_io_submap_from (sm) &&",
          "141:   r_io_submap_to (sm) < r_io_submap_to (bd)) {",
          "143:   RIOSubMap *bdsm = R_NEW (RIOSubMap);",
          "144:   if (!bdsm) {",
          "145:    free (sm);",
          "146:    return false;",
          "147:   }",
          "148:   bdsm->mapref = bd->mapref;",
          "149:   bdsm->itv.addr = r_io_submap_to (sm) + 1;",
          "150:   bdsm->itv.size = r_io_submap_to (bd) - bdsm->itv.addr + 1;",
          "151:   bd->itv.size = r_io_submap_from (sm) - r_io_submap_from (bd);",
          "153:   return r_rbtree_cont_insert (bank->submaps, sm, _find_sm_by_vaddr_cb, NULL) &",
          "154:    r_rbtree_cont_insert (bank->submaps, bdsm, _find_sm_by_vaddr_cb, NULL);",
          "155:  }",
          "157:  bd->itv.size = r_io_submap_from (sm) - r_io_submap_from (bd);",
          "158:  entry = r_rbtree_cont_node_next (entry);",
          "159:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "161:   RContRBNode *next = r_rbtree_cont_node_next (entry);",
          "163:   r_rbtree_cont_delete (bank->submaps, entry->data, _find_sm_by_vaddr_cb, NULL);",
          "164:   entry = next;",
          "165:  }",
          "166:  if (entry && r_io_submap_from (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "167:   bd = (RIOSubMap *)entry->data;",
          "168:   bd->itv.size = r_io_submap_to (bd) - r_io_submap_to (sm);",
          "169:   bd->itv.addr = r_io_submap_to (sm) + 1;",
          "170:  }",
          "171:  return r_rbtree_cont_insert (bank->submaps, sm, _find_sm_by_vaddr_cb, NULL);",
          "172: }",
          "175: R_API bool r_io_bank_map_priorize (RIO *io, const ut32 bankid, const ut32 mapid) {",
          "176:  RIOBank *bank = r_io_bank_get (io, bankid);",
          "177:  r_return_val_if_fail (io && bank, false);",
          "178:  RListIter *iter;",
          "179:  RIOMapRef *mapref;",
          "180:  r_list_foreach (bank->maprefs, iter, mapref) {",
          "181:   if (mapref->id == mapid) {",
          "182:    goto found;",
          "183:   }",
          "184:  }",
          "185:  return false;",
          "186: found:",
          "187:  if (iter == bank->maprefs->head) {",
          "188:   return r_io_map_get_by_ref (io, mapref) ? true : false;",
          "189:  }",
          "190:  RIOSubMap *sm = r_io_submap_new (io, mapref);",
          "191:  if (!sm) {",
          "192:   return false;",
          "193:  }",
          "194:  RContRBNode *entry = _find_entry_submap_node (bank, sm);",
          "195:  if (!entry) {",
          "197:   free (sm);",
          "198:   return false;",
          "199:  }",
          "200:  RIOSubMap *bd = (RIOSubMap *)entry->data;",
          "201:  if (r_itv_eq (bd->itv, sm->itv)) {",
          "202:   bd->mapref = *mapref;",
          "203:   free (sm);",
          "204:   return true;",
          "205:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "154:    r_rbtree_cont_insert (bank->submaps, bdsm, _find_sm_by_vaddr_cb, NULL);",
          "155:  }",
          "158:  entry = r_rbtree_cont_node_next (entry);",
          "159:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "",
          "[Removed Lines]",
          "157:  bd->itv.size = sm->itv.addr - bd->itv.addr;",
          "",
          "[Added Lines]",
          "223:  bd->itv.size = r_io_submap_from (sm) - r_io_submap_from (bd);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "163:   r_rbtree_cont_delete (bank->submaps, entry->data, _find_sm_by_vaddr_cb, NULL);",
          "164:   entry = next;",
          "165:  }",
          "167:   bd = (RIOSubMap *)entry->data;",
          "168:   bd->itv.size = r_io_submap_to (bd) - r_io_submap_to (sm);",
          "169:   bd->itv.addr = r_io_submap_to (sm) + 1;",
          "",
          "[Removed Lines]",
          "166:  if (entry) {",
          "",
          "[Added Lines]",
          "232:  if (entry && r_io_submap_from (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ead0cee8265df7d019065b82d36284addbf05a75",
      "candidate_info": {
        "commit_hash": "ead0cee8265df7d019065b82d36284addbf05a75",
        "repo": "radareorg/radare2",
        "commit_url": "https://github.com/radareorg/radare2/commit/ead0cee8265df7d019065b82d36284addbf05a75",
        "files": [
          "libr/io/io_bank.c",
          "libr/util/new_rbtree.c"
        ],
        "message": "Revert \"Prefer memleak over usaf in io.bank's rbtree bug ##crash\"\n\nThis reverts commit b5cb90b28ec71fda3504da04e3cc94a362807f5e.",
        "before_after_code_files": [
          "libr/io/io_bank.c||libr/io/io_bank.c",
          "libr/util/new_rbtree.c||libr/util/new_rbtree.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ],
          "candidate": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ]
        }
      },
      "candidate_diff": {
        "libr/io/io_bank.c||libr/io/io_bank.c": [
          "File: libr/io/io_bank.c -> libr/io/io_bank.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "232:   r_io_submap_set_to (bd, r_io_submap_from (sm) - 1);",
          "233:   entry = r_rbnode_next (entry);",
          "234:  }",
          "238:   RRBNode *next = r_rbnode_next (entry);",
          "243:   bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "245:   if (!a) {",
          "247:    break;",
          "248:   }",
          "249:   entry = next;",
          "",
          "[Removed Lines]",
          "235:  ut64 smto = r_io_submap_to (sm);",
          "236:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= smto) {",
          "241:   void *smfree = bank->submaps->free;",
          "242:   bank->submaps->free = NULL;",
          "244:   bank->submaps->free = smfree;",
          "246:    entry = NULL;",
          "",
          "[Added Lines]",
          "235:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "",
          "---------------"
        ],
        "libr/util/new_rbtree.c||libr/util/new_rbtree.c": [
          "File: libr/util/new_rbtree.c -> libr/util/new_rbtree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:  r_return_val_if_fail (tree && data && cmp, false);",
          "139:  bool inserted = false;",
          "142:   tree->root = _node_new (data, NULL);",
          "144:    return false;",
          "145:   }",
          "146:   inserted = true;",
          "",
          "[Removed Lines]",
          "141:  if (!tree->root) {",
          "143:   if (!tree->root) {",
          "",
          "[Added Lines]",
          "141:  if (tree->root == NULL) {",
          "143:   if (tree->root == NULL) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2df5543b6d30c4b7b99a04510da7662f027fbe7e",
      "candidate_info": {
        "commit_hash": "2df5543b6d30c4b7b99a04510da7662f027fbe7e",
        "repo": "radareorg/radare2",
        "commit_url": "https://github.com/radareorg/radare2/commit/2df5543b6d30c4b7b99a04510da7662f027fbe7e",
        "files": [
          "libr/io/io_bank.c"
        ],
        "message": "Revert \"Properly fix the UAF in r_io_bank_map_add_top ##crash\"\n\nThis reverts commit 3345147916b9bb3da225248d571cdbac690c0c4d.",
        "before_after_code_files": [
          "libr/io/io_bank.c||libr/io/io_bank.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ],
          "candidate": [
            "libr/io/io_bank.c||libr/io/io_bank.c"
          ]
        }
      },
      "candidate_diff": {
        "libr/io/io_bank.c||libr/io/io_bank.c": [
          "File: libr/io/io_bank.c -> libr/io/io_bank.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "233:   entry = r_rbnode_next (entry);",
          "234:  }",
          "235:  ut64 smto = r_io_submap_to (sm);",
          "249:   }",
          "250:  }",
          "251:  if (entry && r_io_submap_from (((RIOSubMap *)entry->data)) <= r_io_submap_to (sm)) {",
          "252:   bd = (RIOSubMap *)entry->data;",
          "",
          "[Removed Lines]",
          "236:  if (entry) {",
          "237:   ut64 ento = r_io_submap_to (((RIOSubMap*)entry->data));",
          "238:   while (entry && ento <= smto) {",
          "240:    RRBNode *next = r_rbnode_next (entry);",
          "243:    ento = r_io_submap_to (((RIOSubMap*)entry->data));",
          "244:    bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "245:    if (!a) {",
          "246:     next = NULL;",
          "247:    }",
          "248:    entry = next;",
          "",
          "[Added Lines]",
          "236:  while (entry && r_io_submap_to (((RIOSubMap *)entry->data)) <= smto) {",
          "238:   RRBNode *next = r_rbnode_next (entry);",
          "241:   void *smfree = bank->submaps->free;",
          "242:   bank->submaps->free = NULL;",
          "243:   bool a = r_crbtree_delete (bank->submaps, entry->data, _find_sm_by_from_vaddr_cb, NULL);",
          "244:   bank->submaps->free = smfree;",
          "245:   if (!a) {",
          "246:    entry = NULL;",
          "247:    break;",
          "249:   entry = next;",
          "",
          "---------------"
        ]
      }
    }
  ]
}