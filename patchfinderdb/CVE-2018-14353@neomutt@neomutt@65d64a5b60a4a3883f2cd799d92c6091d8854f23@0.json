{
  "cve_id": "CVE-2018-14353",
  "cve_desc": "An issue was discovered in Mutt before 1.10.1 and NeoMutt before 2018-07-16. imap_quote_string in imap/util.c has an integer underflow.",
  "repo": "neomutt/neomutt",
  "patch_hash": "65d64a5b60a4a3883f2cd799d92c6091d8854f23",
  "patch_info": {
    "commit_hash": "65d64a5b60a4a3883f2cd799d92c6091d8854f23",
    "repo": "neomutt/neomutt",
    "commit_url": "https://github.com/neomutt/neomutt/commit/65d64a5b60a4a3883f2cd799d92c6091d8854f23",
    "files": [
      "imap/util.c"
    ],
    "message": "Check for int underflow in imap_quote_string",
    "before_after_code_files": [
      "imap/util.c||imap/util.c"
    ]
  },
  "patch_diff": {
    "imap/util.c||imap/util.c": [
      "File: imap/util.c -> imap/util.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "821:   {",
      "822:     if (strchr(quote, *s))",
      "823:     {",
      "826:         break;",
      "829:     }",
      "",
      "[Removed Lines]",
      "824:       dlen -= 2;",
      "825:       if (dlen == 0)",
      "",
      "[Added Lines]",
      "824:       if (dlen < 2)",
      "826:       dlen -= 2;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "41f7040640001f6a26cd361941e810ee693e94a3",
      "candidate_info": {
        "commit_hash": "41f7040640001f6a26cd361941e810ee693e94a3",
        "repo": "neomutt/neomutt",
        "commit_url": "https://github.com/neomutt/neomutt/commit/41f7040640001f6a26cd361941e810ee693e94a3",
        "files": [
          "bcache.c",
          "browser.c",
          "conn/sasl.c",
          "imap/browse.c",
          "imap/util.c",
          "init.c",
          "mutt/address.c",
          "mutt/buffer.c",
          "ncrypt/pgppacket.c",
          "rfc3676.c"
        ],
        "message": "test ints against 0",
        "before_after_code_files": [
          "bcache.c||bcache.c",
          "browser.c||browser.c",
          "conn/sasl.c||conn/sasl.c",
          "imap/browse.c||imap/browse.c",
          "imap/util.c||imap/util.c",
          "init.c||init.c",
          "mutt/address.c||mutt/address.c",
          "mutt/buffer.c||mutt/buffer.c",
          "ncrypt/pgppacket.c||ncrypt/pgppacket.c",
          "rfc3676.c||rfc3676.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "imap/util.c||imap/util.c"
          ],
          "candidate": [
            "imap/util.c||imap/util.c"
          ]
        }
      },
      "candidate_diff": {
        "bcache.c||bcache.c": [
          "File: bcache.c -> bcache.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:   struct Url url;",
          "53:   int len;",
          "56:     return -1;",
          "",
          "[Removed Lines]",
          "55:   if (!account || !MessageCachedir || !*MessageCachedir || !dst || !dstlen)",
          "",
          "[Added Lines]",
          "55:   if (!account || !MessageCachedir || !*MessageCachedir || !dst || (dstlen == 0))",
          "",
          "---------------"
        ],
        "browser.c||browser.c": [
          "File: browser.c -> browser.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1400:     {",
          "1401:       case OP_GENERIC_SELECT_ENTRY:",
          "1404:         {",
          "1405:           mutt_error(_(\"No files match the file mask\"));",
          "1406:           break;",
          "",
          "[Removed Lines]",
          "1403:         if (!state.entrylen)",
          "",
          "[Added Lines]",
          "1403:         if (state.entrylen == 0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1849:               goto bail;",
          "1850:             }",
          "1851:             kill_prefix = 0;",
          "1853:             {",
          "1854:               mutt_error(_(\"No files match the file mask\"));",
          "1855:               break;",
          "",
          "[Removed Lines]",
          "1852:             if (!state.entrylen)",
          "",
          "[Added Lines]",
          "1852:             if (state.entrylen == 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1988:         break;",
          "1990:       case OP_BROWSER_VIEW_FILE:",
          "1992:         {",
          "1993:           mutt_error(_(\"No files match the file mask\"));",
          "1994:           break;",
          "",
          "[Removed Lines]",
          "1991:         if (!state.entrylen)",
          "",
          "[Added Lines]",
          "1991:         if (state.entrylen == 0)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2129:             menu->redraw = REDRAW_FULL;",
          "2130:             j = 0;",
          "2131:           }",
          "2133:           {",
          "2134:             mutt_error(_(\"No newsgroups match the mask\"));",
          "2135:             break;",
          "",
          "[Removed Lines]",
          "2132:           else if (!state.entrylen)",
          "",
          "[Added Lines]",
          "2132:           else if (state.entrylen == 0)",
          "",
          "---------------"
        ],
        "conn/sasl.c||conn/sasl.c": [
          "File: conn/sasl.c -> conn/sasl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "431:         mutt_debug(1, \"SASL decode failed: %s\\n\", sasl_errstring(rc, NULL, NULL));",
          "432:         goto out;",
          "433:       }",
          "436:     olen = (sasldata->blen - sasldata->bpos > len) ? len :",
          "437:                                                      sasldata->blen - sasldata->bpos;",
          "",
          "[Removed Lines]",
          "434:     } while (!sasldata->blen);",
          "",
          "[Added Lines]",
          "434:     } while (sasldata->blen == 0);",
          "",
          "---------------"
        ],
        "imap/browse.c||imap/browse.c": [
          "File: imap/browse.c -> imap/browse.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "331:   if (browse_add_list_result(idata, buf, state, 0))",
          "332:     goto fail;",
          "335:   {",
          "336:     mutt_error(_(\"No such folder\"));",
          "337:     goto fail;",
          "",
          "[Removed Lines]",
          "334:   if (!state->entrylen)",
          "",
          "[Added Lines]",
          "334:   if (state->entrylen == 0)",
          "",
          "---------------"
        ],
        "imap/util.c||imap/util.c": [
          "File: imap/util.c -> imap/util.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "516:     if (tlen && mutt_account_match(&home.account, &target.account) &&",
          "517:         (mutt_str_strncmp(home.mbox, target.mbox, hlen) == 0))",
          "518:     {",
          "520:         home_match = true;",
          "521:       else if (ImapDelimChars)",
          "522:         for (delim = ImapDelimChars; *delim != '\\0'; delim++)",
          "",
          "[Removed Lines]",
          "519:       if (!hlen)",
          "",
          "[Added Lines]",
          "519:       if (hlen == 0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "531:   {",
          "535:       hlen = -1;",
          "536:     memcpy(path, target.mbox + hlen + 1, tlen - hlen - 1);",
          "537:     path[tlen - hlen - 1] = '\\0';",
          "",
          "[Removed Lines]",
          "534:     if (!hlen)",
          "",
          "[Added Lines]",
          "534:     if (hlen == 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "815:     if (strchr(quote, *s))",
          "816:     {",
          "817:       dlen -= 2;",
          "819:         break;",
          "",
          "[Removed Lines]",
          "818:       if (!dlen)",
          "",
          "[Added Lines]",
          "818:       if (dlen == 0)",
          "",
          "---------------"
        ],
        "init.c||init.c": [
          "File: init.c -> init.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "282:   t = mutt_mem_calloc(1, sizeof(struct MbTable));",
          "283:   slen = mutt_str_strlen(s);",
          "285:     return t;",
          "287:   t->orig_str = mutt_str_strdup(s);",
          "",
          "[Removed Lines]",
          "284:   if (!slen)",
          "",
          "[Added Lines]",
          "284:   if (slen == 0)",
          "",
          "---------------"
        ],
        "mutt/address.c||mutt/address.c": [
          "File: mutt/address.c -> mutt/address.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1035:   {",
          "1036:     if (strpbrk(addr->personal, AddressSpecials))",
          "1037:     {",
          "1039:         goto done;",
          "1041:       buflen--;",
          "",
          "[Removed Lines]",
          "1038:       if (!buflen)",
          "",
          "[Added Lines]",
          "1038:       if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1047:           buflen--;",
          "1048:         }",
          "1050:           goto done;",
          "1052:         buflen--;",
          "1053:       }",
          "1055:         goto done;",
          "1057:       buflen--;",
          "1058:     }",
          "1059:     else",
          "1060:     {",
          "1062:         goto done;",
          "1063:       mutt_str_strfcpy(pbuf, addr->personal, buflen);",
          "1064:       len = mutt_str_strlen(pbuf);",
          "",
          "[Removed Lines]",
          "1049:         if (!buflen)",
          "1054:       if (!buflen)",
          "1061:       if (!buflen)",
          "",
          "[Added Lines]",
          "1049:         if (buflen == 0)",
          "1054:       if (buflen == 0)",
          "1061:       if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1066:       buflen -= len;",
          "1067:     }",
          "1070:       goto done;",
          "1072:     buflen--;",
          "",
          "[Removed Lines]",
          "1069:     if (!buflen)",
          "",
          "[Added Lines]",
          "1069:     if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1075:   if (addr->personal || (addr->mailbox && *addr->mailbox == '@'))",
          "1076:   {",
          "1078:       goto done;",
          "1080:     buflen--;",
          "",
          "[Removed Lines]",
          "1077:     if (!buflen)",
          "",
          "[Added Lines]",
          "1077:     if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1083:   if (addr->mailbox)",
          "1084:   {",
          "1086:       goto done;",
          "1087:     if ((mutt_str_strcmp(addr->mailbox, \"@\") != 0) && !display)",
          "1088:     {",
          "",
          "[Removed Lines]",
          "1085:     if (!buflen)",
          "",
          "[Added Lines]",
          "1085:     if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1105:     if (addr->personal || (addr->mailbox && *addr->mailbox == '@'))",
          "1106:     {",
          "1108:         goto done;",
          "1110:       buflen--;",
          "",
          "[Removed Lines]",
          "1107:       if (!buflen)",
          "",
          "[Added Lines]",
          "1107:       if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1113:     if (addr->group)",
          "1114:     {",
          "1116:         goto done;",
          "1118:       buflen--;",
          "1120:         goto done;",
          "1122:       buflen--;",
          "",
          "[Removed Lines]",
          "1115:       if (!buflen)",
          "1119:       if (!buflen)",
          "",
          "[Added Lines]",
          "1115:       if (buflen == 0)",
          "1119:       if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1124:   }",
          "1125:   else",
          "1126:   {",
          "1128:       goto done;",
          "1130:     buflen--;",
          "",
          "[Removed Lines]",
          "1127:     if (!buflen)",
          "",
          "[Added Lines]",
          "1127:     if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1162:     pbuf += len;",
          "1163:     buflen -= len;",
          "1165:       goto done;",
          "1167:     buflen--;",
          "1169:       goto done;",
          "1171:     buflen--;",
          "",
          "[Removed Lines]",
          "1164:     if (!buflen)",
          "1168:     if (!buflen)",
          "",
          "[Added Lines]",
          "1164:     if (buflen == 0)",
          "1168:     if (buflen == 0)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1188:     if (addr->next && addr->next->mailbox && !addr->group)",
          "1189:     {",
          "1191:         goto done;",
          "1193:       buflen--;",
          "1195:         goto done;",
          "1197:       buflen--;",
          "",
          "[Removed Lines]",
          "1190:       if (!buflen)",
          "1194:       if (!buflen)",
          "",
          "[Added Lines]",
          "1190:       if (buflen == 0)",
          "1194:       if (buflen == 0)",
          "",
          "---------------"
        ],
        "mutt/buffer.c||mutt/buffer.c": [
          "File: mutt/buffer.c -> mutt/buffer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "170:   doff = buf->dptr - buf->data;",
          "171:   blen = buf->dsize - doff;",
          "174:   {",
          "175:     blen = 128;",
          "176:     buf->dsize += blen;",
          "",
          "[Removed Lines]",
          "173:   if (!blen)",
          "",
          "[Added Lines]",
          "173:   if (blen == 0)",
          "",
          "---------------"
        ],
        "ncrypt/pgppacket.c||ncrypt/pgppacket.c": [
          "File: ncrypt/pgppacket.c -> ncrypt/pgppacket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   if (startpos < 0)",
          "73:     return NULL;",
          "76:   {",
          "77:     plen = CHUNKSIZE;",
          "78:     pbuf = mutt_mem_malloc(plen);",
          "",
          "[Removed Lines]",
          "75:   if (!plen)",
          "",
          "[Added Lines]",
          "75:   if (plen == 0)",
          "",
          "---------------"
        ],
        "rfc3676.c||rfc3676.c": [
          "File: rfc3676.c -> rfc3676.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "316:     {",
          "318:       flush_par(s, &fst);",
          "",
          "[Removed Lines]",
          "315:     if ((fixed && (!fst.width || !buf_len)) || sigsep)",
          "",
          "[Added Lines]",
          "315:     if ((fixed && ((fst.width == 0) || (buf_len == 0))) || sigsep)",
          "",
          "---------------"
        ]
      }
    }
  ]
}