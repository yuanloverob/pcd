{
  "cve_id": "CVE-2013-2146",
  "cve_desc": "arch/x86/kernel/cpu/perf_event_intel.c in the Linux kernel before 3.8.9, when the Performance Events Subsystem is enabled, specifies an incorrect bitmask, which allows local users to cause a denial of service (general protection fault and system crash) by attempting to set a reserved bit.",
  "repo": "torvalds/linux",
  "patch_hash": "f1923820c447e986a9da0fc6bf60c1dccdf0408e",
  "patch_info": {
    "commit_hash": "f1923820c447e986a9da0fc6bf60c1dccdf0408e",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/f1923820c447e986a9da0fc6bf60c1dccdf0408e",
    "files": [
      "arch/x86/kernel/cpu/perf_event_intel.c"
    ],
    "message": "perf/x86: Fix offcore_rsp valid mask for SNB/IVB\n\nThe valid mask for both offcore_response_0 and\noffcore_response_1 was wrong for SNB/SNB-EP,\nIVB/IVB-EP. It was possible to write to\nreserved bit and cause a GP fault crashing\nthe kernel.\n\nThis patch fixes the problem by correctly marking the\nreserved bits in the valid mask for all the processors\nmentioned above.\n\nA distinction between desktop and server parts is introduced\nbecause bits 24-30 are only available on the server parts.\n\nThis version of the  patch is just a rebase to perf/urgent tree\nand should apply to older kernels as well.\n\nSigned-off-by: Stephane Eranian <eranian@google.com>\nCc: peterz@infradead.org\nCc: jolsa@redhat.com\nCc: gregkh@linuxfoundation.org\nCc: security@kernel.org\nCc: ak@linux.intel.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
    "before_after_code_files": [
      "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
    ]
  },
  "patch_diff": {
    "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c": [
      "File: arch/x86/kernel/cpu/perf_event_intel.c -> arch/x86/kernel/cpu/perf_event_intel.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "153: };",
      "155: static struct extra_reg intel_snb_extra_regs[] __read_mostly = {",
      "158:  EVENT_EXTRA_END",
      "159: };",
      "",
      "[Removed Lines]",
      "156:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0x3fffffffffull, RSP_0),",
      "157:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0x3fffffffffull, RSP_1),",
      "",
      "[Added Lines]",
      "156:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0x3f807f8fffull, RSP_0),",
      "157:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0x3f807f8fffull, RSP_1),",
      "158:  EVENT_EXTRA_END",
      "159: };",
      "161: static struct extra_reg intel_snbep_extra_regs[] __read_mostly = {",
      "162:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0x3fffff8fffull, RSP_0),",
      "163:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0x3fffff8fffull, RSP_1),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2097:   x86_pmu.event_constraints = intel_snb_event_constraints;",
      "2098:   x86_pmu.pebs_constraints = intel_snb_pebs_event_constraints;",
      "2099:   x86_pmu.pebs_aliases = intel_pebs_aliases_snb;",
      "2102:   x86_pmu.er_flags |= ERF_HAS_RSP_1;",
      "2103:   x86_pmu.er_flags |= ERF_NO_HT_SHARING;",
      "",
      "[Removed Lines]",
      "2100:   x86_pmu.extra_regs = intel_snb_extra_regs;",
      "",
      "[Added Lines]",
      "2106:   if (boot_cpu_data.x86_model == 45)",
      "2107:    x86_pmu.extra_regs = intel_snbep_extra_regs;",
      "2108:   else",
      "2109:    x86_pmu.extra_regs = intel_snb_extra_regs;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2123:   x86_pmu.event_constraints = intel_ivb_event_constraints;",
      "2124:   x86_pmu.pebs_constraints = intel_ivb_pebs_event_constraints;",
      "2125:   x86_pmu.pebs_aliases = intel_pebs_aliases_snb;",
      "2128:   x86_pmu.er_flags |= ERF_HAS_RSP_1;",
      "2129:   x86_pmu.er_flags |= ERF_NO_HT_SHARING;",
      "",
      "[Removed Lines]",
      "2126:   x86_pmu.extra_regs = intel_snb_extra_regs;",
      "",
      "[Added Lines]",
      "2135:   if (boot_cpu_data.x86_model == 62)",
      "2136:    x86_pmu.extra_regs = intel_snbep_extra_regs;",
      "2137:   else",
      "2138:    x86_pmu.extra_regs = intel_snb_extra_regs;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "53ad0447208d3f5897f673ca0b16c776583eedba",
      "candidate_info": {
        "commit_hash": "53ad0447208d3f5897f673ca0b16c776583eedba",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/53ad0447208d3f5897f673ca0b16c776583eedba",
        "files": [
          "arch/x86/kernel/cpu/perf_event_intel.c"
        ],
        "message": "perf/x86: use INTEL_UEVENT_EXTRA_REG to define MSR_OFFCORE_RSP_X\n\nSilvermont (22nm Atom) has two offcore response configuration MSRs,\nunlike other Intel CPU, its event code for MSR_OFFCORE_RSP_1 is 0x02b7.\n\nTo avoid complicating intel_fixup_er(), use INTEL_UEVENT_EXTRA_REG to\ndefine MSR_OFFCORE_RSP_X. So intel_fixup_er() can find the event code\nfor OFFCORE_RSP_N by x86_pmu.extra_regs[N].event.\n\nSigned-off-by: Yan, Zheng <zheng.z.yan@intel.com>\nSigned-off-by: Peter Zijlstra <peterz@infradead.org>\nLink: http://lkml.kernel.org/r/1374138144-17278-1-git-send-email-zheng.z.yan@intel.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
        "before_after_code_files": [
          "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
          ],
          "candidate": [
            "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c": [
          "File: arch/x86/kernel/cpu/perf_event_intel.c -> arch/x86/kernel/cpu/perf_event_intel.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "82: static struct extra_reg intel_nehalem_extra_regs[] __read_mostly =",
          "83: {",
          "85:  INTEL_UEVENT_PEBS_LDLAT_EXTRA_REG(0x100b),",
          "86:  EVENT_EXTRA_END",
          "87: };",
          "",
          "[Removed Lines]",
          "84:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0xffff, RSP_0),",
          "",
          "[Added Lines]",
          "85:  INTEL_UEVENT_EXTRA_REG(0x01b7, MSR_OFFCORE_RSP_0, 0xffff, RSP_0),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "144: static struct extra_reg intel_westmere_extra_regs[] __read_mostly =",
          "145: {",
          "148:  INTEL_UEVENT_PEBS_LDLAT_EXTRA_REG(0x100b),",
          "149:  EVENT_EXTRA_END",
          "150: };",
          "",
          "[Removed Lines]",
          "146:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0xffff, RSP_0),",
          "147:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0xffff, RSP_1),",
          "",
          "[Added Lines]",
          "148:  INTEL_UEVENT_EXTRA_REG(0x01b7, MSR_OFFCORE_RSP_0, 0xffff, RSP_0),",
          "149:  INTEL_UEVENT_EXTRA_REG(0x01bb, MSR_OFFCORE_RSP_1, 0xffff, RSP_1),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "163: };",
          "165: static struct extra_reg intel_snb_extra_regs[] __read_mostly = {",
          "168:  INTEL_UEVENT_PEBS_LDLAT_EXTRA_REG(0x01cd),",
          "169:  EVENT_EXTRA_END",
          "170: };",
          "172: static struct extra_reg intel_snbep_extra_regs[] __read_mostly = {",
          "175:  INTEL_UEVENT_PEBS_LDLAT_EXTRA_REG(0x01cd),",
          "176:  EVENT_EXTRA_END",
          "177: };",
          "",
          "[Removed Lines]",
          "166:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0x3f807f8fffull, RSP_0),",
          "167:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0x3f807f8fffull, RSP_1),",
          "173:  INTEL_EVENT_EXTRA_REG(0xb7, MSR_OFFCORE_RSP_0, 0x3fffff8fffull, RSP_0),",
          "174:  INTEL_EVENT_EXTRA_REG(0xbb, MSR_OFFCORE_RSP_1, 0x3fffff8fffull, RSP_1),",
          "",
          "[Added Lines]",
          "169:  INTEL_UEVENT_EXTRA_REG(0x01b7, MSR_OFFCORE_RSP_0, 0x3f807f8fffull, RSP_0),",
          "170:  INTEL_UEVENT_EXTRA_REG(0x01bb, MSR_OFFCORE_RSP_1, 0x3f807f8fffull, RSP_1),",
          "177:  INTEL_UEVENT_EXTRA_REG(0x01b7, MSR_OFFCORE_RSP_0, 0x3fffff8fffull, RSP_0),",
          "178:  INTEL_UEVENT_EXTRA_REG(0x01bb, MSR_OFFCORE_RSP_1, 0x3fffff8fffull, RSP_1),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1302:  if (idx == EXTRA_REG_RSP_0) {",
          "1303:   event->hw.config &= ~INTEL_ARCH_EVENT_MASK;",
          "1305:   event->hw.extra_reg.reg = MSR_OFFCORE_RSP_0;",
          "1306:  } else if (idx == EXTRA_REG_RSP_1) {",
          "1307:   event->hw.config &= ~INTEL_ARCH_EVENT_MASK;",
          "1309:   event->hw.extra_reg.reg = MSR_OFFCORE_RSP_1;",
          "1310:  }",
          "1311: }",
          "",
          "[Removed Lines]",
          "1304:   event->hw.config |= 0x01b7;",
          "1308:   event->hw.config |= 0x01bb;",
          "",
          "[Added Lines]",
          "1308:   event->hw.config |= x86_pmu.extra_regs[EXTRA_REG_RSP_0].event;",
          "1312:   event->hw.config |= x86_pmu.extra_regs[EXTRA_REG_RSP_1].event;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "20a36e39d59757252edbbdcf9574ae2998733ce9",
      "candidate_info": {
        "commit_hash": "20a36e39d59757252edbbdcf9574ae2998733ce9",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/20a36e39d59757252edbbdcf9574ae2998733ce9",
        "files": [
          "arch/x86/kernel/cpu/perf_event.h",
          "arch/x86/kernel/cpu/perf_event_intel.c",
          "arch/x86/kernel/cpu/perf_event_intel_ds.c"
        ],
        "message": "perf/x86: Fix Intel Ivy Bridge support\n\nThis patch updates the existing Intel IvyBridge (model 58)\nsupport with proper PEBS event constraints. It cannot reuse\nthe same as SandyBridge because some events (0xd3) are\nspecific to IvyBridge.\n\nAlso there is no UOPS_DISPATCHED.THREAD on IVB, so do not\npopulate the PERF_COUNT_HW_STALLED_CYCLES_BACKEND mapping.\n\nSigned-off-by: Stephane Eranian <eranian@google.com>\nCc: peterz@infradead.org\nCc: ak@linux.intel.com\nLink: http://lkml.kernel.org/r/20120910230701.GA5898@quad\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
        "before_after_code_files": [
          "arch/x86/kernel/cpu/perf_event.h||arch/x86/kernel/cpu/perf_event.h",
          "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c",
          "arch/x86/kernel/cpu/perf_event_intel_ds.c||arch/x86/kernel/cpu/perf_event_intel_ds.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
          ],
          "candidate": [
            "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kernel/cpu/perf_event.h||arch/x86/kernel/cpu/perf_event.h": [
          "File: arch/x86/kernel/cpu/perf_event.h -> arch/x86/kernel/cpu/perf_event.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "587: extern struct event_constraint intel_snb_pebs_event_constraints[];",
          "589: struct event_constraint *intel_pebs_constraints(struct perf_event *event);",
          "591: void intel_pmu_pebs_enable(struct perf_event *event);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "589: extern struct event_constraint intel_ivb_pebs_event_constraints[];",
          "",
          "---------------"
        ],
        "arch/x86/kernel/cpu/perf_event_intel.c||arch/x86/kernel/cpu/perf_event_intel.c": [
          "File: arch/x86/kernel/cpu/perf_event_intel.c -> arch/x86/kernel/cpu/perf_event_intel.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2074:   pr_cont(\"SandyBridge events, \");",
          "2075:   break;",
          "2077:  default:",
          "2078:   switch (x86_pmu.version) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2076:   memcpy(hw_cache_event_ids, snb_hw_cache_event_ids,",
          "2077:          sizeof(hw_cache_event_ids));",
          "2078:   memcpy(hw_cache_extra_regs, snb_hw_cache_extra_regs,",
          "2079:          sizeof(hw_cache_extra_regs));",
          "2081:   intel_pmu_lbr_init_snb();",
          "2083:   x86_pmu.event_constraints = intel_snb_event_constraints;",
          "2084:   x86_pmu.pebs_constraints = intel_ivb_pebs_event_constraints;",
          "2085:   x86_pmu.pebs_aliases = intel_pebs_aliases_snb;",
          "2086:   x86_pmu.extra_regs = intel_snb_extra_regs;",
          "2088:   x86_pmu.er_flags |= ERF_HAS_RSP_1;",
          "2089:   x86_pmu.er_flags |= ERF_NO_HT_SHARING;",
          "2092:   intel_perfmon_event_map[PERF_COUNT_HW_STALLED_CYCLES_FRONTEND] =",
          "2093:    X86_CONFIG(.event=0x0e, .umask=0x01, .inv=1, .cmask=1);",
          "2095:   pr_cont(\"IvyBridge events, \");",
          "2096:   break;",
          "",
          "---------------"
        ],
        "arch/x86/kernel/cpu/perf_event_intel_ds.c||arch/x86/kernel/cpu/perf_event_intel_ds.c": [
          "File: arch/x86/kernel/cpu/perf_event_intel_ds.c -> arch/x86/kernel/cpu/perf_event_intel_ds.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "407:  EVENT_CONSTRAINT_END",
          "408: };",
          "410: struct event_constraint *intel_pebs_constraints(struct perf_event *event)",
          "411: {",
          "412:  struct event_constraint *c;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "410: struct event_constraint intel_ivb_pebs_event_constraints[] = {",
          "421:         EVENT_CONSTRAINT_END",
          "422: };",
          "",
          "---------------"
        ]
      }
    }
  ]
}