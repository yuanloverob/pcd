{
  "cve_id": "CVE-2021-29523",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can trigger a denial of service via a `CHECK`-fail in `tf.raw_ops.AddManySparseToTensorsMap`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/6f9896890c4c703ae0a0845394086e2e1e523299/tensorflow/core/kernels/sparse_tensors_map_ops.cc#L257) takes the values specified in `sparse_shape` as dimensions for the output shape. The `TensorShape` constructor(https://github.com/tensorflow/tensorflow/blob/6f9896890c4c703ae0a0845394086e2e1e523299/tensorflow/core/framework/tensor_shape.cc#L183-L188) uses a `CHECK` operation which triggers when `InitDims`(https://github.com/tensorflow/tensorflow/blob/6f9896890c4c703ae0a0845394086e2e1e523299/tensorflow/core/framework/tensor_shape.cc#L212-L296) returns a non-OK status. This is a legacy implementation of the constructor and operations should use `BuildTensorShapeBase` or `AddDimWithStatus` to prevent `CHECK`-failures in the presence of overflows. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "69c68ecbb24dff3fa0e46da0d16c821a2dd22d7c",
  "patch_info": {
    "commit_hash": "69c68ecbb24dff3fa0e46da0d16c821a2dd22d7c",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/69c68ecbb24dff3fa0e46da0d16c821a2dd22d7c",
    "files": [
      "tensorflow/core/kernels/sparse_tensors_map_ops.cc"
    ],
    "message": "Fix overflow CHECK issue with `tf.raw_ops.AddManySparseToTensorsMap`.\n\nPiperOrigin-RevId: 369492969\nChange-Id: I1d70d6c0c92e3d7a25bc3b3aa2a0c0ac9688bf81",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc": [
      "File: tensorflow/core/kernels/sparse_tensors_map_ops.cc -> tensorflow/core/kernels/sparse_tensors_map_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "21: #include <utility>",
      "22: #include <vector>",
      "27: #include \"tensorflow/core/framework/op_kernel.h\"",
      "28: #include \"tensorflow/core/framework/register_types.h\"",
      "29: #include \"tensorflow/core/framework/resource_mgr.h\"",
      "",
      "[Removed Lines]",
      "24: #include \"tensorflow/core/framework/op_kernel.h\"",
      "25: #include \"tensorflow/core/framework/register_types.h\"",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "31: #include \"tensorflow/core/framework/tensor_util.h\"",
      "32: #include \"tensorflow/core/framework/types.h\"",
      "33: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
      "34: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
      "36: namespace tensorflow {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "31: #include \"tensorflow/core/util/overflow.h\"",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "254:         errors::InvalidArgument(",
      "255:             \"Rank of input SparseTensor should be > 1, but saw rank: \", rank));",
      "258:     gtl::InlinedVector<int64, 8> std_order(rank);",
      "259:     std::iota(std_order.begin(), std_order.end(), 0);",
      "260:     SparseTensor input_st;",
      "",
      "[Removed Lines]",
      "257:     TensorShape tensor_input_shape(input_shape->vec<int64>());",
      "",
      "[Added Lines]",
      "255:     auto input_shape_vec = input_shape->vec<int64>();",
      "256:     int new_num_elements = 1;",
      "257:     bool overflow_ocurred = false;",
      "258:     for (int i = 0; i < input_shape_vec.size(); i++) {",
      "259:       new_num_elements =",
      "260:           MultiplyWithoutOverflow(new_num_elements, input_shape_vec(i));",
      "261:       if (new_num_elements < 0) {",
      "262:         overflow_ocurred = true;",
      "263:       }",
      "264:     }",
      "266:     OP_REQUIRES(",
      "267:         context, !overflow_ocurred,",
      "268:         errors::Internal(\"Encountered overflow from large input shape.\"));",
      "270:     TensorShape tensor_input_shape(input_shape_vec);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "262:                                                  tensor_input_shape, std_order,",
      "263:                                                  &input_st));",
      "268:     Tensor sparse_handles(DT_INT64, TensorShape({N}));",
      "269:     auto sparse_handles_t = sparse_handles.vec<int64>();",
      "",
      "[Removed Lines]",
      "265:     auto input_shape_t = input_shape->vec<int64>();",
      "266:     const int64 N = input_shape_t(0);",
      "",
      "[Added Lines]",
      "278:     const int64 N = input_shape_vec(0);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "275:     TensorShape output_shape;",
      "276:     OP_REQUIRES_OK(context, TensorShapeUtils::MakeShape(",
      "278:                                 input_shape->NumElements() - 1, &output_shape));",
      "",
      "[Removed Lines]",
      "277:                                 input_shape_t.data() + 1,",
      "",
      "[Added Lines]",
      "289:                                 input_shape_vec.data() + 1,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ed14bab9a67f033ba9e53de2979dfcdc1a52371b",
      "candidate_info": {
        "commit_hash": "ed14bab9a67f033ba9e53de2979dfcdc1a52371b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ed14bab9a67f033ba9e53de2979dfcdc1a52371b",
        "files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ],
        "message": "Fix overflow CHECK issue with `tf.raw_ops.AddManySparseToTensorsMap`.\n\nPiperOrigin-RevId: 369492969\nChange-Id: I1d70d6c0c92e3d7a25bc3b3aa2a0c0ac9688bf81",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc": [
          "File: tensorflow/core/kernels/sparse_tensors_map_ops.cc -> tensorflow/core/kernels/sparse_tensors_map_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: #include <utility>",
          "22: #include <vector>",
          "27: #include \"tensorflow/core/framework/op_kernel.h\"",
          "28: #include \"tensorflow/core/framework/register_types.h\"",
          "29: #include \"tensorflow/core/framework/resource_mgr.h\"",
          "",
          "[Removed Lines]",
          "24: #include \"tensorflow/core/framework/op_kernel.h\"",
          "25: #include \"tensorflow/core/framework/register_types.h\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "31: #include \"tensorflow/core/framework/tensor_util.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "34: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "36: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"tensorflow/core/util/overflow.h\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "253:         errors::InvalidArgument(",
          "254:             \"Rank of input SparseTensor should be > 1, but saw rank: \", rank));",
          "257:     gtl::InlinedVector<int64, 8> std_order(rank);",
          "258:     std::iota(std_order.begin(), std_order.end(), 0);",
          "259:     SparseTensor input_st;",
          "",
          "[Removed Lines]",
          "256:     TensorShape tensor_input_shape(input_shape->vec<int64>());",
          "",
          "[Added Lines]",
          "254:     auto input_shape_vec = input_shape->vec<int64>();",
          "255:     int new_num_elements = 1;",
          "256:     bool overflow_ocurred = false;",
          "257:     for (int i = 0; i < input_shape_vec.size(); i++) {",
          "258:       new_num_elements =",
          "259:           MultiplyWithoutOverflow(new_num_elements, input_shape_vec(i));",
          "260:       if (new_num_elements < 0) {",
          "261:         overflow_ocurred = true;",
          "262:       }",
          "263:     }",
          "265:     OP_REQUIRES(",
          "266:         context, !overflow_ocurred,",
          "267:         errors::Internal(\"Encountered overflow from large input shape.\"));",
          "269:     TensorShape tensor_input_shape(input_shape_vec);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "261:                                                  tensor_input_shape, std_order,",
          "262:                                                  &input_st));",
          "267:     Tensor sparse_handles(DT_INT64, TensorShape({N}));",
          "268:     auto sparse_handles_t = sparse_handles.vec<int64>();",
          "",
          "[Removed Lines]",
          "264:     auto input_shape_t = input_shape->vec<int64>();",
          "265:     const int64 N = input_shape_t(0);",
          "",
          "[Added Lines]",
          "277:     const int64 N = input_shape_vec(0);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "274:     TensorShape output_shape;",
          "275:     OP_REQUIRES_OK(context, TensorShapeUtils::MakeShape(",
          "277:                                 input_shape->NumElements() - 1, &output_shape));",
          "",
          "[Removed Lines]",
          "276:                                 input_shape_t.data() + 1,",
          "",
          "[Added Lines]",
          "288:                                 input_shape_vec.data() + 1,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f600f6691773e8ba2d32d38005c1df706e02b7c0",
      "candidate_info": {
        "commit_hash": "f600f6691773e8ba2d32d38005c1df706e02b7c0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f600f6691773e8ba2d32d38005c1df706e02b7c0",
        "files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ],
        "message": "Fix overflow CHECK issue with `tf.raw_ops.AddManySparseToTensorsMap`.\n\nPiperOrigin-RevId: 369492969\nChange-Id: I1d70d6c0c92e3d7a25bc3b3aa2a0c0ac9688bf81",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc": [
          "File: tensorflow/core/kernels/sparse_tensors_map_ops.cc -> tensorflow/core/kernels/sparse_tensors_map_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: #include <utility>",
          "22: #include <vector>",
          "27: #include \"tensorflow/core/framework/op_kernel.h\"",
          "28: #include \"tensorflow/core/framework/register_types.h\"",
          "29: #include \"tensorflow/core/framework/resource_mgr.h\"",
          "",
          "[Removed Lines]",
          "24: #include \"tensorflow/core/framework/op_kernel.h\"",
          "25: #include \"tensorflow/core/framework/register_types.h\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "31: #include \"tensorflow/core/framework/tensor_util.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "34: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "36: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"tensorflow/core/util/overflow.h\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "254:         errors::InvalidArgument(",
          "255:             \"Rank of input SparseTensor should be > 1, but saw rank: \", rank));",
          "258:     gtl::InlinedVector<int64, 8> std_order(rank);",
          "259:     std::iota(std_order.begin(), std_order.end(), 0);",
          "260:     SparseTensor input_st;",
          "",
          "[Removed Lines]",
          "257:     TensorShape tensor_input_shape(input_shape->vec<int64>());",
          "",
          "[Added Lines]",
          "255:     auto input_shape_vec = input_shape->vec<int64>();",
          "256:     int new_num_elements = 1;",
          "257:     bool overflow_ocurred = false;",
          "258:     for (int i = 0; i < input_shape_vec.size(); i++) {",
          "259:       new_num_elements =",
          "260:           MultiplyWithoutOverflow(new_num_elements, input_shape_vec(i));",
          "261:       if (new_num_elements < 0) {",
          "262:         overflow_ocurred = true;",
          "263:       }",
          "264:     }",
          "266:     OP_REQUIRES(",
          "267:         context, !overflow_ocurred,",
          "268:         errors::Internal(\"Encountered overflow from large input shape.\"));",
          "270:     TensorShape tensor_input_shape(input_shape_vec);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "262:                                                  tensor_input_shape, std_order,",
          "263:                                                  &input_st));",
          "268:     Tensor sparse_handles(DT_INT64, TensorShape({N}));",
          "269:     auto sparse_handles_t = sparse_handles.vec<int64>();",
          "",
          "[Removed Lines]",
          "265:     auto input_shape_t = input_shape->vec<int64>();",
          "266:     const int64 N = input_shape_t(0);",
          "",
          "[Added Lines]",
          "278:     const int64 N = input_shape_vec(0);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "275:     TensorShape output_shape;",
          "276:     OP_REQUIRES_OK(context, TensorShapeUtils::MakeShape(",
          "278:                                 input_shape->NumElements() - 1, &output_shape));",
          "",
          "[Removed Lines]",
          "277:                                 input_shape_t.data() + 1,",
          "",
          "[Added Lines]",
          "289:                                 input_shape_vec.data() + 1,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "705c67e7581e6dc527dca4483b9c239407795e77",
      "candidate_info": {
        "commit_hash": "705c67e7581e6dc527dca4483b9c239407795e77",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/705c67e7581e6dc527dca4483b9c239407795e77",
        "files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ],
        "message": "Fix overflow CHECK issue with `tf.raw_ops.AddManySparseToTensorsMap`.\n\nPiperOrigin-RevId: 369492969\nChange-Id: I1d70d6c0c92e3d7a25bc3b3aa2a0c0ac9688bf81",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_tensors_map_ops.cc||tensorflow/core/kernels/sparse_tensors_map_ops.cc": [
          "File: tensorflow/core/kernels/sparse_tensors_map_ops.cc -> tensorflow/core/kernels/sparse_tensors_map_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: #include <utility>",
          "22: #include <vector>",
          "27: #include \"tensorflow/core/framework/op_kernel.h\"",
          "28: #include \"tensorflow/core/framework/register_types.h\"",
          "29: #include \"tensorflow/core/framework/resource_mgr.h\"",
          "",
          "[Removed Lines]",
          "24: #include \"tensorflow/core/framework/op_kernel.h\"",
          "25: #include \"tensorflow/core/framework/register_types.h\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "31: #include \"tensorflow/core/framework/tensor_util.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "34: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "36: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"tensorflow/core/util/overflow.h\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "254:         errors::InvalidArgument(",
          "255:             \"Rank of input SparseTensor should be > 1, but saw rank: \", rank));",
          "258:     gtl::InlinedVector<int64, 8> std_order(rank);",
          "259:     std::iota(std_order.begin(), std_order.end(), 0);",
          "260:     SparseTensor input_st;",
          "",
          "[Removed Lines]",
          "257:     TensorShape tensor_input_shape(input_shape->vec<int64>());",
          "",
          "[Added Lines]",
          "255:     auto input_shape_vec = input_shape->vec<int64>();",
          "256:     int new_num_elements = 1;",
          "257:     bool overflow_ocurred = false;",
          "258:     for (int i = 0; i < input_shape_vec.size(); i++) {",
          "259:       new_num_elements =",
          "260:           MultiplyWithoutOverflow(new_num_elements, input_shape_vec(i));",
          "261:       if (new_num_elements < 0) {",
          "262:         overflow_ocurred = true;",
          "263:       }",
          "264:     }",
          "266:     OP_REQUIRES(",
          "267:         context, !overflow_ocurred,",
          "268:         errors::Internal(\"Encountered overflow from large input shape.\"));",
          "270:     TensorShape tensor_input_shape(input_shape_vec);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "262:                                                  tensor_input_shape, std_order,",
          "263:                                                  &input_st));",
          "268:     Tensor sparse_handles(DT_INT64, TensorShape({N}));",
          "269:     auto sparse_handles_t = sparse_handles.vec<int64>();",
          "",
          "[Removed Lines]",
          "265:     auto input_shape_t = input_shape->vec<int64>();",
          "266:     const int64 N = input_shape_t(0);",
          "",
          "[Added Lines]",
          "278:     const int64 N = input_shape_vec(0);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "275:     TensorShape output_shape;",
          "276:     OP_REQUIRES_OK(context, TensorShapeUtils::MakeShape(",
          "278:                                 input_shape->NumElements() - 1, &output_shape));",
          "",
          "[Removed Lines]",
          "277:                                 input_shape_t.data() + 1,",
          "",
          "[Added Lines]",
          "289:                                 input_shape_vec.data() + 1,",
          "",
          "---------------"
        ]
      }
    }
  ]
}