{
  "cve_id": "CVE-2018-7337",
  "cve_desc": "In Wireshark 2.4.0 to 2.4.4, the DOCSIS protocol dissector could crash. This was addressed in plugins/docsis/packet-docsis.c by removing the recursive algorithm that had been used for concatenated PDUs.",
  "repo": "wireshark/wireshark",
  "patch_hash": "91409213ad111fb1607636dcb0b69dac9fb2d0c5",
  "patch_info": {
    "commit_hash": "91409213ad111fb1607636dcb0b69dac9fb2d0c5",
    "repo": "wireshark/wireshark",
    "commit_url": "https://github.com/wireshark/wireshark/commit/91409213ad111fb1607636dcb0b69dac9fb2d0c5",
    "files": [
      "epan/dissectors/packet-docsis.c"
    ],
    "message": "DOCSIS: Remove concatenated PDU dissection.\n\nThe current concatenation PDU support has had serious, repeated problems\nover the years:\n\nfb1ef7b8da\nf6d48e45c8\n3e1828e351\n26a6881014\n625bab309d\n\nRemove it and add a comment recommending iteration.\n\nBug: 14446\nChange-Id: I947ff8e40e18c4628c9df9233b72dd7776e8233d\nReviewed-on: https://code.wireshark.org/review/25905\nReviewed-by: Gerald Combs <gerald@wireshark.org>\nPetri-Dish: Gerald Combs <gerald@wireshark.org>\nTested-by: Petri Dish Buildbot\nReviewed-by: Anders Broman <a.broman58@gmail.com>",
    "before_after_code_files": [
      "epan/dissectors/packet-docsis.c||epan/dissectors/packet-docsis.c"
    ]
  },
  "patch_diff": {
    "epan/dissectors/packet-docsis.c||epan/dissectors/packet-docsis.c": [
      "File: epan/dissectors/packet-docsis.c -> epan/dissectors/packet-docsis.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "515:   tvbuff_t *mgt_tvb = NULL;",
      "516:   gint pdulen = 0;",
      "517:   guint16 payload_length = 0;",
      "519:   gboolean save_fragmented;",
      "521:   proto_item *ti;",
      "522:   proto_tree *docsis_tree;",
      "",
      "[Removed Lines]",
      "518:   guint16 framelen = 0;",
      "527:   static guint16 concatlen;",
      "528:   static guint16 concatpos;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "555:   if ((fctype == FCTYPE_MACSPC) && (fcparm == FCPARM_RQST_FRM || fcparm == FCPARM_QUEUE_DEPTH_REQ_FRM))",
      "556:   {",
      "557:     pdulen = 0;",
      "558:     if (fcparm == FCPARM_QUEUE_DEPTH_REQ_FRM)",
      "559:       framelen = DOCSIS_MIN_HEADER_LEN + 1;",
      "560:     else",
      "561:       framelen = DOCSIS_MIN_HEADER_LEN;",
      "562:   } else {",
      "564:     pdulen = len_sid - (mac_parm + 2);",
      "565:   }",
      "",
      "[Removed Lines]",
      "563:     framelen = DOCSIS_MIN_HEADER_LEN + len_sid;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "618:         next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
      "619:         call_dissector (eth_withoutfcs_handle, next_tvb, pinfo, docsis_tree);",
      "620:       }",
      "626:       break;",
      "627:     }",
      "628:     case FCTYPE_RESERVED:",
      "",
      "[Removed Lines]",
      "621:       if (concatlen > 0)",
      "622:       {",
      "623:         concatlen = concatlen - framelen;",
      "624:         concatpos += framelen;",
      "625:       }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "636:       dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
      "645:       next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
      "646:       call_data_dissector(next_tvb, pinfo, tree);",
      "",
      "[Removed Lines]",
      "638:       if (concatlen > 0)",
      "639:       {",
      "640:         concatlen = concatlen - framelen;",
      "641:         concatpos += framelen;",
      "642:       }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "660:         next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
      "661:         call_dissector (eth_withoutfcs_handle, next_tvb, pinfo, docsis_tree);",
      "662:       }",
      "668:       break;",
      "669:     }",
      "670:     case FCTYPE_MACSPC:",
      "",
      "[Removed Lines]",
      "663:       if (concatlen > 0)",
      "664:       {",
      "665:         concatlen = concatlen - framelen;",
      "666:         concatpos += framelen;",
      "667:       }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "687:           mgt_tvb = tvb_new_subset_remaining(tvb, hdrlen);",
      "688:           call_dissector (docsis_mgmt_handle, mgt_tvb, pinfo, docsis_tree);",
      "696:           break;",
      "697:         }",
      "698:         case FCPARM_RQST_FRM:",
      "",
      "[Removed Lines]",
      "690:           if (concatlen > 0)",
      "691:           {",
      "692:             concatlen = concatlen - framelen;",
      "693:             concatpos += framelen;",
      "694:           }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "704:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
      "713:           break;",
      "714:         }",
      "",
      "[Removed Lines]",
      "706:           if (concatlen > 0)",
      "707:           {",
      "708:             concatlen = concatlen - framelen;",
      "709:             concatpos += framelen;",
      "710:           }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "774:           pinfo->fragmented = save_fragmented;",
      "782:           break;",
      "783:         }",
      "784:         case FCPARM_QUEUE_DEPTH_REQ_FRM:",
      "",
      "[Removed Lines]",
      "776:           if (concatlen > 0)",
      "777:           {",
      "778:             concatlen = concatlen - framelen;",
      "779:             concatpos += framelen;",
      "780:           }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "790:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
      "799:           break;",
      "800:         }",
      "",
      "[Removed Lines]",
      "792:           if (concatlen > 0)",
      "793:           {",
      "794:             concatlen = concatlen - framelen;",
      "795:             concatpos += framelen;",
      "796:           }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "808:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
      "829:           break;",
      "830:         }",
      "831:         default:",
      "834:           break;",
      "836:       break;",
      "",
      "[Removed Lines]",
      "813:           concatlen = len_sid;",
      "814:           concatpos = DOCSIS_MIN_HEADER_LEN;",
      "822:           while (concatlen > 0)",
      "823:           {",
      "824:             next_tvb = tvb_new_subset_length_caplen (tvb, concatpos, -1, concatlen);",
      "825:             call_dissector (docsis_handle, next_tvb, pinfo, docsis_tree);",
      "826:           }",
      "827:           concatlen = 0;",
      "828:           concatpos = 0;",
      "833:           concatlen = 0;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "511a8b0b546d25413e289dc5a7d3a455a33994c2",
      "candidate_info": {
        "commit_hash": "511a8b0b546d25413e289dc5a7d3a455a33994c2",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/511a8b0b546d25413e289dc5a7d3a455a33994c2",
        "files": [
          "plugins/docsis/packet-docsis.c"
        ],
        "message": "DOCSIS: Remove concatenated PDU dissection.\n\nThe current concatenation PDU support has had serious, repeated problems\nover the years:\n\nfb1ef7b8da\nf6d48e45c8\n3e1828e351\n26a6881014\n625bab309d\n\nRemove it and add a comment recommending iteration.\n\nBug: 14446\nChange-Id: I947ff8e40e18c4628c9df9233b72dd7776e8233d\n(cherry picked from commit 3b2fdfbc5818ad908d58eea03749a7083a15412a)\nReviewed-on: https://code.wireshark.org/review/25906\nReviewed-by: Gerald Combs <gerald@wireshark.org>\nPetri-Dish: Gerald Combs <gerald@wireshark.org>\nTested-by: Petri Dish Buildbot\nReviewed-by: Anders Broman <a.broman58@gmail.com>",
        "before_after_code_files": [
          "plugins/docsis/packet-docsis.c||plugins/docsis/packet-docsis.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "plugins/docsis/packet-docsis.c||plugins/docsis/packet-docsis.c": [
          "File: plugins/docsis/packet-docsis.c -> plugins/docsis/packet-docsis.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "532:   proto_item *ti;",
          "533:   proto_tree *docsis_tree;",
          "",
          "[Removed Lines]",
          "538:   static guint16 concatlen;",
          "539:   static guint16 concatpos;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "629:         next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
          "630:         call_dissector (eth_withoutfcs_handle, next_tvb, pinfo, docsis_tree);",
          "631:       }",
          "637:       break;",
          "638:     }",
          "639:     case FCTYPE_RESERVED:",
          "",
          "[Removed Lines]",
          "632:       if (concatlen > 0)",
          "633:       {",
          "634:         concatlen = concatlen - framelen;",
          "635:         concatpos += framelen;",
          "636:       }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "647:       dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
          "656:       next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
          "657:       call_data_dissector(next_tvb, pinfo, tree);",
          "",
          "[Removed Lines]",
          "649:       if (concatlen > 0)",
          "650:       {",
          "651:         concatlen = concatlen - framelen;",
          "652:         concatpos += framelen;",
          "653:       }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "671:         next_tvb =  tvb_new_subset_remaining(tvb, hdrlen);",
          "672:         call_dissector (eth_withoutfcs_handle, next_tvb, pinfo, docsis_tree);",
          "673:       }",
          "679:       break;",
          "680:     }",
          "681:     case FCTYPE_MACSPC:",
          "",
          "[Removed Lines]",
          "674:       if (concatlen > 0)",
          "675:       {",
          "676:         concatlen = concatlen - framelen;",
          "677:         concatpos += framelen;",
          "678:       }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "698:           mgt_tvb = tvb_new_subset_remaining(tvb, hdrlen);",
          "699:           call_dissector (docsis_mgmt_handle, mgt_tvb, pinfo, docsis_tree);",
          "707:           break;",
          "708:         }",
          "709:         case FCPARM_RQST_FRM:",
          "",
          "[Removed Lines]",
          "701:           if (concatlen > 0)",
          "702:           {",
          "703:             concatlen = concatlen - framelen;",
          "704:             concatpos += framelen;",
          "705:           }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "715:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
          "724:           break;",
          "725:         }",
          "",
          "[Removed Lines]",
          "717:           if (concatlen > 0)",
          "718:           {",
          "719:             concatlen = concatlen - framelen;",
          "720:             concatpos += framelen;",
          "721:           }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "785:           pinfo->fragmented = save_fragmented;",
          "793:           break;",
          "794:         }",
          "795:         case FCPARM_QUEUE_DEPTH_REQ_FRM:",
          "",
          "[Removed Lines]",
          "787:           if (concatlen > 0)",
          "788:           {",
          "789:             concatlen = concatlen - framelen;",
          "790:             concatpos += framelen;",
          "791:           }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "801:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
          "810:           break;",
          "811:         }",
          "",
          "[Removed Lines]",
          "803:           if (concatlen > 0)",
          "804:           {",
          "805:             concatlen = concatlen - framelen;",
          "806:             concatpos += framelen;",
          "807:           }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "819:           dissect_hcs_field (tvb, pinfo, docsis_tree, hdrlen);",
          "840:           break;",
          "841:         }",
          "842:         default:",
          "845:           break;",
          "847:       break;",
          "",
          "[Removed Lines]",
          "824:           concatlen = len_sid;",
          "825:           concatpos = DOCSIS_MIN_HEADER_LEN;",
          "833:           while (concatlen > 0)",
          "834:           {",
          "835:             next_tvb = tvb_new_subset_length_caplen (tvb, concatpos, -1, concatlen);",
          "836:             call_dissector (docsis_handle, next_tvb, pinfo, docsis_tree);",
          "837:           }",
          "838:           concatlen = 0;",
          "839:           concatpos = 0;",
          "844:           concatlen = 0;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b98b9be3b1faecd68858604e4d51f85cd53a0701",
      "candidate_info": {
        "commit_hash": "b98b9be3b1faecd68858604e4d51f85cd53a0701",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/b98b9be3b1faecd68858604e4d51f85cd53a0701",
        "files": [
          "plugins/docsis/packet-docsis.c"
        ],
        "message": "docsis: Remove unused variable framelen\n\nThis avoids an error when building with -Werror=unused-but-set-variable\n\nChange-Id: I94a7e47857feadf81a0abb6bb350b32d2acd052e\nReviewed-on: https://code.wireshark.org/review/25924\nPetri-Dish: Stig Bj\u00f8rlykke <stig@bjorlykke.org>\nTested-by: Petri Dish Buildbot\nReviewed-by: Stig Bj\u00f8rlykke <stig@bjorlykke.org>",
        "before_after_code_files": [
          "plugins/docsis/packet-docsis.c||plugins/docsis/packet-docsis.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "plugins/docsis/packet-docsis.c||plugins/docsis/packet-docsis.c": [
          "File: plugins/docsis/packet-docsis.c -> plugins/docsis/packet-docsis.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "526:   tvbuff_t *mgt_tvb = NULL;",
          "527:   gint pdulen = 0;",
          "528:   guint16 payload_length = 0;",
          "530:   gboolean save_fragmented;",
          "532:   proto_item *ti;",
          "",
          "[Removed Lines]",
          "529:   guint16 framelen = 0;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "560:   if ((fctype == FCTYPE_MACSPC) && (fcparm == FCPARM_RQST_FRM || fcparm == FCPARM_QUEUE_DEPTH_REQ_FRM))",
          "561:   {",
          "562:     pdulen = 0;",
          "567:   } else {",
          "569:     pdulen = len_sid - (mac_parm + 2);",
          "570:   }",
          "",
          "[Removed Lines]",
          "563:     if (fcparm == FCPARM_QUEUE_DEPTH_REQ_FRM)",
          "564:       framelen = DOCSIS_MIN_HEADER_LEN + 1;",
          "565:     else",
          "566:       framelen = DOCSIS_MIN_HEADER_LEN;",
          "568:     framelen = DOCSIS_MIN_HEADER_LEN + len_sid;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}