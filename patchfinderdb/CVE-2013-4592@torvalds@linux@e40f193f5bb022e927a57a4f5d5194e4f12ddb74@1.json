{
  "cve_id": "CVE-2013-4592",
  "cve_desc": "Memory leak in the __kvm_set_memory_region function in virt/kvm/kvm_main.c in the Linux kernel before 3.9 allows local users to cause a denial of service (memory consumption) by leveraging certain device access to trigger movement of memory slots.",
  "repo": "torvalds/linux",
  "patch_hash": "e40f193f5bb022e927a57a4f5d5194e4f12ddb74",
  "patch_info": {
    "commit_hash": "e40f193f5bb022e927a57a4f5d5194e4f12ddb74",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/e40f193f5bb022e927a57a4f5d5194e4f12ddb74",
    "files": [
      "virt/kvm/kvm_main.c"
    ],
    "message": "KVM: Fix iommu map/unmap to handle memory slot moves\n\nThe iommu integration into memory slots expects memory slots to be\nadded or removed and doesn't handle the move case.  We can unmap\nslots from the iommu after we mark them invalid and map them before\ninstalling the final memslot array.  Also re-order the kmemdup vs\nmap so we don't leave iommu mappings if we get ENOMEM.\n\nReviewed-by: Gleb Natapov <gleb@redhat.com>\nSigned-off-by: Alex Williamson <alex.williamson@redhat.com>\nSigned-off-by: Marcelo Tosatti <mtosatti@redhat.com>",
    "before_after_code_files": [
      "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c"
    ]
  },
  "patch_diff": {
    "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c": [
      "File: virt/kvm/kvm_main.c -> virt/kvm/kvm_main.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "822:   old_memslots = kvm->memslots;",
      "823:   rcu_assign_pointer(kvm->memslots, slots);",
      "824:   synchronize_srcu_expedited(&kvm->srcu);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "826:   kvm_iommu_unmap_pages(kvm, &old);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "837:  if (r)",
      "838:   goto out_free;",
      "848:  r = -ENOMEM;",
      "849:  slots = kmemdup(kvm->memslots, sizeof(struct kvm_memslots),",
      "850:    GFP_KERNEL);",
      "851:  if (!slots)",
      "852:   goto out_free;",
      "855:  if (!npages) {",
      "856:   new.dirty_bitmap = NULL;",
      "",
      "[Removed Lines]",
      "841:  if (npages) {",
      "842:   r = kvm_iommu_map_pages(kvm, &new);",
      "843:   if (r)",
      "844:    goto out_free;",
      "845:  } else",
      "846:   kvm_iommu_unmap_pages(kvm, &old);",
      "",
      "[Added Lines]",
      "849:  if (npages) {",
      "850:   r = kvm_iommu_map_pages(kvm, &new);",
      "851:   if (r)",
      "852:    goto out_slots;",
      "853:  }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "870:  return 0;",
      "872: out_free:",
      "873:  kvm_free_physmem_slot(&new, &old);",
      "874: out:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "873: out_slots:",
      "874:  kfree(slots);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "261874b0d5ebe2a5ccc544df7170d6559635e79a",
      "candidate_info": {
        "commit_hash": "261874b0d5ebe2a5ccc544df7170d6559635e79a",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/261874b0d5ebe2a5ccc544df7170d6559635e79a",
        "files": [
          "virt/kvm/kvm_main.c"
        ],
        "message": "kvm: Force IOMMU remapping on memory slot read-only flag changes\n\nMemory slot flags can be altered without changing other parameters of\nthe slot.  The read-only attribute is the only one the IOMMU cares\nabout, so generate an un-map, re-map when this occurs.  This also\navoid unnecessarily re-mapping the slot when no IOMMU visible changes\nare made.\n\nReviewed-by: Xiao Guangrong <xiaoguangrong@linux.vnet.ibm.com>\nSigned-off-by: Alex Williamson <alex.williamson@redhat.com>\nSigned-off-by: Gleb Natapov <gleb@redhat.com>",
        "before_after_code_files": [
          "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c"
          ],
          "candidate": [
            "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c"
          ]
        }
      },
      "candidate_diff": {
        "virt/kvm/kvm_main.c||virt/kvm/kvm_main.c": [
          "File: virt/kvm/kvm_main.c -> virt/kvm/kvm_main.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "731:  struct kvm_memory_slot *slot;",
          "732:  struct kvm_memory_slot old, new;",
          "733:  struct kvm_memslots *slots = NULL, *old_memslots;",
          "735:  r = check_memory_region_flags(mem);",
          "736:  if (r)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "734:  bool old_iommu_mapped;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "772:  new.npages = npages;",
          "773:  new.flags = mem->flags;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "776:  old_iommu_mapped = old.npages;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "837:   kvm_iommu_unmap_pages(kvm, &old);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "841:   old_iommu_mapped = false;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "863:    goto out_free;",
          "864:  }",
          "867:  if (npages) {",
          "871:  }",
          "",
          "[Removed Lines]",
          "868:   r = kvm_iommu_map_pages(kvm, &new);",
          "869:   if (r)",
          "870:    goto out_slots;",
          "",
          "[Added Lines]",
          "880:   if (old_iommu_mapped &&",
          "881:       ((new.flags ^ old.flags) & KVM_MEM_READONLY)) {",
          "882:    kvm_iommu_unmap_pages(kvm, &old);",
          "883:    old_iommu_mapped = false;",
          "884:   }",
          "886:   if (!old_iommu_mapped) {",
          "887:    r = kvm_iommu_map_pages(kvm, &new);",
          "888:    if (r)",
          "889:     goto out_slots;",
          "890:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}