{
  "cve_id": "CVE-2018-7998",
  "cve_desc": "In libvips before 8.6.3, a NULL function pointer dereference vulnerability was found in the vips_region_generate function in region.c, which allows remote attackers to cause a denial of service or possibly have unspecified other impact via a crafted image file. This occurs because of a race condition involving a failed delayed load and other worker threads.",
  "repo": "jcupitt/libvips",
  "patch_hash": "20d840e6da15c1574b3ed998bc92f91d1e36c2a5",
  "patch_info": {
    "commit_hash": "20d840e6da15c1574b3ed998bc92f91d1e36c2a5",
    "repo": "jcupitt/libvips",
    "commit_url": "https://github.com/jcupitt/libvips/commit/20d840e6da15c1574b3ed998bc92f91d1e36c2a5",
    "files": [
      "ChangeLog",
      "libvips/foreign/foreign.c",
      "libvips/include/vips/foreign.h"
    ],
    "message": "fix a crash with delayed load\n\nIf a delayed load failed, it could leave the pipeline only half-set up.\nSebsequent threads could then segv.\n\nSet a load-has-failed flag and test before generate.\n\nSee https://github.com/jcupitt/libvips/issues/893",
    "before_after_code_files": [
      "libvips/foreign/foreign.c||libvips/foreign/foreign.c",
      "libvips/include/vips/foreign.h||libvips/include/vips/foreign.h"
    ]
  },
  "patch_diff": {
    "libvips/foreign/foreign.c||libvips/foreign/foreign.c": [
      "File: libvips/foreign/foreign.c -> libvips/foreign/foreign.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "796:  VipsForeignLoad *load = VIPS_FOREIGN_LOAD( b );",
      "797:  VipsForeignLoadClass *class = VIPS_FOREIGN_LOAD_GET_CLASS( load );",
      "799:  if( !load->real ) {",
      "800:   if( !(load->real = vips_foreign_load_temp( load )) )",
      "801:    return( NULL );",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "803:  if( load->error )",
      "804:   return( NULL );",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "819:   g_object_set_qdata( G_OBJECT( load->real ),",
      "820:    vips__foreign_load_operation, load );",
      "834:    return( NULL );",
      "",
      "[Removed Lines]",
      "822:   if( class->load( load ) ||",
      "823:    vips_image_pio_input( load->real ) )",
      "824:    return( NULL );",
      "833:   if( !vips_foreign_load_iscompat( load->real, out ) )",
      "",
      "[Added Lines]",
      "840:   if( class->load( load ) ||",
      "841:    vips_image_pio_input( load->real ) ||",
      "842:    vips_foreign_load_iscompat( load->real, out ) ) {",
      "843:    vips_operation_invalidate( VIPS_OPERATION( load ) );",
      "844:    load->error = TRUE;",
      "847:   }",
      "",
      "---------------"
    ],
    "libvips/include/vips/foreign.h||libvips/include/vips/foreign.h": [
      "File: libvips/include/vips/foreign.h -> libvips/include/vips/foreign.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "160:  gboolean disc;",
      "161: } VipsForeignLoad;",
      "163: typedef struct _VipsForeignLoadClass {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "165:  gboolean error;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "178c2f399ac06a41dd440c1d8c5082cd36e72c62",
      "candidate_info": {
        "commit_hash": "178c2f399ac06a41dd440c1d8c5082cd36e72c62",
        "repo": "jcupitt/libvips",
        "commit_url": "https://github.com/jcupitt/libvips/commit/178c2f399ac06a41dd440c1d8c5082cd36e72c62",
        "files": [
          "libvips/foreign/foreign.c"
        ],
        "message": "oops, dropped a !",
        "before_after_code_files": [
          "libvips/foreign/foreign.c||libvips/foreign/foreign.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libvips/foreign/foreign.c||libvips/foreign/foreign.c"
          ],
          "candidate": [
            "libvips/foreign/foreign.c||libvips/foreign/foreign.c"
          ]
        }
      },
      "candidate_diff": {
        "libvips/foreign/foreign.c||libvips/foreign/foreign.c": [
          "File: libvips/foreign/foreign.c -> libvips/foreign/foreign.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "840:   if( class->load( load ) ||",
          "841:    vips_image_pio_input( load->real ) ||",
          "843:    vips_operation_invalidate( VIPS_OPERATION( load ) );",
          "844:    load->error = TRUE;",
          "",
          "[Removed Lines]",
          "842:    vips_foreign_load_iscompat( load->real, out ) ) {",
          "",
          "[Added Lines]",
          "842:    !vips_foreign_load_iscompat( load->real, out ) ) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}