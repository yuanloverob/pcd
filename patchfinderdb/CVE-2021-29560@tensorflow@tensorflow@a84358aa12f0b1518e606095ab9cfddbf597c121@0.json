{
  "cve_id": "CVE-2021-29560",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can cause a heap buffer overflow in `tf.raw_ops.RaggedTensorToTensor`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/d94227d43aa125ad8b54115c03cece54f6a1977b/tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc#L219-L222) uses the same index to access two arrays in parallel. Since the user controls the shape of the input arguments, an attacker could trigger a heap OOB access when `parent_output_index` is shorter than `row_split`. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "a84358aa12f0b1518e606095ab9cfddbf597c121",
  "patch_info": {
    "commit_hash": "a84358aa12f0b1518e606095ab9cfddbf597c121",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/a84358aa12f0b1518e606095ab9cfddbf597c121",
    "files": [
      "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
    ],
    "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
    "before_after_code_files": [
      "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
      "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "313:             output_index_multiplier, output_size, result);",
      "314:         return tensorflow::Status::OK();",
      "315:       case RowPartitionType::ROW_SPLITS:",
      "316:         CalculateOutputIndexRowSplit(",
      "317:             context, row_partition_tensor, parent_output_index,",
      "318:             output_index_multiplier, output_size, result);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
      "317:           return errors::InvalidArgument(",
      "318:               \"Row partition size is greater than output size: \",",
      "319:               row_partition_tensor.size() - 1, \" > \",",
      "320:               parent_output_index.size());",
      "321:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b9333d7f36539ebeb2e846b69673d32bad6a5914",
      "candidate_info": {
        "commit_hash": "b9333d7f36539ebeb2e846b69673d32bad6a5914",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b9333d7f36539ebeb2e846b69673d32bad6a5914",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "313:             output_index_multiplier, output_size, result);",
          "314:         return tensorflow::Status::OK();",
          "315:       case RowPartitionType::ROW_SPLITS:",
          "316:         CalculateOutputIndexRowSplit(",
          "317:             context, row_partition_tensor, parent_output_index,",
          "318:             output_index_multiplier, output_size, result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
          "317:           return errors::InvalidArgument(",
          "318:               \"Row partition size is greater than output size: \",",
          "319:               row_partition_tensor.size() - 1, \" > \",",
          "320:               parent_output_index.size());",
          "321:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e39f3841424749d224e0712b42bdcd6095fda926",
      "candidate_info": {
        "commit_hash": "e39f3841424749d224e0712b42bdcd6095fda926",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e39f3841424749d224e0712b42bdcd6095fda926",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "313:             output_index_multiplier, output_size, result);",
          "314:         return tensorflow::Status::OK();",
          "315:       case RowPartitionType::ROW_SPLITS:",
          "316:         CalculateOutputIndexRowSplit(",
          "317:             context, row_partition_tensor, parent_output_index,",
          "318:             output_index_multiplier, output_size, result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
          "317:           return errors::InvalidArgument(",
          "318:               \"Row partition size is greater than output size: \",",
          "319:               row_partition_tensor.size() - 1, \" > \",",
          "320:               parent_output_index.size());",
          "321:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "257c207406bdc90e5846b1d6cc9bf18fbb18ab98",
      "candidate_info": {
        "commit_hash": "257c207406bdc90e5846b1d6cc9bf18fbb18ab98",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/257c207406bdc90e5846b1d6cc9bf18fbb18ab98",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "313:             output_index_multiplier, output_size, result);",
          "314:         return tensorflow::Status::OK();",
          "315:       case RowPartitionType::ROW_SPLITS:",
          "316:         CalculateOutputIndexRowSplit(",
          "317:             context, row_partition_tensor, parent_output_index,",
          "318:             output_index_multiplier, output_size, result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
          "317:           return errors::InvalidArgument(",
          "318:               \"Row partition size is greater than output size: \",",
          "319:               row_partition_tensor.size() - 1, \" > \",",
          "320:               parent_output_index.size());",
          "321:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "09481ef55f8dc43e77a139041a02f078b53e2548",
      "candidate_info": {
        "commit_hash": "09481ef55f8dc43e77a139041a02f078b53e2548",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/09481ef55f8dc43e77a139041a02f078b53e2548",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "313:             output_index_multiplier, output_size, result);",
          "314:         return tensorflow::Status::OK();",
          "315:       case RowPartitionType::ROW_SPLITS:",
          "316:         CalculateOutputIndexRowSplit(",
          "317:             context, row_partition_tensor, parent_output_index,",
          "318:             output_index_multiplier, output_size, result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
          "317:           return errors::InvalidArgument(",
          "318:               \"Row partition size is greater than output size: \",",
          "319:               row_partition_tensor.size() - 1, \" > \",",
          "320:               parent_output_index.size());",
          "321:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9edc4e93c12327b4aa4204c67120d8239594be73",
      "candidate_info": {
        "commit_hash": "9edc4e93c12327b4aa4204c67120d8239594be73",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/9edc4e93c12327b4aa4204c67120d8239594be73",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.RaggedTensorToTensor`.\n\nPiperOrigin-RevId: 371986929\nChange-Id: I79ab962a22c5867f36f7f45b780a1ac881b1dbdd",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "313:             output_index_multiplier, output_size, result);",
          "314:         return tensorflow::Status::OK();",
          "315:       case RowPartitionType::ROW_SPLITS:",
          "316:         CalculateOutputIndexRowSplit(",
          "317:             context, row_partition_tensor, parent_output_index,",
          "318:             output_index_multiplier, output_size, result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:         if (row_partition_tensor.size() - 1 > parent_output_index.size()) {",
          "317:           return errors::InvalidArgument(",
          "318:               \"Row partition size is greater than output size: \",",
          "319:               row_partition_tensor.size() - 1, \" > \",",
          "320:               parent_output_index.size());",
          "321:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}