{
  "cve_id": "CVE-2016-0792",
  "cve_desc": "Multiple unspecified API endpoints in Jenkins before 1.650 and LTS before 1.642.2 allow remote authenticated users to execute arbitrary code via serialized data in an XML file, related to XStream and groovy.util.Expando.",
  "repo": "jenkinsci/jenkins",
  "patch_hash": "18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
  "patch_info": {
    "commit_hash": "18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
    "repo": "jenkinsci/jenkins",
    "commit_url": "https://github.com/jenkinsci/jenkins/commit/18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
    "files": [
      "core/src/main/java/hudson/util/XStream2.java",
      "test/src/test/java/hudson/util/XStream2Security247Test.java",
      "test/src/test/resources/hudson/util/XStream2Security247Test/config.xml"
    ],
    "message": "[FIX SECURITY-247] Prevent loading of MethodClosure from XML",
    "before_after_code_files": [
      "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java",
      "test/src/test/java/hudson/util/XStream2Security247Test.java||test/src/test/java/hudson/util/XStream2Security247Test.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java": [
      "File: core/src/main/java/hudson/util/XStream2.java -> core/src/main/java/hudson/util/XStream2.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "160:         registerConverter(new AssociatedConverterImpl(this), -10);",
      "162:         registerConverter(new DynamicProxyConverter(getMapper()) { // SECURITY-105 defense",
      "163:             @Override public boolean canConvert(Class type) {",
      "164:                 return /* this precedes NullConverter */ type != null && super.canConvert(type);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "162:         registerConverter(new BlacklistedTypesConverter(), PRIORITY_VERY_HIGH); // SECURITY-247 defense",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "435:     }",
      "437: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "439:     private static class BlacklistedTypesConverter implements Converter {",
      "440:         @Override",
      "441:         public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) {",
      "442:             throw new UnsupportedOperationException(\"Cannot marshal MethodClosure\");",
      "443:         }",
      "445:         @Override",
      "446:         public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {",
      "447:             throw new ConversionException(\"Cannot load MethodClosure for security reasons\");",
      "448:         }",
      "450:         @Override",
      "451:         public boolean canConvert(Class type) {",
      "452:             return type != null && \"org.codehaus.groovy.runtime.MethodClosure\".equals(type.getName());",
      "453:         }",
      "454:     }",
      "",
      "---------------"
    ],
    "test/src/test/java/hudson/util/XStream2Security247Test.java||test/src/test/java/hudson/util/XStream2Security247Test.java": [
      "File: test/src/test/java/hudson/util/XStream2Security247Test.java -> test/src/test/java/hudson/util/XStream2Security247Test.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: package hudson.util;",
      "3: import hudson.Functions;",
      "4: import hudson.model.Items;",
      "5: import org.apache.commons.io.FileUtils;",
      "6: import org.junit.Rule;",
      "7: import org.junit.Test;",
      "8: import org.jvnet.hudson.test.Issue;",
      "9: import org.jvnet.hudson.test.JenkinsRule;",
      "11: import java.io.File;",
      "13: import static org.junit.Assert.assertFalse;",
      "15: public class XStream2Security247Test {",
      "17:     @Rule",
      "18:     public JenkinsRule j = new JenkinsRule();",
      "20:     @Test",
      "21:     @Issue(\"SECURITY-247\")",
      "22:     public void dontUnmarshalMethodClosure() throws Exception {",
      "23:         if (Functions.isWindows())  return;",
      "24:         File exploitFile = new File(\"/tmp/jenkins-security247test\");",
      "25:         try {",
      "27:             if (exploitFile.exists() && !exploitFile.delete()) {",
      "28:                 throw new IllegalStateException(\"file exists and cannot be deleted\");",
      "29:             }",
      "30:             File tempJobDir = new File(j.jenkins.getRootDir(), \"security247\");",
      "31:             FileUtils.copyInputStreamToFile(XStream2Security247Test.class.getResourceAsStream(\"/hudson/util/XStream2Security247Test/config.xml\"),",
      "32:                     new File(tempJobDir, \"config.xml\"));",
      "33:             try {",
      "34:                 Items.load(j.jenkins, tempJobDir);",
      "35:             } catch (Exception e) {",
      "37:             }",
      "38:             assertFalse(\"no file should be created here\", exploitFile.exists());",
      "39:         } finally {",
      "40:             exploitFile.delete();",
      "41:         }",
      "42:     }",
      "43: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "37cea0a5e22fead9126cbf5ef5937f2cc953d9cc",
      "candidate_info": {
        "commit_hash": "37cea0a5e22fead9126cbf5ef5937f2cc953d9cc",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/37cea0a5e22fead9126cbf5ef5937f2cc953d9cc",
        "files": [
          "core/src/main/java/hudson/util/XStream2.java"
        ],
        "message": "[SECURITY-247] Need to call both overloads",
        "before_after_code_files": [
          "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [
            "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java"
          ],
          "candidate": [
            "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java"
          ]
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java": [
          "File: core/src/main/java/hudson/util/XStream2.java -> core/src/main/java/hudson/util/XStream2.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "454:                 return false;",
          "455:             }",
          "456:             try {",
          "457:                 ClassFilter.DEFAULT.check(type.getName());",
          "458:             } catch (SecurityException se) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "457:                 ClassFilter.DEFAULT.check(type);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1e804fdf2746e224d175d2de764111aa22860a25",
      "candidate_info": {
        "commit_hash": "1e804fdf2746e224d175d2de764111aa22860a25",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/1e804fdf2746e224d175d2de764111aa22860a25",
        "files": [
          "test/src/test/java/hudson/cli/CLIRegistererTest.java",
          "test/src/test/java/hudson/cli/GroovyshCommandTest.java",
          "test/src/test/java/hudson/cli/HelpCommandTest.java"
        ],
        "message": "Looks like an interesting form of a merge conflict.",
        "before_after_code_files": [
          "test/src/test/java/hudson/cli/CLIRegistererTest.java||test/src/test/java/hudson/cli/CLIRegistererTest.java",
          "test/src/test/java/hudson/cli/GroovyshCommandTest.java||test/src/test/java/hudson/cli/GroovyshCommandTest.java",
          "test/src/test/java/hudson/cli/HelpCommandTest.java||test/src/test/java/hudson/cli/HelpCommandTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/src/test/java/hudson/cli/CLIRegistererTest.java||test/src/test/java/hudson/cli/CLIRegistererTest.java": [
          "File: test/src/test/java/hudson/cli/CLIRegistererTest.java -> test/src/test/java/hudson/cli/CLIRegistererTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import static hudson.cli.CLICommandInvoker.Matcher.failedWith;",
          "4: import static hudson.cli.CLICommandInvoker.Matcher.succeededSilently;",
          "5: import static org.hamcrest.MatcherAssert.assertThat;",
          "7: import static org.hamcrest.CoreMatchers.is;",
          "9: import jenkins.model.Jenkins;",
          "",
          "[Removed Lines]",
          "6: import static org.hamcrest.CoreMatchers.containsString;",
          "",
          "[Added Lines]",
          "6: import static org.hamcrest.Matchers.containsString;",
          "",
          "---------------"
        ],
        "test/src/test/java/hudson/cli/GroovyshCommandTest.java||test/src/test/java/hudson/cli/GroovyshCommandTest.java": [
          "File: test/src/test/java/hudson/cli/GroovyshCommandTest.java -> test/src/test/java/hudson/cli/GroovyshCommandTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: import static hudson.cli.CLICommandInvoker.Matcher.*;",
          "28: import jenkins.model.Jenkins;",
          "29: import org.apache.tools.ant.filters.StringInputStream;",
          "31: import static org.junit.Assert.*;",
          "32: import org.junit.Rule;",
          "33: import org.junit.Test;",
          "",
          "[Removed Lines]",
          "30: import static org.hamcrest.CoreMatchers.containsString;",
          "",
          "[Added Lines]",
          "30: import static org.hamcrest.Matchers.containsString;",
          "",
          "---------------"
        ],
        "test/src/test/java/hudson/cli/HelpCommandTest.java||test/src/test/java/hudson/cli/HelpCommandTest.java": [
          "File: test/src/test/java/hudson/cli/HelpCommandTest.java -> test/src/test/java/hudson/cli/HelpCommandTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: import static hudson.cli.CLICommandInvoker.Matcher.*;",
          "28: import static org.junit.Assert.*;",
          "29: import static org.hamcrest.CoreMatchers.*;",
          "30: import static org.hamcrest.text.StringContainsInOrder.stringContainsInOrder;",
          "32: import java.io.PrintStream;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: import static org.hamcrest.Matchers.*;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "79e0b64322a6b15e0b80ac6511c9aa74383642be",
      "candidate_info": {
        "commit_hash": "79e0b64322a6b15e0b80ac6511c9aa74383642be",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/79e0b64322a6b15e0b80ac6511c9aa74383642be",
        "files": [
          "core/src/main/java/jenkins/security/ApiTokenProperty.java"
        ],
        "message": "[FIX SECURITY-241] Compare API tokens in constant time",
        "before_after_code_files": [
          "core/src/main/java/jenkins/security/ApiTokenProperty.java||core/src/main/java/jenkins/security/ApiTokenProperty.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/java/jenkins/security/ApiTokenProperty.java||core/src/main/java/jenkins/security/ApiTokenProperty.java": [
          "File: core/src/main/java/jenkins/security/ApiTokenProperty.java -> core/src/main/java/jenkins/security/ApiTokenProperty.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: import org.kohsuke.stapler.StaplerResponse;",
          "43: import java.io.IOException;",
          "44: import java.security.SecureRandom;",
          "45: import javax.annotation.Nonnull;",
          "46: import org.apache.commons.lang.StringUtils;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: import java.security.MessageDigest;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:     }",
          "111:     public boolean matchesPassword(String password) {",
          "113:     }",
          "115:     private boolean hasPermissionToSeeToken() {",
          "",
          "[Removed Lines]",
          "112:         return  getApiTokenInsecure().equals(password);",
          "",
          "[Added Lines]",
          "113:         String token = getApiTokenInsecure();",
          "114:         return MessageDigest.isEqual(password.getBytes(), token.getBytes());",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "76d1958ebe17bc89a5e8b249ecc965de728bd669",
      "candidate_info": {
        "commit_hash": "76d1958ebe17bc89a5e8b249ecc965de728bd669",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/76d1958ebe17bc89a5e8b249ecc965de728bd669",
        "files": [
          "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java"
        ],
        "message": "[SECURITY-245] Use US-ASCII to prevent charset issues",
        "before_after_code_files": [
          "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java||core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java||core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java": [
          "File: core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java -> core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: package hudson.security.csrf;",
          "8: import java.security.MessageDigest;",
          "9: import java.security.NoSuchAlgorithmException;",
          "10: import java.util.logging.Level;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: import java.nio.charset.Charset;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "96:             String newCrumb = issueCrumb(request, salt);",
          "97:             if ((newCrumb != null) && (crumb != null)) {",
          "100:             }",
          "101:         }",
          "102:         return false;",
          "",
          "[Removed Lines]",
          "99:                 return MessageDigest.isEqual(newCrumb.getBytes(), crumb.getBytes());",
          "",
          "[Added Lines]",
          "100:                 return MessageDigest.isEqual(newCrumb.getBytes(Charset.forName(\"US-ASCII\")),",
          "101:                         crumb.getBytes(Charset.forName(\"US-ASCII\")));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "679da79f5492249c713e3f887ccfa37d56043cba",
      "candidate_info": {
        "commit_hash": "679da79f5492249c713e3f887ccfa37d56043cba",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/679da79f5492249c713e3f887ccfa37d56043cba",
        "files": [
          "core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html"
        ],
        "message": "Update German localization\n\nRemoves mention of http.proxyHost property",
        "before_after_code_files": [
          "core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html||core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html||core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html": [
          "File: core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html -> core/src/main/resources/hudson/ProxyConfiguration/help-name_de.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:   und Plugins herunterzuladen.",
          "11:   <p>",
          "16:   <p>",
          "17:   Wenn Sie sich nicht sicher sind, was Sie hier eintragen sollen, schauen Sie",
          "18:   in der Proxy-Konfiguration Ihres Browsers nach.",
          "",
          "[Removed Lines]",
          "12:   Der Wert, den Sie hier angeben, wird als Systemeigenschaft <tt>http.proxyHost</tt>",
          "13:   gesetzt. Wenn Sie dieses Feld freilassen, wird die Systemeigenschaft gel\u00f6scht.",
          "14:   Jenkins versucht dann, das Update-Center direkt zu kontaktieren.",
          "19: </div>",
          "",
          "[Added Lines]",
          "12:   Wenn Sie dieses Feld freilassen, versucht Jenkins, das Update-Center direkt zu kontaktieren.",
          "",
          "---------------"
        ]
      }
    }
  ]
}