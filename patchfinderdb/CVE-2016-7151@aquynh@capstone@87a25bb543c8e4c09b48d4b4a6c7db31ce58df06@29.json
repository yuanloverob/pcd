{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4a0f327b0fabdc501602322c72750c346d6c0fa4",
      "candidate_info": {
        "commit_hash": "4a0f327b0fabdc501602322c72750c346d6c0fa4",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4a0f327b0fabdc501602322c72750c346d6c0fa4",
        "files": [
          "include/arm.h",
          "include/arm64.h",
          "include/capstone.h",
          "include/mips.h",
          "include/ppc.h",
          "include/sparc.h",
          "include/systemz.h",
          "include/x86.h",
          "include/xcore.h"
        ],
        "message": "replace stdint.h in API headers",
        "before_after_code_files": [
          "include/arm.h||include/arm.h",
          "include/arm64.h||include/arm64.h",
          "include/capstone.h||include/capstone.h",
          "include/mips.h||include/mips.h",
          "include/ppc.h||include/ppc.h",
          "include/sparc.h||include/sparc.h",
          "include/systemz.h||include/systemz.h",
          "include/x86.h||include/x86.h",
          "include/xcore.h||include/xcore.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/arm.h||include/arm.h": [
          "File: include/arm.h -> include/arm.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "14: #ifdef _MSC_VER",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/arm64.h||include/arm64.h": [
          "File: include/arm64.h -> include/arm64.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "14: #ifdef _MSC_VER",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/capstone.h||include/capstone.h": [
          "File: include/capstone.h -> include/capstone.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include <stdarg.h>",
          "13: #if defined(CAPSTONE_HAS_OSXKERNEL)",
          "14: #include <libkern/libkern.h>",
          "15: #else",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/mips.h||include/mips.h": [
          "File: include/mips.h -> include/mips.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/ppc.h||include/ppc.h": [
          "File: include/ppc.h -> include/ppc.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "14: #ifdef _MSC_VER",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/sparc.h||include/sparc.h": [
          "File: include/sparc.h -> include/sparc.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/systemz.h||include/systemz.h": [
          "File: include/systemz.h -> include/systemz.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "14: #ifdef _MSC_VER",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/x86.h||include/x86.h": [
          "File: include/x86.h -> include/x86.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "14: #define X86_REL_ADDR(insn) (insn.address + insn.size + insn.detail->x86.disp)",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ],
        "include/xcore.h||include/xcore.h": [
          "File: include/xcore.h -> include/xcore.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "12: #include \"platform.h\"",
          "14: #ifdef _MSC_VER",
          "",
          "[Removed Lines]",
          "11: #include \"../myinttypes.h\"",
          "",
          "[Added Lines]",
          "11: #include <stdint.h>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c19af63e538d9d18d5029c9d36c11538fe4fa1d0",
      "candidate_info": {
        "commit_hash": "c19af63e538d9d18d5029c9d36c11538fe4fa1d0",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c19af63e538d9d18d5029c9d36c11538fe4fa1d0",
        "files": [
          "arch/X86/X86GenAsmWriter.inc"
        ],
        "message": "x86: fix (AT&T) instruction lgs for issue #805",
        "before_after_code_files": [
          "arch/X86/X86GenAsmWriter.inc||arch/X86/X86GenAsmWriter.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86GenAsmWriter.inc||arch/X86/X86GenAsmWriter.inc": [
          "File: arch/X86/X86GenAsmWriter.inc -> arch/X86/X86GenAsmWriter.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "14181:       case X86_ROL32r1:",
          "14182:         SStream_concat0(O, \"rol\\t$1, \");",
          "14183:         break;",
          "14184:     }",
          "14185: #endif",
          "14186:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14184:       case X86_LGS64rm:",
          "14185:         SStream_concat0(O, \"lgs\\t\");",
          "14186:         break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "10e8323f26cea5f07cfa579616877ecfdd2303c3",
      "candidate_info": {
        "commit_hash": "10e8323f26cea5f07cfa579616877ecfdd2303c3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/10e8323f26cea5f07cfa579616877ecfdd2303c3",
        "files": [
          "arch/X86/X86Disassembler.c"
        ],
        "message": "Bugfix : setting all fields to insns cache (#899)\n\n* Bugfix : setting all fields to insns cache\n\n* Bugfix\nFixing root cause, not setting opcode to 0 in default case\n\n* Not resetting opcode to 0 in this case as well\n\n* Finalizing bugfix",
        "before_after_code_files": [
          "arch/X86/X86Disassembler.c||arch/X86/X86Disassembler.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86Disassembler.c||arch/X86/X86Disassembler.c": [
          "File: arch/X86/X86Disassembler.c -> arch/X86/X86Disassembler.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "230:     case X86_CMPSSrr:  NewOpc = X86_CMPSSrr_alt;  break;",
          "231:    }",
          "234:   }",
          "235: #endif",
          "236:  } else if (type == TYPE_IMM5) {",
          "",
          "[Removed Lines]",
          "233:    MCInst_setOpcode(mcInst, NewOpc);",
          "",
          "[Added Lines]",
          "233:    if (NewOpc != 0) {",
          "234:     MCInst_setOpcode(mcInst, NewOpc);",
          "235:    }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "263:     case X86_VCMPSSZrr:  NewOpc = X86_VCMPSSZrri_alt; break;",
          "264:    }",
          "267:   }",
          "268: #endif",
          "269:  }",
          "",
          "[Removed Lines]",
          "266:    MCInst_setOpcode(mcInst, NewOpc);",
          "",
          "[Added Lines]",
          "268:    if (NewOpc != 0) {",
          "269:     MCInst_setOpcode(mcInst, NewOpc);",
          "270:    }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "10a9c3ac86260f4e361b8b0a30d81e21b4aa1968",
      "candidate_info": {
        "commit_hash": "10a9c3ac86260f4e361b8b0a30d81e21b4aa1968",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/10a9c3ac86260f4e361b8b0a30d81e21b4aa1968",
        "files": [
          "bindings/python/setup.py",
          "bindings/python/setup_cython.py"
        ],
        "message": "Python: remove special case for cygwin build",
        "before_after_code_files": [
          "bindings/python/setup.py||bindings/python/setup.py",
          "bindings/python/setup_cython.py||bindings/python/setup_cython.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "99:         # Do not build tests & static library",
          "100:         os.system('cmake -DCMAKE_BUILD_TYPE=RELEASE -DCAPSTONE_BUILD_TESTS=0 -DCAPSTONE_BUILD_STATIC=0 -G \"NMake Makefiles\" ..')",
          "101:         os.system(\"nmake\")",
          "108:         os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh\")",
          "110:     shutil.copy(LIBRARY_FILE, LIBS_DIR)",
          "",
          "[Removed Lines]",
          "102:     elif SYSTEM == \"cygwin\":",
          "103:         if IS_64BITS:",
          "104:             os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh cygwin-mingw64\")",
          "105:         else:",
          "106:             os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh cygwin-mingw32\")",
          "107:     else:   # Unix",
          "",
          "[Added Lines]",
          "102:     else:   # Unix incl. cygwin",
          "",
          "---------------"
        ],
        "bindings/python/setup_cython.py||bindings/python/setup_cython.py": [
          "File: bindings/python/setup_cython.py -> bindings/python/setup_cython.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "90:         # Do not build tests & static library",
          "91:         os.system('cmake -DCMAKE_BUILD_TYPE=RELEASE -DCAPSTONE_BUILD_TESTS=0 -DCAPSTONE_BUILD_STATIC=0 -G \"NMake Makefiles\" ..')",
          "92:         os.system(\"nmake\")",
          "100:         os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh\")",
          "102:     shutil.copy(LIBRARY_FILE, LIBS_DIR)",
          "",
          "[Removed Lines]",
          "93:     elif SYSTEM == \"cygwin\":",
          "94:         if IS_64BITS:",
          "95:             os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh cygwin-mingw64\")",
          "96:         else:",
          "97:             os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes bash ./make.sh cygwin-mingw32\")",
          "99:     else:   # Unix",
          "",
          "[Added Lines]",
          "93:     else:   # Unix incl. cygwin",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4834cd2700bc852baa30180f16701a4c79aee2fa",
      "candidate_info": {
        "commit_hash": "4834cd2700bc852baa30180f16701a4c79aee2fa",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4834cd2700bc852baa30180f16701a4c79aee2fa",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: initialize i in preprocess(). this fixes compilation issue for MSVC",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: static uint8_t *preprocess(char *code, size_t *size)",
          "30: {",
          "32:  uint8_t high, low;",
          "33:  uint8_t *result;",
          "",
          "[Removed Lines]",
          "31:  size_t i, j = 0;",
          "",
          "[Added Lines]",
          "31:  size_t i = 0, j = 0;",
          "",
          "---------------"
        ]
      }
    }
  ]
}