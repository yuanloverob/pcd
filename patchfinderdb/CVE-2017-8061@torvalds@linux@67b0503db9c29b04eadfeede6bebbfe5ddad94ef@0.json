{
  "cve_id": "CVE-2017-8061",
  "cve_desc": "drivers/media/usb/dvb-usb/dvb-usb-firmware.c in the Linux kernel 4.9.x and 4.10.x before 4.10.7 interacts incorrectly with the CONFIG_VMAP_STACK option, which allows local users to cause a denial of service (system crash or memory corruption) or possibly have unspecified other impact by leveraging use of more than one virtual page for a DMA scatterlist.",
  "repo": "torvalds/linux",
  "patch_hash": "67b0503db9c29b04eadfeede6bebbfe5ddad94ef",
  "patch_info": {
    "commit_hash": "67b0503db9c29b04eadfeede6bebbfe5ddad94ef",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/67b0503db9c29b04eadfeede6bebbfe5ddad94ef",
    "files": [
      "drivers/media/usb/dvb-usb/dvb-usb-firmware.c"
    ],
    "message": "[media] dvb-usb-firmware: don't do DMA on stack\n\nThe buffer allocation for the firmware data was changed in\ncommit 43fab9793c1f (\"[media] dvb-usb: don't use stack for firmware load\")\nbut the same applies for the reset value.\n\nFixes: 43fab9793c1f (\"[media] dvb-usb: don't use stack for firmware load\")\nCc: stable@vger.kernel.org\nSigned-off-by: Stefan Br\u00fcns <stefan.bruens@rwth-aachen.de>\nSigned-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>",
    "before_after_code_files": [
      "drivers/media/usb/dvb-usb/dvb-usb-firmware.c||drivers/media/usb/dvb-usb/dvb-usb-firmware.c"
    ]
  },
  "patch_diff": {
    "drivers/media/usb/dvb-usb/dvb-usb-firmware.c||drivers/media/usb/dvb-usb/dvb-usb-firmware.c": [
      "File: drivers/media/usb/dvb-usb/dvb-usb-firmware.c -> drivers/media/usb/dvb-usb/dvb-usb-firmware.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "36: int usb_cypress_load_firmware(struct usb_device *udev, const struct firmware *fw, int type)",
      "37: {",
      "38:  struct hexline *hx;",
      "44:   return -ENOMEM;",
      "49:   err(\"could not stop the USB controller CPU.\");",
      "51:  while ((ret = dvb_usb_get_hexline(fw, hx, &pos)) > 0) {",
      "",
      "[Removed Lines]",
      "39:  u8 reset;",
      "40:  int ret,pos=0;",
      "42:  hx = kmalloc(sizeof(*hx), GFP_KERNEL);",
      "43:  if (!hx)",
      "47:  reset = 1;",
      "48:  if ((ret = usb_cypress_writemem(udev,cypress[type].cpu_cs_register,&reset,1)) != 1)",
      "",
      "[Added Lines]",
      "39:  u8 *buf;",
      "40:  int ret, pos = 0;",
      "41:  u16 cpu_cs_register = cypress[type].cpu_cs_register;",
      "43:  buf = kmalloc(sizeof(*hx), GFP_KERNEL);",
      "44:  if (!buf)",
      "46:  hx = (struct hexline *)buf;",
      "49:  buf[0] = 1;",
      "50:  if (usb_cypress_writemem(udev, cpu_cs_register, buf, 1) != 1)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "61:  }",
      "62:  if (ret < 0) {",
      "63:   err(\"firmware download failed at %d with %d\",pos,ret);",
      "65:   return ret;",
      "66:  }",
      "68:  if (ret == 0) {",
      "72:    err(\"could not restart the USB controller CPU.\");",
      "73:    ret = -EINVAL;",
      "74:   }",
      "75:  } else",
      "76:   ret = -EIO;",
      "80:  return ret;",
      "81: }",
      "",
      "[Removed Lines]",
      "64:   kfree(hx);",
      "70:   reset = 0;",
      "71:   if (ret || usb_cypress_writemem(udev,cypress[type].cpu_cs_register,&reset,1) != 1) {",
      "78:  kfree(hx);",
      "",
      "[Added Lines]",
      "66:   kfree(buf);",
      "72:   buf[0] = 0;",
      "73:   if (usb_cypress_writemem(udev, cpu_cs_register, buf, 1) != 1) {",
      "80:  kfree(buf);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "43fab9793c1f44e665b4f98035a14942edf03ddc",
      "candidate_info": {
        "commit_hash": "43fab9793c1f44e665b4f98035a14942edf03ddc",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/43fab9793c1f44e665b4f98035a14942edf03ddc",
        "files": [
          "drivers/media/usb/dvb-usb/dvb-usb-firmware.c"
        ],
        "message": "[media] dvb-usb: don't use stack for firmware load\n\nAs reported by Marc Duponcheel <marc@offline.be>, firmware load on\ndvb-usb is using the stack, with is not allowed anymore on default\nKernel configurations:\n\n[ 1025.958836] dvb-usb: found a 'WideView WT-220U PenType Receiver (based on ZL353)' in cold state, will try to load a firmware\n[ 1025.958853] dvb-usb: downloading firmware from file 'dvb-usb-wt220u-zl0353-01.fw'\n[ 1025.958855] dvb-usb: could not stop the USB controller CPU.\n[ 1025.958856] dvb-usb: error while transferring firmware (transferred size: -11, block size: 3)\n[ 1025.958856] dvb-usb: firmware download failed at 8 with -22\n[ 1025.958867] usbcore: registered new interface driver dvb_usb_dtt200u\n\n[    2.789902] dvb-usb: downloading firmware from file 'dvb-usb-wt220u-zl0353-01.fw'\n[    2.789905] ------------[ cut here ]------------\n[    2.789911] WARNING: CPU: 3 PID: 2196 at drivers/usb/core/hcd.c:1584 usb_hcd_map_urb_for_dma+0x430/0x560 [usbcore]\n[    2.789912] transfer buffer not dma capable\n[    2.789912] Modules linked in: btusb dvb_usb_dtt200u(+) dvb_usb_af9035(+) btrtl btbcm dvb_usb dvb_usb_v2 btintel dvb_core bluetooth rc_core rfkill x86_pkg_temp_thermal intel_powerclamp coretemp crc32_pclmul aesni_intel aes_x86_64 glue_helper lrw gf128mul ablk_helper cryptd drm_kms_helper syscopyarea sysfillrect pcspkr i2c_i801 sysimgblt fb_sys_fops drm i2c_smbus i2c_core r8169 lpc_ich mfd_core mii thermal fan rtc_cmos video button acpi_cpufreq processor snd_hda_codec_realtek snd_hda_codec_generic snd_hda_intel snd_hda_codec snd_hwdep snd_hda_core snd_pcm snd_timer snd crc32c_intel ahci libahci libata xhci_pci ehci_pci xhci_hcd ehci_hcd usbcore usb_common dm_mirror dm_region_hash dm_log dm_mod\n[    2.789936] CPU: 3 PID: 2196 Comm: systemd-udevd Not tainted 4.9.0-gentoo #1\n[    2.789937] Hardware name: ASUS All Series/H81I-PLUS, BIOS 0401 07/23/2013\n[    2.789938]  ffffc9000339b690 ffffffff812bd397 ffffc9000339b6e0 0000000000000000\n[    2.789939]  ffffc9000339b6d0 ffffffff81055c86 000006300339b6a0 ffff880116c0c000\n[    2.789941]  0000000000000000 0000000000000000 0000000000000001 ffff880116c08000\n[    2.789942] Call Trace:\n[    2.789945]  [<ffffffff812bd397>] dump_stack+0x4d/0x66\n[    2.789947]  [<ffffffff81055c86>] __warn+0xc6/0xe0\n[    2.789948]  [<ffffffff81055cea>] warn_slowpath_fmt+0x4a/0x50\n[    2.789952]  [<ffffffffa006d460>] usb_hcd_map_urb_for_dma+0x430/0x560 [usbcore]\n[    2.789954]  [<ffffffff814ed5a8>] ? io_schedule_timeout+0xd8/0x110\n[    2.789956]  [<ffffffffa006e09c>] usb_hcd_submit_urb+0x9c/0x980 [usbcore]\n[    2.789958]  [<ffffffff812d0ebf>] ? copy_page_to_iter+0x14f/0x2b0\n[    2.789960]  [<ffffffff81126818>] ? pagecache_get_page+0x28/0x240\n[    2.789962]  [<ffffffff8118c2a0>] ? touch_atime+0x20/0xa0\n[    2.789964]  [<ffffffffa006f7c4>] usb_submit_urb+0x2c4/0x520 [usbcore]\n[    2.789967]  [<ffffffffa006feca>] usb_start_wait_urb+0x5a/0xe0 [usbcore]\n[    2.789969]  [<ffffffffa007000c>] usb_control_msg+0xbc/0xf0 [usbcore]\n[    2.789970]  [<ffffffffa067903d>] usb_cypress_writemem+0x3d/0x40 [dvb_usb]\n[    2.789972]  [<ffffffffa06791cf>] usb_cypress_load_firmware+0x4f/0x130 [dvb_usb]\n[    2.789973]  [<ffffffff8109dbbe>] ? console_unlock+0x2fe/0x5d0\n[    2.789974]  [<ffffffff8109e10c>] ? vprintk_emit+0x27c/0x410\n[    2.789975]  [<ffffffff8109e40a>] ? vprintk_default+0x1a/0x20\n[    2.789976]  [<ffffffff81124d76>] ? printk+0x43/0x4b\n[    2.789977]  [<ffffffffa0679310>] dvb_usb_download_firmware+0x60/0xd0 [dvb_usb]\n[    2.789979]  [<ffffffffa0679898>] dvb_usb_device_init+0x3d8/0x610 [dvb_usb]\n[    2.789981]  [<ffffffffa069e302>] dtt200u_usb_probe+0x92/0xd0 [dvb_usb_dtt200u]\n[    2.789984]  [<ffffffffa007420c>] usb_probe_interface+0xfc/0x270 [usbcore]\n[    2.789985]  [<ffffffff8138bf95>] driver_probe_device+0x215/0x2d0\n[    2.789986]  [<ffffffff8138c0e6>] __driver_attach+0x96/0xa0\n[    2.789987]  [<ffffffff8138c050>] ? driver_probe_device+0x2d0/0x2d0\n[    2.789988]  [<ffffffff81389ffb>] bus_for_each_dev+0x5b/0x90\n[    2.789989]  [<ffffffff8138b7b9>] driver_attach+0x19/0x20\n[    2.789990]  [<ffffffff8138b33c>] bus_add_driver+0x11c/0x220\n[    2.789991]  [<ffffffff8138c91b>] driver_register+0x5b/0xd0\n[    2.789994]  [<ffffffffa0072f6c>] usb_register_driver+0x7c/0x130 [usbcore]\n[    2.789994]  [<ffffffffa06a5000>] ? 0xffffffffa06a5000\n[    2.789996]  [<ffffffffa06a501e>] dtt200u_usb_driver_init+0x1e/0x20 [dvb_usb_dtt200u]\n[    2.789997]  [<ffffffff81000408>] do_one_initcall+0x38/0x140\n[    2.789998]  [<ffffffff8116001c>] ? __vunmap+0x7c/0xc0\n[    2.789999]  [<ffffffff81124fb0>] ? do_init_module+0x22/0x1d2\n[    2.790000]  [<ffffffff81124fe8>] do_init_module+0x5a/0x1d2\n[    2.790002]  [<ffffffff810c96b1>] load_module+0x1e11/0x2580\n[    2.790003]  [<ffffffff810c68b0>] ? show_taint+0x30/0x30\n[    2.790004]  [<ffffffff81177250>] ? kernel_read_file+0x100/0x190\n[    2.790005]  [<ffffffff810c9ffa>] SyS_finit_module+0xba/0xc0\n[    2.790007]  [<ffffffff814f13e0>] entry_SYSCALL_64_fastpath+0x13/0x94\n[    2.790008] ---[ end trace c78a74e78baec6fc ]---\n\nSo, allocate the structure dynamically.\n\nCc: stable@vger.kernel.org # Kernel 4.9+\nSigned-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>",
        "before_after_code_files": [
          "drivers/mediusb/dvb-usb/dvb-usb-firmware.c||drivers/media/usdvb-usdvb-usb-firmware.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/mediusb/dvb-usb/dvb-usb-firmware.c||drivers/media/usdvb-usdvb-usb-firmware.c": [
          "File: drivers/mediusb/dvb-usb/dvb-usb-firmware.c -> drivers/media/usdvb-usdvb-usb-firmware.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}