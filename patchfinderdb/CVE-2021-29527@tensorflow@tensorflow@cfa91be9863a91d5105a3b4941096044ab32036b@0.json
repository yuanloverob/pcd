{
  "cve_id": "CVE-2021-29527",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can trigger a division by 0 in `tf.raw_ops.QuantizedConv2D`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/00e9a4d67d76703fa1aee33dac582acf317e0e81/tensorflow/core/kernels/quantized_conv_ops.cc#L257-L259) does a division by a quantity that is controlled by the caller. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "cfa91be9863a91d5105a3b4941096044ab32036b",
  "patch_info": {
    "commit_hash": "cfa91be9863a91d5105a3b4941096044ab32036b",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/cfa91be9863a91d5105a3b4941096044ab32036b",
    "files": [
      "tensorflow/core/kernels/quantized_conv_ops.cc"
    ],
    "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
    "before_after_code_files": [
      "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
      "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "18: #include <algorithm>",
      "19: #include <vector>",
      "21: #define EIGEN_USE_THREADS",
      "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "21: #include \"tensorflow/core/platform/errors.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "227:       return;",
      "228:     }",
      "232:     int filter_left_offset;",
      "233:     int filter_top_offset;",
      "234:     if (padding == VALID) {",
      "",
      "[Removed Lines]",
      "230:     CHECK_GT(output_width, 0);",
      "231:     CHECK_GT(output_height, 0);",
      "",
      "[Added Lines]",
      "232:     OP_REQUIRES(",
      "233:         context, output_width > 0,",
      "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
      "235:     OP_REQUIRES(",
      "236:         context, output_height > 0,",
      "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
      "258:     const int64 patches_per_chunk =",
      "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
      "260:     const int64 chunk_value_count =",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "264:     OP_REQUIRES(context, filter_value_count > 0,",
      "265:                 errors::InvalidArgument(",
      "266:                     \"filter patch must contain at least one element\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "58bdebb1c7b1d5685e14d830300f01b53a2f5877",
      "candidate_info": {
        "commit_hash": "58bdebb1c7b1d5685e14d830300f01b53a2f5877",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/58bdebb1c7b1d5685e14d830300f01b53a2f5877",
        "files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc"
        ],
        "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
          "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "19: #include <vector>",
          "21: #define EIGEN_USE_THREADS",
          "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227:       return;",
          "228:     }",
          "232:     int filter_left_offset;",
          "233:     int filter_top_offset;",
          "234:     if (padding == VALID) {",
          "",
          "[Removed Lines]",
          "230:     CHECK_GT(output_width, 0);",
          "231:     CHECK_GT(output_height, 0);",
          "",
          "[Added Lines]",
          "232:     OP_REQUIRES(",
          "233:         context, output_width > 0,",
          "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
          "235:     OP_REQUIRES(",
          "236:         context, output_height > 0,",
          "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
          "258:     const int64 patches_per_chunk =",
          "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
          "260:     const int64 chunk_value_count =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     OP_REQUIRES(context, filter_value_count > 0,",
          "265:                 errors::InvalidArgument(",
          "266:                     \"filter patch must contain at least one element\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "59194ba5279b03737919d852ef4a2179fa68c68a",
      "candidate_info": {
        "commit_hash": "59194ba5279b03737919d852ef4a2179fa68c68a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/59194ba5279b03737919d852ef4a2179fa68c68a",
        "files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc"
        ],
        "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
          "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "19: #include <vector>",
          "21: #define EIGEN_USE_THREADS",
          "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227:       return;",
          "228:     }",
          "232:     int filter_left_offset;",
          "233:     int filter_top_offset;",
          "234:     if (padding == VALID) {",
          "",
          "[Removed Lines]",
          "230:     CHECK_GT(output_width, 0);",
          "231:     CHECK_GT(output_height, 0);",
          "",
          "[Added Lines]",
          "232:     OP_REQUIRES(",
          "233:         context, output_width > 0,",
          "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
          "235:     OP_REQUIRES(",
          "236:         context, output_height > 0,",
          "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
          "258:     const int64 patches_per_chunk =",
          "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
          "260:     const int64 chunk_value_count =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     OP_REQUIRES(context, filter_value_count > 0,",
          "265:                 errors::InvalidArgument(",
          "266:                     \"filter patch must contain at least one element\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "71f4fed4768a0e356508afe77b98c0484e354d1e",
      "candidate_info": {
        "commit_hash": "71f4fed4768a0e356508afe77b98c0484e354d1e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/71f4fed4768a0e356508afe77b98c0484e354d1e",
        "files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc"
        ],
        "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
          "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "19: #include <vector>",
          "21: #define EIGEN_USE_THREADS",
          "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227:       return;",
          "228:     }",
          "232:     int filter_left_offset;",
          "233:     int filter_top_offset;",
          "234:     if (padding == VALID) {",
          "",
          "[Removed Lines]",
          "230:     CHECK_GT(output_width, 0);",
          "231:     CHECK_GT(output_height, 0);",
          "",
          "[Added Lines]",
          "232:     OP_REQUIRES(",
          "233:         context, output_width > 0,",
          "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
          "235:     OP_REQUIRES(",
          "236:         context, output_height > 0,",
          "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
          "258:     const int64 patches_per_chunk =",
          "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
          "260:     const int64 chunk_value_count =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     OP_REQUIRES(context, filter_value_count > 0,",
          "265:                 errors::InvalidArgument(",
          "266:                     \"filter patch must contain at least one element\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f8d84439902ecdea8abe951bacf3b1005109c8e3",
      "candidate_info": {
        "commit_hash": "f8d84439902ecdea8abe951bacf3b1005109c8e3",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f8d84439902ecdea8abe951bacf3b1005109c8e3",
        "files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc"
        ],
        "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
          "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "19: #include <vector>",
          "21: #define EIGEN_USE_THREADS",
          "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227:       return;",
          "228:     }",
          "232:     int filter_left_offset;",
          "233:     int filter_top_offset;",
          "234:     if (padding == VALID) {",
          "",
          "[Removed Lines]",
          "230:     CHECK_GT(output_width, 0);",
          "231:     CHECK_GT(output_height, 0);",
          "",
          "[Added Lines]",
          "232:     OP_REQUIRES(",
          "233:         context, output_width > 0,",
          "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
          "235:     OP_REQUIRES(",
          "236:         context, output_height > 0,",
          "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
          "258:     const int64 patches_per_chunk =",
          "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
          "260:     const int64 chunk_value_count =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     OP_REQUIRES(context, filter_value_count > 0,",
          "265:                 errors::InvalidArgument(",
          "266:                     \"filter patch must contain at least one element\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "50f3b08159c6b238e666ec34eeb948bf8ff68974",
      "candidate_info": {
        "commit_hash": "50f3b08159c6b238e666ec34eeb948bf8ff68974",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/50f3b08159c6b238e666ec34eeb948bf8ff68974",
        "files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc"
        ],
        "message": "Fix one FPE and remove two CHECK-fails.\n\nPiperOrigin-RevId: 369349640\nChange-Id: I1fedbfc2b5bab635c5cb51f103d7c9176f79831a",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_conv_ops.cc||tensorflow/core/kernels/quantized_conv_ops.cc": [
          "File: tensorflow/core/kernels/quantized_conv_ops.cc -> tensorflow/core/kernels/quantized_conv_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "19: #include <vector>",
          "21: #define EIGEN_USE_THREADS",
          "23: #define GEMMLOWP_ALLOW_SLOW_SCALAR_FALLBACK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227:       return;",
          "228:     }",
          "232:     int filter_left_offset;",
          "233:     int filter_top_offset;",
          "234:     if (padding == VALID) {",
          "",
          "[Removed Lines]",
          "230:     CHECK_GT(output_width, 0);",
          "231:     CHECK_GT(output_height, 0);",
          "",
          "[Added Lines]",
          "232:     OP_REQUIRES(",
          "233:         context, output_width > 0,",
          "234:         errors::InvalidArgument(\"output_width must be strictly positive\"));",
          "235:     OP_REQUIRES(",
          "236:         context, output_height > 0,",
          "237:         errors::InvalidArgument(\"output_height must be strictly positive\"));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "257:     const int filter_value_count = filter_width * filter_height * input_depth;",
          "258:     const int64 patches_per_chunk =",
          "259:         kMaxChunkSize / (filter_value_count * sizeof(T1));",
          "260:     const int64 chunk_value_count =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     OP_REQUIRES(context, filter_value_count > 0,",
          "265:                 errors::InvalidArgument(",
          "266:                     \"filter patch must contain at least one element\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}