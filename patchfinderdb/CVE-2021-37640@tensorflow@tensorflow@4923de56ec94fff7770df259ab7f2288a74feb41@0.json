{
  "cve_id": "CVE-2021-37640",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions the implementation of `tf.raw_ops.SparseReshape` can be made to trigger an integral division by 0 exception. The [implementation](https://github.com/tensorflow/tensorflow/blob/8d72537c6abf5a44103b57b9c2e22c14f5f49698/tensorflow/core/kernels/reshape_util.cc#L176-L181) calls the reshaping functor whenever there is at least an index in the input but does not check that shape of the input or the target shape have both a non-zero number of elements. The [reshape functor](https://github.com/tensorflow/tensorflow/blob/8d72537c6abf5a44103b57b9c2e22c14f5f49698/tensorflow/core/kernels/reshape_util.cc#L40-L78) blindly divides by the dimensions of the target shape. Hence, if this is not checked, code will result in a division by 0. We have patched the issue in GitHub commit 4923de56ec94fff7770df259ab7f2288a74feb41. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1 as this is the other affected version.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "4923de56ec94fff7770df259ab7f2288a74feb41",
  "patch_info": {
    "commit_hash": "4923de56ec94fff7770df259ab7f2288a74feb41",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/4923de56ec94fff7770df259ab7f2288a74feb41",
    "files": [
      "tensorflow/core/kernels/reshape_util.cc"
    ],
    "message": "Don't do any work when reshaping 0 elements sparse tensor.\n\nIf reshaping to 0 elements tensor, check that input has no elements.\nIf reshaping no elements input, check that output has no elements.\n\nPiperOrigin-RevId: 388296986\nChange-Id: Iadc9fe7252e14313ca987e69bf0d7042fd10232a",
    "before_after_code_files": [
      "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc": [
      "File: tensorflow/core/kernels/reshape_util.cc -> tensorflow/core/kernels/reshape_util.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "174:                                           TensorShape({nnz, output_rank}),",
      "175:                                           &result_indices));",
      "176:   if (nnz > 0) {",
      "177:     OP_REQUIRES_OK(context, functor::ReshapeSparseTensorFunctor<Device>()(",
      "178:                                 context, input_shape, output_shape,",
      "179:                                 input_indices_in.matrix<int64>(),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "177:     OP_REQUIRES(",
      "178:         context, dense_size > 0 && product > 0,",
      "179:         errors::InvalidArgument(",
      "180:             \"Input tensor has \", nnz, \" non zero elements but input shape (\",",
      "181:             input_shape.DebugString(), \") or output shape (\",",
      "182:             output_shape.DebugString(), \") is empty\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ce3a94c60e0a2057b49b329696841fb198f3ab3b",
      "candidate_info": {
        "commit_hash": "ce3a94c60e0a2057b49b329696841fb198f3ab3b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ce3a94c60e0a2057b49b329696841fb198f3ab3b",
        "files": [
          "tensorflow/core/kernels/reshape_util.cc"
        ],
        "message": "Don't do any work when reshaping 0 elements sparse tensor.\n\nIf reshaping to 0 elements tensor, check that input has no elements.\nIf reshaping no elements input, check that output has no elements.\n\nPiperOrigin-RevId: 388296986\nChange-Id: Iadc9fe7252e14313ca987e69bf0d7042fd10232a",
        "before_after_code_files": [
          "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc": [
          "File: tensorflow/core/kernels/reshape_util.cc -> tensorflow/core/kernels/reshape_util.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "174:                                           TensorShape({nnz, output_rank}),",
          "175:                                           &result_indices));",
          "176:   if (nnz > 0) {",
          "177:     OP_REQUIRES_OK(context, functor::ReshapeSparseTensorFunctor<Device>()(",
          "178:                                 context, input_shape, output_shape,",
          "179:                                 input_indices_in.matrix<int64>(),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "177:     OP_REQUIRES(",
          "178:         context, dense_size > 0 && product > 0,",
          "179:         errors::InvalidArgument(",
          "180:             \"Input tensor has \", nnz, \" non zero elements but input shape (\",",
          "181:             input_shape.DebugString(), \") or output shape (\",",
          "182:             output_shape.DebugString(), \") is empty\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dd34ec974f1f6e932be6fa98c0a51e37b99c453b",
      "candidate_info": {
        "commit_hash": "dd34ec974f1f6e932be6fa98c0a51e37b99c453b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/dd34ec974f1f6e932be6fa98c0a51e37b99c453b",
        "files": [
          "tensorflow/core/kernels/reshape_util.cc"
        ],
        "message": "Don't do any work when reshaping 0 elements sparse tensor.\n\nIf reshaping to 0 elements tensor, check that input has no elements.\nIf reshaping no elements input, check that output has no elements.\n\nPiperOrigin-RevId: 388296986\nChange-Id: Iadc9fe7252e14313ca987e69bf0d7042fd10232a",
        "before_after_code_files": [
          "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/reshape_util.cc||tensorflow/core/kernels/reshape_util.cc": [
          "File: tensorflow/core/kernels/reshape_util.cc -> tensorflow/core/kernels/reshape_util.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "174:                                           TensorShape({nnz, output_rank}),",
          "175:                                           &result_indices));",
          "176:   if (nnz > 0) {",
          "177:     OP_REQUIRES_OK(context, functor::ReshapeSparseTensorFunctor<Device>()(",
          "178:                                 context, input_shape, output_shape,",
          "179:                                 input_indices_in.matrix<int64>(),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "177:     OP_REQUIRES(",
          "178:         context, dense_size > 0 && product > 0,",
          "179:         errors::InvalidArgument(",
          "180:             \"Input tensor has \", nnz, \" non zero elements but input shape (\",",
          "181:             input_shape.DebugString(), \") or output shape (\",",
          "182:             output_shape.DebugString(), \") is empty\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}