{
  "cve_id": "CVE-2016-5873",
  "cve_desc": "Buffer overflow in the HTTP URL parsing functions in pecl_http before 3.0.1 might allow remote attackers to execute arbitrary code via non-printable characters in a URL.",
  "repo": "m6w6/ext-http",
  "patch_hash": "3724cd76a28be1d6049b5537232e97ac567ae1f5",
  "patch_info": {
    "commit_hash": "3724cd76a28be1d6049b5537232e97ac567ae1f5",
    "repo": "m6w6/ext-http",
    "commit_url": "https://github.com/m6w6/ext-http/commit/3724cd76a28be1d6049b5537232e97ac",
    "files": [
      ".gitattributes",
      "src/php_http_url.c",
      "tests/bug71719.phpt",
      "tests/data/bug71719.bin"
    ],
    "message": "fix bug #71719 (Buffer overflow in HTTP url parsing functions)\n\nThe parser's offset was not reset when we softfail in scheme\nparsing and continue to parse a path.\nThanks to hlt99 at blinkenshell dot org for the report.",
    "before_after_code_files": [
      "src/php_http_url.c||src/php_http_url.c",
      "tests/bug71719.phpt||tests/bug71719.phpt"
    ]
  },
  "patch_diff": {
    "src/php_http_url.c||src/php_http_url.c": [
      "File: src/php_http_url.c -> src/php_http_url.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1467:   case '7': case '8': case '9':",
      "1468:   case '+': case '-': case '.':",
      "1469:    if (state->ptr == tmp) {",
      "1471:    }",
      "1473:   case 'A': case 'B': case 'C': case 'D': case 'E': case 'F': case 'G':",
      "",
      "[Removed Lines]",
      "1470:     return tmp;",
      "",
      "[Added Lines]",
      "1470:     goto softfail;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1485:   default:",
      "1486:    if (!(mb = parse_mb(state, PARSE_SCHEME, state->ptr, state->end, tmp, 1))) {",
      "1489:    }",
      "1490:    state->ptr += mb - 1;",
      "1491:   }",
      "1492:  } while (++state->ptr != state->end);",
      "1494:  return state->ptr = tmp;",
      "1495: }",
      "1497: php_http_url_t *php_http_url_parse(const char *str, size_t len, unsigned flags TSRMLS_DC)",
      "1498: {",
      "1500:  struct parse_state *state = ecalloc(1, sizeof(*state) + maxlen);",
      "1502:  state->end = str + len;",
      "",
      "[Removed Lines]",
      "1488:     return tmp;",
      "1499:  size_t maxlen = 3 * len;",
      "",
      "[Added Lines]",
      "1487:     goto softfail;",
      "1493: softfail:",
      "1494:  state->offset = 0;",
      "1500:  size_t maxlen = 3 * len + 8 /* null bytes for all components */;",
      "",
      "---------------"
    ],
    "tests/bug71719.phpt||tests/bug71719.phpt": [
      "File: tests/bug71719.phpt -> tests/bug71719.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Buffer overflow in HTTP url parsing functions",
      "3: --SKIPIF--",
      "4: <?php",
      "5: include \"skipif.inc\";",
      "6: ?>",
      "7: --FILE--",
      "8: <?php",
      "10: echo \"Test\\n\";",
      "11: try {",
      "12:  echo new http\\Message(file_get_contents(__DIR__.\"/data/bug71719.bin\"), false);",
      "13: } catch (Exception $e) {",
      "14:  echo $e;",
      "15: }",
      "16: ?>",
      "18: ===DONE===",
      "19: --EXPECTF--",
      "20: Test",
      "21: %r(exception ')?%rhttp\\Exception\\BadMessageException%r(' with message '|: )%rhttp\\Message::__construct(): Could not parse HTTP protocol version 'HTTP/%s.0'%r'?%r in %sbug71719.php:5",
      "22: Stack trace:",
      "23: #0 %sbug71719.php(5): http\\Message->__construct('\\x80\\xACTd 5 HTTP/1.1...', false)",
      "24: #1 {main}",
      "25: ===DONE===",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3c7b514d38d844b855d430fcbaed6dea67c9c17b",
      "candidate_info": {
        "commit_hash": "3c7b514d38d844b855d430fcbaed6dea67c9c17b",
        "repo": "m6w6/ext-http",
        "commit_url": "https://github.com/m6w6/ext-http/commit/3c7b514d38d844b855d430fcbaed6dea67c9c17b",
        "files": [
          "tests/bug71719.phpt"
        ],
        "message": "fix bug title",
        "before_after_code_files": [
          "tests/bug71719.phpt||tests/bug71719.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tests/bug71719.phpt||tests/bug71719.phpt"
          ],
          "candidate": [
            "tests/bug71719.phpt||tests/bug71719.phpt"
          ]
        }
      },
      "candidate_diff": {
        "tests/bug71719.phpt||tests/bug71719.phpt": [
          "File: tests/bug71719.phpt -> tests/bug71719.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "3: --SKIPIF--",
          "4: <?php",
          "5: include \"skipif.inc\";",
          "",
          "[Removed Lines]",
          "2: Buffer overflow in HTTP url parsing functions",
          "",
          "[Added Lines]",
          "2: Bug #71719 (Buffer overflow in HTTP url parsing functions)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b6bd51c63e78ca0212228a7002a93fb67dfede96",
      "candidate_info": {
        "commit_hash": "b6bd51c63e78ca0212228a7002a93fb67dfede96",
        "repo": "m6w6/ext-http",
        "commit_url": "https://github.com/m6w6/ext-http/commit/b6bd51c63e78ca0212228a7002a93fb67dfede96",
        "files": [
          "src/php_http_client.c",
          "src/php_http_client_curl_user.c",
          "tests/bug69357.phpt",
          "tests/bug71719.phpt",
          "tests/client021.phpt",
          "tests/client027.phpt",
          "tests/client028.phpt",
          "tests/client030.phpt",
          "tests/gh-issue12.phpt",
          "tests/gh-issue47.phpt",
          "tests/gh-issue50.phpt",
          "tests/gh-issue6.phpt",
          "travis/pecl"
        ],
        "message": "5.3 compatibility",
        "before_after_code_files": [
          "src/php_http_client.c||src/php_http_client.c",
          "src/php_http_client_curl_user.c||src/php_http_client_curl_user.c",
          "tests/bug69357.phpt||tests/bug69357.phpt",
          "tests/bug71719.phpt||tests/bug71719.phpt",
          "tests/client021.phpt||tests/client021.phpt",
          "tests/client027.phpt||tests/client027.phpt",
          "tests/client028.phpt||tests/client028.phpt",
          "tests/client030.phpt||tests/client030.phpt",
          "tests/gh-issue12.phpt||tests/gh-issue12.phpt",
          "tests/gh-issue47.phpt||tests/gh-issue47.phpt",
          "tests/gh-issue50.phpt||tests/gh-issue50.phpt",
          "tests/gh-issue6.phpt||tests/gh-issue6.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tests/bug71719.phpt||tests/bug71719.phpt"
          ],
          "candidate": [
            "tests/bug71719.phpt||tests/bug71719.phpt"
          ]
        }
      },
      "candidate_diff": {
        "src/php_http_client.c||src/php_http_client.c": [
          "File: src/php_http_client.c -> src/php_http_client.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1256: }",
          "1258: ZEND_BEGIN_ARG_INFO_EX(ai_HttpClient_setDebug, 0, 0, 1)",
          "1260: ZEND_END_ARG_INFO();",
          "1261: static PHP_METHOD(HttpClient, setDebug)",
          "1262: {",
          "",
          "[Removed Lines]",
          "1259:  ZEND_ARG_TYPE_INFO(0, callback, IS_CALLABLE, 1)",
          "",
          "[Added Lines]",
          "1260:  ZEND_ARG_INFO(0, callback)",
          "",
          "---------------"
        ],
        "src/php_http_client_curl_user.c||src/php_http_client_curl_user.c": [
          "File: src/php_http_client_curl_user.c -> src/php_http_client_curl_user.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "216:  ctx->closure.internal_function.handler = php_http_client_curl_user_handler;",
          "218:  MAKE_STD_ZVAL(zclosure);",
          "219:  zend_create_closure(zclosure, &ctx->closure, NULL, NULL TSRMLS_CC);",
          "220:  args[0] = &zclosure;",
          "222:  php_http_object_method_init(&init, ctx->user, ZEND_STRL(\"init\") TSRMLS_CC);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "219: #if PHP_VERSION_ID >= 50400",
          "221: #else",
          "222:  zend_create_closure(zclosure, &ctx->closure TSRMLS_CC);",
          "223: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "282: zend_class_entry *php_http_client_curl_user_class_entry;",
          "284: ZEND_BEGIN_ARG_INFO_EX(ai_init, 0, 0, 1)",
          "286: ZEND_END_ARG_INFO();",
          "287: ZEND_BEGIN_ARG_INFO_EX(ai_timer, 0, 0, 1)",
          "288: #if PHP_VERSION_ID >= 70000",
          "",
          "[Removed Lines]",
          "285:  ZEND_ARG_TYPE_INFO(0, run, IS_CALLABLE, 0)",
          "",
          "[Added Lines]",
          "290:  ZEND_ARG_INFO(0, run)",
          "",
          "---------------"
        ],
        "tests/bug69357.phpt||tests/bug69357.phpt": [
          "File: tests/bug69357.phpt -> tests/bug69357.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: include \"helper/server.inc\";",
          "14: server(\"upload.inc\", function($port) {",
          "18:  $c = new \\http\\Client;",
          "20:  $c->enqueue($r)->send();",
          "22:  var_dump($c->getResponse($r)->getInfo());",
          "",
          "[Removed Lines]",
          "15:  $r = new \\http\\Client\\Request(\"PUT\", \"http://localhost:$port/\", [],",
          "16:    (new \\http\\Message\\Body)->append(\"foo\")",
          "17:  );",
          "19:  $c->setOptions([\"expect_100_timeout\" => 0]);",
          "",
          "[Added Lines]",
          "15:  $b = new \\http\\Message\\Body;",
          "16:  $b->append(\"foo\");",
          "17:  $r = new \\http\\Client\\Request(\"PUT\", \"http://localhost:$port/\", array(), $b);",
          "19:  $c->setOptions(array(\"expect_100_timeout\" => 0));",
          "",
          "---------------"
        ],
        "tests/bug71719.phpt||tests/bug71719.phpt": [
          "File: tests/bug71719.phpt -> tests/bug71719.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: Test",
          "21: %r(exception ')?%rhttp\\Exception\\BadMessageException%r(' with message '|: )%rhttp\\Message::__construct(): Could not parse HTTP protocol version 'HTTP/%s.0'%r'?%r in %sbug71719.php:5",
          "22: Stack trace:",
          "24: #1 {main}",
          "25: ===DONE===",
          "",
          "[Removed Lines]",
          "23: #0 %sbug71719.php(5): http\\Message->__construct('\\x80\\xACTd 5 HTTP/1.1...', false)",
          "",
          "[Added Lines]",
          "23: #0 %sbug71719.php(5): http\\Message->__construct('%r(\\?\\?|\\\\x80\\\\xAC)%rTd 5 HTTP/1.1...', false)",
          "",
          "---------------"
        ],
        "tests/client021.phpt||tests/client021.phpt": [
          "File: tests/client021.phpt -> tests/client021.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "110: });",
          "116: server(\"cookie.inc\", function($port) use($request, $tmpfile) {",
          "117:  $request->setOptions(array(\"port\" => $port));",
          "",
          "[Removed Lines]",
          "113: (new http\\Client(\"curl\", \"test\"))->configure([\"share_cookies\" => false]);",
          "114: $request->setOptions([\"cookiestore\" => null]);",
          "",
          "[Added Lines]",
          "113: $c = new http\\Client(\"curl\", \"test\");",
          "114: $c->configure(array(\"share_cookies\" => false));",
          "115: $c = null;",
          "116: $request->setOptions(array(\"cookiestore\" => null));",
          "",
          "---------------"
        ],
        "tests/client027.phpt||tests/client027.phpt": [
          "File: tests/client027.phpt -> tests/client027.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: server(\"cookie.inc\", function($port) {",
          "17:  $client = new http\\Client(null, \"cookies\");",
          "19:  $request = new http\\Client\\Request(\"GET\", \"http://localhost:$port?r1\");",
          "20:  $client->enqueue($request);",
          "21:  $client->send();",
          "",
          "[Removed Lines]",
          "18:  $client->configure([\"pipelining\" => false]);",
          "",
          "[Added Lines]",
          "18:  $client->configure(array(\"pipelining\" => false));",
          "",
          "---------------"
        ],
        "tests/client028.phpt||tests/client028.phpt": [
          "File: tests/client028.phpt -> tests/client028.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: {",
          "14:  private $client;",
          "15:  private $run;",
          "22:  private $timeout = 1000;",
          "24:  function __construct(http\\Client $client) {",
          "25:   $this->client = $client;",
          "26:  }",
          "29:   $this->run = $run;",
          "30:  }",
          "",
          "[Removed Lines]",
          "16:  private $fds = [",
          "17:    \"R\" => [],",
          "18:    \"W\" => []",
          "19:  ];",
          "20:  private $R = [];",
          "21:  private $W = [];",
          "28:  function init(callable $run) {",
          "",
          "[Added Lines]",
          "16:  private $fds = array(",
          "17:    \"R\" => array(),",
          "18:    \"W\" => array()",
          "19:  );",
          "20:  private $R = array();",
          "21:  private $W = array();",
          "28:  function init($run) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "125: server(\"proxy.inc\", function($port) {",
          "126:  $client = new http\\Client;",
          "128:    \"use_eventloop\" => new UserHandler($client)",
          "130:  $client->enqueue(new http\\Client\\Request(\"GET\", \"http://localhost:$port/\"), function($r) {",
          "131:   var_dump($r->getResponseCode());",
          "132:  });",
          "",
          "[Removed Lines]",
          "127:  $client->configure([",
          "129:  ]);",
          "",
          "[Added Lines]",
          "127:  $client->configure(array(",
          "129:  ));",
          "",
          "---------------"
        ],
        "tests/client030.phpt||tests/client030.phpt": [
          "File: tests/client030.phpt -> tests/client030.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: }",
          "18: server(\"proxy.inc\", function($port) {",
          "19:  $client = new http\\Client;",
          "21:    \"use_eventloop\" => true,",
          "23:  $client->attach(new test);",
          "24:  $client->enqueue(new http\\Client\\Request(\"GET\", \"http://localhost:$port/\"), function($r) {",
          "25:   var_dump($r->getResponseCode());",
          "",
          "[Removed Lines]",
          "20:  $client->configure([",
          "22:  ]);",
          "",
          "[Added Lines]",
          "20:  $client->configure(array(",
          "22:  ));",
          "",
          "---------------"
        ],
        "tests/gh-issue12.phpt||tests/gh-issue12.phpt": [
          "File: tests/gh-issue12.phpt -> tests/gh-issue12.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: foreach ($urls as $url) {",
          "16:  try {",
          "18:   printf(\"OK: %s\\n\", $url);",
          "19:  } catch (Exception $e) {",
          "20:   printf(\"%s\\n\", $e->getMessage());",
          "",
          "[Removed Lines]",
          "17:   (new http\\Client\\Request)->setRequestUrl($url);",
          "",
          "[Added Lines]",
          "17:   $c = new http\\Client\\Request;",
          "18:   $c->setRequestUrl($url);",
          "",
          "---------------"
        ],
        "tests/gh-issue47.phpt||tests/gh-issue47.phpt": [
          "File: tests/gh-issue47.phpt -> tests/gh-issue47.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: <?php",
          "9: echo \"Test\\n\";",
          "12:     \"\",",
          "13:     \"? = =\"",
          "16: $url0=new http\\Url($urls[0]);",
          "17: $url1=$url0->mod($urls[1]);",
          "",
          "[Removed Lines]",
          "11: $urls = [",
          "14: ];",
          "",
          "[Added Lines]",
          "11: $urls = array(",
          "14: );",
          "",
          "---------------"
        ],
        "tests/gh-issue50.phpt||tests/gh-issue50.phpt": [
          "File: tests/gh-issue50.phpt -> tests/gh-issue50.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: exception 'http\\Exception\\RuntimeException' with message 'http\\Client::dequeue(): Could not dequeue request while executing callbacks' in %sgh-issue50.php:9",
          "34: Stack trace:",
          "35: #0 %sgh-issue50.php(9): http\\Client->dequeue(Object(http\\Client\\Request))",
          "37: #2 %sgh-issue50.php(14): http\\Client->send()",
          "38: #3 {main}",
          "39: ===DONE===",
          "",
          "[Removed Lines]",
          "36: #1 [internal function]: {closure}(Object(http\\Client), Object(http\\Client\\Request), 18, 'GET / HTTP/1.1\\r...')",
          "",
          "[Added Lines]",
          "36: #1 [internal function]: {closure}(Object(http\\Client), Object(http\\Client\\Request), 18, 'GET / HTTP/1.1%s...')",
          "",
          "---------------"
        ],
        "tests/gh-issue6.phpt||tests/gh-issue6.phpt": [
          "File: tests/gh-issue6.phpt -> tests/gh-issue6.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: echo \"Test\\n\";",
          "11: echo \"\\n\";",
          "13: echo \"\\n\";",
          "15: ?>",
          "",
          "[Removed Lines]",
          "10: echo (new http\\Url(\"?__utma=1152894289.1017686999.9107388726.1439222726.1494721726.1&__utmb=115739289.1.10.1437388726&__utmc=115883619&__utmx=-&__utmz=115111289.14310476.1.1.utmcsr=google|utmccn=(organic)|utmcmd=organic|utmctr=(not%20provided)&__utmv=-&__utmk=112678937\"))->query;",
          "12: echo (new http\\Url(\"?id={\\$id}\"))->query;",
          "",
          "[Added Lines]",
          "10: $url = new http\\Url(\"?__utma=1152894289.1017686999.9107388726.1439222726.1494721726.1&__utmb=115739289.1.10.1437388726&__utmc=115883619&__utmx=-&__utmz=115111289.14310476.1.1.utmcsr=google|utmccn=(organic)|utmcmd=organic|utmctr=(not%20provided)&__utmv=-&__utmk=112678937\");",
          "11: echo $url->query;",
          "13: $url = new http\\Url(\"?id={\\$id}\");",
          "14: echo $url->query;",
          "",
          "---------------"
        ]
      }
    }
  ]
}