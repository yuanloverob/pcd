{
  "cve_id": "CVE-2011-3947",
  "cve_desc": "Buffer overflow in mjpegbdec.c in libavcodec in FFmpeg 0.7.x before 0.7.12 and 0.8.x before 0.8.11, and in Libav 0.5.x before 0.5.9, 0.6.x before 0.6.6, 0.7.x before 0.7.5, and 0.8.x before 0.8.1, allows remote attackers to cause a denial of service (crash) and possibly execute arbitrary code via a crafted MJPEG-B file.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "b57d262412204e54a7ef8fa1b23ff4dcede622e5",
  "patch_info": {
    "commit_hash": "b57d262412204e54a7ef8fa1b23ff4dcede622e5",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b57d262412204e54a7ef8fa1b23ff4dcede622e5",
    "files": [
      "libavcodec/mjpegbdec.c"
    ],
    "message": "mjpegbdec: Fix overflow in SOS.\n\nBased in part by a fix from Michael Niedermayer <michaelni@gmx.at>\n\nFixes CVE-2011-3947\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind",
    "before_after_code_files": [
      "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c": [
      "File: libavcodec/mjpegbdec.c -> libavcodec/mjpegbdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "59:     s->restart_count = 0;",
      "60:     s->mjpb_skiptosod = 0;",
      "62:     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "62:     if (buf_end - buf_ptr >= 1 << 28)",
      "63:         return AVERROR_INVALIDDATA;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "111:     av_log(avctx, AV_LOG_DEBUG, \"sod offs: 0x%x\\n\", sod_offs);",
      "112:     if (sos_offs)",
      "113:     {",
      "116:         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));",
      "117:         s->start_code = SOS;",
      "118:         if (ff_mjpeg_decode_sos(s, NULL, NULL) < 0 &&",
      "",
      "[Removed Lines]",
      "115:         init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);",
      "",
      "[Added Lines]",
      "117:         init_get_bits(&s->gb, buf_ptr + sos_offs,",
      "118:                       8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b2ac7e585e53ef6c99eef09f1b6fce373fb05125",
      "candidate_info": {
        "commit_hash": "b2ac7e585e53ef6c99eef09f1b6fce373fb05125",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b2ac7e585e53ef6c99eef09f1b6fce373fb05125",
        "files": [
          "libavcodec/mjpegbdec.c"
        ],
        "message": "mjpegbdec: Fix overflow in SOS.\n\nBased in part by a fix from Michael Niedermayer <michaelni@gmx.at>\n\nFixes CVE-2011-3947\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\n(cherry picked from commit b57d262412204e54a7ef8fa1b23ff4dcede622e5)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 083a8a00373b12dc06b8ae4c49eec61fb5e55f4b)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 6ae95a0b93e8df15fe5f364535a7214be0817736)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 6ca010f20965ef71d97a53e871edae2eb9c05a5f)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>",
        "before_after_code_files": [
          "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c": [
          "File: libavcodec/mjpegbdec.c -> libavcodec/mjpegbdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     s->restart_count = 0;",
          "50:     s->mjpb_skiptosod = 0;",
          "52:     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:     if (buf_end - buf_ptr >= 1 << 28)",
          "53:         return AVERROR_INVALIDDATA;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "99:     av_log(avctx, AV_LOG_DEBUG, \"sod offs: 0x%x\\n\", sod_offs);",
          "100:     if (sos_offs)",
          "101:     {",
          "104:         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));",
          "105:         s->start_code = SOS;",
          "106:         ff_mjpeg_decode_sos(s);",
          "",
          "[Removed Lines]",
          "103:         init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);",
          "",
          "[Added Lines]",
          "105:         init_get_bits(&s->gb, buf_ptr + sos_offs,",
          "106:                       8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ca010f20965ef71d97a53e871edae2eb9c05a5f",
      "candidate_info": {
        "commit_hash": "6ca010f20965ef71d97a53e871edae2eb9c05a5f",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/6ca010f20965ef71d97a53e871edae2eb9c05a5f",
        "files": [
          "libavcodec/mjpegbdec.c"
        ],
        "message": "mjpegbdec: Fix overflow in SOS.\n\nBased in part by a fix from Michael Niedermayer <michaelni@gmx.at>\n\nFixes CVE-2011-3947\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\n(cherry picked from commit b57d262412204e54a7ef8fa1b23ff4dcede622e5)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 083a8a00373b12dc06b8ae4c49eec61fb5e55f4b)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 6ae95a0b93e8df15fe5f364535a7214be0817736)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>",
        "before_after_code_files": [
          "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c": [
          "File: libavcodec/mjpegbdec.c -> libavcodec/mjpegbdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:     s->restart_count = 0;",
          "60:     s->mjpb_skiptosod = 0;",
          "62:     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "62:     if (buf_end - buf_ptr >= 1 << 28)",
          "63:         return AVERROR_INVALIDDATA;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:     av_log(avctx, AV_LOG_DEBUG, \"sod offs: 0x%x\\n\", sod_offs);",
          "110:     if (sos_offs)",
          "111:     {",
          "114:         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));",
          "115:         s->start_code = SOS;",
          "116:         ff_mjpeg_decode_sos(s);",
          "",
          "[Removed Lines]",
          "113:         init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);",
          "",
          "[Added Lines]",
          "115:         init_get_bits(&s->gb, buf_ptr + sos_offs,",
          "116:                       8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ae95a0b93e8df15fe5f364535a7214be0817736",
      "candidate_info": {
        "commit_hash": "6ae95a0b93e8df15fe5f364535a7214be0817736",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/6ae95a0b93e8df15fe5f364535a7214be0817736",
        "files": [
          "libavcodec/mjpegbdec.c"
        ],
        "message": "mjpegbdec: Fix overflow in SOS.\n\nBased in part by a fix from Michael Niedermayer <michaelni@gmx.at>\n\nFixes CVE-2011-3947\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\n(cherry picked from commit b57d262412204e54a7ef8fa1b23ff4dcede622e5)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 083a8a00373b12dc06b8ae4c49eec61fb5e55f4b)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>",
        "before_after_code_files": [
          "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c": [
          "File: libavcodec/mjpegbdec.c -> libavcodec/mjpegbdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:     s->restart_count = 0;",
          "60:     s->mjpb_skiptosod = 0;",
          "62:     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "62:     if (buf_end - buf_ptr >= 1 << 28)",
          "63:         return AVERROR_INVALIDDATA;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:     av_log(avctx, AV_LOG_DEBUG, \"sod offs: 0x%x\\n\", sod_offs);",
          "110:     if (sos_offs)",
          "111:     {",
          "114:         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));",
          "115:         s->start_code = SOS;",
          "116:         ff_mjpeg_decode_sos(s, NULL, NULL);",
          "",
          "[Removed Lines]",
          "113:         init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);",
          "",
          "[Added Lines]",
          "115:         init_get_bits(&s->gb, buf_ptr + sos_offs,",
          "116:                       8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "083a8a00373b12dc06b8ae4c49eec61fb5e55f4b",
      "candidate_info": {
        "commit_hash": "083a8a00373b12dc06b8ae4c49eec61fb5e55f4b",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/083a8a00373b12dc06b8ae4c49eec61fb5e55f4b",
        "files": [
          "libavcodec/mjpegbdec.c"
        ],
        "message": "mjpegbdec: Fix overflow in SOS.\n\nBased in part by a fix from Michael Niedermayer <michaelni@gmx.at>\n\nFixes CVE-2011-3947\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\n(cherry picked from commit b57d262412204e54a7ef8fa1b23ff4dcede622e5)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>",
        "before_after_code_files": [
          "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegbdec.c||libavcodec/mjpegbdec.c": [
          "File: libavcodec/mjpegbdec.c -> libavcodec/mjpegbdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:     s->restart_count = 0;",
          "60:     s->mjpb_skiptosod = 0;",
          "62:     init_get_bits(&hgb, buf_ptr, /*buf_size*/(buf_end - buf_ptr)*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "62:     if (buf_end - buf_ptr >= 1 << 28)",
          "63:         return AVERROR_INVALIDDATA;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111:     av_log(avctx, AV_LOG_DEBUG, \"sod offs: 0x%x\\n\", sod_offs);",
          "112:     if (sos_offs)",
          "113:     {",
          "116:         s->mjpb_skiptosod = (sod_offs - sos_offs - show_bits(&s->gb, 16));",
          "117:         s->start_code = SOS;",
          "118:         if (ff_mjpeg_decode_sos(s, NULL, NULL) < 0 &&",
          "",
          "[Removed Lines]",
          "115:         init_get_bits(&s->gb, buf_ptr+sos_offs, field_size*8);",
          "",
          "[Added Lines]",
          "117:         init_get_bits(&s->gb, buf_ptr + sos_offs,",
          "118:                       8 * FFMIN(field_size, buf_end - buf_ptr - sos_offs));",
          "",
          "---------------"
        ]
      }
    }
  ]
}