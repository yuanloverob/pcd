{
  "cve_id": "CVE-2012-0848",
  "cve_desc": "Heap-based buffer overflow in the ws_snd_decode_frame function in libavcodec/ws-snd1.c in FFmpeg 0.9.1 allows remote attackers to cause a denial of service (application crash) via a crafted media file, related to an incorrect calculation, aka \"wrong samples count.\"",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "5257743aee0c3982f0079e6553aabc6aa39401d2",
  "patch_info": {
    "commit_hash": "5257743aee0c3982f0079e6553aabc6aa39401d2",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/5257743aee0c3982f0079e6553aabc6aa39401d2",
    "files": [
      "libavcodec/ws-snd1.c"
    ],
    "message": "ws_snd1: Fix wrong samples count and crash.\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
    ]
  },
  "patch_diff": {
    "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c": [
      "File: libavcodec/ws-snd1.c -> libavcodec/ws-snd1.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "114:         switch (code) {",
      "117:         case 2:  smp = (count & 0x20) ? 1 : count + 1; break;",
      "118:         default: smp = count + 1;                      break;",
      "119:         }",
      "",
      "[Removed Lines]",
      "115:         case 0:  smp = 4;                              break;",
      "116:         case 1:  smp = 2;                              break;",
      "",
      "[Added Lines]",
      "115:         case 0:  smp = 4*(count+1);                    break;",
      "116:         case 1:  smp = 2*(count+1);                    break;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d80db23e7d3130ee5f5f6fff7e6db3274cdd6a98",
      "candidate_info": {
        "commit_hash": "d80db23e7d3130ee5f5f6fff7e6db3274cdd6a98",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/d80db23e7d3130ee5f5f6fff7e6db3274cdd6a98",
        "files": [
          "libavcodec/ws-snd1.c"
        ],
        "message": "ws_snd1: Fix wrong samples count and crash.\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 5257743aee0c3982f0079e6553aabc6aa39401d2)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ],
          "candidate": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c": [
          "File: libavcodec/ws-snd1.c -> libavcodec/ws-snd1.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:         switch (code) {",
          "105:         case 2:  smp = (count & 0x20) ? 1 : count + 1; break;",
          "106:         default: smp = count + 1;                      break;",
          "107:         }",
          "",
          "[Removed Lines]",
          "103:         case 0:  smp = 4;                              break;",
          "104:         case 1:  smp = 2;                              break;",
          "",
          "[Added Lines]",
          "103:         case 0:  smp = 4*(count+1);                    break;",
          "104:         case 1:  smp = 2*(count+1);                    break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "49db3600059010bbe284b8a2ed215eb561f01118",
      "candidate_info": {
        "commit_hash": "49db3600059010bbe284b8a2ed215eb561f01118",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/49db3600059010bbe284b8a2ed215eb561f01118",
        "files": [
          "libavcodec/ws-snd1.c"
        ],
        "message": "ws_snd1: Fix wrong samples count and crash.\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 5257743aee0c3982f0079e6553aabc6aa39401d2)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ],
          "candidate": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c": [
          "File: libavcodec/ws-snd1.c -> libavcodec/ws-snd1.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "114:         switch (code) {",
          "117:         case 2:  smp = (count & 0x20) ? 1 : count + 1; break;",
          "118:         default: smp = count + 1;                      break;",
          "119:         }",
          "",
          "[Removed Lines]",
          "115:         case 0:  smp = 4;                              break;",
          "116:         case 1:  smp = 2;                              break;",
          "",
          "[Added Lines]",
          "115:         case 0:  smp = 4*(count+1);                    break;",
          "116:         case 1:  smp = 2*(count+1);                    break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "417364ce1f979031ef6fee661fc15e1869bdb1b4",
      "candidate_info": {
        "commit_hash": "417364ce1f979031ef6fee661fc15e1869bdb1b4",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/417364ce1f979031ef6fee661fc15e1869bdb1b4",
        "files": [
          "libavcodec/ws-snd1.c"
        ],
        "message": "ws_snd: add some checks to prevent buffer overread or overwrite.",
        "before_after_code_files": [
          "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ],
          "candidate": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c": [
          "File: libavcodec/ws-snd1.c -> libavcodec/ws-snd1.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "61:     if (!buf_size)",
          "62:         return 0;",
          "64:     out_size = AV_RL16(&buf[0]);",
          "65:     in_size = AV_RL16(&buf[2]);",
          "66:     buf += 4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:     if (buf_size < 4) {",
          "65:         av_log(avctx, AV_LOG_ERROR, \"packet is too small\\n\");",
          "66:         return AVERROR(EINVAL);",
          "67:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "74:         return -1;",
          "75:     }",
          "79:     if (in_size == out_size) {",
          "80:         for (i = 0; i < out_size; i++)",
          "82:         return buf_size;",
          "83:     }",
          "87:         uint8_t count;",
          "88:         code = (*buf) >> 6;",
          "89:         count = (*buf) & 0x3F;",
          "90:         buf++;",
          "91:         switch(code) {",
          "93:             for (count++; count > 0; count--) {",
          "",
          "[Removed Lines]",
          "85:     while (out_size > 0) {",
          "86:         int code;",
          "",
          "[Added Lines]",
          "89:     while (out_size > 0 && buf - avpkt->data < buf_size) {",
          "90:         int code, smp, size;",
          "97:         switch (code) {",
          "98:         case 0:  smp = 4;                              break;",
          "99:         case 1:  smp = 2;                              break;",
          "100:         case 2:  smp = (count & 0x20) ? 1 : count + 1; break;",
          "101:         default: smp = count + 1;                      break;",
          "102:         }",
          "103:         if (out_size < smp) {",
          "104:             out_size = 0;",
          "105:             break;",
          "106:         }",
          "109:         size = ((code == 2 && (count & 0x20)) || code == 3) ? 0 : count + 1;",
          "110:         if ((buf - avpkt->data) + size > buf_size)",
          "111:             break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e676bbb8cfb7401cfc189a88c61e7e7c22557fa7",
      "candidate_info": {
        "commit_hash": "e676bbb8cfb7401cfc189a88c61e7e7c22557fa7",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e676bbb8cfb7401cfc189a88c61e7e7c22557fa7",
        "files": [
          "libavcodec/ws-snd1.c"
        ],
        "message": "ws_snd1: Fix wrong samples count and crash.\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9fb7a5af97d8c084c3af2566070d09eae0ab49fc)\n\nAddresses CVE-2012-0848\n\nReviewed-by: Justin Ruggles <justin.ruggles@gmail.com>\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>\n(cherry picked from commit 697a45d861b7cd6a96718383a44f41348487f844)\n\nSigned-off-by: Reinhard Tartler <siretart@tauware.de>",
        "before_after_code_files": [
          "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ],
          "candidate": [
            "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/ws-snd1.c||libavcodec/ws-snd1.c": [
          "File: libavcodec/ws-snd1.c -> libavcodec/ws-snd1.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "97:         switch (code) {",
          "100:         case 2:  smp = (count & 0x20) ? 1 : count + 1; break;",
          "101:         default: smp = count + 1;                      break;",
          "102:         }",
          "",
          "[Removed Lines]",
          "98:         case 0:  smp = 4;                              break;",
          "99:         case 1:  smp = 2;                              break;",
          "",
          "[Added Lines]",
          "98:         case 0:  smp = 4*(count+1);                    break;",
          "99:         case 1:  smp = 2*(count+1);                    break;",
          "",
          "---------------"
        ]
      }
    }
  ]
}