{
  "cve_id": "CVE-2013-2081",
  "cve_desc": "Moodle through 2.1.10, 2.2.x before 2.2.10, 2.3.x before 2.3.7, and 2.4.x before 2.4.4 does not consider \"don't send\" attributes during hub registration, which allows remote hubs to obtain sensitive site information by reading form data.",
  "repo": "moodle/moodle",
  "patch_hash": "669dee58048b18d9034a7b2367b97a50b498b0e0",
  "patch_info": {
    "commit_hash": "669dee58048b18d9034a7b2367b97a50b498b0e0",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/669dee58048b18d9034a7b2367b97a50b498b0e0",
    "files": [
      "admin/registration/forms.php",
      "admin/registration/register.php"
    ],
    "message": "MDL-37822 Moodle send site information to a hub even though it's unchecked",
    "before_after_code_files": [
      "admin/registration/forms.php||admin/registration/forms.php",
      "admin/registration/register.php||admin/registration/register.php"
    ]
  },
  "patch_diff": {
    "admin/registration/forms.php||admin/registration/forms.php": [
      "File: admin/registration/forms.php -> admin/registration/forms.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "244:         $postsnumber = get_config('hub', 'site_postsnumber_' . $cleanhuburl);",
      "245:         $questionsnumber = get_config('hub', 'site_questionsnumber_' . $cleanhuburl);",
      "246:         $resourcesnumber = get_config('hub', 'site_resourcesnumber_' . $cleanhuburl);",
      "249:         $mediancoursesize = get_config('hub', 'site_mediancoursesize_' . $cleanhuburl);",
      "252:         $mform->addElement('hidden', 'huburl', $huburl);",
      "",
      "[Removed Lines]",
      "247:         $badges = get_config('hub', 'site_badges_' . $cleanhuburl);",
      "248:         $issuedbadges = get_config('hub', 'site_issuedbadges_' . $cleanhuburl);",
      "",
      "[Added Lines]",
      "247:         $badgesnumber = get_config('hub', 'site_badges_' . $cleanhuburl);",
      "248:         $issuedbadgesnumber = get_config('hub', 'site_issuedbadges_' . $cleanhuburl);",
      "250:         $participantnumberaveragecfg = get_config('hub', 'site_participantnumberaverage_' . $cleanhuburl);",
      "251:         $modulenumberaveragecfg = get_config('hub', 'site_modulenumberaverage_' . $cleanhuburl);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "387:         if (HUB_MOODLEORGHUBURL != $huburl) {",
      "388:             $mform->addElement('checkbox', 'courses', get_string('sendfollowinginfo', 'hub'),",
      "389:                     \" \" . get_string('coursesnumber', 'hub', $coursecount));",
      "391:             $mform->setType('courses', PARAM_INT);",
      "392:             $mform->addHelpButton('courses', 'sendfollowinginfo', 'hub');",
      "394:             $mform->addElement('checkbox', 'users', '',",
      "395:                     \" \" . get_string('usersnumber', 'hub', $usercount));",
      "397:             $mform->setType('users', PARAM_INT);",
      "399:             $mform->addElement('checkbox', 'roleassignments', '',",
      "400:                     \" \" . get_string('roleassignmentsnumber', 'hub', $roleassigncount));",
      "402:             $mform->setType('roleassignments', PARAM_INT);",
      "404:             $mform->addElement('checkbox', 'posts', '',",
      "405:                     \" \" . get_string('postsnumber', 'hub', $postcount));",
      "407:             $mform->setType('posts', PARAM_INT);",
      "409:             $mform->addElement('checkbox', 'questions', '',",
      "410:                     \" \" . get_string('questionsnumber', 'hub', $questioncount));",
      "412:             $mform->setType('questions', PARAM_INT);",
      "414:             $mform->addElement('checkbox', 'resources', '',",
      "415:                     \" \" . get_string('resourcesnumber', 'hub', $resourcecount));",
      "417:             $mform->setType('resources', PARAM_INT);",
      "419:             $mform->addElement('checkbox', 'badges', '',",
      "420:                     \" \" . get_string('badgesnumber', 'hub', $badges));",
      "422:             $mform->setType('resources', PARAM_INT);",
      "424:             $mform->addElement('checkbox', 'issuedbadges', '',",
      "425:                     \" \" . get_string('issuedbadgesnumber', 'hub', $issuedbadges));",
      "427:             $mform->setType('resources', PARAM_INT);",
      "429:             $mform->addElement('checkbox', 'participantnumberaverage', '',",
      "430:                     \" \" . get_string('participantnumberaverage', 'hub', $participantnumberaverage));",
      "432:             $mform->setType('participantnumberaverage', PARAM_FLOAT);",
      "434:             $mform->addElement('checkbox', 'modulenumberaverage', '',",
      "435:                     \" \" . get_string('modulenumberaverage', 'hub', $modulenumberaverage));",
      "437:             $mform->setType('modulenumberaverage', PARAM_FLOAT);",
      "438:         } else {",
      "439:             $mform->addElement('static', 'courseslabel', get_string('sendfollowinginfo', 'hub'),",
      "",
      "[Removed Lines]",
      "390:             $mform->setDefault('courses', 1);",
      "396:             $mform->setDefault('users', 1);",
      "401:             $mform->setDefault('roleassignments', 1);",
      "406:             $mform->setDefault('posts', 1);",
      "411:             $mform->setDefault('questions', 1);",
      "416:             $mform->setDefault('resources', 1);",
      "421:             $mform->setDefault('badges', 1);",
      "426:             $mform->setDefault('issuedbadges', 1);",
      "431:             $mform->setDefault('participantnumberaverage', 1);",
      "436:             $mform->setDefault('modulenumberaverage', 1);",
      "",
      "[Added Lines]",
      "392:             $mform->setDefault('courses', $coursesnumber != -1);",
      "398:             $mform->setDefault('users', $usersnumber != -1);",
      "403:             $mform->setDefault('roleassignments', $roleassignmentsnumber != -1);",
      "408:             $mform->setDefault('posts', $postsnumber != -1);",
      "413:             $mform->setDefault('questions', $questionsnumber != -1);",
      "418:             $mform->setDefault('resources', $resourcesnumber != -1);",
      "423:             $mform->setDefault('badges', $badgesnumber != -1);",
      "428:             $mform->setDefault('issuedbadges', $issuedbadgesnumber != -1);",
      "433:             $mform->setDefault('participantnumberaverage', $participantnumberaveragecfg != -1);",
      "438:             $mform->setDefault('modulenumberaverage', $modulenumberaveragecfg != -1);",
      "",
      "---------------"
    ],
    "admin/registration/register.php||admin/registration/register.php": [
      "File: admin/registration/register.php -> admin/registration/register.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "62: $fromform = $siteregistrationform->get_data();",
      "64: if (!empty($fromform) and confirm_sesskey()) {",
      "66:     $cleanhuburl = clean_param($huburl, PARAM_ALPHANUMEXT);",
      "67:     set_config('site_name_' . $cleanhuburl, $fromform->name, 'hub');",
      "68:     set_config('site_description_' . $cleanhuburl, $fromform->description, 'hub');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "68:     $inputnames = array('courses', 'users', 'roleassignments', 'posts', 'questions', 'resources',",
      "69:         'badges', 'issuedbadges', 'modulenumberaverage', 'participantnumberaverage');",
      "70:     foreach ($inputnames as $inputname) {",
      "71:         if (empty($fromform->{$inputname})) {",
      "72:             $fromform->{$inputname} = -1;",
      "73:         }",
      "74:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "115: if (!empty($fromform) and empty($update) and confirm_sesskey()) {",
      "117:     if (!empty($fromform) and confirm_sesskey()) { // if the register button has been clicked",
      "118:         $params = (array) $fromform; //we are using the form input as the redirection parameters (token, url and name)",
      "120:         $unconfirmedhub = $registrationmanager->get_unconfirmedhub($huburl);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "131:         $siteinfo = $registrationmanager->get_site_info($huburl);",
      "132:         $fromform->courses = $siteinfo['courses'];",
      "133:         $fromform->users = $siteinfo['users'];",
      "134:         $fromform->enrolments = $siteinfo['enrolments'];",
      "135:         $fromform->posts = $siteinfo['posts'];",
      "136:         $fromform->questions = $siteinfo['questions'];",
      "137:         $fromform->resources = $siteinfo['resources'];",
      "138:         $fromform->badges = $siteinfo['badges'];",
      "139:         $fromform->issuedbadges = $siteinfo['issuedbadges'];",
      "140:         $fromform->modulenumberaverage = $siteinfo['modulenumberaverage'];",
      "141:         $fromform->participantnumberaverage = $siteinfo['participantnumberaverage'];",
      "142:         $fromform->street = $siteinfo['street'];",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "667eaec4d2679a8bc1fcd9f0ff17a1be2babccb0",
      "candidate_info": {
        "commit_hash": "667eaec4d2679a8bc1fcd9f0ff17a1be2babccb0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/667eaec4d2679a8bc1fcd9f0ff17a1be2babccb0",
        "files": [
          "admin/registration/register.php"
        ],
        "message": "MDL-37822 Moodle send site information to a hub even though it's unchecked",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     set_config('site_geolocation_' . $cleanhuburl, $fromform->geolocation, 'hub');",
          "79:     set_config('site_contactable_' . $cleanhuburl, $fromform->contactable, 'hub');",
          "80:     set_config('site_emailalert_' . $cleanhuburl, $fromform->emailalert, 'hub');",
          "81:     set_config('site_coursesnumber_' . $cleanhuburl, $fromform->courses, 'hub');",
          "82:     set_config('site_usersnumber_' . $cleanhuburl, $fromform->users, 'hub');",
          "83:     set_config('site_roleassignmentsnumber_' . $cleanhuburl, $fromform->roleassignments, 'hub');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "84:     $inputnames = array('courses', 'users', 'roleassignments', 'posts', 'questions', 'resources',",
          "85:         'modulenumberaverage', 'participantnumberaverage');",
          "86:     foreach ($inputnames as $inputname) {",
          "87:         if (empty($fromform->{$inputname})) {",
          "88:             $fromform->{$inputname} = -1;",
          "89:         }",
          "90:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "113: if (!empty($fromform) and empty($update) and confirm_sesskey()) {",
          "115:     if (!empty($fromform) and confirm_sesskey()) { // if the register button has been clicked",
          "116:         $params = (array) $fromform; //we are using the form input as the redirection parameters (token, url and name)",
          "118:         $unconfirmedhub = $registrationmanager->get_unconfirmedhub($huburl);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128:         $siteinfo = $registrationmanager->get_site_info($huburl);",
          "129:         $fromform->courses = $siteinfo['courses'];",
          "130:         $fromform->users = $siteinfo['users'];",
          "131:         $fromform->enrolments = $siteinfo['enrolments'];",
          "132:         $fromform->posts = $siteinfo['posts'];",
          "133:         $fromform->questions = $siteinfo['questions'];",
          "134:         $fromform->resources = $siteinfo['resources'];",
          "135:         $fromform->modulenumberaverage = $siteinfo['modulenumberaverage'];",
          "136:         $fromform->participantnumberaverage = $siteinfo['participantnumberaverage'];",
          "137:         $fromform->street = $siteinfo['street'];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "60c468bcb3b6f867a70f2f30427b52e0362e93d1",
      "candidate_info": {
        "commit_hash": "60c468bcb3b6f867a70f2f30427b52e0362e93d1",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/60c468bcb3b6f867a70f2f30427b52e0362e93d1",
        "files": [
          "admin/registration/register.php"
        ],
        "message": "MDL-37822 Moodle send site information to a hub even though it's unchecked",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:     set_config('site_geolocation_' . $cleanhuburl, $fromform->geolocation, 'hub');",
          "77:     set_config('site_contactable_' . $cleanhuburl, $fromform->contactable, 'hub');",
          "78:     set_config('site_emailalert_' . $cleanhuburl, $fromform->emailalert, 'hub');",
          "79:     set_config('site_coursesnumber_' . $cleanhuburl, $fromform->courses, 'hub');",
          "80:     set_config('site_usersnumber_' . $cleanhuburl, $fromform->users, 'hub');",
          "81:     set_config('site_roleassignmentsnumber_' . $cleanhuburl, $fromform->roleassignments, 'hub');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:     $inputnames = array('courses', 'users', 'roleassignments', 'posts', 'questions', 'resources',",
          "83:         'modulenumberaverage', 'participantnumberaverage');",
          "84:     foreach ($inputnames as $inputname) {",
          "85:         if (empty($fromform->{$inputname})) {",
          "86:             $fromform->{$inputname} = -1;",
          "87:         }",
          "88:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111: if (!empty($fromform) and empty($update) and confirm_sesskey()) {",
          "113:     if (!empty($fromform) and confirm_sesskey()) { // if the register button has been clicked",
          "114:         $params = (array) $fromform; //we are using the form input as the redirection parameters (token, url and name)",
          "116:         $unconfirmedhub = $registrationmanager->get_unconfirmedhub($huburl);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:         $siteinfo = $registrationmanager->get_site_info($huburl);",
          "127:         $fromform->courses = $siteinfo['courses'];",
          "128:         $fromform->users = $siteinfo['users'];",
          "129:         $fromform->enrolments = $siteinfo['enrolments'];",
          "130:         $fromform->posts = $siteinfo['posts'];",
          "131:         $fromform->questions = $siteinfo['questions'];",
          "132:         $fromform->resources = $siteinfo['resources'];",
          "133:         $fromform->modulenumberaverage = $siteinfo['modulenumberaverage'];",
          "134:         $fromform->participantnumberaverage = $siteinfo['participantnumberaverage'];",
          "135:         $fromform->street = $siteinfo['street'];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "54a3ce69e9ca751fffd0b3e0eb5be4add50de113",
      "candidate_info": {
        "commit_hash": "54a3ce69e9ca751fffd0b3e0eb5be4add50de113",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/54a3ce69e9ca751fffd0b3e0eb5be4add50de113",
        "files": [
          "admin/registration/register.php"
        ],
        "message": "MDL-37822 Moodle send site information to a hub even though it's unchecked",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     set_config('site_geolocation_' . $cleanhuburl, $fromform->geolocation, 'hub');",
          "79:     set_config('site_contactable_' . $cleanhuburl, $fromform->contactable, 'hub');",
          "80:     set_config('site_emailalert_' . $cleanhuburl, $fromform->emailalert, 'hub');",
          "81:     set_config('site_coursesnumber_' . $cleanhuburl, $fromform->courses, 'hub');",
          "82:     set_config('site_usersnumber_' . $cleanhuburl, $fromform->users, 'hub');",
          "83:     set_config('site_roleassignmentsnumber_' . $cleanhuburl, $fromform->roleassignments, 'hub');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "84:     $inputnames = array('courses', 'users', 'roleassignments', 'posts', 'questions', 'resources',",
          "85:         'modulenumberaverage', 'participantnumberaverage');",
          "86:     foreach ($inputnames as $inputname) {",
          "87:         if (empty($fromform->{$inputname})) {",
          "88:             $fromform->{$inputname} = -1;",
          "89:         }",
          "90:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "113: if (!empty($fromform) and empty($update) and confirm_sesskey()) {",
          "115:     if (!empty($fromform) and confirm_sesskey()) { // if the register button has been clicked",
          "116:         $params = (array) $fromform; //we are using the form input as the redirection parameters (token, url and name)",
          "118:         $unconfirmedhub = $registrationmanager->get_unconfirmedhub($huburl);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128:         $siteinfo = $registrationmanager->get_site_info($huburl);",
          "129:         $fromform->courses = $siteinfo['courses'];",
          "130:         $fromform->users = $siteinfo['users'];",
          "131:         $fromform->enrolments = $siteinfo['enrolments'];",
          "132:         $fromform->posts = $siteinfo['posts'];",
          "133:         $fromform->questions = $siteinfo['questions'];",
          "134:         $fromform->resources = $siteinfo['resources'];",
          "135:         $fromform->modulenumberaverage = $siteinfo['modulenumberaverage'];",
          "136:         $fromform->participantnumberaverage = $siteinfo['participantnumberaverage'];",
          "137:         $fromform->street = $siteinfo['street'];",
          "",
          "---------------"
        ]
      }
    }
  ]
}