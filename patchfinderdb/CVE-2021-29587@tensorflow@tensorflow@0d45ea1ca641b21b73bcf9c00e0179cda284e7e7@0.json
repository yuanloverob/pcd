{
  "cve_id": "CVE-2021-29587",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The `Prepare` step of the `SpaceToDepth` TFLite operator does not check for 0 before division(https://github.com/tensorflow/tensorflow/blob/5f7975d09eac0f10ed8a17dbb6f5964977725adc/tensorflow/lite/kernels/space_to_depth.cc#L63-L67). An attacker can craft a model such that `params->block_size` would be zero. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "0d45ea1ca641b21b73bcf9c00e0179cda284e7e7",
  "patch_info": {
    "commit_hash": "0d45ea1ca641b21b73bcf9c00e0179cda284e7e7",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/0d45ea1ca641b21b73bcf9c00e0179cda284e7e7",
    "files": [
      "tensorflow/lite/kernels/space_to_depth.cc"
    ],
    "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
    "before_after_code_files": [
      "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
      "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "61:   TF_LITE_ENSURE_TYPES_EQ(context, input->type, output->type);",
      "63:   const int block_size = params->block_size;",
      "64:   const int input_height = input->dims->data[1];",
      "65:   const int input_width = input->dims->data[2];",
      "66:   int output_height = input_height / block_size;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "64:   TF_LITE_ENSURE(context, block_size > 0);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "46f9926845371ab318e480bd436baab0d936bc8f",
      "candidate_info": {
        "commit_hash": "46f9926845371ab318e480bd436baab0d936bc8f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/46f9926845371ab318e480bd436baab0d936bc8f",
        "files": [
          "tensorflow/lite/kernels/space_to_depth.cc"
        ],
        "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
          "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:   TF_LITE_ENSURE_TYPES_EQ(context, input->type, output->type);",
          "60:   const int block_size = params->block_size;",
          "61:   const int input_height = input->dims->data[1];",
          "62:   const int input_width = input->dims->data[2];",
          "63:   int output_height = input_height / block_size;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61:   TF_LITE_ENSURE(context, block_size > 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "32009c8b283ecdfe50c2ff4329447ffbf3bc1aa8",
      "candidate_info": {
        "commit_hash": "32009c8b283ecdfe50c2ff4329447ffbf3bc1aa8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/32009c8b283ecdfe50c2ff4329447ffbf3bc1aa8",
        "files": [
          "tensorflow/lite/kernels/space_to_depth.cc"
        ],
        "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
          "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "55:   TF_LITE_ENSURE_EQ(context, input->type, output->type);",
          "57:   const int block_size = params->block_size;",
          "58:   const int input_height = input->dims->data[1];",
          "59:   const int input_width = input->dims->data[2];",
          "60:   int output_height = input_height / block_size;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:   TF_LITE_ENSURE(context, block_size > 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "630e0eb14d37a84b7938b29f8f7b54c086a9f279",
      "candidate_info": {
        "commit_hash": "630e0eb14d37a84b7938b29f8f7b54c086a9f279",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/630e0eb14d37a84b7938b29f8f7b54c086a9f279",
        "files": [
          "tensorflow/lite/kernels/space_to_depth.cc"
        ],
        "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
          "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "61:   TF_LITE_ENSURE_TYPES_EQ(context, input->type, output->type);",
          "63:   const int block_size = params->block_size;",
          "64:   const int input_height = input->dims->data[1];",
          "65:   const int input_width = input->dims->data[2];",
          "66:   int output_height = input_height / block_size;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:   TF_LITE_ENSURE(context, block_size > 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "721faa013094e5ad35b628149557e943cae07ee6",
      "candidate_info": {
        "commit_hash": "721faa013094e5ad35b628149557e943cae07ee6",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/721faa013094e5ad35b628149557e943cae07ee6",
        "files": [
          "tensorflow/lite/kernels/space_to_depth.cc"
        ],
        "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
          "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "61:   TF_LITE_ENSURE_TYPES_EQ(context, input->type, output->type);",
          "63:   const int block_size = params->block_size;",
          "64:   const int input_height = input->dims->data[1];",
          "65:   const int input_width = input->dims->data[2];",
          "66:   int output_height = input_height / block_size;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:   TF_LITE_ENSURE(context, block_size > 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "69f55fa909d90b6f0d1eb3162e0009ae87e1a004",
      "candidate_info": {
        "commit_hash": "69f55fa909d90b6f0d1eb3162e0009ae87e1a004",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/69f55fa909d90b6f0d1eb3162e0009ae87e1a004",
        "files": [
          "tensorflow/lite/kernels/space_to_depth.cc"
        ],
        "message": "Prevent one more div by 0 in TFLite\n\nPiperOrigin-RevId: 370800114\nChange-Id: I6b956aeb8c458cc6f514408d2e89ffacfe249e57",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_depth.cc||tensorflow/lite/kernels/space_to_depth.cc": [
          "File: tensorflow/lite/kernels/space_to_depth.cc -> tensorflow/lite/kernels/space_to_depth.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "55:   TF_LITE_ENSURE_EQ(context, input->type, output->type);",
          "57:   const int block_size = params->block_size;",
          "58:   const int input_height = input->dims->data[1];",
          "59:   const int input_width = input->dims->data[2];",
          "60:   int output_height = input_height / block_size;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:   TF_LITE_ENSURE(context, block_size > 0);",
          "",
          "---------------"
        ]
      }
    }
  ]
}