{
  "cve_id": "CVE-2018-13097",
  "cve_desc": "An issue was discovered in fs/f2fs/super.c in the Linux kernel through 4.17.3. There is an out-of-bounds read or a divide-by-zero error for an incorrect user_block_count in a corrupted f2fs image, leading to a denial of service (BUG).",
  "repo": "torvalds/linux",
  "patch_hash": "9dc956b2c8523aed39d1e6508438be9fea28c8fc",
  "patch_info": {
    "commit_hash": "9dc956b2c8523aed39d1e6508438be9fea28c8fc",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/9dc956b2c8523aed39d1e6508438be9fea28c8fc",
    "files": [
      "fs/f2fs/super.c"
    ],
    "message": "f2fs: fix to do sanity check with user_block_count\n\nThis patch fixs to do sanity check with user_block_count.\n\n- Overview\nDivide zero in utilization when mount() a corrupted f2fs image\n\n- Reproduce (4.18 upstream kernel)\n\n- Kernel message\n[  564.099503] F2FS-fs (loop0): invalid crc value\n[  564.101991] divide error: 0000 [#1] SMP KASAN PTI\n[  564.103103] CPU: 1 PID: 1298 Comm: f2fs_discard-7: Not tainted 4.18.0-rc1+ #4\n[  564.104584] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014\n[  564.106624] RIP: 0010:issue_discard_thread+0x248/0x5c0\n[  564.107692] Code: ff ff 48 8b bd e8 fe ff ff 41 8b 9d 4c 04 00 00 e8 cd b8 ad ff 41 8b 85 50 04 00 00 31 d2 48 8d 04 80 48 8d 04 80 48 c1 e0 02 <48> f7 f3 83 f8 50 7e 16 41 c7 86 7c ff ff ff 01 00 00 00 41 c7 86\n[  564.111686] RSP: 0018:ffff8801f3117dc0 EFLAGS: 00010206\n[  564.112775] RAX: 0000000000000384 RBX: 0000000000000000 RCX: ffffffffb88c1e03\n[  564.114250] RDX: 0000000000000000 RSI: dffffc0000000000 RDI: ffff8801e3aa4850\n[  564.115706] RBP: ffff8801f3117f00 R08: 1ffffffff751a1d0 R09: fffffbfff751a1d0\n[  564.117177] R10: 0000000000000001 R11: fffffbfff751a1d0 R12: 00000000fffffffc\n[  564.118634] R13: ffff8801e3aa4400 R14: ffff8801f3117ed8 R15: ffff8801e2050000\n[  564.120094] FS:  0000000000000000(0000) GS:ffff8801f6f00000(0000) knlGS:0000000000000000\n[  564.121748] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  564.122923] CR2: 000000000202b078 CR3: 00000001f11ac000 CR4: 00000000000006e0\n[  564.124383] Call Trace:\n[  564.124924]  ? __issue_discard_cmd+0x480/0x480\n[  564.125882]  ? __sched_text_start+0x8/0x8\n[  564.126756]  ? __kthread_parkme+0xcb/0x100\n[  564.127620]  ? kthread_blkcg+0x70/0x70\n[  564.128412]  kthread+0x180/0x1d0\n[  564.129105]  ? __issue_discard_cmd+0x480/0x480\n[  564.130029]  ? kthread_associate_blkcg+0x150/0x150\n[  564.131033]  ret_from_fork+0x35/0x40\n[  564.131794] Modules linked in: snd_hda_codec_generic snd_hda_intel snd_hda_codec snd_hwdep snd_hda_core snd_pcm snd_timer snd mac_hid i2c_piix4 soundcore ib_iser rdma_cm iw_cm ib_cm ib_core iscsi_tcp libiscsi_tcp libiscsi scsi_transport_iscsi raid10 raid456 async_raid6_recov async_memcpy async_pq async_xor async_tx raid1 raid0 multipath linear 8139too crct10dif_pclmul crc32_pclmul qxl drm_kms_helper syscopyarea aesni_intel sysfillrect sysimgblt fb_sys_fops ttm drm aes_x86_64 crypto_simd cryptd 8139cp glue_helper mii pata_acpi floppy\n[  564.141798] ---[ end trace 4ce02f25ff7d3df5 ]---\n[  564.142773] RIP: 0010:issue_discard_thread+0x248/0x5c0\n[  564.143885] Code: ff ff 48 8b bd e8 fe ff ff 41 8b 9d 4c 04 00 00 e8 cd b8 ad ff 41 8b 85 50 04 00 00 31 d2 48 8d 04 80 48 8d 04 80 48 c1 e0 02 <48> f7 f3 83 f8 50 7e 16 41 c7 86 7c ff ff ff 01 00 00 00 41 c7 86\n[  564.147776] RSP: 0018:ffff8801f3117dc0 EFLAGS: 00010206\n[  564.148856] RAX: 0000000000000384 RBX: 0000000000000000 RCX: ffffffffb88c1e03\n[  564.150424] RDX: 0000000000000000 RSI: dffffc0000000000 RDI: ffff8801e3aa4850\n[  564.151906] RBP: ffff8801f3117f00 R08: 1ffffffff751a1d0 R09: fffffbfff751a1d0\n[  564.153463] R10: 0000000000000001 R11: fffffbfff751a1d0 R12: 00000000fffffffc\n[  564.154915] R13: ffff8801e3aa4400 R14: ffff8801f3117ed8 R15: ffff8801e2050000\n[  564.156405] FS:  0000000000000000(0000) GS:ffff8801f6f00000(0000) knlGS:0000000000000000\n[  564.158070] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  564.159279] CR2: 000000000202b078 CR3: 00000001f11ac000 CR4: 00000000000006e0\n[  564.161043] ==================================================================\n[  564.162587] BUG: KASAN: stack-out-of-bounds in from_kuid_munged+0x1d/0x50\n[  564.163994] Read of size 4 at addr ffff8801f3117c84 by task f2fs_discard-7:/1298\n\n[  564.165852] CPU: 1 PID: 1298 Comm: f2fs_discard-7: Tainted: G      D           4.18.0-rc1+ #4\n[  564.167593] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014\n[  564.169522] Call Trace:\n[  564.170057]  dump_stack+0x7b/0xb5\n[  564.170778]  print_address_description+0x70/0x290\n[  564.171765]  kasan_report+0x291/0x390\n[  564.172540]  ? from_kuid_munged+0x1d/0x50\n[  564.173408]  __asan_load4+0x78/0x80\n[  564.174148]  from_kuid_munged+0x1d/0x50\n[  564.174962]  do_notify_parent+0x1f5/0x4f0\n[  564.175808]  ? send_sigqueue+0x390/0x390\n[  564.176639]  ? css_set_move_task+0x152/0x340\n[  564.184197]  do_exit+0x1290/0x1390\n[  564.184950]  ? __issue_discard_cmd+0x480/0x480\n[  564.185884]  ? mm_update_next_owner+0x380/0x380\n[  564.186829]  ? __sched_text_start+0x8/0x8\n[  564.187672]  ? __kthread_parkme+0xcb/0x100\n[  564.188528]  ? kthread_blkcg+0x70/0x70\n[  564.189333]  ? kthread+0x180/0x1d0\n[  564.190052]  ? __issue_discard_cmd+0x480/0x480\n[  564.190983]  rewind_stack_do_exit+0x17/0x20\n\n[  564.192190] The buggy address belongs to the page:\n[  564.193213] page:ffffea0007cc45c0 count:0 mapcount:0 mapping:0000000000000000 index:0x0\n[  564.194856] flags: 0x2ffff0000000000()\n[  564.195644] raw: 02ffff0000000000 0000000000000000 dead000000000200 0000000000000000\n[  564.197247] raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000\n[  564.198826] page dumped because: kasan: bad access detected\n\n[  564.200299] Memory state around the buggy address:\n[  564.201306]  ffff8801f3117b80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n[  564.202779]  ffff8801f3117c00: 00 00 00 00 00 00 00 00 00 00 00 f3 f3 f3 f3 f3\n[  564.204252] >ffff8801f3117c80: f3 f3 f3 00 00 00 00 00 00 00 00 00 f1 f1 f1 f1\n[  564.205742]                    ^\n[  564.206424]  ffff8801f3117d00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n[  564.207908]  ffff8801f3117d80: f3 f3 f3 f3 f3 f3 f3 f3 00 00 00 00 00 00 00 00\n[  564.209389] ==================================================================\n[  564.231795] F2FS-fs (loop0): Mounted with checkpoint version = 2\n\n- Location\nhttps://elixir.bootlin.com/linux/v4.18-rc1/source/fs/f2fs/segment.h#L586\n\treturn div_u64((u64)valid_user_blocks(sbi) * 100,\n\t\t\t\t\tsbi->user_block_count);\nMissing checks on sbi->user_block_count.\n\nReported-by: Wen Xu <wen.xu@gatech.edu>\nSigned-off-by: Chao Yu <yuchao0@huawei.com>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>",
    "before_after_code_files": [
      "fs/f2fs/super.c||fs/f2fs/super.c"
    ]
  },
  "patch_diff": {
    "fs/f2fs/super.c||fs/f2fs/super.c": [
      "File: fs/f2fs/super.c -> fs/f2fs/super.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2283:  unsigned int sit_segs, nat_segs;",
      "2284:  unsigned int sit_bitmap_size, nat_bitmap_size;",
      "2285:  unsigned int log_blocks_per_seg;",
      "2286:  int i;",
      "2288:  total = le32_to_cpu(raw_super->segment_count);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2286:  unsigned int segment_count_main;",
      "2287:  block_t user_block_count;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2307:   return 1;",
      "2308:  }",
      "2310:  main_segs = le32_to_cpu(raw_super->segment_count_main);",
      "2311:  blocks_per_seg = sbi->blocks_per_seg;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2312:  user_block_count = le64_to_cpu(ckpt->user_block_count);",
      "2313:  segment_count_main = le32_to_cpu(raw_super->segment_count_main);",
      "2314:  log_blocks_per_seg = le32_to_cpu(raw_super->log_blocks_per_seg);",
      "2315:  if (!user_block_count || user_block_count >=",
      "2316:    segment_count_main << log_blocks_per_seg) {",
      "2317:   f2fs_msg(sbi->sb, KERN_ERR,",
      "2318:    \"Wrong user_block_count: %u\", user_block_count);",
      "2319:   return 1;",
      "2320:  }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2324:  sit_bitmap_size = le32_to_cpu(ckpt->sit_ver_bitmap_bytesize);",
      "2325:  nat_bitmap_size = le32_to_cpu(ckpt->nat_ver_bitmap_bytesize);",
      "2328:  if (sit_bitmap_size != ((sit_segs / 2) << log_blocks_per_seg) / 8 ||",
      "2329:   nat_bitmap_size != ((nat_segs / 2) << log_blocks_per_seg) / 8) {",
      "",
      "[Removed Lines]",
      "2326:  log_blocks_per_seg = le32_to_cpu(raw_super->log_blocks_per_seg);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "52dda80d62dff39979fb407d67b7c9fc02381589",
      "candidate_info": {
        "commit_hash": "52dda80d62dff39979fb407d67b7c9fc02381589",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/52dda80d62dff39979fb407d67b7c9fc02381589",
        "files": [
          "drivers/gpu/drm/i915/intel_guc.c"
        ],
        "message": "drm/i915: Protect guc_fini_wq() against module load abort\n\nPrevent\n[  397.873143] general protection fault: 0000 [#1] PREEMPT SMP PTI\n[  397.873154] CPU: 4 PID: 4799 Comm: drv_module_relo Tainted: G     U            4.18.0-rc6-CI-CI_DRM_4534+ #1\n[  397.873162] Hardware name: Micro-Star International Co., Ltd. MS-7B54/Z370M MORTAR (MS-7B54), BIOS 1.10 12/28/2017\n[  397.873175] RIP: 0010:__lock_acquire+0xf6/0x1b50\n[  397.873179] Code: 85 c0 4c 8b 9d 40 ff ff ff 8b 8d 38 ff ff ff 44 8b 8d 30 ff ff ff 4c 8b 85 28 ff ff ff 44 8b 95 24 ff ff ff 0f 84 54 03 00 00 <f0> ff 80 38 01 00 00 8b 15 45 8c 59 02 45 8b bc 24 70 08 00 00 85\n[  397.873240] RSP: 0018:ffffc90000497b40 EFLAGS: 00010002\n[  397.873246] RAX: 6b6b6b6b6b6b6b6b RBX: 0000000000000001 RCX: 0000000000000000\n[  397.873252] RDX: 0000000000000046 RSI: 0000000000000000 RDI: 0000000000000000\n[  397.873258] RBP: ffffc90000497c20 R08: ffffffff810a25e9 R09: 0000000000000000\n[  397.873264] R10: 0000000000000000 R11: ffff880255c63c28 R12: ffff8801093b2840\n[  397.873270] R13: 0000000000000001 R14: 0000000000000001 R15: 0000000000000246\n[  397.873277] FS:  00007faf88d71980(0000) GS:ffff880266300000(0000) knlGS:0000000000000000\n[  397.873284] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  397.873289] CR2: 000055d866c9ca10 CR3: 000000025472e006 CR4: 00000000003606e0\n[  397.873295] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n[  397.873301] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\n[  397.873308] Call Trace:\n[  397.873318]  ? lock_acquire+0xa6/0x210\n[  397.873323]  lock_acquire+0xa6/0x210\n[  397.873331]  ? drain_workqueue+0x19/0x180\n[  397.873339]  __mutex_lock+0x89/0x980\n[  397.873346]  ? drain_workqueue+0x19/0x180\n[  397.873352]  ? _raw_spin_unlock_irqrestore+0x4c/0x60\n[  397.873359]  ? trace_hardirqs_on_caller+0xe0/0x1b0\n[  397.873365]  ? drain_workqueue+0x19/0x180\n[  397.873373]  ? debug_object_active_state+0x127/0x150\n[  397.873381]  ? drain_workqueue+0x19/0x180\n[  397.873387]  drain_workqueue+0x19/0x180\n[  397.873395]  destroy_workqueue+0x12/0x1f0\n[  397.873476]  intel_guc_fini_misc+0x36/0x90 [i915]\n[  397.873540]  i915_gem_fini+0x91/0x100 [i915]\n[  397.873588]  i915_driver_unload+0xd2/0x110 [i915]\n[  397.873638]  i915_pci_remove+0x19/0x30 [i915]\n[  397.873646]  pci_device_remove+0x36/0xb0\n[  397.873653]  device_release_driver_internal+0x185/0x250\n[  397.873660]  driver_detach+0x35/0x70\n[  397.873668]  bus_remove_driver+0x53/0xd0\n[  397.873675]  pci_unregister_driver+0x25/0xa0\n[  397.873683]  __se_sys_delete_module+0x162/0x210\n[  397.873691]  ? do_syscall_64+0xd/0x190\n[  397.873697]  do_syscall_64+0x55/0x190\n[  397.873704]  entry_SYSCALL_64_after_hwframe+0x49/0xbe\n[  397.873710] RIP: 0033:0x7faf884231b7\n[  397.873714] Code: 73 01 c3 48 8b 0d d1 8c 2c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 b8 b0 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a1 8c 2c 00 f7 d8 64 89 01 48\n[  397.873775] RSP: 002b:00007ffda4e98cf8 EFLAGS: 00000206 ORIG_RAX: 00000000000000b0\n[  397.873784] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007faf884231b7\n[  397.873790] RDX: 0000000000000000 RSI: 0000000000000800 RDI: 000055fbb18f1bd8\n[  397.873796] RBP: 000055fbb18f1b70 R08: 000055fbb18f1bdc R09: 00007ffda4e98d38\n[  397.873802] R10: 00007ffda4e97cf4 R11: 0000000000000206 R12: 000055fbb0d32470\n[  397.873808] R13: 00007ffda4e992e0 R14: 0000000000000000 R15: 0000000000000000\n\nv2: It's use-after-free; not a NULL pointer.\n\nTestcase: igt/drv_module_reload/basic-reload-inject\nSigned-off-by: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Micha\u0142 Winiarski <michal.winiarski@intel.com>\nCc: Michal Wajdeczko <michal.wajdeczko@intel.com>\nReviewed-by: Micha\u0142 Winiarski <michal.winiarski@intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20180726085033.4044-1-chris@chris-wilson.co.uk",
        "before_after_code_files": [
          "drivers/gpu/drm/i915/intel_guc.c||drivers/gpu/drm/i915/intel_guc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/gpu/drm/i915/intel_guc.c||drivers/gpu/drm/i915/intel_guc.c": [
          "File: drivers/gpu/drm/i915/intel_guc.c -> drivers/gpu/drm/i915/intel_guc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "129: static void guc_fini_wq(struct intel_guc *guc)",
          "130: {",
          "138: }",
          "140: int intel_guc_init_misc(struct intel_guc *guc)",
          "",
          "[Removed Lines]",
          "131:  struct drm_i915_private *dev_priv = guc_to_i915(guc);",
          "133:  if (HAS_LOGICAL_RING_PREEMPTION(dev_priv) &&",
          "134:      USES_GUC_SUBMISSION(dev_priv))",
          "135:   destroy_workqueue(guc->preempt_wq);",
          "137:  destroy_workqueue(guc->log.relay.flush_wq);",
          "",
          "[Added Lines]",
          "131:  struct workqueue_struct *wq;",
          "133:  wq = fetch_and_zero(&guc->preempt_wq);",
          "134:  if (wq)",
          "135:   destroy_workqueue(wq);",
          "137:  wq = fetch_and_zero(&guc->log.relay.flush_wq);",
          "138:  if (wq)",
          "139:   destroy_workqueue(wq);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c77ec61ca0a49544ca81881cc5d5529858f7e196",
      "candidate_info": {
        "commit_hash": "c77ec61ca0a49544ca81881cc5d5529858f7e196",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/c77ec61ca0a49544ca81881cc5d5529858f7e196",
        "files": [
          "fs/f2fs/super.c"
        ],
        "message": "f2fs: fix to do sanity check with {sit,nat}_ver_bitmap_bytesize\n\nThis patch adds to do sanity check with {sit,nat}_ver_bitmap_bytesize\nduring mount, in order to avoid accessing across cache boundary with\nthis abnormal bitmap size.\n\n- Overview\nbuffer overrun in build_sit_info() when mounting a crafted f2fs image\n\n- Reproduce\n\n- Kernel message\n[  548.580867] F2FS-fs (loop0): Invalid log blocks per segment (8201)\n\n[  548.580877] F2FS-fs (loop0): Can't find valid F2FS filesystem in 1th superblock\n[  548.584979] ==================================================================\n[  548.586568] BUG: KASAN: use-after-free in kmemdup+0x36/0x50\n[  548.587715] Read of size 64 at addr ffff8801e9c265ff by task mount/1295\n\n[  548.589428] CPU: 1 PID: 1295 Comm: mount Not tainted 4.18.0-rc1+ #4\n[  548.589432] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014\n[  548.589438] Call Trace:\n[  548.589474]  dump_stack+0x7b/0xb5\n[  548.589487]  print_address_description+0x70/0x290\n[  548.589492]  kasan_report+0x291/0x390\n[  548.589496]  ? kmemdup+0x36/0x50\n[  548.589509]  check_memory_region+0x139/0x190\n[  548.589514]  memcpy+0x23/0x50\n[  548.589518]  kmemdup+0x36/0x50\n[  548.589545]  f2fs_build_segment_manager+0x8fa/0x3410\n[  548.589551]  ? __asan_loadN+0xf/0x20\n[  548.589560]  ? f2fs_sanity_check_ckpt+0x1be/0x240\n[  548.589566]  ? f2fs_flush_sit_entries+0x10c0/0x10c0\n[  548.589587]  ? __put_user_ns+0x40/0x40\n[  548.589604]  ? find_next_bit+0x57/0x90\n[  548.589610]  f2fs_fill_super+0x194b/0x2b40\n[  548.589617]  ? f2fs_commit_super+0x1b0/0x1b0\n[  548.589637]  ? set_blocksize+0x90/0x140\n[  548.589651]  mount_bdev+0x1c5/0x210\n[  548.589655]  ? f2fs_commit_super+0x1b0/0x1b0\n[  548.589667]  f2fs_mount+0x15/0x20\n[  548.589672]  mount_fs+0x60/0x1a0\n[  548.589683]  ? alloc_vfsmnt+0x309/0x360\n[  548.589688]  vfs_kern_mount+0x6b/0x1a0\n[  548.589699]  do_mount+0x34a/0x18c0\n[  548.589710]  ? lockref_put_or_lock+0xcf/0x160\n[  548.589716]  ? copy_mount_string+0x20/0x20\n[  548.589728]  ? memcg_kmem_put_cache+0x1b/0xa0\n[  548.589734]  ? kasan_check_write+0x14/0x20\n[  548.589740]  ? _copy_from_user+0x6a/0x90\n[  548.589744]  ? memdup_user+0x42/0x60\n[  548.589750]  ksys_mount+0x83/0xd0\n[  548.589755]  __x64_sys_mount+0x67/0x80\n[  548.589781]  do_syscall_64+0x78/0x170\n[  548.589797]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[  548.589820] RIP: 0033:0x7f76fc331b9a\n[  548.589821] Code: 48 8b 0d 01 c3 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d ce c2 2b 00 f7 d8 64 89 01 48\n[  548.589880] RSP: 002b:00007ffd4f0a0e48 EFLAGS: 00000206 ORIG_RAX: 00000000000000a5\n[  548.589890] RAX: ffffffffffffffda RBX: 000000000146c030 RCX: 00007f76fc331b9a\n[  548.589892] RDX: 000000000146c210 RSI: 000000000146df30 RDI: 0000000001474ec0\n[  548.589895] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000013\n[  548.589897] R10: 00000000c0ed0000 R11: 0000000000000206 R12: 0000000001474ec0\n[  548.589900] R13: 000000000146c210 R14: 0000000000000000 R15: 0000000000000003\n\n[  548.590242] The buggy address belongs to the page:\n[  548.591243] page:ffffea0007a70980 count:0 mapcount:0 mapping:0000000000000000 index:0x0\n[  548.592886] flags: 0x2ffff0000000000()\n[  548.593665] raw: 02ffff0000000000 dead000000000100 dead000000000200 0000000000000000\n[  548.595258] raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000\n[  548.603713] page dumped because: kasan: bad access detected\n\n[  548.605203] Memory state around the buggy address:\n[  548.606198]  ffff8801e9c26480: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff\n[  548.607676]  ffff8801e9c26500: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff\n[  548.609157] >ffff8801e9c26580: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff\n[  548.610629]                                                                 ^\n[  548.612088]  ffff8801e9c26600: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff\n[  548.613674]  ffff8801e9c26680: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff\n[  548.615141] ==================================================================\n[  548.616613] Disabling lock debugging due to kernel taint\n[  548.622871] WARNING: CPU: 1 PID: 1295 at mm/page_alloc.c:4065 __alloc_pages_slowpath+0xe4a/0x1420\n[  548.622878] Modules linked in: snd_hda_codec_generic snd_hda_intel snd_hda_codec snd_hwdep snd_hda_core snd_pcm snd_timer snd mac_hid i2c_piix4 soundcore ib_iser rdma_cm iw_cm ib_cm ib_core iscsi_tcp libiscsi_tcp libiscsi scsi_transport_iscsi raid10 raid456 async_raid6_recov async_memcpy async_pq async_xor async_tx raid1 raid0 multipath linear 8139too crct10dif_pclmul crc32_pclmul qxl drm_kms_helper syscopyarea aesni_intel sysfillrect sysimgblt fb_sys_fops ttm drm aes_x86_64 crypto_simd cryptd 8139cp glue_helper mii pata_acpi floppy\n[  548.623217] CPU: 1 PID: 1295 Comm: mount Tainted: G    B             4.18.0-rc1+ #4\n[  548.623219] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014\n[  548.623226] RIP: 0010:__alloc_pages_slowpath+0xe4a/0x1420\n[  548.623227] Code: ff ff 01 89 85 c8 fe ff ff e9 91 fc ff ff 41 89 c5 e9 5c fc ff ff 0f 0b 89 f8 25 ff ff f7 ff 89 85 8c fe ff ff e9 d5 f2 ff ff <0f> 0b e9 65 f2 ff ff 65 8b 05 38 81 d2 47 f6 c4 01 74 1c 65 48 8b\n[  548.623281] RSP: 0018:ffff8801f28c7678 EFLAGS: 00010246\n[  548.623284] RAX: 0000000000000000 RBX: 00000000006040c0 RCX: ffffffffb82f73b7\n[  548.623287] RDX: 1ffff1003e518eeb RSI: 000000000000000c RDI: 0000000000000000\n[  548.623290] RBP: ffff8801f28c7880 R08: 0000000000000000 R09: ffffed0047fff2c5\n[  548.623292] R10: 0000000000000001 R11: ffffed0047fff2c4 R12: ffff8801e88de040\n[  548.623295] R13: 00000000006040c0 R14: 000000000000000c R15: ffff8801f28c7938\n[  548.623299] FS:  00007f76fca51840(0000) GS:ffff8801f6f00000(0000) knlGS:0000000000000000\n[  548.623302] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  548.623304] CR2: 00007f19b9171760 CR3: 00000001ed952000 CR4: 00000000000006e0\n[  548.623317] Call Trace:\n[  548.623325]  ? kasan_check_read+0x11/0x20\n[  548.623330]  ? __zone_watermark_ok+0x92/0x240\n[  548.623336]  ? get_page_from_freelist+0x1c3/0x1d90\n[  548.623347]  ? _raw_spin_lock_irqsave+0x2a/0x60\n[  548.623353]  ? warn_alloc+0x250/0x250\n[  548.623358]  ? save_stack+0x46/0xd0\n[  548.623361]  ? kasan_kmalloc+0xad/0xe0\n[  548.623366]  ? __isolate_free_page+0x2a0/0x2a0\n[  548.623370]  ? mount_fs+0x60/0x1a0\n[  548.623374]  ? vfs_kern_mount+0x6b/0x1a0\n[  548.623378]  ? do_mount+0x34a/0x18c0\n[  548.623383]  ? ksys_mount+0x83/0xd0\n[  548.623387]  ? __x64_sys_mount+0x67/0x80\n[  548.623391]  ? do_syscall_64+0x78/0x170\n[  548.623396]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[  548.623401]  __alloc_pages_nodemask+0x3c5/0x400\n[  548.623407]  ? __alloc_pages_slowpath+0x1420/0x1420\n[  548.623412]  ? __mutex_lock_slowpath+0x20/0x20\n[  548.623417]  ? kvmalloc_node+0x31/0x80\n[  548.623424]  alloc_pages_current+0x75/0x110\n[  548.623436]  kmalloc_order+0x24/0x60\n[  548.623442]  kmalloc_order_trace+0x24/0xb0\n[  548.623448]  __kmalloc_track_caller+0x207/0x220\n[  548.623455]  ? f2fs_build_node_manager+0x399/0xbb0\n[  548.623460]  kmemdup+0x20/0x50\n[  548.623465]  f2fs_build_node_manager+0x399/0xbb0\n[  548.623470]  f2fs_fill_super+0x195e/0x2b40\n[  548.623477]  ? f2fs_commit_super+0x1b0/0x1b0\n[  548.623481]  ? set_blocksize+0x90/0x140\n[  548.623486]  mount_bdev+0x1c5/0x210\n[  548.623489]  ? f2fs_commit_super+0x1b0/0x1b0\n[  548.623495]  f2fs_mount+0x15/0x20\n[  548.623498]  mount_fs+0x60/0x1a0\n[  548.623503]  ? alloc_vfsmnt+0x309/0x360\n[  548.623508]  vfs_kern_mount+0x6b/0x1a0\n[  548.623513]  do_mount+0x34a/0x18c0\n[  548.623518]  ? lockref_put_or_lock+0xcf/0x160\n[  548.623523]  ? copy_mount_string+0x20/0x20\n[  548.623528]  ? memcg_kmem_put_cache+0x1b/0xa0\n[  548.623533]  ? kasan_check_write+0x14/0x20\n[  548.623537]  ? _copy_from_user+0x6a/0x90\n[  548.623542]  ? memdup_user+0x42/0x60\n[  548.623547]  ksys_mount+0x83/0xd0\n[  548.623552]  __x64_sys_mount+0x67/0x80\n[  548.623557]  do_syscall_64+0x78/0x170\n[  548.623562]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[  548.623566] RIP: 0033:0x7f76fc331b9a\n[  548.623567] Code: 48 8b 0d 01 c3 2b 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 49 89 ca b8 a5 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d ce c2 2b 00 f7 d8 64 89 01 48\n[  548.623632] RSP: 002b:00007ffd4f0a0e48 EFLAGS: 00000206 ORIG_RAX: 00000000000000a5\n[  548.623636] RAX: ffffffffffffffda RBX: 000000000146c030 RCX: 00007f76fc331b9a\n[  548.623639] RDX: 000000000146c210 RSI: 000000000146df30 RDI: 0000000001474ec0\n[  548.623641] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000013\n[  548.623643] R10: 00000000c0ed0000 R11: 0000000000000206 R12: 0000000001474ec0\n[  548.623646] R13: 000000000146c210 R14: 0000000000000000 R15: 0000000000000003\n[  548.623650] ---[ end trace 4ce02f25ff7d3df5 ]---\n[  548.623656] F2FS-fs (loop0): Failed to initialize F2FS node manager\n[  548.627936] F2FS-fs (loop0): Invalid log blocks per segment (8201)\n\n[  548.627940] F2FS-fs (loop0): Can't find valid F2FS filesystem in 1th superblock\n[  548.635835] F2FS-fs (loop0): Failed to initialize F2FS node manager\n\n- Location\nhttps://elixir.bootlin.com/linux/v4.18-rc1/source/fs/f2fs/segment.c#L3578\n\n\tsit_i->sit_bitmap = kmemdup(src_bitmap, bitmap_size, GFP_KERNEL);\n\nBuffer overrun happens when doing memcpy. I suspect there is missing (inconsistent) checks on bitmap_size.\n\nReported by Wen Xu (wen.xu@gatech.edu) from SSLab, Gatech.\n\nReported-by: Wen Xu <wen.xu@gatech.edu>\nSigned-off-by: Chao Yu <yuchao0@huawei.com>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>",
        "before_after_code_files": [
          "fs/f2fs/super.c||fs/f2fs/super.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "fs/f2fs/super.c||fs/f2fs/super.c"
          ],
          "candidate": [
            "fs/f2fs/super.c||fs/f2fs/super.c"
          ]
        }
      },
      "candidate_diff": {
        "fs/f2fs/super.c||fs/f2fs/super.c": [
          "File: fs/f2fs/super.c -> fs/f2fs/super.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2280:  struct f2fs_checkpoint *ckpt = F2FS_CKPT(sbi);",
          "2281:  unsigned int ovp_segments, reserved_segments;",
          "2282:  unsigned int main_segs, blocks_per_seg;",
          "2283:  int i;",
          "2285:  total = le32_to_cpu(raw_super->segment_count);",
          "2286:  fsmeta = le32_to_cpu(raw_super->segment_count_ckpt);",
          "2289:  fsmeta += le32_to_cpu(ckpt->rsvd_segment_count);",
          "2290:  fsmeta += le32_to_cpu(raw_super->segment_count_ssa);",
          "",
          "[Removed Lines]",
          "2287:  fsmeta += le32_to_cpu(raw_super->segment_count_sit);",
          "2288:  fsmeta += le32_to_cpu(raw_super->segment_count_nat);",
          "",
          "[Added Lines]",
          "2283:  unsigned int sit_segs, nat_segs;",
          "2284:  unsigned int sit_bitmap_size, nat_bitmap_size;",
          "2285:  unsigned int log_blocks_per_seg;",
          "2290:  sit_segs = le32_to_cpu(raw_super->segment_count_sit);",
          "2291:  fsmeta += sit_segs;",
          "2292:  nat_segs = le32_to_cpu(raw_super->segment_count_nat);",
          "2293:  fsmeta += nat_segs;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2316:    return 1;",
          "2317:  }",
          "2319:  if (unlikely(f2fs_cp_error(sbi))) {",
          "2320:   f2fs_msg(sbi->sb, KERN_ERR, \"A bug case: need to run fsck\");",
          "2321:   return 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2324:  sit_bitmap_size = le32_to_cpu(ckpt->sit_ver_bitmap_bytesize);",
          "2325:  nat_bitmap_size = le32_to_cpu(ckpt->nat_ver_bitmap_bytesize);",
          "2326:  log_blocks_per_seg = le32_to_cpu(raw_super->log_blocks_per_seg);",
          "2328:  if (sit_bitmap_size != ((sit_segs / 2) << log_blocks_per_seg) / 8 ||",
          "2329:   nat_bitmap_size != ((nat_segs / 2) << log_blocks_per_seg) / 8) {",
          "2330:   f2fs_msg(sbi->sb, KERN_ERR,",
          "2331:    \"Wrong bitmap size: sit: %u, nat:%u\",",
          "2332:    sit_bitmap_size, nat_bitmap_size);",
          "2333:   return 1;",
          "2334:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "20cdcaf903298d54b834daedf65a2ddef70cae0a",
      "candidate_info": {
        "commit_hash": "20cdcaf903298d54b834daedf65a2ddef70cae0a",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/20cdcaf903298d54b834daedf65a2ddef70cae0a",
        "files": [
          "drivers/media/usb/em28xx/em28xx-cards.c"
        ],
        "message": "media: em28xx: Fix DualHD disconnect oops\n\nDuring the duplication of em28xx state for the second tuner pair\na pointer to alt_max_pkt_size_isoc is copied. During tear down\nthe second tuner is destroyed first and kfrees alt_max_pkt_size_isoc,\nthen the first tuner is destroyed and kfrees it again. The property\nshould only be kfree'd if the tuner is PRIMARY_TS.\n\n[  354.888560] ------------[ cut here ]------------\n[  354.888562] kernel BUG at mm/slub.c:296!\n[  354.888574] invalid opcode: 0000 [#1] SMP NOPTI\n[  354.888869] CPU: 1 PID: 19 Comm: kworker/1:0 Not tainted 4.18.0-rc1+ #20\n[  354.889140] Hardware name: MSI MS-7A39/B350M GAMING PRO (MS-7A39), BIOS 2.G0 04/27/2018\n[  354.889408] Workqueue: usb_hub_wq hub_event\n[  354.889679] RIP: 0010:__slab_free+0x217/0x370\n[  354.889942] Code: bb c0 e8 07 41 38 c7 72 39 48 83 c4 70 5b 41 5a 41 5c 41 5d 41 5e 41 5f 5d 49 8d 62 f8 c3 f3 90 49 8b 04 24 a8 01 75 f6 eb 82 <0f> 0b 44 89 45 80 48 89 4d 88 e8 aa fa ff ff 85 c0 74 cc e9 b7 fe\n[  354.890598] RSP: 0018:ffffb84c41a4fad0 EFLAGS: 00010246\n[  354.890934] RAX: ffff948646e85150 RBX: ffff948646e85150 RCX: ffff948646e85150\n[  354.891280] RDX: 00000000820001d9 RSI: fffffa8fd01ba140 RDI: ffff94865e807c00\n[  354.891649] RBP: ffffb84c41a4fb70 R08: 0000000000000001 R09: ffffffffc059ce21\n[  354.892025] R10: ffff948646e85150 R11: 0000000000000001 R12: fffffa8fd01ba140\n[  354.892403] R13: ffff948646e85150 R14: ffff94865e807c00 R15: ffff94864c92e0a0\n[  354.892780] FS:  0000000000000000(0000) GS:ffff94865ec40000(0000) knlGS:0000000000000000\n[  354.893150] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  354.893530] CR2: 00007f4e476da950 CR3: 000000040112c000 CR4: 00000000003406e0\n[  354.893917] Call Trace:\n[  354.894315]  ? __dev_printk+0x3c/0x80\n[  354.894695]  ? _dev_info+0x64/0x80\n[  354.895082]  ? em28xx_free_device+0x41/0x50 [em28xx]\n[  354.895464]  kfree+0x17a/0x190\n[  354.895852]  ? kfree+0x17a/0x190\n[  354.896310]  em28xx_free_device+0x41/0x50 [em28xx]\n[  354.896698]  em28xx_usb_disconnect+0xfa/0x110 [em28xx]\n[  354.897083]  usb_unbind_interface+0x7a/0x270\n[  354.897475]  device_release_driver_internal+0x17c/0x250\n[  354.897864]  device_release_driver+0x12/0x20\n[  354.898252]  bus_remove_device+0xec/0x160\n[  354.898639]  device_del+0x13d/0x320\n[  354.899018]  ? usb_remove_ep_devs+0x1f/0x30\n[  354.899392]  usb_disable_device+0x9e/0x270\n[  354.899772]  usb_disconnect+0x92/0x2a0\n[  354.900149]  hub_event+0x98e/0x1650\n[  354.900519]  ? sched_clock_cpu+0x11/0xa0\n[  354.900890]  process_one_work+0x167/0x3f0\n[  354.901251]  worker_thread+0x4d/0x460\n[  354.901610]  kthread+0x105/0x140\n[  354.901964]  ? rescuer_thread+0x360/0x360\n[  354.902318]  ? kthread_associate_blkcg+0xa0/0xa0\n[  354.902672]  ret_from_fork+0x22/0x40\n[  354.903024] Modules linked in: rc_hauppauge em28xx_rc rc_core si2157 lgdt3306a i2c_mux em28xx_dvb dvb_core videobuf2_vmalloc videobuf2_memops videobuf2_common snd_hda_codec_hdmi nls_iso8859_1 edac_mce_amd kvm crct10dif_pclmul crc32_pclmul ghash_clmulni_intel pcbc snd_hda_intel snd_hda_codec snd_hda_core snd_hwdep snd_pcm snd_seq_midi aesni_intel snd_seq_midi_event aes_x86_64 snd_rawmidi crypto_simd em28xx cryptd glue_helper asix tveeprom usbnet snd_seq v4l2_common mii videodev snd_seq_device media input_leds snd_timer joydev ccp k10temp wmi_bmof snd soundcore mac_hid sch_fq_codel parport_pc ppdev lp parport ip_tables x_tables vfio_pci vfio_virqfd irqbypass vfio_iommu_type1 vfio nouveau mxm_wmi video i2c_algo_bit ttm drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops i2c_piix4 drm ahci libahci\n[  354.905129]  wmi gpio_amdpt gpio_generic hid_generic usbhid hid\n[  354.908140] ---[ end trace c230d02716298c34 ]---\n[  354.908145] RIP: 0010:__slab_free+0x217/0x370\n[  354.908147] Code: bb c0 e8 07 41 38 c7 72 39 48 83 c4 70 5b 41 5a 41 5c 41 5d 41 5e 41 5f 5d 49 8d 62 f8 c3 f3 90 49 8b 04 24 a8 01 75 f6 eb 82 <0f> 0b 44 89 45 80 48 89 4d 88 e8 aa fa ff ff 85 c0 74 cc e9 b7 fe\n[  354.908183] RSP: 0018:ffffb84c41a4fad0 EFLAGS: 00010246\n[  354.908186] RAX: ffff948646e85150 RBX: ffff948646e85150 RCX: ffff948646e85150\n[  354.908189] RDX: 00000000820001d9 RSI: fffffa8fd01ba140 RDI: ffff94865e807c00\n[  354.908191] RBP: ffffb84c41a4fb70 R08: 0000000000000001 R09: ffffffffc059ce21\n[  354.908193] R10: ffff948646e85150 R11: 0000000000000001 R12: fffffa8fd01ba140\n[  354.908195] R13: ffff948646e85150 R14: ffff94865e807c00 R15: ffff94864c92e0a0\n[  354.908198] FS:  0000000000000000(0000) GS:ffff94865ec40000(0000) knlGS:0000000000000000\n[  354.908201] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  354.908203] CR2: 00007f4e476da950 CR3: 000000016b20a000 CR4: 00000000003406e0\n\nSigned-off-by: Brad Love <brad@nextdimension.cc>\nSigned-off-by: Michael Ira Krufky <mkrufky@gmail.com>\nSigned-off-by: Mauro Carvalho Chehab <mchehab+samsung@kernel.org>",
        "before_after_code_files": [
          "drivers/mediusb/em28xx/em28xx-cards.c||drivers/media/usem28xx/em28xx-cards.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/mediusb/em28xx/em28xx-cards.c||drivers/media/usem28xx/em28xx-cards.c": [
          "File: drivers/mediusb/em28xx/em28xx-cards.c -> drivers/media/usem28xx/em28xx-cards.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e2374015f27fe5ee5d5c37966e2faf396cdaaa65",
      "candidate_info": {
        "commit_hash": "e2374015f27fe5ee5d5c37966e2faf396cdaaa65",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/e2374015f27fe5ee5d5c37966e2faf396cdaaa65",
        "files": [
          "fs/f2fs/f2fs.h",
          "fs/f2fs/node.c"
        ],
        "message": "f2fs: fix to propagate return value of scan_nat_page()\n\nAs Anatoly Trosinenko reported in bugzilla:\n\nHow to reproduce:\n1. Compile the 73fcb1a370c76 version of the kernel using the config attached\n2. Unpack and mount the attached filesystem image as F2FS\n3. The kernel will BUG() on mount (BUGs are explicitly enabled in config)\n\n[    2.233612] F2FS-fs (sda): Found nat_bits in checkpoint\n[    2.248422] ------------[ cut here ]------------\n[    2.248857] kernel BUG at fs/f2fs/node.c:1967!\n[    2.249760] invalid opcode: 0000 [#1] SMP NOPTI\n[    2.250219] Modules linked in:\n[    2.251848] CPU: 0 PID: 944 Comm: mount Not tainted 4.17.0-rc5+ #1\n[    2.252331] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014\n[    2.253305] RIP: 0010:build_free_nids+0x337/0x3f0\n[    2.253672] RSP: 0018:ffffae7fc0857c50 EFLAGS: 00000246\n[    2.254080] RAX: 00000000ffffffff RBX: 0000000000000123 RCX: 0000000000000001\n[    2.254638] RDX: ffff9aa7063d5c00 RSI: 0000000000000122 RDI: ffff9aa705852e00\n[    2.255190] RBP: ffff9aa705852e00 R08: 0000000000000001 R09: ffff9aa7059090c0\n[    2.255719] R10: 0000000000000000 R11: 0000000000000000 R12: ffff9aa705852e00\n[    2.256242] R13: ffff9aa7063ad000 R14: ffff9aa705919000 R15: 0000000000000123\n[    2.256809] FS:  00000000023078c0(0000) GS:ffff9aa707800000(0000) knlGS:0000000000000000\n[    2.258654] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[    2.259153] CR2: 00000000005511ae CR3: 0000000005872000 CR4: 00000000000006f0\n[    2.259801] Call Trace:\n[    2.260583]  build_node_manager+0x5cd/0x600\n[    2.260963]  f2fs_fill_super+0x66a/0x17c0\n[    2.261300]  ? f2fs_commit_super+0xe0/0xe0\n[    2.261622]  mount_bdev+0x16e/0x1a0\n[    2.261899]  mount_fs+0x30/0x150\n[    2.262398]  vfs_kern_mount.part.28+0x4f/0xf0\n[    2.262743]  do_mount+0x5d0/0xc60\n[    2.263010]  ? _copy_from_user+0x37/0x60\n[    2.263313]  ? memdup_user+0x39/0x60\n[    2.263692]  ksys_mount+0x7b/0xd0\n[    2.263960]  __x64_sys_mount+0x1c/0x20\n[    2.264268]  do_syscall_64+0x43/0xf0\n[    2.264560]  entry_SYSCALL_64_after_hwframe+0x44/0xa9\n[    2.265095] RIP: 0033:0x48d31a\n[    2.265502] RSP: 002b:00007ffc6fe60a08 EFLAGS: 00000246 ORIG_RAX: 00000000000000a5\n[    2.266089] RAX: ffffffffffffffda RBX: 0000000000008000 RCX: 000000000048d31a\n[    2.266607] RDX: 00007ffc6fe62fa5 RSI: 00007ffc6fe62f9d RDI: 00007ffc6fe62f94\n[    2.267130] RBP: 00000000023078a0 R08: 0000000000000000 R09: 0000000000000000\n[    2.267670] R10: 0000000000008000 R11: 0000000000000246 R12: 0000000000000000\n[    2.268192] R13: 0000000000000000 R14: 00007ffc6fe60c78 R15: 0000000000000000\n[    2.268767] Code: e8 5f c3 ff ff 83 c3 01 41 83 c7 01 81 fb c7 01 00 00 74 48 44 39 7d 04 76 42 48 63 c3 48 8d 04 c0 41 8b 44 06 05 83 f8 ff 75 c1 <0f> 0b 49 8b 45 50 48 8d b8 b0 00 00 00 e8 37 59 69 00 b9 01 00\n[    2.270434] RIP: build_free_nids+0x337/0x3f0 RSP: ffffae7fc0857c50\n[    2.271426] ---[ end trace ab20c06cd3c8fde4 ]---\n\nDuring loading NAT entries, we will do sanity check, once the entry info\nis corrupted, it will cause BUG_ON directly to protect user data from\nbeing overwrited.\n\nIn this case, it will be better to just return failure on mount() instead\nof panic, so that user can get hint from kmsg and try fsck for recovery\nimmediately rather than after an abnormal reboot.\n\nhttps://bugzilla.kernel.org/show_bug.cgi?id=199769\n\nReported-by: Anatoly Trosinenko <anatoly.trosinenko@gmail.com>\nSigned-off-by: Chao Yu <yuchao0@huawei.com>\nSigned-off-by: Jaegeuk Kim <jaegeuk@kernel.org>",
        "before_after_code_files": [
          "fs/f2fs/f2fs.h||fs/f2fs/f2fs.h",
          "fs/f2fs/node.c||fs/f2fs/node.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "fs/f2fs/f2fs.h||fs/f2fs/f2fs.h": [
          "File: fs/f2fs/f2fs.h -> fs/f2fs/f2fs.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "2813: int f2fs_sync_node_pages(struct f2fs_sb_info *sbi,",
          "2814:    struct writeback_control *wbc,",
          "2815:    bool do_balance, enum iostat_type io_type);",
          "2817: bool f2fs_alloc_nid(struct f2fs_sb_info *sbi, nid_t *nid);",
          "2818: void f2fs_alloc_nid_done(struct f2fs_sb_info *sbi, nid_t nid);",
          "2819: void f2fs_alloc_nid_failed(struct f2fs_sb_info *sbi, nid_t nid);",
          "",
          "[Removed Lines]",
          "2816: void f2fs_build_free_nids(struct f2fs_sb_info *sbi, bool sync, bool mount);",
          "",
          "[Added Lines]",
          "2816: int f2fs_build_free_nids(struct f2fs_sb_info *sbi, bool sync, bool mount);",
          "",
          "---------------"
        ],
        "fs/f2fs/node.c||fs/f2fs/node.c": [
          "File: fs/f2fs/node.c -> fs/f2fs/node.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1977:   kmem_cache_free(free_nid_slab, i);",
          "1978: }",
          "1981:    struct page *nat_page, nid_t start_nid)",
          "1982: {",
          "1983:  struct f2fs_nm_info *nm_i = NM_I(sbi);",
          "",
          "[Removed Lines]",
          "1980: static void scan_nat_page(struct f2fs_sb_info *sbi,",
          "",
          "[Added Lines]",
          "1980: static int scan_nat_page(struct f2fs_sb_info *sbi,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1995:    break;",
          "1997:   blk_addr = le32_to_cpu(nat_blk->entries[i].block_addr);",
          "1999:   if (blk_addr == NULL_ADDR) {",
          "2000:    add_free_nid(sbi, start_nid, true, true);",
          "2001:   } else {",
          "",
          "[Removed Lines]",
          "1998:   f2fs_bug_on(sbi, blk_addr == NEW_ADDR);",
          "",
          "[Added Lines]",
          "1999:   if (blk_addr == NEW_ADDR)",
          "2000:    return -EINVAL;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2004:    spin_unlock(&NM_I(sbi)->nid_list_lock);",
          "2005:   }",
          "2006:  }",
          "2007: }",
          "2009: static void scan_curseg_cache(struct f2fs_sb_info *sbi)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2011:  return 0;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2059:  up_read(&nm_i->nat_tree_lock);",
          "2060: }",
          "2063:       bool sync, bool mount)",
          "2064: {",
          "2065:  struct f2fs_nm_info *nm_i = NM_I(sbi);",
          "2067:  nid_t nid = nm_i->next_scan_nid;",
          "2069:  if (unlikely(nid >= nm_i->max_nid))",
          "",
          "[Removed Lines]",
          "2062: static void __f2fs_build_free_nids(struct f2fs_sb_info *sbi,",
          "2066:  int i = 0;",
          "",
          "[Added Lines]",
          "2067: static int __f2fs_build_free_nids(struct f2fs_sb_info *sbi,",
          "2071:  int i = 0, ret;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2073:  if (nm_i->nid_cnt[FREE_NID] >= NAT_ENTRY_PER_BLOCK)",
          "2076:  if (!sync && !f2fs_available_free_memory(sbi, FREE_NIDS))",
          "2079:  if (!mount) {",
          "2081:   scan_free_nid_bits(sbi);",
          "2083:   if (nm_i->nid_cnt[FREE_NID] >= NAT_ENTRY_PER_BLOCK)",
          "2085:  }",
          "",
          "[Removed Lines]",
          "2074:   return;",
          "2077:   return;",
          "2084:    return;",
          "",
          "[Added Lines]",
          "2079:   return 0;",
          "2082:   return 0;",
          "2089:    return 0;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2095:       nm_i->nat_block_bitmap)) {",
          "2096:    struct page *page = get_current_nat_page(sbi, nid);",
          "2099:    f2fs_put_page(page, 1);",
          "2100:   }",
          "2102:   nid += (NAT_ENTRY_PER_BLOCK - (nid % NAT_ENTRY_PER_BLOCK));",
          "",
          "[Removed Lines]",
          "2098:    scan_nat_page(sbi, page, nid);",
          "",
          "[Added Lines]",
          "2103:    ret = scan_nat_page(sbi, page, nid);",
          "2106:    if (ret) {",
          "2107:     up_read(&nm_i->nat_tree_lock);",
          "2108:     f2fs_bug_on(sbi, !mount);",
          "2109:     f2fs_msg(sbi->sb, KERN_ERR,",
          "2110:      \"NAT is corrupt, run fsck to fix it\");",
          "2111:     return -EINVAL;",
          "2112:    }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2118:  f2fs_ra_meta_pages(sbi, NAT_BLOCK_OFFSET(nm_i->next_scan_nid),",
          "2119:      nm_i->ra_nid_pages, META_NAT, false);",
          "2120: }",
          "2123: {",
          "2124:  mutex_lock(&NM_I(sbi)->build_lock);",
          "2126:  mutex_unlock(&NM_I(sbi)->build_lock);",
          "2127: }",
          "",
          "[Removed Lines]",
          "2122: void f2fs_build_free_nids(struct f2fs_sb_info *sbi, bool sync, bool mount)",
          "2125:  __f2fs_build_free_nids(sbi, sync, mount);",
          "",
          "[Added Lines]",
          "2134:  return 0;",
          "2137: int f2fs_build_free_nids(struct f2fs_sb_info *sbi, bool sync, bool mount)",
          "2139:  int ret;",
          "2142:  ret = __f2fs_build_free_nids(sbi, sync, mount);",
          "2145:  return ret;",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2818:  load_free_nid_bitmap(sbi);",
          "2822: }",
          "2824: void f2fs_destroy_node_manager(struct f2fs_sb_info *sbi)",
          "",
          "[Removed Lines]",
          "2820:  f2fs_build_free_nids(sbi, true, true);",
          "2821:  return 0;",
          "",
          "[Added Lines]",
          "2839:  return f2fs_build_free_nids(sbi, true, true);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "89da619bc18d79bca5304724c11d4ba3b67ce2c6",
      "candidate_info": {
        "commit_hash": "89da619bc18d79bca5304724c11d4ba3b67ce2c6",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/89da619bc18d79bca5304724c11d4ba3b67ce2c6",
        "files": [
          "drivers/virtio/virtio_balloon.c"
        ],
        "message": "virtio_balloon: fix another race between migration and ballooning\n\nKernel panic when with high memory pressure, calltrace looks like,\n\nPID: 21439 TASK: ffff881be3afedd0 CPU: 16 COMMAND: \"java\"\n #0 [ffff881ec7ed7630] machine_kexec at ffffffff81059beb\n #1 [ffff881ec7ed7690] __crash_kexec at ffffffff81105942\n #2 [ffff881ec7ed7760] crash_kexec at ffffffff81105a30\n #3 [ffff881ec7ed7778] oops_end at ffffffff816902c8\n #4 [ffff881ec7ed77a0] no_context at ffffffff8167ff46\n #5 [ffff881ec7ed77f0] __bad_area_nosemaphore at ffffffff8167ffdc\n #6 [ffff881ec7ed7838] __node_set at ffffffff81680300\n #7 [ffff881ec7ed7860] __do_page_fault at ffffffff8169320f\n #8 [ffff881ec7ed78c0] do_page_fault at ffffffff816932b5\n #9 [ffff881ec7ed78f0] page_fault at ffffffff8168f4c8\n    [exception RIP: _raw_spin_lock_irqsave+47]\n    RIP: ffffffff8168edef RSP: ffff881ec7ed79a8 RFLAGS: 00010046\n    RAX: 0000000000000246 RBX: ffffea0019740d00 RCX: ffff881ec7ed7fd8\n    RDX: 0000000000020000 RSI: 0000000000000016 RDI: 0000000000000008\n    RBP: ffff881ec7ed79a8 R8: 0000000000000246 R9: 000000000001a098\n    R10: ffff88107ffda000 R11: 0000000000000000 R12: 0000000000000000\n    R13: 0000000000000008 R14: ffff881ec7ed7a80 R15: ffff881be3afedd0\n    ORIG_RAX: ffffffffffffffff CS: 0010 SS: 0018\n\nIt happens in the pagefault and results in double pagefault\nduring compacting pages when memory allocation fails.\n\nAnalysed the vmcore, the page leads to second pagefault is corrupted\nwith _mapcount=-256, but private=0.\n\nIt's caused by the race between migration and ballooning, and lock\nmissing in virtballoon_migratepage() of virtio_balloon driver.\nThis patch fix the bug.\n\nFixes: e22504296d4f64f (\"virtio_balloon: introduce migration primitives to balloon pages\")\nCc: stable@vger.kernel.org\nSigned-off-by: Jiang Biao <jiang.biao2@zte.com.cn>\nSigned-off-by: Huang Chong <huang.chong@zte.com.cn>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "drivers/virtio/virtio_balloon.c||drivers/virtio/virtio_balloon.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/virtio/virtio_balloon.c||drivers/virtio/virtio_balloon.c": [
          "File: drivers/virtio/virtio_balloon.c -> drivers/virtio/virtio_balloon.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "513:  tell_host(vb, vb->inflate_vq);",
          "516:  balloon_page_delete(page);",
          "517:  vb->num_pfns = VIRTIO_BALLOON_PAGES_PER_PAGE;",
          "518:  set_page_pfns(vb, vb->pfns, page);",
          "519:  tell_host(vb, vb->deflate_vq);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "516:  spin_lock_irqsave(&vb_dev_info->pages_lock, flags);",
          "518:  spin_unlock_irqrestore(&vb_dev_info->pages_lock, flags);",
          "",
          "---------------"
        ]
      }
    }
  ]
}