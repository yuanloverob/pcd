{
  "cve_id": "CVE-2013-4541",
  "cve_desc": "The usb_device_post_load function in hw/usb/bus.c in QEMU before 1.7.2 might allow remote attackers to execute arbitrary code via a crafted savevm image, related to a negative setup_len or setup_index value.",
  "repo": "qemu/qemu",
  "patch_hash": "9f8e9895c504149d7048e9fc5eb5cbb34b16e49a",
  "patch_info": {
    "commit_hash": "9f8e9895c504149d7048e9fc5eb5cbb34b16e49a",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/9f8e9895c504149d7048e9fc5eb5cbb34b16e49a",
    "files": [
      "hw/usb/bus.c"
    ],
    "message": "usb: sanity check setup_index+setup_len in post_load\n\nCVE-2013-4541\n\ns->setup_len and s->setup_index are fed into usb_packet_copy as\nsize/offset into s->data_buf, it's possible for invalid state to exploit\nthis to load arbitrary data.\n\nsetup_len and setup_index should be checked to make sure\nthey are not negative.\n\nCc: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
    "before_after_code_files": [
      "hw/usb/bus.c||hw/usb/bus.c"
    ]
  },
  "patch_diff": {
    "hw/usb/bus.c||hw/usb/bus.c": [
      "File: hw/usb/bus.c -> hw/usb/bus.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "49:     } else {",
      "50:         dev->attached = 1;",
      "51:     }",
      "53:         dev->setup_len >= sizeof(dev->data_buf)) {",
      "54:         return -EINVAL;",
      "55:     }",
      "",
      "[Removed Lines]",
      "52:     if (dev->setup_index >= sizeof(dev->data_buf) ||",
      "",
      "[Added Lines]",
      "52:     if (dev->setup_index < 0 ||",
      "53:         dev->setup_len < 0 ||",
      "54:         dev->setup_index >= sizeof(dev->data_buf) ||",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c4bd2e4cb0550fd83321029b9ae7582073fcac67",
      "candidate_info": {
        "commit_hash": "c4bd2e4cb0550fd83321029b9ae7582073fcac67",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/c4bd2e4cb0550fd83321029b9ae7582073fcac67",
        "files": [
          "hw/usb/bus.c"
        ],
        "message": "usb: sanity check setup_index+setup_len in post_load\n\nCVE-2013-4541\n\ns->setup_len and s->setup_index are fed into usb_packet_copy as\nsize/offset into s->data_buf, it's possible for invalid state to exploit\nthis to load arbitrary data.\n\nsetup_len and setup_index should be checked to make sure\nthey are not negative.\n\nCc: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 9f8e9895c504149d7048e9fc5eb5cbb34b16e49a)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/usb/bus.c||hw/usb/bus.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ],
          "candidate": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/bus.c||hw/usb/bus.c": [
          "File: hw/usb/bus.c -> hw/usb/bus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     } else {",
          "48:         dev->attached = 1;",
          "49:     }",
          "51:         dev->setup_len >= sizeof(dev->data_buf)) {",
          "52:         return -EINVAL;",
          "53:     }",
          "",
          "[Removed Lines]",
          "50:     if (dev->setup_index >= sizeof(dev->data_buf) ||",
          "",
          "[Added Lines]",
          "50:     if (dev->setup_index < 0 ||",
          "51:         dev->setup_len < 0 ||",
          "52:         dev->setup_index >= sizeof(dev->data_buf) ||",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "15c35dfd9299733e5391b65efd3e0356a01d01ad",
      "candidate_info": {
        "commit_hash": "15c35dfd9299733e5391b65efd3e0356a01d01ad",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/15c35dfd9299733e5391b65efd3e0356a01d01ad",
        "files": [
          "hw/usb/bus.c"
        ],
        "message": "usb: sanity check setup_index+setup_len in post_load\n\nCVE-2013-4541\n\ns->setup_len and s->setup_index are fed into usb_packet_copy as\nsize/offset into s->data_buf, it's possible for invalid state to exploit\nthis to load arbitrary data.\n\nsetup_len and setup_index should be checked to make sure\nthey are not negative.\n\nCc: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Gerd Hoffmann <kraxel@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 9f8e9895c504149d7048e9fc5eb5cbb34b16e49a)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/usb/bus.c||hw/usb/bus.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ],
          "candidate": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/bus.c||hw/usb/bus.c": [
          "File: hw/usb/bus.c -> hw/usb/bus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     } else {",
          "50:         dev->attached = 1;",
          "51:     }",
          "53:         dev->setup_len >= sizeof(dev->data_buf)) {",
          "54:         return -EINVAL;",
          "55:     }",
          "",
          "[Removed Lines]",
          "52:     if (dev->setup_index >= sizeof(dev->data_buf) ||",
          "",
          "[Added Lines]",
          "52:     if (dev->setup_index < 0 ||",
          "53:         dev->setup_len < 0 ||",
          "54:         dev->setup_index >= sizeof(dev->data_buf) ||",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c60174e847082ab9f70720f86509a3353f816fad",
      "candidate_info": {
        "commit_hash": "c60174e847082ab9f70720f86509a3353f816fad",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/c60174e847082ab9f70720f86509a3353f816fad",
        "files": [
          "hw/usb/bus.c"
        ],
        "message": "usb: sanity check setup_index+setup_len in post_load\n\nSigned-off-by: Gerd Hoffmann <kraxel@redhat.com>",
        "before_after_code_files": [
          "hw/usb/bus.c||hw/usb/bus.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ],
          "candidate": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/bus.c||hw/usb/bus.c": [
          "File: hw/usb/bus.c -> hw/usb/bus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     } else {",
          "48:         dev->attached = 1;",
          "49:     }",
          "50:     return 0;",
          "51: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50:     if (dev->setup_index >= sizeof(dev->data_buf) ||",
          "51:         dev->setup_len >= sizeof(dev->data_buf)) {",
          "52:         return -EINVAL;",
          "53:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "719ffe1f5f72b1c7ace4afe9ba2815bcb53a829e",
      "candidate_info": {
        "commit_hash": "719ffe1f5f72b1c7ace4afe9ba2815bcb53a829e",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/719ffe1f5f72b1c7ace4afe9ba2815bcb53a829e",
        "files": [
          "hw/usb/bus.c"
        ],
        "message": "usb: fix up post load checks\n\nCorrect post load checks:\n1. dev->setup_len == sizeof(dev->data_buf)\n    seems fine, no need to fail migration\n2. When state is DATA, passing index > len\n   will cause memcpy with negative length,\n   resulting in heap overflow\n\nFirst of the issues was reported by dgilbert.\n\nReported-by: \"Dr. David Alan Gilbert\" <dgilbert@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
        "before_after_code_files": [
          "hw/usb/bus.c||hw/usb/bus.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ],
          "candidate": [
            "hw/usb/bus.c||hw/usb/bus.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/bus.c||hw/usb/bus.c": [
          "File: hw/usb/bus.c -> hw/usb/bus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     }",
          "52:     if (dev->setup_index < 0 ||",
          "53:         dev->setup_len < 0 ||",
          "56:         return -EINVAL;",
          "57:     }",
          "58:     return 0;",
          "",
          "[Removed Lines]",
          "54:         dev->setup_index >= sizeof(dev->data_buf) ||",
          "55:         dev->setup_len >= sizeof(dev->data_buf)) {",
          "",
          "[Added Lines]",
          "54:         dev->setup_index > dev->setup_len ||",
          "55:         dev->setup_len > sizeof(dev->data_buf)) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}