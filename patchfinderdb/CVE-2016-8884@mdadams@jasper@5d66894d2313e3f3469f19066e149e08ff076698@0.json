{
  "cve_id": "CVE-2016-8884",
  "cve_desc": "The bmp_getdata function in libjasper/bmp/bmp_dec.c in JasPer 1.900.5 allows remote attackers to cause a denial of service (NULL pointer dereference) by calling the imginfo command with a crafted BMP image. NOTE: this vulnerability exists because of an incomplete fix for CVE-2016-8690.",
  "repo": "mdadams/jasper",
  "patch_hash": "5d66894d2313e3f3469f19066e149e08ff076698",
  "patch_info": {
    "commit_hash": "5d66894d2313e3f3469f19066e149e08ff076698",
    "repo": "mdadams/jasper",
    "commit_url": "https://github.com/mdadams/jasper/commit/5d66894d2313e3f3469f19066e149e08ff076698",
    "files": [
      "src/libjasper/base/jas_seq.c",
      "src/libjasper/bmp/bmp_dec.c"
    ],
    "message": "Fixed a problem with a null pointer dereference in the BMP decoder.",
    "before_after_code_files": [
      "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c",
      "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c"
    ]
  },
  "patch_diff": {
    "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c": [
      "File: src/libjasper/base/jas_seq.c -> src/libjasper/base/jas_seq.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "102:  jas_matrix_t *matrix;",
      "103:  int i;",
      "105:  if (!(matrix = jas_malloc(sizeof(jas_matrix_t)))) {",
      "106:   return 0;",
      "107:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "105:  if (numrows < 0 || numcols < 0) {",
      "106:   return 0;",
      "107:  }",
      "",
      "---------------"
    ],
    "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c": [
      "File: src/libjasper/bmp/bmp_dec.c -> src/libjasper/bmp/bmp_dec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "107:  uint_fast16_t numcmpts;",
      "108:  long n;",
      "110:  if (optstr) {",
      "111:   jas_eprintf(\"warning: ignoring BMP decoder options\\n\");",
      "112:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "110:  image = 0;",
      "111:  info = 0;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "122:  if (bmp_gethdr(in, &hdr)) {",
      "123:   jas_eprintf(\"cannot get header\\n\");",
      "125:  }",
      "126:  JAS_DBGLOG(1, (",
      "127:    \"BMP header: magic 0x%x; siz %d; res1 %d; res2 %d; off %d\\n\",",
      "",
      "[Removed Lines]",
      "124:   return 0;",
      "",
      "[Added Lines]",
      "127:   goto error;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "132:  if (!(info = bmp_getinfo(in))) {",
      "133:   jas_eprintf(\"cannot get info\\n\");",
      "135:  }",
      "136:  JAS_DBGLOG(1,",
      "144:  if (!bmp_issupported(&hdr, info)) {",
      "145:   jas_eprintf(\"error: unsupported BMP encoding\\n\");",
      "148:  }",
      "152:  if ((n = hdr.off - (BMP_HDRLEN + BMP_INFOLEN + BMP_PALLEN(info))) < 0) {",
      "153:   jas_eprintf(\"error: possibly bad bitmap offset?\\n\");",
      "155:  }",
      "156:  if (n > 0) {",
      "157:   jas_eprintf(\"skipping unknown data in BMP file\\n\");",
      "158:   if (bmp_gobble(in, n)) {",
      "161:   }",
      "162:  }",
      "",
      "[Removed Lines]",
      "134:   return 0;",
      "137:    (\"BMP information: len %d; width %d; height %d; numplanes %d; \"",
      "138:    \"depth %d; enctype %d; siz %d; hres %d; vres %d; numcolors %d; \"",
      "139:    \"mincolors %d\\n\", info->len, info->width, info->height, info->numplanes,",
      "140:    info->depth, info->enctype, info->siz, info->hres, info->vres,",
      "141:    info->numcolors, info->mincolors));",
      "146:   bmp_info_destroy(info);",
      "147:   return 0;",
      "154:   return 0;",
      "159:    bmp_info_destroy(info);",
      "160:    return 0;",
      "",
      "[Added Lines]",
      "139:   goto error;",
      "142:    (\"BMP information: len %ld; width %ld; height %ld; numplanes %d; \"",
      "143:    \"depth %d; enctype %ld; siz %ld; hres %ld; vres %ld; numcolors %ld; \"",
      "144:    \"mincolors %ld\\n\", JAS_CAST(long, info->len),",
      "145:    JAS_CAST(long, info->width), JAS_CAST(long, info->height),",
      "146:    JAS_CAST(long, info->numplanes), JAS_CAST(long, info->depth),",
      "147:    JAS_CAST(long, info->enctype), JAS_CAST(long, info->siz),",
      "148:    JAS_CAST(long, info->hres), JAS_CAST(long, info->vres),",
      "149:    JAS_CAST(long, info->numcolors), JAS_CAST(long, info->mincolors)));",
      "151:  if (info->width < 0 || info->height < 0 || info->numplanes < 0 ||",
      "152:    info->depth < 0 || info->siz < 0 || info->hres < 0 || info->vres < 0) {",
      "153:   jas_eprintf(\"corrupt bit stream\\n\");",
      "154:   goto error;",
      "155:  }",
      "162:   goto error;",
      "169:   goto error;",
      "177:    goto error;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "180:  if (!(image = jas_image_create(numcmpts, cmptparms,",
      "181:    JAS_CLRSPC_UNKNOWN))) {",
      "184:  }",
      "186:  if (numcmpts == 3) {",
      "",
      "[Removed Lines]",
      "182:   bmp_info_destroy(info);",
      "183:   return 0;",
      "",
      "[Added Lines]",
      "201:   goto error;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "201:  if (bmp_getdata(in, info, image)) {",
      "205:  }",
      "207:  bmp_info_destroy(info);",
      "209:  return image;",
      "210: }",
      "212: int bmp_validate(jas_stream_t *in)",
      "",
      "[Removed Lines]",
      "202:   bmp_info_destroy(info);",
      "203:   jas_image_destroy(image);",
      "204:   return 0;",
      "",
      "[Added Lines]",
      "223:   goto error;",
      "230: error:",
      "231:  if (info) {",
      "232:   bmp_info_destroy(info);",
      "233:  }",
      "234:  if (image) {",
      "235:   jas_image_destroy(image);",
      "236:  }",
      "237:  return 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "988f8365f7d8ad8073b6786e433d34c553ecf568",
      "candidate_info": {
        "commit_hash": "988f8365f7d8ad8073b6786e433d34c553ecf568",
        "repo": "mdadams/jasper",
        "commit_url": "https://github.com/mdadams/jasper/commit/988f8365f7d8ad8073b6786e433d34c553ecf568",
        "files": [
          "src/libjasper/base/jas_malloc.c",
          "src/libjasper/base/jas_seq.c"
        ],
        "message": "Fixed an integer overflow problem.",
        "before_after_code_files": [
          "src/libjasper/base/jas_malloc.c||src/libjasper/base/jas_malloc.c",
          "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c"
          ],
          "candidate": [
            "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c"
          ]
        }
      },
      "candidate_diff": {
        "src/libjasper/base/jas_malloc.c||src/libjasper/base/jas_malloc.c": [
          "File: src/libjasper/base/jas_malloc.c -> src/libjasper/base/jas_malloc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "238: void *jas_malloc(size_t size)",
          "239: {",
          "240:  void *result;",
          "242:  result = malloc(size);",
          "243:  JAS_DBGLOG(100, (\"jas_malloc(%zu) -> %p\\n\", size, result));",
          "244:  return result;",
          "",
          "[Removed Lines]",
          "241:  JAS_DBGLOG(101, (\"jas_malloc called with %zu\\n\", size));",
          "",
          "[Added Lines]",
          "241:  JAS_DBGLOG(101, (\"jas_malloc(%zu)\\n\", size));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "247: void *jas_realloc(void *ptr, size_t size)",
          "248: {",
          "249:  void *result;",
          "251:  result = realloc(ptr, size);",
          "252:  JAS_DBGLOG(100, (\"jas_realloc(%p, %zu) -> %p\\n\", ptr, size, result));",
          "253:  return result;",
          "",
          "[Removed Lines]",
          "250:  JAS_DBGLOG(101, (\"jas_realloc called with %x,%zu\\n\", ptr, size));",
          "",
          "[Added Lines]",
          "250:  JAS_DBGLOG(101, (\"jas_realloc(%x, %zu)\\n\", ptr, size));",
          "",
          "---------------"
        ],
        "src/libjasper/base/jas_seq.c||src/libjasper/base/jas_seq.c": [
          "File: src/libjasper/base/jas_seq.c -> src/libjasper/base/jas_seq.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "101: {",
          "102:  jas_matrix_t *matrix;",
          "103:  int i;",
          "105:  if (numrows < 0 || numcols < 0) {",
          "107:  }",
          "109:  if (!(matrix = jas_malloc(sizeof(jas_matrix_t)))) {",
          "111:  }",
          "112:  matrix->flags_ = 0;",
          "113:  matrix->numrows_ = numrows;",
          "",
          "[Removed Lines]",
          "106:   return 0;",
          "110:   return 0;",
          "",
          "[Added Lines]",
          "104:  size_t size;",
          "106:  matrix = 0;",
          "109:   goto error;",
          "113:   goto error;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "115:  matrix->rows_ = 0;",
          "116:  matrix->maxrows_ = numrows;",
          "117:  matrix->data_ = 0;",
          "120:  if (matrix->maxrows_ > 0) {",
          "121:   if (!(matrix->rows_ = jas_alloc2(matrix->maxrows_,",
          "122:     sizeof(jas_seqent_t *)))) {",
          "125:   }",
          "126:  }",
          "128:  if (matrix->datasize_ > 0) {",
          "129:   if (!(matrix->data_ = jas_alloc2(matrix->datasize_,",
          "130:     sizeof(jas_seqent_t)))) {",
          "133:   }",
          "134:  }",
          "",
          "[Removed Lines]",
          "118:  matrix->datasize_ = numrows * numcols;",
          "123:    jas_matrix_destroy(matrix);",
          "124:    return 0;",
          "131:    jas_matrix_destroy(matrix);",
          "132:    return 0;",
          "",
          "[Added Lines]",
          "121:  matrix->datasize_ = 0;",
          "124:  if (!jas_safe_size_mul(numrows, numcols, &size)) {",
          "125:   goto error;",
          "126:  }",
          "127:  matrix->datasize_ = size;",
          "132:    goto error;",
          "139:    goto error;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "147:  matrix->yend_ = matrix->numrows_;",
          "149:  return matrix;",
          "150: }",
          "152: void jas_matrix_destroy(jas_matrix_t *matrix)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "158: error:",
          "159:  if (matrix) {",
          "160:   jas_matrix_destroy(matrix);",
          "161:  }",
          "162:  return 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8f62b4761711d036fd8964df256b938c809b7fca",
      "candidate_info": {
        "commit_hash": "8f62b4761711d036fd8964df256b938c809b7fca",
        "repo": "mdadams/jasper",
        "commit_url": "https://github.com/mdadams/jasper/commit/8f62b4761711d036fd8964df256b938c809b7fca",
        "files": [
          "src/appl/imginfo.c",
          "src/libjasper/bmp/bmp_dec.c"
        ],
        "message": "Fixed a sanitizer failure in the BMP codec. Also, added a --debug-level command line option to the imginfo command for debugging purposes.",
        "before_after_code_files": [
          "src/appl/imginfo.c||src/appl/imginfo.c",
          "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c"
          ],
          "candidate": [
            "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c"
          ]
        }
      },
      "candidate_diff": {
        "src/appl/imginfo.c||src/appl/imginfo.c": [
          "File: src/appl/imginfo.c -> src/appl/imginfo.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "85:  OPT_HELP,",
          "86:  OPT_VERSION,",
          "87:  OPT_VERBOSE,",
          "89: } optid_t;",
          "",
          "[Removed Lines]",
          "88:  OPT_INFILE",
          "",
          "[Added Lines]",
          "88:  OPT_INFILE,",
          "89:  OPT_DEBUG",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "104:  {OPT_VERSION, \"version\", 0},",
          "105:  {OPT_VERBOSE, \"verbose\", 0},",
          "106:  {OPT_INFILE, \"f\", JAS_OPT_HASARG},",
          "107:  {-1, 0, 0}",
          "108: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:  {OPT_DEBUG, \"debug-level\", JAS_OPT_HASARG},",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "126:  int numcmpts;",
          "127:  int verbose;",
          "128:  char *fmtname;",
          "130:  if (jas_init()) {",
          "131:   abort();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "131:  int debug;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "136:  infile = 0;",
          "137:  verbose = 0;",
          "140:  while ((id = jas_getopt(argc, argv, opts)) >= 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "141:  debug = 0;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "146:    printf(\"%s\\n\", JAS_VERSION);",
          "147:    exit(EXIT_SUCCESS);",
          "148:    break;",
          "149:   case OPT_INFILE:",
          "150:    infile = jas_optarg;",
          "151:    break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "153:   case OPT_DEBUG:",
          "154:    debug = atoi(jas_optarg);",
          "155:    break;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "156:   }",
          "157:  }",
          "160:  if (infile) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "166:  jas_setdbglevel(debug);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "179:  if (!(image = jas_image_decode(instream, fmtid, 0))) {",
          "180:   fprintf(stderr, \"cannot load image\\n\");",
          "181:   return EXIT_FAILURE;",
          "182:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "189:   jas_stream_close(instream);",
          "",
          "---------------"
        ],
        "src/libjasper/bmp/bmp_dec.c||src/libjasper/bmp/bmp_dec.c": [
          "File: src/libjasper/bmp/bmp_dec.c -> src/libjasper/bmp/bmp_dec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "77: #include \"jasper/jas_stream.h\"",
          "78: #include \"jasper/jas_image.h\"",
          "79: #include \"jasper/jas_malloc.h\"",
          "81: #include \"bmp_cod.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "80: #include \"jasper/jas_debug.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "122:   jas_eprintf(\"cannot get header\\n\");",
          "123:   return 0;",
          "124:  }",
          "127:  if (!(info = bmp_getinfo(in))) {",
          "128:   jas_eprintf(\"cannot get info\\n\");",
          "129:   return 0;",
          "130:  }",
          "133:  if (!bmp_issupported(&hdr, info)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:  JAS_DBGLOG(1, (",
          "127:    \"BMP header: magic 0x%x; siz %d; res1 %d; res2 %d; off %d\\n\",",
          "128:    hdr.magic, hdr.siz, hdr.reserved1, hdr.reserved2, hdr.off",
          "129:    ));",
          "136:  JAS_DBGLOG(1,",
          "137:    (\"BMP information: len %d; width %d; height %d; numplanes %d; \"",
          "138:    \"depth %d; enctype %d; siz %d; hres %d; vres %d; numcolors %d; \"",
          "139:    \"mincolors %d\\n\", info->len, info->width, info->height, info->numplanes,",
          "140:    info->depth, info->enctype, info->siz, info->hres, info->vres,",
          "141:    info->numcolors, info->mincolors));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "440:   if ((c = jas_stream_getc(in)) == EOF) {",
          "441:    return -1;",
          "442:   }",
          "444:   if (--n <= 0) {",
          "445:    break;",
          "446:   }",
          "",
          "[Removed Lines]",
          "443:   v |= (c << 24);",
          "",
          "[Added Lines]",
          "454:   v |= (JAS_CAST(uint_fast32_t, c) << 24);",
          "",
          "---------------"
        ]
      }
    }
  ]
}