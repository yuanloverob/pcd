{
  "cve_id": "CVE-2020-1900",
  "cve_desc": "When unserializing an object with dynamic properties HHVM needs to pre-reserve the full size of the dynamic property array before inserting anything into it. Otherwise the array might resize, invalidating previously stored references. This pre-reservation was not occurring in HHVM prior to v4.32.3, between versions 4.33.0 and 4.56.0, 4.57.0, 4.58.0, 4.58.1, 4.59.0, 4.60.0, 4.61.0, 4.62.0.",
  "repo": "facebook/hhvm",
  "patch_hash": "c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
  "patch_info": {
    "commit_hash": "c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
    "files": [
      "hphp/runtime/base/object-data.cpp",
      "hphp/runtime/base/variable-unserializer.cpp"
    ],
    "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
    "before_after_code_files": [
      "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
      "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
    ]
  },
  "patch_diff": {
    "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
      "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "342:     return dynPropArray();",
      "343:   }",
      "345:   return setDynPropArray(",
      "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
      "347:   );",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
      "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
      "347:     check_non_safepoint_surprise();",
      "348:   }",
      "",
      "---------------"
    ],
    "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
      "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "555:     t = obj->makeDynProp(realKey.get());",
      "556:   } else {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "555:     obj->reserveDynProps(nProp);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bcb380e61a68d2529d3224fef41607a10cd31075",
      "candidate_info": {
        "commit_hash": "bcb380e61a68d2529d3224fef41607a10cd31075",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/bcb380e61a68d2529d3224fef41607a10cd31075",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "322:     return dynPropArray();",
          "323:   }",
          "325:   return setDynPropArray(",
          "326:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "327:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "325:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "326:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "327:     check_non_safepoint_surprise();",
          "328:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b4e260d5a2ad757b105b6fd6d87646052cf2bab9",
      "candidate_info": {
        "commit_hash": "b4e260d5a2ad757b105b6fd6d87646052cf2bab9",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/b4e260d5a2ad757b105b6fd6d87646052cf2bab9",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "324:     return dynPropArray();",
          "325:   }",
          "327:   return setDynPropArray(",
          "328:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "329:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "327:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "328:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "329:     check_non_safepoint_surprise();",
          "330:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b975f3552b505589cbfe2b97a6b8969a3ef31f6a",
      "candidate_info": {
        "commit_hash": "b975f3552b505589cbfe2b97a6b8969a3ef31f6a",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/b975f3552b505589cbfe2b97a6b8969a3ef31f6a",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:     return dynPropArray();",
          "343:   }",
          "345:   return setDynPropArray(",
          "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "347:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "347:     check_non_safepoint_surprise();",
          "348:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "108a0e6a2f1d5cc5b0cf383a246e819866955a43",
      "candidate_info": {
        "commit_hash": "108a0e6a2f1d5cc5b0cf383a246e819866955a43",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/108a0e6a2f1d5cc5b0cf383a246e819866955a43",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:     return dynPropArray();",
          "343:   }",
          "345:   return setDynPropArray(",
          "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "347:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "347:     check_non_safepoint_surprise();",
          "348:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "555:     t = obj->makeDynProp(realKey.get());",
          "556:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "555:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1ceea93e1aa6d224d3a4476e8813fb2b8a94daae",
      "candidate_info": {
        "commit_hash": "1ceea93e1aa6d224d3a4476e8813fb2b8a94daae",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/1ceea93e1aa6d224d3a4476e8813fb2b8a94daae",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:     return dynPropArray();",
          "343:   }",
          "345:   return setDynPropArray(",
          "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "347:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "347:     check_non_safepoint_surprise();",
          "348:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    }
  ]
}