{
  "cve_id": "CVE-2013-7026",
  "cve_desc": "Multiple race conditions in ipc/shm.c in the Linux kernel before 3.12.2 allow local users to cause a denial of service (use-after-free and system crash) or possibly have unspecified other impact via a crafted application that uses shmctl IPC_RMID operations in conjunction with other shm system calls.",
  "repo": "torvalds/linux",
  "patch_hash": "a399b29dfbaaaf91162b2dc5a5875dd51bbfa2a1",
  "patch_info": {
    "commit_hash": "a399b29dfbaaaf91162b2dc5a5875dd51bbfa2a1",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/a399b29dfbaaaf91162b2dc5a5875dd51bbfa2a1",
    "files": [
      "ipc/shm.c"
    ],
    "message": "ipc,shm: fix shm_file deletion races\n\nWhen IPC_RMID races with other shm operations there's potential for\nuse-after-free of the shm object's associated file (shm_file).\n\nHere's the race before this patch:\n\n  TASK 1                     TASK 2\n  ------                     ------\n  shm_rmid()\n    ipc_lock_object()\n                             shmctl()\n                             shp = shm_obtain_object_check()\n\n    shm_destroy()\n      shum_unlock()\n      fput(shp->shm_file)\n                             ipc_lock_object()\n                             shmem_lock(shp->shm_file)\n                             <OOPS>\n\nThe oops is caused because shm_destroy() calls fput() after dropping the\nipc_lock.  fput() clears the file's f_inode, f_path.dentry, and\nf_path.mnt, which causes various NULL pointer references in task 2.  I\nreliably see the oops in task 2 if with shmlock, shmu\n\nThis patch fixes the races by:\n1) set shm_file=NULL in shm_destroy() while holding ipc_object_lock().\n2) modify at risk operations to check shm_file while holding\n   ipc_object_lock().\n\nExample workloads, which each trigger oops...\n\nWorkload 1:\n  while true; do\n    id=$(shmget 1 4096)\n    shm_rmid $id &\n    shmlock $id &\n    wait\n  done\n\n  The oops stack shows accessing NULL f_inode due to racing fput:\n    _raw_spin_lock\n    shmem_lock\n    SyS_shmctl\n\nWorkload 2:\n  while true; do\n    id=$(shmget 1 4096)\n    shmat $id 4096 &\n    shm_rmid $id &\n    wait\n  done\n\n  The oops stack is similar to workload 1 due to NULL f_inode:\n    touch_atime\n    shmem_mmap\n    shm_mmap\n    mmap_region\n    do_mmap_pgoff\n    do_shmat\n    SyS_shmat\n\nWorkload 3:\n  while true; do\n    id=$(shmget 1 4096)\n    shmlock $id\n    shm_rmid $id &\n    shmunlock $id &\n    wait\n  done\n\n  The oops stack shows second fput tripping on an NULL f_inode.  The\n  first fput() completed via from shm_destroy(), but a racing thread did\n  a get_file() and queued this fput():\n    locks_remove_flock\n    __fput\n    ____fput\n    task_work_run\n    do_notify_resume\n    int_signal\n\nFixes: c2c737a0461e (\"ipc,shm: shorten critical region for shmat\")\nFixes: 2caacaa82a51 (\"ipc,shm: shorten critical region for shmctl\")\nSigned-off-by: Greg Thelen <gthelen@google.com>\nCc: Davidlohr Bueso <davidlohr@hp.com>\nCc: Rik van Riel <riel@redhat.com>\nCc: Manfred Spraul <manfred@colorfullife.com>\nCc: <stable@vger.kernel.org>  # 3.10.17+ 3.11.6+\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "before_after_code_files": [
      "ipc/shm.c||ipc/shm.c"
    ]
  },
  "patch_diff": {
    "ipc/shm.c||ipc/shm.c": [
      "File: ipc/shm.c -> ipc/shm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "209: static void shm_destroy(struct ipc_namespace *ns, struct shmid_kernel *shp)",
      "210: {",
      "211:  ns->shm_tot -= (shp->shm_segsz + PAGE_SIZE - 1) >> PAGE_SHIFT;",
      "212:  shm_rmid(ns, shp);",
      "213:  shm_unlock(shp);",
      "216:  else if (shp->mlock_user)",
      "220:  ipc_rcu_putref(shp, shm_rcu_free);",
      "221: }",
      "",
      "[Removed Lines]",
      "214:  if (!is_file_hugepages(shp->shm_file))",
      "215:   shmem_lock(shp->shm_file, 0, shp->mlock_user);",
      "217:   user_shm_unlock(file_inode(shp->shm_file)->i_size,",
      "218:       shp->mlock_user);",
      "219:  fput (shp->shm_file);",
      "",
      "[Added Lines]",
      "211:  struct file *shm_file;",
      "213:  shm_file = shp->shm_file;",
      "214:  shp->shm_file = NULL;",
      "218:  if (!is_file_hugepages(shm_file))",
      "219:   shmem_lock(shm_file, 0, shp->mlock_user);",
      "221:   user_shm_unlock(file_inode(shm_file)->i_size, shp->mlock_user);",
      "222:  fput(shm_file);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "983:   }",
      "985:   shm_file = shp->shm_file;",
      "986:   if (is_file_hugepages(shm_file))",
      "987:    goto out_unlock0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "991:   if (shm_file == NULL) {",
      "992:    err = -EIDRM;",
      "993:    goto out_unlock0;",
      "994:   }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1101:   goto out_unlock;",
      "1103:  ipc_lock_object(&shp->shm_perm);",
      "1104:  path = shp->shm_file->f_path;",
      "1105:  path_get(&path);",
      "1106:  shp->shm_nattch++;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1116:  if (shp->shm_file == NULL) {",
      "1117:   ipc_unlock_object(&shp->shm_perm);",
      "1118:   err = -EIDRM;",
      "1119:   goto out_unlock;",
      "1120:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f3d2b0135f4bdbfe47a99753923a64efd373d11",
      "candidate_info": {
        "commit_hash": "0f3d2b0135f4bdbfe47a99753923a64efd373d11",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/0f3d2b0135f4bdbfe47a99753923a64efd373d11",
        "files": [
          "ipc/msg.c",
          "ipc/sem.c",
          "ipc/shm.c",
          "ipc/util.h"
        ],
        "message": "ipc: introduce ipc_valid_object() helper to sort out IPC_RMID races\n\nAfter the locking semantics for the SysV IPC API got improved, a couple\nof IPC_RMID race windows were opened because we ended up dropping the\n'kern_ipc_perm.deleted' check performed way down in ipc_lock().  The\nspotted races got sorted out by re-introducing the old test within the\nracy critical sections.\n\nThis patch introduces ipc_valid_object() to consolidate the way we cope\nwith IPC_RMID races by using the same abstraction across the API\nimplementation.\n\nSigned-off-by: Rafael Aquini <aquini@redhat.com>\nAcked-by: Rik van Riel <riel@redhat.com>\nAcked-by: Greg Thelen <gthelen@google.com>\nReviewed-by: Davidlohr Bueso <davidlohr@hp.com>\nCc: Manfred Spraul <manfred@colorfullife.com>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
        "before_after_code_files": [
          "ipc/msg.c||ipc/msg.c",
          "ipc/sem.c||ipc/sem.c",
          "ipc/shm.c||ipc/shm.c",
          "ipc/util.h||ipc/util.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ipc/shm.c||ipc/shm.c"
          ],
          "candidate": [
            "ipc/shm.c||ipc/shm.c"
          ]
        }
      },
      "candidate_diff": {
        "ipc/msg.c||ipc/msg.c": [
          "File: ipc/msg.c -> ipc/msg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "696:    goto out_unlock0;",
          "700:    err = -EIDRM;",
          "701:    goto out_unlock0;",
          "702:   }",
          "",
          "[Removed Lines]",
          "699:   if (msq->q_perm.deleted) {",
          "",
          "[Added Lines]",
          "699:   if (!ipc_valid_object(&msq->q_perm)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "731:   ipc_lock_object(&msq->q_perm);",
          "733:   ipc_rcu_putref(msq, ipc_rcu_free);",
          "735:    err = -EIDRM;",
          "736:    goto out_unlock0;",
          "737:   }",
          "",
          "[Removed Lines]",
          "734:   if (msq->q_perm.deleted) {",
          "",
          "[Added Lines]",
          "735:   if (!ipc_valid_object(&msq->q_perm)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "909:   ipc_lock_object(&msq->q_perm);",
          "913:    msg = ERR_PTR(-EIDRM);",
          "914:    goto out_unlock0;",
          "915:   }",
          "",
          "[Removed Lines]",
          "912:   if (msq->q_perm.deleted) {",
          "",
          "[Added Lines]",
          "913:   if (!ipc_valid_object(&msq->q_perm)) {",
          "",
          "---------------"
        ],
        "ipc/sem.c||ipc/sem.c": [
          "File: ipc/sem.c -> ipc/sem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1285:  sem_lock(sma, NULL, -1);",
          "1288:   sem_unlock(sma, -1);",
          "1289:   rcu_read_unlock();",
          "1290:   return -EIDRM;",
          "",
          "[Removed Lines]",
          "1287:  if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1287:  if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1344:   int i;",
          "1346:   sem_lock(sma, NULL, -1);",
          "1348:    err = -EIDRM;",
          "1349:    goto out_unlock;",
          "1350:   }",
          "",
          "[Removed Lines]",
          "1347:   if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1347:   if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1364:    rcu_read_lock();",
          "1365:    sem_lock_and_putref(sma);",
          "1367:     err = -EIDRM;",
          "1368:     goto out_unlock;",
          "1369:    }",
          "",
          "[Removed Lines]",
          "1366:    if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1366:    if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1411:   }",
          "1412:   rcu_read_lock();",
          "1413:   sem_lock_and_putref(sma);",
          "1415:    err = -EIDRM;",
          "1416:    goto out_unlock;",
          "1417:   }",
          "",
          "[Removed Lines]",
          "1414:   if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1414:   if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1437:   goto out_rcu_wakeup;",
          "1439:  sem_lock(sma, NULL, -1);",
          "1441:   err = -EIDRM;",
          "1442:   goto out_unlock;",
          "1443:  }",
          "",
          "[Removed Lines]",
          "1440:  if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1440:  if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1702:  rcu_read_lock();",
          "1703:  sem_lock_and_putref(sma);",
          "1705:   sem_unlock(sma, -1);",
          "1706:   rcu_read_unlock();",
          "1707:   kfree(new);",
          "",
          "[Removed Lines]",
          "1704:  if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "1704:  if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1849:  error = -EIDRM;",
          "1850:  locknum = sem_lock(sma, sops, nsops);",
          "1852:   goto out_unlock_free;",
          "",
          "[Removed Lines]",
          "1851:  if (sma->sem_perm.deleted)",
          "",
          "[Added Lines]",
          "1859:  if (!ipc_valid_object(&sma->sem_perm))",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2071:   sem_lock(sma, NULL, -1);",
          "2074:    sem_unlock(sma, -1);",
          "2075:    rcu_read_unlock();",
          "2076:    continue;",
          "",
          "[Removed Lines]",
          "2073:   if (sma->sem_perm.deleted) {",
          "",
          "[Added Lines]",
          "2081:   if (!ipc_valid_object(&sma->sem_perm)) {",
          "",
          "---------------"
        ],
        "ipc/shm.c||ipc/shm.c": [
          "File: ipc/shm.c -> ipc/shm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "975:    goto out_unlock1;",
          "977:   ipc_lock_object(&shp->shm_perm);",
          "978:   if (!ns_capable(ns->user_ns, CAP_IPC_LOCK)) {",
          "979:    kuid_t euid = current_euid();",
          "980:    if (!uid_eq(euid, shp->shm_perm.uid) &&",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "980:   if (!ipc_valid_object(&shp->shm_perm)) {",
          "981:    err = -EIDRM;",
          "982:    goto out_unlock0;",
          "983:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "989:   }",
          "991:   shm_file = shp->shm_file;",
          "999:   if (is_file_hugepages(shm_file))",
          "1000:    goto out_unlock0;",
          "",
          "[Removed Lines]",
          "994:   if (shm_file == NULL) {",
          "995:    err = -EIDRM;",
          "996:    goto out_unlock0;",
          "997:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1116:  ipc_lock_object(&shp->shm_perm);",
          "1120:   ipc_unlock_object(&shp->shm_perm);",
          "1121:   err = -EIDRM;",
          "1122:   goto out_unlock;",
          "",
          "[Removed Lines]",
          "1119:  if (shp->shm_file == NULL) {",
          "",
          "[Added Lines]",
          "1119:  if (!ipc_valid_object(&shp->shm_perm)) {",
          "",
          "---------------"
        ],
        "ipc/util.h||ipc/util.h": [
          "File: ipc/util.h -> ipc/util.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "185:  rcu_read_unlock();",
          "186: }",
          "188: struct kern_ipc_perm *ipc_obtain_object_check(struct ipc_ids *ids, int id);",
          "189: int ipcget(struct ipc_namespace *ns, struct ipc_ids *ids,",
          "190:    struct ipc_ops *ops, struct ipc_params *params);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "196: static inline bool ipc_valid_object(struct kern_ipc_perm *perm)",
          "197: {",
          "198:  return perm->deleted == 0;",
          "199: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}