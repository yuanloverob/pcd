{
  "cve_id": "CVE-2017-6467",
  "cve_desc": "In Wireshark 2.2.0 to 2.2.4 and 2.0.0 to 2.0.10, there is a Netscaler file parser infinite loop, triggered by a malformed capture file. This was addressed in wiretap/netscaler.c by changing the restrictions on file size.",
  "repo": "wireshark/wireshark",
  "patch_hash": "875d95ea605758308fc2369d83a41a34a6adbe53",
  "patch_info": {
    "commit_hash": "875d95ea605758308fc2369d83a41a34a6adbe53",
    "repo": "wireshark/wireshark",
    "commit_url": "https://github.com/wireshark/wireshark/commit/875d95ea605758308fc2369d83a41a34a6adbe53",
    "files": [
      "wiretap/netscaler.c"
    ],
    "message": "nstrace: Allow opening of files that are not multiples of 16kB in size.\n\nWireshark/Tshark hangs when netscaler trace file smaller than 16KB is opened. \nIt also hangs when a gzipped trace file is opened. With this fix, \nFiles with sizes that are not multiple of 16KB and gzipped files can be opened.\n\nBug: 12083\nChange-Id: I26b2fc406edafcb2f1f6161d69064ba5662ddf29\nReviewed-on: https://code.wireshark.org/review/13721\nReviewed-by: Michael Mann <mmann78@netscape.net>",
    "before_after_code_files": [
      "wiretap/netscaler.c||wiretap/netscaler.c"
    ]
  },
  "patch_diff": {
    "wiretap/netscaler.c||wiretap/netscaler.c": [
      "File: wiretap/netscaler.c -> wiretap/netscaler.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1274:         }\\",
      "1275:         nst_dataSize = nspr_getv20recordsize(hdp);\\",
      "1276:         rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
      "1278:         ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE - 1)) : 0;\\",
      "1279:         while (nsg_nextPageOffset) {\\",
      "1281:                 nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
      "1282:             }\\",
      "1284:             nstrace->xxx_offset += nstrace_buflen;\\",
      "1285:             bytes_read = file_read(nstrace_buf, NSPR_PAGESIZE_TRACE, wth->fh);\\",
      "1286:             if ( !file_eof(wth->fh) && bytes_read != NSPR_PAGESIZE_TRACE) {\\",
      "1287:                 return FALSE;\\",
      "1288:             } else {\\",
      "1289:                 nstrace_buf_offset = 0;\\",
      "1290:             }\\",
      "1291:             rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
      "1293:             ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE- 1)): 0;\\",
      "1294:         } \\",
      "1295:         while (nstrace_tmpbuff_off < nst_dataSize) {\\",
      "",
      "[Removed Lines]",
      "1277:         nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
      "1280:             while (nstrace_buf_offset < NSPR_PAGESIZE_TRACE) {\\",
      "1283:             nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
      "1292:             nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
      "",
      "[Added Lines]",
      "1277:         nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= (guint)nstrace->nstrace_buflen) ?\\",
      "1280:             while (nstrace_buf_offset < nstrace->nstrace_buflen) {\\",
      "1284:             nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
      "1291:             nstrace_buflen = bytes_read;\\",
      "1293:             nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= (guint)nstrace->nstrace_buflen) ?\\",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1297:         }\\",
      "1298:         memcpy(ws_buffer_start_ptr(wth->frame_buffer), nstrace_tmpbuff, (phdr)->caplen);\\",
      "1299:         nstrace->nstrace_buf_offset = nstrace_buf_offset;\\",
      "1301:         nstrace->nsg_creltime = nsg_creltime;\\",
      "1302:         return TRUE;\\",
      "1303:     } while(0)",
      "",
      "[Removed Lines]",
      "1300:         nstrace->nstrace_buflen = nstrace_buflen = ((gint32)NSPR_PAGESIZE_TRACE);\\",
      "",
      "[Added Lines]",
      "1301:         nstrace->nstrace_buflen = nstrace_buflen;\\",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1315:     int bytes_read = 0;",
      "1319:     do",
      "1320:     {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1319:     if(nstrace_buflen == 0){",
      "1321:     }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1328:             nstrace_buf[nstrace_buf_offset])",
      "1329:         {",
      "1330:             hdp = (nspr_hd_v20_t *) &nstrace_buf[nstrace_buf_offset];",
      "1331:             switch (hdp->phd_RecordType)",
      "1332:             {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1335:             if(nspr_getv20recordsize(hdp) == 0){",
      "1338:               return FALSE;",
      "1339:             }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "284ad58d288722a8725401967bff0c4455488f0c",
      "candidate_info": {
        "commit_hash": "284ad58d288722a8725401967bff0c4455488f0c",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/284ad58d288722a8725401967bff0c4455488f0c",
        "files": [
          "wiretap/netscaler.c"
        ],
        "message": "nstrace: Allow opening of files that are not multiples of 16kB in size.\n\nWireshark/Tshark hangs when netscaler trace file smaller than 16KB is opened. \nIt also hangs when a gzipped trace file is opened. With this fix, \nFiles with sizes that are not multiple of 16KB and gzipped files can be opened.\n\nBug: 12083\nChange-Id: I26b2fc406edafcb2f1f6161d69064ba5662ddf29\nReviewed-on: https://code.wireshark.org/review/13721\nReviewed-by: Michael Mann <mmann78@netscape.net>\n(cherry picked from commit 875d95ea605758308fc2369d83a41a34a6adbe53)\nReviewed-on: https://code.wireshark.org/review/20328\nReviewed-by: Guy Harris <guy@alum.mit.edu>",
        "before_after_code_files": [
          "wiretap/netscaler.c||wiretap/netscaler.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "wiretap/netscaler.c||wiretap/netscaler.c"
          ],
          "candidate": [
            "wiretap/netscaler.c||wiretap/netscaler.c"
          ]
        }
      },
      "candidate_diff": {
        "wiretap/netscaler.c||wiretap/netscaler.c": [
          "File: wiretap/netscaler.c -> wiretap/netscaler.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1276:         }\\",
          "1277:         nst_dataSize = nspr_getv20recordsize(hdp);\\",
          "1278:         rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
          "1280:         ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE - 1)) : 0;\\",
          "1281:         while (nsg_nextPageOffset) {\\",
          "1283:                 nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1284:             }\\",
          "1286:             nstrace->xxx_offset += nstrace_buflen;\\",
          "1287:             bytes_read = file_read(nstrace_buf, NSPR_PAGESIZE_TRACE, wth->fh);\\",
          "1288:             if ( !file_eof(wth->fh) && bytes_read != NSPR_PAGESIZE_TRACE) {\\",
          "1289:                 return FALSE;\\",
          "1290:             } else {\\",
          "1291:                 nstrace_buf_offset = 0;\\",
          "1292:             }\\",
          "1293:             rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
          "1295:             ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE- 1)): 0;\\",
          "1296:         } \\",
          "1297:         while (nstrace_tmpbuff_off < nst_dataSize) {\\",
          "",
          "[Removed Lines]",
          "1279:         nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
          "1282:             while (nstrace_buf_offset < NSPR_PAGESIZE_TRACE) {\\",
          "1285:             nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
          "1294:             nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
          "",
          "[Added Lines]",
          "1279:         nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= (guint)nstrace->nstrace_buflen) ?\\",
          "1282:             while (nstrace_buf_offset < nstrace->nstrace_buflen) {\\",
          "1286:             nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
          "1293:             nstrace_buflen = bytes_read;\\",
          "1295:             nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= (guint)nstrace->nstrace_buflen) ?\\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1299:         }\\",
          "1300:         memcpy(ws_buffer_start_ptr(wth->frame_buffer), nstrace_tmpbuff, (phdr)->caplen);\\",
          "1301:         nstrace->nstrace_buf_offset = nstrace_buf_offset;\\",
          "1303:         nstrace->nsg_creltime = nsg_creltime;\\",
          "1304:         return TRUE;\\",
          "1305:     } while(0)",
          "",
          "[Removed Lines]",
          "1302:         nstrace->nstrace_buflen = nstrace_buflen = ((gint32)NSPR_PAGESIZE_TRACE);\\",
          "",
          "[Added Lines]",
          "1303:         nstrace->nstrace_buflen = nstrace_buflen;\\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1317:     int bytes_read = 0;",
          "1321:     do",
          "1322:     {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1321:     if(nstrace_buflen == 0){",
          "1323:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1330:             nstrace_buf[nstrace_buf_offset])",
          "1331:         {",
          "1332:             hdp = (nspr_hd_v20_t *) &nstrace_buf[nstrace_buf_offset];",
          "1333:             switch (hdp->phd_RecordType)",
          "1334:             {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1337:             if(nspr_getv20recordsize(hdp) == 0){",
          "1340:               return FALSE;",
          "1341:             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4b76a94ef9a6ca780d861a3eeb0d12230ef8c0c",
      "candidate_info": {
        "commit_hash": "c4b76a94ef9a6ca780d861a3eeb0d12230ef8c0c",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/c4b76a94ef9a6ca780d861a3eeb0d12230ef8c0c",
        "files": [
          "wiretap/netscaler.c"
        ],
        "message": "More indentation cleanups.\n\nChange-Id: Ia448727e6340723800d92097f0ef7f3582ef6340\nReviewed-on: https://code.wireshark.org/review/7359\nReviewed-by: Guy Harris <guy@alum.mit.edu>",
        "before_after_code_files": [
          "wiretap/netscaler.c||wiretap/netscaler.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "wiretap/netscaler.c||wiretap/netscaler.c"
          ],
          "candidate": [
            "wiretap/netscaler.c||wiretap/netscaler.c"
          ]
        }
      },
      "candidate_diff": {
        "wiretap/netscaler.c||wiretap/netscaler.c": [
          "File: wiretap/netscaler.c -> wiretap/netscaler.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1194: #define PACKET_DESCRIBE(phdr,FPTIMEDEF,SIZEDEF,ver,enumprefix,type,structname,TYPE)\\",
          "1195:     do {\\",
          "1213:             nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1214:         }\\",
          "1223:         rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
          "1224:         nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
          "1237: static gboolean nstrace_read_v30(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)",
          "1238: {",
          "",
          "[Removed Lines]",
          "1196:     nspr_##structname##_t *fp = (nspr_##structname##_t *) &nstrace_buf[nstrace_buf_offset];\\",
          "1197:     (phdr)->rec_type = REC_TYPE_PACKET;\\",
          "1198:     TIMEDEFV##ver(fp,type);\\",
          "1199:     SIZEDEF##ver((phdr),fp,ver);\\",
          "1200:     TRACE_V##ver##_REC_LEN_OFF((phdr),enumprefix,type,structname);\\",
          "1201:     (phdr)->pseudo_header.nstr.rec_type = NSPR_HEADER_VERSION##TYPE;\\",
          "1202:     ws_buffer_assure_space(wth->frame_buffer, (phdr)->caplen);\\",
          "1204:     while (nstrace_tmpbuff_off < nspr_##structname##_s) {\\",
          "1205:         nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1206:     }\\",
          "1207:     nst_dataSize = nspr_getv20recordsize(hdp);\\",
          "1208:     rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
          "1209:     nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
          "1210:     ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE - 1)) : 0;\\",
          "1211:     while (nsg_nextPageOffset) {\\",
          "1212:         while (nstrace_buf_offset < NSPR_PAGESIZE_TRACE) {\\",
          "1215:         nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
          "1216:         nstrace->xxx_offset += nstrace_buflen;\\",
          "1217:         bytes_read = file_read(nstrace_buf, NSPR_PAGESIZE_TRACE, wth->fh);\\",
          "1218:         if (bytes_read != NSPR_PAGESIZE_TRACE) {\\",
          "1219:             return FALSE;\\",
          "1220:         } else {\\",
          "1221:             nstrace_buf_offset = 0;\\",
          "1222:         }\\",
          "1225:         ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE- 1)): 0;\\",
          "1226:     } \\",
          "1227:     while (nstrace_tmpbuff_off < nst_dataSize) {\\",
          "1228:         nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1229:     }\\",
          "1230:     memcpy(ws_buffer_start_ptr(wth->frame_buffer), nstrace_tmpbuff, (phdr)->caplen);\\",
          "1231:     nstrace->nstrace_buf_offset = nstrace_buf_offset;\\",
          "1232:     nstrace->nstrace_buflen = nstrace_buflen = ((gint32)NSPR_PAGESIZE_TRACE);\\",
          "1233:     nstrace->nsg_creltime = nsg_creltime;\\",
          "1234:     return TRUE;\\",
          "1235: } while(0)",
          "",
          "[Added Lines]",
          "1196:         nspr_##structname##_t *fp = (nspr_##structname##_t *) &nstrace_buf[nstrace_buf_offset];\\",
          "1197:         (phdr)->rec_type = REC_TYPE_PACKET;\\",
          "1198:         TIMEDEFV##ver(fp,type);\\",
          "1199:         SIZEDEF##ver((phdr),fp,ver);\\",
          "1200:         TRACE_V##ver##_REC_LEN_OFF((phdr),enumprefix,type,structname);\\",
          "1201:         (phdr)->pseudo_header.nstr.rec_type = NSPR_HEADER_VERSION##TYPE;\\",
          "1202:         ws_buffer_assure_space(wth->frame_buffer, (phdr)->caplen);\\",
          "1204:         while (nstrace_tmpbuff_off < nspr_##structname##_s) {\\",
          "1207:         nst_dataSize = nspr_getv20recordsize(hdp);\\",
          "1210:         ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE - 1)) : 0;\\",
          "1211:         while (nsg_nextPageOffset) {\\",
          "1212:             while (nstrace_buf_offset < NSPR_PAGESIZE_TRACE) {\\",
          "1213:                 nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1214:             }\\",
          "1215:             nstrace_buflen = NSPR_PAGESIZE_TRACE;\\",
          "1216:             nstrace->xxx_offset += nstrace_buflen;\\",
          "1217:             bytes_read = file_read(nstrace_buf, NSPR_PAGESIZE_TRACE, wth->fh);\\",
          "1218:             if (bytes_read != NSPR_PAGESIZE_TRACE) {\\",
          "1219:                 return FALSE;\\",
          "1220:             } else {\\",
          "1221:                 nstrace_buf_offset = 0;\\",
          "1222:             }\\",
          "1223:             rec_size = nst_dataSize - nstrace_tmpbuff_off;\\",
          "1224:             nsg_nextPageOffset = ((nstrace_buf_offset + rec_size) >= NSPR_PAGESIZE_TRACE) ?\\",
          "1225:             ((nstrace_buf_offset + rec_size) - (NSPR_PAGESIZE_TRACE- 1)): 0;\\",
          "1226:         } \\",
          "1227:         while (nstrace_tmpbuff_off < nst_dataSize) {\\",
          "1228:             nstrace_tmpbuff[nstrace_tmpbuff_off++] = nstrace_buf[nstrace_buf_offset++];\\",
          "1229:         }\\",
          "1230:         memcpy(ws_buffer_start_ptr(wth->frame_buffer), nstrace_tmpbuff, (phdr)->caplen);\\",
          "1231:         nstrace->nstrace_buf_offset = nstrace_buf_offset;\\",
          "1232:         nstrace->nstrace_buflen = nstrace_buflen = ((gint32)NSPR_PAGESIZE_TRACE);\\",
          "1233:         nstrace->nsg_creltime = nsg_creltime;\\",
          "1234:         return TRUE;\\",
          "1235:     } while(0)",
          "",
          "---------------"
        ]
      }
    }
  ]
}