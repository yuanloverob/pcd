{
  "cve_id": "CVE-2016-9373",
  "cve_desc": "In Wireshark 2.2.0 to 2.2.1 and 2.0.0 to 2.0.7, the DCERPC dissector could crash with a use-after-free, triggered by network traffic or a capture file. This was addressed in epan/dissectors/packet-dcerpc-nt.c and epan/dissectors/packet-dcerpc-spoolss.c by using the wmem file scope for private strings.",
  "repo": "wireshark/wireshark",
  "patch_hash": "929ad3805fa31431c39de629e9b09e77e8152709",
  "patch_info": {
    "commit_hash": "929ad3805fa31431c39de629e9b09e77e8152709",
    "repo": "wireshark/wireshark",
    "commit_url": "https://github.com/wireshark/wireshark/commit/929ad3805fa31431c39de629e9b09e77e8152709",
    "files": [
      "epan/dissectors/packet-dcerpc-nt.c",
      "epan/dissectors/packet-dcerpc-spoolss.c"
    ],
    "message": "DCERPC: save strings in wmem file scope\n\nBug: 13072\nChange-Id: Ib5f3d91be822a3d7180d95e3299dec978941c1d5\nReviewed-on: https://code.wireshark.org/review/18564\nReviewed-by: Pascal Quantin <pascal.quantin@gmail.com>\nPetri-Dish: Pascal Quantin <pascal.quantin@gmail.com>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Michael Mann <mmann78@netscape.net>",
    "before_after_code_files": [
      "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
      "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
    ]
  },
  "patch_diff": {
    "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c": [
      "File: epan/dissectors/packet-dcerpc-nt.c -> epan/dissectors/packet-dcerpc-nt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1262:  if (options & CB_STR_SAVE) {",
      "1263:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
      "1265:  }",
      "1266: }",
      "",
      "[Removed Lines]",
      "1264:   dcv->private_data = s;",
      "",
      "[Added Lines]",
      "1264:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1324:  if (options & CB_STR_SAVE) {",
      "1325:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
      "1328:  }",
      "1329: }",
      "",
      "[Removed Lines]",
      "1327:   dcv->private_data = s;",
      "",
      "[Added Lines]",
      "1327:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
      "",
      "---------------"
    ],
    "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c": [
      "File: epan/dissectors/packet-dcerpc-spoolss.c -> epan/dissectors/packet-dcerpc-spoolss.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "628:  offset =  dissect_SYSTEM_TIME(",
      "629:   tvb, offset, pinfo, tree, di, drep, NULL, FALSE, &str);",
      "632:  return offset;",
      "633: }",
      "",
      "[Removed Lines]",
      "630:  dcv->private_data = str;",
      "",
      "[Added Lines]",
      "630:  dcv->private_data = wmem_strdup(wmem_file_scope(), str);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cc8e37f0f53c4401bb1644a34eddea345940a8df",
      "candidate_info": {
        "commit_hash": "cc8e37f0f53c4401bb1644a34eddea345940a8df",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/cc8e37f0f53c4401bb1644a34eddea345940a8df",
        "files": [
          "epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c"
        ],
        "message": "DCERPC: save strings in wmem file scope\n\nBug: 13072\nChange-Id: Ib5f3d91be822a3d7180d95e3299dec978941c1d5\nReviewed-on: https://code.wireshark.org/review/18564\nReviewed-by: Pascal Quantin <pascal.quantin@gmail.com>\nPetri-Dish: Pascal Quantin <pascal.quantin@gmail.com>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Michael Mann <mmann78@netscape.net>\n(cherry picked from commit 929ad3805fa31431c39de629e9b09e77e8152709)\nReviewed-on: https://code.wireshark.org/review/18567\n(cherry picked from commit 3f457988ca74b4ca6feb859aedb41fd11899c498)\nReviewed-on: https://code.wireshark.org/review/18568\nPetri-Dish: Michael Mann <mmann78@netscape.net>",
        "before_after_code_files": [
          "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ],
          "candidate": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c": [
          "File: epan/dissectors/packet-dcerpc-nt.c -> epan/dissectors/packet-dcerpc-nt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1261:  if (options & CB_STR_SAVE) {",
          "1262:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1264:  }",
          "1265: }",
          "",
          "[Removed Lines]",
          "1263:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1263:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1323:  if (options & CB_STR_SAVE) {",
          "1324:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1327:  }",
          "1328: }",
          "",
          "[Removed Lines]",
          "1326:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1326:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------"
        ],
        "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c": [
          "File: epan/dissectors/packet-dcerpc-spoolss.c -> epan/dissectors/packet-dcerpc-spoolss.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "628:  offset =  dissect_SYSTEM_TIME(",
          "629:   tvb, offset, pinfo, tree, di, drep, NULL, FALSE, &str);",
          "632:  return offset;",
          "633: }",
          "",
          "[Removed Lines]",
          "630:  dcv->private_data = str;",
          "",
          "[Added Lines]",
          "630:  dcv->private_data = wmem_strdup(wmem_file_scope(), str);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f457988ca74b4ca6feb859aedb41fd11899c498",
      "candidate_info": {
        "commit_hash": "3f457988ca74b4ca6feb859aedb41fd11899c498",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/3f457988ca74b4ca6feb859aedb41fd11899c498",
        "files": [
          "epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c"
        ],
        "message": "DCERPC: save strings in wmem file scope\n\nBug: 13072\nChange-Id: Ib5f3d91be822a3d7180d95e3299dec978941c1d5\nReviewed-on: https://code.wireshark.org/review/18564\nReviewed-by: Pascal Quantin <pascal.quantin@gmail.com>\nPetri-Dish: Pascal Quantin <pascal.quantin@gmail.com>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Michael Mann <mmann78@netscape.net>\n(cherry picked from commit 929ad3805fa31431c39de629e9b09e77e8152709)\nReviewed-on: https://code.wireshark.org/review/18567",
        "before_after_code_files": [
          "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ],
          "candidate": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c": [
          "File: epan/dissectors/packet-dcerpc-nt.c -> epan/dissectors/packet-dcerpc-nt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1261:  if (options & CB_STR_SAVE) {",
          "1262:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1264:  }",
          "1265: }",
          "",
          "[Removed Lines]",
          "1263:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1263:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1323:  if (options & CB_STR_SAVE) {",
          "1324:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1327:  }",
          "1328: }",
          "",
          "[Removed Lines]",
          "1326:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1326:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------"
        ],
        "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c": [
          "File: epan/dissectors/packet-dcerpc-spoolss.c -> epan/dissectors/packet-dcerpc-spoolss.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "628:  offset =  dissect_SYSTEM_TIME(",
          "629:   tvb, offset, pinfo, tree, di, drep, NULL, FALSE, &str);",
          "632:  return offset;",
          "633: }",
          "",
          "[Removed Lines]",
          "630:  dcv->private_data = str;",
          "",
          "[Added Lines]",
          "630:  dcv->private_data = wmem_strdup(wmem_file_scope(), str);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d101dc0b3c76ea0dd9796b4794df5bf12acd11cc",
      "candidate_info": {
        "commit_hash": "d101dc0b3c76ea0dd9796b4794df5bf12acd11cc",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/d101dc0b3c76ea0dd9796b4794df5bf12acd11cc",
        "files": [
          "epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c"
        ],
        "message": "DCERPC: save strings in wmem file scope\n\nBug: 13072\nChange-Id: Ib5f3d91be822a3d7180d95e3299dec978941c1d5\nReviewed-on: https://code.wireshark.org/review/18564\nReviewed-by: Pascal Quantin <pascal.quantin@gmail.com>\nPetri-Dish: Pascal Quantin <pascal.quantin@gmail.com>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Michael Mann <mmann78@netscape.net>\n(cherry picked from commit 929ad3805fa31431c39de629e9b09e77e8152709)\nReviewed-on: https://code.wireshark.org/review/18567\n(cherry picked from commit 3f457988ca74b4ca6feb859aedb41fd11899c498)\nReviewed-on: https://code.wireshark.org/review/18568\nPetri-Dish: Michael Mann <mmann78@netscape.net>\n(cherry picked from commit cc8e37f0f53c4401bb1644a34eddea345940a8df)\nReviewed-on: https://code.wireshark.org/review/18870\nReviewed-by: Balint Reczey <balint@balintreczey.hu>",
        "before_after_code_files": [
          "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
          "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ],
          "candidate": [
            "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c",
            "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/dissectors/packet-dcerpc-nt.c||epan/dissectors/packet-dcerpc-nt.c": [
          "File: epan/dissectors/packet-dcerpc-nt.c -> epan/dissectors/packet-dcerpc-nt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1257:  if (options & CB_STR_SAVE) {",
          "1258:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1260:  }",
          "1261: }",
          "",
          "[Removed Lines]",
          "1259:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1259:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1319:  if (options & CB_STR_SAVE) {",
          "1320:   dcerpc_call_value *dcv = (dcerpc_call_value *)di->call_data;",
          "1323:  }",
          "1324: }",
          "",
          "[Removed Lines]",
          "1322:   dcv->private_data = s;",
          "",
          "[Added Lines]",
          "1322:   dcv->private_data = wmem_strdup(wmem_file_scope(), s);",
          "",
          "---------------"
        ],
        "epan/dissectors/packet-dcerpc-spoolss.c||epan/dissectors/packet-dcerpc-spoolss.c": [
          "File: epan/dissectors/packet-dcerpc-spoolss.c -> epan/dissectors/packet-dcerpc-spoolss.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "613:  offset =  dissect_SYSTEM_TIME(",
          "614:   tvb, offset, pinfo, tree, di, drep, NULL, FALSE, &str);",
          "617:  return offset;",
          "618: }",
          "",
          "[Removed Lines]",
          "615:  dcv->private_data = str;",
          "",
          "[Added Lines]",
          "615:  dcv->private_data = wmem_strdup(wmem_file_scope(), str);",
          "",
          "---------------"
        ]
      }
    }
  ]
}