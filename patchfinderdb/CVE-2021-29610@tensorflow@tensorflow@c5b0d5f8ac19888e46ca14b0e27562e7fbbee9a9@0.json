{
  "cve_id": "CVE-2021-29610",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The validation in `tf.raw_ops.QuantizeAndDequantizeV2` allows invalid values for `axis` argument:. The validation(https://github.com/tensorflow/tensorflow/blob/eccb7ec454e6617738554a255d77f08e60ee0808/tensorflow/core/kernels/quantize_and_dequantize_op.cc#L74-L77) uses `||` to mix two different conditions. If `axis_ < -1` the condition in `OP_REQUIRES` will still be true, but this value of `axis_` results in heap underflow. This allows attackers to read/write to other data on the heap. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
  "patch_info": {
    "commit_hash": "c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
    "files": [
      "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
    ],
    "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
    "before_after_code_files": [
      "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
      "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "73:   void Compute(OpKernelContext* ctx) override {",
      "74:     const Tensor& input = ctx->input(0);",
      "75:     OP_REQUIRES(",
      "76:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
      "77:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "75:     OP_REQUIRES(",
      "76:         ctx, axis_ >= -1,",
      "77:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ce30ca3641cdb2d19e08be13dd86d952b767605d",
      "candidate_info": {
        "commit_hash": "ce30ca3641cdb2d19e08be13dd86d952b767605d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ce30ca3641cdb2d19e08be13dd86d952b767605d",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   void Compute(OpKernelContext* ctx) override {",
          "73:     const Tensor& input = ctx->input(0);",
          "74:     const int depth = (axis_ == -1) ? 1 : input.dim_size(axis_);",
          "75:     Tensor input_min_tensor;",
          "76:     Tensor input_max_tensor;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     OP_REQUIRES(",
          "75:         ctx, axis_ >= -1,",
          "76:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "77:     OP_REQUIRES(",
          "78:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "79:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "80:                                 \" but is rank \", input.shape().dims()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "57fbb97d0bebae1225940f941452fcfc86cc62d5",
      "candidate_info": {
        "commit_hash": "57fbb97d0bebae1225940f941452fcfc86cc62d5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/57fbb97d0bebae1225940f941452fcfc86cc62d5",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   void Compute(OpKernelContext* ctx) override {",
          "73:     const Tensor& input = ctx->input(0);",
          "74:     const int depth = (axis_ == -1) ? 1 : input.dim_size(axis_);",
          "75:     Tensor input_min_tensor;",
          "76:     Tensor input_max_tensor;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     OP_REQUIRES(",
          "75:         ctx, axis_ >= -1,",
          "76:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "77:     OP_REQUIRES(",
          "78:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "79:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "80:                                 \" but is rank \", input.shape().dims()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5d692bf5d76aa9539969652532287a318cbdc813",
      "candidate_info": {
        "commit_hash": "5d692bf5d76aa9539969652532287a318cbdc813",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5d692bf5d76aa9539969652532287a318cbdc813",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:   void Compute(OpKernelContext* ctx) override {",
          "74:     const Tensor& input = ctx->input(0);",
          "75:     OP_REQUIRES(",
          "76:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "77:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75:     OP_REQUIRES(",
          "76:         ctx, axis_ >= -1,",
          "77:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4f2db83c97c4e74ecfe118e29b75a669a8a2087",
      "candidate_info": {
        "commit_hash": "c4f2db83c97c4e74ecfe118e29b75a669a8a2087",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c4f2db83c97c4e74ecfe118e29b75a669a8a2087",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   void Compute(OpKernelContext* ctx) override {",
          "73:     const Tensor& input = ctx->input(0);",
          "74:     const int depth = (axis_ == -1) ? 1 : input.dim_size(axis_);",
          "75:     Tensor input_min_tensor;",
          "76:     Tensor input_max_tensor;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     OP_REQUIRES(",
          "75:         ctx, axis_ >= -1,",
          "76:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "77:     OP_REQUIRES(",
          "78:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "79:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "80:                                 \" but is rank \", input.shape().dims()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
      "candidate_info": {
        "commit_hash": "e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   void Compute(OpKernelContext* ctx) override {",
          "73:     const Tensor& input = ctx->input(0);",
          "74:     OP_REQUIRES(",
          "75:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "76:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     OP_REQUIRES(",
          "75:         ctx, axis_ >= -1,",
          "76:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "",
          "---------------"
        ]
      }
    }
  ]
}