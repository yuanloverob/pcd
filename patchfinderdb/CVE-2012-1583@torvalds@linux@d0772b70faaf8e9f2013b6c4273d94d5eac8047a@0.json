{
  "cve_id": "CVE-2012-1583",
  "cve_desc": "Double free vulnerability in the xfrm6_tunnel_rcv function in net/ipv6/xfrm6_tunnel.c in the Linux kernel before 2.6.22, when the xfrm6_tunnel module is enabled, allows remote attackers to cause a denial of service (panic) via crafted IPv6 packets.",
  "repo": "torvalds/linux",
  "patch_hash": "d0772b70faaf8e9f2013b6c4273d94d5eac8047a",
  "patch_info": {
    "commit_hash": "d0772b70faaf8e9f2013b6c4273d94d5eac8047a",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/d0772b70faaf8e9f2013b6c4273d94d5eac8047a",
    "files": [
      "net/ipv6/xfrm6_tunnel.c"
    ],
    "message": "[IPV6]: Fix slab corruption running ip6sic\n\nFrom: Eric Sesterhenn <snakebyte@gmx.de>\n\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c"
    ]
  },
  "patch_diff": {
    "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c": [
      "File: net/ipv6/xfrm6_tunnel.c -> net/ipv6/xfrm6_tunnel.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "261:  __be32 spi;",
      "263:  spi = xfrm6_tunnel_spi_lookup((xfrm_address_t *)&iph->saddr);",
      "265: }",
      "267: static int xfrm6_tunnel_err(struct sk_buff *skb, struct inet6_skb_parm *opt,",
      "",
      "[Removed Lines]",
      "264:  return xfrm6_rcv_spi(skb, spi);",
      "",
      "[Added Lines]",
      "264:  return xfrm6_rcv_spi(skb, spi) > 0 ? : 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "33b5ecb8f64706d1ed472dcb44162ab3a7345724",
      "candidate_info": {
        "commit_hash": "33b5ecb8f64706d1ed472dcb44162ab3a7345724",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/33b5ecb8f64706d1ed472dcb44162ab3a7345724",
        "files": [
          "include/net/xfrm.h",
          "net/ipv6/xfrm6_input.c",
          "net/ipv6/xfrm6_tunnel.c"
        ],
        "message": "[IPSEC]: Get nexthdr from caller in xfrm6_rcv_spi\n\nCurrently xfrm6_rcv_spi gets the nexthdr value itself from the packet.\nThis means that we need to fix up the value in case we have a 4-on-6\ntunnel.  Moving this logic into the caller simplifies things and allows\nus to merge the code with IPv4.\n\nSigned-off-by: Herbert Xu <herbert@gondor.apana.org.au>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "include/net/xfrm.h||include/net/xfrm.h",
          "net/ipv6/xfrm6_input.c||net/ipv6/xfrm6_input.c",
          "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c"
          ],
          "candidate": [
            "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c"
          ]
        }
      },
      "candidate_diff": {
        "include/net/xfrm.h||include/net/xfrm.h": [
          "File: include/net/xfrm.h -> include/net/xfrm.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1058: extern int xfrm4_output(struct sk_buff *skb);",
          "1059: extern int xfrm4_tunnel_register(struct xfrm_tunnel *handler, unsigned short family);",
          "1060: extern int xfrm4_tunnel_deregister(struct xfrm_tunnel *handler, unsigned short family);",
          "1062: extern int xfrm6_rcv(struct sk_buff *skb);",
          "1063: extern int xfrm6_input_addr(struct sk_buff *skb, xfrm_address_t *daddr,",
          "1064:        xfrm_address_t *saddr, u8 proto);",
          "",
          "[Removed Lines]",
          "1061: extern int xfrm6_rcv_spi(struct sk_buff *skb, __be32 spi);",
          "",
          "[Added Lines]",
          "1061: extern int xfrm6_rcv_spi(struct sk_buff *skb, int nexthdr, __be32 spi);",
          "",
          "---------------"
        ],
        "net/ipv6/xfrm6_input.c||net/ipv6/xfrm6_input.c": [
          "File: net/ipv6/xfrm6_input.c -> net/ipv6/xfrm6_input.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: #include <net/ipv6.h>",
          "17: #include <net/xfrm.h>",
          "20: {",
          "21:  int err;",
          "22:  __be32 seq;",
          "",
          "[Removed Lines]",
          "19: int xfrm6_rcv_spi(struct sk_buff *skb, __be32 spi)",
          "",
          "[Added Lines]",
          "19: int xfrm6_rcv_spi(struct sk_buff *skb, int nexthdr, __be32 spi)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "24:  struct xfrm_state *x;",
          "25:  int xfrm_nr = 0;",
          "26:  int decaps = 0;",
          "28:  unsigned int nhoff;",
          "30:  nhoff = IP6CB(skb)->nhoff;",
          "33:  seq = 0;",
          "34:  if (!spi && (err = xfrm_parse_spi(skb, nexthdr, &spi, &seq)) != 0)",
          "",
          "[Removed Lines]",
          "27:  int nexthdr;",
          "31:  nexthdr = skb_network_header(skb)[nhoff];",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "41:    goto drop;",
          "43:   x = xfrm_state_lookup((xfrm_address_t *)&iph->daddr, spi,",
          "45:   if (x == NULL)",
          "46:    goto drop;",
          "47:   spin_lock(&x->lock);",
          "",
          "[Removed Lines]",
          "44:     nexthdr != IPPROTO_IPIP ? nexthdr : IPPROTO_IPV6, AF_INET6);",
          "",
          "[Added Lines]",
          "42:           nexthdr, AF_INET6);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "136: int xfrm6_rcv(struct sk_buff *skb)",
          "137: {",
          "139: }",
          "141: EXPORT_SYMBOL(xfrm6_rcv);",
          "",
          "[Removed Lines]",
          "138:  return xfrm6_rcv_spi(skb, 0);",
          "",
          "[Added Lines]",
          "136:  return xfrm6_rcv_spi(skb, skb_network_header(skb)[IP6CB(skb)->nhoff],",
          "137:         0);",
          "",
          "---------------"
        ],
        "net/ipv6/xfrm6_tunnel.c||net/ipv6/xfrm6_tunnel.c": [
          "File: net/ipv6/xfrm6_tunnel.c -> net/ipv6/xfrm6_tunnel.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "257:  __be32 spi;",
          "259:  spi = xfrm6_tunnel_spi_lookup((xfrm_address_t *)&iph->saddr);",
          "261: }",
          "263: static int xfrm6_tunnel_err(struct sk_buff *skb, struct inet6_skb_parm *opt,",
          "",
          "[Removed Lines]",
          "260:  return xfrm6_rcv_spi(skb, spi) > 0 ? : 0;",
          "",
          "[Added Lines]",
          "260:  return xfrm6_rcv_spi(skb, IPPROTO_IPV6, spi) > 0 ? : 0;",
          "",
          "---------------"
        ]
      }
    }
  ]
}