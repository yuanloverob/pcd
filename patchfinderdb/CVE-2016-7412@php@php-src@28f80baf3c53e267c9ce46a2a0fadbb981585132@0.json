{
  "cve_id": "CVE-2016-7412",
  "cve_desc": "ext/mysqlnd/mysqlnd_wireprotocol.c in PHP before 5.6.26 and 7.x before 7.0.11 does not verify that a BIT field has the UNSIGNED_FLAG flag, which allows remote MySQL servers to cause a denial of service (heap-based buffer overflow) or possibly have unspecified other impact via crafted field metadata.",
  "repo": "php/php-src",
  "patch_hash": "28f80baf3c53e267c9ce46a2a0fadbb981585132",
  "patch_info": {
    "commit_hash": "28f80baf3c53e267c9ce46a2a0fadbb981585132",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/28f80baf3c53e267c9ce46a2a0fadbb981585132",
    "files": [
      "ext/mysqlnd/mysqlnd_wireprotocol.c"
    ],
    "message": "Fix bug #72293 - Heap overflow in mysqlnd related to BIT fields",
    "before_after_code_files": [
      "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
    ]
  },
  "patch_diff": {
    "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c": [
      "File: ext/mysqlnd/mysqlnd_wireprotocol.c -> ext/mysqlnd/mysqlnd_wireprotocol.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1585:  zend_uchar * p = row_buffer->ptr;",
      "1586:  size_t data_size = row_buffer->app;",
      "1589:  DBG_ENTER(\"php_mysqlnd_rowp_read_text_protocol_aux\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1588:  const zend_uchar * const packet_end = (zend_uchar*) row_buffer->ptr + data_size;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1607:   zend_uchar *this_field_len_pos = p;",
      "1611:   if (copy_data == FALSE && current_field > start_field && last_field_was_string) {",
      "1613:      Normal queries:",
      "",
      "[Removed Lines]",
      "1609:   unsigned long len = php_mysqlnd_net_field_length(&p);",
      "",
      "[Added Lines]",
      "1610:   const unsigned long len = php_mysqlnd_net_field_length(&p);",
      "1612:   if (len != MYSQLND_NULL_LENGTH && ((p + len) > packet_end)) {",
      "1613:    php_error_docref(NULL, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
      "1614:              \" bytes after end of packet\", (p + len) - packet_end - 1);",
      "1615:    DBG_RETURN(FAIL);",
      "1616:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "caea2c876b4302b9fb1b12bfa755e064ec199e68",
      "candidate_info": {
        "commit_hash": "caea2c876b4302b9fb1b12bfa755e064ec199e68",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/caea2c876b4302b9fb1b12bfa755e064ec199e68",
        "files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c"
        ],
        "message": "Fix bug #72293 - Heap overflow in mysqlnd related to BIT fields",
        "before_after_code_files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ],
          "candidate": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c": [
          "File: ext/mysqlnd/mysqlnd_wireprotocol.c -> ext/mysqlnd/mysqlnd_wireprotocol.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1635:  zend_uchar * p = row_buffer->ptr;",
          "1636:  size_t data_size = row_buffer->app;",
          "1639:  DBG_ENTER(\"php_mysqlnd_rowp_read_text_protocol_aux\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1638:  const zend_uchar * const packet_end = (zend_uchar*) row_buffer->ptr + data_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1652:   if (len == MYSQLND_NULL_LENGTH) {",
          "1653:    ZVAL_NULL(current_field);",
          "1654:   } else {",
          "1655: #if defined(MYSQLND_STRING_TO_INT_CONVERSION)",
          "1656:    struct st_mysqlnd_perm_bind perm_bind =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1655:   } else if ((p + len) > packet_end) {",
          "1656:    php_error_docref(NULL, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
          "1657:              \" bytes after end of packet\", (p + len) - packet_end - 1);",
          "1658:    DBG_RETURN(FAIL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c984661d39cfa4db1dd97fde1f59c77a44991440",
      "candidate_info": {
        "commit_hash": "c984661d39cfa4db1dd97fde1f59c77a44991440",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/c984661d39cfa4db1dd97fde1f59c77a44991440",
        "files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c"
        ],
        "message": "Fix bug #72293 - Heap overflow in mysqlnd related to BIT fields",
        "before_after_code_files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ],
          "candidate": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c": [
          "File: ext/mysqlnd/mysqlnd_wireprotocol.c -> ext/mysqlnd/mysqlnd_wireprotocol.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1608:  zend_uchar * p = row_buffer->ptr;",
          "1609:  size_t data_size = row_buffer->app;",
          "1612:  DBG_ENTER(\"php_mysqlnd_rowp_read_text_protocol_aux\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1611:  const zend_uchar * const packet_end = (zend_uchar*) row_buffer->ptr + data_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1620:  for (i = 0, current_field = start_field; current_field < end_field; current_field++, i++) {",
          "1625:   if (len == MYSQLND_NULL_LENGTH) {",
          "1626:    ZVAL_NULL(current_field);",
          "1627:   } else {",
          "1628: #if defined(MYSQLND_STRING_TO_INT_CONVERSION)",
          "1629:    struct st_mysqlnd_perm_bind perm_bind =",
          "",
          "[Removed Lines]",
          "1622:   zend_ulong len = php_mysqlnd_net_field_length(&p);",
          "",
          "[Added Lines]",
          "1623:   const zend_ulong len = php_mysqlnd_net_field_length(&p);",
          "1628:   } else if ((p + len) > packet_end) {",
          "1629:    php_error_docref(NULL, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
          "1630:              \" bytes after end of packet\", (p + len) - packet_end - 1);",
          "1631:    DBG_RETURN(FAIL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "55237fe153694f5501636a49e387f36297037e4a",
      "candidate_info": {
        "commit_hash": "55237fe153694f5501636a49e387f36297037e4a",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/55237fe153694f5501636a49e387f36297037e4a",
        "files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c"
        ],
        "message": "fix ZTS build",
        "before_after_code_files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ],
          "candidate": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c": [
          "File: ext/mysqlnd/mysqlnd_wireprotocol.c -> ext/mysqlnd/mysqlnd_wireprotocol.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1610:   const unsigned long len = php_mysqlnd_net_field_length(&p);",
          "1612:   if (len != MYSQLND_NULL_LENGTH && ((p + len) > packet_end)) {",
          "1614:              \" bytes after end of packet\", (p + len) - packet_end - 1);",
          "1615:    DBG_RETURN(FAIL);",
          "1616:   }",
          "",
          "[Removed Lines]",
          "1613:    php_error_docref(NULL, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
          "",
          "[Added Lines]",
          "1613:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b4edc331997b2dbc6bf5da9af4aeffd78306ffb9",
      "candidate_info": {
        "commit_hash": "b4edc331997b2dbc6bf5da9af4aeffd78306ffb9",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/b4edc331997b2dbc6bf5da9af4aeffd78306ffb9",
        "files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c"
        ],
        "message": "Fix bug #72293 - Heap overflow in mysqlnd related to BIT fields",
        "before_after_code_files": [
          "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ],
          "candidate": [
            "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/mysqlnd/mysqlnd_wireprotocol.c||ext/mysqlnd/mysqlnd_wireprotocol.c": [
          "File: ext/mysqlnd/mysqlnd_wireprotocol.c -> ext/mysqlnd/mysqlnd_wireprotocol.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1585:  zend_uchar * p = row_buffer->ptr;",
          "1586:  size_t data_size = row_buffer->app;",
          "1589:  DBG_ENTER(\"php_mysqlnd_rowp_read_text_protocol_aux\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1588:  const zend_uchar * const packet_end = (zend_uchar*) row_buffer->ptr + data_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1607:   zend_uchar *this_field_len_pos = p;",
          "1611:   if (copy_data == FALSE && current_field > start_field && last_field_was_string) {",
          "1613:      Normal queries:",
          "",
          "[Removed Lines]",
          "1609:   unsigned long len = php_mysqlnd_net_field_length(&p);",
          "",
          "[Added Lines]",
          "1610:   const unsigned long len = php_mysqlnd_net_field_length(&p);",
          "1612:   if (len != MYSQLND_NULL_LENGTH && ((p + len) > packet_end)) {",
          "1613:    php_error_docref(NULL, E_WARNING, \"Malformed server packet. Field length pointing \"MYSQLND_SZ_T_SPEC",
          "1614:              \" bytes after end of packet\", (p + len) - packet_end - 1);",
          "1615:    DBG_RETURN(FAIL);",
          "1616:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}