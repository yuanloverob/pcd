{
  "cve_id": "CVE-2016-9933",
  "cve_desc": "Stack consumption vulnerability in the gdImageFillToBorder function in gd.c in the GD Graphics Library (aka libgd) before 2.2.2, as used in PHP before 5.6.28 and 7.x before 7.0.13, allows remote attackers to cause a denial of service (segmentation violation) via a crafted imagefilltoborder call that triggers use of a negative color value.",
  "repo": "php/php-src",
  "patch_hash": "863d37ea66d5c960db08d6f4a2cbd2518f0f80d1",
  "patch_info": {
    "commit_hash": "863d37ea66d5c960db08d6f4a2cbd2518f0f80d1",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/863d37ea66d5c960db08d6f4a2cbd2518f0f80d1",
    "files": [
      "ext/gd/libgd/gd.c",
      "ext/gd/tests/bug72696.phpt"
    ],
    "message": "Fix #72696: imagefilltoborder stackoverflow on truecolor images\n\nWe must not allow negative color values be passed to\ngdImageFillToBorder(), because that can lead to infinite recursion\nsince the recursion termination condition will not necessarily be met.",
    "before_after_code_files": [
      "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
      "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
    ]
  },
  "patch_diff": {
    "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c": [
      "File: ext/gd/libgd/gd.c -> ext/gd/libgd/gd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1747:  int leftLimit = -1, rightLimit;",
      "1748:  int i, restoreAlphaBlending = 0;",
      "1752:   return;",
      "1753:  }",
      "",
      "[Removed Lines]",
      "1750:  if (border < 0) {",
      "",
      "[Added Lines]",
      "1750:  if (border < 0 || color < 0) {",
      "",
      "---------------"
    ],
    "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt": [
      "File: ext/gd/tests/bug72696.phpt -> ext/gd/tests/bug72696.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #72696 (imagefilltoborder stackoverflow on truecolor images)",
      "3: --SKIPIF--",
      "4: <?php",
      "5: if (!extension_loaded('gd')) die('skip gd extension not available');",
      "6: ?>",
      "7: --FILE--",
      "8: <?php",
      "9: $im = imagecreatetruecolor(10, 10);",
      "10: imagefilltoborder($im, 0, 0, 1, -2);",
      "11: ?>",
      "12: ===DONE===",
      "13: --EXPECT--",
      "14: ===DONE===",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5693474997b5a804be307583fb7bc3cfcdd50aec",
      "candidate_info": {
        "commit_hash": "5693474997b5a804be307583fb7bc3cfcdd50aec",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/5693474997b5a804be307583fb7bc3cfcdd50aec",
        "files": [
          "ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt"
        ],
        "message": "Fix #72696: imagefilltoborder stackoverflow on truecolor images\n\nWe must not allow negative color values be passed to\ngdImageFillToBorder(), because that can lead to infinite recursion\nsince the recursion termination condition will not necessarily be met.\n\n(cherry picked from commit 863d37ea66d5c960db08d6f4a2cbd2518f0f80d1)",
        "before_after_code_files": [
          "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ],
          "candidate": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c": [
          "File: ext/gd/libgd/gd.c -> ext/gd/libgd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1745:  int leftLimit = -1, rightLimit;",
          "1746:  int i, restoreAlphaBlending = 0;",
          "1750:   return;",
          "1751:  }",
          "",
          "[Removed Lines]",
          "1748:  if (border < 0) {",
          "",
          "[Added Lines]",
          "1748:  if (border < 0 || color < 0) {",
          "",
          "---------------"
        ],
        "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt": [
          "File: ext/gd/tests/bug72696.phpt -> ext/gd/tests/bug72696.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72696 (imagefilltoborder stackoverflow on truecolor images)",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!extension_loaded('gd')) die('skip gd extension not available');",
          "6: ?>",
          "7: --FILE--",
          "8: <?php",
          "9: $im = imagecreatetruecolor(10, 10);",
          "10: imagefilltoborder($im, 0, 0, 1, -2);",
          "11: ?>",
          "12: ===DONE===",
          "13: --EXPECT--",
          "14: ===DONE===",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a05e84c42bfbff1f2ab17dfcb3311b55ff63f0a1",
      "candidate_info": {
        "commit_hash": "a05e84c42bfbff1f2ab17dfcb3311b55ff63f0a1",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/a05e84c42bfbff1f2ab17dfcb3311b55ff63f0a1",
        "files": [
          "ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt"
        ],
        "message": "Fix #72696: imagefilltoborder stackoverflow on truecolor images\n\nWe must not allow negative color values be passed to\ngdImageFillToBorder(), because that can lead to infinite recursion\nsince the recursion termination condition will not necessarily be met.\n\n(cherry picked from commit 863d37ea66d5c960db08d6f4a2cbd2518f0f80d1)\n(cherry picked from commit 5693474997b5a804be307583fb7bc3cfcdd50aec)",
        "before_after_code_files": [
          "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ],
          "candidate": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c": [
          "File: ext/gd/libgd/gd.c -> ext/gd/libgd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1745:  int leftLimit = -1, rightLimit;",
          "1746:  int i, restoreAlphaBlending = 0;",
          "1750:   return;",
          "1751:  }",
          "",
          "[Removed Lines]",
          "1748:  if (border < 0) {",
          "",
          "[Added Lines]",
          "1748:  if (border < 0 || color < 0) {",
          "",
          "---------------"
        ],
        "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt": [
          "File: ext/gd/tests/bug72696.phpt -> ext/gd/tests/bug72696.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72696 (imagefilltoborder stackoverflow on truecolor images)",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!extension_loaded('gd')) die('skip gd extension not available');",
          "6: ?>",
          "7: --FILE--",
          "8: <?php",
          "9: $im = imagecreatetruecolor(10, 10);",
          "10: imagefilltoborder($im, 0, 0, 1, -2);",
          "11: ?>",
          "12: ===DONE===",
          "13: --EXPECT--",
          "14: ===DONE===",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7c27d0329f730d701d18e66db7e85ef7d128712b",
      "candidate_info": {
        "commit_hash": "7c27d0329f730d701d18e66db7e85ef7d128712b",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/7c27d0329f730d701d18e66db7e85ef7d128712b",
        "files": [
          "ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt"
        ],
        "message": "Fix #72696: imagefilltoborder stackoverflow on truecolor images\n\nWe must not allow negative color values be passed to\ngdImageFillToBorder(), because that can lead to infinite recursion\nsince the recursion termination condition will not necessarily be met.",
        "before_after_code_files": [
          "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
          "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ],
          "candidate": [
            "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c",
            "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/libgd/gd.c||ext/gd/libgd/gd.c": [
          "File: ext/gd/libgd/gd.c -> ext/gd/libgd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1747:  int leftLimit = -1, rightLimit;",
          "1748:  int i, restoreAlphaBlending = 0;",
          "1752:   return;",
          "1753:  }",
          "",
          "[Removed Lines]",
          "1750:  if (border < 0) {",
          "",
          "[Added Lines]",
          "1750:  if (border < 0 || color < 0) {",
          "",
          "---------------"
        ],
        "ext/gd/tests/bug72696.phpt||ext/gd/tests/bug72696.phpt": [
          "File: ext/gd/tests/bug72696.phpt -> ext/gd/tests/bug72696.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72696 (imagefilltoborder stackoverflow on truecolor images)",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!extension_loaded('gd')) die('skip gd extension not available');",
          "6: ?>",
          "7: --FILE--",
          "8: <?php",
          "9: $im = imagecreatetruecolor(10, 10);",
          "10: imagefilltoborder($im, 0, 0, 1, -2);",
          "11: ?>",
          "12: ===DONE===",
          "13: --EXPECT--",
          "14: ===DONE===",
          "",
          "---------------"
        ]
      }
    }
  ]
}