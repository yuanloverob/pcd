{
  "cve_id": "CVE-2021-29597",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The implementation of the `SpaceToBatchNd` TFLite operator is [vulnerable to a division by zero error](https://github.com/tensorflow/tensorflow/blob/412c7d9bb8f8a762c5b266c9e73bfa165f29aac8/tensorflow/lite/kernels/space_to_batch_nd.cc#L82-L83). An attacker can craft a model such that one dimension of the `block` input is 0. Hence, the corresponding value in `block_shape` is 0. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "6d36ba65577006affb272335b7c1abd829010708",
  "patch_info": {
    "commit_hash": "6d36ba65577006affb272335b7c1abd829010708",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/6d36ba65577006affb272335b7c1abd829010708",
    "files": [
      "tensorflow/lite/kernels/space_to_batch_nd.cc"
    ],
    "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
    "before_after_code_files": [
      "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
      "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "79:   for (int dim = 0; dim < spatial_dims_num; ++dim) {",
      "80:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
      "81:                           paddings_data[dim * 2 + 1]);",
      "82:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
      "83:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
      "84:     output_batch_size *= block_shape[dim];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "82:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "762ce5297f902439a0bb982bdf9a2878286aeaf1",
      "candidate_info": {
        "commit_hash": "762ce5297f902439a0bb982bdf9a2878286aeaf1",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/762ce5297f902439a0bb982bdf9a2878286aeaf1",
        "files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc"
        ],
        "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
          "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:   for (int dim = 0; dim < spatial_dims_num; ++dim) {",
          "80:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
          "81:                           paddings_data[dim * 2 + 1]);",
          "82:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
          "83:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
          "84:     output_batch_size *= block_shape[dim];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "24dc678816142616a6664ed82788d4db413fc85a",
      "candidate_info": {
        "commit_hash": "24dc678816142616a6664ed82788d4db413fc85a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/24dc678816142616a6664ed82788d4db413fc85a",
        "files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc"
        ],
        "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
          "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:   for (int dim = 0; dim < spatial_dims_num; ++dim) {",
          "80:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
          "81:                           paddings_data[dim * 2 + 1]);",
          "82:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
          "83:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
          "84:     output_batch_size *= block_shape[dim];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "06ed916d34e38b1c366ff1d32f6e8667751669a8",
      "candidate_info": {
        "commit_hash": "06ed916d34e38b1c366ff1d32f6e8667751669a8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/06ed916d34e38b1c366ff1d32f6e8667751669a8",
        "files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc"
        ],
        "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
          "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:   for (int dim = 0; dim < kSpatialDimensionNum; ++dim) {",
          "74:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
          "75:                           paddings_data[dim * 2 + 1]);",
          "76:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
          "77:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
          "78:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3e1f82cfa6fb1aaaa0e1d59a9599b7f84a019dca",
      "candidate_info": {
        "commit_hash": "3e1f82cfa6fb1aaaa0e1d59a9599b7f84a019dca",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3e1f82cfa6fb1aaaa0e1d59a9599b7f84a019dca",
        "files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc"
        ],
        "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
          "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:   for (int dim = 0; dim < kSpatialDimensionNum; ++dim) {",
          "76:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
          "77:                           paddings_data[dim * 2 + 1]);",
          "78:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
          "79:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
          "80:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ca451ad50014514b6185181deae83b217c198de2",
      "candidate_info": {
        "commit_hash": "ca451ad50014514b6185181deae83b217c198de2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ca451ad50014514b6185181deae83b217c198de2",
        "files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc"
        ],
        "message": "Prevent division by 0\n\nPiperOrigin-RevId: 370984990\nChange-Id: Ib324955bbeb1cbd97c82fd5d61a00a2697c9a2de",
        "before_after_code_files": [
          "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/space_to_batch_nd.cc||tensorflow/lite/kernels/space_to_batch_nd.cc": [
          "File: tensorflow/lite/kernels/space_to_batch_nd.cc -> tensorflow/lite/kernels/space_to_batch_nd.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:   for (int dim = 0; dim < spatial_dims_num; ++dim) {",
          "80:     int final_dim_size = (input_size->data[dim + 1] + paddings_data[dim * 2] +",
          "81:                           paddings_data[dim * 2 + 1]);",
          "82:     TF_LITE_ENSURE_EQ(context, final_dim_size % block_shape[dim], 0);",
          "83:     output_size->data[dim + 1] = final_dim_size / block_shape[dim];",
          "84:     output_batch_size *= block_shape[dim];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:     TF_LITE_ENSURE(context, block_shape[dim] != 0);",
          "",
          "---------------"
        ]
      }
    }
  ]
}