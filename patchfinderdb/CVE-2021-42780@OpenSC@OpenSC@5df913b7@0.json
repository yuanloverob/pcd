{
  "cve_id": "CVE-2021-42780",
  "cve_desc": "A use after return issue was found in Opensc before version 0.22.0 in insert_pin function that could potentially crash programs using the library.",
  "repo": "OpenSC/OpenSC",
  "patch_hash": "5df913b7f57ad89b9832555d24c08d23a534311e",
  "patch_info": {
    "commit_hash": "5df913b7f57ad89b9832555d24c08d23a534311e",
    "repo": "OpenSC/OpenSC",
    "commit_url": "https://github.com/OpenSC/OpenSC/commit/5df913b7f57ad89b9832555d24c08d23a534311e",
    "files": [
      "src/libopensc/pkcs15-tcos.c"
    ],
    "message": "tcos: Check bounds in insert_pin()\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=28383",
    "before_after_code_files": [
      "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c"
    ]
  },
  "patch_diff": {
    "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c": [
      "File: src/libopensc/pkcs15-tcos.c -> src/libopensc/pkcs15-tcos.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "242:    \"Searching for PIN-Ref %02X\\n\", pin_reference);",
      "243:   while ((r = sc_read_record(card, ++rec_no, buf, sizeof(buf), SC_RECORD_BY_REC_NR)) > 0) {",
      "244:    int found = 0, fbz = -1;",
      "246:     continue;",
      "248:     if (buf[i] == 0x83 && buf[i + 1] == 1 && buf[i + 2] == pin_reference) {",
      "249:      ++found;",
      "250:     }",
      "252:      fbz = buf[i + 1 + buf[i + 1]];",
      "253:     }",
      "254:    }",
      "",
      "[Removed Lines]",
      "245:    if (buf[0] != 0xA0)",
      "247:    for (i = 2; i < buf[1] + 2; i += 2 + buf[i + 1]) {",
      "251:     if (buf[i] == 0x90) {",
      "",
      "[Added Lines]",
      "245:    if (r < 2 || buf[0] != 0xA0)",
      "247:    for (i = 2; i < buf[1] + 2 && (i + 2) < r; i += 2 + buf[i + 1]) {",
      "251:     if (buf[i] == 0x90 && (i + 1 + buf[i + 1]) < r) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1ae8b60425ab61f5c6fedf4502275c9047683f69",
      "candidate_info": {
        "commit_hash": "1ae8b60425ab61f5c6fedf4502275c9047683f69",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/1ae8b60425ab61f5c6fedf4502275c9047683f69",
        "files": [
          "src/libopensc/card-mcrd.c"
        ],
        "message": "mcrd: Do not leak memory\n\nSimilar as in 62049ea18c622f\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=28405",
        "before_after_code_files": [
          "src/libopensc/card-mcrd.c||src/libopensc/card-mcrd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/libopensc/card-mcrd.c||src/libopensc/card-mcrd.c": [
          "File: src/libopensc/card-mcrd.c -> src/libopensc/card-mcrd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "882:    priv->curpathlen--;",
          "883:    priv->is_ef = 0;",
          "884:   }",
          "885:   r = select_down(card, pathptr, 1, 0, file);",
          "886:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "886:   if (file) {",
          "887:    sc_file_free(*file);",
          "889:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "196bf9e574fb421b5d0f7f5f064d86631df259ad",
      "candidate_info": {
        "commit_hash": "196bf9e574fb421b5d0f7f5f064d86631df259ad",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/196bf9e574fb421b5d0f7f5f064d86631df259ad",
        "files": [
          "src/libopensc/card-gpk.c"
        ],
        "message": "gpk: Replace assert with error\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=28306",
        "before_after_code_files": [
          "src/libopensc/card-gpk.c||src/libopensc/card-gpk.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/libopensc/card-gpk.c||src/libopensc/card-gpk.c": [
          "File: src/libopensc/card-gpk.c -> src/libopensc/card-gpk.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "552:    cp->len = 0;",
          "554:   case GPK_SEL_DF:",
          "556:    path = (unsigned short int *) cp->value;",
          "557:    path[cp->len++] = fid;",
          "558:   }",
          "",
          "[Removed Lines]",
          "555:    assert(cp->len + 1 <= SC_MAX_PATH_SIZE / 2);",
          "",
          "[Added Lines]",
          "555:    if (cp->len + 1 > SC_MAX_PATH_SIZE / 2) {",
          "556:     return SC_ERROR_INTERNAL;",
          "557:    }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "69544553c36f0613f6283e0eeb3f9eb549825986",
      "candidate_info": {
        "commit_hash": "69544553c36f0613f6283e0eeb3f9eb549825986",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/69544553c36f0613f6283e0eeb3f9eb549825986",
        "files": [
          "src/libopensc/pkcs15-tcos.c"
        ],
        "message": "tcos: Reformat insert_pin() for readability",
        "before_after_code_files": [
          "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c"
          ],
          "candidate": [
            "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c"
          ]
        }
      },
      "candidate_diff": {
        "src/libopensc/pkcs15-tcos.c||src/libopensc/pkcs15-tcos.c": [
          "File: src/libopensc/pkcs15-tcos.c -> src/libopensc/pkcs15-tcos.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "225:  pin_obj.auth_id.len      = auth_id ? 0 : 1;",
          "226:  pin_obj.auth_id.value[0] = auth_id;",
          "229:   unsigned char buf[256];",
          "230:   int i, rec_no=0;",
          "232:   sc_append_file_id(&pin_info.path, 0x5049);",
          "234:    sc_log(ctx,",
          "235:     \"Select(%s) failed\\n\",",
          "236:     sc_print_path(&pin_info.path));",
          "",
          "[Removed Lines]",
          "228:  if(card->type==SC_CARD_TYPE_TCOS_V3){",
          "231:   if(pin_info.path.len>=2) pin_info.path.len-=2;",
          "233:   if(sc_select_file(card, &pin_info.path, NULL)!=SC_SUCCESS){",
          "",
          "[Added Lines]",
          "228:  if(card->type == SC_CARD_TYPE_TCOS_V3) {",
          "231:   if (pin_info.path.len >= 2) {",
          "232:    pin_info.path.len -= 2;",
          "233:   }",
          "235:   if (sc_select_file(card, &pin_info.path, NULL) != SC_SUCCESS) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "238:   }",
          "239:   sc_log(ctx,",
          "240:    \"Searching for PIN-Ref %02X\\n\", pin_reference);",
          "247:    }",
          "250:   }",
          "252:    sc_log(ctx, \"No EF_PWDD-Record found\\n\");",
          "253:    return 1;",
          "254:   }",
          "",
          "[Removed Lines]",
          "241:   while((r=sc_read_record(card, ++rec_no, buf, sizeof(buf), SC_RECORD_BY_REC_NR))>0){",
          "242:    int found=0, fbz=-1;",
          "243:    if(buf[0]!=0xA0) continue;",
          "244:    for(i=2;i<buf[1]+2;i+=2+buf[i+1]){",
          "245:     if(buf[i]==0x83 && buf[i+1]==1 && buf[i+2]==pin_reference) ++found;",
          "246:     if(buf[i]==0x90) fbz=buf[i+1+buf[i+1]];",
          "248:    if(found) pin_info.tries_left=fbz;",
          "249:    if(found) break;",
          "251:   if(r<=0){",
          "",
          "[Added Lines]",
          "243:   while ((r = sc_read_record(card, ++rec_no, buf, sizeof(buf), SC_RECORD_BY_REC_NR)) > 0) {",
          "244:    int found = 0, fbz = -1;",
          "245:    if (buf[0] != 0xA0)",
          "246:     continue;",
          "247:    for (i = 2; i < buf[1] + 2; i += 2 + buf[i + 1]) {",
          "248:     if (buf[i] == 0x83 && buf[i + 1] == 1 && buf[i + 2] == pin_reference) {",
          "249:      ++found;",
          "250:     }",
          "251:     if (buf[i] == 0x90) {",
          "252:      fbz = buf[i + 1 + buf[i + 1]];",
          "253:     }",
          "254:    }",
          "255:    if (found) {",
          "256:     pin_info.tries_left = fbz;",
          "257:     break;",
          "260:   if (r <= 0) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "259:    sc_file_free(f);",
          "260:    return 1;",
          "261:   }",
          "263:   sc_file_free(f);",
          "264:  }",
          "",
          "[Removed Lines]",
          "262:   pin_info.tries_left=f->prop_attr[3];",
          "",
          "[Added Lines]",
          "271:   pin_info.tries_left = f->prop_attr[3];",
          "",
          "---------------"
        ]
      }
    }
  ]
}