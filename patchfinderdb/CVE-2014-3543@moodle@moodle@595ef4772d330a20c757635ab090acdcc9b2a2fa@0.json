{
  "cve_id": "CVE-2014-3543",
  "cve_desc": "mod/imscp/locallib.php in Moodle through 2.3.11, 2.4.x before 2.4.11, 2.5.x before 2.5.7, 2.6.x before 2.6.4, and 2.7.x before 2.7.1 allows remote attackers to read arbitrary files via a package with a manifest file containing an XML external entity declaration in conjunction with an entity reference, related to an XML External Entity (XXE) issue affecting IMSCP resources and the IMSCC format.",
  "repo": "moodle/moodle",
  "patch_hash": "595ef4772d330a20c757635ab090acdcc9b2a2fa",
  "patch_info": {
    "commit_hash": "595ef4772d330a20c757635ab090acdcc9b2a2fa",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/595ef4772d330a20c757635ab090acdcc9b2a2fa",
    "files": [
      "mod/imscp/locallib.php"
    ],
    "message": "MDL-45417 mod_imscp: Prevent entity injections from package content",
    "before_after_code_files": [
      "mod/imscp/locallib.php||mod/imscp/locallib.php"
    ]
  },
  "patch_diff": {
    "mod/imscp/locallib.php||mod/imscp/locallib.php": [
      "File: mod/imscp/locallib.php -> mod/imscp/locallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "105: function imscp_parse_manifestfile($manifestfilecontents, $imscp, $context) {",
      "106:     $doc = new DOMDocument();",
      "107:     if (!$doc->loadXML($manifestfilecontents, LIBXML_NONET)) {",
      "108:         return null;",
      "109:     }",
      "112:     $doc->documentURI = 'http://grrr/';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "107:     $oldentities = libxml_disable_entity_loader(true);",
      "111:     libxml_disable_entity_loader($oldentities);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "204:     if (!$manifestfile = $fs->get_file($context->id, 'mod_imscp', 'content', $imscp->revision, $dirname, $filename)) {",
      "205:         return null;",
      "206:     }",
      "207:     $doc = new DOMDocument();",
      "208:     if (!$doc->loadXML($manifestfile->get_content(), LIBXML_NONET)) {",
      "209:         return null;",
      "210:     }",
      "211:     $xmlresources = $doc->getElementsByTagName('resource');",
      "212:     foreach ($xmlresources as $res) {",
      "213:         if (!$href = $res->attributes->getNamedItem('href')) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "211:     $oldentities = libxml_disable_entity_loader(true);",
      "215:     libxml_disable_entity_loader($oldentities);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bbc12d9cb5efb7210665ab1587d498c8d92f89d2",
      "candidate_info": {
        "commit_hash": "bbc12d9cb5efb7210665ab1587d498c8d92f89d2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bbc12d9cb5efb7210665ab1587d498c8d92f89d2",
        "files": [
          "mod/imscp/locallib.php"
        ],
        "message": "MDL-45417 mod_imscp: Prevent entity injections from package content",
        "before_after_code_files": [
          "mod/imscp/locallib.php||mod/imscp/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ],
          "candidate": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/imscp/locallib.php||mod/imscp/locallib.php": [
          "File: mod/imscp/locallib.php -> mod/imscp/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "106: function imscp_parse_manifestfile($manifestfilecontents, $imscp, $context) {",
          "107:     $doc = new DOMDocument();",
          "108:     if (!$doc->loadXML($manifestfilecontents, LIBXML_NONET)) {",
          "109:         return null;",
          "110:     }",
          "113:     $doc->documentURI = 'http://grrr/';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:     $oldentities = libxml_disable_entity_loader(true);",
          "112:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "205:     if (!$manifestfile = $fs->get_file($context->id, 'mod_imscp', 'content', $imscp->revision, $dirname, $filename)) {",
          "206:         return null;",
          "207:     }",
          "208:     $doc = new DOMDocument();",
          "209:     if (!$doc->loadXML($manifestfile->get_content(), LIBXML_NONET)) {",
          "210:         return null;",
          "211:     }",
          "212:     $xmlresources = $doc->getElementsByTagName('resource');",
          "213:     foreach ($xmlresources as $res) {",
          "214:         if (!$href = $res->attributes->getNamedItem('href')) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "212:     $oldentities = libxml_disable_entity_loader(true);",
          "216:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1d110af2d6fc5d16dda6c2d90add3e8c5b5829be",
      "candidate_info": {
        "commit_hash": "1d110af2d6fc5d16dda6c2d90add3e8c5b5829be",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1d110af2d6fc5d16dda6c2d90add3e8c5b5829be",
        "files": [
          "mod/imscp/locallib.php"
        ],
        "message": "MDL-45417 mod_imscp: Prevent entity injections from package content",
        "before_after_code_files": [
          "mod/imscp/locallib.php||mod/imscp/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ],
          "candidate": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/imscp/locallib.php||mod/imscp/locallib.php": [
          "File: mod/imscp/locallib.php -> mod/imscp/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "105: function imscp_parse_manifestfile($manifestfilecontents, $imscp, $context) {",
          "106:     $doc = new DOMDocument();",
          "107:     if (!$doc->loadXML($manifestfilecontents, LIBXML_NONET)) {",
          "108:         return null;",
          "109:     }",
          "112:     $doc->documentURI = 'http://grrr/';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "107:     $oldentities = libxml_disable_entity_loader(true);",
          "111:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "204:     if (!$manifestfile = $fs->get_file($context->id, 'mod_imscp', 'content', $imscp->revision, $dirname, $filename)) {",
          "205:         return null;",
          "206:     }",
          "207:     $doc = new DOMDocument();",
          "208:     if (!$doc->loadXML($manifestfile->get_content(), LIBXML_NONET)) {",
          "209:         return null;",
          "210:     }",
          "211:     $xmlresources = $doc->getElementsByTagName('resource');",
          "212:     foreach ($xmlresources as $res) {",
          "213:         if (!$href = $res->attributes->getNamedItem('href')) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "211:     $oldentities = libxml_disable_entity_loader(true);",
          "215:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "01cf8fdd9cb75091f1688243012c7a236c110bee",
      "candidate_info": {
        "commit_hash": "01cf8fdd9cb75091f1688243012c7a236c110bee",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/01cf8fdd9cb75091f1688243012c7a236c110bee",
        "files": [
          "mod/imscp/locallib.php"
        ],
        "message": "MDL-45417 mod_imscp: Prevent entity injections from package content",
        "before_after_code_files": [
          "mod/imscp/locallib.php||mod/imscp/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ],
          "candidate": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/imscp/locallib.php||mod/imscp/locallib.php": [
          "File: mod/imscp/locallib.php -> mod/imscp/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "106: function imscp_parse_manifestfile($manifestfilecontents, $imscp, $context) {",
          "107:     $doc = new DOMDocument();",
          "108:     if (!$doc->loadXML($manifestfilecontents, LIBXML_NONET)) {",
          "109:         return null;",
          "110:     }",
          "113:     $doc->documentURI = 'http://grrr/';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:     $oldentities = libxml_disable_entity_loader(true);",
          "112:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "205:     if (!$manifestfile = $fs->get_file($context->id, 'mod_imscp', 'content', $imscp->revision, $dirname, $filename)) {",
          "206:         return null;",
          "207:     }",
          "208:     $doc = new DOMDocument();",
          "209:     if (!$doc->loadXML($manifestfile->get_content(), LIBXML_NONET)) {",
          "210:         return null;",
          "211:     }",
          "212:     $xmlresources = $doc->getElementsByTagName('resource');",
          "213:     foreach ($xmlresources as $res) {",
          "214:         if (!$href = $res->attributes->getNamedItem('href')) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "212:     $oldentities = libxml_disable_entity_loader(true);",
          "216:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9b60a086cfdc35c53f38ad678b9bef1dd656348c",
      "candidate_info": {
        "commit_hash": "9b60a086cfdc35c53f38ad678b9bef1dd656348c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9b60a086cfdc35c53f38ad678b9bef1dd656348c",
        "files": [
          "mod/imscp/locallib.php"
        ],
        "message": "MDL-45417 mod_imscp: Prevent entity injections from package content",
        "before_after_code_files": [
          "mod/imscp/locallib.php||mod/imscp/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ],
          "candidate": [
            "mod/imscp/locallib.php||mod/imscp/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/imscp/locallib.php||mod/imscp/locallib.php": [
          "File: mod/imscp/locallib.php -> mod/imscp/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "106: function imscp_parse_manifestfile($manifestfilecontents) {",
          "107:     $doc = new DOMDocument();",
          "108:     if (!$doc->loadXML($manifestfilecontents, LIBXML_NONET)) {",
          "109:         return null;",
          "110:     }",
          "113:     $doc->documentURI = 'http://grrr/';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:     $oldentities = libxml_disable_entity_loader(true);",
          "112:     libxml_disable_entity_loader($oldentities);",
          "",
          "---------------"
        ]
      }
    }
  ]
}