{
  "cve_id": "CVE-2021-3671",
  "cve_desc": "A null pointer de-reference was found in the way samba kerberos server handled missing sname in TGS-REQ (Ticket Granting Server - Request). An authenticated user could use this flaw to crash the samba server.",
  "repo": "heimdal/heimdal",
  "patch_hash": "04171147948d0a3636bc6374181926f0fb2ec83a",
  "patch_info": {
    "commit_hash": "04171147948d0a3636bc6374181926f0fb2ec83a",
    "repo": "heimdal/heimdal",
    "commit_url": "https://github.com/heimdal/heimdal/commit/04171147948d0a3636bc6374181926f0fb2ec83a",
    "files": [
      "kdc/krb5tgs.c"
    ],
    "message": "kdc: validate sname in TGS-REQ\n\nIn tgs_build_reply(), validate the server name in the TGS-REQ is present before\ndereferencing.",
    "before_after_code_files": [
      "kdc/krb5tgs.c||kdc/krb5tgs.c"
    ]
  },
  "patch_diff": {
    "kdc/krb5tgs.c||kdc/krb5tgs.c": [
      "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1700:  s = &adtkt.cname;",
      "1701:  r = adtkt.crealm;",
      "1702:     }",
      "1704:     _krb5_principalname2krb5_principal(context, &sp, *s, r);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1702:     } else if (s == NULL) {",
      "1703:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
      "1704:  _kdc_set_e_text(r, \"No server in request\");",
      "1705:  goto out;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "278d9738cf91ec7ae5e28b929553757b3f01235f",
      "candidate_info": {
        "commit_hash": "278d9738cf91ec7ae5e28b929553757b3f01235f",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/278d9738cf91ec7ae5e28b929553757b3f01235f",
        "files": [
          "kdc/krb5tgs.c"
        ],
        "message": "kdc: validate sname in TGS-REQ\n\nIn tgs_build_reply(), validate the server name in the TGS-REQ is present before\ndereferencing.\n\n(cherry picked from commit 04171147948d0a3636bc6374181926f0fb2ec83a)\n\nChange-Id: Ied76c1483a3f6e9f0be779d8d20ca80a180da4f1",
        "before_after_code_files": [
          "kdc/krb5tgs.c||kdc/krb5tgs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ]
        }
      },
      "candidate_diff": {
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1667:  s = &adtkt.cname;",
          "1668:  r = adtkt.crealm;",
          "1669:     }",
          "1671:     _krb5_principalname2krb5_principal(context, &sp, *s, r);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1669:     } else if (s == NULL) {",
          "1670:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
          "1671:  _kdc_set_e_text(r, \"No server in request\");",
          "1672:  goto out;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "68f7b8a8d0168d1fdf77bfacc06a4fa19d2bfc5d",
      "candidate_info": {
        "commit_hash": "68f7b8a8d0168d1fdf77bfacc06a4fa19d2bfc5d",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/68f7b8a8d0168d1fdf77bfacc06a4fa19d2bfc5d",
        "files": [
          "kdc/krb5tgs.c"
        ],
        "message": "kdc: validate sname in TGS-REQ\n\nIn tgs_build_reply(), validate the server name in the TGS-REQ is present before\ndereferencing.\n\n(cherry picked from commit 04171147948d0a3636bc6374181926f0fb2ec83a)\n\nChange-Id: Ied76c1483a3f6e9f0be779d8d20ca80a180da4f1",
        "before_after_code_files": [
          "kdc/krb5tgs.c||kdc/krb5tgs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ]
        }
      },
      "candidate_diff": {
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1667:  s = &adtkt.cname;",
          "1668:  r = adtkt.crealm;",
          "1669:     }",
          "1671:     _krb5_principalname2krb5_principal(context, &sp, *s, r);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1669:     } else if (s == NULL) {",
          "1670:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
          "1671:  _kdc_set_e_text(r, \"No server in request\");",
          "1672:  goto out;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fb3ea5b9437eb1e2df6e80c6b26d6982c95d2409",
      "candidate_info": {
        "commit_hash": "fb3ea5b9437eb1e2df6e80c6b26d6982c95d2409",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/fb3ea5b9437eb1e2df6e80c6b26d6982c95d2409",
        "files": [
          "kdc/bx509d.c",
          "kdc/fast.c",
          "kdc/httpkadmind.c",
          "kdc/kerberos5.c",
          "kdc/krb5tgs.c",
          "kdc/process.c"
        ],
        "message": "kdc: Add ret to common svc req elements\n\nWe're logging SUCCESS even when the KDC sends error replies.  That's\nbecause we're returning success to process_request() even when we send\nerrors to clients.  The error we want to send to the client, and that we\nsucceed or fail to send it, are different statuses.\n\nAlso, further move things into `r` and out of function arguments.",
        "before_after_code_files": [
          "kdc/bx509d.c||kdc/bx509d.c",
          "kdc/fast.c||kdc/fast.c",
          "kdc/httpkadmind.c||kdc/httpkadmind.c",
          "kdc/kerberos5.c||kdc/kerberos5.c",
          "kdc/krb5tgs.c||kdc/krb5tgs.c",
          "kdc/process.c||kdc/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ]
        }
      },
      "candidate_diff": {
        "kdc/bx509d.c||kdc/bx509d.c": [
          "File: kdc/bx509d.c -> kdc/bx509d.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "126:     char *ccname;",
          "127:     char *freeme1;",
          "130:     char frombuf[128];",
          "131: } *bx509_request_desc;",
          "",
          "[Removed Lines]",
          "129:     krb5_error_code ret;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kdc/fast.c||kdc/fast.c": [
          "File: kdc/fast.c -> kdc/fast.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "328:      krb5_crypto armor_crypto,",
          "329:      const KDC_REQ_BODY *req_body,",
          "330:      krb5_error_code outer_error,",
          "332:      krb5_principal error_client,",
          "333:      krb5_principal error_server,",
          "334:      time_t *csec, int *cusec,",
          "",
          "[Removed Lines]",
          "331:      const char *e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "370:  ret = krb5_mk_error(r->context,",
          "371:        outer_error,",
          "373:        NULL,",
          "374:        error_client,",
          "375:        error_server,",
          "",
          "[Removed Lines]",
          "372:        e_text,",
          "",
          "[Added Lines]",
          "371:        r->e_text,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "393:  }",
          "395:  outer_error = KRB5_KDC_ERR_MORE_PREAUTH_DATA_REQUIRED;",
          "397:  if (r->fast.flags.requested_hidden_names) {",
          "398:      error_client = NULL;",
          "399:      error_server = NULL;",
          "",
          "[Removed Lines]",
          "396:  e_text = NULL;",
          "",
          "[Added Lines]",
          "395:  r->e_text = NULL;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "436:     ret = krb5_mk_error(r->context,",
          "437:    outer_error,",
          "439:    (e_data.length ? &e_data : NULL),",
          "440:    error_client,",
          "441:    error_server,",
          "",
          "[Removed Lines]",
          "438:    e_text,",
          "",
          "[Added Lines]",
          "437:    r->e_text,",
          "",
          "---------------"
        ],
        "kdc/httpkadmind.c||kdc/httpkadmind.c": [
          "File: kdc/httpkadmind.c -> kdc/httpkadmind.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "119:     HEIM_SVC_REQUEST_DESC_COMMON_ELEMENTS;",
          "121:     struct MHD_Connection *connection;",
          "123:     krb5_times token_times;",
          "",
          "[Removed Lines]",
          "122:     krb5_error_code ret;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kdc/kerberos5.c||kdc/kerberos5.c": [
          "File: kdc/kerberos5.c -> kdc/kerberos5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "418:     va_end(ap);",
          "419: }",
          "421: void",
          "422: _kdc_set_e_text(astgs_request_t r, const char *fmt, ...)",
          "423:  __attribute__ ((__format__ (__printf__, 2, 3)))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "421: void",
          "422: _kdc_set_const_e_text(astgs_request_t r, const char *e_text)",
          "423: {",
          "425:     if (r->e_text) {",
          "426:  kdc_log(r->context, r->config, 1,",
          "427:                 \"trying to replace e-text \\\"%s\\\" with \\\"%s\\\"\\n\",",
          "428:   r->e_text, e_text);",
          "429:  return;",
          "430:     }",
          "432:     r->e_text = e_text;",
          "433:     kdc_log(r->context, r->config, 4, \"%s\", e_text);",
          "434: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "430:     vasprintf_ret = vasprintf(&e_text, fmt, ap);",
          "431:     va_end(ap);",
          "435:  return;",
          "438:     if (r->e_text) {",
          "",
          "[Removed Lines]",
          "433:     if (vasprintf_ret < 0 || !e_text)",
          "",
          "[Added Lines]",
          "448:     if (vasprintf_ret < 0 || !e_text) {",
          "450:         kdc_log(r->context, r->config, 1,",
          "451:                 \"Could not set e_text: %s (out of memory)\", fmt);",
          "453:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2190:   r->cname, fixed_client_name);",
          "2191:  free(fixed_client_name);",
          "2193:  ret = _kdc_fast_mk_error(r, r->rep.padata, r->armor_crypto,",
          "2196:      r->client->entry.principal, r->server_princ,",
          "2197:      NULL, NULL, r->reply);",
          "2198:  goto out;",
          "",
          "[Removed Lines]",
          "2194:      &req->req_body, KRB5_KDC_ERR_WRONG_REALM,",
          "2195:      NULL,",
          "",
          "[Added Lines]",
          "2211:         r->e_text = NULL;",
          "2213:      &req->req_body,",
          "2214:                                  r->ret = KRB5_KDC_ERR_WRONG_REALM,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2776:      r->rep.padata,",
          "2777:             r->armor_crypto,",
          "2778:             &req->req_body,",
          "2780:             r->client_princ,",
          "2781:             r->server_princ,",
          "2782:             NULL, NULL,",
          "",
          "[Removed Lines]",
          "2779:             ret, r->e_text,",
          "",
          "[Added Lines]",
          "2798:             r->ret = ret,",
          "",
          "---------------"
        ],
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "859:    krb5_kdc_configuration *config,",
          "860:                  krb5_auth_context ac,",
          "861:    KDC_REQ_BODY *b,",
          "863:    krb5_keyblock *key)",
          "864: {",
          "865:     krb5_authenticator auth;",
          "",
          "[Removed Lines]",
          "862:    const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "982:     hdb_entry_ex **krbtgt,",
          "983:     krb5_enctype *krbtgt_etype,",
          "984:     krb5_ticket **ticket,",
          "986:     const char *from,",
          "987:     const struct sockaddr *from_addr,",
          "988:     time_t **csec,",
          "",
          "[Removed Lines]",
          "985:     const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1183:  }",
          "1184:     }",
          "1188:     if (ret) {",
          "1189:  krb5_auth_con_free(r->context, ac);",
          "1190:  goto out;",
          "",
          "[Removed Lines]",
          "1186:     ret = tgs_check_authenticator(r->context, config,",
          "1187:       ac, b, e_text, &(*ticket)->ticket.key);",
          "",
          "[Added Lines]",
          "1184:     ret = tgs_check_authenticator(r->context, config, ac, b,",
          "1185:                                   &(*ticket)->ticket.key);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1426:   hdb_entry_ex *krbtgt,",
          "1427:   krb5_enctype krbtgt_etype,",
          "1428:   krb5_ticket *ticket,",
          "1430:   AuthorizationData **auth_data,",
          "1431:   const struct sockaddr *from_addr)",
          "1432: {",
          "",
          "[Removed Lines]",
          "1429:   const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1491:     if (s == NULL) {",
          "1492:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
          "1494:  goto out;",
          "1495:     }",
          "",
          "[Removed Lines]",
          "1493:  _kdc_set_e_text(priv, \"No server in request\");",
          "",
          "[Added Lines]",
          "1490:         _kdc_set_const_e_text(priv, \"No server in request\");",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2499:     hdb_entry_ex *krbtgt = NULL;",
          "2500:     krb5_ticket *ticket = NULL;",
          "2502:     krb5_enctype krbtgt_etype = ETYPE_NULL;",
          "2504:     time_t *csec = NULL;",
          "2505:     int *cusec = NULL;",
          "2507:     if(req->padata == NULL){",
          "2509:  kdc_log(r->context, config, 4,",
          "",
          "[Removed Lines]",
          "2501:     const char *e_text = NULL;",
          "",
          "[Added Lines]",
          "2503:     r->e_text = NULL;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2532:        &krbtgt,",
          "2533:        &krbtgt_etype,",
          "2534:        &ticket,",
          "2536:        from, from_addr,",
          "2537:        &csec, &cusec,",
          "2538:        &auth_data);",
          "",
          "[Removed Lines]",
          "2535:        &e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2561:      krbtgt,",
          "2562:      krbtgt_etype,",
          "2563:      ticket,",
          "2565:      &auth_data,",
          "2566:      from_addr);",
          "2567:     if (ret) {",
          "",
          "[Removed Lines]",
          "2564:      &e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2574:     if (datagram_reply && data->length > config->max_datagram_reply_length) {",
          "2575:  krb5_data_free(data);",
          "2576:  ret = KRB5KRB_ERR_RESPONSE_TOO_BIG;",
          "2578:     }",
          "2580: out:",
          "",
          "[Removed Lines]",
          "2577:  e_text = \"Reply packet too large\";",
          "",
          "[Added Lines]",
          "2573:         _kdc_set_const_e_text(r, \"Reply packet too large\");",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2586:      &error_method,",
          "2587:      r->armor_crypto,",
          "2588:      &req->req_body,",
          "2590:      ticket != NULL ? ticket->client : NULL,",
          "2591:      ticket != NULL ? ticket->server : NULL,",
          "2592:      csec, cusec,",
          "",
          "[Removed Lines]",
          "2589:      ret, r->e_text,",
          "",
          "[Added Lines]",
          "2585:      r->ret = ret,",
          "",
          "---------------"
        ],
        "kdc/process.c||kdc/process.c": [
          "File: kdc/process.c -> kdc/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "127: #define CASE(x) case x : retname = #x; break",
          "129:     CASE(ENOMEM);",
          "130:     CASE(EACCES);",
          "131:     CASE(HDB_ERR_NOT_FOUND_HERE);",
          "",
          "[Removed Lines]",
          "128:     switch (ret) {",
          "",
          "[Added Lines]",
          "128:     switch (ret ? ret : r->ret) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "773802aecfb4b6a73817fa522faeb55b2a7cdb2a",
      "candidate_info": {
        "commit_hash": "773802aecfb4b6a73817fa522faeb55b2a7cdb2a",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/773802aecfb4b6a73817fa522faeb55b2a7cdb2a",
        "files": [
          "kdc/krb5tgs.c"
        ],
        "message": "kdc: fix _kdc_set_e_text argument in previous commit\n\n\"r\" is the realm, not the TGS request; that is priv",
        "before_after_code_files": [
          "kdc/krb5tgs.c||kdc/krb5tgs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ]
        }
      },
      "candidate_diff": {
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1701:  r = adtkt.crealm;",
          "1702:     } else if (s == NULL) {",
          "1703:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
          "1705:  goto out;",
          "1706:     }",
          "",
          "[Removed Lines]",
          "1704:  _kdc_set_e_text(r, \"No server in request\");",
          "",
          "[Added Lines]",
          "1704:  _kdc_set_e_text(priv, \"No server in request\");",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3b62c73bbcd744a736df3277bacdffd4e355f77a",
      "candidate_info": {
        "commit_hash": "3b62c73bbcd744a736df3277bacdffd4e355f77a",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/3b62c73bbcd744a736df3277bacdffd4e355f77a",
        "files": [
          "kdc/bx509d.c",
          "kdc/fast.c",
          "kdc/httpkadmind.c",
          "kdc/kerberos5.c",
          "kdc/krb5tgs.c",
          "kdc/process.c"
        ],
        "message": "kdc: Add ret to common svc req elements\n\nWe're logging SUCCESS even when the KDC sends error replies.  That's\nbecause we're returning success to process_request() even when we send\nerrors to clients.  The error we want to send to the client, and that we\nsucceed or fail to send it, are different statuses.\n\nAlso, further move things into `r` and out of function arguments.",
        "before_after_code_files": [
          "kdc/bx509d.c||kdc/bx509d.c",
          "kdc/fast.c||kdc/fast.c",
          "kdc/httpkadmind.c||kdc/httpkadmind.c",
          "kdc/kerberos5.c||kdc/kerberos5.c",
          "kdc/krb5tgs.c||kdc/krb5tgs.c",
          "kdc/process.c||kdc/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c"
          ]
        }
      },
      "candidate_diff": {
        "kdc/bx509d.c||kdc/bx509d.c": [
          "File: kdc/bx509d.c -> kdc/bx509d.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "126:     char *ccname;",
          "127:     char *freeme1;",
          "130:     char frombuf[128];",
          "131: } *bx509_request_desc;",
          "",
          "[Removed Lines]",
          "129:     krb5_error_code ret;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kdc/fast.c||kdc/fast.c": [
          "File: kdc/fast.c -> kdc/fast.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "328:      krb5_crypto armor_crypto,",
          "329:      const KDC_REQ_BODY *req_body,",
          "330:      krb5_error_code outer_error,",
          "332:      krb5_principal error_client,",
          "333:      krb5_principal error_server,",
          "334:      time_t *csec, int *cusec,",
          "",
          "[Removed Lines]",
          "331:      const char *e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "370:  ret = krb5_mk_error(r->context,",
          "371:        outer_error,",
          "373:        NULL,",
          "374:        error_client,",
          "375:        error_server,",
          "",
          "[Removed Lines]",
          "372:        e_text,",
          "",
          "[Added Lines]",
          "371:        r->e_text,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "393:  }",
          "395:  outer_error = KRB5_KDC_ERR_MORE_PREAUTH_DATA_REQUIRED;",
          "397:  if (r->fast.flags.requested_hidden_names) {",
          "398:      error_client = NULL;",
          "399:      error_server = NULL;",
          "",
          "[Removed Lines]",
          "396:  e_text = NULL;",
          "",
          "[Added Lines]",
          "395:  r->e_text = NULL;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "436:     ret = krb5_mk_error(r->context,",
          "437:    outer_error,",
          "439:    (e_data.length ? &e_data : NULL),",
          "440:    error_client,",
          "441:    error_server,",
          "",
          "[Removed Lines]",
          "438:    e_text,",
          "",
          "[Added Lines]",
          "437:    r->e_text,",
          "",
          "---------------"
        ],
        "kdc/httpkadmind.c||kdc/httpkadmind.c": [
          "File: kdc/httpkadmind.c -> kdc/httpkadmind.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "119:     HEIM_SVC_REQUEST_DESC_COMMON_ELEMENTS;",
          "121:     struct MHD_Connection *connection;",
          "123:     krb5_times token_times;",
          "",
          "[Removed Lines]",
          "122:     krb5_error_code ret;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kdc/kerberos5.c||kdc/kerberos5.c": [
          "File: kdc/kerberos5.c -> kdc/kerberos5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "418:     va_end(ap);",
          "419: }",
          "421: void",
          "422: _kdc_set_e_text(astgs_request_t r, const char *fmt, ...)",
          "423:  __attribute__ ((__format__ (__printf__, 2, 3)))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "421: void",
          "422: _kdc_set_const_e_text(astgs_request_t r, const char *e_text)",
          "423: {",
          "425:     if (r->e_text) {",
          "426:  kdc_log(r->context, r->config, 1,",
          "427:                 \"trying to replace e-text \\\"%s\\\" with \\\"%s\\\"\\n\",",
          "428:   r->e_text, e_text);",
          "429:  return;",
          "430:     }",
          "432:     r->e_text = e_text;",
          "433:     kdc_log(r->context, r->config, 4, \"%s\", e_text);",
          "434: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "430:     vasprintf_ret = vasprintf(&e_text, fmt, ap);",
          "431:     va_end(ap);",
          "435:  return;",
          "438:     if (r->e_text) {",
          "",
          "[Removed Lines]",
          "433:     if (vasprintf_ret < 0 || !e_text)",
          "",
          "[Added Lines]",
          "448:     if (vasprintf_ret < 0 || !e_text) {",
          "450:         kdc_log(r->context, r->config, 1,",
          "451:                 \"Could not set e_text: %s (out of memory)\", fmt);",
          "453:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2190:   r->cname, fixed_client_name);",
          "2191:  free(fixed_client_name);",
          "2193:  ret = _kdc_fast_mk_error(r, r->rep.padata, r->armor_crypto,",
          "2196:      r->client->entry.principal, r->server_princ,",
          "2197:      NULL, NULL, r->reply);",
          "2198:  goto out;",
          "",
          "[Removed Lines]",
          "2194:      &req->req_body, KRB5_KDC_ERR_WRONG_REALM,",
          "2195:      NULL,",
          "",
          "[Added Lines]",
          "2211:         r->e_text = NULL;",
          "2213:      &req->req_body,",
          "2214:                                  r->ret = KRB5_KDC_ERR_WRONG_REALM,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2776:      r->rep.padata,",
          "2777:             r->armor_crypto,",
          "2778:             &req->req_body,",
          "2780:             r->client_princ,",
          "2781:             r->server_princ,",
          "2782:             NULL, NULL,",
          "",
          "[Removed Lines]",
          "2779:             ret, r->e_text,",
          "",
          "[Added Lines]",
          "2798:             r->ret = ret,",
          "",
          "---------------"
        ],
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "859:    krb5_kdc_configuration *config,",
          "860:                  krb5_auth_context ac,",
          "861:    KDC_REQ_BODY *b,",
          "863:    krb5_keyblock *key)",
          "864: {",
          "865:     krb5_authenticator auth;",
          "",
          "[Removed Lines]",
          "862:    const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "982:     hdb_entry_ex **krbtgt,",
          "983:     krb5_enctype *krbtgt_etype,",
          "984:     krb5_ticket **ticket,",
          "986:     const char *from,",
          "987:     const struct sockaddr *from_addr,",
          "988:     time_t **csec,",
          "",
          "[Removed Lines]",
          "985:     const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1183:  }",
          "1184:     }",
          "1188:     if (ret) {",
          "1189:  krb5_auth_con_free(r->context, ac);",
          "1190:  goto out;",
          "",
          "[Removed Lines]",
          "1186:     ret = tgs_check_authenticator(r->context, config,",
          "1187:       ac, b, e_text, &(*ticket)->ticket.key);",
          "",
          "[Added Lines]",
          "1184:     ret = tgs_check_authenticator(r->context, config, ac, b,",
          "1185:                                   &(*ticket)->ticket.key);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1426:   hdb_entry_ex *krbtgt,",
          "1427:   krb5_enctype krbtgt_etype,",
          "1428:   krb5_ticket *ticket,",
          "1430:   AuthorizationData **auth_data,",
          "1431:   const struct sockaddr *from_addr)",
          "1432: {",
          "",
          "[Removed Lines]",
          "1429:   const char **e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1491:     if (s == NULL) {",
          "1492:  ret = KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN;",
          "1494:  goto out;",
          "1495:     }",
          "",
          "[Removed Lines]",
          "1493:  _kdc_set_e_text(priv, \"No server in request\");",
          "",
          "[Added Lines]",
          "1490:         _kdc_set_const_e_text(priv, \"No server in request\");",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2499:     hdb_entry_ex *krbtgt = NULL;",
          "2500:     krb5_ticket *ticket = NULL;",
          "2502:     krb5_enctype krbtgt_etype = ETYPE_NULL;",
          "2504:     time_t *csec = NULL;",
          "2505:     int *cusec = NULL;",
          "2507:     if(req->padata == NULL){",
          "2509:  kdc_log(r->context, config, 4,",
          "",
          "[Removed Lines]",
          "2501:     const char *e_text = NULL;",
          "",
          "[Added Lines]",
          "2503:     r->e_text = NULL;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2532:        &krbtgt,",
          "2533:        &krbtgt_etype,",
          "2534:        &ticket,",
          "2536:        from, from_addr,",
          "2537:        &csec, &cusec,",
          "2538:        &auth_data);",
          "",
          "[Removed Lines]",
          "2535:        &e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2561:      krbtgt,",
          "2562:      krbtgt_etype,",
          "2563:      ticket,",
          "2565:      &auth_data,",
          "2566:      from_addr);",
          "2567:     if (ret) {",
          "",
          "[Removed Lines]",
          "2564:      &e_text,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2574:     if (datagram_reply && data->length > config->max_datagram_reply_length) {",
          "2575:  krb5_data_free(data);",
          "2576:  ret = KRB5KRB_ERR_RESPONSE_TOO_BIG;",
          "2578:     }",
          "2580: out:",
          "",
          "[Removed Lines]",
          "2577:  e_text = \"Reply packet too large\";",
          "",
          "[Added Lines]",
          "2573:         _kdc_set_const_e_text(r, \"Reply packet too large\");",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2586:      &error_method,",
          "2587:      r->armor_crypto,",
          "2588:      &req->req_body,",
          "2590:      ticket != NULL ? ticket->client : NULL,",
          "2591:      ticket != NULL ? ticket->server : NULL,",
          "2592:      csec, cusec,",
          "",
          "[Removed Lines]",
          "2589:      ret, r->e_text,",
          "",
          "[Added Lines]",
          "2585:      r->ret = ret,",
          "",
          "---------------"
        ],
        "kdc/process.c||kdc/process.c": [
          "File: kdc/process.c -> kdc/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "127: #define CASE(x) case x : retname = #x; break",
          "129:     CASE(ENOMEM);",
          "130:     CASE(EACCES);",
          "131:     CASE(HDB_ERR_NOT_FOUND_HERE);",
          "",
          "[Removed Lines]",
          "128:     switch (ret) {",
          "",
          "[Added Lines]",
          "128:     switch (ret ? ret : r->ret) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}