{
  "cve_id": "CVE-2017-1000504",
  "cve_desc": "A race condition during Jenkins 2.94 and earlier; 2.89.1 and earlier startup could result in the wrong order of execution of commands during initialization. There is a very short window of time after startup during which Jenkins may no longer show the 'Please wait while Jenkins is getting ready to work' message but Cross-Site Request Forgery (CSRF) protection may not yet be effective.",
  "repo": "jenkinsci/jenkins",
  "patch_hash": "ccc374a7176d7704941fb494589790b7673efe2e",
  "patch_info": {
    "commit_hash": "ccc374a7176d7704941fb494589790b7673efe2e",
    "repo": "jenkinsci/jenkins",
    "commit_url": "https://github.com/jenkinsci/jenkins/commit/ccc374a7176d7704941fb494589790b7673efe2e",
    "files": [
      "core/src/main/java/jenkins/model/Jenkins.java"
    ],
    "message": "[SECURITY-667] Ensure all tasks have completed before we attain COMPLETED.",
    "before_after_code_files": [
      "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java": [
      "File: core/src/main/java/jenkins/model/Jenkins.java -> core/src/main/java/jenkins/model/Jenkins.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "3097:             });",
      "3098:         }",
      "3101:             public void run(Reactor reactor) throws Exception {",
      "",
      "[Removed Lines]",
      "3100:         g.requires(JOB_LOADED).add(\"Cleaning up obsolete items deleted from the disk\", new Executable() {",
      "",
      "[Added Lines]",
      "3100:         g.requires(JOB_LOADED).attains(COMPLETED).add(\"Cleaning up obsolete items deleted from the disk\", new Executable() {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3112:             }",
      "3113:         });",
      "3116:             public void run(Reactor session) throws Exception {",
      "3117:                 rebuildDependencyGraph();",
      "",
      "[Removed Lines]",
      "3115:         g.requires(JOB_LOADED).add(\"Finalizing set up\",new Executable() {",
      "",
      "[Added Lines]",
      "3115:         g.requires(JOB_LOADED).attains(COMPLETED).add(\"Finalizing set up\",new Executable() {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0311b2dffa76ba01748b1be6a18fc7c1955e65fe",
      "candidate_info": {
        "commit_hash": "0311b2dffa76ba01748b1be6a18fc7c1955e65fe",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/0311b2dffa76ba01748b1be6a18fc7c1955e65fe",
        "files": [
          "core/src/main/java/jenkins/model/Jenkins.java",
          "test/src/test/java/jenkins/model/JenkinsTest.java",
          "test/src/test/resources/plugins/jenkins-47406.hpi"
        ],
        "message": "[FIXES JENKINS-47406] Milestone JOB_LOADED is now attained after cleaning up obsolete items (#3078)\n\n* [FIXES JENKINS-47406] Milestone JOB_LOADED is now attained after cleaning up obsolete items\n\nThis allows @Initializer(after=InitMilestone.JOB_LOADED) implementations\nto create items safely without risking them to be removed.\n\n* [JENKINS-47406] Add test with an initializer creating a job\n\n* Revert \"[FIXES JENKINS-47406] Milestone JOB_LOADED is now attained after cleaning up obsolete items\"\n\nThis reverts commit 79ce796b00fde11fda586c9c9e2b8e93a53e2b31.\n\n* [JENKINS-47406] Reinstate the test with Jesse's solution\n\n* Reverted this commit by mistake\n\nRevert \"Revert \"[FIXES JENKINS-47406] Milestone JOB_LOADED is now attained after cleaning up obsolete items\"\"\n\nThis reverts commit 36c499c58c83427c7b8a6d3cc5902ec26732b2c7.\n\n* Add link to hpi sources\n\n* Fix Mix-up after the previous merge",
        "before_after_code_files": [
          "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java",
          "test/src/test/java/jenkins/model/JenkinsTest.java||test/src/test/java/jenkins/model/JenkinsTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
          ],
          "candidate": [
            "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
          ]
        }
      },
      "candidate_diff": {
        "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java": [
          "File: core/src/main/java/jenkins/model/Jenkins.java -> core/src/main/java/jenkins/model/Jenkins.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "3054:             }",
          "3055:         });",
          "3057:         for (final File subdir : subdirs) {",
          "3059:                 public void run(Reactor session) throws Exception {",
          "3060:                     if(!Items.getConfigFile(subdir).exists()) {",
          "",
          "[Removed Lines]",
          "3058:             g.requires(loadJenkins).attains(JOB_LOADED).notFatal().add(\"Loading item \" + subdir.getName(), new Executable() {",
          "",
          "[Added Lines]",
          "3057:         List<Handle> loadJobs = new ArrayList<>();",
          "3059:             loadJobs.add(g.requires(loadJenkins).attains(JOB_LOADED).notFatal().add(\"Loading item \" + subdir.getName(), new Executable() {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3065:                     items.put(item.getName(), item);",
          "3066:                     loadedNames.add(item.getName());",
          "3067:                 }",
          "3069:         }",
          "3072:             public void run(Reactor reactor) throws Exception {",
          "",
          "[Removed Lines]",
          "3068:             });",
          "3071:         g.requires(JOB_LOADED).attains(COMPLETED).add(\"Cleaning up obsolete items deleted from the disk\", new Executable() {",
          "",
          "[Added Lines]",
          "3069:             }));",
          "3072:         g.requires(loadJobs.toArray(new Handle[loadJobs.size()])).attains(JOB_LOADED).add(\"Cleaning up obsolete items deleted from the disk\", new Executable() {",
          "",
          "---------------"
        ],
        "test/src/test/java/jenkins/model/JenkinsTest.java||test/src/test/java/jenkins/model/JenkinsTest.java": [
          "File: test/src/test/java/jenkins/model/JenkinsTest.java -> test/src/test/java/jenkins/model/JenkinsTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: package jenkins.model;",
          "26: import static org.hamcrest.MatcherAssert.assertThat;",
          "27: import static org.hamcrest.Matchers.containsString;",
          "28: import static org.hamcrest.Matchers.greaterThan;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: import static hudson.init.InitMilestone.*;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44: import com.gargoylesoftware.htmlunit.html.HtmlForm;",
          "45: import com.gargoylesoftware.htmlunit.html.HtmlPage;",
          "47: import hudson.maven.MavenModuleSet;",
          "48: import hudson.maven.MavenModuleSetBuild;",
          "49: import hudson.model.Computer;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "48: import hudson.init.Initializer;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "72: import org.jvnet.hudson.test.JenkinsRule;",
          "73: import org.jvnet.hudson.test.JenkinsRule.WebClient;",
          "74: import org.jvnet.hudson.test.TestExtension;",
          "75: import org.kohsuke.stapler.HttpResponse;",
          "76: import org.mockito.ArgumentCaptor;",
          "77: import org.mockito.Mockito;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "77: import org.jvnet.hudson.test.recipes.WithPlugin;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "83: import java.util.Collections;",
          "84: import java.util.HashSet;",
          "85: import java.util.Set;",
          "86: import org.jvnet.hudson.test.MockAuthorizationStrategy;",
          "88: import javax.annotation.CheckForNull;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "89: import java.util.logging.Logger;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "683:         VersionNumber nullVersion = Jenkins.getStoredVersion();",
          "684:         assertNull(nullVersion);",
          "685:     }",
          "686: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "691:     @Issue(\"JENKINS-47406\")",
          "692:     @Test",
          "693:     @WithPlugin(\"jenkins-47406.hpi\") // Sources: https://github.com/Vlatombe/jenkins-47406",
          "694:     public void jobCreatedByInitializerIsRetained() {",
          "695:         assertNotNull(\"JENKINS-47406 should exist\", j.jenkins.getItem(\"JENKINS-47406\"));",
          "696:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9c23a30e674137bc9d8fbed4cc31f9098266949f",
      "candidate_info": {
        "commit_hash": "9c23a30e674137bc9d8fbed4cc31f9098266949f",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/9c23a30e674137bc9d8fbed4cc31f9098266949f",
        "files": [
          "core/src/main/java/jenkins/model/Jenkins.java"
        ],
        "message": "[FIXED JENKINS-40489] - Fix Jenkins initialization stage names",
        "before_after_code_files": [
          "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
          ],
          "candidate": [
            "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java"
          ]
        }
      },
      "candidate_diff": {
        "core/src/main/java/jenkins/model/Jenkins.java||core/src/main/java/jenkins/model/Jenkins.java": [
          "File: core/src/main/java/jenkins/model/Jenkins.java -> core/src/main/java/jenkins/model/Jenkins.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "3044:         });",
          "3046:         for (final File subdir : subdirs) {",
          "3048:                 public void run(Reactor session) throws Exception {",
          "3049:                     if(!Items.getConfigFile(subdir).exists()) {",
          "",
          "[Removed Lines]",
          "3047:             g.requires(loadJenkins).attains(JOB_LOADED).notFatal().add(\"Loading job \"+subdir.getName(),new Executable() {",
          "",
          "[Added Lines]",
          "3047:             g.requires(loadJenkins).attains(JOB_LOADED).notFatal().add(\"Loading item \" + subdir.getName(), new Executable() {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3057:             });",
          "3058:         }",
          "3061:             public void run(Reactor reactor) throws Exception {",
          "",
          "[Removed Lines]",
          "3060:         g.requires(JOB_LOADED).add(\"Cleaning up old builds\",new Executable() {",
          "",
          "[Added Lines]",
          "3060:         g.requires(JOB_LOADED).add(\"Cleaning up obsolete items deleted from the disk\", new Executable() {",
          "",
          "---------------"
        ]
      }
    }
  ]
}