{
  "cve_id": "CVE-2017-18222",
  "cve_desc": "In the Linux kernel before 4.12, Hisilicon Network Subsystem (HNS) does not consider the ETH_SS_PRIV_FLAGS case when retrieving sset_count data, which allows local users to cause a denial of service (buffer overflow and memory corruption) or possibly have unspecified other impact, as demonstrated by incompatibility between hns_get_sset_count and ethtool_get_strings.",
  "repo": "torvalds/linux",
  "patch_hash": "412b65d15a7f8a93794653968308fc100f2aa87c",
  "patch_info": {
    "commit_hash": "412b65d15a7f8a93794653968308fc100f2aa87c",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/412b65d15a7f8a93794653968308fc100f2aa87c",
    "files": [
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c"
    ],
    "message": "net: hns: fix ethtool_get_strings overflow in hns driver\n\nhns_get_sset_count() returns HNS_NET_STATS_CNT and the data space allocated\nis not enough for ethtool_get_strings(), which will cause random memory\ncorruption.\n\nWhen SLAB and DEBUG_SLAB are both enabled, memory corruptions like the\nthe following can be observed without this patch:\n[   43.115200] Slab corruption (Not tainted): Acpi-ParseExt start=ffff801fb0b69030, len=80\n[   43.115206] Redzone: 0x9f911029d006462/0x5f78745f31657070.\n[   43.115208] Last user: [<5f7272655f746b70>](0x5f7272655f746b70)\n[   43.115214] 010: 70 70 65 31 5f 74 78 5f 70 6b 74 00 6b 6b 6b 6b  ppe1_tx_pkt.kkkk\n[   43.115217] 030: 70 70 65 31 5f 74 78 5f 70 6b 74 5f 6f 6b 00 6b  ppe1_tx_pkt_ok.k\n[   43.115218] Next obj: start=ffff801fb0b69098, len=80\n[   43.115220] Redzone: 0x706d655f6f666966/0x9f911029d74e35b.\n[   43.115229] Last user: [<ffff0000084b11b0>](acpi_os_release_object+0x28/0x38)\n[   43.115231] 000: 74 79 00 6b 6b 6b 6b 6b 70 70 65 31 5f 74 78 5f  ty.kkkkkppe1_tx_\n[   43.115232] 010: 70 6b 74 5f 65 72 72 5f 63 73 75 6d 5f 66 61 69  pkt_err_csum_fai\n\nSigned-off-by: Timmy Li <lixiaoping3@huawei.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
      "drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c"
    ]
  },
  "patch_diff": {
    "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c": [
      "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "667: static int hns_gmac_get_sset_count(int stringset)",
      "668: {",
      "670:   return ARRAY_SIZE(g_gmac_stats_string);",
      "672:  return 0;",
      "",
      "[Removed Lines]",
      "669:  if (stringset == ETH_SS_STATS)",
      "",
      "[Added Lines]",
      "669:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
      "",
      "---------------"
    ],
    "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c": [
      "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "423: int hns_ppe_get_sset_count(int stringset)",
      "424: {",
      "426:   return ETH_PPE_STATIC_NUM;",
      "427:  return 0;",
      "428: }",
      "",
      "[Removed Lines]",
      "425:  if (stringset == ETH_SS_STATS)",
      "",
      "[Added Lines]",
      "425:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
      "",
      "---------------"
    ],
    "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c": [
      "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "877: int hns_rcb_get_ring_sset_count(int stringset)",
      "878: {",
      "880:   return HNS_RING_STATIC_REG_NUM;",
      "882:  return 0;",
      "",
      "[Removed Lines]",
      "879:  if (stringset == ETH_SS_STATS)",
      "",
      "[Added Lines]",
      "879:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
      "",
      "---------------"
    ],
    "drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c": [
      "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_xgmac.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "782: static int hns_xgmac_get_sset_count(int stringset)",
      "783: {",
      "785:   return ARRAY_SIZE(g_xgmac_stats_string);",
      "787:  return 0;",
      "",
      "[Removed Lines]",
      "784:  if (stringset == ETH_SS_STATS)",
      "",
      "[Added Lines]",
      "784:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d61d263c8d82db7c4404a29ebc29674b1c0c05c9",
      "candidate_info": {
        "commit_hash": "d61d263c8d82db7c4404a29ebc29674b1c0c05c9",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/d61d263c8d82db7c4404a29ebc29674b1c0c05c9",
        "files": [
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
          "drivers/net/ethernet/hisilicon/hns/hns_ethtool.c"
        ],
        "message": "net: hns: Fix ethtool private flags\n\nThe driver implementation returns support for private flags, while\nno private flags are present. When asked for the number of private\nflags it returns the number of statistic flag names.\n\nFix this by returning EOPNOTSUPP for not implemented ethtool flags.\n\nSigned-off-by: Matthias Brugger <mbrugger@suse.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
          "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
          "drivers/net/ethernet/hisilicon/hns/hns_ethtool.c||drivers/net/ethernet/hisilicon/hns/hns_ethtool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c"
          ],
          "candidate": [
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
            "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c": [
          "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "667: static int hns_gmac_get_sset_count(int stringset)",
          "668: {",
          "670:   return ARRAY_SIZE(g_gmac_stats_string);",
          "672:  return 0;",
          "",
          "[Removed Lines]",
          "669:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
          "",
          "[Added Lines]",
          "669:  if (stringset == ETH_SS_STATS)",
          "",
          "---------------"
        ],
        "drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c": [
          "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_ppe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "423: int hns_ppe_get_sset_count(int stringset)",
          "424: {",
          "426:   return ETH_PPE_STATIC_NUM;",
          "427:  return 0;",
          "428: }",
          "",
          "[Removed Lines]",
          "425:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
          "",
          "[Added Lines]",
          "425:  if (stringset == ETH_SS_STATS)",
          "",
          "---------------"
        ],
        "drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c||drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c": [
          "File: drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c -> drivers/net/ethernet/hisilicon/hns/hns_dsaf_rcb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "877: int hns_rcb_get_ring_sset_count(int stringset)",
          "878: {",
          "880:   return HNS_RING_STATIC_REG_NUM;",
          "882:  return 0;",
          "",
          "[Removed Lines]",
          "879:  if (stringset == ETH_SS_STATS || stringset == ETH_SS_PRIV_FLAGS)",
          "",
          "[Added Lines]",
          "879:  if (stringset == ETH_SS_STATS)",
          "",
          "---------------"
        ],
        "drivers/net/ethernet/hisilicon/hns/hns_ethtool.c||drivers/net/ethernet/hisilicon/hns/hns_ethtool.c": [
          "File: drivers/net/ethernet/hisilicon/hns/hns_ethtool.c -> drivers/net/ethernet/hisilicon/hns/hns_ethtool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "993:    cnt--;",
          "995:   return cnt;",
          "997:   return (HNS_NET_STATS_CNT + ops->get_sset_count(h, stringset));",
          "998:  }",
          "999: }",
          "",
          "[Removed Lines]",
          "996:  } else {",
          "",
          "[Added Lines]",
          "996:  } else if (stringset == ETH_SS_STATS) {",
          "998:  } else {",
          "999:   return -EOPNOTSUPP;",
          "",
          "---------------"
        ]
      }
    }
  ]
}