{
  "cve_id": "CVE-2017-18186",
  "cve_desc": "An issue was discovered in QPDF before 7.0.0. There is an infinite loop due to looping xref tables in QPDF.cc.",
  "repo": "qpdf/qpdf",
  "patch_hash": "85f05cc57ffa0a863d9d9b23e73acea9410b2937",
  "patch_info": {
    "commit_hash": "85f05cc57ffa0a863d9d9b23e73acea9410b2937",
    "repo": "qpdf/qpdf",
    "commit_url": "https://github.com/qpdf/qpdf/commit/85f05cc57ffa0a863d9d9b23e73acea9410b2937",
    "files": [
      "ChangeLog",
      "libqpdf/QPDF.cc",
      "qpdf/qtest/qpdf.test",
      "qpdf/qtest/qpdf/issue-149.out",
      "qpdf/qtest/qpdf/issue-149.pdf"
    ],
    "message": "Detect xref pointer infinite loop (fixes #149)",
    "before_after_code_files": [
      "libqpdf/QPDF.cc||libqpdf/QPDF.cc",
      "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test"
    ]
  },
  "patch_diff": {
    "libqpdf/QPDF.cc||libqpdf/QPDF.cc": [
      "File: libqpdf/QPDF.cc -> libqpdf/QPDF.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "491: QPDF::read_xref(qpdf_offset_t xref_offset)",
      "492: {",
      "493:     std::map<int, int> free_table;",
      "494:     while (xref_offset)",
      "495:     {",
      "496:         char buf[7];",
      "497:         memset(buf, 0, sizeof(buf));",
      "498:  this->m->file->seek(xref_offset, SEEK_SET);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "494:     std::set<qpdf_offset_t> visited;",
      "497:         visited.insert(xref_offset);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "520:  {",
      "521:      xref_offset = read_xrefStream(xref_offset);",
      "522:  }",
      "523:     }",
      "525:     if (! this->m->trailer.isInitialized())",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "525:         if (visited.count(xref_offset) != 0)",
      "526:         {",
      "527:             xref_offset = 0;",
      "528:         }",
      "",
      "---------------"
    ],
    "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test": [
      "File: qpdf/qtest/qpdf.test -> qpdf/qtest/qpdf.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "221:     [\"141a\", \"/W entry size 0\", 2],",
      "222:     [\"141b\", \"/W entry size 0\", 2],",
      "223:     [\"143\", \"self-referential ostream\", 3],",
      "224:     );",
      "225: $n_tests += scalar(@bug_tests);",
      "226: foreach my $d (@bug_tests)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "224:     [\"149\", \"xref prev pointer loop\", 3],",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ee44aef8d08d8f745380277412ec8bb420648a7c",
      "candidate_info": {
        "commit_hash": "ee44aef8d08d8f745380277412ec8bb420648a7c",
        "repo": "qpdf/qpdf",
        "commit_url": "https://github.com/qpdf/qpdf/commit/ee44aef8d08d8f745380277412ec8bb420648a7c",
        "files": [
          "ChangeLog",
          "libqpdf/QPDF.cc",
          "qpdf/qpdf.testcov",
          "qpdf/qtest/qpdf.test",
          "qpdf/qtest/qpdf/append-xref-loop-fixed.pdf",
          "qpdf/qtest/qpdf/append-xref-loop.out",
          "qpdf/qtest/qpdf/append-xref-loop.pdf",
          "qpdf/qtest/qpdf/issue-149.out"
        ],
        "message": "Treat loop in xref tables as damage (fixes #192)\n\nPrior to this fix, if there was a loop detected in following /Prev\npointers in xref streams/tables, it would cause qpdf to lose data.\nNote that this condition causes many PDF readers to hang or fail.",
        "before_after_code_files": [
          "libqpdf/QPDF.cc||libqpdf/QPDF.cc",
          "qpdf/qpdf.testcov||qpdf/qpdf.testcov",
          "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libqpdf/QPDF.cc||libqpdf/QPDF.cc",
            "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test"
          ],
          "candidate": [
            "libqpdf/QPDF.cc||libqpdf/QPDF.cc",
            "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test"
          ]
        }
      },
      "candidate_diff": {
        "libqpdf/QPDF.cc||libqpdf/QPDF.cc": [
          "File: libqpdf/QPDF.cc -> libqpdf/QPDF.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "532:  }",
          "533:         if (visited.count(xref_offset) != 0)",
          "534:         {",
          "536:         }",
          "537:     }",
          "",
          "[Removed Lines]",
          "535:             xref_offset = 0;",
          "",
          "[Added Lines]",
          "535:             QTC::TC(\"qpdf\", \"QPDF xref loop\");",
          "536:             throw QPDFExc(qpdf_e_damaged_pdf, this->m->file->getName(), \"\", 0,",
          "537:                           \"loop detected following xref tables\");",
          "",
          "---------------"
        ],
        "qpdf/qpdf.testcov||qpdf/qpdf.testcov": [
          "File: qpdf/qpdf.testcov -> qpdf/qpdf.testcov",
          "--- Hunk 1 ---",
          "[Context before]",
          "334: QPDFObjectHandle numeric non-numeric 0",
          "335: QPDFObjectHandle erase array bounds 0",
          "336: qpdf-c called qpdf_check_pdf 0",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "337: QPDF xref loop 0",
          "",
          "---------------"
        ],
        "qpdf/qtest/qpdf.test||qpdf/qtest/qpdf.test": [
          "File: qpdf/qtest/qpdf.test -> qpdf/qtest/qpdf.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1400: show_ntests();",
          "1401: # ----------",
          "1402: $td->notify(\"--- Recovery Tests ---\");",
          "1405: # Recovery tests.  These are mostly after-the-fact -- when recovery",
          "1406: # was implemented, some degree of recovery was possible on many of the",
          "",
          "[Removed Lines]",
          "1403: $n_tests += @badfiles + 7;",
          "",
          "[Added Lines]",
          "1403: $n_tests += @badfiles + 9;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1469:               $td->EXIT_STATUS => 3},",
          "1470:              $td->NORMALIZE_NEWLINES);",
          "1472: show_ntests();",
          "1473: # ----------",
          "1474: $td->notify(\"--- Basic Parsing Tests ---\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1472: $td->runtest(\"xref loop with append\",",
          "1473:              {$td->COMMAND =>",
          "1474:                   \"qpdf --deterministic-id append-xref-loop.pdf a.pdf\"},",
          "1475:              {$td->FILE => \"append-xref-loop.out\",",
          "1476:               $td->EXIT_STATUS => 3},",
          "1477:              $td->NORMALIZE_NEWLINES);",
          "1479: $td->runtest(\"check output\",",
          "1480:       {$td->FILE => \"a.pdf\"},",
          "1481:       {$td->FILE => \"append-xref-loop-fixed.pdf\"});",
          "",
          "---------------"
        ]
      }
    }
  ]
}