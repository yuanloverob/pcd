{
  "cve_id": "CVE-2021-29574",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The implementation of `tf.raw_ops.MaxPool3DGradGrad` exhibits undefined behavior by dereferencing null pointers backing attacker-supplied empty tensors. The implementation(https://github.com/tensorflow/tensorflow/blob/72fe792967e7fd25234342068806707bbc116618/tensorflow/core/kernels/pooling_ops_3d.cc#L679-L703) fails to validate that the 3 tensor inputs are not empty. If any of them is empty, then accessing the elements in the tensor results in dereferencing a null pointer. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "a3d9f9be9ac2296615644061b40cefcee341dcc4",
  "patch_info": {
    "commit_hash": "a3d9f9be9ac2296615644061b40cefcee341dcc4",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/a3d9f9be9ac2296615644061b40cefcee341dcc4",
    "files": [
      "tensorflow/core/kernels/pooling_ops_3d.cc"
    ],
    "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
    "before_after_code_files": [
      "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
      "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "698:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
      "699:                                 {2}, 0, tensor_out.shape(), &output));",
      "701:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
      "702:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
      "703:   }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "703:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
      "704:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
      "705:                                         tensor_in.DebugString()));",
      "706:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
      "707:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
      "708:                                         tensor_out.DebugString()));",
      "709:     OP_REQUIRES(",
      "710:         context, out_grad_backprop.NumElements() > 0,",
      "711:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
      "712:                                 out_grad_backprop.DebugString()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f304acc131f699cd08f5f996e3c7bd231c5d5f0",
      "candidate_info": {
        "commit_hash": "0f304acc131f699cd08f5f996e3c7bd231c5d5f0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0f304acc131f699cd08f5f996e3c7bd231c5d5f0",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "698:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
          "699:                                 {2}, 0, tensor_out.shape(), &output));",
          "701:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
          "702:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
          "703:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "703:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
          "704:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
          "705:                                         tensor_in.DebugString()));",
          "706:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
          "707:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
          "708:                                         tensor_out.DebugString()));",
          "709:     OP_REQUIRES(",
          "710:         context, out_grad_backprop.NumElements() > 0,",
          "711:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
          "712:                                 out_grad_backprop.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b723f70d2ac32dd7967a23c948e6f760221d7657",
      "candidate_info": {
        "commit_hash": "b723f70d2ac32dd7967a23c948e6f760221d7657",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b723f70d2ac32dd7967a23c948e6f760221d7657",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "702:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
          "703:                                 {2}, 0, tensor_out.shape(), &output));",
          "705:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
          "706:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
          "707:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "707:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
          "708:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
          "709:                                         tensor_in.DebugString()));",
          "710:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
          "711:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
          "712:                                         tensor_out.DebugString()));",
          "713:     OP_REQUIRES(",
          "714:         context, out_grad_backprop.NumElements() > 0,",
          "715:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
          "716:                                 out_grad_backprop.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5c0f8d9abe5a0a7a70de03eb359e8ffe8adeb8cb",
      "candidate_info": {
        "commit_hash": "5c0f8d9abe5a0a7a70de03eb359e8ffe8adeb8cb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5c0f8d9abe5a0a7a70de03eb359e8ffe8adeb8cb",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "702:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
          "703:                                 {2}, 0, tensor_out.shape(), &output));",
          "705:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
          "706:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
          "707:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "707:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
          "708:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
          "709:                                         tensor_in.DebugString()));",
          "710:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
          "711:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
          "712:                                         tensor_out.DebugString()));",
          "713:     OP_REQUIRES(",
          "714:         context, out_grad_backprop.NumElements() > 0,",
          "715:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
          "716:                                 out_grad_backprop.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2578f8cb613b09c7737fc4388c4a06e86aebf998",
      "candidate_info": {
        "commit_hash": "2578f8cb613b09c7737fc4388c4a06e86aebf998",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/2578f8cb613b09c7737fc4388c4a06e86aebf998",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "698:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
          "699:                                 {2}, 0, tensor_out.shape(), &output));",
          "701:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
          "702:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
          "703:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "703:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
          "704:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
          "705:                                         tensor_in.DebugString()));",
          "706:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
          "707:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
          "708:                                         tensor_out.DebugString()));",
          "709:     OP_REQUIRES(",
          "710:         context, out_grad_backprop.NumElements() > 0,",
          "711:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
          "712:                                 out_grad_backprop.DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "53b19e42f63208c5de40bbe509e5befa56f24269",
      "candidate_info": {
        "commit_hash": "53b19e42f63208c5de40bbe509e5befa56f24269",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/53b19e42f63208c5de40bbe509e5befa56f24269",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Add missing validation to pooling_ops_3d\n\nPiperOrigin-RevId: 372218727\nChange-Id: I6b9ed4266aa7286c02f1f230d7bea922c1be547e",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "704:     OP_REQUIRES_OK(context, context->forward_input_or_allocate_output(",
          "705:                                 {2}, 0, tensor_out.shape(), &output));",
          "707:     LaunchMaxPooling3dGradGradOp<Device, T>::launch(",
          "708:         context, params, tensor_in, tensor_out, out_grad_backprop, output);",
          "709:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "709:     OP_REQUIRES(context, tensor_in.NumElements() > 0,",
          "710:                 errors::InvalidArgument(\"received empty tensor tensor_in: \",",
          "711:                                         tensor_in.DebugString()));",
          "712:     OP_REQUIRES(context, tensor_out.NumElements() > 0,",
          "713:                 errors::InvalidArgument(\"received empty tensor tensor_out: \",",
          "714:                                         tensor_out.DebugString()));",
          "715:     OP_REQUIRES(",
          "716:         context, out_grad_backprop.NumElements() > 0,",
          "717:         errors::InvalidArgument(\"received empty tensor out_grad_backprop: \",",
          "718:                                 out_grad_backprop.DebugString()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}