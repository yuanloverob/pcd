{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
      "candidate_info": {
        "commit_hash": "4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
        "files": [
          ".appveyor.yml",
          "appveyor.yml",
          "arch/X86/X86IntelInstPrinter.c"
        ],
        "message": "Revert \"rename appveyor.yml to .appveyor.yml\"\n\nThis reverts commit 3abf30552812fdfb07a1cbe5fff187ba9103d104.",
        "before_after_code_files": [
          "arch/X86/X86IntelInstPrinter.c||arch/X86/X86IntelInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86IntelInstPrinter.c||arch/X86/X86IntelInstPrinter.c": [
          "File: arch/X86/X86IntelInstPrinter.c -> arch/X86/X86IntelInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "420:   printRegName(O, MCOperand_getReg(Op));",
          "421:  } else if (MCOperand_isImm(Op)) {",
          "422:   int64_t imm = MCOperand_getImm(Op);",
          "427:  }",
          "428: }",
          "",
          "[Removed Lines]",
          "423:   if (MI->csh->imm_unsigned == CS_OPT_ON)",
          "424:    printImm(MI->csh->syntax, O, imm, true);",
          "425:   else",
          "426:    printImm(MI->csh->syntax, O, imm, false);",
          "",
          "[Added Lines]",
          "423:   printImm(MI->csh->syntax, O, imm, false);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "849:   switch(MI->flat_insn->id) {",
          "850:    default:",
          "855:     break;",
          "857:    case X86_INS_MOVABS:",
          "",
          "[Removed Lines]",
          "851:     if (MI->csh->imm_unsigned == CS_OPT_ON)",
          "852:      printImm(MI->csh->syntax, O, imm, true);",
          "853:     else",
          "854:      printImm(MI->csh->syntax, O, imm, false);",
          "",
          "[Added Lines]",
          "848:     printImm(MI->csh->syntax, O, imm, false);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "edc72e6a7be31d46e17400f661edddb8388d83b4",
      "candidate_info": {
        "commit_hash": "edc72e6a7be31d46e17400f661edddb8388d83b4",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/edc72e6a7be31d46e17400f661edddb8388d83b4",
        "files": [
          "bindings/python/capstone/m68k.py"
        ],
        "message": "Replace copy.deepcopy by  copy_ctypes_list for get_arch_info\n\nThis replacement was done for commit\n16477206564745782854e0ec5c68defa02429dd8, allowing the python binding to\nbe used in PyPy. It seems the m68k arch has been forgotten.",
        "before_after_code_files": [
          "bindings/python/capstone/m68k.py||bindings/python/capstone/m68k.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/capstone/m68k.py||bindings/python/capstone/m68k.py": [
          "File: bindings/python/capstone/m68k.py -> bindings/python/capstone/m68k.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "86:     )",
          "88: def get_arch_info(a):",
          "",
          "[Removed Lines]",
          "89:     return (copy.deepcopy(a.operands[:a.op_count]), a.op_size)",
          "",
          "[Added Lines]",
          "89:     return (copy_ctypes_list(a.operands[:a.op_count]), a.op_size)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bc8a649b35188786754ea1b0bddd5cb48a039162",
      "candidate_info": {
        "commit_hash": "bc8a649b35188786754ea1b0bddd5cb48a039162",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/bc8a649b35188786754ea1b0bddd5cb48a039162",
        "files": [
          "xcode/Capstone.xcodeproj/project.pbxproj",
          "xcode/CapstoneFramework/module.modulemap"
        ],
        "message": "macOS framework - Added a module map for Swift/Objective-C. (#1057)",
        "before_after_code_files": [
          "xcode/Capstone.xcodeproj/project.pbxproj||xcode/Capstone.xcodeproj/project.pbxproj",
          "xcode/CapstoneFramework/module.modulemap||xcode/CapstoneFramework/module.modulemap"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "xcode/Capstone.xcodeproj/project.pbxproj||xcode/Capstone.xcodeproj/project.pbxproj": [
          "File: xcode/Capstone.xcodeproj/project.pbxproj -> xcode/Capstone.xcodeproj/project.pbxproj",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:  objects = {",
          "10:   0537EAAA1FC6284F00F06BF9 /* tms320c64x.h in Headers */ = {isa = PBXBuildFile; fileRef = 0537EAA91FC6284E00F06BF9 /* tms320c64x.h */; settings = {ATTRIBUTES = (Public, ); }; };",
          "12:   DC07A86E19F6061D00254FCF /* libcapstone.a in Frameworks */ = {isa = PBXBuildFile; fileRef = DCFE23BD19DDCC2D00EF8EA9 /* libcapstone.a */; };",
          "13:   DC3A28E31AF29C0100FC9913 /* test_customized_mnem.c in Sources */ = {isa = PBXBuildFile; fileRef = DC3A28E21AF29C0100FC9913 /* test_customized_mnem.c */; };",
          "14:   DC3A28E41AF29C4600FC9913 /* libcapstone.a in Frameworks */ = {isa = PBXBuildFile; fileRef = DCFE23BD19DDCC2D00EF8EA9 /* libcapstone.a */; };",
          "",
          "[Removed Lines]",
          "11:   0537EAAC1FC6286300F06BF9 /* m680x.h in Headers */ = {isa = PBXBuildFile; fileRef = 0537EAAB1FC6286300F06BF9 /* m680x.h */; };",
          "",
          "[Added Lines]",
          "10:   05354FA41FC62FCC00920005 /* m68k.h in Headers */ = {isa = PBXBuildFile; fileRef = DCA3579F1BC2C14E0094BB3F /* m68k.h */; settings = {ATTRIBUTES = (Public, ); }; };",
          "12:   0537EAAC1FC6286300F06BF9 /* m680x.h in Headers */ = {isa = PBXBuildFile; fileRef = 0537EAAB1FC6286300F06BF9 /* m680x.h */; settings = {ATTRIBUTES = (Public, ); }; };",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "324:   0537EAA91FC6284E00F06BF9 /* tms320c64x.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; path = tms320c64x.h; sourceTree = \"<group>\"; };",
          "325:   0537EAAB1FC6286300F06BF9 /* m680x.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; path = m680x.h; sourceTree = \"<group>\"; };",
          "326:   DC3A28DB1AF29BEB00FC9913 /* test_customized_mnem */ = {isa = PBXFileReference; explicitFileType = \"compiled.mach-o.executable\"; includeInIndex = 0; path = test_customized_mnem; sourceTree = BUILT_PRODUCTS_DIR; };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "325:   05354FA51FC6305300920005 /* module.modulemap */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = \"sourcecode.module-map\"; path = module.modulemap; sourceTree = \"<group>\"; };",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "664:   DC474F6919DE6F3B00BCA449 /* framework */ = {",
          "665:    isa = PBXGroup;",
          "666:    children = (",
          "667:     DC474F6B19DE6F3B00BCA449 /* Info.plist */,",
          "668:    );",
          "669:    name = framework;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "669:     05354FA51FC6305300920005 /* module.modulemap */,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "956:    isa = PBXHeadersBuildPhase;",
          "957:    buildActionMask = 2147483647;",
          "958:    files = (",
          "959:     DCA357881BC2C0290094BB3F /* M68KDisassembler.h in Headers */,",
          "960:     DC474F8119DE6F6B00BCA449 /* arm.h in Headers */,",
          "961:     DC474F8219DE6F6B00BCA449 /* arm64.h in Headers */,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "962:     05354FA41FC62FCC00920005 /* m68k.h in Headers */,",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2750:     INSTALL_PATH = \"@rpath\";",
          "2751:     LD_RUNPATH_SEARCH_PATHS = \"$(inherited) @executable_path/../Frameworks @loader_path/Frameworks\";",
          "2752:     MACOSX_DEPLOYMENT_TARGET = 10.9;",
          "2753:     MTL_ENABLE_DEBUG_INFO = YES;",
          "2754:     ONLY_ACTIVE_ARCH = YES;",
          "2755:     PRODUCT_BUNDLE_IDENTIFIER = \"com.felixcloutier.$(PRODUCT_NAME:rfc1034identifier)\";",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2757:     MODULEMAP_FILE = \"$(SRCROOT)/CapstoneFramework/module.modulemap\";",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2814:     INSTALL_PATH = \"@rpath\";",
          "2815:     LD_RUNPATH_SEARCH_PATHS = \"$(inherited) @executable_path/../Frameworks @loader_path/Frameworks\";",
          "2816:     MACOSX_DEPLOYMENT_TARGET = 10.9;",
          "2817:     MTL_ENABLE_DEBUG_INFO = NO;",
          "2818:     PRODUCT_BUNDLE_IDENTIFIER = \"com.felixcloutier.$(PRODUCT_NAME:rfc1034identifier)\";",
          "2819:     PRODUCT_NAME = Capstone;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2822:     MODULEMAP_FILE = \"$(SRCROOT)/CapstoneFramework/module.modulemap\";",
          "",
          "---------------"
        ],
        "xcode/CapstoneFramework/module.modulemap||xcode/CapstoneFramework/module.modulemap": [
          "File: xcode/CapstoneFramework/module.modulemap -> xcode/CapstoneFramework/module.modulemap",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: module capstone {",
          "2:     header \"Headers/capstone.h\"",
          "3:     export *",
          "4: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f20a0a032b7cad4101c6d22f6159b82aedd779e3",
      "candidate_info": {
        "commit_hash": "f20a0a032b7cad4101c6d22f6159b82aedd779e3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f20a0a032b7cad4101c6d22f6159b82aedd779e3",
        "files": [
          "arch/X86/X86ATTInstPrinter.c"
        ],
        "message": "Fix UB when accessing un-initialized array (#890)",
        "before_after_code_files": [
          "arch/X86/X86ATTInstPrinter.c||arch/X86/X86ATTInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86ATTInstPrinter.c||arch/X86/X86ATTInstPrinter.c": [
          "File: arch/X86/X86ATTInstPrinter.c -> arch/X86/X86ATTInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "917:  }",
          "919:  if (MI->csh->detail) {",
          "923:   switch(MCInst_getOpcode(MI)) {",
          "",
          "[Removed Lines]",
          "920:   uint8_t access[6];",
          "",
          "[Added Lines]",
          "920:   uint8_t access[6] = {0};",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6039a675a42dc106d3639bf061a45d081a15d84f",
      "candidate_info": {
        "commit_hash": "6039a675a42dc106d3639bf061a45d081a15d84f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/6039a675a42dc106d3639bf061a45d081a15d84f",
        "files": [
          "bindings/python/test_m68k.py"
        ],
        "message": "fixup indentation, mix of spaces and tabs",
        "before_after_code_files": [
          "bindings/python/test_m68k.py||bindings/python/test_m68k.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/test_m68k.py||bindings/python/test_m68k.py": [
          "File: bindings/python/test_m68k.py -> bindings/python/test_m68k.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "45: def print_insn_detail(insn):",
          "46:     if len(insn.operands) > 0:",
          "47:         print(\"\\top_count: %u\" % (len(insn.operands)))",
          "51:     for i, op in enumerate(insn.operands):",
          "52:         if op.type == M68K_OP_REG:",
          "",
          "[Removed Lines]",
          "49:  print(\"\\tgroups_count: %u\" % len(insn.groups))",
          "",
          "[Added Lines]",
          "48:         print(\"\\tgroups_count: %u\" % len(insn.groups))",
          "",
          "---------------"
        ]
      }
    }
  ]
}