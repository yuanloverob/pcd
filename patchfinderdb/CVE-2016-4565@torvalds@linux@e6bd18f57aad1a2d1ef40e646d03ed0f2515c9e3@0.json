{
  "cve_id": "CVE-2016-4565",
  "cve_desc": "The InfiniBand (aka IB) stack in the Linux kernel before 4.5.3 incorrectly relies on the write system call, which allows local users to cause a denial of service (kernel memory write operation) or possibly have unspecified other impact via a uAPI interface.",
  "repo": "torvalds/linux",
  "patch_hash": "e6bd18f57aad1a2d1ef40e646d03ed0f2515c9e3",
  "patch_info": {
    "commit_hash": "e6bd18f57aad1a2d1ef40e646d03ed0f2515c9e3",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/e6bd18f57aad1a2d1ef40e646d03ed0f2515c9e3",
    "files": [
      "drivers/infiniband/core/ucm.c",
      "drivers/infiniband/core/ucma.c",
      "drivers/infiniband/core/uverbs_main.c",
      "drivers/infiniband/hw/qib/qib_file_ops.c",
      "drivers/staging/rdma/hfi1/TODO",
      "drivers/staging/rdma/hfi1/file_ops.c",
      "include/rdma/ib.h"
    ],
    "message": "IB/security: Restrict use of the write() interface\n\nThe drivers/infiniband stack uses write() as a replacement for\nbi-directional ioctl().  This is not safe. There are ways to\ntrigger write calls that result in the return structure that\nis normally written to user space being shunted off to user\nspecified kernel memory instead.\n\nFor the immediate repair, detect and deny suspicious accesses to\nthe write API.\n\nFor long term, update the user space libraries and the kernel API\nto something that doesn't present the same security vulnerabilities\n(likely a structured ioctl() interface).\n\nThe impacted uAPI interfaces are generally only available if\nhardware from drivers/infiniband is installed in the system.\n\nReported-by: Jann Horn <jann@thejh.net>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\nSigned-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>\n[ Expanded check to all known write() entry points ]\nCc: stable@vger.kernel.org\nSigned-off-by: Doug Ledford <dledford@redhat.com>",
    "before_after_code_files": [
      "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c",
      "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c",
      "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c",
      "drivers/infiniband/hw/qib/qib_file_ops.c||drivers/infiniband/hw/qib/qib_file_ops.c",
      "drivers/staging/rdma/hfi1/file_ops.c||drivers/staging/rdma/hfi1/file_ops.c",
      "include/rdma/ib.h||include/rdma/ib.h"
    ]
  },
  "patch_diff": {
    "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c": [
      "File: drivers/infiniband/core/ucm.c -> drivers/infiniband/core/ucm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "49: #include <asm/uaccess.h>",
      "51: #include <rdma/ib_cm.h>",
      "52: #include <rdma/ib_user_cm.h>",
      "53: #include <rdma/ib_marshall.h>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "51: #include <rdma/ib.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1103:  struct ib_ucm_cmd_hdr hdr;",
      "1104:  ssize_t result;",
      "1106:  if (len < sizeof(hdr))",
      "1107:   return -EINVAL;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1107:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
      "1108:   return -EACCES;",
      "",
      "---------------"
    ],
    "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c": [
      "File: drivers/infiniband/core/ucma.c -> drivers/infiniband/core/ucma.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1574:  struct rdma_ucm_cmd_hdr hdr;",
      "1575:  ssize_t ret;",
      "1577:  if (len < sizeof(hdr))",
      "1578:   return -EINVAL;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1577:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
      "1578:   return -EACCES;",
      "",
      "---------------"
    ],
    "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c": [
      "File: drivers/infiniband/core/uverbs_main.c -> drivers/infiniband/core/uverbs_main.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "49: #include <asm/uaccess.h>",
      "51: #include \"uverbs.h\"",
      "53: MODULE_AUTHOR(\"Roland Dreier\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "51: #include <rdma/ib.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "709:  int srcu_key;",
      "710:  ssize_t ret;",
      "712:  if (count < sizeof hdr)",
      "713:   return -EINVAL;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "714:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
      "715:   return -EACCES;",
      "",
      "---------------"
    ],
    "drivers/infiniband/hw/qib/qib_file_ops.c||drivers/infiniband/hw/qib/qib_file_ops.c": [
      "File: drivers/infiniband/hw/qib/qib_file_ops.c -> drivers/infiniband/hw/qib/qib_file_ops.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "45: #include <linux/export.h>",
      "46: #include <linux/uio.h>",
      "48: #include \"qib.h\"",
      "49: #include \"qib_common.h\"",
      "50: #include \"qib_user_sdma.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "48: #include <rdma/ib.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2067:  ssize_t ret = 0;",
      "2068:  void *dest;",
      "2070:  if (count < sizeof(cmd.type)) {",
      "2071:   ret = -EINVAL;",
      "2072:   goto bail;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2072:  if (WARN_ON_ONCE(!ib_safe_file_access(fp)))",
      "2073:   return -EACCES;",
      "",
      "---------------"
    ],
    "drivers/staging/rdma/hfi1/file_ops.c||drivers/staging/rdma/hfi1/file_ops.c": [
      "File: drivers/staging/rdma/hfi1/file_ops.c -> drivers/staging/rdma/hfi1/file_ops.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "49: #include <linux/vmalloc.h>",
      "50: #include <linux/io.h>",
      "52: #include \"hfi.h\"",
      "53: #include \"pio.h\"",
      "54: #include \"device.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "52: #include <rdma/ib.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "190:  int uctxt_required = 1;",
      "191:  int must_be_root = 0;",
      "193:  if (count < sizeof(cmd)) {",
      "194:   ret = -EINVAL;",
      "195:   goto bail;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "196:  if (WARN_ON_ONCE(!ib_safe_file_access(fp)))",
      "197:   return -EACCES;",
      "",
      "---------------"
    ],
    "include/rdma/ib.h||include/rdma/ib.h": [
      "File: include/rdma/ib.h -> include/rdma/ib.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "34: #define _RDMA_IB_H",
      "36: #include <linux/types.h>",
      "38: struct ib_addr {",
      "39:  union {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "37: #include <linux/sched.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "86:  __u64   sib_scope_id;",
      "87: };",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "100: static inline bool ib_safe_file_access(struct file *filp)",
      "101: {",
      "102:  return filp->f_cred == current_cred() && segment_eq(get_fs(), USER_DS);",
      "103: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f73a1dbc45a58ea3ae5c3d60c71e58a8a9563914",
      "candidate_info": {
        "commit_hash": "f73a1dbc45a58ea3ae5c3d60c71e58a8a9563914",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/f73a1dbc45a58ea3ae5c3d60c71e58a8a9563914",
        "files": [
          "drivers/infiniband/core/ucm.c",
          "drivers/infiniband/core/ucma.c",
          "drivers/infiniband/core/uverbs_main.c",
          "drivers/infiniband/hw/qib/qib_file_ops.c"
        ],
        "message": "infiniband: remove WARN that is not kernel bug\n\nOn Mon, Nov 21, 2016 at 09:52:53AM -0700, Jason Gunthorpe wrote:\n> On Mon, Nov 21, 2016 at 02:14:08PM +0200, Leon Romanovsky wrote:\n> > >\n> > > In ib_ucm_write function there is a wrong prefix:\n> > >\n> > > + pr_err_once(\"ucm_write: process %d (%s) tried to do something hinky\\n\",\n> >\n> > I did it intentionally to have the same errors for all flows.\n>\n> Lets actually use a good message too please?\n>\n>  pr_err_once(\"ucm_write: process %d (%s) changed security contexts after opening FD, this is not allowed.\\n\",\n>\n> Jason\n\n>From 70f95b2d35aea42e5b97e7d27ab2f4e8effcbe67 Mon Sep 17 00:00:00 2001\nFrom: Leon Romanovsky <leonro@mellanox.com>\nDate: Mon, 21 Nov 2016 13:30:59 +0200\nSubject: [PATCH rdma-next V2] IB/{core, qib}: Remove WARN that is not kernel bug\n\nWARNINGs mean kernel bugs, in this case, they are placed\nto mark programming errors and/or malicious attempts.\n\nBUG/WARNs that are not kernel bugs hinder automated testing efforts.\n\nSigned-off-by: Dmitry Vyukov <dvyukov@google.com>\nSigned-off-by: Leon Romanovsky <leonro@mellanox.com>\nSigned-off-by: Doug Ledford <dledford@redhat.com>",
        "before_after_code_files": [
          "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c",
          "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c",
          "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c",
          "drivers/infiniband/hw/qib/qib_file_ops.c||drivers/infiniband/hw/qiqib_file_ops.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c",
            "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c",
            "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c"
          ],
          "candidate": [
            "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c",
            "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c",
            "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/infiniband/core/ucm.c||drivers/infiniband/core/ucm.c": [
          "File: drivers/infiniband/core/ucm.c -> drivers/infiniband/core/ucm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1104:  struct ib_ucm_cmd_hdr hdr;",
          "1105:  ssize_t result;",
          "1108:   return -EACCES;",
          "1110:  if (len < sizeof(hdr))",
          "1111:   return -EINVAL;",
          "",
          "[Removed Lines]",
          "1107:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
          "",
          "[Added Lines]",
          "1107:  if (!ib_safe_file_access(filp)) {",
          "1108:   pr_err_once(\"ucm_write: process %d (%s) changed security contexts after opening file descriptor, this is not allowed.\\n\",",
          "1109:        task_tgid_vnr(current), current->comm);",
          "1111:  }",
          "",
          "---------------"
        ],
        "drivers/infiniband/core/ucma.c||drivers/infiniband/core/ucma.c": [
          "File: drivers/infiniband/core/ucma.c -> drivers/infiniband/core/ucma.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1584:  struct rdma_ucm_cmd_hdr hdr;",
          "1585:  ssize_t ret;",
          "1588:   return -EACCES;",
          "1590:  if (len < sizeof(hdr))",
          "1591:   return -EINVAL;",
          "",
          "[Removed Lines]",
          "1587:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
          "",
          "[Added Lines]",
          "1587:  if (!ib_safe_file_access(filp)) {",
          "1588:   pr_err_once(\"ucma_write: process %d (%s) changed security contexts after opening file descriptor, this is not allowed.\\n\",",
          "1589:        task_tgid_vnr(current), current->comm);",
          "1591:  }",
          "",
          "---------------"
        ],
        "drivers/infiniband/core/uverbs_main.c||drivers/infiniband/core/uverbs_main.c": [
          "File: drivers/infiniband/core/uverbs_main.c -> drivers/infiniband/core/uverbs_main.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "749:  int srcu_key;",
          "750:  ssize_t ret;",
          "753:   return -EACCES;",
          "755:  if (count < sizeof hdr)",
          "756:   return -EINVAL;",
          "",
          "[Removed Lines]",
          "752:  if (WARN_ON_ONCE(!ib_safe_file_access(filp)))",
          "",
          "[Added Lines]",
          "752:  if (!ib_safe_file_access(filp)) {",
          "753:   pr_err_once(\"uverbs_write: process %d (%s) changed security contexts after opening file descriptor, this is not allowed.\\n\",",
          "754:        task_tgid_vnr(current), current->comm);",
          "756:  }",
          "",
          "---------------"
        ],
        "drivers/infiniband/hw/qib/qib_file_ops.c||drivers/infiniband/hw/qiqib_file_ops.c": [
          "File: drivers/infiniband/hw/qib/qib_file_ops.c -> drivers/infiniband/hw/qiqib_file_ops.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2066:  ssize_t ret = 0;",
          "2067:  void *dest;",
          "2070:   return -EACCES;",
          "2072:  if (count < sizeof(cmd.type)) {",
          "2073:   ret = -EINVAL;",
          "",
          "[Removed Lines]",
          "2069:  if (WARN_ON_ONCE(!ib_safe_file_access(fp)))",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}