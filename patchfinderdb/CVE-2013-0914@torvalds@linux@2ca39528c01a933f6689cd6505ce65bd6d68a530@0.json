{
  "cve_id": "CVE-2013-0914",
  "cve_desc": "The flush_signal_handlers function in kernel/signal.c in the Linux kernel before 3.8.4 preserves the value of the sa_restorer field across an exec operation, which makes it easier for local users to bypass the ASLR protection mechanism via a crafted application containing a sigaction system call.",
  "repo": "torvalds/linux",
  "patch_hash": "2ca39528c01a933f6689cd6505ce65bd6d68a530",
  "patch_info": {
    "commit_hash": "2ca39528c01a933f6689cd6505ce65bd6d68a530",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/2ca39528c01a933f6689cd6505ce65bd6d68a530",
    "files": [
      "kernel/signal.c"
    ],
    "message": "signal: always clear sa_restorer on execve\n\nWhen the new signal handlers are set up, the location of sa_restorer is\nnot cleared, leaking a parent process's address space location to\nchildren.  This allows for a potential bypass of the parent's ASLR by\nexamining the sa_restorer value returned when calling sigaction().\n\nBased on what should be considered \"secret\" about addresses, it only\nmatters across the exec not the fork (since the VMAs haven't changed\nuntil the exec).  But since exec sets SIG_DFL and keeps sa_restorer,\nthis is where it should be fixed.\n\nGiven the few uses of sa_restorer, a \"set\" function was not written\nsince this would be the only use.  Instead, we use\n__ARCH_HAS_SA_RESTORER, as already done in other places.\n\nExample of the leak before applying this patch:\n\n  $ cat /proc/$$/maps\n  ...\n  7fb9f3083000-7fb9f3238000 r-xp 00000000 fd:01 404469 .../libc-2.15.so\n  ...\n  $ ./leak\n  ...\n  7f278bc74000-7f278be29000 r-xp 00000000 fd:01 404469 .../libc-2.15.so\n  ...\n  1 0 (nil) 0x7fb9f30b94a0\n  2 4000000 (nil) 0x7f278bcaa4a0\n  3 4000000 (nil) 0x7f278bcaa4a0\n  4 0 (nil) 0x7fb9f30b94a0\n  ...\n\n[akpm@linux-foundation.org: use SA_RESTORER for backportability]\nSigned-off-by: Kees Cook <keescook@chromium.org>\nReported-by: Emese Revfy <re.emese@gmail.com>\nCc: Emese Revfy <re.emese@gmail.com>\nCc: PaX Team <pageexec@freemail.hu>\nCc: Al Viro <viro@zeniv.linux.org.uk>\nCc: Oleg Nesterov <oleg@redhat.com>\nCc: \"Eric W. Biederman\" <ebiederm@xmission.com>\nCc: Serge Hallyn <serge.hallyn@canonical.com>\nCc: Julien Tinnes <jln@google.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "before_after_code_files": [
      "kernel/signal.c||kernel/signal.c"
    ]
  },
  "patch_diff": {
    "kernel/signal.c||kernel/signal.c": [
      "File: kernel/signal.c -> kernel/signal.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "485:   if (force_default || ka->sa.sa_handler != SIG_IGN)",
      "486:    ka->sa.sa_handler = SIG_DFL;",
      "487:   ka->sa.sa_flags = 0;",
      "488:   sigemptyset(&ka->sa.sa_mask);",
      "489:   ka++;",
      "490:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "488: #ifdef SA_RESTORER",
      "489:   ka->sa.sa_restorer = NULL;",
      "490: #endif",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "522cff142d7d2f9230839c9e1f21a4d8bcc22a4a",
      "candidate_info": {
        "commit_hash": "522cff142d7d2f9230839c9e1f21a4d8bcc22a4a",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/522cff142d7d2f9230839c9e1f21a4d8bcc22a4a",
        "files": [
          "kernel/signal.c"
        ],
        "message": "kernel/signal.c: use __ARCH_HAS_SA_RESTORER instead of SA_RESTORER\n\n__ARCH_HAS_SA_RESTORER is the preferred conditional for use in 3.9 and\nlater kernels, per Kees.\n\nCc: Emese Revfy <re.emese@gmail.com>\nCc: Emese Revfy <re.emese@gmail.com>\nCc: PaX Team <pageexec@freemail.hu>\nCc: Al Viro <viro@zeniv.linux.org.uk>\nCc: Oleg Nesterov <oleg@redhat.com>\nCc: \"Eric W. Biederman\" <ebiederm@xmission.com>\nCc: Serge Hallyn <serge.hallyn@canonical.com>\nCc: Julien Tinnes <jln@google.com>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
        "before_after_code_files": [
          "kernel/signal.c||kernel/signal.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "kernel/signal.c||kernel/signal.c"
          ],
          "candidate": [
            "kernel/signal.c||kernel/signal.c"
          ]
        }
      },
      "candidate_diff": {
        "kernel/signal.c||kernel/signal.c": [
          "File: kernel/signal.c -> kernel/signal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "485:   if (force_default || ka->sa.sa_handler != SIG_IGN)",
          "486:    ka->sa.sa_handler = SIG_DFL;",
          "487:   ka->sa.sa_flags = 0;",
          "489:   ka->sa.sa_restorer = NULL;",
          "490: #endif",
          "491:   sigemptyset(&ka->sa.sa_mask);",
          "",
          "[Removed Lines]",
          "488: #ifdef SA_RESTORER",
          "",
          "[Added Lines]",
          "488: #ifdef __ARCH_HAS_SA_RESTORER",
          "",
          "---------------"
        ]
      }
    }
  ]
}