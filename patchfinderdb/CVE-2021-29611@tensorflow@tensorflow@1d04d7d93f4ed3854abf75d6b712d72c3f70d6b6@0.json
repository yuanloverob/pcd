{
  "cve_id": "CVE-2021-29611",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Incomplete validation in `SparseReshape` results in a denial of service based on a `CHECK`-failure. The implementation(https://github.com/tensorflow/tensorflow/blob/e87b51ce05c3eb172065a6ea5f48415854223285/tensorflow/core/kernels/sparse_reshape_op.cc#L40) has no validation that the input arguments specify a valid sparse tensor. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2 and TensorFlow 2.3.3, as these are the only affected versions.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "1d04d7d93f4ed3854abf75d6b712d72c3f70d6b6",
  "patch_info": {
    "commit_hash": "1d04d7d93f4ed3854abf75d6b712d72c3f70d6b6",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/1d04d7d93f4ed3854abf75d6b712d72c3f70d6b6",
    "files": [
      "tensorflow/core/kernels/sparse_reshape_op.cc"
    ],
    "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseReshape`.\n\nPiperOrigin-RevId: 371218558\nChange-Id: I6a6dc5bf15b50a1d05bdd95e9ba347cb39f40f45",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
      "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "26: #include \"tensorflow/core/framework/types.h\"",
      "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
      "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
      "30: namespace tensorflow {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29: #include \"tensorflow/core/platform/errors.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "38:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
      "40:   void Compute(OpKernelContext* context) override {",
      "41:     ReshapeSparseTensor<Device>(context, context->input(0), context->input(1),",
      "42:                                 context->input(2), 0 /* output indices index */,",
      "43:                                 1 /* output shape index */);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "42:     const Tensor& input_indices_in = context->input(0);",
      "43:     const Tensor& input_shape_in = context->input(1);",
      "45:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
      "46:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
      "47:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
      "48:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
      "49:     OP_REQUIRES(context,",
      "50:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
      "51:                 errors::InvalidArgument(",
      "52:                     \"Input tensor rank must match input shape length.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a1c42379acd2f8eb197eec941b369108e8751909",
      "candidate_info": {
        "commit_hash": "a1c42379acd2f8eb197eec941b369108e8751909",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a1c42379acd2f8eb197eec941b369108e8751909",
        "files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with .",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
          "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"tensorflow/core/framework/types.h\"",
          "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
          "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
          "36:   void Compute(OpKernelContext* context) override {",
          "37:     ReshapeSparseTensor(context, context->input(0), context->input(1),",
          "38:                         context->input(2), 0 /* output indices index */,",
          "39:                         1 /* output shape index */);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     const Tensor& input_indices_in = context->input(0);",
          "39:     const Tensor& input_shape_in = context->input(1);",
          "41:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
          "42:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
          "43:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
          "44:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
          "45:     OP_REQUIRES(context,",
          "46:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
          "47:                 errors::InvalidArgument(",
          "48:                     \"Input tensor rank must match input shape length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "004d9629d0f77e17c34a266c2d4306d660a1808a",
      "candidate_info": {
        "commit_hash": "004d9629d0f77e17c34a266c2d4306d660a1808a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/004d9629d0f77e17c34a266c2d4306d660a1808a",
        "files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseReshape`.\n\nPiperOrigin-RevId: 371218558\nChange-Id: I6a6dc5bf15b50a1d05bdd95e9ba347cb39f40f45",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
          "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"tensorflow/core/framework/types.h\"",
          "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
          "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "38:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
          "40:   void Compute(OpKernelContext* context) override {",
          "41:     ReshapeSparseTensor<Device>(context, context->input(0), context->input(1),",
          "42:                                 context->input(2), 0 /* output indices index */,",
          "43:                                 1 /* output shape index */);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42:     const Tensor& input_indices_in = context->input(0);",
          "43:     const Tensor& input_shape_in = context->input(1);",
          "45:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
          "46:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
          "47:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
          "48:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
          "49:     OP_REQUIRES(context,",
          "50:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
          "51:                 errors::InvalidArgument(",
          "52:                     \"Input tensor rank must match input shape length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "808ad5c16eca8cae3bcfd6ec9af55e0d64138a6b",
      "candidate_info": {
        "commit_hash": "808ad5c16eca8cae3bcfd6ec9af55e0d64138a6b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/808ad5c16eca8cae3bcfd6ec9af55e0d64138a6b",
        "files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with .",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
          "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"tensorflow/core/framework/types.h\"",
          "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
          "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
          "36:   void Compute(OpKernelContext* context) override {",
          "37:     ReshapeSparseTensor(context, context->input(0), context->input(1),",
          "38:                         context->input(2), 0 /* output indices index */,",
          "39:                         1 /* output shape index */);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     const Tensor& input_indices_in = context->input(0);",
          "39:     const Tensor& input_shape_in = context->input(1);",
          "41:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
          "42:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
          "43:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
          "44:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
          "45:     OP_REQUIRES(context,",
          "46:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
          "47:                 errors::InvalidArgument(",
          "48:                     \"Input tensor rank must match input shape length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9a1b7410d66eaf5eac61d9b5633b5f7ce2f37abf",
      "candidate_info": {
        "commit_hash": "9a1b7410d66eaf5eac61d9b5633b5f7ce2f37abf",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/9a1b7410d66eaf5eac61d9b5633b5f7ce2f37abf",
        "files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with .",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
          "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"tensorflow/core/framework/types.h\"",
          "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
          "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
          "36:   void Compute(OpKernelContext* context) override {",
          "37:     Reshape(context, context->input(0), context->input(1), context->input(2),",
          "38:             0 /* output indices index */, 1 /* output shape index */);",
          "39:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     const Tensor& input_indices_in = context->input(0);",
          "39:     const Tensor& input_shape_in = context->input(1);",
          "41:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
          "42:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
          "43:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
          "44:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
          "45:     OP_REQUIRES(context,",
          "46:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
          "47:                 errors::InvalidArgument(",
          "48:                     \"Input tensor rank must match input shape length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4ba5e3feac29c09798811d0c54e543a1e2a77be",
      "candidate_info": {
        "commit_hash": "c4ba5e3feac29c09798811d0c54e543a1e2a77be",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c4ba5e3feac29c09798811d0c54e543a1e2a77be",
        "files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with .",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_reshape_op.cc||tensorflow/core/kernels/sparse_reshape_op.cc": [
          "File: tensorflow/core/kernels/sparse_reshape_op.cc -> tensorflow/core/kernels/sparse_reshape_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"tensorflow/core/framework/types.h\"",
          "27: #include \"tensorflow/core/kernels/reshape_util.h\"",
          "28: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:   explicit SparseReshapeOp(OpKernelConstruction* context) : OpKernel(context) {}",
          "36:   void Compute(OpKernelContext* context) override {",
          "37:     Reshape(context, context->input(0), context->input(1), context->input(2),",
          "38:             0 /* output indices index */, 1 /* output shape index */);",
          "39:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     const Tensor& input_indices_in = context->input(0);",
          "39:     const Tensor& input_shape_in = context->input(1);",
          "41:     OP_REQUIRES(context, TensorShapeUtils::IsMatrix(input_indices_in.shape()),",
          "42:                 errors::InvalidArgument(\"Input must be a matrix.\"));",
          "43:     OP_REQUIRES(context, TensorShapeUtils::IsVector(input_shape_in.shape()),",
          "44:                 errors::InvalidArgument(\"Input shape must be a vector.\"));",
          "45:     OP_REQUIRES(context,",
          "46:                 input_indices_in.dim_size(1) == input_shape_in.dim_size(0),",
          "47:                 errors::InvalidArgument(",
          "48:                     \"Input tensor rank must match input shape length.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}