{
  "cve_id": "CVE-2015-1787",
  "cve_desc": "The ssl3_get_client_key_exchange function in s3_srvr.c in OpenSSL 1.0.2 before 1.0.2a, when client authentication and an ephemeral Diffie-Hellman ciphersuite are enabled, allows remote attackers to cause a denial of service (daemon crash) via a ClientKeyExchange message with a length of zero.",
  "repo": "openssl/openssl",
  "patch_hash": "d3cc5e610d1719a35cda52c9152134b490a8c944",
  "patch_info": {
    "commit_hash": "d3cc5e610d1719a35cda52c9152134b490a8c944",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/d3cc5e610d1719a35cda52c9152134b490a8c944",
    "files": [
      "ssl/s3_srvr.c"
    ],
    "message": "Fix DHE Null CKE vulnerability\n\nIf client auth is used then a server can seg fault in the event of a DHE\ncipher being used and a zero length ClientKeyExchange message being sent\nby the client. This could be exploited in a DoS attack.\n\nCVE-2015-1787\n\nReviewed-by: Richard Levitte <levitte@openssl.org>",
    "before_after_code_files": [
      "ssl/s3_srvr.c||ssl/s3_srvr.c"
    ]
  },
  "patch_diff": {
    "ssl/s3_srvr.c||ssl/s3_srvr.c": [
      "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2233:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd)) {",
      "2234:         int idx = -1;",
      "2235:         EVP_PKEY *skey = NULL;",
      "2237:             n2s(p, i);",
      "2239:             i = 0;",
      "2240:         if (n && n != i + 2) {",
      "2241:             if (!(s->options & SSL_OP_SSLEAY_080_CLIENT_DH_BUG)) {",
      "2242:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
      "",
      "[Removed Lines]",
      "2236:         if (n)",
      "2238:         else",
      "",
      "[Added Lines]",
      "2236:         if (n > 1) {",
      "2238:         } else {",
      "2239:             if (alg_k & SSL_kDHE) {",
      "2240:                 al = SSL_AD_HANDSHAKE_FAILURE;",
      "2241:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
      "2242:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
      "2243:                 goto f_err;",
      "2244:             }",
      "2246:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "73999b62a27d9ac7c10ff27d79fd2bab97f97670",
      "candidate_info": {
        "commit_hash": "73999b62a27d9ac7c10ff27d79fd2bab97f97670",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/73999b62a27d9ac7c10ff27d79fd2bab97f97670",
        "files": [
          "include/openssl/ssl.h",
          "ssl/d1_clnt.c",
          "ssl/s3_both.c",
          "ssl/s3_clnt.c",
          "ssl/s3_srvr.c",
          "ssl/ssl_err.c",
          "ssl/ssl_locl.h",
          "ssl/statem.c"
        ],
        "message": "Move PACKET creation into the state machine\n\nPreviously each message specific process function would create its own\nPACKET structure. Rather than duplicate all of this code lots of times we\nshould create it in the state machine itself.\n\nReviewed-by: Tim Hudson <tjh@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>",
        "before_after_code_files": [
          "include/openssl/ssl.h||include/openssl/ssl.h",
          "ssl/d1_clnt.c||ssl/d1_clnt.c",
          "ssl/s3_both.c||ssl/s3_both.c",
          "ssl/s3_clnt.c||ssl/s3_clnt.c",
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/ssl_err.c||ssl/ssl_err.c",
          "ssl/ssl_locl.h||ssl/ssl_locl.h",
          "ssl/statem.c||ssl/statem.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ],
          "candidate": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ]
        }
      },
      "candidate_diff": {
        "include/openssl/ssl.h||include/openssl/ssl.h": [
          "File: include/openssl/ssl.h -> include/openssl/ssl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1985: # define SSL_F_DTLS_CONSTRUCT_CHANGE_CIPHER_SPEC          371",
          "1986: # define SSL_F_DTLS_CONSTRUCT_HELLO_VERIFY_REQUEST        385",
          "1987: # define SSL_F_DTLS_GET_REASSEMBLED_MESSAGE               370",
          "1988: # define SSL_F_READ_STATE_MACHINE                         352",
          "1989: # define SSL_F_SSL3_ACCEPT                                128",
          "1990: # define SSL_F_SSL3_ADD_CERT_TO_BUF                       296",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1988: # define SSL_F_DTLS_PROCESS_HELLO_VERIFY                  386",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2300: # define SSL_R_INVALID_TICKET_KEYS_LENGTH                 325",
          "2301: # define SSL_R_INVALID_TRUST                              279",
          "2302: # define SSL_R_LENGTH_MISMATCH                            159",
          "2303: # define SSL_R_LENGTH_TOO_SHORT                           160",
          "2304: # define SSL_R_LIBRARY_BUG                                274",
          "2305: # define SSL_R_LIBRARY_HAS_NO_CIPHERS                     161",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2304: # define SSL_R_LENGTH_TOO_LONG                            102",
          "",
          "---------------"
        ],
        "ssl/d1_clnt.c||ssl/d1_clnt.c": [
          "File: ssl/d1_clnt.c -> ssl/d1_clnt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:                           dtls1_get_client_method, DTLSv1_2_enc_data)",
          "160: {",
          "161:     int al;",
          "163:     unsigned int cookie_len;",
          "169:     if (cookie_len > sizeof(s->d1->cookie)) {",
          "170:         al = SSL_AD_ILLEGAL_PARAMETER;",
          "171:         goto f_err;",
          "172:     }",
          "175:     s->d1->cookie_len = cookie_len;",
          "177:     return MSG_PROCESS_FINISHED_READING;",
          "",
          "[Removed Lines]",
          "159: enum MSG_PROCESS_RETURN dtls_process_hello_verify(SSL *s, unsigned long n)",
          "162:     unsigned char *data;",
          "165:     data = (unsigned char *)s->init_msg;",
          "166:     data += 2;",
          "168:     cookie_len = *(data++);",
          "174:     memcpy(s->d1->cookie, data, cookie_len);",
          "",
          "[Added Lines]",
          "159: enum MSG_PROCESS_RETURN dtls_process_hello_verify(SSL *s, PACKET *pkt)",
          "163:     PACKET cookiepkt;",
          "165:     if (!PACKET_forward(pkt, 2)",
          "166:             || !PACKET_get_length_prefixed_1(pkt, &cookiepkt)) {",
          "167:         al = SSL_AD_DECODE_ERROR;",
          "168:         SSLerr(SSL_F_DTLS_PROCESS_HELLO_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "169:         goto f_err;",
          "170:     }",
          "172:     cookie_len = PACKET_remaining(&cookiepkt);",
          "175:         SSLerr(SSL_F_DTLS_PROCESS_HELLO_VERIFY, SSL_R_LENGTH_TOO_LONG);",
          "179:     if (!PACKET_copy_bytes(&cookiepkt, s->d1->cookie, cookie_len)) {",
          "180:         al = SSL_AD_DECODE_ERROR;",
          "181:         SSLerr(SSL_F_DTLS_PROCESS_HELLO_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "182:         goto f_err;",
          "183:     }",
          "",
          "---------------"
        ],
        "ssl/s3_both.c||ssl/s3_both.c": [
          "File: ssl/s3_both.c -> ssl/s3_both.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "224: }",
          "225: #endif",
          "228: {",
          "229:     int al;",
          "236:     if (SSL_IS_DTLS(s)) {",
          "238:                     || (s->version != DTLS1_BAD_VER",
          "240:                 al = SSL_AD_ILLEGAL_PARAMETER;",
          "241:                 SSLerr(SSL_F_TLS_PROCESS_CHANGE_CIPHER_SPEC,",
          "242:                        SSL_R_BAD_CHANGE_CIPHER_SPEC);",
          "243:                 goto f_err;",
          "244:         }",
          "245:     } else {",
          "247:             al = SSL_AD_ILLEGAL_PARAMETER;",
          "248:             SSLerr(SSL_F_TLS_PROCESS_CHANGE_CIPHER_SPEC,",
          "249:                    SSL_R_BAD_CHANGE_CIPHER_SPEC);",
          "",
          "[Removed Lines]",
          "227: enum MSG_PROCESS_RETURN tls_process_change_cipher_spec(SSL *s, long n)",
          "237:         if ((s->version == DTLS1_BAD_VER && n != DTLS1_CCS_HEADER_LENGTH + 1)",
          "239:                         && n != DTLS1_CCS_HEADER_LENGTH - 1)) {",
          "246:         if (n != 0) {",
          "",
          "[Added Lines]",
          "227: enum MSG_PROCESS_RETURN tls_process_change_cipher_spec(SSL *s, PACKET *pkt)",
          "230:     long remain;",
          "232:     remain = PACKET_remaining(pkt);",
          "239:         if ((s->version == DTLS1_BAD_VER",
          "240:                         && remain != DTLS1_CCS_HEADER_LENGTH + 1)",
          "242:                         && remain != DTLS1_CCS_HEADER_LENGTH - 1)) {",
          "249:         if (remain != 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "288:     return MSG_PROCESS_ERROR;",
          "289: }",
          "292: {",
          "293:     int al, i;",
          "297:     if (!s->s3->change_cipher_spec) {",
          "",
          "[Removed Lines]",
          "291: enum MSG_PROCESS_RETURN tls_process_finished(SSL *s, unsigned long n)",
          "294:     unsigned char *p;",
          "",
          "[Added Lines]",
          "294: enum MSG_PROCESS_RETURN tls_process_finished(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "301:     }",
          "302:     s->s3->change_cipher_spec = 0;",
          "305:     i = s->s3->tmp.peer_finish_md_len;",
          "308:         al = SSL_AD_DECODE_ERROR;",
          "309:         SSLerr(SSL_F_TLS_PROCESS_FINISHED, SSL_R_BAD_DIGEST_LENGTH);",
          "310:         goto f_err;",
          "311:     }",
          "314:         al = SSL_AD_DECRYPT_ERROR;",
          "315:         SSLerr(SSL_F_TLS_PROCESS_FINISHED, SSL_R_DIGEST_CHECK_FAILED);",
          "316:         goto f_err;",
          "",
          "[Removed Lines]",
          "304:     p = (unsigned char *)s->init_msg;",
          "307:     if (i < 0 || (unsigned long)i != n) {",
          "313:     if (CRYPTO_memcmp(p, s->s3->tmp.peer_finish_md, i) != 0) {",
          "",
          "[Added Lines]",
          "308:     if (i < 0 || (unsigned long)i != PACKET_remaining(pkt)) {",
          "314:     if (CRYPTO_memcmp(PACKET_data(pkt), s->s3->tmp.peer_finish_md, i) != 0) {",
          "",
          "---------------"
        ],
        "ssl/s3_clnt.c||ssl/s3_clnt.c": [
          "File: ssl/s3_clnt.c -> ssl/s3_clnt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "448:     return 0;",
          "449: }",
          "452: {",
          "453:     STACK_OF(SSL_CIPHER) *sk;",
          "454:     const SSL_CIPHER *c;",
          "456:     size_t session_id_len;",
          "457:     unsigned char *cipherchars;",
          "458:     int i, al = SSL_AD_INTERNAL_ERROR;",
          "",
          "[Removed Lines]",
          "451: enum MSG_PROCESS_RETURN tls_process_server_hello(SSL *s, unsigned long n)",
          "455:     PACKET pkt, session_id;",
          "",
          "[Added Lines]",
          "451: enum MSG_PROCESS_RETURN tls_process_server_hello(SSL *s, PACKET *pkt)",
          "455:     PACKET session_id;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "461:     SSL_COMP *comp;",
          "462: #endif",
          "470:     if (s->method->version == TLS_ANY_VERSION) {",
          "471:         unsigned int sversion;",
          "474:             al = SSL_AD_DECODE_ERROR;",
          "475:             SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "476:             goto f_err;",
          "",
          "[Removed Lines]",
          "464:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "465:         al = SSL_AD_INTERNAL_ERROR;",
          "466:         SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "467:         goto f_err;",
          "468:     }",
          "473:         if (!PACKET_get_net_2(&pkt, &sversion)) {",
          "",
          "[Added Lines]",
          "467:         if (!PACKET_get_net_2(pkt, &sversion)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "515:         unsigned int hversion;",
          "516:         int options;",
          "519:             al = SSL_AD_DECODE_ERROR;",
          "520:             SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "521:             goto f_err;",
          "",
          "[Removed Lines]",
          "518:         if (!PACKET_get_net_2(&pkt, &hversion)) {",
          "",
          "[Added Lines]",
          "512:         if (!PACKET_get_net_2(pkt, &hversion)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "542:     } else {",
          "543:         unsigned char *vers;",
          "546:             al = SSL_AD_DECODE_ERROR;",
          "547:             SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "548:             goto f_err;",
          "",
          "[Removed Lines]",
          "545:         if (!PACKET_get_bytes(&pkt, &vers, 2)) {",
          "",
          "[Added Lines]",
          "539:         if (!PACKET_get_bytes(pkt, &vers, 2)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "562:         al = SSL_AD_DECODE_ERROR;",
          "563:         SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "564:         goto f_err;",
          "",
          "[Removed Lines]",
          "561:     if (!PACKET_copy_bytes(&pkt, s->s3->server_random, SSL3_RANDOM_SIZE)) {",
          "",
          "[Added Lines]",
          "555:     if (!PACKET_copy_bytes(pkt, s->s3->server_random, SSL3_RANDOM_SIZE)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "567:     s->hit = 0;",
          "571:         al = SSL_AD_DECODE_ERROR;",
          "572:         SSLerr(SSL_F_SSL3_GET_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "573:         goto f_err;",
          "",
          "[Removed Lines]",
          "570:     if (!PACKET_get_length_prefixed_1(&pkt, &session_id)) {",
          "",
          "[Added Lines]",
          "564:     if (!PACKET_get_length_prefixed_1(pkt, &session_id)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "580:         goto f_err;",
          "581:     }",
          "584:         SSLerr(SSL_F_SSL3_GET_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "585:         al = SSL_AD_DECODE_ERROR;",
          "586:         goto f_err;",
          "",
          "[Removed Lines]",
          "583:     if (!PACKET_get_bytes(&pkt, &cipherchars, TLS_CIPHER_LEN)) {",
          "",
          "[Added Lines]",
          "577:     if (!PACKET_get_bytes(pkt, &cipherchars, TLS_CIPHER_LEN)) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "700:         goto f_err;",
          "704:         SSLerr(SSL_F_SSL3_GET_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "705:         al = SSL_AD_DECODE_ERROR;",
          "706:         goto f_err;",
          "",
          "[Removed Lines]",
          "703:     if (!PACKET_get_1(&pkt, &compression)) {",
          "",
          "[Added Lines]",
          "697:     if (!PACKET_get_1(pkt, &compression)) {",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "748: #endif",
          "752:         SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_PARSE_TLSEXT);",
          "753:         goto err;",
          "754:     }",
          "758:         al = SSL_AD_DECODE_ERROR;",
          "759:         SSLerr(SSL_F_TLS_PROCESS_SERVER_HELLO, SSL_R_BAD_PACKET_LENGTH);",
          "",
          "[Removed Lines]",
          "751:     if (!ssl_parse_serverhello_tlsext(s, &pkt)) {",
          "756:     if (PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "745:     if (!ssl_parse_serverhello_tlsext(s, pkt)) {",
          "750:     if (PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "794:     return MSG_PROCESS_ERROR;",
          "795: }",
          "798: {",
          "799:     int al, i, ret = MSG_PROCESS_ERROR, exp_idx;",
          "800:     unsigned long cert_list_len, cert_len;",
          "",
          "[Removed Lines]",
          "797: enum MSG_PROCESS_RETURN tls_process_server_certificate(SSL *s, unsigned long n)",
          "",
          "[Added Lines]",
          "791: enum MSG_PROCESS_RETURN tls_process_server_certificate(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "802:     unsigned char *certstart, *certbytes;",
          "803:     STACK_OF(X509) *sk = NULL;",
          "804:     EVP_PKEY *pkey = NULL;",
          "813:     if ((sk = sk_X509_new_null()) == NULL) {",
          "814:         SSLerr(SSL_F_TLS_PROCESS_SERVER_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "815:         goto err;",
          "816:     }",
          "820:         al = SSL_AD_DECODE_ERROR;",
          "821:         SSLerr(SSL_F_TLS_PROCESS_SERVER_CERTIFICATE, SSL_R_LENGTH_MISMATCH);",
          "822:         goto f_err;",
          "823:     }",
          "827:             al = SSL_AD_DECODE_ERROR;",
          "828:             SSLerr(SSL_F_TLS_PROCESS_SERVER_CERTIFICATE,",
          "829:                    SSL_R_CERT_LENGTH_MISMATCH);",
          "",
          "[Removed Lines]",
          "805:     PACKET pkt;",
          "807:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "808:         al = SSL_AD_INTERNAL_ERROR;",
          "809:         SSLerr(SSL_F_TLS_PROCESS_SERVER_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "810:         goto f_err;",
          "811:     }",
          "818:     if (!PACKET_get_net_3(&pkt, &cert_list_len)",
          "819:             || PACKET_remaining(&pkt) != cert_list_len) {",
          "824:     while (PACKET_remaining(&pkt)) {",
          "825:         if (!PACKET_get_net_3(&pkt, &cert_len)",
          "826:                 || !PACKET_get_bytes(&pkt, &certbytes, cert_len)) {",
          "",
          "[Added Lines]",
          "805:     if (!PACKET_get_net_3(pkt, &cert_list_len)",
          "806:             || PACKET_remaining(pkt) != cert_list_len) {",
          "811:     while (PACKET_remaining(pkt)) {",
          "812:         if (!PACKET_get_net_3(pkt, &cert_len)",
          "813:                 || !PACKET_get_bytes(pkt, &certbytes, cert_len)) {",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "924:     return ret;",
          "925: }",
          "928: {",
          "929: #ifndef OPENSSL_NO_RSA",
          "930:     unsigned char *q, md_buf[EVP_MAX_MD_SIZE * 2];",
          "",
          "[Removed Lines]",
          "927: enum MSG_PROCESS_RETURN tls_process_key_exchange(SSL *s, unsigned long n)",
          "",
          "[Added Lines]",
          "914: enum MSG_PROCESS_RETURN tls_process_key_exchange(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "946:     EC_POINT *srvr_ecpoint = NULL;",
          "947:     int curve_nid = 0;",
          "948: #endif",
          "951:     EVP_MD_CTX_init(&md_ctx);",
          "953:     alg_k = s->s3->tmp.new_cipher->algorithm_mkey;",
          "962: #ifndef OPENSSL_NO_RSA",
          "963:     RSA_free(s->s3->peer_rsa_tmp);",
          "",
          "[Removed Lines]",
          "949:     PACKET pkt, save_param_start, signature;",
          "955:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "956:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "957:             al = SSL_AD_INTERNAL_ERROR;",
          "958:             goto f_err;",
          "959:     }",
          "960:     save_param_start = pkt;",
          "",
          "[Added Lines]",
          "936:     PACKET save_param_start, signature;",
          "942:     save_param_start = *pkt;",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "981:     if (alg_k & SSL_PSK) {",
          "982:         PACKET psk_identity_hint;",
          "984:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "985:             goto f_err;",
          "986:         }",
          "",
          "[Removed Lines]",
          "983:         if (!PACKET_get_length_prefixed_2(&pkt, &psk_identity_hint)) {",
          "",
          "[Added Lines]",
          "965:         if (!PACKET_get_length_prefixed_2(pkt, &psk_identity_hint)) {",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1011: #ifndef OPENSSL_NO_SRP",
          "1012:     if (alg_k & SSL_kSRP) {",
          "1013:         PACKET prime, generator, salt, server_pub;",
          "1018:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1019:             goto f_err;",
          "1020:         }",
          "",
          "[Removed Lines]",
          "1014:         if (!PACKET_get_length_prefixed_2(&pkt, &prime)",
          "1015:             || !PACKET_get_length_prefixed_2(&pkt, &generator)",
          "1016:             || !PACKET_get_length_prefixed_1(&pkt, &salt)",
          "1017:             || !PACKET_get_length_prefixed_2(&pkt, &server_pub)) {",
          "",
          "[Added Lines]",
          "996:         if (!PACKET_get_length_prefixed_2(pkt, &prime)",
          "997:             || !PACKET_get_length_prefixed_2(pkt, &generator)",
          "998:             || !PACKET_get_length_prefixed_1(pkt, &salt)",
          "999:             || !PACKET_get_length_prefixed_2(pkt, &server_pub)) {",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1055:             goto f_err;",
          "1056:         }",
          "1060:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1061:             goto f_err;",
          "1062:         }",
          "",
          "[Removed Lines]",
          "1058:         if (!PACKET_get_length_prefixed_2(&pkt, &mod)",
          "1059:             || !PACKET_get_length_prefixed_2(&pkt, &exp)) {",
          "",
          "[Added Lines]",
          "1040:         if (!PACKET_get_length_prefixed_2(pkt, &mod)",
          "1041:             || !PACKET_get_length_prefixed_2(pkt, &exp)) {",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1098:     else if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "1099:         PACKET prime, generator, pub_key;",
          "1104:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1105:             goto f_err;",
          "1106:         }",
          "",
          "[Removed Lines]",
          "1101:         if (!PACKET_get_length_prefixed_2(&pkt, &prime)",
          "1102:             || !PACKET_get_length_prefixed_2(&pkt, &generator)",
          "1103:             || !PACKET_get_length_prefixed_2(&pkt, &pub_key)) {",
          "",
          "[Added Lines]",
          "1083:         if (!PACKET_get_length_prefixed_2(pkt, &prime)",
          "1084:             || !PACKET_get_length_prefixed_2(pkt, &generator)",
          "1085:             || !PACKET_get_length_prefixed_2(pkt, &pub_key)) {",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "1161:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_TOO_SHORT);",
          "1162:             goto f_err;",
          "1163:         }",
          "",
          "[Removed Lines]",
          "1160:         if (!PACKET_get_bytes(&pkt, &ecparams, 3)) {",
          "",
          "[Added Lines]",
          "1142:         if (!PACKET_get_bytes(pkt, &ecparams, 3)) {",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "1205:             goto err;",
          "1206:         }",
          "1209:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1210:             goto f_err;",
          "1211:         }",
          "",
          "[Removed Lines]",
          "1208:         if (!PACKET_get_length_prefixed_1(&pkt, &encoded_pt)) {",
          "",
          "[Added Lines]",
          "1190:         if (!PACKET_get_length_prefixed_1(pkt, &encoded_pt)) {",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "1255:         if (!PACKET_get_sub_packet(&save_param_start, &params,",
          "1256:                                    PACKET_remaining(&save_param_start) -",
          "1258:             al = SSL_AD_INTERNAL_ERROR;",
          "1259:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "1260:             goto f_err;",
          "",
          "[Removed Lines]",
          "1257:                                    PACKET_remaining(&pkt))) {",
          "",
          "[Added Lines]",
          "1239:                                    PACKET_remaining(pkt))) {",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "1263:         if (SSL_USE_SIGALGS(s)) {",
          "1264:             unsigned char *sigalgs;",
          "1265:             int rv;",
          "1267:                 SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_TOO_SHORT);",
          "1268:                 goto f_err;",
          "1269:             }",
          "",
          "[Removed Lines]",
          "1266:             if (!PACKET_get_bytes(&pkt, &sigalgs, 2)) {",
          "",
          "[Added Lines]",
          "1248:             if (!PACKET_get_bytes(pkt, &sigalgs, 2)) {",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "1280:             md = EVP_sha1();",
          "1281:         }",
          "1285:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1286:             goto f_err;",
          "1287:         }",
          "",
          "[Removed Lines]",
          "1283:         if (!PACKET_get_length_prefixed_2(&pkt, &signature)",
          "1284:             || PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "1265:         if (!PACKET_get_length_prefixed_2(pkt, &signature)",
          "1266:             || PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "1362:             goto err;",
          "1363:         }",
          "1366:             SSLerr(SSL_F_TLS_PROCESS_KEY_EXCHANGE, SSL_R_EXTRA_DATA_IN_MESSAGE);",
          "1367:             goto f_err;",
          "1368:         }",
          "",
          "[Removed Lines]",
          "1365:         if (PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "1347:         if (PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "1390:     return MSG_PROCESS_ERROR;",
          "1391: }",
          "1394: {",
          "1395:     int ret = MSG_PROCESS_ERROR;",
          "1396:     unsigned int list_len, ctype_num, i, name_len;",
          "",
          "[Removed Lines]",
          "1393: enum MSG_PROCESS_RETURN tls_process_certificate_request(SSL *s, unsigned long n)",
          "",
          "[Added Lines]",
          "1375: enum MSG_PROCESS_RETURN tls_process_certificate_request(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "1398:     unsigned char *data;",
          "1399:     unsigned char *namestart, *namebytes;",
          "1400:     STACK_OF(X509_NAME) *ca_sk = NULL;",
          "1409:     if ((ca_sk = sk_X509_NAME_new(ca_dn_cmp)) == NULL) {",
          "1410:         SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST, ERR_R_MALLOC_FAILURE);",
          "",
          "[Removed Lines]",
          "1401:     PACKET pkt;",
          "1403:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "1404:         ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_INTERNAL_ERROR);",
          "1405:         SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST, ERR_R_INTERNAL_ERROR);",
          "1406:         goto err;",
          "1407:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "1412:     }",
          "1417:         ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);",
          "1418:         SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST, SSL_R_LENGTH_MISMATCH);",
          "1419:         goto err;",
          "",
          "[Removed Lines]",
          "1415:     if (!PACKET_get_1(&pkt, &ctype_num)",
          "1416:             || !PACKET_get_bytes(&pkt, &data, ctype_num)) {",
          "",
          "[Added Lines]",
          "1390:     if (!PACKET_get_1(pkt, &ctype_num)",
          "1391:             || !PACKET_get_bytes(pkt, &data, ctype_num)) {",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "1435:         s->s3->tmp.ctype[i] = data[i];",
          "1437:     if (SSL_USE_SIGALGS(s)) {",
          "1440:             ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);",
          "1441:             SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST,",
          "1442:                    SSL_R_LENGTH_MISMATCH);",
          "",
          "[Removed Lines]",
          "1438:         if (!PACKET_get_net_2(&pkt, &list_len)",
          "1439:                 || !PACKET_get_bytes(&pkt, &data, list_len)) {",
          "",
          "[Added Lines]",
          "1413:         if (!PACKET_get_net_2(pkt, &list_len)",
          "1414:                 || !PACKET_get_bytes(pkt, &data, list_len)) {",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "1462:     }",
          "1467:         ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);",
          "1468:         SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST, SSL_R_LENGTH_MISMATCH);",
          "1469:         goto err;",
          "1470:     }",
          "1475:             ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);",
          "1476:             SSLerr(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST,",
          "1477:                    SSL_R_LENGTH_MISMATCH);",
          "",
          "[Removed Lines]",
          "1465:     if (!PACKET_get_net_2(&pkt, &list_len)",
          "1466:             || PACKET_remaining(&pkt) != list_len) {",
          "1472:     while (PACKET_remaining(&pkt)) {",
          "1473:         if (!PACKET_get_net_2(&pkt, &name_len)",
          "1474:                 || !PACKET_get_bytes(&pkt, &namebytes, name_len)) {",
          "",
          "[Added Lines]",
          "1440:     if (!PACKET_get_net_2(pkt, &list_len)",
          "1441:             || PACKET_remaining(pkt) != list_len) {",
          "1447:     while (PACKET_remaining(pkt)) {",
          "1448:         if (!PACKET_get_net_2(pkt, &name_len)",
          "1449:                 || !PACKET_get_bytes(pkt, &namebytes, name_len)) {",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "1520:     return (X509_NAME_cmp(*a, *b));",
          "1521: }",
          "1524: {",
          "1525:     int al;",
          "1526:     unsigned int ticklen;",
          "1527:     unsigned long ticket_lifetime_hint;",
          "1539:         al = SSL_AD_DECODE_ERROR;",
          "1540:         SSLerr(SSL_F_SSL3_GET_NEW_SESSION_TICKET, SSL_R_LENGTH_MISMATCH);",
          "1541:         goto f_err;",
          "",
          "[Removed Lines]",
          "1523: enum MSG_PROCESS_RETURN tls_process_new_session_ticket(SSL *s, unsigned long n)",
          "1528:     PACKET pkt;",
          "1530:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "1531:         al = SSL_AD_INTERNAL_ERROR;",
          "1532:         SSLerr(SSL_F_TLS_PROCESS_NEW_SESSION_TICKET, ERR_R_INTERNAL_ERROR);",
          "1533:         goto f_err;",
          "1534:     }",
          "1536:     if (!PACKET_get_net_4(&pkt, &ticket_lifetime_hint)",
          "1537:             || !PACKET_get_net_2(&pkt, &ticklen)",
          "1538:             || PACKET_remaining(&pkt) != ticklen) {",
          "",
          "[Added Lines]",
          "1498: enum MSG_PROCESS_RETURN tls_process_new_session_ticket(SSL *s, PACKET *pkt)",
          "1504:     if (!PACKET_get_net_4(pkt, &ticket_lifetime_hint)",
          "1505:             || !PACKET_get_net_2(pkt, &ticklen)",
          "1506:             || PACKET_remaining(pkt) != ticklen) {",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "1584:         SSLerr(SSL_F_TLS_PROCESS_NEW_SESSION_TICKET, ERR_R_MALLOC_FAILURE);",
          "1585:         goto err;",
          "1586:     }",
          "1588:         al = SSL_AD_DECODE_ERROR;",
          "1589:         SSLerr(SSL_F_TLS_PROCESS_NEW_SESSION_TICKET, SSL_R_LENGTH_MISMATCH);",
          "1590:         goto f_err;",
          "",
          "[Removed Lines]",
          "1587:     if (!PACKET_copy_bytes(&pkt, s->session->tlsext_tick, ticklen)) {",
          "",
          "[Added Lines]",
          "1555:     if (!PACKET_copy_bytes(pkt, s->session->tlsext_tick, ticklen)) {",
          "",
          "---------------",
          "--- Hunk 31 ---",
          "[Context before]",
          "1614:     return MSG_PROCESS_ERROR;",
          "1615: }",
          "1618: {",
          "1619:     int al;",
          "1620:     unsigned long resplen;",
          "1621:     unsigned int type;",
          "1630:             || type != TLSEXT_STATUSTYPE_ocsp) {",
          "1631:         al = SSL_AD_DECODE_ERROR;",
          "1632:         SSLerr(SSL_F_TLS_PROCESS_CERT_STATUS, SSL_R_UNSUPPORTED_STATUS_TYPE);",
          "1633:         goto f_err;",
          "1634:     }",
          "1637:         al = SSL_AD_DECODE_ERROR;",
          "1638:         SSLerr(SSL_F_TLS_PROCESS_CERT_STATUS, SSL_R_LENGTH_MISMATCH);",
          "1639:         goto f_err;",
          "",
          "[Removed Lines]",
          "1617: enum MSG_PROCESS_RETURN tls_process_cert_status(SSL *s, unsigned long n)",
          "1622:     PACKET pkt;",
          "1624:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "1625:         al = SSL_AD_INTERNAL_ERROR;",
          "1626:         SSLerr(SSL_F_TLS_PROCESS_CERT_STATUS, ERR_R_INTERNAL_ERROR);",
          "1627:         goto f_err;",
          "1628:     }",
          "1629:     if (!PACKET_get_1(&pkt, &type)",
          "1635:     if (!PACKET_get_net_3(&pkt, &resplen)",
          "1636:             || PACKET_remaining(&pkt) != resplen) {",
          "",
          "[Added Lines]",
          "1585: enum MSG_PROCESS_RETURN tls_process_cert_status(SSL *s, PACKET *pkt)",
          "1591:     if (!PACKET_get_1(pkt, &type)",
          "1597:     if (!PACKET_get_net_3(pkt, &resplen)",
          "1598:             || PACKET_remaining(pkt) != resplen) {",
          "",
          "---------------",
          "--- Hunk 32 ---",
          "[Context before]",
          "1645:         SSLerr(SSL_F_TLS_PROCESS_CERT_STATUS, ERR_R_MALLOC_FAILURE);",
          "1646:         goto f_err;",
          "1647:     }",
          "1649:         al = SSL_AD_DECODE_ERROR;",
          "1650:         SSLerr(SSL_F_TLS_PROCESS_CERT_STATUS, SSL_R_LENGTH_MISMATCH);",
          "1651:         goto f_err;",
          "",
          "[Removed Lines]",
          "1648:     if (!PACKET_copy_bytes(&pkt, s->tlsext_ocsp_resp, resplen)) {",
          "",
          "[Added Lines]",
          "1610:     if (!PACKET_copy_bytes(pkt, s->tlsext_ocsp_resp, resplen)) {",
          "",
          "---------------",
          "--- Hunk 33 ---",
          "[Context before]",
          "1672:     return MSG_PROCESS_ERROR;",
          "1673: }",
          "1676: {",
          "1679:         ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);",
          "1680:         SSLerr(SSL_F_TLS_PROCESS_SERVER_DONE, SSL_R_LENGTH_MISMATCH);",
          "",
          "[Removed Lines]",
          "1675: enum MSG_PROCESS_RETURN tls_process_server_done(SSL *s, unsigned long n)",
          "1677:     if (n > 0) {",
          "",
          "[Added Lines]",
          "1637: enum MSG_PROCESS_RETURN tls_process_server_done(SSL *s, PACKET *pkt)",
          "1639:     if (PACKET_remaining(pkt) > 0) {",
          "",
          "---------------"
        ],
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "204:     return 1;",
          "205: }",
          "208: {",
          "209:     int i, al = SSL_AD_INTERNAL_ERROR;",
          "210:     unsigned int j, complen = 0;",
          "",
          "[Removed Lines]",
          "207: enum MSG_PROCESS_RETURN tls_process_client_hello(SSL *s, long n)",
          "",
          "[Added Lines]",
          "207: enum MSG_PROCESS_RETURN tls_process_client_hello(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "216:     STACK_OF(SSL_CIPHER) *ciphers = NULL;",
          "217:     int protverr = 1;",
          "220:     int is_v2_record;",
          "228:     is_v2_record = RECORD_LAYER_is_sslv2_record(&s->rlayer);",
          "230:     PACKET_null_init(&cookie);",
          "",
          "[Removed Lines]",
          "219:     PACKET pkt, session_id, cipher_suites, compression, extensions, cookie;",
          "222:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "223:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "224:         al = SSL_AD_INTERNAL_ERROR;",
          "225:         goto f_err;",
          "226:     }",
          "",
          "[Added Lines]",
          "219:     PACKET session_id, cipher_suites, compression, extensions, cookie;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "251:                 || mt != SSL2_MT_CLIENT_HELLO) {",
          "",
          "[Removed Lines]",
          "250:         if (!PACKET_get_1(&pkt, &mt)",
          "",
          "[Added Lines]",
          "244:         if (!PACKET_get_1(pkt, &mt)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "258:             goto err;",
          "259:         }",
          "263:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "264:             goto err;",
          "",
          "[Removed Lines]",
          "261:         if (!PACKET_get_net_2(&pkt, &version)) {",
          "",
          "[Added Lines]",
          "255:         if (!PACKET_get_net_2(pkt, &version)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "284:             al = SSL_AD_DECODE_ERROR;",
          "285:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_LENGTH_TOO_SHORT);",
          "286:             goto f_err;",
          "",
          "[Removed Lines]",
          "283:         if(!PACKET_get_net_2(&pkt, (unsigned int *)&s->client_version)) {",
          "",
          "[Added Lines]",
          "277:         if(!PACKET_get_net_2(pkt, (unsigned int *)&s->client_version)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "365:         unsigned int cipher_len, session_id_len, challenge_len;",
          "366:         PACKET challenge;",
          "371:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO,",
          "372:                    SSL_R_RECORD_LENGTH_MISMATCH);",
          "373:             al = SSL_AD_DECODE_ERROR;",
          "374:             goto f_err;",
          "375:         }",
          "382:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_RECORD_LENGTH_MISMATCH);",
          "383:             al = SSL_AD_DECODE_ERROR;",
          "384:             goto f_err;",
          "",
          "[Removed Lines]",
          "368:         if (!PACKET_get_net_2(&pkt, &cipher_len)",
          "369:                 || !PACKET_get_net_2(&pkt, &session_id_len)",
          "370:                 || !PACKET_get_net_2(&pkt, &challenge_len)) {",
          "377:         if (!PACKET_get_sub_packet(&pkt, &cipher_suites, cipher_len)",
          "378:             || !PACKET_get_sub_packet(&pkt, &session_id, session_id_len)",
          "379:             || !PACKET_get_sub_packet(&pkt, &challenge, challenge_len)",
          "381:             || PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "362:         if (!PACKET_get_net_2(pkt, &cipher_len)",
          "363:                 || !PACKET_get_net_2(pkt, &session_id_len)",
          "364:                 || !PACKET_get_net_2(pkt, &challenge_len)) {",
          "371:         if (!PACKET_get_sub_packet(pkt, &cipher_suites, cipher_len)",
          "372:             || !PACKET_get_sub_packet(pkt, &session_id, session_id_len)",
          "373:             || !PACKET_get_sub_packet(pkt, &challenge, challenge_len)",
          "375:             || PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "400:         PACKET_null_init(&extensions);",
          "401:     } else {",
          "405:             al = SSL_AD_DECODE_ERROR;",
          "406:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_LENGTH_MISMATCH);",
          "407:             goto f_err;",
          "408:         }",
          "410:         if (SSL_IS_DTLS(s)) {",
          "412:                 al = SSL_AD_DECODE_ERROR;",
          "413:                 SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_LENGTH_MISMATCH);",
          "414:                 goto f_err;",
          "",
          "[Removed Lines]",
          "403:         if (!PACKET_copy_bytes(&pkt, s->s3->client_random, SSL3_RANDOM_SIZE)",
          "404:             || !PACKET_get_length_prefixed_1(&pkt, &session_id)) {",
          "411:             if (!PACKET_get_length_prefixed_1(&pkt, &cookie)) {",
          "",
          "[Added Lines]",
          "397:         if (!PACKET_copy_bytes(pkt, s->s3->client_random, SSL3_RANDOM_SIZE)",
          "398:             || !PACKET_get_length_prefixed_1(pkt, &session_id)) {",
          "405:             if (!PACKET_get_length_prefixed_1(pkt, &cookie)) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "424:             }",
          "425:         }",
          "429:                 al = SSL_AD_DECODE_ERROR;",
          "430:                 SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_LENGTH_MISMATCH);",
          "431:                 goto f_err;",
          "432:         }",
          "435:     }",
          "437:     s->hit = 0;",
          "",
          "[Removed Lines]",
          "427:         if (!PACKET_get_length_prefixed_2(&pkt, &cipher_suites)",
          "428:             || !PACKET_get_length_prefixed_1(&pkt, &compression)) {",
          "434:         extensions = pkt;",
          "",
          "[Added Lines]",
          "421:         if (!PACKET_get_length_prefixed_2(pkt, &cipher_suites)",
          "422:             || !PACKET_get_length_prefixed_1(pkt, &compression)) {",
          "428:         extensions = *pkt;",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1497:     return 0;",
          "1498: }",
          "1501: {",
          "1502:     int al;",
          "1503:     unsigned int i;",
          "",
          "[Removed Lines]",
          "1500: enum MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, long n)",
          "",
          "[Added Lines]",
          "1494: enum MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1516:     EC_POINT *clnt_ecpoint = NULL;",
          "1517:     BN_CTX *bn_ctx = NULL;",
          "1518: #endif",
          "1520:     unsigned char *data, *rsa_decrypt = NULL;",
          "1528:     alg_k = s->s3->tmp.new_cipher->algorithm_mkey;",
          "1530: #ifndef OPENSSL_NO_PSK",
          "",
          "[Removed Lines]",
          "1519:     PACKET pkt, enc_premaster;",
          "1522:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "1523:         al = SSL_AD_INTERNAL_ERROR;",
          "1524:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "1525:         goto f_err;",
          "1526:     }",
          "",
          "[Added Lines]",
          "1513:     PACKET enc_premaster;",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1532:     if (alg_k & SSL_PSK) {",
          "1533:         unsigned char psk[PSK_MAX_PSK_LEN];",
          "1534:         size_t psklen;",
          "1538:             al = SSL_AD_DECODE_ERROR;",
          "1539:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1540:             goto f_err;",
          "",
          "[Removed Lines]",
          "1535:  PACKET psk_identity;",
          "1537:         if (!PACKET_get_length_prefixed_2(&pkt, &psk_identity)) {",
          "",
          "[Added Lines]",
          "1523:         PACKET psk_identity;",
          "1525:         if (!PACKET_get_length_prefixed_2(pkt, &psk_identity)) {",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1589:     }",
          "1590:     if (alg_k & SSL_kPSK) {",
          "1593:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1594:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "1595:             goto f_err;",
          "",
          "[Removed Lines]",
          "1592:         if (PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "1580:         if (PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1639:         if (s->version == SSL3_VERSION || s->version == DTLS1_BAD_VER) {",
          "1641:         } else {",
          "1646:                 if (s->options & SSL_OP_TLS_D5_BUG) {",
          "1647:                     enc_premaster = orig;",
          "",
          "[Removed Lines]",
          "1640:             enc_premaster = pkt;",
          "1642:             PACKET orig = pkt;",
          "1643:             if (!PACKET_get_length_prefixed_2(&pkt, &enc_premaster)",
          "1644:                 || PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "1628:             enc_premaster = *pkt;",
          "1630:             PACKET orig = *pkt;",
          "1631:             if (!PACKET_get_length_prefixed_2(pkt, &enc_premaster)",
          "1632:                 || PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1764:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd | SSL_kDHEPSK)) {",
          "1765:         int idx = -1;",
          "1766:         EVP_PKEY *skey = NULL;",
          "1768:         unsigned char shared[(OPENSSL_DH_MAX_MODULUS_BITS + 7) / 8];",
          "1771:             if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "1772:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1773:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "[Removed Lines]",
          "1767:         PACKET bookmark = pkt;",
          "1770:         if (!PACKET_get_net_2(&pkt, &i)) {",
          "",
          "[Added Lines]",
          "1755:         PACKET bookmark = *pkt;",
          "1758:         if (!PACKET_get_net_2(pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1776:             }",
          "1777:             i = 0;",
          "1778:         }",
          "1780:             if (!(s->options & SSL_OP_SSLEAY_080_CLIENT_DH_BUG)) {",
          "1781:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "1782:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "1783:                 goto err;",
          "1784:             } else {",
          "1787:             }",
          "1788:         }",
          "1789:         if (alg_k & SSL_kDHr)",
          "",
          "[Removed Lines]",
          "1779:         if (PACKET_remaining(&pkt) != i) {",
          "1785:                 pkt = bookmark;",
          "1786:                 i = PACKET_remaining(&pkt);",
          "",
          "[Added Lines]",
          "1767:         if (PACKET_remaining(pkt) != i) {",
          "1774:                 i = PACKET_remaining(pkt);",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1808:         } else",
          "1809:             dh_srvr = s->s3->tmp.dh;",
          "1813:             EVP_PKEY *clkey = X509_get_pubkey(s->session->peer);",
          "1814:             if (clkey) {",
          "",
          "[Removed Lines]",
          "1811:         if (n == 0L) {",
          "",
          "[Added Lines]",
          "1799:         if (PACKET_remaining(pkt) == 0L) {",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1824:             EVP_PKEY_free(clkey);",
          "1825:             pub = dh_clnt->pub_key;",
          "1826:         } else {",
          "1829:                 al = SSL_AD_INTERNAL_ERROR;",
          "1830:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "[Removed Lines]",
          "1827:             if (!PACKET_get_bytes(&pkt, &data, i)) {",
          "",
          "[Added Lines]",
          "1815:             if (!PACKET_get_bytes(pkt, &data, i)) {",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "1906:             goto err;",
          "1907:         }",
          "1912:             if (alg_k & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "",
          "[Removed Lines]",
          "1909:         if (n == 0L) {",
          "",
          "[Added Lines]",
          "1897:         if (PACKET_remaining(pkt) == 0L) {",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "1950:             }",
          "1954:                 al = SSL_AD_DECODE_ERROR;",
          "1955:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "1956:                        SSL_R_LENGTH_MISMATCH);",
          "1957:                 goto f_err;",
          "1958:             }",
          "1961:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "1962:                 goto err;",
          "1963:             }",
          "",
          "[Removed Lines]",
          "1953:             if (!PACKET_get_1(&pkt, &i)) {",
          "1959:             if (!PACKET_get_bytes(&pkt, &data, i)",
          "1960:                     || PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "1941:             if (!PACKET_get_1(pkt, &i)) {",
          "1947:             if (!PACKET_get_bytes(pkt, &data, i)",
          "1948:                     || PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "2003: #endif",
          "2004: #ifndef OPENSSL_NO_SRP",
          "2005:     if (alg_k & SSL_kSRP) {",
          "2008:             al = SSL_AD_DECODE_ERROR;",
          "2009:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_BAD_SRP_A_LENGTH);",
          "2010:             goto f_err;",
          "",
          "[Removed Lines]",
          "2006:         if (!PACKET_get_net_2(&pkt, &i)",
          "2007:                 || !PACKET_get_bytes(&pkt, &data, i)) {",
          "",
          "[Added Lines]",
          "1994:         if (!PACKET_get_net_2(pkt, &i)",
          "1995:                 || !PACKET_get_bytes(pkt, &data, i)) {",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "2041:         unsigned long alg_a;",
          "2042:         int Ttag, Tclass;",
          "2043:         long Tlen;",
          "2046:         alg_a = s->s3->tmp.new_cipher->algorithm_auth;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2032:         long sess_key_len;",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "2061:                 ERR_clear_error();",
          "2062:         }",
          "2065:             al = SSL_AD_INTERNAL_ERROR;",
          "2066:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2067:             goto f_err;",
          "2068:         }",
          "2072:             || Tclass != V_ASN1_UNIVERSAL) {",
          "2073:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2074:                    SSL_R_DECRYPTION_FAILED);",
          "",
          "[Removed Lines]",
          "2064:         if (!PACKET_get_bytes(&pkt, &data, n)) {",
          "2069:         if (ASN1_get_object",
          "2070:             ((const unsigned char **)&data, &Tlen, &Ttag, &Tclass,",
          "2071:              n) != V_ASN1_CONSTRUCTED || Ttag != V_ASN1_SEQUENCE",
          "",
          "[Added Lines]",
          "2053:         sess_key_len = PACKET_remaining(pkt);",
          "2054:         if (!PACKET_get_bytes(pkt, &data, sess_key_len)) {",
          "2059:         if (ASN1_get_object ((const unsigned char **)&data, &Tlen, &Ttag,",
          "2060:                              &Tclass, sess_key_len) != V_ASN1_CONSTRUCTED",
          "2061:             || Ttag != V_ASN1_SEQUENCE",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "2239:     return WORK_FINISHED_CONTINUE;",
          "2240: }",
          "2243: {",
          "2244:     EVP_PKEY *pkey = NULL;",
          "2245:     unsigned char *sig, *data;",
          "",
          "[Removed Lines]",
          "2242: enum MSG_PROCESS_RETURN tls_process_cert_verify(SSL *s, long n)",
          "",
          "[Added Lines]",
          "2232: enum MSG_PROCESS_RETURN tls_process_cert_verify(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "2249:     X509 *peer;",
          "2250:     const EVP_MD *md = NULL;",
          "2251:     EVP_MD_CTX mctx;",
          "2253:     EVP_MD_CTX_init(&mctx);",
          "2255:     peer = s->session->peer;",
          "",
          "[Removed Lines]",
          "2252:     PACKET pkt;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "2263:         goto f_err;",
          "2264:     }",
          "2278:         len = 64;",
          "2279:     } else {",
          "2280:         if (SSL_USE_SIGALGS(s)) {",
          "2281:             int rv;",
          "2284:                 al = SSL_AD_DECODE_ERROR;",
          "2285:                 goto f_err;",
          "2286:             }",
          "",
          "[Removed Lines]",
          "2267:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2268:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "2269:         al = SSL_AD_INTERNAL_ERROR;",
          "2270:         goto f_err;",
          "2271:     }",
          "2277:     if (n == 64 && pkey->type == NID_id_GostR3410_2001) {",
          "2283:             if (!PACKET_get_bytes(&pkt, &sig, 2)) {",
          "",
          "[Added Lines]",
          "2260:     if (PACKET_remaining(pkt) == 64 && pkey->type == NID_id_GostR3410_2001) {",
          "2266:             if (!PACKET_get_bytes(pkt, &sig, 2)) {",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "2296:             fprintf(stderr, \"USING TLSv1.2 HASH %s\\n\", EVP_MD_name(md));",
          "2297: #endif",
          "2298:         }",
          "2300:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "2301:             al = SSL_AD_DECODE_ERROR;",
          "2302:             goto f_err;",
          "2303:         }",
          "2304:     }",
          "2305:     j = EVP_PKEY_size(pkey);",
          "2307:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_WRONG_SIGNATURE_SIZE);",
          "2308:         al = SSL_AD_DECODE_ERROR;",
          "2309:         goto f_err;",
          "2310:     }",
          "2312:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "2313:         al = SSL_AD_DECODE_ERROR;",
          "2314:         goto f_err;",
          "",
          "[Removed Lines]",
          "2299:         if (!PACKET_get_net_2(&pkt, &len)) {",
          "2306:     if (((int)len > j) || ((int)PACKET_remaining(&pkt) > j) || (n <= 0)) {",
          "2311:     if (!PACKET_get_bytes(&pkt, &data, len)) {",
          "",
          "[Added Lines]",
          "2282:         if (!PACKET_get_net_2(pkt, &len)) {",
          "2289:     if (((int)len > j) || ((int)PACKET_remaining(pkt) > j)",
          "2290:             || (PACKET_remaining(pkt) == 0)) {",
          "2295:     if (!PACKET_get_bytes(pkt, &data, len)) {",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "2421:     return ret;",
          "2422: }",
          "2425: {",
          "2426:     int i, al, ret = MSG_PROCESS_ERROR;",
          "2427:     X509 *x = NULL;",
          "",
          "[Removed Lines]",
          "2424: enum MSG_PROCESS_RETURN tls_process_client_certificate(SSL *s, long n)",
          "",
          "[Added Lines]",
          "2408: enum MSG_PROCESS_RETURN tls_process_client_certificate(SSL *s, PACKET *pkt)",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "2429:     const unsigned char *certstart;",
          "2430:     unsigned char *certbytes;",
          "2431:     STACK_OF(X509) *sk = NULL;",
          "2440:     if ((sk = sk_X509_new_null()) == NULL) {",
          "2441:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "2442:         goto f_err;",
          "2443:     }",
          "2448:         al = SSL_AD_DECODE_ERROR;",
          "2449:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, SSL_R_LENGTH_MISMATCH);",
          "2450:         goto f_err;",
          "",
          "[Removed Lines]",
          "2432:     PACKET pkt, spkt;",
          "2434:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2435:         al = SSL_AD_INTERNAL_ERROR;",
          "2436:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "2437:         goto f_err;",
          "2438:     }",
          "2445:     if (!PACKET_get_net_3(&pkt, &llen)",
          "2446:             || !PACKET_get_sub_packet(&pkt, &spkt, llen)",
          "2447:             || PACKET_remaining(&pkt) != 0) {",
          "",
          "[Added Lines]",
          "2416:     PACKET spkt;",
          "2423:     if (!PACKET_get_net_3(pkt, &llen)",
          "2424:             || !PACKET_get_sub_packet(pkt, &spkt, llen)",
          "2425:             || PACKET_remaining(pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "2752: {",
          "2754:     size_t next_proto_len;",
          "",
          "[Removed Lines]",
          "2751: enum MSG_PROCESS_RETURN tls_process_next_proto(SSL *s, long n)",
          "2753:     PACKET pkt, next_proto, padding;",
          "2756:     if (n < 2) {",
          "2758:     }",
          "2760:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2761:         SSLerr(SSL_F_TLS_PROCESS_NEXT_PROTO, ERR_R_INTERNAL_ERROR);",
          "2762:         goto err;",
          "2763:     }",
          "",
          "[Added Lines]",
          "2729: enum MSG_PROCESS_RETURN tls_process_next_proto(SSL *s, PACKET *pkt)",
          "2731:     PACKET next_proto, padding;",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "2775:         SSLerr(SSL_F_TLS_PROCESS_NEXT_PROTO, SSL_R_LENGTH_MISMATCH);",
          "2776:         goto err;",
          "2777:     }",
          "",
          "[Removed Lines]",
          "2772:     if (!PACKET_get_length_prefixed_1(&pkt, &next_proto)",
          "2773:         || !PACKET_get_length_prefixed_1(&pkt, &padding)",
          "2774:         || PACKET_remaining(&pkt) > 0) {",
          "",
          "[Added Lines]",
          "2741:     if (!PACKET_get_length_prefixed_1(pkt, &next_proto)",
          "2742:         || !PACKET_get_length_prefixed_1(pkt, &padding)",
          "2743:         || PACKET_remaining(pkt) > 0) {",
          "",
          "---------------"
        ],
        "ssl/ssl_err.c||ssl/ssl_err.c": [
          "File: ssl/ssl_err.c -> ssl/ssl_err.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "118:      \"dtls_construct_hello_verify_request\"},",
          "119:     {ERR_FUNC(SSL_F_DTLS_GET_REASSEMBLED_MESSAGE),",
          "120:      \"DTLS_GET_REASSEMBLED_MESSAGE\"},",
          "121:     {ERR_FUNC(SSL_F_READ_STATE_MACHINE), \"READ_STATE_MACHINE\"},",
          "122:     {ERR_FUNC(SSL_F_SSL3_ACCEPT), \"ssl3_accept\"},",
          "123:     {ERR_FUNC(SSL_F_SSL3_ADD_CERT_TO_BUF), \"SSL3_ADD_CERT_TO_BUF\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "121:     {ERR_FUNC(SSL_F_DTLS_PROCESS_HELLO_VERIFY), \"dtls_process_hello_verify\"},",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "524:      \"invalid ticket keys length\"},",
          "525:     {ERR_REASON(SSL_R_INVALID_TRUST), \"invalid trust\"},",
          "526:     {ERR_REASON(SSL_R_LENGTH_MISMATCH), \"length mismatch\"},",
          "527:     {ERR_REASON(SSL_R_LENGTH_TOO_SHORT), \"length too short\"},",
          "528:     {ERR_REASON(SSL_R_LIBRARY_BUG), \"library bug\"},",
          "529:     {ERR_REASON(SSL_R_LIBRARY_HAS_NO_CIPHERS), \"library has no ciphers\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "528:     {ERR_REASON(SSL_R_LENGTH_TOO_LONG), \"length too long\"},",
          "",
          "---------------"
        ],
        "ssl/ssl_locl.h||ssl/ssl_locl.h": [
          "File: ssl/ssl_locl.h -> ssl/ssl_locl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "2003: __owur int tls_construct_server_certificate(SSL *s);",
          "2004: __owur int tls_construct_new_session_ticket(SSL *s);",
          "2005: __owur int tls_construct_cert_status(SSL *s);",
          "2008: __owur int ssl3_setup_key_block(SSL *s);",
          "2009: __owur int tls_construct_change_cipher_spec(SSL *s);",
          "2010: __owur int dtls_construct_change_cipher_spec(SSL *s);",
          "",
          "[Removed Lines]",
          "2006: __owur enum MSG_PROCESS_RETURN tls_process_change_cipher_spec(SSL *s, long n);",
          "2007: __owur enum MSG_PROCESS_RETURN tls_process_finished(SSL *s, unsigned long n);",
          "",
          "[Added Lines]",
          "2006: __owur enum MSG_PROCESS_RETURN tls_process_change_cipher_spec(SSL *s,",
          "2007:                                                               PACKET *pkt);",
          "2008: __owur enum MSG_PROCESS_RETURN tls_process_finished(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2107: __owur int tls_construct_client_hello(SSL *s);",
          "2108: __owur enum MSG_PROCESS_RETURN tls_process_server_hello(SSL *s,",
          "2110: __owur enum MSG_PROCESS_RETURN tls_process_certificate_request(SSL *s,",
          "2112: __owur enum MSG_PROCESS_RETURN tls_process_new_session_ticket(SSL *s,",
          "2116: __owur int tls_construct_client_verify(SSL *s);",
          "2117: __owur enum WORK_STATE tls_prepare_client_certificate(SSL *s,",
          "2118:                                                       enum WORK_STATE wst);",
          "",
          "[Removed Lines]",
          "2109:                                                         unsigned long n);",
          "2111:                                                                unsigned long n);",
          "2113:                                                               unsigned long n);",
          "2114: __owur enum MSG_PROCESS_RETURN tls_process_cert_status(SSL *s, unsigned long n);",
          "2115: __owur enum MSG_PROCESS_RETURN tls_process_server_done(SSL *s, unsigned long n);",
          "",
          "[Added Lines]",
          "2110:                                                         PACKET *pkt);",
          "2112:                                                                PACKET *pkt);",
          "2114:                                                               PACKET *pkt);",
          "2115: __owur enum MSG_PROCESS_RETURN tls_process_cert_status(SSL *s, PACKET *pkt);",
          "2116: __owur enum MSG_PROCESS_RETURN tls_process_server_done(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2121: __owur int tls_construct_client_key_exchange(SSL *s);",
          "2122: __owur int tls_client_key_exchange_post_work(SSL *s);",
          "2123: __owur enum MSG_PROCESS_RETURN tls_process_key_exchange(SSL *s,",
          "2125: __owur enum MSG_PROCESS_RETURN tls_process_server_certificate(SSL *s,",
          "2127: __owur int ssl3_check_cert_and_algorithm(SSL *s);",
          "2128: #  ifndef OPENSSL_NO_NEXTPROTONEG",
          "2129: __owur int tls_construct_next_proto(SSL *s);",
          "2130: #  endif",
          "2136: __owur enum WORK_STATE tls_post_process_client_hello(SSL *s,",
          "2137:                                                      enum WORK_STATE wst);",
          "2138: __owur int tls_construct_server_hello(SSL *s);",
          "",
          "[Removed Lines]",
          "2124:                                                         unsigned long n);",
          "2126:                                                               unsigned long n);",
          "2131: __owur enum MSG_PROCESS_RETURN dtls_process_hello_verify(SSL *s,",
          "2132:                                                          unsigned long n);",
          "2135: __owur enum MSG_PROCESS_RETURN tls_process_client_hello(SSL *s, long n);",
          "",
          "[Added Lines]",
          "2125:                                                         PACKET *pkt);",
          "2127:                                                               PACKET *pkt);",
          "2132: __owur enum MSG_PROCESS_RETURN dtls_process_hello_verify(SSL *s, PACKET *pkt);",
          "2135: __owur enum MSG_PROCESS_RETURN tls_process_client_hello(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2141: __owur int tls_construct_server_key_exchange(SSL *s);",
          "2142: __owur int tls_construct_certificate_request(SSL *s);",
          "2143: __owur int tls_construct_server_done(SSL *s);",
          "2146: __owur enum WORK_STATE tls_post_process_client_key_exchange(SSL *s,",
          "2147:     enum WORK_STATE wst);",
          "2149: #  ifndef OPENSSL_NO_NEXTPROTONEG",
          "2151: #  endif",
          "2153: __owur int tls1_new(SSL *s);",
          "",
          "[Removed Lines]",
          "2144: __owur enum MSG_PROCESS_RETURN tls_process_client_certificate(SSL *s, long n);",
          "2145: __owur enum MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, long n);",
          "2148: __owur enum MSG_PROCESS_RETURN tls_process_cert_verify(SSL *s, long n);",
          "2150: __owur enum MSG_PROCESS_RETURN tls_process_next_proto(SSL *s, long n);",
          "",
          "[Added Lines]",
          "2144: __owur enum MSG_PROCESS_RETURN tls_process_client_certificate(SSL *s,",
          "2145:                                                               PACKET *pkt);",
          "2146: __owur enum MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s,",
          "2147:                                                                PACKET *pkt);",
          "2150: __owur enum MSG_PROCESS_RETURN tls_process_cert_verify(SSL *s, PACKET *pkt);",
          "2152: __owur enum MSG_PROCESS_RETURN tls_process_next_proto(SSL *s, PACKET *pkt);",
          "",
          "---------------"
        ],
        "ssl/statem.c||ssl/statem.c": [
          "File: ssl/statem.c -> ssl/statem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "116: static enum WORK_STATE client_post_work(SSL *s, enum WORK_STATE wst);",
          "117: static int client_construct_message(SSL *s);",
          "118: static unsigned long client_max_message_size(SSL *s);",
          "121: static enum WORK_STATE client_post_process_message(SSL *s, enum WORK_STATE wst);",
          "122: static int server_read_transition(SSL *s, int mt);",
          "123: static inline int send_server_key_exchange(SSL *s);",
          "",
          "[Removed Lines]",
          "119: static enum MSG_PROCESS_RETURN client_process_message(SSL *s,",
          "120:                                                       unsigned long len);",
          "",
          "[Added Lines]",
          "119: static enum MSG_PROCESS_RETURN client_process_message(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "127: static enum WORK_STATE server_post_work(SSL *s, enum WORK_STATE wst);",
          "128: static int server_construct_message(SSL *s);",
          "129: static unsigned long server_max_message_size(SSL *s);",
          "131: static enum WORK_STATE server_post_process_message(SSL *s, enum WORK_STATE wst);",
          "",
          "[Removed Lines]",
          "130: static enum MSG_PROCESS_RETURN server_process_message(SSL *s, unsigned long len);",
          "",
          "[Added Lines]",
          "129: static enum MSG_PROCESS_RETURN server_process_message(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "529:     int ret, mt;",
          "530:     unsigned long len;",
          "531:     int (*transition)(SSL *s, int mt);",
          "533:     enum WORK_STATE (*post_process_message)(SSL *s, enum WORK_STATE wst);",
          "534:     unsigned long (*max_message_size)(SSL *s);",
          "535:     void (*cb) (const SSL *ssl, int type, int val) = NULL;",
          "",
          "[Removed Lines]",
          "532:     enum MSG_PROCESS_RETURN (*process_message)(SSL *s, unsigned long n);",
          "",
          "[Added Lines]",
          "531:     PACKET pkt;",
          "532:     enum MSG_PROCESS_RETURN (*process_message)(SSL *s, PACKET *pkt);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "612:             }",
          "614:             s->first_packet = 0;",
          "616:             if (ret == MSG_PROCESS_ERROR) {",
          "617:                 return SUB_STATE_ERROR;",
          "618:             }",
          "",
          "[Removed Lines]",
          "615:             ret = process_message(s, len);",
          "",
          "[Added Lines]",
          "615:             if (!PACKET_buf_init(&pkt, s->init_msg, len)) {",
          "616:                 ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_INTERNAL_ERROR);",
          "617:                 SSLerr(SSL_F_READ_STATE_MACHINE, ERR_R_INTERNAL_ERROR);",
          "618:                 return SUB_STATE_ERROR;",
          "619:             }",
          "620:             ret = process_message(s, &pkt);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1448: {",
          "1449:     STATEM *st = &s->statem;",
          "1451:     switch(st->hand_state) {",
          "1452:         case TLS_ST_CR_SRVR_HELLO:",
          "1455:         case DTLS_ST_CR_HELLO_VERIFY_REQUEST:",
          "1458:         case TLS_ST_CR_CERT:",
          "1461:         case TLS_ST_CR_CERT_STATUS:",
          "1464:         case TLS_ST_CR_KEY_EXCH:",
          "1467:         case TLS_ST_CR_CERT_REQ:",
          "1470:         case TLS_ST_CR_SRVR_DONE:",
          "1473:         case TLS_ST_CR_CHANGE:",
          "1476:         case TLS_ST_CR_SESSION_TICKET:",
          "1479:         case TLS_ST_CR_FINISHED:",
          "1482:         default:",
          "",
          "[Removed Lines]",
          "1447: static enum MSG_PROCESS_RETURN client_process_message(SSL *s, unsigned long len)",
          "1453:             return tls_process_server_hello(s, len);",
          "1456:             return dtls_process_hello_verify(s, len);",
          "1459:             return tls_process_server_certificate(s, len);",
          "1462:             return tls_process_cert_status(s, len);",
          "1465:             return tls_process_key_exchange(s, len);",
          "1468:             return tls_process_certificate_request(s, len);",
          "1471:             return tls_process_server_done(s, len);",
          "1474:             return tls_process_change_cipher_spec(s, len);",
          "1477:             return tls_process_new_session_ticket(s, len);",
          "1480:             return tls_process_finished(s, len);",
          "",
          "[Added Lines]",
          "1452: static enum MSG_PROCESS_RETURN client_process_message(SSL *s, PACKET *pkt)",
          "1458:             return tls_process_server_hello(s, pkt);",
          "1461:             return dtls_process_hello_verify(s, pkt);",
          "1464:             return tls_process_server_certificate(s, pkt);",
          "1467:             return tls_process_cert_status(s, pkt);",
          "1470:             return tls_process_key_exchange(s, pkt);",
          "1473:             return tls_process_certificate_request(s, pkt);",
          "1476:             return tls_process_server_done(s, pkt);",
          "1479:             return tls_process_change_cipher_spec(s, pkt);",
          "1482:             return tls_process_new_session_ticket(s, pkt);",
          "1485:             return tls_process_finished(s, pkt);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2166: {",
          "2167:     STATEM *st = &s->statem;",
          "2169:     switch(st->hand_state) {",
          "2170:     case TLS_ST_SR_CLNT_HELLO:",
          "2173:     case TLS_ST_SR_CERT:",
          "2176:     case TLS_ST_SR_KEY_EXCH:",
          "2179:     case TLS_ST_SR_CERT_VRFY:",
          "2182: #ifndef OPENSSL_NO_NEXTPROTONEG",
          "2183:     case TLS_ST_SR_NEXT_PROTO:",
          "2185: #endif",
          "2187:     case TLS_ST_SR_CHANGE:",
          "2190:     case TLS_ST_SR_FINISHED:",
          "2193:     default:",
          "",
          "[Removed Lines]",
          "2164: static enum MSG_PROCESS_RETURN  server_process_message(SSL *s,",
          "2165:                                                        unsigned long len)",
          "2171:         return tls_process_client_hello(s, len);",
          "2174:         return tls_process_client_certificate(s, len);",
          "2177:         return tls_process_client_key_exchange(s, len);",
          "2180:         return tls_process_cert_verify(s, len);",
          "2184:         return tls_process_next_proto(s, len);",
          "2188:         return tls_process_change_cipher_spec(s, len);",
          "2191:         return tls_process_finished(s, len);",
          "",
          "[Added Lines]",
          "2169: static enum MSG_PROCESS_RETURN  server_process_message(SSL *s, PACKET *pkt)",
          "2175:         return tls_process_client_hello(s, pkt);",
          "2178:         return tls_process_client_certificate(s, pkt);",
          "2181:         return tls_process_client_key_exchange(s, pkt);",
          "2184:         return tls_process_cert_verify(s, pkt);",
          "2188:         return tls_process_next_proto(s, pkt);",
          "2192:         return tls_process_change_cipher_spec(s, pkt);",
          "2195:         return tls_process_finished(s, pkt);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "efcdbcbeda556876c0147dca21d51610de30dfd9",
      "candidate_info": {
        "commit_hash": "efcdbcbeda556876c0147dca21d51610de30dfd9",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/efcdbcbeda556876c0147dca21d51610de30dfd9",
        "files": [
          "ssl/s3_srvr.c"
        ],
        "message": "PACKETise ClientKeyExchange processing\n\nUse the new PACKET code to process the CKE message\n\nReviewed-by: Stephen Henson <steve@openssl.org>",
        "before_after_code_files": [
          "ssl/s3_srvr.c||ssl/s3_srvr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ],
          "candidate": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ]
        }
      },
      "candidate_diff": {
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2212: int ssl3_get_client_key_exchange(SSL *s)",
          "2213: {",
          "2215:     long n;",
          "2216:     unsigned long alg_k;",
          "2218: #ifndef OPENSSL_NO_RSA",
          "2219:     RSA *rsa = NULL;",
          "2220:     EVP_PKEY *pkey = NULL;",
          "",
          "[Removed Lines]",
          "2214:     int i, al, ok;",
          "2217:     unsigned char *p;",
          "",
          "[Added Lines]",
          "2214:     unsigned int i;",
          "2215:     int al, ok;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2229:     EC_POINT *clnt_ecpoint = NULL;",
          "2230:     BN_CTX *bn_ctx = NULL;",
          "2231: #endif",
          "2233:     n = s->method->ssl_get_message(s,",
          "2234:                                    SSL3_ST_SR_KEY_EXCH_A,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2232:     PACKET pkt;",
          "2233:     unsigned char *data;",
          "2234:     size_t remain;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2238:     if (!ok)",
          "2239:         return ((int)n);",
          "2242:     alg_k = s->s3->tmp.new_cipher->algorithm_mkey;",
          "",
          "[Removed Lines]",
          "2240:     p = (unsigned char *)s->init_msg;",
          "",
          "[Added Lines]",
          "2243:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2244:         al = SSL_AD_INTERNAL_ERROR;",
          "2245:         SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2246:         goto f_err;",
          "2247:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2246:     if (alg_k & SSL_PSK) {",
          "2247:         unsigned char psk[PSK_MAX_PSK_LEN];",
          "2248:         size_t psklen;",
          "2256:             al = SSL_AD_DECODE_ERROR;",
          "2257:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2258:             goto f_err;",
          "",
          "[Removed Lines]",
          "2249:         if (n < 2) {",
          "2250:             al = SSL_AD_DECODE_ERROR;",
          "2251:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2252:             goto f_err;",
          "2253:         }",
          "2254:         n2s(p, i);",
          "2255:         if (i + 2 > n) {",
          "",
          "[Added Lines]",
          "2257:         if (!PACKET_get_net_2(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2271:         }",
          "2273:         OPENSSL_free(s->session->psk_identity);",
          "2276:         if (s->session->psk_identity == NULL) {",
          "2277:             al = SSL_AD_INTERNAL_ERROR;",
          "2278:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2279:                    ERR_R_MALLOC_FAILURE);",
          "2280:             goto f_err;",
          "2281:         }",
          "2283:         psklen = s->psk_server_callback(s, s->session->psk_identity,",
          "2284:                                          psk, sizeof(psk));",
          "",
          "[Removed Lines]",
          "2274:         s->session->psk_identity = BUF_strndup((char *)p, i);",
          "",
          "[Added Lines]",
          "2276:         s->session->psk_identity = OPENSSL_malloc(i + 1);",
          "2283:         if (!PACKET_copy_bytes(&pkt, (unsigned char *)s->session->psk_identity,",
          "2284:                                i)) {",
          "2285:             al = SSL_AD_DECODE_ERROR;",
          "2286:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2287:             goto f_err;",
          "2288:         }",
          "2289:         s->session->psk_identity[i] = '\\0';",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2308:         }",
          "2310:         s->s3->tmp.psklen = psklen;",
          "2314:     }",
          "2315:     if (alg_k & SSL_kPSK) {",
          "2318:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "2319:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2320:             goto f_err;",
          "",
          "[Removed Lines]",
          "2312:         n -= i + 2;",
          "2313:         p += i;",
          "2317:         if (n != 0) {",
          "",
          "[Added Lines]",
          "2322:         if (PACKET_remaining(&pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2364:         if (s->version > SSL3_VERSION && s->version != DTLS1_BAD_VER) {",
          "2367:                 if (!(s->options & SSL_OP_TLS_D5_BUG)) {",
          "2368:                     al = SSL_AD_DECODE_ERROR;",
          "2369:                     SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2370:                            SSL_R_TLS_RSA_ENCRYPTED_VALUE_LENGTH_IS_WRONG);",
          "2371:                     goto f_err;",
          "2376:         }",
          "",
          "[Removed Lines]",
          "2365:             n2s(p, i);",
          "2366:             if (n != i + 2) {",
          "2372:                 } else",
          "2373:                     p -= 2;",
          "2374:             } else",
          "2375:                 n = i;",
          "",
          "[Added Lines]",
          "2370:             if (!PACKET_get_net_2(&pkt, &i)) {",
          "2371:                 al = SSL_AD_DECODE_ERROR;",
          "2372:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2373:                 goto f_err;",
          "2374:             }",
          "2375:             remain = PACKET_remaining(&pkt);",
          "2376:             if (remain != i) {",
          "2382:                 } else {",
          "2383:                     remain += 2;",
          "2384:                     if (!PACKET_back(&pkt, 2)) {",
          "2389:                         al = SSL_AD_INTERNAL_ERROR;",
          "2390:                         SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2391:                                ERR_R_INTERNAL_ERROR);",
          "2392:                         goto f_err;",
          "2393:                     }",
          "2394:                 }",
          "2395:             }",
          "2396:         } else {",
          "2397:             remain = PACKET_remaining(&pkt);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2386:             al = SSL_AD_DECRYPT_ERROR;",
          "2387:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2388:                    SSL_R_TLS_RSA_ENCRYPTED_VALUE_LENGTH_IS_WRONG);",
          "2389:             goto f_err;",
          "2390:         }",
          "",
          "[Removed Lines]",
          "2385:         if (n < SSL_MAX_MASTER_KEY_LENGTH) {",
          "",
          "[Added Lines]",
          "2408:         if (remain < SSL_MAX_MASTER_KEY_LENGTH) {",
          "2415:         if (!PACKET_get_bytes(&pkt, &data, remain)) {",
          "2417:             al = SSL_AD_INTERNAL_ERROR;",
          "2418:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2419:             goto f_err;",
          "2420:         }",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2401:                               sizeof(rand_premaster_secret)) <= 0)",
          "2402:             goto err;",
          "2403:         decrypt_len =",
          "2405:         ERR_clear_error();",
          "",
          "[Removed Lines]",
          "2404:             RSA_private_decrypt((int)n, p, p, rsa, RSA_PKCS1_PADDING);",
          "",
          "[Added Lines]",
          "2433:             RSA_private_decrypt(remain, data, data, rsa, RSA_PKCS1_PADDING);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2422:         version_good =",
          "2424:         version_good &=",
          "",
          "[Removed Lines]",
          "2423:             constant_time_eq_8(p[0], (unsigned)(s->client_version >> 8));",
          "2425:             constant_time_eq_8(p[1], (unsigned)(s->client_version & 0xff));",
          "",
          "[Added Lines]",
          "2452:             constant_time_eq_8(data[0], (unsigned)(s->client_version >> 8));",
          "2454:             constant_time_eq_8(data[1], (unsigned)(s->client_version & 0xff));",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2436:         if (s->options & SSL_OP_TLS_ROLLBACK_BUG) {",
          "2437:             unsigned char workaround_good;",
          "2438:             workaround_good =",
          "2440:             workaround_good &=",
          "2442:             version_good |= workaround_good;",
          "2443:         }",
          "",
          "[Removed Lines]",
          "2439:                 constant_time_eq_8(p[0], (unsigned)(s->version >> 8));",
          "2441:                 constant_time_eq_8(p[1], (unsigned)(s->version & 0xff));",
          "",
          "[Added Lines]",
          "2468:                 constant_time_eq_8(data[0], (unsigned)(s->version >> 8));",
          "2470:                 constant_time_eq_8(data[1], (unsigned)(s->version & 0xff));",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2457:         for (j = 0; j < sizeof(rand_premaster_secret); j++) {",
          "2459:                                           rand_premaster_secret[j]);",
          "2460:         }",
          "2463:             al = SSL_AD_INTERNAL_ERROR;",
          "2464:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2465:             goto f_err;",
          "",
          "[Removed Lines]",
          "2458:             p[j] = constant_time_select_8(decrypt_good, p[j],",
          "2462:         if (!ssl_generate_master_secret(s, p, sizeof(rand_premaster_secret), 0)) {",
          "",
          "[Added Lines]",
          "2487:             data[j] = constant_time_select_8(decrypt_good, data[j],",
          "2491:         if (!ssl_generate_master_secret(s, data, sizeof(rand_premaster_secret),",
          "2492:                                         0)) {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "2470:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd | SSL_kDHEPSK)) {",
          "2471:         int idx = -1;",
          "2472:         EVP_PKEY *skey = NULL;",
          "2476:             if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "2477:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2478:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Removed Lines]",
          "2473:         if (n > 1) {",
          "2474:             n2s(p, i);",
          "2475:         } else {",
          "",
          "[Added Lines]",
          "2503:         size_t bookm;",
          "2504:         unsigned char shared[(OPENSSL_DH_MAX_MODULUS_BITS + 7) / 8];",
          "2506:         if (!PACKET_get_bookmark(&pkt, &bookm)) {",
          "2507:             al = SSL_AD_INTERNAL_ERROR;",
          "2508:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2509:             goto f_err;",
          "2510:         }",
          "2511:         if (!PACKET_get_net_2(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "2481:             }",
          "2482:             i = 0;",
          "2483:         }",
          "2485:             if (!(s->options & SSL_OP_SSLEAY_080_CLIENT_DH_BUG)) {",
          "2486:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2487:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "2488:                 goto err;",
          "2489:             } else {",
          "2492:             }",
          "2493:         }",
          "2494:         if (alg_k & SSL_kDHr)",
          "",
          "[Removed Lines]",
          "2484:         if (n && n != i + 2) {",
          "2490:                 p -= 2;",
          "2491:                 i = (int)n;",
          "",
          "[Added Lines]",
          "2520:         if (PACKET_remaining(&pkt) != i) {",
          "2526:                 if (!PACKET_goto_bookmark(&pkt, bookm)) {",
          "2527:                     al = SSL_AD_INTERNAL_ERROR;",
          "2528:                     SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2529:                            ERR_R_INTERNAL_ERROR);",
          "2530:                     goto f_err;",
          "2531:                 }",
          "2532:                 i = PACKET_remaining(&pkt);",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "2528:             }",
          "2529:             EVP_PKEY_free(clkey);",
          "2530:             pub = dh_clnt->pub_key;",
          "2533:         if (pub == NULL) {",
          "2534:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_BN_LIB);",
          "2535:             goto err;",
          "2536:         }",
          "2540:         if (i <= 0) {",
          "2541:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "",
          "[Removed Lines]",
          "2531:         } else",
          "2532:             pub = BN_bin2bn(p, i, NULL);",
          "2538:         i = DH_compute_key(p, pub, dh_srvr);",
          "",
          "[Added Lines]",
          "2572:         } else {",
          "2573:             if (!PACKET_get_bytes(&pkt, &data, i)) {",
          "2575:                 al = SSL_AD_INTERNAL_ERROR;",
          "2576:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2577:                        ERR_R_INTERNAL_ERROR);",
          "2578:                 goto f_err;",
          "2579:             }",
          "2580:             pub = BN_bin2bn(data, i, NULL);",
          "2581:         }",
          "2587:         i = DH_compute_key(shared, pub, dh_srvr);",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "2550:         else",
          "2551:             BN_clear_free(pub);",
          "2552:         pub = NULL;",
          "2554:             al = SSL_AD_INTERNAL_ERROR;",
          "2555:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2556:             goto f_err;",
          "",
          "[Removed Lines]",
          "2553:         if (!ssl_generate_master_secret(s, p, i, 0)) {",
          "",
          "[Added Lines]",
          "2602:         if (!ssl_generate_master_secret(s, shared, i, 0)) {",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "2567:         const EC_KEY *tkey;",
          "2568:         const EC_GROUP *group;",
          "2569:         const BIGNUM *priv_key;",
          "2572:         if ((srvr_ecdh = EC_KEY_new()) == NULL) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2619:         unsigned char *shared;",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "2645:             }",
          "2651:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2652:                 goto err;",
          "2653:             }",
          "2655:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2656:                 goto err;",
          "2657:             }",
          "2663:         }",
          "",
          "[Removed Lines]",
          "2648:             i = *p;",
          "2649:             p += 1;",
          "2650:             if (n != 1 + i) {",
          "2654:             if (EC_POINT_oct2point(group, clnt_ecpoint, p, i, bn_ctx) == 0) {",
          "2662:             p = (unsigned char *)s->init_buf->data;",
          "",
          "[Added Lines]",
          "2698:             if (!PACKET_get_1(&pkt, &i)) {",
          "2699:                 al = SSL_AD_DECODE_ERROR;",
          "2700:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2701:                        SSL_R_LENGTH_MISMATCH);",
          "2702:                 goto f_err;",
          "2703:             }",
          "2704:             if (!PACKET_get_bytes(&pkt, &data, i)",
          "2705:                     || PACKET_remaining(&pkt) != 0) {",
          "2709:             if (EC_POINT_oct2point(group, clnt_ecpoint, data, i, bn_ctx) == 0) {",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "2668:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "2669:             goto err;",
          "2670:         }",
          "2673:         if (i <= 0) {",
          "2674:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "2675:             goto err;",
          "2676:         }",
          "",
          "[Removed Lines]",
          "2671:         i = ECDH_compute_key(p, (field_size + 7) / 8, clnt_ecpoint, srvr_ecdh,",
          "2672:                              NULL);",
          "",
          "[Added Lines]",
          "2721:         shared = OPENSSL_malloc((field_size + 7) / 8);",
          "2722:         if (shared == NULL) {",
          "2723:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2724:             goto err;",
          "2725:         }",
          "2726:         i = ECDH_compute_key(shared, (field_size + 7) / 8, clnt_ecpoint,",
          "2727:                              srvr_ecdh, NULL);",
          "2730:             OPENSSL_free(shared);",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "2682:         EC_KEY_free(s->s3->tmp.ecdh);",
          "2683:         s->s3->tmp.ecdh = NULL;",
          "2686:             al = SSL_AD_INTERNAL_ERROR;",
          "2687:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2688:             goto f_err;",
          "",
          "[Removed Lines]",
          "2685:         if (!ssl_generate_master_secret(s, p, i, 0)) {",
          "",
          "[Added Lines]",
          "2741:         if (!ssl_generate_master_secret(s, shared, i, 1)) {",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "2692: #endif",
          "2693: #ifndef OPENSSL_NO_SRP",
          "2694:     if (alg_k & SSL_kSRP) {",
          "2700:             al = SSL_AD_DECODE_ERROR;",
          "2703:             goto f_err;",
          "2704:         }",
          "2706:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_BN_LIB);",
          "2707:             goto err;",
          "2708:         }",
          "",
          "[Removed Lines]",
          "2695:         int param_len;",
          "2697:         n2s(p, i);",
          "2698:         param_len = i + 2;",
          "2699:         if (param_len > n) {",
          "2701:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2702:                    SSL_R_BAD_SRP_A_LENGTH);",
          "2705:         if ((s->srp_ctx.A = BN_bin2bn(p, i, NULL)) == NULL) {",
          "",
          "[Added Lines]",
          "2751:         if (!PACKET_get_net_2(&pkt, &i)",
          "2752:                 || !PACKET_get_bytes(&pkt, &data, i)) {",
          "2754:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_BAD_SRP_A_LENGTH);",
          "2757:         if ((s->srp_ctx.A = BN_bin2bn(data, i, NULL)) == NULL) {",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "2724:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2725:             goto err;",
          "2726:         }",
          "2729:     } else",
          "2731:     if (alg_k & SSL_kGOST) {",
          "",
          "[Removed Lines]",
          "2728:         p += i;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "2757:                 ERR_clear_error();",
          "2758:         }",
          "2760:         if (ASN1_get_object",
          "2762:              n) != V_ASN1_CONSTRUCTED || Ttag != V_ASN1_SEQUENCE",
          "2763:             || Tclass != V_ASN1_UNIVERSAL) {",
          "2764:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2765:                    SSL_R_DECRYPTION_FAILED);",
          "2766:             goto gerr;",
          "2767:         }",
          "2769:         inlen = Tlen;",
          "2770:         if (EVP_PKEY_decrypt",
          "2771:             (pkey_ctx, premaster_secret, &outlen, start, inlen) <= 0) {",
          "",
          "[Removed Lines]",
          "2761:             ((const unsigned char **)&p, &Tlen, &Ttag, &Tclass,",
          "2768:         start = p;",
          "",
          "[Added Lines]",
          "2810:         if (!PACKET_get_bytes(&pkt, &data, n)) {",
          "2811:             al = SSL_AD_INTERNAL_ERROR;",
          "2812:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2813:             goto f_err;",
          "2814:         }",
          "2816:             ((const unsigned char **)&data, &Tlen, &Ttag, &Tclass,",
          "2823:         start = data;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4bd16463b84efb13ce5fb35add284e284b0fd819",
      "candidate_info": {
        "commit_hash": "4bd16463b84efb13ce5fb35add284e284b0fd819",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/4bd16463b84efb13ce5fb35add284e284b0fd819",
        "files": [
          "ssl/packet_locl.h",
          "ssl/s3_clnt.c",
          "ssl/s3_srvr.c",
          "ssl/t1_lib.c",
          "test/packettest.c"
        ],
        "message": "Remove PACKET_(get|goto)_bookmark\n\nThe bookmark API results in a lot of boilerplate error checking that can\nbe much more easily achieved with a simple struct copy. It also lays the\npath for removing the third PACKET field.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
        "before_after_code_files": [
          "ssl/packet_locl.h||ssl/packet_locl.h",
          "ssl/s3_clnt.c||ssl/s3_clnt.c",
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/t1_lib.c||ssl/t1_lib.c",
          "test/packettest.c||test/packettest.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ],
          "candidate": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ]
        }
      },
      "candidate_diff": {
        "ssl/packet_locl.h||ssl/packet_locl.h": [
          "File: ssl/packet_locl.h -> ssl/packet_locl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "421:     return 1;",
          "422: }",
          "",
          "[Removed Lines]",
          "425: __owur static inline int PACKET_get_bookmark(const PACKET *pkt, size_t *bm)",
          "426: {",
          "429:     return 1;",
          "430: }",
          "433: __owur static inline int PACKET_goto_bookmark(PACKET *pkt, size_t bm)",
          "434: {",
          "435:     if (bm > (size_t)(pkt->end - pkt->start))",
          "436:         return 0;",
          "438:     pkt->curr = pkt->start + bm;",
          "440:     return 1;",
          "441: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "ssl/s3_clnt.c||ssl/s3_clnt.c": [
          "File: ssl/s3_clnt.c -> ssl/s3_clnt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1102:     if (s->version >= TLS1_VERSION && s->tls_session_secret_cb &&",
          "1103:         s->session->tlsext_tick) {",
          "1104:         SSL_CIPHER *pref_cipher = NULL;",
          "1109:             SSLerr(SSL_F_SSL3_GET_SERVER_HELLO, SSL_R_LENGTH_MISMATCH);",
          "1110:             al = SSL_AD_DECODE_ERROR;",
          "1111:             goto f_err;",
          "",
          "[Removed Lines]",
          "1105:         size_t bookm;",
          "1106:         if (!PACKET_get_bookmark(&pkt, &bookm)",
          "1107:                 || !PACKET_forward(&pkt, j)",
          "1108:                 || !PACKET_get_bytes(&pkt, &cipherchars, ciphercharlen)) {",
          "",
          "[Added Lines]",
          "1105:         PACKET bookmark = pkt;",
          "1106:         if (!PACKET_forward(&pkt, j)",
          "1107:             || !PACKET_get_bytes(&pkt, &cipherchars, ciphercharlen)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1122:             al = SSL_AD_INTERNAL_ERROR;",
          "1123:             goto f_err;",
          "1124:         }",
          "1130:     }",
          "",
          "[Removed Lines]",
          "1125:         if (!PACKET_goto_bookmark(&pkt, bookm)) {",
          "1126:             SSLerr(SSL_F_SSL3_GET_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1127:             al = SSL_AD_INTERNAL_ERROR;",
          "1128:             goto f_err;",
          "1129:         }",
          "",
          "[Added Lines]",
          "1124:         pkt = bookmark;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1462:     int curve_nid = 0;",
          "1463:     unsigned int encoded_pt_len = 0;",
          "1464: #endif",
          "1466:     unsigned char *data, *param;",
          "1469:     EVP_MD_CTX_init(&md_ctx);",
          "",
          "[Removed Lines]",
          "1465:     PACKET pkt;",
          "1467:     size_t startparam, endparam;",
          "",
          "[Added Lines]",
          "1460:     PACKET pkt, save_param_start;",
          "1462:     size_t param_len;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1496:         return (1);",
          "1497:     }",
          "1501:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "1502:             al = SSL_AD_INTERNAL_ERROR;",
          "1503:             goto f_err;",
          "1504:     }",
          "1506: #ifndef OPENSSL_NO_RSA",
          "1507:     RSA_free(s->s3->peer_rsa_tmp);",
          "",
          "[Removed Lines]",
          "1499:     if (!PACKET_buf_init(&pkt, s->init_msg, n)",
          "1500:             || !PACKET_get_bookmark(&pkt, &startparam)) {",
          "",
          "[Added Lines]",
          "1494:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "1499:     save_param_start = pkt;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1894:     }",
          "1903:     if (pkey != NULL) {",
          "",
          "[Removed Lines]",
          "1897:     if (!PACKET_get_bookmark(&pkt, &endparam)) {",
          "1898:         SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "1899:         goto f_err;",
          "1900:     }",
          "",
          "[Added Lines]",
          "1896:     param_len = PACKET_remaining(&save_param_start) - PACKET_remaining(&pkt);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1939:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, SSL_R_WRONG_SIGNATURE_LENGTH);",
          "1940:             goto f_err;",
          "1941:         }",
          "1944:             al = SSL_AD_INTERNAL_ERROR;",
          "1945:             SSLerr(SSL_F_SSL3_GET_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "1946:             goto f_err;",
          "",
          "[Removed Lines]",
          "1942:         if (!PACKET_goto_bookmark(&pkt, startparam)",
          "1943:                 || !PACKET_get_bytes(&pkt, &param, endparam - startparam)) {",
          "",
          "[Added Lines]",
          "1938:         pkt = save_param_start;",
          "1939:         if (!PACKET_get_bytes(&pkt, &param, param_len)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1960:                                  SSL3_RANDOM_SIZE);",
          "1961:                 EVP_DigestUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "1962:                                  SSL3_RANDOM_SIZE);",
          "1964:                 EVP_DigestFinal_ex(&md_ctx, q, &size);",
          "1965:                 q += size;",
          "1966:                 j += size;",
          "",
          "[Removed Lines]",
          "1963:                 EVP_DigestUpdate(&md_ctx, param, endparam - startparam);",
          "",
          "[Added Lines]",
          "1959:                 EVP_DigestUpdate(&md_ctx, param, param_len);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1986:                              SSL3_RANDOM_SIZE);",
          "1987:             EVP_VerifyUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "1988:                              SSL3_RANDOM_SIZE);",
          "1990:             if (EVP_VerifyFinal(&md_ctx, data, (int)i, pkey) <= 0) {",
          "1992:                 al = SSL_AD_DECRYPT_ERROR;",
          "",
          "[Removed Lines]",
          "1989:             EVP_VerifyUpdate(&md_ctx, param, endparam - startparam);",
          "",
          "[Added Lines]",
          "1985:             EVP_VerifyUpdate(&md_ctx, param, param_len);",
          "",
          "---------------"
        ],
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2481:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd | SSL_kDHEPSK)) {",
          "2482:         int idx = -1;",
          "2483:         EVP_PKEY *skey = NULL;",
          "2485:         unsigned char shared[(OPENSSL_DH_MAX_MODULUS_BITS + 7) / 8];",
          "2492:         if (!PACKET_get_net_2(&pkt, &i)) {",
          "2493:             if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "2494:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "",
          "[Removed Lines]",
          "2484:         size_t bookm;",
          "2487:         if (!PACKET_get_bookmark(&pkt, &bookm)) {",
          "2488:             al = SSL_AD_INTERNAL_ERROR;",
          "2489:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2490:             goto f_err;",
          "2491:         }",
          "",
          "[Added Lines]",
          "2484:         PACKET bookmark = pkt;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2504:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "2505:                 goto err;",
          "2506:             } else {",
          "2513:                 i = PACKET_remaining(&pkt);",
          "2514:             }",
          "2515:         }",
          "",
          "[Removed Lines]",
          "2507:                 if (!PACKET_goto_bookmark(&pkt, bookm)) {",
          "2508:                     al = SSL_AD_INTERNAL_ERROR;",
          "2509:                     SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2510:                            ERR_R_INTERNAL_ERROR);",
          "2511:                     goto f_err;",
          "2512:                 }",
          "",
          "[Added Lines]",
          "2502:                 pkt = bookmark;",
          "",
          "---------------"
        ],
        "ssl/t1_lib.c||ssl/t1_lib.c": [
          "File: ssl/t1_lib.c -> ssl/t1_lib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2934:                         int len, SSL_SESSION **ret)",
          "2935: {",
          "2936:     unsigned int i;",
          "2938:     int retv = -1;",
          "",
          "[Removed Lines]",
          "2937:     size_t bookmark = 0;",
          "",
          "[Added Lines]",
          "2937:     PACKET bookmark = *pkt;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2949:     if ((s->version <= SSL3_VERSION))",
          "2950:         return 0;",
          "2957:     if (SSL_IS_DTLS(s)) {",
          "2958:         if (!PACKET_get_1(pkt, &i)",
          "",
          "[Removed Lines]",
          "2952:     if (!PACKET_get_bookmark(pkt, &bookmark)) {",
          "2953:         return -1;",
          "2954:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3043:     }",
          "3044:     retv = 0;",
          "3045: end:",
          "3048:     return retv;",
          "3049: }",
          "",
          "[Removed Lines]",
          "3046:     if (!PACKET_goto_bookmark(pkt, bookmark))",
          "3047:         return -1;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/packettest.c||test/packettest.c": [
          "File: test/packettest.c -> test/packettest.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "62: #define BUF_LEN 255",
          "65: {",
          "71:         fprintf(stderr, \"test_PACKET_remaining() failed\\n\");",
          "72:         return 0;",
          "73:     }",
          "",
          "[Removed Lines]",
          "64: static int test_PACKET_remaining(PACKET *pkt)",
          "66:     if (        PACKET_remaining(pkt) != BUF_LEN",
          "67:             || !PACKET_forward(pkt, BUF_LEN - 1)",
          "68:             ||  PACKET_remaining(pkt) != 1",
          "69:             || !PACKET_forward(pkt, 1)",
          "70:             ||  PACKET_remaining(pkt) != 0) {",
          "",
          "[Added Lines]",
          "64: static int test_PACKET_remaining(unsigned char buf[BUF_LEN])",
          "66:     PACKET pkt;",
          "68:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "69:             ||  PACKET_remaining(&pkt) != BUF_LEN",
          "70:             || !PACKET_forward(&pkt, BUF_LEN - 1)",
          "71:             ||  PACKET_remaining(&pkt) != 1",
          "72:             || !PACKET_forward(&pkt, 1)",
          "73:             ||  PACKET_remaining(&pkt) != 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "75:     return 1;",
          "76: }",
          "79: {",
          "80:     unsigned int i;",
          "84:             ||  i != 0x02",
          "87:             ||  i != 0xfe",
          "89:         fprintf(stderr, \"test_PACKET_get_1() failed\\n\");",
          "90:         return 0;",
          "91:     }",
          "",
          "[Removed Lines]",
          "78: static int test_PACKET_get_1(PACKET *pkt, size_t start)",
          "82:     if (       !PACKET_goto_bookmark(pkt, start)",
          "83:             || !PACKET_get_1(pkt, &i)",
          "85:             || !PACKET_forward(pkt, BUF_LEN - 2)",
          "86:             || !PACKET_get_1(pkt, &i)",
          "88:             ||  PACKET_get_1(pkt, &i)) {",
          "",
          "[Added Lines]",
          "81: static int test_PACKET_get_1(unsigned char buf[BUF_LEN])",
          "84:     PACKET pkt;",
          "86:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "87:             || !PACKET_get_1(&pkt, &i)",
          "89:             || !PACKET_forward(&pkt, BUF_LEN - 2)",
          "90:             || !PACKET_get_1(&pkt, &i)",
          "92:             ||  PACKET_get_1(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "93:     return 1;",
          "94: }",
          "97: {",
          "98:     unsigned long i;",
          "102:             ||  i != 0x08060402UL",
          "105:             ||  i != 0xfefcfaf8UL",
          "107:         fprintf(stderr, \"test_PACKET_get_4() failed\\n\");",
          "108:         return 0;",
          "109:     }",
          "",
          "[Removed Lines]",
          "96: static int test_PACKET_get_4(PACKET *pkt, size_t start)",
          "100:     if (       !PACKET_goto_bookmark(pkt, start)",
          "101:             || !PACKET_get_4(pkt, &i)",
          "103:             || !PACKET_forward(pkt, BUF_LEN - 8)",
          "104:             || !PACKET_get_4(pkt, &i)",
          "106:             ||  PACKET_get_4(pkt, &i)) {",
          "",
          "[Added Lines]",
          "100: static int test_PACKET_get_4(unsigned char buf[BUF_LEN])",
          "103:     PACKET pkt;",
          "105:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "106:             || !PACKET_get_4(&pkt, &i)",
          "108:             || !PACKET_forward(&pkt, BUF_LEN - 8)",
          "109:             || !PACKET_get_4(&pkt, &i)",
          "111:             ||  PACKET_get_4(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "111:     return 1;",
          "112: }",
          "115: {",
          "116:     unsigned int i;",
          "120:             ||  i != 0x0204",
          "123:             ||  i != 0xfcfe",
          "125:         fprintf(stderr, \"test_PACKET_get_net_2() failed\\n\");",
          "126:         return 0;",
          "127:     }",
          "",
          "[Removed Lines]",
          "114: static int test_PACKET_get_net_2(PACKET *pkt, size_t start)",
          "118:     if (       !PACKET_goto_bookmark(pkt, start)",
          "119:             || !PACKET_get_net_2(pkt, &i)",
          "121:             || !PACKET_forward(pkt, BUF_LEN - 4)",
          "122:             || !PACKET_get_net_2(pkt, &i)",
          "124:             ||  PACKET_get_net_2(pkt, &i)) {",
          "",
          "[Added Lines]",
          "119: static int test_PACKET_get_net_2(unsigned char buf[BUF_LEN])",
          "122:     PACKET pkt;",
          "124:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "125:             || !PACKET_get_net_2(&pkt, &i)",
          "127:             || !PACKET_forward(&pkt, BUF_LEN - 4)",
          "128:             || !PACKET_get_net_2(&pkt, &i)",
          "130:             ||  PACKET_get_net_2(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "129:     return 1;",
          "130: }",
          "133: {",
          "134:     unsigned long i;",
          "138:             ||  i != 0x020406UL",
          "141:             ||  i != 0xfafcfeUL",
          "143:         fprintf(stderr, \"test_PACKET_get_net_3() failed\\n\");",
          "144:         return 0;",
          "145:     }",
          "",
          "[Removed Lines]",
          "132: static int test_PACKET_get_net_3(PACKET *pkt, size_t start)",
          "136:     if (       !PACKET_goto_bookmark(pkt, start)",
          "137:             || !PACKET_get_net_3(pkt, &i)",
          "139:             || !PACKET_forward(pkt, BUF_LEN - 6)",
          "140:             || !PACKET_get_net_3(pkt, &i)",
          "142:             ||  PACKET_get_net_3(pkt, &i)) {",
          "",
          "[Added Lines]",
          "138: static int test_PACKET_get_net_3(unsigned char buf[BUF_LEN])",
          "141:     PACKET pkt;",
          "143:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "144:             || !PACKET_get_net_3(&pkt, &i)",
          "146:             || !PACKET_forward(&pkt, BUF_LEN - 6)",
          "147:             || !PACKET_get_net_3(&pkt, &i)",
          "149:             ||  PACKET_get_net_3(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "147:     return 1;",
          "148: }",
          "151: {",
          "152:     unsigned long i;",
          "156:             ||  i != 0x02040608UL",
          "159:             ||  i != 0xf8fafcfeUL",
          "161:         fprintf(stderr, \"test_PACKET_get_net_4() failed\\n\");",
          "162:         return 0;",
          "163:     }",
          "",
          "[Removed Lines]",
          "150: static int test_PACKET_get_net_4(PACKET *pkt, size_t start)",
          "154:     if (       !PACKET_goto_bookmark(pkt, start)",
          "155:             || !PACKET_get_net_4(pkt, &i)",
          "157:             || !PACKET_forward(pkt, BUF_LEN - 8)",
          "158:             || !PACKET_get_net_4(pkt, &i)",
          "160:             ||  PACKET_get_net_4(pkt, &i)) {",
          "",
          "[Added Lines]",
          "157: static int test_PACKET_get_net_4(unsigned char buf[BUF_LEN])",
          "160:     PACKET pkt;",
          "162:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "163:             || !PACKET_get_net_4(&pkt, &i)",
          "165:             || !PACKET_forward(&pkt, BUF_LEN - 8)",
          "166:             || !PACKET_get_net_4(&pkt, &i)",
          "168:             ||  PACKET_get_net_4(&pkt, &i)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "165:     return 1;",
          "166: }",
          "169: {",
          "171:     unsigned long i;",
          "175:             || !PACKET_get_net_4(&subpkt, &i)",
          "176:             ||  i != 0x02040608UL",
          "177:             ||  PACKET_remaining(&subpkt)",
          "180:             || !PACKET_get_net_4(&subpkt, &i)",
          "181:             ||  i != 0xf8fafcfeUL",
          "182:             ||  PACKET_remaining(&subpkt)",
          "184:         fprintf(stderr, \"test_PACKET_get_sub_packet() failed\\n\");",
          "185:         return 0;",
          "186:     }",
          "",
          "[Removed Lines]",
          "168: static int test_PACKET_get_sub_packet(PACKET *pkt, size_t start)",
          "170:     PACKET subpkt;",
          "173:     if (       !PACKET_goto_bookmark(pkt, start)",
          "174:             || !PACKET_get_sub_packet(pkt, &subpkt, 4)",
          "178:             || !PACKET_forward(pkt, BUF_LEN - 8)",
          "179:             || !PACKET_get_sub_packet(pkt, &subpkt, 4)",
          "183:             ||  PACKET_get_sub_packet(pkt, &subpkt, 4)) {",
          "",
          "[Added Lines]",
          "176: static int test_PACKET_get_sub_packet(unsigned char buf[BUF_LEN])",
          "178:     PACKET pkt, subpkt;",
          "181:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "182:             || !PACKET_get_sub_packet(&pkt, &subpkt, 4)",
          "186:             || !PACKET_forward(&pkt, BUF_LEN - 8)",
          "187:             || !PACKET_get_sub_packet(&pkt, &subpkt, 4)",
          "191:             ||  PACKET_get_sub_packet(&pkt, &subpkt, 4)) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "188:     return 1;",
          "189: }",
          "192: {",
          "193:     unsigned char *bytes;",
          "197:             ||  bytes[0] != 2 || bytes[1] != 4",
          "198:             ||  bytes[2] != 6 || bytes[3] != 8",
          "202:             ||  bytes[0] != 0xf8 || bytes[1] != 0xfa",
          "203:             ||  bytes[2] != 0xfc || bytes[3] != 0xfe",
          "205:         fprintf(stderr, \"test_PACKET_get_bytes() failed\\n\");",
          "206:         return 0;",
          "207:     }",
          "",
          "[Removed Lines]",
          "191: static int test_PACKET_get_bytes(PACKET *pkt, size_t start)",
          "195:     if (       !PACKET_goto_bookmark(pkt, start)",
          "196:             || !PACKET_get_bytes(pkt, &bytes, 4)",
          "199:             ||  PACKET_remaining(pkt) != BUF_LEN -4",
          "200:             || !PACKET_forward(pkt, BUF_LEN - 8)",
          "201:             || !PACKET_get_bytes(pkt, &bytes, 4)",
          "204:             ||  PACKET_remaining(pkt)) {",
          "",
          "[Added Lines]",
          "199: static int test_PACKET_get_bytes(unsigned char buf[BUF_LEN])",
          "202:     PACKET pkt;",
          "204:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "205:             || !PACKET_get_bytes(&pkt, &bytes, 4)",
          "208:             ||  PACKET_remaining(&pkt) != BUF_LEN -4",
          "209:             || !PACKET_forward(&pkt, BUF_LEN - 8)",
          "210:             || !PACKET_get_bytes(&pkt, &bytes, 4)",
          "213:             ||  PACKET_remaining(&pkt)) {",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "209:     return 1;",
          "210: }",
          "213: {",
          "214:     unsigned char bytes[4];",
          "218:             ||  bytes[0] != 2 || bytes[1] != 4",
          "219:             ||  bytes[2] != 6 || bytes[3] != 8",
          "223:             ||  bytes[0] != 0xf8 || bytes[1] != 0xfa",
          "224:             ||  bytes[2] != 0xfc || bytes[3] != 0xfe",
          "226:         fprintf(stderr, \"test_PACKET_copy_bytes() failed\\n\");",
          "227:         return 0;",
          "228:     }",
          "",
          "[Removed Lines]",
          "212: static int test_PACKET_copy_bytes(PACKET *pkt, size_t start)",
          "216:     if (       !PACKET_goto_bookmark(pkt, start)",
          "217:             || !PACKET_copy_bytes(pkt, bytes, 4)",
          "220:             ||  PACKET_remaining(pkt) != BUF_LEN - 4",
          "221:             || !PACKET_forward(pkt, BUF_LEN - 8)",
          "222:             || !PACKET_copy_bytes(pkt, bytes, 4)",
          "225:             ||  PACKET_remaining(pkt)) {",
          "",
          "[Added Lines]",
          "221: static int test_PACKET_copy_bytes(unsigned char buf[BUF_LEN])",
          "224:     PACKET pkt;",
          "226:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "227:             || !PACKET_copy_bytes(&pkt, bytes, 4)",
          "230:             ||  PACKET_remaining(&pkt) != BUF_LEN - 4",
          "231:             || !PACKET_forward(&pkt, BUF_LEN - 8)",
          "232:             || !PACKET_copy_bytes(&pkt, bytes, 4)",
          "235:             ||  PACKET_remaining(&pkt)) {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "230:     return 1;",
          "231: }",
          "234: {",
          "235:     unsigned char *data = NULL;",
          "236:     size_t len;",
          "239:             ||  len != BUF_LEN",
          "243:             ||  len != BUF_LEN - 10",
          "247:             ||  len != BUF_LEN - 9",
          "249:         fprintf(stderr, \"test_PACKET_memdup() failed\\n\");",
          "250:         OPENSSL_free(data);",
          "251:         return 0;",
          "",
          "[Removed Lines]",
          "233: static int test_PACKET_memdup(PACKET *pkt, size_t start)",
          "237:     if (       !PACKET_goto_bookmark(pkt, start)",
          "238:             || !PACKET_memdup(pkt, &data, &len)",
          "240:             ||  memcmp(data, PACKET_data(pkt), len)",
          "241:             || !PACKET_forward(pkt, 10)",
          "242:             || !PACKET_memdup(pkt, &data, &len)",
          "244:             ||  memcmp(data, PACKET_data(pkt), len)",
          "245:             || !PACKET_back(pkt, 1)",
          "246:             || !PACKET_memdup(pkt, &data, &len)",
          "248:                ||  memcmp(data, PACKET_data(pkt), len)) {",
          "",
          "[Added Lines]",
          "243: static int test_PACKET_memdup(unsigned char buf[BUF_LEN])",
          "247:     PACKET pkt;",
          "249:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "250:             || !PACKET_memdup(&pkt, &data, &len)",
          "252:             ||  memcmp(data, PACKET_data(&pkt), len)",
          "253:             || !PACKET_forward(&pkt, 10)",
          "254:             || !PACKET_memdup(&pkt, &data, &len)",
          "256:             ||  memcmp(data, PACKET_data(&pkt), len)",
          "257:             || !PACKET_back(&pkt, 1)",
          "258:             || !PACKET_memdup(&pkt, &data, &len)",
          "260:                ||  memcmp(data, PACKET_data(&pkt), len)) {",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "282:     return 1;",
          "283: }",
          "286: {",
          "287:     unsigned char *byte;",
          "294:             ||  byte[0] != 4",
          "304:         fprintf(stderr, \"test_PACKET_move_funcs() failed\\n\");",
          "305:         return 0;",
          "306:     }",
          "",
          "[Removed Lines]",
          "285: static int test_PACKET_move_funcs(PACKET *pkt, size_t start)",
          "288:     size_t bm;",
          "290:     if (       !PACKET_goto_bookmark(pkt, start)",
          "291:             ||  PACKET_back(pkt, 1)",
          "292:             || !PACKET_forward(pkt, 1)",
          "293:             || !PACKET_get_bytes(pkt, &byte, 1)",
          "295:             || !PACKET_get_bookmark(pkt, &bm)",
          "296:             || !PACKET_forward(pkt, BUF_LEN - 2)",
          "297:             ||  PACKET_forward(pkt, 1)",
          "298:             || !PACKET_back(pkt, 1)",
          "299:             || !PACKET_get_bytes(pkt, &byte, 1)",
          "300:             ||  byte[0] != 0xfe",
          "301:             || !PACKET_goto_bookmark(pkt, bm)",
          "302:             || !PACKET_get_bytes(pkt, &byte, 1)",
          "303:             ||  byte[0] != 6) {",
          "",
          "[Added Lines]",
          "297: static int test_PACKET_move_funcs(unsigned char buf[BUF_LEN])",
          "300:     PACKET pkt;",
          "302:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "303:             ||  PACKET_back(&pkt, 1)",
          "304:             || !PACKET_forward(&pkt, 1)",
          "305:             || !PACKET_get_bytes(&pkt, &byte, 1)",
          "307:             || !PACKET_forward(&pkt, BUF_LEN - 2)",
          "308:             ||  PACKET_forward(&pkt, 1)",
          "309:             || !PACKET_back(&pkt, 1)",
          "310:             || !PACKET_get_bytes(&pkt, &byte, 1)",
          "311:             ||  byte[0] != 0xfe) {",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "416: {",
          "417:     unsigned char buf[BUF_LEN];",
          "418:     unsigned int i;",
          "422:     for (i=1; i<=BUF_LEN; i++) {",
          "423:         buf[i-1] = (i * 2) & 0xff;",
          "424:     }",
          "425:     i = 0;",
          "433:     if (       !test_PACKET_buf_init()",
          "444:             || !test_PACKET_strndup()",
          "446:             || !test_PACKET_get_length_prefixed_1()",
          "447:             || !test_PACKET_get_length_prefixed_2()",
          "448:             || !test_PACKET_get_length_prefixed_3()) {",
          "",
          "[Removed Lines]",
          "419:     size_t start = 0;",
          "420:     PACKET pkt;",
          "427:     if (       !PACKET_buf_init(&pkt, buf, BUF_LEN)",
          "428:             || !PACKET_get_bookmark(&pkt, &start)) {",
          "429:         fprintf(stderr, \"setup failed\\n\");",
          "430:         return 0;",
          "431:     }",
          "434:             || !test_PACKET_remaining(&pkt)",
          "435:             || !test_PACKET_get_1(&pkt, start)",
          "436:             || !test_PACKET_get_4(&pkt, start)",
          "437:             || !test_PACKET_get_net_2(&pkt, start)",
          "438:             || !test_PACKET_get_net_3(&pkt, start)",
          "439:             || !test_PACKET_get_net_4(&pkt, start)",
          "440:             || !test_PACKET_get_sub_packet(&pkt, start)",
          "441:             || !test_PACKET_get_bytes(&pkt, start)",
          "442:             || !test_PACKET_copy_bytes(&pkt, start)",
          "443:             || !test_PACKET_memdup(&pkt, start)",
          "445:             || !test_PACKET_move_funcs(&pkt, start)",
          "",
          "[Added Lines]",
          "434:             || !test_PACKET_remaining(buf)",
          "435:             || !test_PACKET_get_1(buf)",
          "436:             || !test_PACKET_get_4(buf)",
          "437:             || !test_PACKET_get_net_2(buf)",
          "438:             || !test_PACKET_get_net_3(buf)",
          "439:             || !test_PACKET_get_net_4(buf)",
          "440:             || !test_PACKET_get_sub_packet(buf)",
          "441:             || !test_PACKET_get_bytes(buf)",
          "442:             || !test_PACKET_copy_bytes(buf)",
          "443:             || !test_PACKET_memdup(buf)",
          "445:             || !test_PACKET_move_funcs(buf)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e27f234a4147a7bd621d2a439c2cc2cc9a6a8382",
      "candidate_info": {
        "commit_hash": "e27f234a4147a7bd621d2a439c2cc2cc9a6a8382",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/e27f234a4147a7bd621d2a439c2cc2cc9a6a8382",
        "files": [
          "include/openssl/ssl.h",
          "ssl/d1_srvr.c",
          "ssl/s3_srvr.c",
          "ssl/ssl_err.c",
          "ssl/ssl_lib.c",
          "ssl/ssl_locl.h"
        ],
        "message": "Split TLS server functions\n\nSplit the TLS server ssl3_get_* and ssl3_send_* functions into two ready\nfor the migration to the new state machine code.\n\nReviewed-by: Tim Hudson <tjh@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>",
        "before_after_code_files": [
          "include/openssl/ssl.h||include/openssl/ssl.h",
          "ssl/d1_srvr.c||ssl/d1_srvr.c",
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/ssl_err.c||ssl/ssl_err.c",
          "ssl/ssl_lib.c||ssl/ssl_lib.c",
          "ssl/ssl_locl.h||ssl/ssl_locl.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ],
          "candidate": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ]
        }
      },
      "candidate_diff": {
        "include/openssl/ssl.h||include/openssl/ssl.h": [
          "File: include/openssl/ssl.h -> include/openssl/ssl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "2104: # define SSL_F_TLS1_SETUP_KEY_BLOCK                       211",
          "2105: # define SSL_F_TLS1_SET_SERVER_SIGALGS                    335",
          "2106: # define SSL_F_TLS_CLIENT_KEY_EXCHANGE_POST_WORK          354",
          "2107: # define SSL_F_TLS_CONSTRUCT_CLIENT_CERTIFICATE           355",
          "2108: # define SSL_F_TLS_CONSTRUCT_CLIENT_HELLO                 356",
          "2109: # define SSL_F_TLS_CONSTRUCT_CLIENT_KEY_EXCHANGE          357",
          "2110: # define SSL_F_TLS_CONSTRUCT_CLIENT_VERIFY                358",
          "2111: # define SSL_F_TLS_CONSTRUCT_FINISHED                     359",
          "2112: # define SSL_F_TLS_GET_MESSAGE_BODY                       351",
          "2113: # define SSL_F_TLS_GET_MESSAGE_HEADER                     350",
          "2114: # define SSL_F_TLS_PREPARE_CLIENT_CERTIFICATE             360",
          "2115: # define SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST            361",
          "2116: # define SSL_F_TLS_PROCESS_CERT_STATUS                    362",
          "2117: # define SSL_F_TLS_PROCESS_CHANGE_CIPHER_SPEC             363",
          "2118: # define SSL_F_TLS_PROCESS_FINISHED                       364",
          "2119: # define SSL_F_TLS_PROCESS_KEY_EXCHANGE                   365",
          "2120: # define SSL_F_TLS_PROCESS_NEW_SESSION_TICKET             366",
          "2121: # define SSL_F_TLS_PROCESS_SERVER_CERTIFICATE             367",
          "2122: # define SSL_F_TLS_PROCESS_SERVER_DONE                    368",
          "2123: # define SSL_F_TLS_PROCESS_SERVER_HELLO                   369",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2107: # define SSL_F_TLS_CONSTRUCT_CERTIFICATE_REQUEST          372",
          "2113: # define SSL_F_TLS_CONSTRUCT_HELLO_REQUEST                373",
          "2114: # define SSL_F_TLS_CONSTRUCT_SERVER_CERTIFICATE           374",
          "2115: # define SSL_F_TLS_CONSTRUCT_SERVER_DONE                  375",
          "2116: # define SSL_F_TLS_CONSTRUCT_SERVER_HELLO                 376",
          "2117: # define SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE          377",
          "2120: # define SSL_F_TLS_POST_PROCESS_CLIENT_HELLO              378",
          "2124: # define SSL_F_TLS_PROCESS_CERT_VERIFY                    379",
          "2126: # define SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE             380",
          "2127: # define SSL_F_TLS_PROCESS_CLIENT_HELLO                   381",
          "2128: # define SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE            382",
          "2132: # define SSL_F_TLS_PROCESS_NEXT_PROTO                     383",
          "",
          "---------------"
        ],
        "ssl/d1_srvr.c||ssl/d1_srvr.c": [
          "File: ssl/d1_srvr.c -> ssl/d1_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "317:                 goto end;",
          "318:             dtls1_stop_timer(s);",
          "321:                 s->state = DTLS1_ST_SW_HELLO_VERIFY_REQUEST_A;",
          "322:             else",
          "323:                 s->state = SSL3_ST_SW_SRVR_HELLO_A;",
          "",
          "[Removed Lines]",
          "320:             if (ret == 1 && (SSL_get_options(s) & SSL_OP_COOKIE_EXCHANGE))",
          "",
          "[Added Lines]",
          "320:             if (!s->d1->cookie_verified",
          "321:                     && (SSL_get_options(s) & SSL_OP_COOKIE_EXCHANGE))",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "599:             s->state = SSL3_ST_SR_CERT_VRFY_A;",
          "600:             s->init_num = 0;",
          "",
          "[Removed Lines]",
          "602:             if (ret == 2) {",
          "",
          "[Added Lines]",
          "603:             if (s->no_cert_verify) {",
          "",
          "---------------"
        ],
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "350:             ret = ssl3_get_client_hello(s);",
          "351:             if (ret <= 0)",
          "352:                 goto end;",
          "353: #ifndef OPENSSL_NO_SRP",
          "355:         case SSL3_ST_SR_CLNT_HELLO_D:",
          "356:             {",
          "363:                     goto end;",
          "373:                     ret = -1;",
          "375:                     goto end;",
          "376:                 }",
          "377:             }",
          "381:             s->state = SSL3_ST_SW_SRVR_HELLO_A;",
          "382:             s->init_num = 0;",
          "383:             break;",
          "385:         case SSL3_ST_SW_SRVR_HELLO_A:",
          "386:         case SSL3_ST_SW_SRVR_HELLO_B:",
          "",
          "[Removed Lines]",
          "354:             s->state = SSL3_ST_SR_CLNT_HELLO_D;",
          "357:                 int al;",
          "358:                 if ((ret = ssl_check_srp_ext_ClientHello(s, &al)) < 0) {",
          "362:                     s->rwstate = SSL_X509_LOOKUP;",
          "364:                 }",
          "365:                 if (ret != SSL_ERROR_NONE) {",
          "366:                     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "371:                     if (al != TLS1_AD_UNKNOWN_PSK_IDENTITY)",
          "372:                         SSLerr(SSL_F_SSL3_ACCEPT, SSL_R_CLIENTHELLO_TLSEXT);",
          "374:                     s->state = SSL_ST_ERR;",
          "378: #endif",
          "380:             s->renegotiate = 2;",
          "",
          "[Added Lines]",
          "353:             s->state = SSL3_ST_SW_SRVR_HELLO_A;",
          "354:             s->init_num = 0;",
          "355:             break;",
          "360:                 enum WORK_STATE wst_ret;",
          "362:                 wst_ret = tls_post_process_client_hello(s, WORK_MORE_B);",
          "363:                 if (wst_ret == WORK_MORE_B)",
          "365:                 if (wst_ret == WORK_ERROR) {",
          "374: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "569:             ret = ssl3_get_client_key_exchange(s);",
          "570:             if (ret <= 0)",
          "571:                 goto end;",
          "",
          "[Removed Lines]",
          "572:             if (ret == 2) {",
          "",
          "[Added Lines]",
          "563:             if (s->no_cert_verify) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "825: {",
          "827:     if (s->state == SSL3_ST_SW_HELLO_REQ_A) {",
          "830:             return -1;",
          "831:         }",
          "832:         s->state = SSL3_ST_SW_HELLO_REQ_B;",
          "",
          "[Removed Lines]",
          "828:         if (!ssl_set_handshake_header(s, SSL3_MT_HELLO_REQUEST, 0)) {",
          "829:             SSLerr(SSL_F_SSL3_SEND_HELLO_REQUEST, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "819:         if (tls_construct_hello_request(s) == 0) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "836:     return ssl_do_write(s);",
          "837: }",
          "839: int ssl3_get_client_hello(SSL *s)",
          "840: {",
          "843:     long n;",
          "855:     if (s->state == SSL3_ST_SR_CLNT_HELLO_C && !s->first_packet)",
          "856:         goto retry_cert;",
          "",
          "[Removed Lines]",
          "841:     int i, ok, al = SSL_AD_INTERNAL_ERROR, ret = -1;",
          "842:     unsigned int j, complen = 0;",
          "844:     unsigned long id;",
          "845:     SSL_CIPHER *c;",
          "846: #ifndef OPENSSL_NO_COMP",
          "847:     SSL_COMP *comp = NULL;",
          "848: #endif",
          "849:     STACK_OF(SSL_CIPHER) *ciphers = NULL;",
          "850:     int protverr = 1;",
          "852:     PACKET pkt, session_id, cipher_suites, compression, extensions, cookie;",
          "853:     int is_v2_record;",
          "",
          "[Added Lines]",
          "829: int tls_construct_hello_request(SSL *s)",
          "830: {",
          "831:     if (!ssl_set_handshake_header(s, SSL3_MT_HELLO_REQUEST, 0)) {",
          "832:         SSLerr(SSL_F_TLS_CONSTRUCT_HELLO_REQUEST, ERR_R_INTERNAL_ERROR);",
          "833:         statem_set_error(s);",
          "834:         return 0;",
          "835:     }",
          "837:     return 1;",
          "838: }",
          "842:     int ok;",
          "844:     enum WORK_STATE wst_ret;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "874:     if (!ok)",
          "875:         return ((int)n);",
          "876:     s->first_packet = 0;",
          "877:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "879:         al = SSL_AD_INTERNAL_ERROR;",
          "880:         goto f_err;",
          "881:     }",
          "",
          "[Removed Lines]",
          "878:         SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "869:     if (tls_process_client_hello(s, n) == 0)",
          "870:         return -1;",
          "872:  retry_cert:",
          "873:     wst_ret = tls_post_process_client_hello(s, WORK_MORE_A);",
          "874:     if (wst_ret == WORK_MORE_A || wst_ret == WORK_ERROR)",
          "875:         return -1;",
          "876:     if (wst_ret == WORK_MORE_B) {",
          "877:         s->state = SSL3_ST_SR_CLNT_HELLO_D;",
          "878:         return -1;",
          "879:     }",
          "880:     return n;",
          "881: }",
          "883: enum MSG_PROCESS_RETURN tls_process_client_hello(SSL *s, long n)",
          "884: {",
          "885:     int i, al = SSL_AD_INTERNAL_ERROR;",
          "886:     unsigned int j, complen = 0;",
          "887:     unsigned long id;",
          "888:     SSL_CIPHER *c;",
          "889: #ifndef OPENSSL_NO_COMP",
          "890:     SSL_COMP *comp = NULL;",
          "891: #endif",
          "892:     STACK_OF(SSL_CIPHER) *ciphers = NULL;",
          "893:     int protverr = 1;",
          "895:     PACKET pkt, session_id, cipher_suites, compression, extensions, cookie;",
          "896:     int is_v2_record;",
          "899:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "913:             goto err;",
          "914:         }",
          "916:         if (!PACKET_get_net_2(&pkt, &version)) {",
          "919:             goto err;",
          "920:         }",
          "921:         if (version == 0x0002) {",
          "924:             goto err;",
          "925:         } else if ((version & 0xff00) == (SSL3_VERSION_MAJOR << 8)) {",
          "927:             s->client_version = version;",
          "928:         } else {",
          "931:             goto err;",
          "932:         }",
          "933:     } else {",
          "",
          "[Removed Lines]",
          "912:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "918:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "923:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "930:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "",
          "[Added Lines]",
          "933:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "939:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "944:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "951:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "938:         if(!PACKET_get_net_2(&pkt, (unsigned int *)&s->client_version)) {",
          "939:             al = SSL_AD_DECODE_ERROR;",
          "941:             goto f_err;",
          "942:         }",
          "943:     }",
          "",
          "[Removed Lines]",
          "940:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_LENGTH_TOO_SHORT);",
          "",
          "[Added Lines]",
          "961:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_LENGTH_TOO_SHORT);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "998:     }",
          "1000:     if (protverr) {",
          "1002:         if ((!s->enc_write_ctx && !s->write_hash)) {",
          "",
          "[Removed Lines]",
          "1001:         SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "",
          "[Added Lines]",
          "1022:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_UNKNOWN_PROTOCOL);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1023:         if (!PACKET_get_net_2(&pkt, &cipher_len)",
          "1024:                 || !PACKET_get_net_2(&pkt, &session_id_len)",
          "1025:                 || !PACKET_get_net_2(&pkt, &challenge_len)) {",
          "1027:             al = SSL_AD_DECODE_ERROR;",
          "1028:             goto f_err;",
          "1029:         }",
          "",
          "[Removed Lines]",
          "1026:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_RECORD_LENGTH_MISMATCH);",
          "",
          "[Added Lines]",
          "1047:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO,",
          "1048:                    SSL_R_RECORD_LENGTH_MISMATCH);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1153:                 SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_COOKIE_MISMATCH);",
          "1154:                 goto f_err;",
          "1155:             }",
          "1158:         }",
          "1159:         if (s->method->version == DTLS_ANY_VERSION) {",
          "",
          "[Removed Lines]",
          "1157:             ret = -2;",
          "",
          "[Added Lines]",
          "1178:             s->d1->cookie_verified = 1;",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1278:                                                                (s));",
          "1279:             if (pref_cipher == NULL) {",
          "1280:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1282:                 goto f_err;",
          "1283:             }",
          "",
          "[Removed Lines]",
          "1281:                 SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_NO_SHARED_CIPHER);",
          "",
          "[Added Lines]",
          "1302:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_NO_SHARED_CIPHER);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1306:         if (!ssl_allow_compression(s)) {",
          "1308:                    SSL_R_INCONSISTENT_COMPRESSION);",
          "1309:             goto f_err;",
          "1310:         }",
          "",
          "[Removed Lines]",
          "1307:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,",
          "",
          "[Added Lines]",
          "1328:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO,",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1317:             }",
          "1318:         }",
          "1319:         if (s->s3->tmp.new_compression == NULL) {",
          "1321:                    SSL_R_INVALID_COMPRESSION_ALGORITHM);",
          "1322:             goto f_err;",
          "1323:         }",
          "",
          "[Removed Lines]",
          "1320:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,",
          "",
          "[Added Lines]",
          "1341:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO,",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1328:         }",
          "1329:         if (k >= complen) {",
          "1330:             al = SSL_AD_ILLEGAL_PARAMETER;",
          "1332:                    SSL_R_REQUIRED_COMPRESSSION_ALGORITHM_MISSING);",
          "1333:             goto f_err;",
          "1334:         }",
          "",
          "[Removed Lines]",
          "1331:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,",
          "",
          "[Added Lines]",
          "1352:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO,",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1365:     if (s->session->compress_meth != 0) {",
          "1367:         goto f_err;",
          "1368:     }",
          "1369: #endif",
          "",
          "[Removed Lines]",
          "1366:         SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_INCONSISTENT_COMPRESSION);",
          "",
          "[Added Lines]",
          "1387:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_INCONSISTENT_COMPRESSION);",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1382:         s->session->ciphers = ciphers;",
          "1383:         if (ciphers == NULL) {",
          "1384:             al = SSL_AD_INTERNAL_ERROR;",
          "1386:             goto f_err;",
          "1387:         }",
          "1388:         ciphers = NULL;",
          "1389:         if (!tls1_set_server_sigalgs(s)) {",
          "1391:             goto err;",
          "1392:         }",
          "1401:             }",
          "1405:             }",
          "1407:         }",
          "1414:         }",
          "1451:         }",
          "1452:     }",
          "1457:  f_err:",
          "1461:     }",
          "1465: }",
          "1468: {",
          "1469:     unsigned char *buf;",
          "1470:     unsigned char *p, *d;",
          "",
          "[Removed Lines]",
          "1385:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "1390:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_CLIENTHELLO_TLSEXT);",
          "1394:  retry_cert:",
          "1395:         if (s->cert->cert_cb) {",
          "1396:             int rv = s->cert->cert_cb(s, s->cert->cert_cb_arg);",
          "1397:             if (rv == 0) {",
          "1398:                 al = SSL_AD_INTERNAL_ERROR;",
          "1399:                 SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_CERT_CB_ERROR);",
          "1400:                 goto f_err;",
          "1402:             if (rv < 0) {",
          "1403:                 s->rwstate = SSL_X509_LOOKUP;",
          "1404:                 return -1;",
          "1406:             s->rwstate = SSL_NOTHING;",
          "1408:         c = ssl3_choose_cipher(s, s->session->ciphers, SSL_get_ciphers(s));",
          "1410:         if (c == NULL) {",
          "1411:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1412:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_NO_SHARED_CIPHER);",
          "1413:             goto f_err;",
          "1415:         s->s3->tmp.new_cipher = c;",
          "1417:         if (s->not_resumable_session_cb != NULL)",
          "1418:             s->session->not_resumable = s->not_resumable_session_cb(s,",
          "1419:                                                                     ((c->algorithm_mkey & (SSL_kDHE | SSL_kECDHE))",
          "1420:                                                                      != 0));",
          "1421:         if (s->session->not_resumable)",
          "1423:             s->tlsext_ticket_expected = 0;",
          "1424:     } else {",
          "1426:         s->s3->tmp.new_cipher = s->session->cipher;",
          "1427:     }",
          "1429:     if (!SSL_USE_SIGALGS(s) || !(s->verify_mode & SSL_VERIFY_PEER)) {",
          "1430:         if (!ssl3_digest_cached_records(s, 0))",
          "1431:             goto f_err;",
          "1432:     }",
          "1447:     if (s->version >= SSL3_VERSION) {",
          "1448:         if (ssl_check_clienthello_tlsext_late(s) <= 0) {",
          "1449:             SSLerr(SSL_F_SSL3_GET_CLIENT_HELLO, SSL_R_CLIENTHELLO_TLSEXT);",
          "1450:             goto err;",
          "1454:     if (ret < 0)",
          "1455:         ret = -ret;",
          "1456:     if (0) {",
          "1458:         ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "1459:  err:",
          "1460:         s->state = SSL_ST_ERR;",
          "1463:     sk_SSL_CIPHER_free(ciphers);",
          "1464:     return ret < 0 ? -1 : ret;",
          "1467: int ssl3_send_server_hello(SSL *s)",
          "",
          "[Added Lines]",
          "1406:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, ERR_R_INTERNAL_ERROR);",
          "1411:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_HELLO, SSL_R_CLIENTHELLO_TLSEXT);",
          "1414:     }",
          "1416:     sk_SSL_CIPHER_free(ciphers);",
          "1417:     return MSG_PROCESS_CONTINUE_PROCESSING;",
          "1418:  f_err:",
          "1419:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "1420:  err:",
          "1421:     statem_set_error(s);",
          "1423:     sk_SSL_CIPHER_free(ciphers);",
          "1424:     return MSG_PROCESS_ERROR;",
          "1426: }",
          "1428: enum WORK_STATE tls_post_process_client_hello(SSL *s, enum WORK_STATE wst)",
          "1429: {",
          "1430:     int al;",
          "1431:     SSL_CIPHER *cipher;",
          "1433:     if (wst == WORK_MORE_A) {",
          "1434:         if (!s->hit) {",
          "1436:             if (s->cert->cert_cb) {",
          "1437:                 int rv = s->cert->cert_cb(s, s->cert->cert_cb_arg);",
          "1438:                 if (rv == 0) {",
          "1439:                     al = SSL_AD_INTERNAL_ERROR;",
          "1440:                     SSLerr(SSL_F_TLS_POST_PROCESS_CLIENT_HELLO, SSL_R_CERT_CB_ERROR);",
          "1441:                     goto f_err;",
          "1442:                 }",
          "1443:                 if (rv < 0) {",
          "1444:                     s->rwstate = SSL_X509_LOOKUP;",
          "1445:                     return WORK_MORE_A;",
          "1446:                 }",
          "1447:                 s->rwstate = SSL_NOTHING;",
          "1449:             cipher = ssl3_choose_cipher(s, s->session->ciphers, SSL_get_ciphers(s));",
          "1451:             if (cipher == NULL) {",
          "1452:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1453:                 SSLerr(SSL_F_TLS_POST_PROCESS_CLIENT_HELLO, SSL_R_NO_SHARED_CIPHER);",
          "1454:                 goto f_err;",
          "1456:             s->s3->tmp.new_cipher = cipher;",
          "1458:             if (s->not_resumable_session_cb != NULL)",
          "1459:                 s->session->not_resumable = s->not_resumable_session_cb(s,",
          "1460:                     ((cipher->algorithm_mkey & (SSL_kDHE | SSL_kECDHE)) != 0));",
          "1461:             if (s->session->not_resumable)",
          "1463:                 s->tlsext_ticket_expected = 0;",
          "1464:         } else {",
          "1466:             s->s3->tmp.new_cipher = s->session->cipher;",
          "1469:         if (!SSL_USE_SIGALGS(s) || !(s->verify_mode & SSL_VERIFY_PEER)) {",
          "1470:             if (!ssl3_digest_cached_records(s, 0))",
          "1471:                 goto f_err;",
          "1487:         if (s->version >= SSL3_VERSION) {",
          "1488:             if (ssl_check_clienthello_tlsext_late(s) <= 0) {",
          "1489:                 SSLerr(SSL_F_TLS_POST_PROCESS_CLIENT_HELLO, SSL_R_CLIENTHELLO_TLSEXT);",
          "1490:                 goto f_err;",
          "1491:             }",
          "1492:         }",
          "1494:         wst = WORK_MORE_B;",
          "1495:     }",
          "1496: #ifndef OPENSSL_NO_SRP",
          "1497:     if (wst == WORK_MORE_B) {",
          "1498:         int ret;",
          "1499:         if ((ret = ssl_check_srp_ext_ClientHello(s, &al)) < 0) {",
          "1503:             s->rwstate = SSL_X509_LOOKUP;",
          "1504:             return WORK_MORE_B;",
          "1505:         }",
          "1506:         if (ret != SSL_ERROR_NONE) {",
          "1511:             if (al != TLS1_AD_UNKNOWN_PSK_IDENTITY)",
          "1512:                 SSLerr(SSL_F_TLS_POST_PROCESS_CLIENT_HELLO,",
          "1513:                            SSL_R_CLIENTHELLO_TLSEXT);",
          "1514:             goto f_err;",
          "1517: #endif",
          "1518:     s->renegotiate = 2;",
          "1520:     return WORK_FINISHED_STOP;",
          "1522:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "1523:     statem_set_error(s);",
          "1524:     return WORK_ERROR;",
          "1525: }",
          "1527: int ssl3_send_server_hello(SSL *s)",
          "1528: {",
          "1529:     if (s->state == SSL3_ST_SW_SRVR_HELLO_A) {",
          "1530:         if (tls_construct_server_hello(s) != 1)",
          "1531:             return -1;",
          "1532:         s->state = SSL3_ST_SW_SRVR_HELLO_B;",
          "1536:     return ssl_do_write(s);",
          "1539: int tls_construct_server_hello(SSL *s)",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1472:     int al = 0;",
          "1473:     unsigned long l;",
          "1527: #ifdef OPENSSL_NO_COMP",
          "1529: #else",
          "1534: #endif",
          "1557:     }",
          "1561: }",
          "1563: int ssl3_send_server_done(SSL *s)",
          "1564: {",
          "1566:     if (s->state == SSL3_ST_SW_SRVR_DONE_A) {",
          "1569:             return -1;",
          "1571:         s->state = SSL3_ST_SW_SRVR_DONE_B;",
          "1572:     }",
          "",
          "[Removed Lines]",
          "1475:     if (s->state == SSL3_ST_SW_SRVR_HELLO_A) {",
          "1476:         buf = (unsigned char *)s->init_buf->data;",
          "1479:         d = p = ssl_handshake_start(s);",
          "1488:         memcpy(p, s->s3->server_random, SSL3_RANDOM_SIZE);",
          "1489:         p += SSL3_RANDOM_SIZE;",
          "1507:         if (s->session->not_resumable ||",
          "1508:             (!(s->ctx->session_cache_mode & SSL_SESS_CACHE_SERVER)",
          "1509:              && !s->hit))",
          "1510:             s->session->session_id_length = 0;",
          "1512:         sl = s->session->session_id_length;",
          "1513:         if (sl > (int)sizeof(s->session->session_id)) {",
          "1514:             SSLerr(SSL_F_SSL3_SEND_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1515:             s->state = SSL_ST_ERR;",
          "1516:             return -1;",
          "1517:         }",
          "1519:         memcpy(p, s->session->session_id, sl);",
          "1520:         p += sl;",
          "1523:         i = ssl3_put_cipher_by_char(s->s3->tmp.new_cipher, p);",
          "1524:         p += i;",
          "1530:         if (s->s3->tmp.new_compression == NULL)",
          "1532:         else",
          "1536:         if (ssl_prepare_serverhello_tlsext(s) <= 0) {",
          "1537:             SSLerr(SSL_F_SSL3_SEND_SERVER_HELLO, SSL_R_SERVERHELLO_TLSEXT);",
          "1538:             s->state = SSL_ST_ERR;",
          "1539:             return -1;",
          "1540:         }",
          "1541:         if ((p =",
          "1542:              ssl_add_serverhello_tlsext(s, p, buf + SSL3_RT_MAX_PLAIN_LENGTH,",
          "1543:                                         &al)) == NULL) {",
          "1544:             ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "1545:             SSLerr(SSL_F_SSL3_SEND_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1546:             s->state = SSL_ST_ERR;",
          "1547:             return -1;",
          "1548:         }",
          "1551:         l = (p - d);",
          "1552:         if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_HELLO, l)) {",
          "1553:             SSLerr(SSL_F_SSL3_SEND_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1554:             return -1;",
          "1555:         }",
          "1556:         s->state = SSL3_ST_SW_SRVR_HELLO_B;",
          "1560:     return ssl_do_write(s);",
          "1567:         if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_DONE, 0)) {",
          "1568:             SSLerr(SSL_F_SSL3_SEND_SERVER_DONE, ERR_R_INTERNAL_ERROR);",
          "1570:         }",
          "",
          "[Added Lines]",
          "1547:     buf = (unsigned char *)s->init_buf->data;",
          "1550:     d = p = ssl_handshake_start(s);",
          "1559:     memcpy(p, s->s3->server_random, SSL3_RANDOM_SIZE);",
          "1560:     p += SSL3_RANDOM_SIZE;",
          "1578:     if (s->session->not_resumable ||",
          "1579:         (!(s->ctx->session_cache_mode & SSL_SESS_CACHE_SERVER)",
          "1580:          && !s->hit))",
          "1581:         s->session->session_id_length = 0;",
          "1583:     sl = s->session->session_id_length;",
          "1584:     if (sl > (int)sizeof(s->session->session_id)) {",
          "1585:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1586:         statem_set_error(s);",
          "1587:         return 0;",
          "1588:     }",
          "1590:     memcpy(p, s->session->session_id, sl);",
          "1591:     p += sl;",
          "1594:     i = ssl3_put_cipher_by_char(s->s3->tmp.new_cipher, p);",
          "1595:     p += i;",
          "1601:     if (s->s3->tmp.new_compression == NULL)",
          "1603:     else",
          "1607:     if (ssl_prepare_serverhello_tlsext(s) <= 0) {",
          "1608:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_HELLO, SSL_R_SERVERHELLO_TLSEXT);",
          "1609:         statem_set_error(s);",
          "1610:         return 0;",
          "1611:     }",
          "1612:     if ((p =",
          "1613:          ssl_add_serverhello_tlsext(s, p, buf + SSL3_RT_MAX_PLAIN_LENGTH,",
          "1614:                                     &al)) == NULL) {",
          "1615:         ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "1616:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1617:         statem_set_error(s);",
          "1618:         return 0;",
          "1619:     }",
          "1622:     l = (p - d);",
          "1623:     if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_HELLO, l)) {",
          "1624:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_HELLO, ERR_R_INTERNAL_ERROR);",
          "1625:         statem_set_error(s);",
          "1626:         return 0;",
          "1629:     return 1;",
          "1636:         if (tls_construct_server_done(s) == 0)",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "1575:     return ssl_do_write(s);",
          "1576: }",
          "1578: int ssl3_send_server_key_exchange(SSL *s)",
          "1579: {",
          "1580: #ifndef OPENSSL_NO_RSA",
          "1581:     unsigned char *q;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1645: int tls_construct_server_done(SSL *s)",
          "1646: {",
          "1647:     if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_DONE, 0)) {",
          "1648:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_DONE, ERR_R_INTERNAL_ERROR);",
          "1649:         statem_set_error(s);",
          "1650:         return 0;",
          "1651:     }",
          "1653:     if (!s->s3->tmp.cert_request) {",
          "1654:         if (!ssl3_digest_cached_records(s, 0)) {",
          "1655:             statem_set_error(s);",
          "1656:         }",
          "1657:     }",
          "1659:     return 1;",
          "1660: }",
          "1663: {",
          "1664:     if (s->state == SSL3_ST_SW_KEY_EXCH_A) {",
          "1665:         if (tls_construct_server_key_exchange(s) == 0)",
          "1666:             return -1;",
          "1667:     }",
          "1669:     s->state = SSL3_ST_SW_KEY_EXCH_B;",
          "1670:     return ssl_do_write(s);",
          "1671: }",
          "1673: int tls_construct_server_key_exchange(SSL *s)",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "1607:     EVP_MD_CTX md_ctx;",
          "1609:     EVP_MD_CTX_init(&md_ctx);",
          "1618: #ifndef OPENSSL_NO_PSK",
          "1631: #ifndef OPENSSL_NO_RSA",
          "1649:             if (rsa == NULL) {",
          "1650:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1653:                 goto f_err;",
          "1654:             }",
          "1659: #endif",
          "1660: #ifndef OPENSSL_NO_DH",
          "1678:             if (dhp == NULL) {",
          "1693:                        ERR_R_INTERNAL_ERROR);",
          "1695:             }",
          "1701:                 goto err;",
          "1702:             }",
          "1719:             }",
          "1724: #endif",
          "1725: #ifndef OPENSSL_NO_EC",
          "1758:                 goto err;",
          "1759:             }",
          "1854: #ifndef OPENSSL_NO_SRP",
          "1874:         }",
          "1877: #ifndef OPENSSL_NO_SRP",
          "1881: #endif",
          "1896:         }",
          "1904: #ifndef OPENSSL_NO_PSK",
          "1915:         }",
          "1916: #endif",
          "1919: #ifndef OPENSSL_NO_SRP",
          "1924: #endif",
          "1930: #ifndef OPENSSL_NO_EC",
          "1951: #endif",
          "1959: #ifndef OPENSSL_NO_RSA",
          "1985: #endif",
          "1997:                 }",
          "1998: #ifdef SSL_DEBUG",
          "2000: #endif",
          "2022:             }",
          "2026:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "2028:             goto f_err;",
          "2029:         }",
          "2030:     }",
          "2033:     EVP_MD_CTX_cleanup(&md_ctx);",
          "2035:  f_err:",
          "2036:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "2037:  err:",
          "",
          "[Removed Lines]",
          "1610:     if (s->state == SSL3_ST_SW_KEY_EXCH_A) {",
          "1611:         type = s->s3->tmp.new_cipher->algorithm_mkey;",
          "1612:         cert = s->cert;",
          "1614:         buf = s->init_buf;",
          "1616:         r[0] = r[1] = r[2] = r[3] = NULL;",
          "1617:         n = 0;",
          "1619:         if (type & SSL_PSK) {",
          "1623:             n += 2;",
          "1624:             if (s->cert->psk_identity_hint)",
          "1625:                 n += strlen(s->cert->psk_identity_hint);",
          "1626:         }",
          "1628:         if (type & (SSL_kPSK | SSL_kRSAPSK)) {",
          "1629:         } else",
          "1632:         if (type & SSL_kRSA) {",
          "1633:             rsa = cert->rsa_tmp;",
          "1634:             if ((rsa == NULL) && (s->cert->rsa_tmp_cb != NULL)) {",
          "1635:                 rsa = s->cert->rsa_tmp_cb(s,",
          "1636:                                           SSL_C_IS_EXPORT(s->s3->",
          "1637:                                                           tmp.new_cipher),",
          "1638:                                           SSL_C_EXPORT_PKEYLENGTH(s->s3->",
          "1639:                                                                   tmp.new_cipher));",
          "1640:                 if (rsa == NULL) {",
          "1641:                     al = SSL_AD_HANDSHAKE_FAILURE;",
          "1642:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1643:                            SSL_R_ERROR_GENERATING_TMP_RSA_KEY);",
          "1644:                     goto f_err;",
          "1645:                 }",
          "1646:                 RSA_up_ref(rsa);",
          "1647:                 cert->rsa_tmp = rsa;",
          "1648:             }",
          "1651:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1652:                        SSL_R_MISSING_TMP_RSA_KEY);",
          "1655:             r[0] = rsa->n;",
          "1656:             r[1] = rsa->e;",
          "1657:             s->s3->tmp.use_rsa_tmp = 1;",
          "1658:         } else",
          "1661:         if (type & (SSL_kDHE | SSL_kDHEPSK)) {",
          "1662:             if (s->cert->dh_tmp_auto) {",
          "1663:                 dhp = ssl_get_auto_dh(s);",
          "1664:                 if (dhp == NULL) {",
          "1665:                     al = SSL_AD_INTERNAL_ERROR;",
          "1666:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1667:                            ERR_R_INTERNAL_ERROR);",
          "1668:                     goto f_err;",
          "1669:                 }",
          "1670:             } else",
          "1671:                 dhp = cert->dh_tmp;",
          "1672:             if ((dhp == NULL) && (s->cert->dh_tmp_cb != NULL))",
          "1673:                 dhp = s->cert->dh_tmp_cb(s,",
          "1674:                                          SSL_C_IS_EXPORT(s->s3->",
          "1675:                                                          tmp.new_cipher),",
          "1676:                                          SSL_C_EXPORT_PKEYLENGTH(s->s3->",
          "1677:                                                                  tmp.new_cipher));",
          "1679:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1680:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1681:                        SSL_R_MISSING_TMP_DH_KEY);",
          "1682:                 goto f_err;",
          "1683:             }",
          "1684:             if (!ssl_security(s, SSL_SECOP_TMP_DH,",
          "1685:                               DH_security_bits(dhp), 0, dhp)) {",
          "1686:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1687:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1688:                        SSL_R_DH_KEY_TOO_SMALL);",
          "1689:                 goto f_err;",
          "1690:             }",
          "1691:             if (s->s3->tmp.dh != NULL) {",
          "1692:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1694:                 goto err;",
          "1697:             if (s->cert->dh_tmp_auto)",
          "1698:                 dh = dhp;",
          "1699:             else if ((dh = DHparams_dup(dhp)) == NULL) {",
          "1700:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1704:             s->s3->tmp.dh = dh;",
          "1705:             if ((dhp->pub_key == NULL ||",
          "1706:                  dhp->priv_key == NULL ||",
          "1707:                  (s->options & SSL_OP_SINGLE_DH_USE))) {",
          "1708:                 if (!DH_generate_key(dh)) {",
          "1709:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1710:                     goto err;",
          "1711:                 }",
          "1712:             } else {",
          "1713:                 dh->pub_key = BN_dup(dhp->pub_key);",
          "1714:                 dh->priv_key = BN_dup(dhp->priv_key);",
          "1715:                 if ((dh->pub_key == NULL) || (dh->priv_key == NULL)) {",
          "1716:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1717:                     goto err;",
          "1718:                 }",
          "1720:             r[0] = dh->p;",
          "1721:             r[1] = dh->g;",
          "1722:             r[2] = dh->pub_key;",
          "1723:         } else",
          "1726:         if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "1727:             const EC_GROUP *group;",
          "1729:             ecdhp = cert->ecdh_tmp;",
          "1730:             if (s->cert->ecdh_tmp_auto) {",
          "1732:                 int nid = tls1_shared_curve(s, -2);",
          "1733:                 if (nid != NID_undef)",
          "1734:                     ecdhp = EC_KEY_new_by_curve_name(nid);",
          "1735:             } else if ((ecdhp == NULL) && s->cert->ecdh_tmp_cb) {",
          "1736:                 ecdhp = s->cert->ecdh_tmp_cb(s,",
          "1737:                                              SSL_C_IS_EXPORT(s->s3->",
          "1738:                                                              tmp.new_cipher),",
          "1739:                                              SSL_C_EXPORT_PKEYLENGTH(s->",
          "1740:                                                                      s3->tmp.new_cipher));",
          "1741:             }",
          "1742:             if (ecdhp == NULL) {",
          "1743:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "1744:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1745:                        SSL_R_MISSING_TMP_ECDH_KEY);",
          "1746:                 goto f_err;",
          "1747:             }",
          "1749:             if (s->s3->tmp.ecdh != NULL) {",
          "1750:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1751:                        ERR_R_INTERNAL_ERROR);",
          "1752:                 goto err;",
          "1753:             }",
          "1756:             if (ecdhp == NULL) {",
          "1757:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1760:             if (s->cert->ecdh_tmp_auto)",
          "1761:                 ecdh = ecdhp;",
          "1762:             else if ((ecdh = EC_KEY_dup(ecdhp)) == NULL) {",
          "1763:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1764:                 goto err;",
          "1765:             }",
          "1767:             s->s3->tmp.ecdh = ecdh;",
          "1768:             if ((EC_KEY_get0_public_key(ecdh) == NULL) ||",
          "1769:                 (EC_KEY_get0_private_key(ecdh) == NULL) ||",
          "1770:                 (s->options & SSL_OP_SINGLE_ECDH_USE)) {",
          "1771:                 if (!EC_KEY_generate_key(ecdh)) {",
          "1772:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1773:                            ERR_R_ECDH_LIB);",
          "1774:                     goto err;",
          "1775:                 }",
          "1776:             }",
          "1778:             if (((group = EC_KEY_get0_group(ecdh)) == NULL) ||",
          "1779:                 (EC_KEY_get0_public_key(ecdh) == NULL) ||",
          "1780:                 (EC_KEY_get0_private_key(ecdh) == NULL)) {",
          "1781:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1782:                 goto err;",
          "1783:             }",
          "1785:             if (SSL_C_IS_EXPORT(s->s3->tmp.new_cipher) &&",
          "1786:                 (EC_GROUP_get_degree(group) > 163)) {",
          "1787:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1788:                        SSL_R_ECGROUP_TOO_LARGE_FOR_CIPHER);",
          "1789:                 goto err;",
          "1790:             }",
          "1797:             if ((curve_id =",
          "1798:                  tls1_ec_nid2curve_id(EC_GROUP_get_curve_name(group)))",
          "1799:                 == 0) {",
          "1800:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1801:                        SSL_R_UNSUPPORTED_ELLIPTIC_CURVE);",
          "1802:                 goto err;",
          "1803:             }",
          "1809:             encodedlen = EC_POINT_point2oct(group,",
          "1810:                                             EC_KEY_get0_public_key(ecdh),",
          "1811:                                             POINT_CONVERSION_UNCOMPRESSED,",
          "1812:                                             NULL, 0, NULL);",
          "1814:             encodedPoint = (unsigned char *)",
          "1815:                 OPENSSL_malloc(encodedlen * sizeof(unsigned char));",
          "1816:             bn_ctx = BN_CTX_new();",
          "1817:             if ((encodedPoint == NULL) || (bn_ctx == NULL)) {",
          "1818:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1819:                        ERR_R_MALLOC_FAILURE);",
          "1820:                 goto err;",
          "1821:             }",
          "1823:             encodedlen = EC_POINT_point2oct(group,",
          "1824:                                             EC_KEY_get0_public_key(ecdh),",
          "1825:                                             POINT_CONVERSION_UNCOMPRESSED,",
          "1826:                                             encodedPoint, encodedlen, bn_ctx);",
          "1828:             if (encodedlen == 0) {",
          "1829:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1830:                 goto err;",
          "1831:             }",
          "1833:             BN_CTX_free(bn_ctx);",
          "1834:             bn_ctx = NULL;",
          "1842:             n += 4 + encodedlen;",
          "1848:             r[0] = NULL;",
          "1849:             r[1] = NULL;",
          "1850:             r[2] = NULL;",
          "1851:             r[3] = NULL;",
          "1852:         } else",
          "1855:         if (type & SSL_kSRP) {",
          "1856:             if ((s->srp_ctx.N == NULL) ||",
          "1857:                 (s->srp_ctx.g == NULL) ||",
          "1858:                 (s->srp_ctx.s == NULL) || (s->srp_ctx.B == NULL)) {",
          "1859:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1860:                        SSL_R_MISSING_SRP_PARAM);",
          "1861:                 goto err;",
          "1862:             }",
          "1863:             r[0] = s->srp_ctx.N;",
          "1864:             r[1] = s->srp_ctx.g;",
          "1865:             r[2] = s->srp_ctx.s;",
          "1866:             r[3] = s->srp_ctx.B;",
          "1867:         } else",
          "1868: #endif",
          "1869:         {",
          "1870:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1871:             SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1872:                    SSL_R_UNKNOWN_KEY_EXCHANGE_TYPE);",
          "1873:             goto f_err;",
          "1875:         for (i = 0; i < 4 && r[i] != NULL; i++) {",
          "1876:             nr[i] = BN_num_bytes(r[i]);",
          "1878:             if ((i == 2) && (type & SSL_kSRP))",
          "1879:                 n += 1 + nr[i];",
          "1880:             else",
          "1882:                 n += 2 + nr[i];",
          "1883:         }",
          "1885:         if (!(s->s3->tmp.new_cipher->algorithm_auth & (SSL_aNULL|SSL_aSRP))",
          "1886:             && !(s->s3->tmp.new_cipher->algorithm_mkey & SSL_PSK)) {",
          "1887:             if ((pkey = ssl_get_sign_pkey(s, s->s3->tmp.new_cipher, &md))",
          "1888:                 == NULL) {",
          "1889:                 al = SSL_AD_DECODE_ERROR;",
          "1890:                 goto f_err;",
          "1891:             }",
          "1892:             kn = EVP_PKEY_size(pkey);",
          "1893:         } else {",
          "1894:             pkey = NULL;",
          "1895:             kn = 0;",
          "1898:         if (!BUF_MEM_grow_clean(buf, n + SSL_HM_HEADER_LENGTH(s) + kn)) {",
          "1899:             SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_LIB_BUF);",
          "1900:             goto err;",
          "1901:         }",
          "1902:         d = p = ssl_handshake_start(s);",
          "1905:         if (type & SSL_PSK) {",
          "1907:             if (s->cert->psk_identity_hint) {",
          "1908:                 s2n(strlen(s->cert->psk_identity_hint), p);",
          "1909:                 strncpy((char *)p, s->cert->psk_identity_hint,",
          "1910:                         strlen(s->cert->psk_identity_hint));",
          "1911:                 p += strlen(s->cert->psk_identity_hint);",
          "1912:             } else {",
          "1913:                 s2n(0, p);",
          "1914:             }",
          "1918:         for (i = 0; i < 4 && r[i] != NULL; i++) {",
          "1920:             if ((i == 2) && (type & SSL_kSRP)) {",
          "1922:                 p++;",
          "1923:             } else",
          "1925:                 s2n(nr[i], p);",
          "1926:             BN_bn2bin(r[i], p);",
          "1927:             p += nr[i];",
          "1928:         }",
          "1931:         if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "1939:             p += 1;",
          "1941:             p += 1;",
          "1943:             p += 1;",
          "1945:             p += 1;",
          "1946:             memcpy(p, encodedPoint, encodedlen);",
          "1947:             OPENSSL_free(encodedPoint);",
          "1948:             encodedPoint = NULL;",
          "1949:             p += encodedlen;",
          "1950:         }",
          "1954:         if (pkey != NULL) {",
          "1960:             if (pkey->type == EVP_PKEY_RSA && !SSL_USE_SIGALGS(s)) {",
          "1961:                 q = md_buf;",
          "1962:                 j = 0;",
          "1963:                 for (num = 2; num > 0; num--) {",
          "1964:                     EVP_MD_CTX_set_flags(&md_ctx,",
          "1965:                                          EVP_MD_CTX_FLAG_NON_FIPS_ALLOW);",
          "1966:                     EVP_DigestInit_ex(&md_ctx, (num == 2)",
          "1967:                                       ? s->ctx->md5 : s->ctx->sha1, NULL);",
          "1968:                     EVP_DigestUpdate(&md_ctx, &(s->s3->client_random[0]),",
          "1969:                                      SSL3_RANDOM_SIZE);",
          "1970:                     EVP_DigestUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "1971:                                      SSL3_RANDOM_SIZE);",
          "1972:                     EVP_DigestUpdate(&md_ctx, d, n);",
          "1973:                     EVP_DigestFinal_ex(&md_ctx, q, (unsigned int *)&i);",
          "1974:                     q += i;",
          "1975:                     j += i;",
          "1976:                 }",
          "1977:                 if (RSA_sign(NID_md5_sha1, md_buf, j,",
          "1978:                              &(p[2]), &u, pkey->pkey.rsa) <= 0) {",
          "1979:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_LIB_RSA);",
          "1980:                     goto err;",
          "1981:                 }",
          "1982:                 s2n(u, p);",
          "1983:                 n += u + 2;",
          "1984:             } else",
          "1986:             if (md) {",
          "1988:                 if (SSL_USE_SIGALGS(s)) {",
          "1989:                     if (!tls12_get_sigandhash(p, pkey, md)) {",
          "1991:                         al = SSL_AD_INTERNAL_ERROR;",
          "1992:                         SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "1993:                                ERR_R_INTERNAL_ERROR);",
          "1994:                         goto f_err;",
          "1995:                     }",
          "1996:                     p += 2;",
          "1999:                 fprintf(stderr, \"Using hash %s\\n\", EVP_MD_name(md));",
          "2001:                 EVP_SignInit_ex(&md_ctx, md, NULL);",
          "2002:                 EVP_SignUpdate(&md_ctx, &(s->s3->client_random[0]),",
          "2003:                                SSL3_RANDOM_SIZE);",
          "2004:                 EVP_SignUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "2005:                                SSL3_RANDOM_SIZE);",
          "2006:                 EVP_SignUpdate(&md_ctx, d, n);",
          "2007:                 if (!EVP_SignFinal(&md_ctx, &(p[2]),",
          "2008:                                    (unsigned int *)&i, pkey)) {",
          "2009:                     SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_LIB_EVP);",
          "2010:                     goto err;",
          "2011:                 }",
          "2012:                 s2n(i, p);",
          "2013:                 n += i + 2;",
          "2014:                 if (SSL_USE_SIGALGS(s))",
          "2015:                     n += 2;",
          "2016:             } else {",
          "2018:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2019:                 SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,",
          "2020:                        SSL_R_UNKNOWN_PKEY_TYPE);",
          "2021:                 goto f_err;",
          "2023:         }",
          "2025:         if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_KEY_EXCHANGE, n)) {",
          "2027:             SSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2032:     s->state = SSL3_ST_SW_KEY_EXCH_B;",
          "2034:     return ssl_do_write(s);",
          "",
          "[Added Lines]",
          "1706:     type = s->s3->tmp.new_cipher->algorithm_mkey;",
          "1707:     cert = s->cert;",
          "1709:     buf = s->init_buf;",
          "1711:     r[0] = r[1] = r[2] = r[3] = NULL;",
          "1712:     n = 0;",
          "1714:     if (type & SSL_PSK) {",
          "1718:         n += 2;",
          "1719:         if (s->cert->psk_identity_hint)",
          "1720:             n += strlen(s->cert->psk_identity_hint);",
          "1721:     }",
          "1723:     if (type & (SSL_kPSK | SSL_kRSAPSK)) {",
          "1724:     } else",
          "1727:     if (type & SSL_kRSA) {",
          "1728:         rsa = cert->rsa_tmp;",
          "1729:         if ((rsa == NULL) && (s->cert->rsa_tmp_cb != NULL)) {",
          "1730:             rsa = s->cert->rsa_tmp_cb(s,",
          "1731:                                       SSL_C_IS_EXPORT(s->s3->",
          "1732:                                                       tmp.new_cipher),",
          "1733:                                       SSL_C_EXPORT_PKEYLENGTH(s->s3->",
          "1734:                                                               tmp.new_cipher));",
          "1737:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1738:                        SSL_R_ERROR_GENERATING_TMP_RSA_KEY);",
          "1741:             RSA_up_ref(rsa);",
          "1742:             cert->rsa_tmp = rsa;",
          "1743:         }",
          "1744:         if (rsa == NULL) {",
          "1745:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1746:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1747:                    SSL_R_MISSING_TMP_RSA_KEY);",
          "1748:             goto f_err;",
          "1749:         }",
          "1750:         r[0] = rsa->n;",
          "1751:         r[1] = rsa->e;",
          "1752:         s->s3->tmp.use_rsa_tmp = 1;",
          "1753:     } else",
          "1756:     if (type & (SSL_kDHE | SSL_kDHEPSK)) {",
          "1757:         if (s->cert->dh_tmp_auto) {",
          "1758:             dhp = ssl_get_auto_dh(s);",
          "1760:                 al = SSL_AD_INTERNAL_ERROR;",
          "1761:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1763:                 goto f_err;",
          "1765:         } else",
          "1766:             dhp = cert->dh_tmp;",
          "1767:         if ((dhp == NULL) && (s->cert->dh_tmp_cb != NULL))",
          "1768:             dhp = s->cert->dh_tmp_cb(s,",
          "1769:                                      SSL_C_IS_EXPORT(s->s3->",
          "1770:                                                      tmp.new_cipher),",
          "1771:                                      SSL_C_EXPORT_PKEYLENGTH(s->s3->",
          "1772:                                                              tmp.new_cipher));",
          "1773:         if (dhp == NULL) {",
          "1774:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1775:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1776:                    SSL_R_MISSING_TMP_DH_KEY);",
          "1777:             goto f_err;",
          "1778:         }",
          "1779:         if (!ssl_security(s, SSL_SECOP_TMP_DH,",
          "1780:                           DH_security_bits(dhp), 0, dhp)) {",
          "1781:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1782:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1783:                    SSL_R_DH_KEY_TOO_SMALL);",
          "1784:             goto f_err;",
          "1785:         }",
          "1786:         if (s->s3->tmp.dh != NULL) {",
          "1787:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1788:                    ERR_R_INTERNAL_ERROR);",
          "1789:             goto err;",
          "1790:         }",
          "1792:         if (s->cert->dh_tmp_auto)",
          "1793:             dh = dhp;",
          "1794:         else if ((dh = DHparams_dup(dhp)) == NULL) {",
          "1795:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1796:             goto err;",
          "1797:         }",
          "1799:         s->s3->tmp.dh = dh;",
          "1800:         if ((dhp->pub_key == NULL ||",
          "1801:              dhp->priv_key == NULL ||",
          "1802:              (s->options & SSL_OP_SINGLE_DH_USE))) {",
          "1803:             if (!DH_generate_key(dh)) {",
          "1804:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1807:         } else {",
          "1808:             dh->pub_key = BN_dup(dhp->pub_key);",
          "1809:             dh->priv_key = BN_dup(dhp->priv_key);",
          "1810:             if ((dh->pub_key == NULL) || (dh->priv_key == NULL)) {",
          "1811:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "1812:                 goto err;",
          "1814:         }",
          "1815:         r[0] = dh->p;",
          "1816:         r[1] = dh->g;",
          "1817:         r[2] = dh->pub_key;",
          "1818:     } else",
          "1821:     if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "1822:         const EC_GROUP *group;",
          "1824:         ecdhp = cert->ecdh_tmp;",
          "1825:         if (s->cert->ecdh_tmp_auto) {",
          "1827:             int nid = tls1_shared_curve(s, -2);",
          "1828:             if (nid != NID_undef)",
          "1829:                 ecdhp = EC_KEY_new_by_curve_name(nid);",
          "1830:         } else if ((ecdhp == NULL) && s->cert->ecdh_tmp_cb) {",
          "1831:             ecdhp = s->cert->ecdh_tmp_cb(s,",
          "1832:                                          SSL_C_IS_EXPORT(s->s3->",
          "1833:                                                          tmp.new_cipher),",
          "1834:                                          SSL_C_EXPORT_PKEYLENGTH(s->",
          "1835:                                                                  s3->tmp.new_cipher));",
          "1836:         }",
          "1837:         if (ecdhp == NULL) {",
          "1838:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "1839:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1840:                    SSL_R_MISSING_TMP_ECDH_KEY);",
          "1841:             goto f_err;",
          "1842:         }",
          "1844:         if (s->s3->tmp.ecdh != NULL) {",
          "1845:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1846:                    ERR_R_INTERNAL_ERROR);",
          "1847:             goto err;",
          "1848:         }",
          "1851:         if (ecdhp == NULL) {",
          "1852:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1853:             goto err;",
          "1854:         }",
          "1855:         if (s->cert->ecdh_tmp_auto)",
          "1856:             ecdh = ecdhp;",
          "1857:         else if ((ecdh = EC_KEY_dup(ecdhp)) == NULL) {",
          "1858:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1859:             goto err;",
          "1860:         }",
          "1862:         s->s3->tmp.ecdh = ecdh;",
          "1863:         if ((EC_KEY_get0_public_key(ecdh) == NULL) ||",
          "1864:             (EC_KEY_get0_private_key(ecdh) == NULL) ||",
          "1865:             (s->options & SSL_OP_SINGLE_ECDH_USE)) {",
          "1866:             if (!EC_KEY_generate_key(ecdh)) {",
          "1867:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1868:                        ERR_R_ECDH_LIB);",
          "1871:         }",
          "1873:         if (((group = EC_KEY_get0_group(ecdh)) == NULL) ||",
          "1874:             (EC_KEY_get0_public_key(ecdh) == NULL) ||",
          "1875:             (EC_KEY_get0_private_key(ecdh) == NULL)) {",
          "1876:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1877:             goto err;",
          "1878:         }",
          "1880:         if (SSL_C_IS_EXPORT(s->s3->tmp.new_cipher) &&",
          "1881:             (EC_GROUP_get_degree(group) > 163)) {",
          "1882:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1883:                    SSL_R_ECGROUP_TOO_LARGE_FOR_CIPHER);",
          "1884:             goto err;",
          "1885:         }",
          "1892:         if ((curve_id =",
          "1893:              tls1_ec_nid2curve_id(EC_GROUP_get_curve_name(group)))",
          "1894:             == 0) {",
          "1895:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1896:                    SSL_R_UNSUPPORTED_ELLIPTIC_CURVE);",
          "1897:             goto err;",
          "1898:         }",
          "1904:         encodedlen = EC_POINT_point2oct(group,",
          "1905:                                         EC_KEY_get0_public_key(ecdh),",
          "1906:                                         POINT_CONVERSION_UNCOMPRESSED,",
          "1907:                                         NULL, 0, NULL);",
          "1909:         encodedPoint = (unsigned char *)",
          "1910:             OPENSSL_malloc(encodedlen * sizeof(unsigned char));",
          "1911:         bn_ctx = BN_CTX_new();",
          "1912:         if ((encodedPoint == NULL) || (bn_ctx == NULL)) {",
          "1913:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1914:                    ERR_R_MALLOC_FAILURE);",
          "1915:             goto err;",
          "1916:         }",
          "1918:         encodedlen = EC_POINT_point2oct(group,",
          "1919:                                         EC_KEY_get0_public_key(ecdh),",
          "1920:                                         POINT_CONVERSION_UNCOMPRESSED,",
          "1921:                                         encodedPoint, encodedlen, bn_ctx);",
          "1923:         if (encodedlen == 0) {",
          "1924:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "1925:             goto err;",
          "1926:         }",
          "1928:         BN_CTX_free(bn_ctx);",
          "1929:         bn_ctx = NULL;",
          "1937:         n += 4 + encodedlen;",
          "1943:         r[0] = NULL;",
          "1944:         r[1] = NULL;",
          "1945:         r[2] = NULL;",
          "1946:         r[3] = NULL;",
          "1947:     } else",
          "1950:     if (type & SSL_kSRP) {",
          "1951:         if ((s->srp_ctx.N == NULL) ||",
          "1952:             (s->srp_ctx.g == NULL) ||",
          "1953:             (s->srp_ctx.s == NULL) || (s->srp_ctx.B == NULL)) {",
          "1954:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1955:                    SSL_R_MISSING_SRP_PARAM);",
          "1956:             goto err;",
          "1958:         r[0] = s->srp_ctx.N;",
          "1959:         r[1] = s->srp_ctx.g;",
          "1960:         r[2] = s->srp_ctx.s;",
          "1961:         r[3] = s->srp_ctx.B;",
          "1962:     } else",
          "1963: #endif",
          "1964:     {",
          "1965:         al = SSL_AD_HANDSHAKE_FAILURE;",
          "1966:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "1967:                SSL_R_UNKNOWN_KEY_EXCHANGE_TYPE);",
          "1968:         goto f_err;",
          "1969:     }",
          "1970:     for (i = 0; i < 4 && r[i] != NULL; i++) {",
          "1971:         nr[i] = BN_num_bytes(r[i]);",
          "1973:         if ((i == 2) && (type & SSL_kSRP))",
          "1974:             n += 1 + nr[i];",
          "1975:         else",
          "1977:             n += 2 + nr[i];",
          "1978:     }",
          "1980:     if (!(s->s3->tmp.new_cipher->algorithm_auth & (SSL_aNULL|SSL_aSRP))",
          "1981:         && !(s->s3->tmp.new_cipher->algorithm_mkey & SSL_PSK)) {",
          "1982:         if ((pkey = ssl_get_sign_pkey(s, s->s3->tmp.new_cipher, &md))",
          "1983:             == NULL) {",
          "1984:             al = SSL_AD_DECODE_ERROR;",
          "1985:             goto f_err;",
          "1987:         kn = EVP_PKEY_size(pkey);",
          "1988:     } else {",
          "1989:         pkey = NULL;",
          "1990:         kn = 0;",
          "1991:     }",
          "1993:     if (!BUF_MEM_grow_clean(buf, n + SSL_HM_HEADER_LENGTH(s) + kn)) {",
          "1994:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_LIB_BUF);",
          "1995:         goto err;",
          "1996:     }",
          "1997:     d = p = ssl_handshake_start(s);",
          "2000:     if (type & SSL_PSK) {",
          "2002:         if (s->cert->psk_identity_hint) {",
          "2003:             s2n(strlen(s->cert->psk_identity_hint), p);",
          "2004:             strncpy((char *)p, s->cert->psk_identity_hint,",
          "2005:                     strlen(s->cert->psk_identity_hint));",
          "2006:             p += strlen(s->cert->psk_identity_hint);",
          "2007:         } else {",
          "2008:             s2n(0, p);",
          "2010:     }",
          "2013:     for (i = 0; i < 4 && r[i] != NULL; i++) {",
          "2015:         if ((i == 2) && (type & SSL_kSRP)) {",
          "2017:             p++;",
          "2018:         } else",
          "2020:             s2n(nr[i], p);",
          "2021:         BN_bn2bin(r[i], p);",
          "2022:         p += nr[i];",
          "2023:     }",
          "2026:     if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "2034:         p += 1;",
          "2036:         p += 1;",
          "2038:         p += 1;",
          "2040:         p += 1;",
          "2041:         memcpy(p, encodedPoint, encodedlen);",
          "2042:         OPENSSL_free(encodedPoint);",
          "2043:         encodedPoint = NULL;",
          "2044:         p += encodedlen;",
          "2045:     }",
          "2049:     if (pkey != NULL) {",
          "2055:         if (pkey->type == EVP_PKEY_RSA && !SSL_USE_SIGALGS(s)) {",
          "2056:             q = md_buf;",
          "2057:             j = 0;",
          "2058:             for (num = 2; num > 0; num--) {",
          "2059:                 EVP_MD_CTX_set_flags(&md_ctx,",
          "2060:                                      EVP_MD_CTX_FLAG_NON_FIPS_ALLOW);",
          "2061:                 EVP_DigestInit_ex(&md_ctx, (num == 2)",
          "2062:                                   ? s->ctx->md5 : s->ctx->sha1, NULL);",
          "2063:                 EVP_DigestUpdate(&md_ctx, &(s->s3->client_random[0]),",
          "2064:                                  SSL3_RANDOM_SIZE);",
          "2065:                 EVP_DigestUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "2066:                                  SSL3_RANDOM_SIZE);",
          "2067:                 EVP_DigestUpdate(&md_ctx, d, n);",
          "2068:                 EVP_DigestFinal_ex(&md_ctx, q, (unsigned int *)&i);",
          "2069:                 q += i;",
          "2070:                 j += i;",
          "2071:             }",
          "2072:             if (RSA_sign(NID_md5_sha1, md_buf, j,",
          "2073:                          &(p[2]), &u, pkey->pkey.rsa) <= 0) {",
          "2074:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_LIB_RSA);",
          "2075:                 goto err;",
          "2076:             }",
          "2077:             s2n(u, p);",
          "2078:             n += u + 2;",
          "2079:         } else",
          "2081:         if (md) {",
          "2083:             if (SSL_USE_SIGALGS(s)) {",
          "2084:                 if (!tls12_get_sigandhash(p, pkey, md)) {",
          "2086:                     al = SSL_AD_INTERNAL_ERROR;",
          "2087:                     SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "2088:                            ERR_R_INTERNAL_ERROR);",
          "2089:                     goto f_err;",
          "2091:                 p += 2;",
          "2092:             }",
          "2094:             fprintf(stderr, \"Using hash %s\\n\", EVP_MD_name(md));",
          "2096:             EVP_SignInit_ex(&md_ctx, md, NULL);",
          "2097:             EVP_SignUpdate(&md_ctx, &(s->s3->client_random[0]),",
          "2098:                            SSL3_RANDOM_SIZE);",
          "2099:             EVP_SignUpdate(&md_ctx, &(s->s3->server_random[0]),",
          "2100:                            SSL3_RANDOM_SIZE);",
          "2101:             EVP_SignUpdate(&md_ctx, d, n);",
          "2102:             if (!EVP_SignFinal(&md_ctx, &(p[2]),",
          "2103:                                (unsigned int *)&i, pkey)) {",
          "2104:                 SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_LIB_EVP);",
          "2105:                 goto err;",
          "2107:             s2n(i, p);",
          "2108:             n += i + 2;",
          "2109:             if (SSL_USE_SIGALGS(s))",
          "2110:                 n += 2;",
          "2111:         } else {",
          "2114:             SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE,",
          "2115:                    SSL_R_UNKNOWN_PKEY_TYPE);",
          "2120:     if (!ssl_set_handshake_header(s, SSL3_MT_SERVER_KEY_EXCHANGE, n)) {",
          "2121:         al = SSL_AD_HANDSHAKE_FAILURE;",
          "2122:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2123:         goto f_err;",
          "2124:     }",
          "2127:     return 1;",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "2040:     BN_CTX_free(bn_ctx);",
          "2041: #endif",
          "2042:     EVP_MD_CTX_cleanup(&md_ctx);",
          "2045: }",
          "2047: int ssl3_send_certificate_request(SSL *s)",
          "2048: {",
          "2049:     unsigned char *p, *d;",
          "2050:     int i, j, nl, off, n;",
          "",
          "[Removed Lines]",
          "2043:     s->state = SSL_ST_ERR;",
          "2044:     return (-1);",
          "",
          "[Added Lines]",
          "2136:     statem_set_error(s);",
          "2137:     return 0;",
          "2141: {",
          "2142:     if (s->state == SSL3_ST_SW_CERT_REQ_A) {",
          "2143:         if (tls_construct_certificate_request(s) == 0)",
          "2144:             return -1;",
          "2145:         s->state = SSL3_ST_SW_CERT_REQ_B;",
          "2146:     }",
          "2149:     return ssl_do_write(s);",
          "2150: }",
          "2152: int tls_construct_certificate_request(SSL *s)",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "2052:     X509_NAME *name;",
          "2053:     BUF_MEM *buf;",
          "2081:         p += 2;",
          "2101:             }",
          "2102:         }",
          "2113:     }",
          "2117:  err:",
          "2120: }",
          "2122: int ssl3_get_client_key_exchange(SSL *s)",
          "2123: {",
          "2126:     long n;",
          "2127:     unsigned long alg_k;",
          "2128: #ifndef OPENSSL_NO_RSA",
          "2129:     RSA *rsa = NULL;",
          "",
          "[Removed Lines]",
          "2055:     if (s->state == SSL3_ST_SW_CERT_REQ_A) {",
          "2056:         buf = s->init_buf;",
          "2058:         d = p = ssl_handshake_start(s);",
          "2061:         p++;",
          "2062:         n = ssl3_get_req_cert_type(s, p);",
          "2063:         d[0] = n;",
          "2064:         p += n;",
          "2065:         n++;",
          "2067:         if (SSL_USE_SIGALGS(s)) {",
          "2068:             const unsigned char *psigs;",
          "2069:             unsigned char *etmp = p;",
          "2070:             nl = tls12_get_psigalgs(s, &psigs);",
          "2072:             p += 2;",
          "2073:             nl = tls12_copy_sigalgs(s, p, psigs, nl);",
          "2075:             s2n(nl, etmp);",
          "2076:             p += nl;",
          "2077:             n += nl + 2;",
          "2078:         }",
          "2080:         off = n;",
          "2082:         n += 2;",
          "2084:         sk = SSL_get_client_CA_list(s);",
          "2085:         nl = 0;",
          "2086:         if (sk != NULL) {",
          "2087:             for (i = 0; i < sk_X509_NAME_num(sk); i++) {",
          "2088:                 name = sk_X509_NAME_value(sk, i);",
          "2089:                 j = i2d_X509_NAME(name, NULL);",
          "2090:                 if (!BUF_MEM_grow_clean",
          "2091:                     (buf, SSL_HM_HEADER_LENGTH(s) + n + j + 2)) {",
          "2092:                     SSLerr(SSL_F_SSL3_SEND_CERTIFICATE_REQUEST,",
          "2093:                            ERR_R_BUF_LIB);",
          "2094:                     goto err;",
          "2095:                 }",
          "2096:                 p = ssl_handshake_start(s) + n;",
          "2097:                 s2n(j, p);",
          "2098:                 i2d_X509_NAME(name, &p);",
          "2099:                 n += 2 + j;",
          "2100:                 nl += 2 + j;",
          "2104:         p = ssl_handshake_start(s) + off;",
          "2105:         s2n(nl, p);",
          "2107:         if (!ssl_set_handshake_header(s, SSL3_MT_CERTIFICATE_REQUEST, n)) {",
          "2108:             SSLerr(SSL_F_SSL3_SEND_CERTIFICATE_REQUEST, ERR_R_INTERNAL_ERROR);",
          "2109:             return -1;",
          "2110:         }",
          "2112:         s->state = SSL3_ST_SW_CERT_REQ_B;",
          "2116:     return ssl_do_write(s);",
          "2118:     s->state = SSL_ST_ERR;",
          "2119:     return (-1);",
          "2124:     unsigned int i;",
          "2125:     int al, ok;",
          "",
          "[Added Lines]",
          "2160:     buf = s->init_buf;",
          "2162:     d = p = ssl_handshake_start(s);",
          "2165:     p++;",
          "2166:     n = ssl3_get_req_cert_type(s, p);",
          "2167:     d[0] = n;",
          "2168:     p += n;",
          "2169:     n++;",
          "2171:     if (SSL_USE_SIGALGS(s)) {",
          "2172:         const unsigned char *psigs;",
          "2173:         unsigned char *etmp = p;",
          "2174:         nl = tls12_get_psigalgs(s, &psigs);",
          "2177:         nl = tls12_copy_sigalgs(s, p, psigs, nl);",
          "2179:         s2n(nl, etmp);",
          "2180:         p += nl;",
          "2181:         n += nl + 2;",
          "2182:     }",
          "2184:     off = n;",
          "2185:     p += 2;",
          "2186:     n += 2;",
          "2188:     sk = SSL_get_client_CA_list(s);",
          "2189:     nl = 0;",
          "2190:     if (sk != NULL) {",
          "2191:         for (i = 0; i < sk_X509_NAME_num(sk); i++) {",
          "2192:             name = sk_X509_NAME_value(sk, i);",
          "2193:             j = i2d_X509_NAME(name, NULL);",
          "2194:             if (!BUF_MEM_grow_clean",
          "2195:                 (buf, SSL_HM_HEADER_LENGTH(s) + n + j + 2)) {",
          "2196:                 SSLerr(SSL_F_TLS_CONSTRUCT_CERTIFICATE_REQUEST,",
          "2197:                        ERR_R_BUF_LIB);",
          "2198:                 goto err;",
          "2200:             p = ssl_handshake_start(s) + n;",
          "2201:             s2n(j, p);",
          "2202:             i2d_X509_NAME(name, &p);",
          "2203:             n += 2 + j;",
          "2204:             nl += 2 + j;",
          "2206:     }",
          "2208:     p = ssl_handshake_start(s) + off;",
          "2209:     s2n(nl, p);",
          "2211:     if (!ssl_set_handshake_header(s, SSL3_MT_CERTIFICATE_REQUEST, n)) {",
          "2212:         SSLerr(SSL_F_TLS_CONSTRUCT_CERTIFICATE_REQUEST, ERR_R_INTERNAL_ERROR);",
          "2213:         goto err;",
          "2216:     s->s3->tmp.cert_request = 1;",
          "2218:     return 1;",
          "2220:     statem_set_error(s);",
          "2221:     return 0;",
          "2226:     int ok;",
          "2229:     n = s->method->ssl_get_message(s,",
          "2230:                                    SSL3_ST_SR_KEY_EXCH_A,",
          "2231:                                    SSL3_ST_SR_KEY_EXCH_B,",
          "2232:                                    SSL3_MT_CLIENT_KEY_EXCHANGE, 2048, &ok);",
          "2234:     if (!ok)",
          "2235:         return ((int)n);",
          "2237:     if (tls_process_client_key_exchange(s, n) == 0)",
          "2238:         return -1;",
          "2240:     return n;",
          "2241: }",
          "2243: enum MSG_PROCESS_RETURN tls_process_client_key_exchange(SSL *s, long n)",
          "2244: {",
          "2245:     int al;",
          "2246:     unsigned int i;",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "2142:     PACKET pkt, enc_premaster;",
          "2143:     unsigned char *data, *rsa_decrypt = NULL;",
          "2152:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2153:         al = SSL_AD_INTERNAL_ERROR;",
          "2155:         goto f_err;",
          "2156:     }",
          "",
          "[Removed Lines]",
          "2145:     n = s->method->ssl_get_message(s,",
          "2146:                                    SSL3_ST_SR_KEY_EXCH_A,",
          "2147:                                    SSL3_ST_SR_KEY_EXCH_B,",
          "2148:                                    SSL3_MT_CLIENT_KEY_EXCHANGE, 2048, &ok);",
          "2150:     if (!ok)",
          "2151:         return ((int)n);",
          "2154:         SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "2267:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "2167:         if (!PACKET_get_length_prefixed_2(&pkt, &psk_identity)) {",
          "2168:             al = SSL_AD_DECODE_ERROR;",
          "2170:             goto f_err;",
          "2171:         }",
          "2172:         if (PACKET_remaining(&psk_identity) > PSK_MAX_IDENTITY_LEN) {",
          "2173:             al = SSL_AD_DECODE_ERROR;",
          "2175:                    SSL_R_DATA_LENGTH_TOO_LONG);",
          "2176:             goto f_err;",
          "2177:         }",
          "2178:         if (s->psk_server_callback == NULL) {",
          "2179:             al = SSL_AD_INTERNAL_ERROR;",
          "2181:                    SSL_R_PSK_NO_SERVER_CB);",
          "2182:             goto f_err;",
          "2183:         }",
          "",
          "[Removed Lines]",
          "2169:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2174:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2180:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2282:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2287:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2293:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "2194:         if (psklen > PSK_MAX_PSK_LEN) {",
          "2195:             al = SSL_AD_INTERNAL_ERROR;",
          "2197:             goto f_err;",
          "2198:         } else if (psklen == 0) {",
          "2203:                    SSL_R_PSK_IDENTITY_NOT_FOUND);",
          "2204:             al = SSL_AD_UNKNOWN_PSK_IDENTITY;",
          "2205:             goto f_err;",
          "",
          "[Removed Lines]",
          "2196:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2202:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2309:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2315:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "2212:         if (s->s3->tmp.psk == NULL) {",
          "2213:             al = SSL_AD_INTERNAL_ERROR;",
          "2215:             goto f_err;",
          "2216:         }",
          "",
          "[Removed Lines]",
          "2214:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "[Added Lines]",
          "2327:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "2222:         if (PACKET_remaining(&pkt) != 0) {",
          "2223:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "2225:             goto f_err;",
          "2226:         }",
          "2228:         if (!ssl_generate_master_secret(s, NULL, 0, 0)) {",
          "2229:             al = SSL_AD_INTERNAL_ERROR;",
          "2231:             goto f_err;",
          "2232:         }",
          "2233:     } else",
          "",
          "[Removed Lines]",
          "2224:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2230:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "2337:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2343:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "2249:             if (rsa == NULL) {",
          "2250:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2252:                        SSL_R_MISSING_TMP_RSA_PKEY);",
          "2253:                 goto f_err;",
          "",
          "[Removed Lines]",
          "2251:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2364:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "2258:             if ((pkey == NULL) ||",
          "2259:                 (pkey->type != EVP_PKEY_RSA) || (pkey->pkey.rsa == NULL)) {",
          "2260:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2262:                        SSL_R_MISSING_RSA_CERTIFICATE);",
          "2263:                 goto f_err;",
          "2264:             }",
          "",
          "[Removed Lines]",
          "2261:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2374:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "2383:         if (!ssl_generate_master_secret(s, rsa_decrypt,",
          "2384:                                         sizeof(rand_premaster_secret), 0)) {",
          "2385:             al = SSL_AD_INTERNAL_ERROR;",
          "2387:             goto f_err;",
          "2388:         }",
          "2389:         OPENSSL_free(rsa_decrypt);",
          "",
          "[Removed Lines]",
          "2386:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "2499:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "2400:         if (!PACKET_get_net_2(&pkt, &i)) {",
          "2401:             if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "2402:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2404:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "2405:                 goto f_err;",
          "2406:             }",
          "",
          "[Removed Lines]",
          "2403:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2516:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 31 ---",
          "[Context before]",
          "2408:         }",
          "2409:         if (PACKET_remaining(&pkt) != i) {",
          "2410:             if (!(s->options & SSL_OP_SSLEAY_080_CLIENT_DH_BUG)) {",
          "2412:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "2413:                 goto err;",
          "2414:             } else {",
          "",
          "[Removed Lines]",
          "2411:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2524:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 32 ---",
          "[Context before]",
          "2425:             if ((skey == NULL) ||",
          "2426:                 (skey->type != EVP_PKEY_DH) || (skey->pkey.dh == NULL)) {",
          "2427:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2429:                        SSL_R_MISSING_RSA_CERTIFICATE);",
          "2430:                 goto f_err;",
          "2431:             }",
          "2432:             dh_srvr = skey->pkey.dh;",
          "2433:         } else if (s->s3->tmp.dh == NULL) {",
          "2434:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "2436:                    SSL_R_MISSING_TMP_DH_KEY);",
          "2437:             goto f_err;",
          "2438:         } else",
          "",
          "[Removed Lines]",
          "2428:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2435:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2541:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2548:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 33 ---",
          "[Context before]",
          "2447:             }",
          "2448:             if (dh_clnt == NULL) {",
          "2449:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2451:                        SSL_R_MISSING_TMP_DH_KEY);",
          "2452:                 goto f_err;",
          "2453:             }",
          "",
          "[Removed Lines]",
          "2450:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2563:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 34 ---",
          "[Context before]",
          "2457:             if (!PACKET_get_bytes(&pkt, &data, i)) {",
          "2459:                 al = SSL_AD_INTERNAL_ERROR;",
          "2461:                        ERR_R_INTERNAL_ERROR);",
          "2462:                 goto f_err;",
          "2463:             }",
          "2464:             pub = BN_bin2bn(data, i, NULL);",
          "2465:         }",
          "2466:         if (pub == NULL) {",
          "2468:             goto err;",
          "2469:         }",
          "2471:         i = DH_compute_key(shared, pub, dh_srvr);",
          "2473:         if (i <= 0) {",
          "2475:             BN_clear_free(pub);",
          "2476:             goto err;",
          "2477:         }",
          "",
          "[Removed Lines]",
          "2460:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2467:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_BN_LIB);",
          "2474:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "",
          "[Added Lines]",
          "2573:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2580:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_BN_LIB);",
          "2587:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_DH_LIB);",
          "",
          "---------------",
          "--- Hunk 35 ---",
          "[Context before]",
          "2485:         pub = NULL;",
          "2486:         if (!ssl_generate_master_secret(s, shared, i, 0)) {",
          "2487:             al = SSL_AD_INTERNAL_ERROR;",
          "2489:             goto f_err;",
          "2490:         }",
          "2493:     } else",
          "2494: #endif",
          "2496: #ifndef OPENSSL_NO_EC",
          "2497:     if (alg_k & (SSL_kECDHE | SSL_kECDHr | SSL_kECDHe | SSL_kECDHEPSK)) {",
          "2499:         int field_size = 0;",
          "2500:         const EC_KEY *tkey;",
          "2501:         const EC_GROUP *group;",
          "",
          "[Removed Lines]",
          "2488:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2491:         if (dh_clnt)",
          "2492:             return 2;",
          "2498:         int ret = 1;",
          "",
          "[Added Lines]",
          "2601:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2604:         if (dh_clnt) {",
          "2605:             s->no_cert_verify = 1;",
          "2606:             return MSG_PROCESS_CONTINUE_PROCESSING;",
          "2607:         }",
          "",
          "---------------",
          "--- Hunk 36 ---",
          "[Context before]",
          "2506:         if ((srvr_ecdh = EC_KEY_new()) == NULL) {",
          "2508:             goto err;",
          "2509:         }",
          "",
          "[Removed Lines]",
          "2507:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "[Added Lines]",
          "2621:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "---------------",
          "--- Hunk 37 ---",
          "[Context before]",
          "2526:         if (!EC_KEY_set_group(srvr_ecdh, group) ||",
          "2527:             !EC_KEY_set_private_key(srvr_ecdh, priv_key)) {",
          "2529:             goto err;",
          "2530:         }",
          "2533:         if ((clnt_ecpoint = EC_POINT_new(group)) == NULL) {",
          "2535:             goto err;",
          "2536:         }",
          "",
          "[Removed Lines]",
          "2528:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2534:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "[Added Lines]",
          "2642:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2648:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "",
          "---------------",
          "--- Hunk 38 ---",
          "[Context before]",
          "2541:             if (alg_k & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "2542:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2544:                        SSL_R_MISSING_TMP_ECDH_KEY);",
          "2545:                 goto f_err;",
          "2546:             }",
          "",
          "[Removed Lines]",
          "2543:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2657:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 39 ---",
          "[Context before]",
          "2557:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2559:                        SSL_R_UNABLE_TO_DECODE_ECDH_CERTS);",
          "2560:                 goto f_err;",
          "2561:             }",
          "",
          "[Removed Lines]",
          "2558:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2672:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 40 ---",
          "[Context before]",
          "2563:             if (EC_POINT_copy(clnt_ecpoint,",
          "2564:                               EC_KEY_get0_public_key(clnt_pub_pkey->",
          "2565:                                                      pkey.ec)) == 0) {",
          "2567:                 goto err;",
          "2568:             }",
          "2570:         } else {",
          "2575:             if ((bn_ctx = BN_CTX_new()) == NULL) {",
          "2577:                        ERR_R_MALLOC_FAILURE);",
          "2578:                 goto err;",
          "2579:             }",
          "",
          "[Removed Lines]",
          "2566:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2576:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2680:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2683:             s->no_cert_verify = 1;",
          "2690:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 41 ---",
          "[Context before]",
          "2582:             if (!PACKET_get_1(&pkt, &i)) {",
          "2583:                 al = SSL_AD_DECODE_ERROR;",
          "2585:                        SSL_R_LENGTH_MISMATCH);",
          "2586:                 goto f_err;",
          "2587:             }",
          "2588:             if (!PACKET_get_bytes(&pkt, &data, i)",
          "2589:                     || PACKET_remaining(&pkt) != 0) {",
          "2591:                 goto err;",
          "2592:             }",
          "2593:             if (EC_POINT_oct2point(group, clnt_ecpoint, data, i, bn_ctx) == 0) {",
          "2595:                 goto err;",
          "2596:             }",
          "2597:         }",
          "",
          "[Removed Lines]",
          "2584:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2590:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2594:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "",
          "[Added Lines]",
          "2698:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2704:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "2708:                 SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_EC_LIB);",
          "",
          "---------------",
          "--- Hunk 42 ---",
          "[Context before]",
          "2600:         field_size = EC_GROUP_get_degree(group);",
          "2601:         if (field_size <= 0) {",
          "2603:             goto err;",
          "2604:         }",
          "2605:         shared = OPENSSL_malloc((field_size + 7) / 8);",
          "2606:         if (shared == NULL) {",
          "2608:             goto err;",
          "2609:         }",
          "2610:         i = ECDH_compute_key(shared, (field_size + 7) / 8, clnt_ecpoint,",
          "2611:                              srvr_ecdh, NULL);",
          "2612:         if (i <= 0) {",
          "2614:             OPENSSL_free(shared);",
          "2615:             goto err;",
          "2616:         }",
          "",
          "[Removed Lines]",
          "2602:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "2607:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2613:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "",
          "[Added Lines]",
          "2716:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "2721:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2727:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_ECDH_LIB);",
          "",
          "---------------",
          "--- Hunk 43 ---",
          "[Context before]",
          "2625:         if (!ssl_generate_master_secret(s, shared, i, 1)) {",
          "2626:             al = SSL_AD_INTERNAL_ERROR;",
          "2628:             goto f_err;",
          "2629:         }",
          "2631:     } else",
          "2632: #endif",
          "2633: #ifndef OPENSSL_NO_SRP",
          "",
          "[Removed Lines]",
          "2627:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2630:         return (ret);",
          "",
          "[Added Lines]",
          "2741:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2744:         return MSG_PROCESS_CONTINUE_PROCESSING;",
          "",
          "---------------",
          "--- Hunk 44 ---",
          "[Context before]",
          "2635:         if (!PACKET_get_net_2(&pkt, &i)",
          "2636:                 || !PACKET_get_bytes(&pkt, &data, i)) {",
          "2637:             al = SSL_AD_DECODE_ERROR;",
          "2639:             goto f_err;",
          "2640:         }",
          "2641:         if ((s->srp_ctx.A = BN_bin2bn(data, i, NULL)) == NULL) {",
          "2643:             goto err;",
          "2644:         }",
          "2645:         if (BN_ucmp(s->srp_ctx.A, s->srp_ctx.N) >= 0",
          "2646:             || BN_is_zero(s->srp_ctx.A)) {",
          "2647:             al = SSL_AD_ILLEGAL_PARAMETER;",
          "2649:                    SSL_R_BAD_SRP_PARAMETERS);",
          "2650:             goto f_err;",
          "2651:         }",
          "2652:         OPENSSL_free(s->session->srp_username);",
          "2653:         s->session->srp_username = BUF_strdup(s->srp_ctx.login);",
          "2654:         if (s->session->srp_username == NULL) {",
          "2656:             goto err;",
          "2657:         }",
          "2659:         if (!srp_generate_server_master_secret(s)) {",
          "2661:             goto err;",
          "2662:         }",
          "2663:     } else",
          "2665:     if (alg_k & SSL_kGOST) {",
          "2667:         EVP_PKEY_CTX *pkey_ctx;",
          "2668:         EVP_PKEY *client_pub_pkey = NULL, *pk = NULL;",
          "2669:         unsigned char premaster_secret[32], *start;",
          "",
          "[Removed Lines]",
          "2638:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_BAD_SRP_A_LENGTH);",
          "2642:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_BN_LIB);",
          "2648:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2655:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2660:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2666:         int ret = 0;",
          "",
          "[Added Lines]",
          "2752:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_BAD_SRP_A_LENGTH);",
          "2756:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_BN_LIB);",
          "2762:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "2769:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2774:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 45 ---",
          "[Context before]",
          "2694:         if (!PACKET_get_bytes(&pkt, &data, n)) {",
          "2695:             al = SSL_AD_INTERNAL_ERROR;",
          "2697:             goto f_err;",
          "2698:         }",
          "2699:         if (ASN1_get_object",
          "2700:             ((const unsigned char **)&data, &Tlen, &Ttag, &Tclass,",
          "2701:              n) != V_ASN1_CONSTRUCTED || Ttag != V_ASN1_SEQUENCE",
          "2702:             || Tclass != V_ASN1_UNIVERSAL) {",
          "2704:                    SSL_R_DECRYPTION_FAILED);",
          "2705:             goto gerr;",
          "2706:         }",
          "",
          "[Removed Lines]",
          "2696:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2703:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2809:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2816:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 46 ---",
          "[Context before]",
          "2708:         inlen = Tlen;",
          "2709:         if (EVP_PKEY_decrypt",
          "2710:             (pkey_ctx, premaster_secret, &outlen, start, inlen) <= 0) {",
          "2712:                    SSL_R_DECRYPTION_FAILED);",
          "2713:             goto gerr;",
          "2714:         }",
          "",
          "[Removed Lines]",
          "2711:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "",
          "[Added Lines]",
          "2824:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE,",
          "",
          "---------------",
          "--- Hunk 47 ---",
          "[Context before]",
          "2716:         if (!ssl_generate_master_secret(s, premaster_secret,",
          "2717:                                         sizeof(premaster_secret), 0)) {",
          "2718:             al = SSL_AD_INTERNAL_ERROR;",
          "2720:             goto f_err;",
          "2721:         }",
          "2723:         if (EVP_PKEY_CTX_ctrl",
          "2724:             (pkey_ctx, -1, -1, EVP_PKEY_CTRL_PEER_KEY, 2, NULL) > 0)",
          "2728:  gerr:",
          "2729:         EVP_PKEY_free(client_pub_pkey);",
          "2730:         EVP_PKEY_CTX_free(pkey_ctx);",
          "2733:         goto err;",
          "2734:     } else {",
          "2735:         al = SSL_AD_HANDSHAKE_FAILURE;",
          "2737:         goto f_err;",
          "2738:     }",
          "2741:  f_err:",
          "2742:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "2743: #if !defined(OPENSSL_NO_DH) || !defined(OPENSSL_NO_RSA) || !defined(OPENSSL_NO_EC) || defined(OPENSSL_NO_SRP)",
          "",
          "[Removed Lines]",
          "2719:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2725:             ret = 2;",
          "2726:         else",
          "2727:             ret = 1;",
          "2731:         if (ret)",
          "2732:             return ret;",
          "2736:         SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_UNKNOWN_CIPHER_TYPE);",
          "2740:     return (1);",
          "",
          "[Added Lines]",
          "2832:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2838:             s->no_cert_verify = 1;",
          "2840:         EVP_PKEY_free(client_pub_pkey);",
          "2841:         EVP_PKEY_CTX_free(pkey_ctx);",
          "2842:         return MSG_PROCESS_CONTINUE_PROCESSING;",
          "2849:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE, SSL_R_UNKNOWN_CIPHER_TYPE);",
          "2853:     return MSG_PROCESS_CONTINUE_PROCESSING;",
          "",
          "---------------",
          "--- Hunk 48 ---",
          "[Context before]",
          "2754:     OPENSSL_clear_free(s->s3->tmp.psk, s->s3->tmp.psklen);",
          "2755:     s->s3->tmp.psk = NULL;",
          "2756: #endif",
          "2759: }",
          "2761: int ssl3_get_cert_verify(SSL *s)",
          "2762: {",
          "2766:     long n;",
          "",
          "[Removed Lines]",
          "2757:     s->state = SSL_ST_ERR;",
          "2758:     return (-1);",
          "2763:     EVP_PKEY *pkey = NULL;",
          "2764:     unsigned char *sig, *data;",
          "2765:     int al, ok, ret = 0;",
          "2767:     int type = 0, i, j;",
          "2768:     unsigned int len;",
          "2769:     X509 *peer;",
          "2770:     const EVP_MD *md = NULL;",
          "2771:     EVP_MD_CTX mctx;",
          "2772:     PACKET pkt;",
          "2773:     EVP_MD_CTX_init(&mctx);",
          "",
          "[Added Lines]",
          "2870:     statem_set_error(s);",
          "2871:     return MSG_PROCESS_ERROR;",
          "2876:     int ok, ret = 1;",
          "",
          "---------------",
          "--- Hunk 49 ---",
          "[Context before]",
          "2783:     if (s->session->peer == NULL) {",
          "2785:         goto end;",
          "2786:     }",
          "",
          "[Removed Lines]",
          "2784:         ret = 1;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 50 ---",
          "[Context before]",
          "2794:     if (!ok)",
          "2795:         return ((int)n);",
          "2797:     peer = s->session->peer;",
          "2798:     pkey = X509_get_pubkey(peer);",
          "2799:     type = X509_certificate_type(peer, pkey);",
          "2801:     if (!(type & EVP_PKT_SIGN)) {",
          "2803:                SSL_R_SIGNATURE_FOR_NON_SIGNING_CERTIFICATE);",
          "2804:         al = SSL_AD_ILLEGAL_PARAMETER;",
          "2805:         goto f_err;",
          "",
          "[Removed Lines]",
          "2802:         SSLerr(SSL_F_SSL3_GET_CERT_VERIFY,",
          "",
          "[Added Lines]",
          "2900:     if (tls_process_cert_verify(s, n) == 0)",
          "2901:         ret = -1;",
          "2903:  end:",
          "2904:     BIO_free(s->s3->handshake_buffer);",
          "2905:     s->s3->handshake_buffer = NULL;",
          "2906:     return ret;",
          "2907: }",
          "2910: enum MSG_PROCESS_RETURN tls_process_cert_verify(SSL *s, long n)",
          "2911: {",
          "2912:     EVP_PKEY *pkey = NULL;",
          "2913:     unsigned char *sig, *data;",
          "2914:     int al, ret = MSG_PROCESS_ERROR;",
          "2915:     int type = 0, i, j;",
          "2916:     unsigned int len;",
          "2917:     X509 *peer;",
          "2918:     const EVP_MD *md = NULL;",
          "2919:     EVP_MD_CTX mctx;",
          "2920:     PACKET pkt;",
          "2921:     EVP_MD_CTX_init(&mctx);",
          "2928:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY,",
          "",
          "---------------",
          "--- Hunk 51 ---",
          "[Context before]",
          "2809:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "2811:         al = SSL_AD_INTERNAL_ERROR;",
          "2812:         goto f_err;",
          "2813:     }",
          "",
          "[Removed Lines]",
          "2810:         SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "2936:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 52 ---",
          "[Context before]",
          "2839: #endif",
          "2840:         }",
          "2841:         if (!PACKET_get_net_2(&pkt, &len)) {",
          "2843:             al = SSL_AD_DECODE_ERROR;",
          "2844:             goto f_err;",
          "2845:         }",
          "2846:     }",
          "2847:     j = EVP_PKEY_size(pkey);",
          "2848:     if (((int)len > j) || ((int)PACKET_remaining(&pkt) > j) || (n <= 0)) {",
          "2850:         al = SSL_AD_DECODE_ERROR;",
          "2851:         goto f_err;",
          "2852:     }",
          "2853:     if (!PACKET_get_bytes(&pkt, &data, len)) {",
          "2855:         al = SSL_AD_DECODE_ERROR;",
          "2856:         goto f_err;",
          "2857:     }",
          "",
          "[Removed Lines]",
          "2842:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "2849:         SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_WRONG_SIGNATURE_SIZE);",
          "2854:         SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "",
          "[Added Lines]",
          "2968:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "2975:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_WRONG_SIGNATURE_SIZE);",
          "2980:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_LENGTH_MISMATCH);",
          "",
          "---------------",
          "--- Hunk 53 ---",
          "[Context before]",
          "2861:         void *hdata;",
          "2862:         hdatalen = BIO_get_mem_data(s->s3->handshake_buffer, &hdata);",
          "2863:         if (hdatalen <= 0) {",
          "2865:             al = SSL_AD_INTERNAL_ERROR;",
          "2866:             goto f_err;",
          "2867:         }",
          "",
          "[Removed Lines]",
          "2864:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "2990:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 54 ---",
          "[Context before]",
          "2871: #endif",
          "2872:         if (!EVP_VerifyInit_ex(&mctx, md, NULL)",
          "2873:             || !EVP_VerifyUpdate(&mctx, hdata, hdatalen)) {",
          "2875:             al = SSL_AD_INTERNAL_ERROR;",
          "2876:             goto f_err;",
          "2877:         }",
          "2879:         if (EVP_VerifyFinal(&mctx, data, len, pkey) <= 0) {",
          "2880:             al = SSL_AD_DECRYPT_ERROR;",
          "2882:             goto f_err;",
          "2883:         }",
          "2884:     } else",
          "",
          "[Removed Lines]",
          "2874:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, ERR_R_EVP_LIB);",
          "2881:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_SIGNATURE);",
          "",
          "[Added Lines]",
          "3000:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, ERR_R_EVP_LIB);",
          "3007:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_SIGNATURE);",
          "",
          "---------------",
          "--- Hunk 55 ---",
          "[Context before]",
          "2889:                        pkey->pkey.rsa);",
          "2890:         if (i < 0) {",
          "2891:             al = SSL_AD_DECRYPT_ERROR;",
          "2893:             goto f_err;",
          "2894:         }",
          "2895:         if (i == 0) {",
          "2896:             al = SSL_AD_DECRYPT_ERROR;",
          "2898:             goto f_err;",
          "2899:         }",
          "2900:     } else",
          "",
          "[Removed Lines]",
          "2892:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_RSA_DECRYPT);",
          "2897:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_RSA_SIGNATURE);",
          "",
          "[Added Lines]",
          "3018:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_RSA_DECRYPT);",
          "3023:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_RSA_SIGNATURE);",
          "",
          "---------------",
          "--- Hunk 56 ---",
          "[Context before]",
          "2907:         if (j <= 0) {",
          "2909:             al = SSL_AD_DECRYPT_ERROR;",
          "2911:             goto f_err;",
          "2912:         }",
          "2913:     } else",
          "",
          "[Removed Lines]",
          "2910:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_DSA_SIGNATURE);",
          "",
          "[Added Lines]",
          "3036:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_DSA_SIGNATURE);",
          "",
          "---------------",
          "--- Hunk 57 ---",
          "[Context before]",
          "2920:         if (j <= 0) {",
          "2922:             al = SSL_AD_DECRYPT_ERROR;",
          "2924:             goto f_err;",
          "2925:         }",
          "2926:     } else",
          "",
          "[Removed Lines]",
          "2923:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_ECDSA_SIGNATURE);",
          "",
          "[Added Lines]",
          "3049:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_ECDSA_SIGNATURE);",
          "",
          "---------------",
          "--- Hunk 58 ---",
          "[Context before]",
          "2941:         EVP_PKEY_CTX_free(pctx);",
          "2942:         if (j <= 0) {",
          "2943:             al = SSL_AD_DECRYPT_ERROR;",
          "2945:             goto f_err;",
          "2946:         }",
          "2947:     } else {",
          "2949:         al = SSL_AD_UNSUPPORTED_CERTIFICATE;",
          "2950:         goto f_err;",
          "2951:     }",
          "2954:     if (0) {",
          "2955:  f_err:",
          "2956:         ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "2958:     }",
          "2960:     BIO_free(s->s3->handshake_buffer);",
          "2961:     s->s3->handshake_buffer = NULL;",
          "2962:     EVP_MD_CTX_cleanup(&mctx);",
          "2963:     EVP_PKEY_free(pkey);",
          "2965: }",
          "2967: int ssl3_get_client_certificate(SSL *s)",
          "2968: {",
          "2977:     n = s->method->ssl_get_message(s,",
          "2978:                                    SSL3_ST_SR_CERT_A,",
          "",
          "[Removed Lines]",
          "2944:             SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, SSL_R_BAD_ECDSA_SIGNATURE);",
          "2948:         SSLerr(SSL_F_SSL3_GET_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "2953:     ret = 1;",
          "2957:         s->state = SSL_ST_ERR;",
          "2959:  end:",
          "2964:     return (ret);",
          "2969:     int i, ok, al, ret = -1;",
          "2970:     X509 *x = NULL;",
          "2971:     unsigned long l, llen, n;",
          "2972:     const unsigned char *certstart;",
          "2973:     unsigned char *certbytes;",
          "2974:     STACK_OF(X509) *sk = NULL;",
          "2975:     PACKET pkt, spkt;",
          "",
          "[Added Lines]",
          "3070:             SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, SSL_R_BAD_ECDSA_SIGNATURE);",
          "3074:         SSLerr(SSL_F_TLS_PROCESS_CERT_VERIFY, ERR_R_INTERNAL_ERROR);",
          "3079:     ret = MSG_PROCESS_CONTINUE_READING;",
          "3083:         statem_set_error(s);",
          "3089:     return ret;",
          "3094:     int ok, al;",
          "3095:     long n;",
          "",
          "---------------",
          "--- Hunk 59 ---",
          "[Context before]",
          "3000:             goto f_err;",
          "3001:         }",
          "3002:         s->s3->tmp.reuse_message = 1;",
          "3004:     }",
          "3006:     if (s->s3->tmp.message_type != SSL3_MT_CERTIFICATE) {",
          "",
          "[Removed Lines]",
          "3003:         return (1);",
          "",
          "[Added Lines]",
          "3123:         return 1;",
          "",
          "---------------",
          "--- Hunk 60 ---",
          "[Context before]",
          "3009:         goto f_err;",
          "3010:     }",
          "3012:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "3013:         al = SSL_AD_INTERNAL_ERROR;",
          "3015:         goto f_err;",
          "3016:     }",
          "3018:     if ((sk = sk_X509_new_null()) == NULL) {",
          "3021:     }",
          "3023:     if (!PACKET_get_net_3(&pkt, &llen)",
          "3024:             || !PACKET_get_sub_packet(&pkt, &spkt, llen)",
          "3025:             || PACKET_remaining(&pkt) != 0) {",
          "3026:         al = SSL_AD_DECODE_ERROR;",
          "3028:         goto f_err;",
          "3029:     }",
          "",
          "[Removed Lines]",
          "3014:         SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3019:         SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "3020:         goto done;",
          "3027:         SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, SSL_R_LENGTH_MISMATCH);",
          "",
          "[Added Lines]",
          "3132:     if (tls_process_client_certificate(s, n) == 0)",
          "3133:         goto f_err;",
          "3135:     return 1;",
          "3136:  f_err:",
          "3137:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "3138:     s->state = SSL_ST_ERR;",
          "3139:     return -1;",
          "3140: }",
          "3142: enum MSG_PROCESS_RETURN tls_process_client_certificate(SSL *s, long n)",
          "3143: {",
          "3144:     int i, al, ret = MSG_PROCESS_ERROR;",
          "3145:     X509 *x = NULL;",
          "3146:     unsigned long l, llen;",
          "3147:     const unsigned char *certstart;",
          "3148:     unsigned char *certbytes;",
          "3149:     STACK_OF(X509) *sk = NULL;",
          "3150:     PACKET pkt, spkt;",
          "3154:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3159:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "3160:         goto f_err;",
          "3167:         SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, SSL_R_LENGTH_MISMATCH);",
          "",
          "---------------",
          "--- Hunk 61 ---",
          "[Context before]",
          "3032:         if (!PACKET_get_net_3(&spkt, &l)",
          "3033:                 || !PACKET_get_bytes(&spkt, &certbytes, l)) {",
          "3034:             al = SSL_AD_DECODE_ERROR;",
          "3036:                    SSL_R_CERT_LENGTH_MISMATCH);",
          "3037:             goto f_err;",
          "3038:         }",
          "",
          "[Removed Lines]",
          "3035:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "",
          "[Added Lines]",
          "3175:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "",
          "---------------",
          "--- Hunk 62 ---",
          "[Context before]",
          "3040:         certstart = certbytes;",
          "3041:         x = d2i_X509(NULL, (const unsigned char **)&certbytes, l);",
          "3042:         if (x == NULL) {",
          "3045:         }",
          "3046:         if (certbytes != (certstart + l)) {",
          "3047:             al = SSL_AD_DECODE_ERROR;",
          "3049:                    SSL_R_CERT_LENGTH_MISMATCH);",
          "3050:             goto f_err;",
          "3051:         }",
          "3052:         if (!sk_X509_push(sk, x)) {",
          "3055:         }",
          "3056:         x = NULL;",
          "3057:     }",
          "",
          "[Removed Lines]",
          "3043:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, ERR_R_ASN1_LIB);",
          "3044:             goto done;",
          "3048:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "3053:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "3054:             goto done;",
          "",
          "[Added Lines]",
          "3183:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_ASN1_LIB);",
          "3184:             goto f_err;",
          "3188:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "3193:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);",
          "3194:             goto f_err;",
          "",
          "---------------",
          "--- Hunk 63 ---",
          "[Context before]",
          "3061:         if (s->version == SSL3_VERSION) {",
          "3062:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "3064:                    SSL_R_NO_CERTIFICATES_RETURNED);",
          "3065:             goto f_err;",
          "3066:         }",
          "3068:         else if ((s->verify_mode & SSL_VERIFY_PEER) &&",
          "3069:                  (s->verify_mode & SSL_VERIFY_FAIL_IF_NO_PEER_CERT)) {",
          "3071:                    SSL_R_PEER_DID_NOT_RETURN_A_CERTIFICATE);",
          "3072:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "3073:             goto f_err;",
          "",
          "[Removed Lines]",
          "3063:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "3070:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "",
          "[Added Lines]",
          "3203:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "3210:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "",
          "---------------",
          "--- Hunk 64 ---",
          "[Context before]",
          "3082:         i = ssl_verify_cert_chain(s, sk);",
          "3083:         if (i <= 0) {",
          "3084:             al = ssl_verify_alarm_type(s->verify_result);",
          "3086:                    SSL_R_CERTIFICATE_VERIFY_FAILED);",
          "3087:             goto f_err;",
          "3088:         }",
          "3089:         if (i > 1) {",
          "3091:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "3092:             goto f_err;",
          "3093:         }",
          "3094:         pkey = X509_get_pubkey(sk_X509_value(sk, 0));",
          "3095:         if (pkey == NULL) {",
          "3096:             al = SSL3_AD_HANDSHAKE_FAILURE;",
          "3098:                    SSL_R_UNKNOWN_CERTIFICATE_TYPE);",
          "3099:             goto f_err;",
          "3100:         }",
          "",
          "[Removed Lines]",
          "3085:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "3090:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, i);",
          "3097:             SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,",
          "",
          "[Added Lines]",
          "3225:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "3230:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE, i);",
          "3237:             SSLerr(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE,",
          "",
          "---------------",
          "--- Hunk 65 ---",
          "[Context before]",
          "3114:     sk = NULL;",
          "3116:     goto done;",
          "3118:  f_err:",
          "3119:     ssl3_send_alert(s, SSL3_AL_FATAL, al);",
          "3120:  done:",
          "3122:     X509_free(x);",
          "3123:     sk_X509_pop_free(sk, X509_free);",
          "3125: }",
          "3127: int ssl3_send_server_certificate(SSL *s)",
          "3128: {",
          "3131:     if (s->state == SSL3_ST_SW_CERT_A) {",
          "3144:         s->state = SSL3_ST_SW_CERT_B;",
          "3145:     }",
          "",
          "[Removed Lines]",
          "3115:     ret = 1;",
          "3121:     s->state = SSL_ST_ERR;",
          "3124:     return (ret);",
          "3129:     CERT_PKEY *cpk;",
          "3132:         cpk = ssl_get_server_send_pkey(s);",
          "3133:         if (cpk == NULL) {",
          "3134:             SSLerr(SSL_F_SSL3_SEND_SERVER_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3135:             s->state = SSL_ST_ERR;",
          "3136:             return (0);",
          "3137:         }",
          "3139:         if (!ssl3_output_cert_chain(s, cpk)) {",
          "3140:             SSLerr(SSL_F_SSL3_SEND_SERVER_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3141:             s->state = SSL_ST_ERR;",
          "3142:             return (0);",
          "3143:         }",
          "",
          "[Added Lines]",
          "3255:     ret = MSG_PROCESS_CONTINUE_READING;",
          "3260:     statem_set_error(s);",
          "3264:     return ret;",
          "3270:         if (tls_construct_server_certificate(s) == 0)",
          "3271:             return 0;",
          "",
          "---------------",
          "--- Hunk 66 ---",
          "[Context before]",
          "3148:     return ssl_do_write(s);",
          "3149: }",
          "3152: int ssl3_send_newsession_ticket(SSL *s)",
          "3153: {",
          "3158:     if (s->state == SSL3_ST_SW_SESSION_TICKET_A) {",
          "3181:             return -1;",
          "3271:             goto err;",
          "3273:             goto err;",
          "3286:             goto err;",
          "3289:     }",
          "3293:  err:",
          "3294:     OPENSSL_free(senc);",
          "3295:     EVP_CIPHER_CTX_cleanup(&ctx);",
          "3296:     HMAC_CTX_cleanup(&hctx);",
          "3299: }",
          "3301: int ssl3_send_cert_status(SSL *s)",
          "3302: {",
          "3303:     if (s->state == SSL3_ST_SW_CERT_STATUS_A) {",
          "3313:             return -1;",
          "3330:         s->state = SSL3_ST_SW_CERT_STATUS_B;",
          "3332:     }",
          "3335:     return (ssl3_do_write(s, SSL3_RT_HANDSHAKE));",
          "3336: }",
          "3338: #ifndef OPENSSL_NO_NEXTPROTONEG",
          "",
          "[Removed Lines]",
          "3154:     unsigned char *senc = NULL;",
          "3155:     EVP_CIPHER_CTX ctx;",
          "3156:     HMAC_CTX hctx;",
          "3159:         unsigned char *p, *macstart;",
          "3160:         const unsigned char *const_p;",
          "3161:         int len, slen_full, slen;",
          "3162:         SSL_SESSION *sess;",
          "3163:         unsigned int hlen;",
          "3164:         SSL_CTX *tctx = s->initial_ctx;",
          "3165:         unsigned char iv[EVP_MAX_IV_LENGTH];",
          "3166:         unsigned char key_name[16];",
          "3169:         slen_full = i2d_SSL_SESSION(s->session, NULL);",
          "3174:         if (slen_full == 0 || slen_full > 0xFF00) {",
          "3175:             s->state = SSL_ST_ERR;",
          "3176:             return -1;",
          "3177:         }",
          "3178:         senc = OPENSSL_malloc(slen_full);",
          "3179:         if (!senc) {",
          "3180:             s->state = SSL_ST_ERR;",
          "3182:         }",
          "3184:         EVP_CIPHER_CTX_init(&ctx);",
          "3185:         HMAC_CTX_init(&hctx);",
          "3187:         p = senc;",
          "3188:         if (!i2d_SSL_SESSION(s->session, &p))",
          "3189:             goto err;",
          "3194:         const_p = senc;",
          "3195:         sess = d2i_SSL_SESSION(NULL, &const_p, slen_full);",
          "3196:         if (sess == NULL)",
          "3197:             goto err;",
          "3200:         slen = i2d_SSL_SESSION(sess, NULL);",
          "3202:             SSL_SESSION_free(sess);",
          "3203:             goto err;",
          "3204:         }",
          "3205:         p = senc;",
          "3206:         if (!i2d_SSL_SESSION(sess, &p)) {",
          "3207:             SSL_SESSION_free(sess);",
          "3208:             goto err;",
          "3209:         }",
          "3210:         SSL_SESSION_free(sess);",
          "3220:         if (!BUF_MEM_grow(s->init_buf,",
          "3221:                           SSL_HM_HEADER_LENGTH(s) + 22 + EVP_MAX_IV_LENGTH +",
          "3222:                           EVP_MAX_BLOCK_LENGTH + EVP_MAX_MD_SIZE + slen))",
          "3223:             goto err;",
          "3225:         p = ssl_handshake_start(s);",
          "3230:         if (tctx->tlsext_ticket_key_cb) {",
          "3231:             if (tctx->tlsext_ticket_key_cb(s, key_name, iv, &ctx,",
          "3232:                                            &hctx, 1) < 0)",
          "3233:                 goto err;",
          "3234:         } else {",
          "3235:             if (RAND_bytes(iv, 16) <= 0)",
          "3236:                 goto err;",
          "3237:             if (!EVP_EncryptInit_ex(&ctx, EVP_aes_128_cbc(), NULL,",
          "3238:                                     tctx->tlsext_tick_aes_key, iv))",
          "3239:                 goto err;",
          "3240:             if (!HMAC_Init_ex(&hctx, tctx->tlsext_tick_hmac_key, 16,",
          "3241:                               EVP_sha256(), NULL))",
          "3242:                 goto err;",
          "3243:             memcpy(key_name, tctx->tlsext_tick_key_name, 16);",
          "3244:         }",
          "3251:         l2n(s->hit ? 0 : s->session->timeout, p);",
          "3254:         p += 2;",
          "3256:         macstart = p;",
          "3257:         memcpy(p, key_name, 16);",
          "3258:         p += 16;",
          "3260:         memcpy(p, iv, EVP_CIPHER_CTX_iv_length(&ctx));",
          "3261:         p += EVP_CIPHER_CTX_iv_length(&ctx);",
          "3263:         if (!EVP_EncryptUpdate(&ctx, p, &len, senc, slen))",
          "3264:             goto err;",
          "3265:         p += len;",
          "3266:         if (!EVP_EncryptFinal(&ctx, p, &len))",
          "3267:             goto err;",
          "3268:         p += len;",
          "3270:         if (!HMAC_Update(&hctx, macstart, p - macstart))",
          "3272:         if (!HMAC_Final(&hctx, p, &hlen))",
          "3275:         EVP_CIPHER_CTX_cleanup(&ctx);",
          "3276:         HMAC_CTX_cleanup(&hctx);",
          "3278:         p += hlen;",
          "3281:         len = p - ssl_handshake_start(s);",
          "3283:         p = ssl_handshake_start(s) + 4;",
          "3284:         s2n(len - 6, p);",
          "3285:         if (!ssl_set_handshake_header(s, SSL3_MT_NEWSESSION_TICKET, len))",
          "3287:         s->state = SSL3_ST_SW_SESSION_TICKET_B;",
          "3288:         OPENSSL_free(senc);",
          "3292:     return ssl_do_write(s);",
          "3297:     s->state = SSL_ST_ERR;",
          "3298:     return -1;",
          "3304:         unsigned char *p;",
          "3311:         if (!BUF_MEM_grow(s->init_buf, 8 + s->tlsext_ocsp_resplen)) {",
          "3312:             s->state = SSL_ST_ERR;",
          "3314:         }",
          "3316:         p = (unsigned char *)s->init_buf->data;",
          "3321:         l2n3(s->tlsext_ocsp_resplen + 4, p);",
          "3325:         l2n3(s->tlsext_ocsp_resplen, p);",
          "3327:         memcpy(p, s->tlsext_ocsp_resp, s->tlsext_ocsp_resplen);",
          "3329:         s->init_num = 8 + s->tlsext_ocsp_resplen;",
          "3331:         s->init_off = 0;",
          "",
          "[Added Lines]",
          "3279: int tls_construct_server_certificate(SSL *s)",
          "3280: {",
          "3281:     CERT_PKEY *cpk;",
          "3283:     cpk = ssl_get_server_send_pkey(s);",
          "3284:     if (cpk == NULL) {",
          "3285:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3286:         statem_set_error(s);",
          "3287:         return 0;",
          "3288:     }",
          "3290:     if (!ssl3_output_cert_chain(s, cpk)) {",
          "3291:         SSLerr(SSL_F_TLS_CONSTRUCT_SERVER_CERTIFICATE, ERR_R_INTERNAL_ERROR);",
          "3292:         statem_set_error(s);",
          "3293:         return 0;",
          "3294:     }",
          "3296:     return 1;",
          "3297: }",
          "3303:         if (tls_construct_new_session_ticket(s) == 0)",
          "3306:         s->state = SSL3_ST_SW_SESSION_TICKET_B;",
          "3307:     }",
          "3310:     return ssl_do_write(s);",
          "3311: }",
          "3313: int tls_construct_new_session_ticket(SSL *s)",
          "3314: {",
          "3315:     unsigned char *senc = NULL;",
          "3316:     EVP_CIPHER_CTX ctx;",
          "3317:     HMAC_CTX hctx;",
          "3318:     unsigned char *p, *macstart;",
          "3319:     const unsigned char *const_p;",
          "3320:     int len, slen_full, slen;",
          "3321:     SSL_SESSION *sess;",
          "3322:     unsigned int hlen;",
          "3323:     SSL_CTX *tctx = s->initial_ctx;",
          "3324:     unsigned char iv[EVP_MAX_IV_LENGTH];",
          "3325:     unsigned char key_name[16];",
          "3328:     slen_full = i2d_SSL_SESSION(s->session, NULL);",
          "3333:     if (slen_full == 0 || slen_full > 0xFF00) {",
          "3334:         statem_set_error(s);",
          "3335:         return 0;",
          "3336:     }",
          "3337:     senc = OPENSSL_malloc(slen_full);",
          "3338:     if (!senc) {",
          "3339:         statem_set_error(s);",
          "3340:         return 0;",
          "3341:     }",
          "3343:     EVP_CIPHER_CTX_init(&ctx);",
          "3344:     HMAC_CTX_init(&hctx);",
          "3346:     p = senc;",
          "3347:     if (!i2d_SSL_SESSION(s->session, &p))",
          "3348:         goto err;",
          "3353:     const_p = senc;",
          "3354:     sess = d2i_SSL_SESSION(NULL, &const_p, slen_full);",
          "3355:     if (sess == NULL)",
          "3356:         goto err;",
          "3359:     slen = i2d_SSL_SESSION(sess, NULL);",
          "3361:         SSL_SESSION_free(sess);",
          "3362:         goto err;",
          "3363:     }",
          "3364:     p = senc;",
          "3365:     if (!i2d_SSL_SESSION(sess, &p)) {",
          "3366:         SSL_SESSION_free(sess);",
          "3367:         goto err;",
          "3368:     }",
          "3369:     SSL_SESSION_free(sess);",
          "3379:     if (!BUF_MEM_grow(s->init_buf,",
          "3380:                       SSL_HM_HEADER_LENGTH(s) + 22 + EVP_MAX_IV_LENGTH +",
          "3381:                       EVP_MAX_BLOCK_LENGTH + EVP_MAX_MD_SIZE + slen))",
          "3382:         goto err;",
          "3384:     p = ssl_handshake_start(s);",
          "3389:     if (tctx->tlsext_ticket_key_cb) {",
          "3390:         if (tctx->tlsext_ticket_key_cb(s, key_name, iv, &ctx,",
          "3391:                                        &hctx, 1) < 0)",
          "3392:             goto err;",
          "3393:     } else {",
          "3394:         if (RAND_bytes(iv, 16) <= 0)",
          "3396:         if (!EVP_EncryptInit_ex(&ctx, EVP_aes_128_cbc(), NULL,",
          "3397:                                 tctx->tlsext_tick_aes_key, iv))",
          "3399:         if (!HMAC_Init_ex(&hctx, tctx->tlsext_tick_hmac_key, 16,",
          "3400:                           EVP_sha256(), NULL))",
          "3402:         memcpy(key_name, tctx->tlsext_tick_key_name, 16);",
          "3410:     l2n(s->hit ? 0 : s->session->timeout, p);",
          "3413:     p += 2;",
          "3415:     macstart = p;",
          "3416:     memcpy(p, key_name, 16);",
          "3417:     p += 16;",
          "3419:     memcpy(p, iv, EVP_CIPHER_CTX_iv_length(&ctx));",
          "3420:     p += EVP_CIPHER_CTX_iv_length(&ctx);",
          "3422:     if (!EVP_EncryptUpdate(&ctx, p, &len, senc, slen))",
          "3423:         goto err;",
          "3424:     p += len;",
          "3425:     if (!EVP_EncryptFinal(&ctx, p, &len))",
          "3426:         goto err;",
          "3427:     p += len;",
          "3429:     if (!HMAC_Update(&hctx, macstart, p - macstart))",
          "3430:         goto err;",
          "3431:     if (!HMAC_Final(&hctx, p, &hlen))",
          "3432:         goto err;",
          "3434:     EVP_CIPHER_CTX_cleanup(&ctx);",
          "3435:     HMAC_CTX_cleanup(&hctx);",
          "3437:     p += hlen;",
          "3440:     len = p - ssl_handshake_start(s);",
          "3442:     p = ssl_handshake_start(s) + 4;",
          "3443:     s2n(len - 6, p);",
          "3444:     if (!ssl_set_handshake_header(s, SSL3_MT_NEWSESSION_TICKET, len))",
          "3445:         goto err;",
          "3446:     OPENSSL_free(senc);",
          "3448:     return 1;",
          "3453:     statem_set_error(s);",
          "3454:     return 0;",
          "3460:         if (tls_construct_cert_status(s) == 0)",
          "3470: int tls_construct_cert_status(SSL *s)",
          "3471: {",
          "3472:     unsigned char *p;",
          "3479:     if (!BUF_MEM_grow(s->init_buf, 8 + s->tlsext_ocsp_resplen)) {",
          "3480:         statem_set_error(s);",
          "3481:         return 0;",
          "3482:     }",
          "3484:     p = (unsigned char *)s->init_buf->data;",
          "3489:     l2n3(s->tlsext_ocsp_resplen + 4, p);",
          "3493:     l2n3(s->tlsext_ocsp_resplen, p);",
          "3495:     memcpy(p, s->tlsext_ocsp_resp, s->tlsext_ocsp_resplen);",
          "3497:     s->init_num = 8 + s->tlsext_ocsp_resplen;",
          "3498:     s->init_off = 0;",
          "3500:     return 1;",
          "3501: }",
          "",
          "---------------",
          "--- Hunk 67 ---",
          "[Context before]",
          "3344: {",
          "3345:     int ok;",
          "3346:     long n;",
          "",
          "[Removed Lines]",
          "3347:     PACKET pkt, next_proto, padding;",
          "3348:     size_t next_proto_len;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 68 ---",
          "[Context before]",
          "3375:     if (!s->s3->change_cipher_spec) {",
          "3376:         SSLerr(SSL_F_SSL3_GET_NEXT_PROTO, SSL_R_GOT_NEXT_PROTO_BEFORE_A_CCS);",
          "3378:         return -1;",
          "3379:     }",
          "3381:     if (n < 2) {",
          "3383:     }",
          "3385:     if (!PACKET_buf_init(&pkt, s->init_msg, n)) {",
          "3387:         goto err;",
          "3388:     }",
          "",
          "[Removed Lines]",
          "3377:         s->state = SSL_ST_ERR;",
          "3386:         SSLerr(SSL_F_SSL3_GET_NEXT_PROTO, ERR_R_INTERNAL_ERROR);",
          "",
          "[Added Lines]",
          "3540:         statem_set_error(s);",
          "3544:     if (tls_process_next_proto(s, n) == 0)",
          "3545:         return -1;",
          "3547:     return n;",
          "3548: }",
          "3554: enum MSG_PROCESS_RETURN tls_process_next_proto(SSL *s, long n)",
          "3555: {",
          "3556:     PACKET pkt, next_proto, padding;",
          "3557:     size_t next_proto_len;",
          "3564:         SSLerr(SSL_F_TLS_PROCESS_NEXT_PROTO, ERR_R_INTERNAL_ERROR);",
          "",
          "---------------",
          "--- Hunk 69 ---",
          "[Context before]",
          "3397:     if (!PACKET_get_length_prefixed_1(&pkt, &next_proto)",
          "3398:         || !PACKET_get_length_prefixed_1(&pkt, &padding)",
          "3399:         || PACKET_remaining(&pkt) > 0) {",
          "3401:         goto err;",
          "3402:     }",
          "",
          "[Removed Lines]",
          "3400:         SSLerr(SSL_F_SSL3_GET_NEXT_PROTO, SSL_R_LENGTH_MISMATCH);",
          "",
          "[Added Lines]",
          "3578:         SSLerr(SSL_F_TLS_PROCESS_NEXT_PROTO, SSL_R_LENGTH_MISMATCH);",
          "",
          "---------------",
          "--- Hunk 70 ---",
          "[Context before]",
          "3410:     s->next_proto_negotiated_len = (unsigned char)next_proto_len;",
          "3413: err:",
          "3416: }",
          "3417: #endif",
          "",
          "[Removed Lines]",
          "3412:     return 1;",
          "3414:     s->state = SSL_ST_ERR;",
          "3415:     return 0;",
          "",
          "[Added Lines]",
          "3590:     return MSG_PROCESS_CONTINUE_READING;",
          "3592:     statem_set_error(s);",
          "3593:     return MSG_PROCESS_ERROR;",
          "",
          "---------------"
        ],
        "ssl/ssl_err.c||ssl/ssl_err.c": [
          "File: ssl/ssl_err.c -> ssl/ssl_err.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "339:     {ERR_FUNC(SSL_F_TLS1_SET_SERVER_SIGALGS), \"tls1_set_server_sigalgs\"},",
          "340:     {ERR_FUNC(SSL_F_TLS_CLIENT_KEY_EXCHANGE_POST_WORK),",
          "341:      \"tls_client_key_exchange_post_work\"},",
          "342:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_CLIENT_CERTIFICATE),",
          "343:      \"tls_construct_client_certificate\"},",
          "344:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_CLIENT_HELLO), \"tls_construct_client_hello\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "342:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_CERTIFICATE_REQUEST),",
          "343:      \"tls_construct_certificate_request\"},",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "347:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_CLIENT_VERIFY),",
          "348:      \"tls_construct_client_verify\"},",
          "349:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_FINISHED), \"tls_construct_finished\"},",
          "350:     {ERR_FUNC(SSL_F_TLS_GET_MESSAGE_BODY), \"tls_get_message_body\"},",
          "351:     {ERR_FUNC(SSL_F_TLS_GET_MESSAGE_HEADER), \"tls_get_message_header\"},",
          "352:     {ERR_FUNC(SSL_F_TLS_PREPARE_CLIENT_CERTIFICATE),",
          "353:      \"tls_prepare_client_certificate\"},",
          "354:     {ERR_FUNC(SSL_F_TLS_PROCESS_CERTIFICATE_REQUEST),",
          "355:      \"tls_process_certificate_request\"},",
          "356:     {ERR_FUNC(SSL_F_TLS_PROCESS_CERT_STATUS), \"tls_process_cert_status\"},",
          "357:     {ERR_FUNC(SSL_F_TLS_PROCESS_CHANGE_CIPHER_SPEC),",
          "358:      \"tls_process_change_cipher_spec\"},",
          "359:     {ERR_FUNC(SSL_F_TLS_PROCESS_FINISHED), \"tls_process_finished\"},",
          "360:     {ERR_FUNC(SSL_F_TLS_PROCESS_KEY_EXCHANGE), \"tls_process_key_exchange\"},",
          "361:     {ERR_FUNC(SSL_F_TLS_PROCESS_NEW_SESSION_TICKET),",
          "362:      \"tls_process_new_session_ticket\"},",
          "363:     {ERR_FUNC(SSL_F_TLS_PROCESS_SERVER_CERTIFICATE),",
          "364:      \"tls_process_server_certificate\"},",
          "365:     {ERR_FUNC(SSL_F_TLS_PROCESS_SERVER_DONE), \"tls_process_server_done\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "352:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_HELLO_REQUEST),",
          "353:      \"tls_construct_hello_request\"},",
          "354:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_SERVER_CERTIFICATE),",
          "355:      \"tls_construct_server_certificate\"},",
          "356:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_SERVER_DONE), \"tls_construct_server_done\"},",
          "357:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_SERVER_HELLO), \"tls_construct_server_hello\"},",
          "358:     {ERR_FUNC(SSL_F_TLS_CONSTRUCT_SERVER_KEY_EXCHANGE),",
          "359:      \"tls_construct_server_key_exchange\"},",
          "362:     {ERR_FUNC(SSL_F_TLS_POST_PROCESS_CLIENT_HELLO),",
          "363:      \"tls_post_process_client_hello\"},",
          "369:     {ERR_FUNC(SSL_F_TLS_PROCESS_CERT_VERIFY), \"tls_process_cert_verify\"},",
          "372:     {ERR_FUNC(SSL_F_TLS_PROCESS_CLIENT_CERTIFICATE),",
          "373:      \"tls_process_client_certificate\"},",
          "374:     {ERR_FUNC(SSL_F_TLS_PROCESS_CLIENT_HELLO), \"tls_process_client_hello\"},",
          "375:     {ERR_FUNC(SSL_F_TLS_PROCESS_CLIENT_KEY_EXCHANGE),",
          "376:      \"tls_process_client_key_exchange\"},",
          "381:     {ERR_FUNC(SSL_F_TLS_PROCESS_NEXT_PROTO), \"tls_process_next_proto\"},",
          "",
          "---------------"
        ],
        "ssl/ssl_lib.c||ssl/ssl_lib.c": [
          "File: ssl/ssl_lib.c -> ssl/ssl_lib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "228:     s->init_buf = NULL;",
          "229:     clear_ciphers(s);",
          "230:     s->first_packet = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "231:     s->no_cert_verify = 0;",
          "",
          "---------------"
        ],
        "ssl/ssl_locl.h||ssl/ssl_locl.h": [
          "File: ssl/ssl_locl.h -> ssl/ssl_locl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1161:     void (*msg_callback) (int write_p, int version, int content_type,",
          "1162:                           const void *buf, size_t len, SSL *ssl, void *arg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1161:     unsigned int no_cert_verify;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1557: typedef struct dtls1_state_st {",
          "1558:     unsigned char cookie[DTLS1_COOKIE_LENGTH];",
          "1559:     unsigned int cookie_len;",
          "1562:     unsigned short handshake_write_seq;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1563:     unsigned int cookie_verified;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2051: __owur int ssl3_put_cipher_by_char(const SSL_CIPHER *c, unsigned char *p);",
          "2052: void ssl3_init_finished_mac(SSL *s);",
          "2053: __owur int ssl3_send_server_certificate(SSL *s);",
          "2054: __owur int ssl3_send_newsession_ticket(SSL *s);",
          "2055: __owur int ssl3_send_cert_status(SSL *s);",
          "2056: __owur int ssl3_get_change_cipher_spec(SSL *s, int a, int b);",
          "2057: __owur int ssl3_get_finished(SSL *s, int state_a, int state_b);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2058: __owur int tls_construct_server_certificate(SSL *s);",
          "2060: __owur int tls_construct_new_session_ticket(SSL *s);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2193:                                                      enum WORK_STATE wst);",
          "2194: __owur int tls_construct_server_hello(SSL *s);",
          "2195: __owur int ssl3_send_hello_request(SSL *s);",
          "2196: __owur int ssl3_send_server_key_exchange(SSL *s);",
          "2197: __owur int ssl3_send_certificate_request(SSL *s);",
          "2198: __owur int ssl3_send_server_done(SSL *s);",
          "2199: __owur int ssl3_get_client_certificate(SSL *s);",
          "2200: __owur int ssl3_get_client_key_exchange(SSL *s);",
          "2201: __owur int ssl3_get_cert_verify(SSL *s);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2202: __owur int tls_construct_hello_request(SSL *s);",
          "2204: __owur int tls_construct_server_key_exchange(SSL *s);",
          "2206: __owur int tls_construct_certificate_request(SSL *s);",
          "2208: __owur int tls_construct_server_done(SSL *s);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "85269210ff39eabd1f898716f1e9bbcd2d0b8be2",
      "candidate_info": {
        "commit_hash": "85269210ff39eabd1f898716f1e9bbcd2d0b8be2",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/85269210ff39eabd1f898716f1e9bbcd2d0b8be2",
        "files": [
          "ssl/s3_srvr.c",
          "ssl/ssl_locl.h"
        ],
        "message": "Extended PSK server support.\n\nAdd support for RSAPSK, DHEPSK and ECDHEPSK server side.\n\nUpdate various checks to ensure certificate and server key exchange messages\nare only sent when required.\n\nUpdate message handling. PSK server key exchange parsing now include an\nidentity hint prefix for all PSK server key exchange messages. PSK\nclient key exchange message expects PSK identity and requests key for\nall PSK key exchange ciphersuites.\n\nUpdate flags for RSA, DH and ECDH so they are also used in PSK.\n\nReviewed-by: Matt Caswell <matt@openssl.org>",
        "before_after_code_files": [
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/ssl_locl.h||ssl/ssl_locl.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ],
          "candidate": [
            "ssl/s3_srvr.c||ssl/s3_srvr.c"
          ]
        }
      },
      "candidate_diff": {
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "403:         case SSL3_ST_SW_CERT_B:",
          "410:                 ret = ssl3_send_server_certificate(s);",
          "411:                 if (ret <= 0)",
          "412:                     goto end;",
          "",
          "[Removed Lines]",
          "406:             if (!",
          "407:                 (s->s3->tmp.",
          "408:                  new_cipher->algorithm_auth & (SSL_aNULL | SSL_aSRP))",
          "409: && !(s->s3->tmp.new_cipher->algorithm_mkey & SSL_kPSK)) {",
          "",
          "[Added Lines]",
          "406:             if (!(s->s3->tmp.new_cipher->algorithm_auth &",
          "407:                  (SSL_aNULL | SSL_aSRP | SSL_aPSK))) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "448: #ifndef OPENSSL_NO_PSK",
          "450: #endif",
          "451: #ifndef OPENSSL_NO_SRP",
          "",
          "[Removed Lines]",
          "449:                 || ((alg_k & SSL_kPSK) && s->ctx->psk_identity_hint)",
          "",
          "[Added Lines]",
          "448:                 || ((alg_k & (SSL_kPSK | SSL_kRSAPSK)) && s->ctx->psk_identity_hint)",
          "450:                 || (alg_k & (SSL_PSK & (SSL_kDHEPSK | SSL_kECDHEPSK)))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1723:         r[0] = r[1] = r[2] = r[3] = NULL;",
          "1724:         n = 0;",
          "1725: #ifndef OPENSSL_NO_RSA",
          "1726:         if (type & SSL_kRSA) {",
          "1727:             rsa = cert->rsa_tmp;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1726: #ifndef OPENSSL_NO_PSK",
          "1727:         if (type & SSL_PSK) {",
          "1731:             n += 2;",
          "1732:             if (s->ctx->psk_identity_hint)",
          "1733:                 n += strlen(s->ctx->psk_identity_hint);",
          "1734:         }",
          "1736:         if (type & (SSL_kPSK | SSL_kRSAPSK)) {",
          "1737:         } else",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1752:         } else",
          "1753: #endif",
          "1754: #ifndef OPENSSL_NO_DH",
          "1756:             if (s->cert->dh_tmp_auto) {",
          "1757:                 dhp = ssl_get_auto_dh(s);",
          "1758:                 if (dhp == NULL) {",
          "",
          "[Removed Lines]",
          "1755:         if (type & SSL_kDHE) {",
          "",
          "[Added Lines]",
          "1769:         if (type & (SSL_kDHE | SSL_kDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1817:         } else",
          "1818: #endif",
          "1819: #ifndef OPENSSL_NO_EC",
          "1821:             const EC_GROUP *group;",
          "1823:             ecdhp = cert->ecdh_tmp;",
          "",
          "[Removed Lines]",
          "1820:         if (type & SSL_kECDHE) {",
          "",
          "[Added Lines]",
          "1834:         if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1936:             n = 4 + encodedlen;",
          "",
          "[Added Lines]",
          "1950:             n += 4 + encodedlen;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1945:             r[3] = NULL;",
          "1946:         } else",
          "1956: #ifndef OPENSSL_NO_SRP",
          "1957:         if (type & SSL_kSRP) {",
          "1958:             if ((s->srp_ctx.N == NULL) ||",
          "",
          "[Removed Lines]",
          "1948: #ifndef OPENSSL_NO_PSK",
          "1949:         if (type & SSL_kPSK) {",
          "1953:             n += 2 + strlen(s->ctx->psk_identity_hint);",
          "1954:         } else",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1984:                 n += 2 + nr[i];",
          "1985:         }",
          "1989:             if ((pkey = ssl_get_sign_pkey(s, s->s3->tmp.new_cipher, &md))",
          "1990:                 == NULL) {",
          "1991:                 al = SSL_AD_DECODE_ERROR;",
          "",
          "[Removed Lines]",
          "1987:         if (!(s->s3->tmp.new_cipher->algorithm_auth & (SSL_aNULL | SSL_aSRP))",
          "1988:             && !(s->s3->tmp.new_cipher->algorithm_mkey & SSL_kPSK)) {",
          "",
          "[Added Lines]",
          "1993:         if (!(s->s3->tmp.new_cipher->algorithm_auth & (SSL_aNULL|SSL_aSRP))",
          "1994:             && !(s->s3->tmp.new_cipher->algorithm_mkey & SSL_PSK)) {",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2003:         }",
          "2004:         d = p = ssl_handshake_start(s);",
          "2006:         for (i = 0; i < 4 && r[i] != NULL; i++) {",
          "2007: #ifndef OPENSSL_NO_SRP",
          "2008:             if ((i == 2) && (type & SSL_kSRP)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2012: #ifndef OPENSSL_NO_PSK",
          "2013:         if (type & SSL_PSK) {",
          "2015:             if (s->ctx->psk_identity_hint) {",
          "2016:                 s2n(strlen(s->ctx->psk_identity_hint), p);",
          "2017:                 strncpy((char *)p, s->ctx->psk_identity_hint,",
          "2018:                         strlen(s->ctx->psk_identity_hint));",
          "2019:                 p += strlen(s->ctx->psk_identity_hint);",
          "2020:             } else {",
          "2021:                 s2n(0, p);",
          "2022:             }",
          "2023:         }",
          "2024: #endif",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2016:         }",
          "2018: #ifndef OPENSSL_NO_EC",
          "",
          "[Removed Lines]",
          "2019:         if (type & SSL_kECDHE) {",
          "",
          "[Added Lines]",
          "2039:         if (type & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2038:         }",
          "2039: #endif",
          "2052:         if (pkey != NULL) {",
          "",
          "[Removed Lines]",
          "2041: #ifndef OPENSSL_NO_PSK",
          "2042:         if (type & SSL_kPSK) {",
          "2044:             s2n(strlen(s->ctx->psk_identity_hint), p);",
          "2045:             strncpy((char *)p, s->ctx->psk_identity_hint,",
          "2046:                     strlen(s->ctx->psk_identity_hint));",
          "2047:             p += strlen(s->ctx->psk_identity_hint);",
          "2048:         }",
          "2049: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2250:     alg_k = s->s3->tmp.new_cipher->algorithm_mkey;",
          "2252: #ifndef OPENSSL_NO_RSA",
          "2254:         unsigned char rand_premaster_secret[SSL_MAX_MASTER_KEY_LENGTH];",
          "2255:         int decrypt_len;",
          "2256:         unsigned char decrypt_good, version_good;",
          "",
          "[Removed Lines]",
          "2253:     if (alg_k & SSL_kRSA) {",
          "",
          "[Added Lines]",
          "2262: #ifndef OPENSSL_NO_PSK",
          "2264:     if (alg_k & SSL_PSK) {",
          "2265:         unsigned char psk[PSK_MAX_PSK_LEN];",
          "2266:         size_t psklen;",
          "2267:         if (n < 2) {",
          "2268:             al = SSL_AD_DECODE_ERROR;",
          "2269:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2270:             goto f_err;",
          "2271:         }",
          "2272:         n2s(p, i);",
          "2273:         if (i + 2 > n) {",
          "2274:             al = SSL_AD_DECODE_ERROR;",
          "2275:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2276:             goto f_err;",
          "2277:         }",
          "2278:         if (i > PSK_MAX_IDENTITY_LEN) {",
          "2279:             al = SSL_AD_DECODE_ERROR;",
          "2280:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2281:                    SSL_R_DATA_LENGTH_TOO_LONG);",
          "2282:             goto f_err;",
          "2283:         }",
          "2284:         if (s->psk_server_callback == NULL) {",
          "2285:             al = SSL_AD_INTERNAL_ERROR;",
          "2286:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2287:                    SSL_R_PSK_NO_SERVER_CB);",
          "2288:             goto f_err;",
          "2289:         }",
          "2291:         OPENSSL_free(s->session->psk_identity);",
          "2292:         s->session->psk_identity = BUF_strndup((char *)p, i);",
          "2294:         if (s->session->psk_identity == NULL) {",
          "2295:             al = SSL_AD_INTERNAL_ERROR;",
          "2296:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2297:                    ERR_R_MALLOC_FAILURE);",
          "2298:             goto f_err;",
          "2299:         }",
          "2301:         psklen = s->psk_server_callback(s, s->session->psk_identity,",
          "2302:                                          psk, sizeof(psk));",
          "2304:         if (psklen > PSK_MAX_PSK_LEN) {",
          "2305:             al = SSL_AD_INTERNAL_ERROR;",
          "2306:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2307:             goto f_err;",
          "2308:         } else if (psklen == 0) {",
          "2312:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2313:                    SSL_R_PSK_IDENTITY_NOT_FOUND);",
          "2314:             al = SSL_AD_UNKNOWN_PSK_IDENTITY;",
          "2315:             goto f_err;",
          "2316:         }",
          "2318:         OPENSSL_free(s->s3->tmp.psk);",
          "2319:         s->s3->tmp.psk = BUF_memdup(psk, psklen);",
          "2320:         OPENSSL_cleanse(psk, psklen);",
          "2322:         if (s->s3->tmp.psk == NULL) {",
          "2323:             al = SSL_AD_INTERNAL_ERROR;",
          "2324:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2325:             goto f_err;",
          "2326:         }",
          "2328:         s->s3->tmp.psklen = psklen;",
          "2330:         n -= i + 2;",
          "2331:         p += i;",
          "2332:     }",
          "2333:     if (alg_k & SSL_kPSK) {",
          "2335:         if (n != 0) {",
          "2336:             al = SSL_AD_HANDSHAKE_FAILURE;",
          "2337:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2338:             goto f_err;",
          "2339:         }",
          "2341:         if (!ssl_generate_master_secret(s, NULL, 0, 0)) {",
          "2342:             al = SSL_AD_INTERNAL_ERROR;",
          "2343:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2344:             goto f_err;",
          "2345:         }",
          "2346:     } else",
          "2347: #endif",
          "2349:     if (alg_k & (SSL_kRSA | SSL_kRSAPSK)) {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "2389:     } else",
          "2390: #endif",
          "2391: #ifndef OPENSSL_NO_DH",
          "2393:         int idx = -1;",
          "2394:         EVP_PKEY *skey = NULL;",
          "2395:         if (n > 1) {",
          "2396:             n2s(p, i);",
          "2397:         } else {",
          "2399:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2400:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2401:                        SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);",
          "",
          "[Removed Lines]",
          "2392:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd)) {",
          "2398:             if (alg_k & SSL_kDHE) {",
          "",
          "[Added Lines]",
          "2488:     if (alg_k & (SSL_kDHE | SSL_kDHr | SSL_kDHd | SSL_kDHEPSK)) {",
          "2494:             if (alg_k & (SSL_kDHE | SSL_kDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "2483: #endif",
          "2485: #ifndef OPENSSL_NO_EC",
          "2487:         int ret = 1;",
          "2488:         int field_size = 0;",
          "2489:         const EC_KEY *tkey;",
          "",
          "[Removed Lines]",
          "2486:     if (alg_k & (SSL_kECDHE | SSL_kECDHr | SSL_kECDHe)) {",
          "",
          "[Added Lines]",
          "2582:     if (alg_k & (SSL_kECDHE | SSL_kECDHr | SSL_kECDHe | SSL_kECDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "2526:         if (n == 0L) {",
          "2530:                 al = SSL_AD_HANDSHAKE_FAILURE;",
          "2531:                 SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2532:                        SSL_R_MISSING_TMP_ECDH_KEY);",
          "",
          "[Removed Lines]",
          "2529:             if (alg_k & SSL_kECDHE) {",
          "",
          "[Added Lines]",
          "2625:             if (alg_k & (SSL_kECDHE | SSL_kECDHEPSK)) {",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "2612:         return (ret);",
          "2613:     } else",
          "2614: #endif",
          "2701: #ifndef OPENSSL_NO_SRP",
          "2702:     if (alg_k & SSL_kSRP) {",
          "2703:         int param_len;",
          "",
          "[Removed Lines]",
          "2615: #ifndef OPENSSL_NO_PSK",
          "2616:     if (alg_k & SSL_kPSK) {",
          "2617:         unsigned char *t = NULL;",
          "2618:         unsigned char psk_or_pre_ms[PSK_MAX_PSK_LEN * 2 + 4];",
          "2619:         unsigned int pre_ms_len = 0, psk_len = 0;",
          "2620:         int psk_err = 1;",
          "2621:         char tmp_id[PSK_MAX_IDENTITY_LEN + 1];",
          "2623:         al = SSL_AD_HANDSHAKE_FAILURE;",
          "2625:         n2s(p, i);",
          "2626:         if (n != i + 2) {",
          "2627:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, SSL_R_LENGTH_MISMATCH);",
          "2628:             goto psk_err;",
          "2629:         }",
          "2630:         if (i > PSK_MAX_IDENTITY_LEN) {",
          "2631:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2632:                    SSL_R_DATA_LENGTH_TOO_LONG);",
          "2633:             goto psk_err;",
          "2634:         }",
          "2635:         if (s->psk_server_callback == NULL) {",
          "2636:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2637:                    SSL_R_PSK_NO_SERVER_CB);",
          "2638:             goto psk_err;",
          "2639:         }",
          "2644:         memcpy(tmp_id, p, i);",
          "2645:         memset(tmp_id + i, 0, PSK_MAX_IDENTITY_LEN + 1 - i);",
          "2646:         psk_len = s->psk_server_callback(s, tmp_id,",
          "2647:                                          psk_or_pre_ms,",
          "2648:                                          sizeof(psk_or_pre_ms));",
          "2649:         OPENSSL_cleanse(tmp_id, sizeof(tmp_id));",
          "2651:         if (psk_len > PSK_MAX_PSK_LEN) {",
          "2652:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2653:             goto psk_err;",
          "2654:         } else if (psk_len == 0) {",
          "2658:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,",
          "2659:                    SSL_R_PSK_IDENTITY_NOT_FOUND);",
          "2660:             al = SSL_AD_UNKNOWN_PSK_IDENTITY;",
          "2661:             goto psk_err;",
          "2662:         }",
          "2665:         pre_ms_len = 2 + psk_len + 2 + psk_len;",
          "2666:         t = psk_or_pre_ms;",
          "2667:         memmove(psk_or_pre_ms + psk_len + 4, psk_or_pre_ms, psk_len);",
          "2668:         s2n(psk_len, t);",
          "2669:         memset(t, 0, psk_len);",
          "2670:         t += psk_len;",
          "2671:         s2n(psk_len, t);",
          "2673:         OPENSSL_free(s->session->psk_identity);",
          "2674:         s->session->psk_identity = BUF_strdup((char *)p);",
          "2675:         if (s->session->psk_identity == NULL) {",
          "2676:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2677:             goto psk_err;",
          "2678:         }",
          "2680:         OPENSSL_free(s->session->psk_identity_hint);",
          "2681:         s->session->psk_identity_hint = BUF_strdup(s->ctx->psk_identity_hint);",
          "2682:         if (s->ctx->psk_identity_hint != NULL &&",
          "2683:             s->session->psk_identity_hint == NULL) {",
          "2684:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_MALLOC_FAILURE);",
          "2685:             goto psk_err;",
          "2686:         }",
          "2688:         if (!ssl_generate_master_secret(s, psk_or_pre_ms, pre_ms_len, 0)) {",
          "2689:             al = SSL_AD_INTERNAL_ERROR;",
          "2690:             SSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE, ERR_R_INTERNAL_ERROR);",
          "2691:             goto f_err;",
          "2692:         }",
          "2693:         psk_err = 0;",
          "2694:  psk_err:",
          "2695:         if (psk_err != 0) {",
          "2696:             OPENSSL_cleanse(psk_or_pre_ms, sizeof(psk_or_pre_ms));",
          "2697:             goto f_err;",
          "2698:         }",
          "2699:     } else",
          "2700: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "2819:     EC_POINT_free(clnt_ecpoint);",
          "2820:     EC_KEY_free(srvr_ecdh);",
          "2821:     BN_CTX_free(bn_ctx);",
          "2822: #endif",
          "2823:     s->state = SSL_ST_ERR;",
          "2824:     return (-1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2832: #endif",
          "2833: #ifndef OPENSSL_NO_PSK",
          "2834:     OPENSSL_clear_free(s->s3->tmp.psk, s->s3->tmp.psklen);",
          "2835:     s->s3->tmp.psk = NULL;",
          "",
          "---------------"
        ],
        "ssl/ssl_locl.h||ssl/ssl_locl.h": [
          "File: ssl/ssl_locl.h -> ssl/ssl_locl.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1278:         unsigned char *pms;",
          "1279:         size_t pmslen;",
          "1281:         unsigned char *psk;",
          "1282:         size_t psklen;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1280: #ifndef OPENSSL_NO_PSK",
          "1284: #endif",
          "",
          "---------------"
        ]
      }
    }
  ]
}