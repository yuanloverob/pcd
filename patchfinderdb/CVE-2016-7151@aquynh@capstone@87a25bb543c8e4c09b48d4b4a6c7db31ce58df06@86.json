{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f20a0a032b7cad4101c6d22f6159b82aedd779e3",
      "candidate_info": {
        "commit_hash": "f20a0a032b7cad4101c6d22f6159b82aedd779e3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f20a0a032b7cad4101c6d22f6159b82aedd779e3",
        "files": [
          "arch/X86/X86ATTInstPrinter.c"
        ],
        "message": "Fix UB when accessing un-initialized array (#890)",
        "before_after_code_files": [
          "arch/X86/X86ATTInstPrinter.c||arch/X86/X86ATTInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86ATTInstPrinter.c||arch/X86/X86ATTInstPrinter.c": [
          "File: arch/X86/X86ATTInstPrinter.c -> arch/X86/X86ATTInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "917:  }",
          "919:  if (MI->csh->detail) {",
          "923:   switch(MCInst_getOpcode(MI)) {",
          "",
          "[Removed Lines]",
          "920:   uint8_t access[6];",
          "",
          "[Added Lines]",
          "920:   uint8_t access[6] = {0};",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6039a675a42dc106d3639bf061a45d081a15d84f",
      "candidate_info": {
        "commit_hash": "6039a675a42dc106d3639bf061a45d081a15d84f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/6039a675a42dc106d3639bf061a45d081a15d84f",
        "files": [
          "bindings/python/test_m68k.py"
        ],
        "message": "fixup indentation, mix of spaces and tabs",
        "before_after_code_files": [
          "bindings/python/test_m68k.py||bindings/python/test_m68k.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/test_m68k.py||bindings/python/test_m68k.py": [
          "File: bindings/python/test_m68k.py -> bindings/python/test_m68k.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "45: def print_insn_detail(insn):",
          "46:     if len(insn.operands) > 0:",
          "47:         print(\"\\top_count: %u\" % (len(insn.operands)))",
          "51:     for i, op in enumerate(insn.operands):",
          "52:         if op.type == M68K_OP_REG:",
          "",
          "[Removed Lines]",
          "49:  print(\"\\tgroups_count: %u\" % len(insn.groups))",
          "",
          "[Added Lines]",
          "48:         print(\"\\tgroups_count: %u\" % len(insn.groups))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5862699008f1d245a86a6b5faaceeed5898923d",
      "candidate_info": {
        "commit_hash": "c5862699008f1d245a86a6b5faaceeed5898923d",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c5862699008f1d245a86a6b5faaceeed5898923d",
        "files": [
          "bindings/python/capstone/__init__.py"
        ],
        "message": "python: add __version__",
        "before_after_code_files": [
          "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py": [
          "File: bindings/python/capstone/__init__.py -> bindings/python/capstone/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:     'CS_GRP_IRET',",
          "93:     'CsError',",
          "94: ]",
          "96: # Capstone C interface",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     '__version__',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "99: CS_API_MAJOR = 3",
          "100: CS_API_MINOR = 0",
          "102: # architectures",
          "103: CS_ARCH_ARM = 0",
          "104: CS_ARCH_ARM64 = 1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "104: __version__ = \"%s.%s\" %(CS_API_MAJOR, CS_API_MINOR)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "35a3ca1389287f15191a6b9a321d71e355318127",
      "candidate_info": {
        "commit_hash": "35a3ca1389287f15191a6b9a321d71e355318127",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/35a3ca1389287f15191a6b9a321d71e355318127",
        "files": [
          "arch/M68K/M68KInstPrinter.c"
        ],
        "message": "Adjusted operand printing",
        "before_after_code_files": [
          "arch/M68K/M68KInstPrinter.c||arch/M68K/M68KInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/M68K/M68KInstPrinter.c||arch/M68K/M68KInstPrinter.c": [
          "File: arch/M68K/M68KInstPrinter.c -> arch/M68K/M68KInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "114: static void registerPair(SStream* O, const cs_m68k_op* op)",
          "115: {",
          "118: }",
          "120: void printAddressingMode(SStream* O, const cs_m68k* inst, const cs_m68k_op* op)",
          "",
          "[Removed Lines]",
          "116:  SStream_concat(O, \"%s:%s\", s_reg_names[M68K_REG_D0 + (op->register_bits >> 4)],",
          "117:    s_reg_names[M68K_REG_D0 + (op->register_bits & 0xf)]);",
          "",
          "[Added Lines]",
          "116:  SStream_concat(O, \"%s:%s\", s_reg_names[M68K_REG_D0 + op->reg_pair.reg_0],",
          "117:    s_reg_names[M68K_REG_D0 + op->reg_pair.reg_1]);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8d2642fa6a91135f29eebfab722d3a96cc4d40d7",
      "candidate_info": {
        "commit_hash": "8d2642fa6a91135f29eebfab722d3a96cc4d40d7",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/8d2642fa6a91135f29eebfab722d3a96cc4d40d7",
        "files": [
          "bindings/python/MANIFEST.in",
          "bindings/python/setup.py"
        ],
        "message": "Support all OSs.",
        "before_after_code_files": [
          "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in",
          "bindings/python/setup.py||bindings/python/setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in": [
          "File: bindings/python/MANIFEST.in -> bindings/python/MANIFEST.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: recursive-include prebuilt *",
          "3: include LICENSE.TXT",
          "4: include README",
          "",
          "[Removed Lines]",
          "1: recursive-include src *",
          "",
          "[Added Lines]",
          "1: recursive-include capstone *",
          "",
          "---------------"
        ],
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:         pass",
          "39: # adapted from commit e504b81 of Nguyen Tan Cong",
          "40: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "41: is_64bits = sys.maxsize > 2**32",
          "",
          "[Removed Lines]",
          "37: SETUP_DATA_FILES = []",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "55:     dir_util.copy_tree(\"../../arch\", \"src/arch/\")",
          "56:     dir_util.copy_tree(\"../../include\", \"src/include/\")",
          "59:     src.extend(glob.glob(\"../../*.[ch]\"))",
          "60:     src.extend(glob.glob(\"../../*.mk\"))",
          "",
          "[Removed Lines]",
          "57:     dir_util.copy_tree(\"../../msvc/headers\", \"src/msvc/headers\")",
          "",
          "[Added Lines]",
          "55: #    dir_util.copy_tree(\"../../msvc/headers\", \"src/msvc/headers\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "77:     \"\"\"Reshuffle files for distribution.\"\"\"",
          "79:     def run(self):",
          "81:             try:",
          "82:                 os.unlink(filename)",
          "83:             except Exception:",
          "",
          "[Removed Lines]",
          "80:         for filename in glob.glob(\"capstone/*.{dll,so}\"):",
          "",
          "[Added Lines]",
          "78:         for filename in (glob.glob(\"capstone/*.dll\")",
          "79:                          + glob.glob(\"capstone/*.so\")",
          "80:                          + glob.glob(\"capstone/*.dylib\")):",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "124:         if not os.path.exists('src'):",
          "125:             return",
          "160:                 os.chdir(\"..\")",
          "165: def dummy_src():",
          "",
          "[Removed Lines]",
          "127:         try:",
          "128:             for (lib_name, build_info) in libraries:",
          "129:                 log.info(\"building '%s' library\", lib_name)",
          "131:                 os.chdir(\"src\")",
          "133:                 # platform description refers at https://docs.python.org/2/library/sys.html#sys.platform",
          "134:                 if SYSTEM == \"win32\":",
          "135:                     # Windows build: this process requires few things:",
          "136:                     #    - CMake + MSVC installed",
          "137:                     #    - Run this command in an environment setup for MSVC",
          "138:                     os.mkdir(\"build\")",
          "139:                     os.chdir(\"build\")",
          "140:                     # Do not build tests & static library",
          "141:                     os.system('cmake -DCMAKE_BUILD_TYPE=RELEASE -DCAPSTONE_BUILD_TESTS=0 -DCAPSTONE_BUILD_STATIC=0 -G \"NMake Makefiles\" ..')",
          "142:                     os.system(\"nmake\")",
          "143:                     os.chdir(\"..\")",
          "144:                     SETUP_DATA_FILES.append(\"src/build/capstone.dll\")",
          "145:                 elif SYSTEM == \"cygwin\":",
          "146:                     os.chmod(\"make.sh\", stat.S_IREAD|stat.S_IEXEC)",
          "147:                     if is_64bits:",
          "148:                         os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh cygwin-mingw64\")",
          "149:                     else:",
          "150:                         os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh cygwin-mingw32\")",
          "151:                     SETUP_DATA_FILES.append(\"src/capstone.dll\")",
          "152:                 else:   # Unix",
          "153:                     os.chmod(\"make.sh\", stat.S_IREAD|stat.S_IEXEC)",
          "154:                     os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh\")",
          "155:                     if SYSTEM == \"darwin\":",
          "156:                         SETUP_DATA_FILES.append(\"src/libcapstone.dylib\")",
          "157:                     else:   # Non-OSX",
          "158:                         SETUP_DATA_FILES.append(\"src/libcapstone.so\")",
          "161:         except Exception:",
          "162:             pass",
          "",
          "[Added Lines]",
          "127:         for (lib_name, build_info) in libraries:",
          "128:             log.info(\"building '%s' library\", lib_name)",
          "130:             os.chdir(\"src\")",
          "132:             # platform description refers at https://docs.python.org/2/library/sys.html#sys.platform",
          "133:             if SYSTEM == \"win32\":",
          "134:                 # Windows build: this process requires few things:",
          "135:                 #    - CMake + MSVC installed",
          "136:                 #    - Run this command in an environment setup for MSVC",
          "137:                 os.mkdir(\"build\")",
          "138:                 os.chdir(\"build\")",
          "139:                 # Do not build tests & static library",
          "140:                 os.system('cmake -DCMAKE_BUILD_TYPE=RELEASE -DCAPSTONE_BUILD_TESTS=0 -DCAPSTONE_BUILD_STATIC=0 -G \"NMake Makefiles\" ..')",
          "141:                 os.system(\"nmake\")",
          "143:                 so = \"src/build/capstone.dll\"",
          "144:             elif SYSTEM == \"cygwin\":",
          "145:                 os.chmod(\"make.sh\", stat.S_IREAD|stat.S_IEXEC)",
          "146:                 if is_64bits:",
          "147:                     os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh cygwin-mingw64\")",
          "148:                 else:",
          "149:                     os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh cygwin-mingw32\")",
          "151:                 so = \"src/capstone.dll\"",
          "152:             else:   # Unix",
          "153:                 os.chmod(\"make.sh\", stat.S_IREAD|stat.S_IEXEC)",
          "154:                 os.system(\"CAPSTONE_BUILD_CORE_ONLY=yes ./make.sh\")",
          "155:                 if SYSTEM == \"darwin\":",
          "156:                     so = \"src/libcapstone.dylib\"",
          "157:                 else:   # Non-OSX",
          "158:                     so = \"src/libcapstone.so\"",
          "160:             os.chdir(\"..\")",
          "161:             shutil.copy(so, \"capstone\")",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "192:         ),",
          "193:     )],",
          "194:     zip_safe=False,",
          "195:     package_data={",
          "197:     }",
          "198: )",
          "",
          "[Removed Lines]",
          "196:         \"capstone\": [\"*.dll\"],",
          "",
          "[Added Lines]",
          "194:     include_package_data=True,",
          "196:         \"capstone\": [\"*.so\", \"*.dll\", \"*.dylib\"],",
          "",
          "---------------"
        ]
      }
    }
  ]
}