{
  "cve_id": "CVE-2015-6830",
  "cve_desc": "libraries/plugins/auth/AuthenticationCookie.class.php in phpMyAdmin 4.3.x before 4.3.13.2 and 4.4.x before 4.4.14.1 allows remote attackers to bypass a multiple-reCaptcha protection mechanism against brute-force credential guessing by providing a correct response to a single reCaptcha.",
  "repo": "phpmyadmin/phpmyadmin",
  "patch_hash": "785f4e2711848eb8945894199d5870253a88584e",
  "patch_info": {
    "commit_hash": "785f4e2711848eb8945894199d5870253a88584e",
    "repo": "phpmyadmin/phpmyadmin",
    "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/785f4e2711848eb8945894199d5870253a88584e",
    "files": [
      "ChangeLog",
      "libraries/plugins/auth/AuthenticationCookie.class.php",
      "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
    ],
    "message": "Fix reCaptcha bypass\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
    "before_after_code_files": [
      "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
      "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
    ]
  },
  "patch_diff": {
    "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
      "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "223:                 . $GLOBALS['server'] . '\" />';",
      "224:         } // end if (server choice)",
      "235:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
      "236:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
      "238:         ) {",
      "240:             echo '<script src=\"https://www.google.com/recaptcha/api.js?hl='",
      "",
      "[Removed Lines]",
      "227:         $skip = false;",
      "228:         if (  isset($_SESSION['last_valid_captcha'])",
      "229:             && $_SESSION['last_valid_captcha']",
      "230:         ) {",
      "231:             $skip = true;",
      "232:         }",
      "237:             && !$skip",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "337:             if (! defined('TESTSUITE')) {",
      "338:                 session_destroy();",
      "341:             }",
      "343:             if ($GLOBALS['cfg']['LoginCookieDeleteAll']) {",
      "",
      "[Removed Lines]",
      "340:                 $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "360:         if (! empty($_REQUEST['pma_username'])) {",
      "371:             if (! empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
      "372:                 && ! empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
      "374:             ) {",
      "375:                 if (! empty($_POST[\"g-recaptcha-response\"])) {",
      "",
      "[Removed Lines]",
      "363:             $skip = false;",
      "364:             if (isset($_SESSION['last_valid_captcha'])",
      "365:                 && $_SESSION['last_valid_captcha']",
      "366:             ) {",
      "367:                 $skip = true;",
      "368:             }",
      "373:                 && ! $skip",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "389:                     if ($resp == null || ! $resp->isSuccess()) {",
      "390:                         $conn_error = __('Entered captcha is wrong, try again!');",
      "392:                         return false;",
      "395:                     }",
      "396:                 } else {",
      "403:                 }",
      "404:             }",
      "",
      "[Removed Lines]",
      "391:                         $_SESSION['last_valid_captcha'] = false;",
      "393:                     } else {",
      "394:                         $_SESSION['last_valid_captcha'] = true;",
      "397:                     if (! isset($_SESSION['last_valid_captcha'])",
      "398:                         || ! $_SESSION['last_valid_captcha']",
      "399:                     ) {",
      "400:                         $conn_error = __('Please enter correct captcha!');",
      "401:                         return false;",
      "402:                     }",
      "",
      "[Added Lines]",
      "374:                     $conn_error = __('Please enter correct captcha!');",
      "375:                     return false;",
      "",
      "---------------"
    ],
    "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php": [
      "File: test/classes/plugin/auth/PMA_AuthenticationCookie_test.php -> test/classes/plugin/auth/PMA_AuthenticationCookie_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "186:         $GLOBALS['cfg']['Lang'] = 'en';",
      "187:         $GLOBALS['cfg']['AllowArbitraryServer'] = true;",
      "188:         $GLOBALS['cfg']['Servers'] = array(1, 2);",
      "190:         $GLOBALS['target'] = 'testTarget';",
      "191:         $GLOBALS['db'] = 'testDb';",
      "192:         $GLOBALS['table'] = 'testTable';",
      "",
      "[Removed Lines]",
      "189:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "189:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "190:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "308:         $GLOBALS['cfg']['Lang'] = '';",
      "309:         $GLOBALS['cfg']['AllowArbitraryServer'] = false;",
      "310:         $GLOBALS['cfg']['Servers'] = array(1);",
      "312:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
      "313:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
      "314:         $GLOBALS['server'] = 0;",
      "",
      "[Removed Lines]",
      "311:         $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "435:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
      "436:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
      "437:         $_POST[\"g-recaptcha-response\"] = '';",
      "",
      "[Removed Lines]",
      "434:         $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "485:         $_REQUEST['old_usr'] = '';",
      "486:         $_REQUEST['pma_username'] = 'testPMAUser';",
      "487:         $_REQUEST['pma_servername'] = 'testPMAServer';",
      "",
      "[Removed Lines]",
      "484:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "483:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "484:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "611:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "612:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "613:         $_SESSION['last_access_time'] = '';",
      "617:         $this->object = $this->getMockBuilder('AuthenticationCookie')",
      "",
      "[Removed Lines]",
      "614:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "614:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "615:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "649:         $_COOKIE['pmaPass-1'] = 'pmaPass1';",
      "650:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "651:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "653:         $_SESSION['last_access_time'] = time() - 1000;",
      "654:         $GLOBALS['cfg']['LoginCookieValidity'] = 1440;",
      "",
      "[Removed Lines]",
      "652:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "653:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "654:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "694:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "695:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "696:         $_SESSION['last_access_time'] = 1;",
      "698:         $GLOBALS['cfg']['LoginCookieValidity'] = 0;",
      "699:         $_SESSION['last_access_time'] = -1;",
      "",
      "[Removed Lines]",
      "697:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "699:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "700:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1b939fb3d3640d3bfe9fac6e023ae74cfc28862c",
      "candidate_info": {
        "commit_hash": "1b939fb3d3640d3bfe9fac6e023ae74cfc28862c",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/1b939fb3d3640d3bfe9fac6e023ae74cfc28862c",
        "files": [
          "doc/config.rst",
          "libraries/config.default.php",
          "libraries/config/ServerConfigChecks.class.php",
          "libraries/config/messages.inc.php",
          "libraries/config/setup.forms.php",
          "libraries/plugins/auth/AuthenticationCookie.class.php"
        ],
        "message": "rfe #1441 Add regexp match when using AllowArbitraryServer\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
        "before_after_code_files": [
          "libraries/config.default.php||libraries/config.default.php",
          "libraries/config/ServerConfigChecks.class.php||libraries/config/ServerConfigChecks.class.php",
          "libraries/config/messages.inc.php||libraries/config/messages.inc.php",
          "libraries/config/setup.forms.php||libraries/config/setup.forms.php",
          "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php"
          ],
          "candidate": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/config.default.php||libraries/config.default.php": [
          "File: libraries/config.default.php -> libraries/config.default.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "809: $cfg['AllowArbitraryServer'] = false;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "817: $cfg['ArbitraryServerRegexp'] = '';",
          "",
          "---------------"
        ],
        "libraries/config/ServerConfigChecks.class.php||libraries/config/ServerConfigChecks.class.php": [
          "File: libraries/config/ServerConfigChecks.class.php -> libraries/config/ServerConfigChecks.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "369:     protected static function defineMessages()",
          "370:     {",
          "372:         $sAllowArbitraryServerWarn = sprintf(",
          "373:             $sAllowArbitraryServerWarn,",
          "374:             '[a@?page=form&amp;formset=Features#tab_Security]',",
          "376:             '[/a]'",
          "377:         );",
          "378:         $sBlowfishSecretMsg = __('You didn\\'t have blowfish secret set and have enabled [kbd]cookie[/kbd] authentication, so a key was automatically generated for you. It is used to encrypt cookies; you don\\'t need to remember it.');",
          "",
          "[Removed Lines]",
          "371:         $sAllowArbitraryServerWarn = __('This %soption%s should be disabled as it allows attackers to bruteforce login to any MySQL server. If you feel this is necessary, use %strusted proxies list%s. However, IP-based protection may not be reliable if your IP belongs to an ISP where thousands of users, including you, are connected to.');",
          "375:             '[/a]', '[a@?page=form&amp;formset=Features#tab_Security]',",
          "",
          "[Added Lines]",
          "371:         $sAllowArbitraryServerWarn = __('This %soption%s should be disabled as it allows attackers to bruteforce login to any MySQL server. If you feel this is necessary, use %srestrict login to MySQL server%s or %strusted proxies list%s. However, IP-based protection with trusted proxies list may not be reliable if your IP belongs to an ISP where thousands of users, including you, are connected to.');",
          "375:             '[/a]',",
          "376:             '[a@?page=form&amp;formset=Features#tab_Security]',",
          "377:             '[/a]',",
          "378:             '[a@?page=form&amp;formset=Features#tab_Security]',",
          "",
          "---------------"
        ],
        "libraries/config/messages.inc.php||libraries/config/messages.inc.php": [
          "File: libraries/config/messages.inc.php -> libraries/config/messages.inc.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: $strConfigAllowArbitraryServer_desc",
          "18:     = __('If enabled, user can enter any MySQL server in login form for cookie auth.');",
          "19: $strConfigAllowArbitraryServer_name = __('Allow login to any MySQL server');",
          "20: $strConfigAllowThirdPartyFraming_desc = __(",
          "21:     'Enabling this allows a page located on a different domain to call phpMyAdmin '",
          "22:     . 'inside a frame, and is a potential [strong]security hole[/strong] allowing '",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: $strConfigArbitraryServerRegexp_desc = __(",
          "21:     'Restricts the MySQL servers the user can enter when login to an arbitrary '",
          "22:     . 'MySQL server is enabled by matching the IP of the MySQL server to the given '",
          "23:     . 'regular expression.'",
          "24: );",
          "25: $strConfigArbitraryServerRegexp_name = __('Restrict login to MySQL server');",
          "",
          "---------------"
        ],
        "libraries/config/setup.forms.php||libraries/config/setup.forms.php": [
          "File: libraries/config/setup.forms.php -> libraries/config/setup.forms.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "108:     'TrustedProxies',",
          "109:     'AllowUserDropDatabase',",
          "110:     'AllowArbitraryServer',",
          "111:     'LoginCookieRecall',",
          "112:     'LoginCookieValidity',",
          "113:     'LoginCookieStore',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "111:     'ArbitraryServerRegexp',",
          "",
          "---------------"
        ],
        "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
          "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "406:             if ($GLOBALS['cfg']['AllowArbitraryServer']",
          "407:                 && isset($_REQUEST['pma_servername'])",
          "408:             ) {",
          "409:                 $GLOBALS['pma_auth_server'] = $_REQUEST['pma_servername'];",
          "410:             }",
          "411:             return true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "409:                 if ($GLOBALS['cfg']['ArbitraryServerRegexp']) {",
          "410:                     $parts = explode(' ', $_REQUEST['pma_servername']);",
          "411:                     if (count($parts) == 2) {",
          "412:                         $tmp_host = $parts[0];",
          "413:                     } else {",
          "414:                         $tmp_host = $_REQUEST['pma_servername'];",
          "415:                     }",
          "417:                     $match = preg_match(",
          "418:                         $GLOBALS['cfg']['ArbitraryServerRegexp'], $tmp_host",
          "419:                     );",
          "420:                     if (! $match) {",
          "421:                         $conn_error = __(",
          "422:                             'You are not allowed to log in to this MySQL server!'",
          "423:                         );",
          "424:                         return false;",
          "425:                     }",
          "426:                 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "743a5288350596e067da2569abe5f663a79c4d67",
      "candidate_info": {
        "commit_hash": "743a5288350596e067da2569abe5f663a79c4d67",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/743a5288350596e067da2569abe5f663a79c4d67",
        "files": [
          "ChangeLog",
          "libraries/Header.class.php",
          "libraries/plugins/auth/AuthenticationCookie.class.php",
          "libraries/plugins/auth/recaptcha/LICENSE",
          "libraries/plugins/auth/recaptcha/recaptchalib.php",
          "libraries/plugins/auth/recaptchalib.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ],
        "message": "rfe #1590 Recaptcha API v2\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
        "before_after_code_files": [
          "libraries/Header.class.php||libraries/Header.class.php",
          "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
          "libraries/plugins/auth/recaptchrecaptchalib.php||libraries/plugins/auth/recaptcha/recaptchalib.php",
          "libraries/plugins/auth/recaptchalib.php||libraries/plugins/auth/recaptchalib.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ],
          "candidate": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/Header.class.php||libraries/Header.class.php": [
          "File: libraries/Header.class.php -> libraries/Header.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "499:         if (!empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
          "500:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "501:         ) {",
          "503:         } else {",
          "504:             $captcha_url = '';",
          "505:         }",
          "",
          "[Removed Lines]",
          "502:             $captcha_url = ' https://www.google.com ';",
          "",
          "[Added Lines]",
          "502:             $captcha_url = ' https://www.google.com https://www.gstatic.com ';",
          "",
          "---------------"
        ],
        "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
          "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "233:             && !$skip",
          "234:         ) {",
          "269:         }",
          "271:         echo '</fieldset>",
          "",
          "[Removed Lines]",
          "236:             echo '<script type=\"text/javascript\">",
          "237:                     var RecaptchaOptions = {",
          "238:                         theme : \"white\"",
          "239:                     };",
          "240:                  </script>",
          "241:                  <script type=\"text/javascript\"",
          "242:                     src=\"https://www.google.com/recaptcha/api/challenge?'",
          "243:                     . 'k=' . $GLOBALS['cfg']['CaptchaLoginPublicKey'] . '&amp;'",
          "244:                     . 'hl=' . $GLOBALS['lang'] . '\">",
          "245:                  </script>",
          "246:                  <noscript>",
          "247:                     <iframe src=\"https://www.google.com/recaptcha/api/noscript?k='",
          "248:                 . $GLOBALS['cfg']['CaptchaLoginPublicKey'] . '\"",
          "249:                         height=\"300\" width=\"500\" frameborder=\"0\"></iframe><br>",
          "250:                     <textarea name=\"recaptcha_challenge_field\" rows=\"3\" cols=\"40\">",
          "251:                     </textarea>",
          "252:                     <input type=\"hidden\" name=\"recaptcha_response_field\"",
          "253:                         value=\"manual_challenge\">",
          "254:                  </noscript>",
          "255:                  <script type=\"text/javascript\">",
          "256:                     $(function() {",
          "257:                         $(document).on(",
          "258:                           \"mouseover\",",
          "259:                           \"#recaptcha_reload_btn,\" +",
          "260:                           \"#recaptcha_switch_audio_btn,\" +",
          "261:                           \"#recaptcha_switch_img_btn,\" +",
          "262:                           \"#recaptcha_whatsthis_btn,\" +",
          "263:                           \"#recaptcha_audio_play_again\"",
          "264:                           function() {",
          "265:                             $(this).addClass(\"disableAjax\");",
          "266:                         });",
          "267:                     });",
          "268:                  </script>';",
          "",
          "[Added Lines]",
          "236:             echo '<script src=\"https://www.google.com/recaptcha/api.js?hl='",
          "237:                 . $GLOBALS['lang'] . '\" async defer></script>';",
          "238:             echo '<div class=\"g-recaptcha\" data-sitekey=\"'",
          "239:                 . $GLOBALS['cfg']['CaptchaLoginPublicKey'] . '\"></div>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "365:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "366:             && !$skip",
          "367:         ) {",
          "376:                     $_SERVER[\"REMOTE_ADDR\"],",
          "379:                 );",
          "383:                     $conn_error = __('Entered captcha is wrong, try again!');",
          "384:                     $_SESSION['last_valid_captcha'] = false;",
          "385:                     return false;",
          "386:                 } else {",
          "387:                     $_SESSION['last_valid_captcha'] = true;",
          "388:                 }",
          "394:             } else {",
          "395:                 if (! isset($_SESSION['last_valid_captcha'])",
          "396:                     || ! $_SESSION['last_valid_captcha']",
          "397:                 ) {",
          "398:                     return false;",
          "399:                 }",
          "400:             }",
          "",
          "[Removed Lines]",
          "368:             if (  !empty($_POST[\"recaptcha_challenge_field\"])",
          "369:                 && !empty($_POST[\"recaptcha_response_field\"])",
          "370:             ) {",
          "371:                 include_once 'libraries/plugins/auth/recaptchalib.php';",
          "374:                 $resp = recaptcha_check_answer(",
          "375:                     $GLOBALS['cfg']['CaptchaLoginPrivateKey'],",
          "377:                     $_POST[\"recaptcha_challenge_field\"],",
          "378:                     $_POST[\"recaptcha_response_field\"]",
          "382:                 if ( !$resp->is_valid ) {",
          "389:             } elseif (! empty($_POST[\"recaptcha_challenge_field\"])",
          "390:                 && empty($_POST[\"recaptcha_response_field\"])",
          "391:             ) {",
          "392:                 $conn_error = __('Please enter correct captcha!');",
          "393:                 return false;",
          "",
          "[Added Lines]",
          "339:             if (! empty($_POST[\"g-recaptcha-response\"])) {",
          "341:                 include_once 'libraries/plugins/auth/recaptcha/recaptchalib.php';",
          "342:                 $reCaptcha = new ReCaptcha(",
          "343:                     $GLOBALS['cfg']['CaptchaLoginPrivateKey']",
          "344:                 );",
          "347:                 $resp = $reCaptcha->verifyResponse(",
          "349:                     $_POST[\"g-recaptcha-response\"]",
          "353:                 if ($resp == null || ! $resp->success) {",
          "364:                     $conn_error = __('Please enter correct captcha!');",
          "",
          "---------------"
        ],
        "libraries/plugins/auth/recaptchrecaptchalib.php||libraries/plugins/auth/recaptcha/recaptchalib.php": [
          "File: libraries/plugins/auth/recaptchrecaptchalib.php -> libraries/plugins/auth/recaptcha/recaptchalib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "36: class ReCaptchaResponse",
          "37: {",
          "38:     public $success;",
          "39:     public $errorCodes;",
          "40: }",
          "42: class ReCaptcha",
          "43: {",
          "44:     private static $_signupUrl = \"https://www.google.com/recaptcha/admin\";",
          "45:     private static $_siteVerifyUrl =",
          "46:         \"https://www.google.com/recaptcha/api/siteverify?\";",
          "47:     private $_secret;",
          "48:     private static $_version = \"php_1.0\";",
          "55:     function ReCaptcha($secret)",
          "56:     {",
          "57:         if ($secret == null || $secret == \"\") {",
          "58:             die(\"To use reCAPTCHA you must get an API key from <a href='\"",
          "59:                 . self::$_signupUrl . \"'>\" . self::$_signupUrl . \"</a>\");",
          "60:         }",
          "61:         $this->_secret=$secret;",
          "62:     }",
          "71:     private function _encodeQS($data)",
          "72:     {",
          "73:         $req = \"\";",
          "74:         foreach ($data as $key => $value) {",
          "75:             $req .= $key . '=' . urlencode(stripslashes($value)) . '&';",
          "76:         }",
          "79:         $req=substr($req, 0, strlen($req)-1);",
          "80:         return $req;",
          "81:     }",
          "91:     private function _submitHTTPGet($path, $data)",
          "92:     {",
          "93:         $req = $this->_encodeQS($data);",
          "94:         $response = file_get_contents($path . $req);",
          "95:         return $response;",
          "96:     }",
          "107:     public function verifyResponse($remoteIp, $response)",
          "108:     {",
          "110:         if ($response == null || strlen($response) == 0) {",
          "111:             $recaptchaResponse = new ReCaptchaResponse();",
          "112:             $recaptchaResponse->success = false;",
          "113:             $recaptchaResponse->errorCodes = 'missing-input';",
          "114:             return $recaptchaResponse;",
          "115:         }",
          "117:         $getResponse = $this->_submitHttpGet(",
          "118:             self::$_siteVerifyUrl,",
          "119:             array (",
          "120:                 'secret' => $this->_secret,",
          "121:                 'remoteip' => $remoteIp,",
          "122:                 'v' => self::$_version,",
          "123:                 'response' => $response",
          "124:             )",
          "125:         );",
          "126:         $answers = json_decode($getResponse, true);",
          "127:         $recaptchaResponse = new ReCaptchaResponse();",
          "129:         if (trim($answers ['success']) == true) {",
          "130:             $recaptchaResponse->success = true;",
          "131:         } else {",
          "132:             $recaptchaResponse->success = false;",
          "133:             $recaptchaResponse->errorCodes = $answers ['error-codes'];",
          "134:         }",
          "136:         return $recaptchaResponse;",
          "137:     }",
          "138: }",
          "140: ?>",
          "",
          "---------------"
        ],
        "libraries/plugins/auth/recaptchalib.php||libraries/plugins/auth/recaptchalib.php": [
          "File: libraries/plugins/auth/recaptchalib.php -> libraries/plugins/auth/recaptchalib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php": [
          "File: test/classes/plugin/auth/PMA_AuthenticationCookie_test.php -> test/classes/plugin/auth/PMA_AuthenticationCookie_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "372:         );",
          "374:         $this->assertContains(",
          "377:             $result",
          "378:         );",
          "380:         $this->assertContains(",
          "393:             $result",
          "394:         );",
          "",
          "[Removed Lines]",
          "375:             'src=\"https://www.google.com/recaptcha/api/'",
          "376:             . 'challenge?k=testpubkey&amp;hl=en\">',",
          "381:             'iframe src=\"https://www.google.com/recaptcha/api/noscript' .",
          "382:             '?k=testpubkey\"',",
          "383:             $result",
          "384:         );",
          "386:         $this->assertContains(",
          "387:             '<textarea name=\"recaptcha_challenge_field\" rows=\"3\" cols=\"40\">',",
          "388:             $result",
          "389:         );",
          "391:         $this->assertContains(",
          "392:             '<input type=\"hidden\" name=\"recaptcha_response_field\"',",
          "",
          "[Added Lines]",
          "375:             '<script src=\"https://www.google.com/recaptcha/api.js?hl=en\"'",
          "376:             . ' async defer></script>',",
          "381:             '<div class=\"g-recaptcha\" data-sitekey=\"testpubkey\">',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "473:         $_SESSION['last_valid_captcha'] = false;",
          "474:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "475:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "479:         $this->assertFalse(",
          "480:             $this->object->authCheck()",
          "",
          "[Removed Lines]",
          "476:         $_POST[\"recaptcha_challenge_field\"] = 'captcha1';",
          "477:         $_POST[\"recaptcha_response_field\"] = '';",
          "",
          "[Added Lines]",
          "465:         $_POST[\"g-recaptcha-response\"] = '';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "485:             $GLOBALS['conn_error']",
          "486:         );",
          "502:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "",
          "[Removed Lines]",
          "490:         $_SESSION['last_valid_captcha'] = false;",
          "491:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "492:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "493:         $_POST[\"recaptcha_challenge_field\"] = '';",
          "494:         $_POST[\"recaptcha_response_field\"] = '';",
          "496:         $this->assertFalse(",
          "497:             $this->object->authCheck()",
          "498:         );",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0314e67900f01410bc8c81c58a40dc0515e3c91d",
      "candidate_info": {
        "commit_hash": "0314e67900f01410bc8c81c58a40dc0515e3c91d",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/0314e67900f01410bc8c81c58a40dc0515e3c91d",
        "files": [
          "ChangeLog",
          "libraries/plugins/auth/AuthenticationCookie.class.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ],
        "message": "Fix reCaptcha bypass\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
        "before_after_code_files": [
          "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ],
          "candidate": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
          "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "218:                 . $GLOBALS['server'] . '\" />';",
          "219:         } // end if (server choice)",
          "230:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
          "231:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "233:         ) {",
          "235:             echo '<script type=\"text/javascript\">",
          "",
          "[Removed Lines]",
          "222:         $skip = false;",
          "223:         if (  isset($_SESSION['last_valid_captcha'])",
          "224:             && $_SESSION['last_valid_captcha']",
          "225:         ) {",
          "226:             $skip = true;",
          "227:         }",
          "232:             && !$skip",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "349:             return false;",
          "350:         }",
          "361:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
          "362:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "364:         ) {",
          "365:             if (  !empty($_POST[\"recaptcha_challenge_field\"])",
          "366:                 && !empty($_POST[\"recaptcha_response_field\"])",
          "",
          "[Removed Lines]",
          "353:         $skip = false;",
          "354:         if (  isset($_SESSION['last_valid_captcha'])",
          "355:             && $_SESSION['last_valid_captcha']",
          "356:         ) {",
          "357:             $skip = true;",
          "358:         }",
          "363:             && !$skip",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "379:                 if ( !$resp->is_valid ) {",
          "380:                     $conn_error = __('Entered captcha is wrong, try again!');",
          "382:                     return false;",
          "385:                 }",
          "386:             } elseif (! empty($_POST[\"recaptcha_challenge_field\"])",
          "387:                 && empty($_POST[\"recaptcha_response_field\"])",
          "",
          "[Removed Lines]",
          "381:                     $_SESSION['last_valid_captcha'] = false;",
          "383:                 } else {",
          "384:                     $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "389:                 $conn_error = __('Please enter correct captcha!');",
          "390:                 return false;",
          "391:             } else {",
          "397:             }",
          "398:         }",
          "",
          "[Removed Lines]",
          "392:                 if (! isset($_SESSION['last_valid_captcha'])",
          "393:                     || ! $_SESSION['last_valid_captcha']",
          "394:                 ) {",
          "395:                     return false;",
          "396:                 }",
          "",
          "[Added Lines]",
          "371:                 return false;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "407:             if (! defined('TESTSUITE')) {",
          "408:                 session_destroy();",
          "411:             }",
          "413:             if ($GLOBALS['cfg']['LoginCookieDeleteAll']) {",
          "",
          "[Removed Lines]",
          "410:                 $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php": [
          "File: test/classes/plugin/auth/PMA_AuthenticationCookie_test.php -> test/classes/plugin/auth/PMA_AuthenticationCookie_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "186:         $GLOBALS['cfg']['Lang'] = 'en';",
          "187:         $GLOBALS['cfg']['AllowArbitraryServer'] = true;",
          "188:         $GLOBALS['cfg']['Servers'] = array(1, 2);",
          "190:         $GLOBALS['target'] = 'testTarget';",
          "191:         $GLOBALS['db'] = 'testDb';",
          "192:         $GLOBALS['table'] = 'testTable';",
          "",
          "[Removed Lines]",
          "189:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "189:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "190:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "328:         $GLOBALS['cfg']['Lang'] = '';",
          "329:         $GLOBALS['cfg']['AllowArbitraryServer'] = false;",
          "330:         $GLOBALS['cfg']['Servers'] = array(1);",
          "332:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "333:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "334:         $GLOBALS['server'] = 0;",
          "",
          "[Removed Lines]",
          "331:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "474:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "475:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "476:         $_POST[\"recaptcha_challenge_field\"] = 'captcha1';",
          "",
          "[Removed Lines]",
          "473:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "491:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "492:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "493:         $_POST[\"recaptcha_challenge_field\"] = '';",
          "",
          "[Removed Lines]",
          "490:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "536:         $_REQUEST['old_usr'] = '';",
          "537:         $_REQUEST['pma_username'] = 'testPMAUser';",
          "538:         $_REQUEST['pma_servername'] = 'testPMAServer';",
          "",
          "[Removed Lines]",
          "535:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "533:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "534:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "662:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "663:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "664:         $_SESSION['last_access_time'] = '';",
          "668:         $this->object = $this->getMockBuilder('AuthenticationCookie')",
          "669:             ->disableOriginalConstructor()",
          "",
          "[Removed Lines]",
          "665:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "664:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "665:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "700:         $_COOKIE['pmaPass-1'] = 'pmaPass1';",
          "701:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "702:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "704:         $_SESSION['last_access_time'] = time() - 1000;",
          "705:         $GLOBALS['cfg']['LoginCookieValidity'] = 1440;",
          "",
          "[Removed Lines]",
          "703:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "702:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "703:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "745:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "746:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "747:         $_SESSION['last_access_time'] = 1;",
          "749:         $GLOBALS['cfg']['LoginCookieValidity'] = 0;",
          "750:         $_SESSION['last_access_time'] = -1;",
          "",
          "[Removed Lines]",
          "748:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "748:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "749:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------"
        ]
      }
    }
  ]
}