{
  "cve_id": "CVE-2017-11147",
  "cve_desc": "In PHP before 5.6.30 and 7.x before 7.0.15, the PHAR archive handler could be used by attackers supplying malicious archive files to crash the PHP interpreter or potentially disclose information due to a buffer over-read in the phar_parse_pharfile function in ext/phar/phar.c.",
  "repo": "php/php-src",
  "patch_hash": "e5246580a85f031e1a3b8064edbaa55c1643a451",
  "patch_info": {
    "commit_hash": "e5246580a85f031e1a3b8064edbaa55c1643a451",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/e5246580a85f031e1a3b8064edbaa55c1643a451",
    "files": [
      "ext/phar/phar.c"
    ],
    "message": "Fix bug #73773 - Seg fault when loading hostile phar",
    "before_after_code_files": [
      "ext/phar/phar.c||ext/phar/phar.c"
    ]
  },
  "patch_diff": {
    "ext/phar/phar.c||ext/phar/phar.c": [
      "File: ext/phar/phar.c -> ext/phar/phar.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1054:  entry.is_persistent = mydata->is_persistent;",
      "1056:  for (manifest_index = 0; manifest_index < manifest_count; ++manifest_index) {",
      "1058:    MAPPHAR_FAIL(\"internal corruption of phar \\\"%s\\\" (truncated manifest entry)\")",
      "1059:   }",
      "",
      "[Removed Lines]",
      "1057:   if (buffer + 24 > endbuffer) {",
      "",
      "[Added Lines]",
      "1057:   if (buffer + 28 > endbuffer) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1068:    entry.manifest_pos = manifest_index;",
      "1069:   }",
      "1072:    MAPPHAR_FAIL(\"internal corruption of phar \\\"%s\\\" (truncated manifest entry)\");",
      "1073:   }",
      "",
      "[Removed Lines]",
      "1071:   if (entry.filename_len > endbuffer - buffer - 20) {",
      "",
      "[Added Lines]",
      "1071:   if (entry.filename_len > endbuffer - buffer - 24) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ca46d0acbce55019b970fcd4c1e8a10edfdded93",
      "candidate_info": {
        "commit_hash": "ca46d0acbce55019b970fcd4c1e8a10edfdded93",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/ca46d0acbce55019b970fcd4c1e8a10edfdded93",
        "files": [
          "ext/phar/phar.c",
          "ext/phar/tests/bug73764.phar",
          "ext/phar/tests/bug73764.phpt"
        ],
        "message": "Fix int overflows in phar (bug #73764)",
        "before_after_code_files": [
          "ext/phar/phar.c||ext/phar/phar.c",
          "ext/phar/tests/bug73764.phpt||ext/phar/tests/bug73764.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/phar.c||ext/phar/phar.c"
          ],
          "candidate": [
            "ext/phar/phar.c||ext/phar/phar.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/phar.c||ext/phar/phar.c": [
          "File: ext/phar/phar.c -> ext/phar/phar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1055:  entry.is_persistent = mydata->is_persistent;",
          "1057:  for (manifest_index = 0; manifest_index < manifest_count; ++manifest_index) {",
          "1059:    MAPPHAR_FAIL(\"internal corruption of phar \\\"%s\\\" (truncated manifest entry)\")",
          "1060:   }",
          "",
          "[Removed Lines]",
          "1058:   if (buffer + 4 > endbuffer) {",
          "",
          "[Added Lines]",
          "1058:   if (buffer + 24 > endbuffer) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1069:    entry.manifest_pos = manifest_index;",
          "1070:   }",
          "1073:    MAPPHAR_FAIL(\"internal corruption of phar \\\"%s\\\" (truncated manifest entry)\");",
          "1074:   }",
          "",
          "[Removed Lines]",
          "1072:   if (entry.filename_len + 20 > endbuffer - buffer) {",
          "",
          "[Added Lines]",
          "1072:   if (entry.filename_len > endbuffer - buffer - 20) {",
          "",
          "---------------"
        ],
        "ext/phar/tests/bug73764.phpt||ext/phar/tests/bug73764.phpt": [
          "File: ext/phar/tests/bug73764.phpt -> ext/phar/tests/bug73764.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Phar: PHP bug #73764: Crash while loading hostile phar archive",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
          "5: --FILE--",
          "6: <?php",
          "7: chdir(__DIR__);",
          "8: try {",
          "9: $p = Phar::LoadPhar('bug73764.phar', 'alias.phar');",
          "10: echo \"OK\\n\";",
          "11: } catch(PharException $e) {",
          "12:  echo $e->getMessage();",
          "13: }",
          "14: ?>",
          "15: --EXPECTF--",
          "16: internal corruption of phar \"%sbug73764.phar\" (truncated manifest entry)",
          "",
          "---------------"
        ]
      }
    }
  ]
}