{
  "cve_id": "CVE-2015-4116",
  "cve_desc": "Use-after-free vulnerability in the spl_ptr_heap_insert function in ext/spl/spl_heap.c in PHP before 5.5.27 and 5.6.x before 5.6.11 allows remote attackers to execute arbitrary code by triggering a failed SplMinHeap::compare operation.",
  "repo": "php/php-src",
  "patch_hash": "1cbd25ca15383394ffa9ee8601c5de4c0f2f90e1",
  "patch_info": {
    "commit_hash": "1cbd25ca15383394ffa9ee8601c5de4c0f2f90e1",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/1cbd25ca15383394ffa9ee8601c5de4c0f2f90e1",
    "files": [
      "NEWS",
      "ext/spl/spl_heap.c",
      "ext/spl/tests/bug69737.phpt"
    ],
    "message": "Fix bug #69737 - Segfault when SplMinHeap::compare produces fatal error",
    "before_after_code_files": [
      "ext/spl/spl_heap.c||ext/spl/spl_heap.c",
      "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
    ]
  },
  "patch_diff": {
    "ext/spl/spl_heap.c||ext/spl/spl_heap.c": [
      "File: ext/spl/spl_heap.c -> ext/spl/spl_heap.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "249:  heap->ctor(elem TSRMLS_CC);",
      "253:   heap->elements[i] = heap->elements[(i-1)/2];",
      "254:  }",
      "256:  if (EG(exception)) {",
      "",
      "[Removed Lines]",
      "252:  for(i = heap->count++; i > 0 && heap->cmp(heap->elements[(i-1)/2], elem, cmp_userdata TSRMLS_CC) < 0; i = (i-1)/2) {",
      "",
      "[Added Lines]",
      "252:  for(i = heap->count; i > 0 && heap->cmp(heap->elements[(i-1)/2], elem, cmp_userdata TSRMLS_CC) < 0; i = (i-1)/2) {",
      "255:  heap->count++;",
      "",
      "---------------"
    ],
    "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt": [
      "File: ext/spl/tests/bug69737.phpt -> ext/spl/tests/bug69737.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #69737 (Segfault when SplMinHeap::compare produces fatal error)",
      "3: --FILE--",
      "4: <?php",
      "5: class SplMinHeap1 extends SplMinHeap {",
      "6:   public function compare($a, $b) {",
      "7:     return -parent::notexist($a, $b);",
      "8:   }",
      "9: }",
      "10: $h = new SplMinHeap1();",
      "11: $h->insert(1);",
      "12: $h->insert(6);",
      "13: ?>",
      "14: ===DONE===",
      "15: --EXPECTF--",
      "16: Fatal error: Call to undefined method SplMinHeap::notexist() in %s/bug69737.php on line %d",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9e69ef4ce2b48143249415ea375bc72b5f758dcc",
      "candidate_info": {
        "commit_hash": "9e69ef4ce2b48143249415ea375bc72b5f758dcc",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/9e69ef4ce2b48143249415ea375bc72b5f758dcc",
        "files": [
          "ext/spl/tests/bug69737.phpt"
        ],
        "message": "fix dir separator in test",
        "before_after_code_files": [
          "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ],
          "candidate": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt": [
          "File: ext/spl/tests/bug69737.phpt -> ext/spl/tests/bug69737.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: ?>",
          "14: ===DONE===",
          "15: --EXPECTF--",
          "",
          "[Removed Lines]",
          "16: Fatal error: Call to undefined method SplMinHeap::notexist() in %s/bug69737.php on line %d",
          "",
          "[Added Lines]",
          "16: Fatal error: Call to undefined method SplMinHeap::notexist() in %s%ebug69737.php on line %d",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c0a54d62e259534490cf8c4b8c41be16ded337b3",
      "candidate_info": {
        "commit_hash": "c0a54d62e259534490cf8c4b8c41be16ded337b3",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/c0a54d62e259534490cf8c4b8c41be16ded337b3",
        "files": [
          "ext/spl/tests/bug69737.phpt"
        ],
        "message": "fix test",
        "before_after_code_files": [
          "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ],
          "candidate": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt": [
          "File: ext/spl/tests/bug69737.phpt -> ext/spl/tests/bug69737.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: ?>",
          "14: ===DONE===",
          "15: --EXPECTF--",
          "",
          "[Removed Lines]",
          "16: Fatal error: Call to undefined method SplMinHeap::notexist() in %s/bug69737.php on line %d",
          "",
          "[Added Lines]",
          "16: Fatal error: Uncaught EngineException: Call to undefined method SplMinHeap::notexist() in %s/bug69737.php:%d",
          "17: Stack trace:",
          "18: #0 [internal function]: SplMinHeap1->compare(1, 6)",
          "19: #1 %s/bug69737.php(%d): SplHeap->insert(6)",
          "20: #2 {main}",
          "21:   thrown in %s/bug69737.php on line %d",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0cd86f6b7783ad09acd98a655f38d1359d9e0c72",
      "candidate_info": {
        "commit_hash": "0cd86f6b7783ad09acd98a655f38d1359d9e0c72",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/0cd86f6b7783ad09acd98a655f38d1359d9e0c72",
        "files": [
          "ext/spl/tests/bug69737.phpt"
        ],
        "message": "fix dir separator in test",
        "before_after_code_files": [
          "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ],
          "candidate": [
            "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/tests/bug69737.phpt||ext/spl/tests/bug69737.phpt": [
          "File: ext/spl/tests/bug69737.phpt -> ext/spl/tests/bug69737.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: ?>",
          "14: ===DONE===",
          "15: --EXPECTF--",
          "17: Stack trace:",
          "18: #0 [internal function]: SplMinHeap1->compare(1, 6)",
          "20: #2 {main}",
          "",
          "[Removed Lines]",
          "16: Fatal error: Uncaught EngineException: Call to undefined method SplMinHeap::notexist() in %s/bug69737.php:%d",
          "19: #1 %s/bug69737.php(%d): SplHeap->insert(6)",
          "21:   thrown in %s/bug69737.php on line %d",
          "",
          "[Added Lines]",
          "16: Fatal error: Uncaught EngineException: Call to undefined method SplMinHeap::notexist() in %s%ebug69737.php:%d",
          "19: #1 %s%ebug69737.php(%d): SplHeap->insert(6)",
          "21:   thrown in %s%ebug69737.php on line %d",
          "",
          "---------------"
        ]
      }
    }
  ]
}