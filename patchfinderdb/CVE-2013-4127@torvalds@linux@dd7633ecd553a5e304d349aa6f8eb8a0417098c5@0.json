{
  "cve_id": "CVE-2013-4127",
  "cve_desc": "Use-after-free vulnerability in the vhost_net_set_backend function in drivers/vhost/net.c in the Linux kernel through 3.10.3 allows local users to cause a denial of service (OOPS and system crash) via vectors involving powering on a virtual machine.",
  "repo": "torvalds/linux",
  "patch_hash": "dd7633ecd553a5e304d349aa6f8eb8a0417098c5",
  "patch_info": {
    "commit_hash": "dd7633ecd553a5e304d349aa6f8eb8a0417098c5",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/dd7633ecd553a5e304d349aa6f8eb8a0417098c5",
    "files": [
      "drivers/vhost/net.c"
    ],
    "message": "vhost-net: fix use-after-free in vhost_net_flush\n\nvhost_net_ubuf_put_and_wait has a confusing name:\nit will actually also free it's argument.\nThus since commit 1280c27f8e29acf4af2da914e80ec27c3dbd5c01\n    \"vhost-net: flush outstanding DMAs on memory change\"\nvhost_net_flush tries to use the argument after passing it\nto vhost_net_ubuf_put_and_wait, this results\nin use after free.\nTo fix, don't free the argument in vhost_net_ubuf_put_and_wait,\nadd an new API for callers that want to free ubufs.\n\nAcked-by: Asias He <asias@redhat.com>\nAcked-by: Jason Wang <jasowang@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "drivers/vhost/net.c||drivers/vhost/net.c"
    ]
  },
  "patch_diff": {
    "drivers/vhost/net.c||drivers/vhost/net.c": [
      "File: drivers/vhost/net.c -> drivers/vhost/net.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "150: {",
      "151:  kref_put(&ubufs->kref, vhost_net_zerocopy_done_signal);",
      "152:  wait_event(ubufs->wait, !atomic_read(&ubufs->kref.refcount));",
      "153:  kfree(ubufs);",
      "154: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "153: }",
      "155: static void vhost_net_ubuf_put_wait_and_free(struct vhost_net_ubuf_ref *ubufs)",
      "156: {",
      "157:  vhost_net_ubuf_put_and_wait(ubufs);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "948:  mutex_unlock(&vq->mutex);",
      "950:  if (oldubufs) {",
      "952:   mutex_lock(&vq->mutex);",
      "953:   vhost_zerocopy_signal_used(n, vq);",
      "954:   mutex_unlock(&vq->mutex);",
      "",
      "[Removed Lines]",
      "951:   vhost_net_ubuf_put_and_wait(oldubufs);",
      "",
      "[Added Lines]",
      "956:   vhost_net_ubuf_put_wait_and_free(oldubufs);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "966:  rcu_assign_pointer(vq->private_data, oldsock);",
      "967:  vhost_net_enable_vq(n, vq);",
      "968:  if (ubufs)",
      "970: err_ubufs:",
      "971:  fput(sock->file);",
      "972: err_vq:",
      "",
      "[Removed Lines]",
      "969:   vhost_net_ubuf_put_and_wait(ubufs);",
      "",
      "[Added Lines]",
      "974:   vhost_net_ubuf_put_wait_and_free(ubufs);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c38e39c378f46f00ce922dd40a91043a9925c28d",
      "candidate_info": {
        "commit_hash": "c38e39c378f46f00ce922dd40a91043a9925c28d",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/c38e39c378f46f00ce922dd40a91043a9925c28d",
        "files": [
          "drivers/vhost/net.c"
        ],
        "message": "vhost-net: fix use-after-free in vhost_net_flush\n\nvhost_net_ubuf_put_and_wait has a confusing name:\nit will actually also free it's argument.\nThus since commit 1280c27f8e29acf4af2da914e80ec27c3dbd5c01\n    \"vhost-net: flush outstanding DMAs on memory change\"\nvhost_net_flush tries to use the argument after passing it\nto vhost_net_ubuf_put_and_wait, this results\nin use after free.\nTo fix, don't free the argument in vhost_net_ubuf_put_and_wait,\nadd an new API for callers that want to free ubufs.\n\nAcked-by: Asias He <asias@redhat.com>\nAcked-by: Jason Wang <jasowang@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "drivers/vhost/net.c||drivers/vhost/net.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "drivers/vhost/net.c||drivers/vhost/net.c"
          ],
          "candidate": [
            "drivers/vhost/net.c||drivers/vhost/net.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/vhost/net.c||drivers/vhost/net.c": [
          "File: drivers/vhost/net.c -> drivers/vhost/net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "150: {",
          "151:  kref_put(&ubufs->kref, vhost_net_zerocopy_done_signal);",
          "152:  wait_event(ubufs->wait, !atomic_read(&ubufs->kref.refcount));",
          "153:  kfree(ubufs);",
          "154: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "153: }",
          "155: static void vhost_net_ubuf_put_wait_and_free(struct vhost_net_ubuf_ref *ubufs)",
          "156: {",
          "157:  vhost_net_ubuf_put_and_wait(ubufs);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "948:  mutex_unlock(&vq->mutex);",
          "950:  if (oldubufs) {",
          "952:   mutex_lock(&vq->mutex);",
          "953:   vhost_zerocopy_signal_used(n, vq);",
          "954:   mutex_unlock(&vq->mutex);",
          "",
          "[Removed Lines]",
          "951:   vhost_net_ubuf_put_and_wait(oldubufs);",
          "",
          "[Added Lines]",
          "956:   vhost_net_ubuf_put_wait_and_free(oldubufs);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "966:  rcu_assign_pointer(vq->private_data, oldsock);",
          "967:  vhost_net_enable_vq(n, vq);",
          "968:  if (ubufs)",
          "970: err_ubufs:",
          "971:  fput(sock->file);",
          "972: err_vq:",
          "",
          "[Removed Lines]",
          "969:   vhost_net_ubuf_put_and_wait(ubufs);",
          "",
          "[Added Lines]",
          "974:   vhost_net_ubuf_put_wait_and_free(ubufs);",
          "",
          "---------------"
        ]
      }
    }
  ]
}