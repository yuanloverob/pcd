{
  "cve_id": "CVE-2014-0182",
  "cve_desc": "Heap-based buffer overflow in the virtio_load function in hw/virtio/virtio.c in QEMU before 1.7.2 might allow remote attackers to execute arbitrary code via a crafted config length in a savevm image.",
  "repo": "qemu/qemu",
  "patch_hash": "a890a2f9137ac3cf5b607649e66a6f3a5512d8dc",
  "patch_info": {
    "commit_hash": "a890a2f9137ac3cf5b607649e66a6f3a5512d8dc",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/a890a2f9137ac3cf5b607649e66a6f3a5512d8dc",
    "files": [
      "hw/virtio/virtio.c"
    ],
    "message": "virtio: validate config_len on load\n\nMalformed input can have config_len in migration stream\nexceed the array size allocated on destination, the\nresult will be heap overflow.\n\nTo fix, that config_len matches on both sides.\n\nCVE-2014-0182\n\nReported-by: \"Dr. David Alan Gilbert\" <dgilbert@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n\n--\n\nv2: use %ix and %zx to print config_len values\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
    "before_after_code_files": [
      "hw/virtio/virtio.c||hw/virtio/virtio.c"
    ]
  },
  "patch_diff": {
    "hw/virtio/virtio.c||hw/virtio/virtio.c": [
      "File: hw/virtio/virtio.c -> hw/virtio/virtio.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "898: int virtio_load(VirtIODevice *vdev, QEMUFile *f)",
      "899: {",
      "900:     int i, ret;",
      "901:     uint32_t num;",
      "902:     uint32_t features;",
      "903:     uint32_t supported_features;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "901:     int32_t config_len;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "924:                      features, supported_features);",
      "925:         return -1;",
      "926:     }",
      "928:     qemu_get_buffer(f, vdev->config, vdev->config_len);",
      "930:     num = qemu_get_be32(f);",
      "",
      "[Removed Lines]",
      "927:     vdev->config_len = qemu_get_be32(f);",
      "",
      "[Added Lines]",
      "928:     config_len = qemu_get_be32(f);",
      "929:     if (config_len != vdev->config_len) {",
      "930:         error_report(\"Unexpected config length 0x%x. Expected 0x%zx\",",
      "931:                      config_len, vdev->config_len);",
      "932:         return -1;",
      "933:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3bb84a6c988e59892b0ca2a143805f92eb4b04ba",
      "candidate_info": {
        "commit_hash": "3bb84a6c988e59892b0ca2a143805f92eb4b04ba",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/3bb84a6c988e59892b0ca2a143805f92eb4b04ba",
        "files": [
          "hw/virtio/virtio.c"
        ],
        "message": "virtio: validate config_len on load\n\nMalformed input can have config_len in migration stream\nexceed the array size allocated on destination, the\nresult will be heap overflow.\n\nTo fix, that config_len matches on both sides.\n\nCVE-2014-0182\n\nReported-by: \"Dr. David Alan Gilbert\" <dgilbert@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n\n--\n\nv2: use %ix and %zx to print config_len values\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit a890a2f9137ac3cf5b607649e66a6f3a5512d8dc)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/virtio/virtio.c||hw/virtio/virtio.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ],
          "candidate": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/virtio/virtio.c||hw/virtio/virtio.c": [
          "File: hw/virtio/virtio.c -> hw/virtio/virtio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "898: int virtio_load(VirtIODevice *vdev, QEMUFile *f)",
          "899: {",
          "900:     int i, ret;",
          "901:     uint32_t num;",
          "902:     uint32_t features;",
          "903:     uint32_t supported_features;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "901:     int32_t config_len;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "924:                      features, supported_features);",
          "925:         return -1;",
          "926:     }",
          "928:     qemu_get_buffer(f, vdev->config, vdev->config_len);",
          "930:     num = qemu_get_be32(f);",
          "",
          "[Removed Lines]",
          "927:     vdev->config_len = qemu_get_be32(f);",
          "",
          "[Added Lines]",
          "928:     config_len = qemu_get_be32(f);",
          "929:     if (config_len != vdev->config_len) {",
          "930:         error_report(\"Unexpected config length 0x%x. Expected 0x%zx\",",
          "931:                      config_len, vdev->config_len);",
          "932:         return -1;",
          "933:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2003205fd2799fdeebe56a6c700d34555d114142",
      "candidate_info": {
        "commit_hash": "2003205fd2799fdeebe56a6c700d34555d114142",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/2003205fd2799fdeebe56a6c700d34555d114142",
        "files": [
          "hw/virtio/virtio.c"
        ],
        "message": "virtio: validate config_len on load\n\nMalformed input can have config_len in migration stream\nexceed the array size allocated on destination, the\nresult will be heap overflow.\n\nTo fix, that config_len matches on both sides.\n\nCVE-2014-0182\n\nReported-by: \"Dr. David Alan Gilbert\" <dgilbert@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n\n--\n\nv2: use %ix and %zx to print config_len values\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit a890a2f9137ac3cf5b607649e66a6f3a5512d8dc)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/virtio/virtio.c||hw/virtio/virtio.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ],
          "candidate": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/virtio/virtio.c||hw/virtio/virtio.c": [
          "File: hw/virtio/virtio.c -> hw/virtio/virtio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "895: int virtio_load(VirtIODevice *vdev, QEMUFile *f)",
          "896: {",
          "897:     int i, ret;",
          "898:     uint32_t num;",
          "899:     uint32_t features;",
          "900:     uint32_t supported_features;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "898:     int32_t config_len;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "921:                      features, supported_features);",
          "922:         return -1;",
          "923:     }",
          "925:     qemu_get_buffer(f, vdev->config, vdev->config_len);",
          "927:     num = qemu_get_be32(f);",
          "",
          "[Removed Lines]",
          "924:     vdev->config_len = qemu_get_be32(f);",
          "",
          "[Added Lines]",
          "925:     config_len = qemu_get_be32(f);",
          "926:     if (config_len != vdev->config_len) {",
          "927:         error_report(\"Unexpected config length 0x%x. Expected 0x%zx\",",
          "928:                      config_len, vdev->config_len);",
          "929:         return -1;",
          "930:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2f5732e9648fcddc8759a8fd25c0b41a38352be6",
      "candidate_info": {
        "commit_hash": "2f5732e9648fcddc8759a8fd25c0b41a38352be6",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/2f5732e9648fcddc8759a8fd25c0b41a38352be6",
        "files": [
          "hw/virtio/virtio.c"
        ],
        "message": "Allow mismatched virtio config-len\n\nCommit 'virtio: validate config_len on load' restricted config_len\nloaded from the wire to match the config_len that the device had.\n\nUnfortunately, there are cases where this isn't true, the one\nwe found it on was the wce addition in virtio-blk.\n\nAllow mismatched config-lengths:\n   *) If the version on the wire is shorter then fine\n   *) If the version on the wire is longer, load what we have space\n      for and skip the rest.\n\n(This is mst@redhat.com's rework of what I originally posted)\n\nSigned-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>\nReviewed-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "hw/virtio/virtio.c||hw/virtio/virtio.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ],
          "candidate": [
            "hw/virtio/virtio.c||hw/virtio/virtio.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/virtio/virtio.c||hw/virtio/virtio.c": [
          "File: hw/virtio/virtio.c -> hw/virtio/virtio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "926:         return -1;",
          "927:     }",
          "928:     config_len = qemu_get_be32(f);",
          "933:     }",
          "936:     num = qemu_get_be32(f);",
          "",
          "[Removed Lines]",
          "929:     if (config_len != vdev->config_len) {",
          "930:         error_report(\"Unexpected config length 0x%x. Expected 0x%zx\",",
          "931:                      config_len, vdev->config_len);",
          "932:         return -1;",
          "934:     qemu_get_buffer(f, vdev->config, vdev->config_len);",
          "",
          "[Added Lines]",
          "935:     qemu_get_buffer(f, vdev->config, MIN(config_len, vdev->config_len));",
          "937:     while (config_len > vdev->config_len) {",
          "938:         qemu_get_byte(f);",
          "939:         config_len--;",
          "",
          "---------------"
        ]
      }
    }
  ]
}