{
  "cve_id": "CVE-2022-29211",
  "cve_desc": "TensorFlow is an open source platform for machine learning. Prior to versions 2.9.0, 2.8.1, 2.7.2, and 2.6.4, the implementation of `tf.histogram_fixed_width` is vulnerable to a crash when the values array contain `Not a Number` (`NaN`) elements. The implementation assumes that all floating point operations are defined and then converts a floating point result to an integer index. If `values` contains `NaN` then the result of the division is still `NaN` and the cast to `int32` would result in a crash. This only occurs on the CPU implementation. Versions 2.9.0, 2.8.1, 2.7.2, and 2.6.4 contain a patch for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "e57fd691c7b0fd00ea3bfe43444f30c1969748b5",
  "patch_info": {
    "commit_hash": "e57fd691c7b0fd00ea3bfe43444f30c1969748b5",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/e57fd691c7b0fd00ea3bfe43444f30c1969748b5",
    "files": [
      "tensorflow/core/kernels/histogram_op.cc"
    ],
    "message": "Prevent crash when histogram is called with NaN values.\n\nFixes #45770\n\nPiperOrigin-RevId: 443149951",
    "before_after_code_files": [
      "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc": [
      "File: tensorflow/core/kernels/histogram_op.cc -> tensorflow/core/kernels/histogram_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "50:                         static_cast<double>(nbins);",
      "51:     const double nbins_minus_1 = static_cast<double>(nbins - 1);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "54:     const Eigen::Tensor<int32, 1, 1> nans_tensor =",
      "55:         values.isnan().template cast<int32>();",
      "56:     const Eigen::Tensor<int32, 0, 1> reduced_tensor = nans_tensor.sum();",
      "57:     const int num_nans = reduced_tensor(0);",
      "58:     if (num_nans > 0) {",
      "59:       return errors::InvalidArgument(\"Histogram values must not contain NaN\");",
      "60:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "98:     const auto nbins = nbins_tensor.scalar<int32>()();",
      "100:     OP_REQUIRES(",
      "102:         errors::InvalidArgument(\"value_range should satisfy value_range[0] < \"",
      "103:                                 \"value_range[1], but got '[\",",
      "104:                                 value_range(0), \", \", value_range(1), \"]'\"));",
      "105:     OP_REQUIRES(",
      "107:         errors::InvalidArgument(\"nbins should be a positive number, but got '\",",
      "108:                                 nbins, \"'\"));",
      "",
      "[Removed Lines]",
      "101:         ctx, (value_range(0) < value_range(1)),",
      "106:         ctx, (nbins > 0),",
      "",
      "[Added Lines]",
      "110:         ctx, value_range(0) < value_range(1),",
      "115:         ctx, nbins > 0,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1338c29ca34fc7d7125430cb63c6c364c54abddd",
      "candidate_info": {
        "commit_hash": "1338c29ca34fc7d7125430cb63c6c364c54abddd",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/1338c29ca34fc7d7125430cb63c6c364c54abddd",
        "files": [
          "tensorflow/core/kernels/histogram_op.cc"
        ],
        "message": "Prevent crash when histogram is called with NaN values.\n\nFixes #45770\n\nPiperOrigin-RevId: 443149951",
        "before_after_code_files": [
          "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc": [
          "File: tensorflow/core/kernels/histogram_op.cc -> tensorflow/core/kernels/histogram_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:                         static_cast<double>(nbins);",
          "51:     const double nbins_minus_1 = static_cast<double>(nbins - 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     const Eigen::Tensor<int32, 1, 1> nans_tensor =",
          "55:         values.isnan().template cast<int32>();",
          "56:     const Eigen::Tensor<int32, 0, 1> reduced_tensor = nans_tensor.sum();",
          "57:     const int num_nans = reduced_tensor(0);",
          "58:     if (num_nans > 0) {",
          "59:       return errors::InvalidArgument(\"Histogram values must not contain NaN\");",
          "60:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:     const auto nbins = nbins_tensor.scalar<int32>()();",
          "100:     OP_REQUIRES(",
          "102:         errors::InvalidArgument(\"value_range should satisfy value_range[0] < \"",
          "103:                                 \"value_range[1], but got '[\",",
          "104:                                 value_range(0), \", \", value_range(1), \"]'\"));",
          "105:     OP_REQUIRES(",
          "107:         errors::InvalidArgument(\"nbins should be a positive number, but got '\",",
          "108:                                 nbins, \"'\"));",
          "",
          "[Removed Lines]",
          "101:         ctx, (value_range(0) < value_range(1)),",
          "106:         ctx, (nbins > 0),",
          "",
          "[Added Lines]",
          "110:         ctx, value_range(0) < value_range(1),",
          "115:         ctx, nbins > 0,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f37c07e574321caf40775462f1eda3f67fbd7a1a",
      "candidate_info": {
        "commit_hash": "f37c07e574321caf40775462f1eda3f67fbd7a1a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f37c07e574321caf40775462f1eda3f67fbd7a1a",
        "files": [
          "tensorflow/core/kernels/histogram_op.cc"
        ],
        "message": "Prevent crash when histogram is called with NaN values.\n\nFixes #45770\n\nPiperOrigin-RevId: 443149951",
        "before_after_code_files": [
          "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc": [
          "File: tensorflow/core/kernels/histogram_op.cc -> tensorflow/core/kernels/histogram_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:                         static_cast<double>(nbins);",
          "51:     const double nbins_minus_1 = static_cast<double>(nbins - 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     const Eigen::Tensor<int32, 1, 1> nans_tensor =",
          "55:         values.isnan().template cast<int32>();",
          "56:     const Eigen::Tensor<int32, 0, 1> reduced_tensor = nans_tensor.sum();",
          "57:     const int num_nans = reduced_tensor(0);",
          "58:     if (num_nans > 0) {",
          "59:       return errors::InvalidArgument(\"Histogram values must not contain NaN\");",
          "60:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:     const auto nbins = nbins_tensor.scalar<int32>()();",
          "100:     OP_REQUIRES(",
          "102:         errors::InvalidArgument(\"value_range should satisfy value_range[0] < \"",
          "103:                                 \"value_range[1], but got '[\",",
          "104:                                 value_range(0), \", \", value_range(1), \"]'\"));",
          "105:     OP_REQUIRES(",
          "107:         errors::InvalidArgument(\"nbins should be a positive number, but got '\",",
          "108:                                 nbins, \"'\"));",
          "",
          "[Removed Lines]",
          "101:         ctx, (value_range(0) < value_range(1)),",
          "106:         ctx, (nbins > 0),",
          "",
          "[Added Lines]",
          "110:         ctx, value_range(0) < value_range(1),",
          "115:         ctx, nbins > 0,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4527f8521b948293a21637411959573b664d853b",
      "candidate_info": {
        "commit_hash": "4527f8521b948293a21637411959573b664d853b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/4527f8521b948293a21637411959573b664d853b",
        "files": [
          "tensorflow/core/kernels/histogram_op.cc"
        ],
        "message": "Prevent crash when histogram is called with NaN values.\n\nFixes #45770\n\nPiperOrigin-RevId: 443149951",
        "before_after_code_files": [
          "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc": [
          "File: tensorflow/core/kernels/histogram_op.cc -> tensorflow/core/kernels/histogram_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:                         static_cast<double>(nbins);",
          "51:     const double nbins_minus_1 = static_cast<double>(nbins - 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     const Eigen::Tensor<int32, 1, 1> nans_tensor =",
          "55:         values.isnan().template cast<int32>();",
          "56:     const Eigen::Tensor<int32, 0, 1> reduced_tensor = nans_tensor.sum();",
          "57:     const int num_nans = reduced_tensor(0);",
          "58:     if (num_nans > 0) {",
          "59:       return errors::InvalidArgument(\"Histogram values must not contain NaN\");",
          "60:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:     const auto nbins = nbins_tensor.scalar<int32>()();",
          "100:     OP_REQUIRES(",
          "102:         errors::InvalidArgument(\"value_range should satisfy value_range[0] < \"",
          "103:                                 \"value_range[1], but got '[\",",
          "104:                                 value_range(0), \", \", value_range(1), \"]'\"));",
          "105:     OP_REQUIRES(",
          "107:         errors::InvalidArgument(\"nbins should be a positive number, but got '\",",
          "108:                                 nbins, \"'\"));",
          "",
          "[Removed Lines]",
          "101:         ctx, (value_range(0) < value_range(1)),",
          "106:         ctx, (nbins > 0),",
          "",
          "[Added Lines]",
          "110:         ctx, value_range(0) < value_range(1),",
          "115:         ctx, nbins > 0,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dcfd10abe790eedf6e113b83451399173515b753",
      "candidate_info": {
        "commit_hash": "dcfd10abe790eedf6e113b83451399173515b753",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/dcfd10abe790eedf6e113b83451399173515b753",
        "files": [
          "tensorflow/core/kernels/histogram_op.cc"
        ],
        "message": "Prevent crash when histogram is called with NaN values.\n\nFixes #45770\n\nPiperOrigin-RevId: 443149951",
        "before_after_code_files": [
          "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/histogram_op.cc||tensorflow/core/kernels/histogram_op.cc": [
          "File: tensorflow/core/kernels/histogram_op.cc -> tensorflow/core/kernels/histogram_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:                         static_cast<double>(nbins);",
          "51:     const double nbins_minus_1 = static_cast<double>(nbins - 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     const Eigen::Tensor<int32, 1, 1> nans_tensor =",
          "55:         values.isnan().template cast<int32>();",
          "56:     const Eigen::Tensor<int32, 0, 1> reduced_tensor = nans_tensor.sum();",
          "57:     const int num_nans = reduced_tensor(0);",
          "58:     if (num_nans > 0) {",
          "59:       return errors::InvalidArgument(\"Histogram values must not contain NaN\");",
          "60:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:     const auto nbins = nbins_tensor.scalar<int32>()();",
          "100:     OP_REQUIRES(",
          "102:         errors::InvalidArgument(\"value_range should satisfy value_range[0] < \"",
          "103:                                 \"value_range[1], but got '[\",",
          "104:                                 value_range(0), \", \", value_range(1), \"]'\"));",
          "105:     OP_REQUIRES(",
          "107:         errors::InvalidArgument(\"nbins should be a positive number, but got '\",",
          "108:                                 nbins, \"'\"));",
          "",
          "[Removed Lines]",
          "101:         ctx, (value_range(0) < value_range(1)),",
          "106:         ctx, (nbins > 0),",
          "",
          "[Added Lines]",
          "110:         ctx, value_range(0) < value_range(1),",
          "115:         ctx, nbins > 0,",
          "",
          "---------------"
        ]
      }
    }
  ]
}