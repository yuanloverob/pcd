{
  "cve_id": "CVE-2017-14727",
  "cve_desc": "logger.c in the logger plugin in WeeChat before 1.9.1 allows a crash via strftime date/time specifiers, because a buffer is not initialized.",
  "repo": "weechat/weechat",
  "patch_hash": "f105c6f0b56fb5687b2d2aedf37cb1d1b434d556",
  "patch_info": {
    "commit_hash": "f105c6f0b56fb5687b2d2aedf37cb1d1b434d556",
    "repo": "weechat/weechat",
    "commit_url": "https://github.com/weechat/weechat/commit/f105c6f0b56fb5687b2d2aedf37cb1d1b434d556",
    "files": [
      "ChangeLog.adoc",
      "src/plugins/logger/logger.c"
    ],
    "message": "logger: call strftime before replacing buffer local variables",
    "before_after_code_files": [
      "src/plugins/logger/logger.c||src/plugins/logger/logger.c"
    ]
  },
  "patch_diff": {
    "src/plugins/logger/logger.c||src/plugins/logger/logger.c": [
      "File: src/plugins/logger/logger.c -> src/plugins/logger/logger.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "295: char *",
      "296: logger_get_mask_expanded (struct t_gui_buffer *buffer, const char *mask)",
      "297: {",
      "300:     const char *dir_separator;",
      "301:     int length;",
      "302:     time_t seconds;",
      "303:     struct tm *date_tmp;",
      "305:     mask2 = NULL;",
      "312:     dir_separator = weechat_info_get (\"dir_separator\", \"\");",
      "313:     if (!dir_separator)",
      "314:         return NULL;",
      "323:         goto end;",
      "327:         goto end;",
      "333:         goto end;",
      "335: #ifdef __CYGWIN__",
      "338: #else",
      "342:         goto end;",
      "354:         goto end;",
      "361:     if (weechat_config_boolean (logger_config_file_name_lower_case))",
      "364:     if (weechat_logger_plugin->debug)",
      "365:     {",
      "",
      "[Removed Lines]",
      "298:     char *mask2, *mask_decoded, *mask_decoded2, *mask_decoded3, *mask_decoded4;",
      "299:     char *mask_decoded5;",
      "306:     mask_decoded = NULL;",
      "307:     mask_decoded2 = NULL;",
      "308:     mask_decoded3 = NULL;",
      "309:     mask_decoded4 = NULL;",
      "310:     mask_decoded5 = NULL;",
      "321:     mask2 = weechat_string_replace (mask, dir_separator, \"\\01\");",
      "322:     if (!mask2)",
      "325:     mask_decoded = weechat_buffer_string_replace_local_var (buffer, mask2);",
      "326:     if (!mask_decoded)",
      "329:     mask_decoded2 = weechat_string_replace (mask_decoded,",
      "330:                                             dir_separator,",
      "331:                                             weechat_config_string (logger_config_file_replacement_char));",
      "332:     if (!mask_decoded2)",
      "336:     mask_decoded3 = weechat_string_replace (mask_decoded2, \"\\\\\",",
      "337:                                             weechat_config_string (logger_config_file_replacement_char));",
      "339:     mask_decoded3 = strdup (mask_decoded2);",
      "341:     if (!mask_decoded3)",
      "345:     mask_decoded4 = weechat_string_replace (mask_decoded3,",
      "346:                                             \"\\01\", dir_separator);",
      "347:     if (!mask_decoded4)",
      "348:         goto end;",
      "351:     length = strlen (mask_decoded4) + 256 + 1;",
      "352:     mask_decoded5 = malloc (length);",
      "353:     if (!mask_decoded5)",
      "355:     seconds = time (NULL);",
      "356:     date_tmp = localtime (&seconds);",
      "357:     mask_decoded5[0] = '\\0';",
      "358:     strftime (mask_decoded5, length - 1, mask_decoded4, date_tmp);",
      "362:         weechat_string_tolower (mask_decoded5);",
      "",
      "[Added Lines]",
      "298:     char *mask2, *mask3, *mask4, *mask5, *mask6, *mask7;",
      "305:     mask3 = NULL;",
      "306:     mask4 = NULL;",
      "307:     mask5 = NULL;",
      "308:     mask6 = NULL;",
      "309:     mask7 = NULL;",
      "316:     length = strlen (mask) + 256 + 1;",
      "317:     mask2 = malloc (length);",
      "318:     if (!mask2)",
      "319:         goto end;",
      "320:     seconds = time (NULL);",
      "321:     date_tmp = localtime (&seconds);",
      "322:     mask2[0] = '\\0';",
      "323:     if (strftime (mask2, length - 1, mask, date_tmp) == 0)",
      "324:         mask2[0] = '\\0';",
      "331:     mask3 = weechat_string_replace (mask2, dir_separator, \"\\01\");",
      "332:     if (!mask3)",
      "335:     mask4 = weechat_buffer_string_replace_local_var (buffer, mask3);",
      "336:     if (!mask4)",
      "339:     mask5 = weechat_string_replace (mask4,",
      "340:                                     dir_separator,",
      "341:                                     weechat_config_string (logger_config_file_replacement_char));",
      "342:     if (!mask5)",
      "346:     mask6 = weechat_string_replace (mask5, \"\\\\\",",
      "347:                                     weechat_config_string (logger_config_file_replacement_char));",
      "349:     mask6 = strdup (mask5);",
      "351:     if (!mask6)",
      "355:     mask7 = weechat_string_replace (mask6,",
      "356:                                     \"\\01\", dir_separator);",
      "357:     if (!mask7)",
      "362:         weechat_string_tolower (mask7);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "368:                                   \"decoded mask = \\\"%s\\\"\",",
      "369:                                   LOGGER_PLUGIN_NAME,",
      "370:                                   weechat_buffer_get_string (buffer, \"name\"),",
      "372:     }",
      "374: end:",
      "375:     if (mask2)",
      "376:         free (mask2);",
      "387: }",
      "",
      "[Removed Lines]",
      "371:                                   mask, mask_decoded5);",
      "377:     if (mask_decoded)",
      "378:         free (mask_decoded);",
      "379:     if (mask_decoded2)",
      "380:         free (mask_decoded2);",
      "381:     if (mask_decoded3)",
      "382:         free (mask_decoded3);",
      "383:     if (mask_decoded4)",
      "384:         free (mask_decoded4);",
      "386:     return mask_decoded5;",
      "",
      "[Added Lines]",
      "371:                                   mask, mask7);",
      "377:     if (mask3)",
      "378:         free (mask3);",
      "379:     if (mask4)",
      "380:         free (mask4);",
      "381:     if (mask5)",
      "382:         free (mask5);",
      "383:     if (mask6)",
      "384:         free (mask6);",
      "386:     return mask7;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e4cc90f4b43153dc1c6516c1f1aad2504faa5443",
      "candidate_info": {
        "commit_hash": "e4cc90f4b43153dc1c6516c1f1aad2504faa5443",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/e4cc90f4b43153dc1c6516c1f1aad2504faa5443",
        "files": [
          "src/plugins/logger/logger.c"
        ],
        "message": "logger: call strftime before replacing buffer local variables",
        "before_after_code_files": [
          "src/plugins/logger/logger.c||src/plugins/logger/logger.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/plugins/logger/logger.c||src/plugins/logger/logger.c"
          ],
          "candidate": [
            "src/plugins/logger/logger.c||src/plugins/logger/logger.c"
          ]
        }
      },
      "candidate_diff": {
        "src/plugins/logger/logger.c||src/plugins/logger/logger.c": [
          "File: src/plugins/logger/logger.c -> src/plugins/logger/logger.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "295: char *",
          "296: logger_get_mask_expanded (struct t_gui_buffer *buffer, const char *mask)",
          "297: {",
          "300:     const char *dir_separator;",
          "301:     int length;",
          "302:     time_t seconds;",
          "303:     struct tm *date_tmp;",
          "305:     mask2 = NULL;",
          "312:     dir_separator = weechat_info_get (\"dir_separator\", \"\");",
          "313:     if (!dir_separator)",
          "314:         return NULL;",
          "323:         goto end;",
          "327:         goto end;",
          "333:         goto end;",
          "335: #ifdef __CYGWIN__",
          "338: #else",
          "342:         goto end;",
          "354:         goto end;",
          "361:     if (weechat_config_boolean (logger_config_file_name_lower_case))",
          "364:     if (weechat_logger_plugin->debug)",
          "365:     {",
          "",
          "[Removed Lines]",
          "298:     char *mask2, *mask_decoded, *mask_decoded2, *mask_decoded3, *mask_decoded4;",
          "299:     char *mask_decoded5;",
          "306:     mask_decoded = NULL;",
          "307:     mask_decoded2 = NULL;",
          "308:     mask_decoded3 = NULL;",
          "309:     mask_decoded4 = NULL;",
          "310:     mask_decoded5 = NULL;",
          "321:     mask2 = weechat_string_replace (mask, dir_separator, \"\\01\");",
          "322:     if (!mask2)",
          "325:     mask_decoded = weechat_buffer_string_replace_local_var (buffer, mask2);",
          "326:     if (!mask_decoded)",
          "329:     mask_decoded2 = weechat_string_replace (mask_decoded,",
          "330:                                             dir_separator,",
          "331:                                             weechat_config_string (logger_config_file_replacement_char));",
          "332:     if (!mask_decoded2)",
          "336:     mask_decoded3 = weechat_string_replace (mask_decoded2, \"\\\\\",",
          "337:                                             weechat_config_string (logger_config_file_replacement_char));",
          "339:     mask_decoded3 = strdup (mask_decoded2);",
          "341:     if (!mask_decoded3)",
          "345:     mask_decoded4 = weechat_string_replace (mask_decoded3,",
          "346:                                             \"\\01\", dir_separator);",
          "347:     if (!mask_decoded4)",
          "348:         goto end;",
          "351:     length = strlen (mask_decoded4) + 256 + 1;",
          "352:     mask_decoded5 = malloc (length);",
          "353:     if (!mask_decoded5)",
          "355:     seconds = time (NULL);",
          "356:     date_tmp = localtime (&seconds);",
          "357:     mask_decoded5[0] = '\\0';",
          "358:     strftime (mask_decoded5, length - 1, mask_decoded4, date_tmp);",
          "362:         weechat_string_tolower (mask_decoded5);",
          "",
          "[Added Lines]",
          "298:     char *mask2, *mask3, *mask4, *mask5, *mask6, *mask7;",
          "305:     mask3 = NULL;",
          "306:     mask4 = NULL;",
          "307:     mask5 = NULL;",
          "308:     mask6 = NULL;",
          "309:     mask7 = NULL;",
          "316:     length = strlen (mask) + 256 + 1;",
          "317:     mask2 = malloc (length);",
          "318:     if (!mask2)",
          "319:         goto end;",
          "320:     seconds = time (NULL);",
          "321:     date_tmp = localtime (&seconds);",
          "322:     mask2[0] = '\\0';",
          "323:     if (strftime (mask2, length - 1, mask, date_tmp) == 0)",
          "324:         mask2[0] = '\\0';",
          "331:     mask3 = weechat_string_replace (mask2, dir_separator, \"\\01\");",
          "332:     if (!mask3)",
          "335:     mask4 = weechat_buffer_string_replace_local_var (buffer, mask3);",
          "336:     if (!mask4)",
          "339:     mask5 = weechat_string_replace (mask4,",
          "340:                                     dir_separator,",
          "341:                                     weechat_config_string (logger_config_file_replacement_char));",
          "342:     if (!mask5)",
          "346:     mask6 = weechat_string_replace (mask5, \"\\\\\",",
          "347:                                     weechat_config_string (logger_config_file_replacement_char));",
          "349:     mask6 = strdup (mask5);",
          "351:     if (!mask6)",
          "355:     mask7 = weechat_string_replace (mask6,",
          "356:                                     \"\\01\", dir_separator);",
          "357:     if (!mask7)",
          "362:         weechat_string_tolower (mask7);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "368:                                   \"decoded mask = \\\"%s\\\"\",",
          "369:                                   LOGGER_PLUGIN_NAME,",
          "370:                                   weechat_buffer_get_string (buffer, \"name\"),",
          "372:     }",
          "374: end:",
          "375:     if (mask2)",
          "376:         free (mask2);",
          "387: }",
          "",
          "[Removed Lines]",
          "371:                                   mask, mask_decoded5);",
          "377:     if (mask_decoded)",
          "378:         free (mask_decoded);",
          "379:     if (mask_decoded2)",
          "380:         free (mask_decoded2);",
          "381:     if (mask_decoded3)",
          "382:         free (mask_decoded3);",
          "383:     if (mask_decoded4)",
          "384:         free (mask_decoded4);",
          "386:     return mask_decoded5;",
          "",
          "[Added Lines]",
          "371:                                   mask, mask7);",
          "377:     if (mask3)",
          "378:         free (mask3);",
          "379:     if (mask4)",
          "380:         free (mask4);",
          "381:     if (mask5)",
          "382:         free (mask5);",
          "383:     if (mask6)",
          "384:         free (mask6);",
          "386:     return mask7;",
          "",
          "---------------"
        ]
      }
    }
  ]
}