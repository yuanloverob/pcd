{
  "cve_id": "CVE-2014-2571",
  "cve_desc": "Cross-site scripting (XSS) vulnerability in the quiz_question_tostring function in mod/quiz/editlib.php in Moodle through 2.3.11, 2.4.x before 2.4.9, 2.5.x before 2.5.5, and 2.6.x before 2.6.2 allows remote authenticated users to inject arbitrary web script or HTML via a quiz question.",
  "repo": "moodle/moodle",
  "patch_hash": "7051f3a8828665f4fab37c8db91322fec85a64db",
  "patch_info": {
    "commit_hash": "7051f3a8828665f4fab37c8db91322fec85a64db",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/7051f3a8828665f4fab37c8db91322fec85a64db",
    "files": [
      "mod/quiz/editlib.php",
      "mod/quiz/tests/editlib_test.php"
    ],
    "message": "MDL-43690 quiz_question_tostring missing s().\n\nThis meant that the edit quiz page sometimes had invalid HTML.",
    "before_after_code_files": [
      "mod/quiz/editlib.php||mod/quiz/editlib.php",
      "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
    ]
  },
  "patch_diff": {
    "mod/quiz/editlib.php||mod/quiz/editlib.php": [
      "File: mod/quiz/editlib.php -> mod/quiz/editlib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1018:         $questiontext = shorten_text($questiontext, 200);",
      "1019:         $result .= '<span class=\"questiontext\">';",
      "1020:         if (!empty($questiontext)) {",
      "1022:         } else {",
      "1023:             $result .= '<span class=\"error\">';",
      "1024:             $result .= get_string('questiontextisempty', 'quiz');",
      "",
      "[Removed Lines]",
      "1021:             $result .= $questiontext;",
      "",
      "[Added Lines]",
      "1021:             $result .= s($questiontext);",
      "",
      "---------------"
    ],
    "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php": [
      "File: mod/quiz/tests/editlib_test.php -> mod/quiz/tests/editlib_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "82:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 2), '1,2,0,0');",
      "83:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 3), '1,2,0');",
      "84:     }",
      "85: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "86:     public function test_quiz_question_tostring() {",
      "87:         $question = new stdClass();",
      "88:         $question->qtype = 'multichoice';",
      "89:         $question->name = 'The question name';",
      "90:         $question->questiontext = '<p>What sort of <b>inequality</b> is x &lt; y<img alt=\"?\" src=\"...\"></p>';",
      "91:         $question->questiontextformat = FORMAT_HTML;",
      "93:         $summary = quiz_question_tostring($question);",
      "94:         $this->assertEquals('<span class=\"questionname\">The question name</span>' .",
      "95:                 '<span class=\"questiontext\">What sort of INEQUALITY is x &lt; y[?]</span>', $summary);",
      "96:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fd4b7f57399bed85db0d4066ba12c2633ce87ba3",
      "candidate_info": {
        "commit_hash": "fd4b7f57399bed85db0d4066ba12c2633ce87ba3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/fd4b7f57399bed85db0d4066ba12c2633ce87ba3",
        "files": [
          "mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php"
        ],
        "message": "MDL-43690 quiz_question_tostring missing s().\n\nThis meant that the edit quiz page sometimes had invalid HTML.",
        "before_after_code_files": [
          "mod/quiz/editlib.php||mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ],
          "candidate": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/quiz/editlib.php||mod/quiz/editlib.php": [
          "File: mod/quiz/editlib.php -> mod/quiz/editlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018:         $questiontext = shorten_text($questiontext, 200);",
          "1019:         $result .= '<span class=\"questiontext\">';",
          "1020:         if (!empty($questiontext)) {",
          "1022:         } else {",
          "1023:             $result .= '<span class=\"error\">';",
          "1024:             $result .= get_string('questiontextisempty', 'quiz');",
          "",
          "[Removed Lines]",
          "1021:             $result .= $questiontext;",
          "",
          "[Added Lines]",
          "1021:             $result .= s($questiontext);",
          "",
          "---------------"
        ],
        "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php": [
          "File: mod/quiz/tests/editlib_test.php -> mod/quiz/tests/editlib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 2), '1,2,0,0');",
          "83:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 3), '1,2,0');",
          "84:     }",
          "85: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:     public function test_quiz_question_tostring() {",
          "87:         $question = new stdClass();",
          "88:         $question->qtype = 'multichoice';",
          "89:         $question->name = 'The question name';",
          "90:         $question->questiontext = '<p>What sort of <b>inequality</b> is x &lt; y<img alt=\"?\" src=\"...\"></p>';",
          "91:         $question->questiontextformat = FORMAT_HTML;",
          "93:         $summary = quiz_question_tostring($question);",
          "94:         $this->assertEquals('<span class=\"questionname\">The question name</span>' .",
          "95:                 '<span class=\"questiontext\">What sort of INEQUALITY is x &lt; y[?]</span>', $summary);",
          "96:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "217d839ded7026ed1b1280e1c296bc80a4036023",
      "candidate_info": {
        "commit_hash": "217d839ded7026ed1b1280e1c296bc80a4036023",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/217d839ded7026ed1b1280e1c296bc80a4036023",
        "files": [
          "mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php"
        ],
        "message": "MDL-43690 quiz_question_tostring missing s().\n\nThis meant that the edit quiz page sometimes had invalid HTML.",
        "before_after_code_files": [
          "mod/quiz/editlib.php||mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ],
          "candidate": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/quiz/editlib.php||mod/quiz/editlib.php": [
          "File: mod/quiz/editlib.php -> mod/quiz/editlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018:         $questiontext = shorten_text($questiontext, 200);",
          "1019:         $result .= '<span class=\"questiontext\">';",
          "1020:         if (!empty($questiontext)) {",
          "1022:         } else {",
          "1023:             $result .= '<span class=\"error\">';",
          "1024:             $result .= get_string('questiontextisempty', 'quiz');",
          "",
          "[Removed Lines]",
          "1021:             $result .= $questiontext;",
          "",
          "[Added Lines]",
          "1021:             $result .= s($questiontext);",
          "",
          "---------------"
        ],
        "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php": [
          "File: mod/quiz/tests/editlib_test.php -> mod/quiz/tests/editlib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 2), '1,2,0,0');",
          "83:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 3), '1,2,0');",
          "84:     }",
          "85: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:     public function test_quiz_question_tostring() {",
          "87:         $question = new stdClass();",
          "88:         $question->qtype = 'multichoice';",
          "89:         $question->name = 'The question name';",
          "90:         $question->questiontext = '<p>What sort of <b>inequality</b> is x &lt; y<img alt=\"?\" src=\"...\"></p>';",
          "91:         $question->questiontextformat = FORMAT_HTML;",
          "93:         $summary = quiz_question_tostring($question);",
          "94:         $this->assertEquals('<span class=\"questionname\">The question name</span>' .",
          "95:                 '<span class=\"questiontext\">What sort of INEQUALITY is x &lt; y[?]</span>', $summary);",
          "96:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5da73345fdd46cef912b229b2cfae2a26e36efd8",
      "candidate_info": {
        "commit_hash": "5da73345fdd46cef912b229b2cfae2a26e36efd8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5da73345fdd46cef912b229b2cfae2a26e36efd8",
        "files": [
          "mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php"
        ],
        "message": "MDL-43690 quiz_question_tostring missing s().\n\nThis meant that the edit quiz page sometimes had invalid HTML.",
        "before_after_code_files": [
          "mod/quiz/editlib.php||mod/quiz/editlib.php",
          "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ],
          "candidate": [
            "mod/quiz/editlib.php||mod/quiz/editlib.php",
            "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/quiz/editlib.php||mod/quiz/editlib.php": [
          "File: mod/quiz/editlib.php -> mod/quiz/editlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018:         $questiontext = shorten_text($questiontext, 200);",
          "1019:         $result .= '<span class=\"questiontext\">';",
          "1020:         if (!empty($questiontext)) {",
          "1022:         } else {",
          "1023:             $result .= '<span class=\"error\">';",
          "1024:             $result .= get_string('questiontextisempty', 'quiz');",
          "",
          "[Removed Lines]",
          "1021:             $result .= $questiontext;",
          "",
          "[Added Lines]",
          "1021:             $result .= s($questiontext);",
          "",
          "---------------"
        ],
        "mod/quiz/tests/editlib_test.php||mod/quiz/tests/editlib_test.php": [
          "File: mod/quiz/tests/editlib_test.php -> mod/quiz/tests/editlib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 2), '1,2,0,0');",
          "83:         $this->assertEquals(quiz_add_page_break_at('1,2,0', 3), '1,2,0');",
          "84:     }",
          "85: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:     public function test_quiz_question_tostring() {",
          "87:         $question = new stdClass();",
          "88:         $question->qtype = 'multichoice';",
          "89:         $question->name = 'The question name';",
          "90:         $question->questiontext = '<p>What sort of <b>inequality</b> is x &lt; y<img alt=\"?\" src=\"...\"></p>';",
          "91:         $question->questiontextformat = FORMAT_HTML;",
          "93:         $summary = quiz_question_tostring($question);",
          "94:         $this->assertEquals('<span class=\"questionname\">The question name</span>' .",
          "95:                 '<span class=\"questiontext\">What sort of INEQUALITY is x &lt; y[?]</span>', $summary);",
          "96:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}