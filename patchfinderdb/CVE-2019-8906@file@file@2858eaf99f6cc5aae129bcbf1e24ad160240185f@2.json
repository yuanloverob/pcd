{
  "cve_id": "CVE-2019-8906",
  "cve_desc": "do_core_note in readelf.c in libmagic.a in file 5.35 has an out-of-bounds read because memcpy is misused.",
  "repo": "file/file",
  "patch_hash": "2858eaf99f6cc5aae129bcbf1e24ad160240185f",
  "patch_info": {
    "commit_hash": "2858eaf99f6cc5aae129bcbf1e24ad160240185f",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/2858eaf99f6cc5aae129bcbf1e24ad160240185f",
    "files": [
      "src/readelf.c"
    ],
    "message": "Avoid OOB read (found by ASAN reported by F. Alonso)",
    "before_after_code_files": [
      "src/readelf.c||src/readelf.c"
    ]
  },
  "patch_diff": {
    "src/readelf.c||src/readelf.c": [
      "File: src/readelf.c -> src/readelf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: #include \"file.h\"",
      "29: #ifndef lint",
      "31: #endif",
      "33: #ifdef BUILTIN_ELF",
      "",
      "[Removed Lines]",
      "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.156 2018/10/19 00:33:04 christos Exp $\")",
      "",
      "[Added Lines]",
      "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.157 2019/01/02 19:44:14 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "752:    char sbuf[512];",
      "753:    struct NetBSD_elfcore_procinfo pi;",
      "754:    memset(&pi, 0, sizeof(pi));",
      "757:    if (file_printf(ms, \", from '%.31s', pid=%u, uid=%u, \"",
      "758:        \"gid=%u, nlwps=%u, lwp=%u (signal %u/code %u)\",",
      "",
      "[Removed Lines]",
      "755:    memcpy(&pi, nbuf + doff, descsz);",
      "",
      "[Added Lines]",
      "755:    memcpy(&pi, nbuf + doff, MIN(descsz, sizeof(pi)));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7af5106e1f94b17ae5635f6a5035210bc6e4491f",
      "candidate_info": {
        "commit_hash": "7af5106e1f94b17ae5635f6a5035210bc6e4491f",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/7af5106e1f94b17ae5635f6a5035210bc6e4491f",
        "files": [
          "src/readelf.c"
        ],
        "message": "check against -1 to appease coverity.",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.146 2018/07/27 07:50:14 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.147 2018/08/01 09:56:24 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1716:      && (errno == ESPIPE))",
          "1717:   fd = file_pipe2file(ms, fd, buf, nbytes);",
          "1720:     file_badread(ms);",
          "1721:   return -1;",
          "1722:  }",
          "",
          "[Removed Lines]",
          "1719:  if (fstat(fd, &st) == -1) {",
          "",
          "[Added Lines]",
          "1719:  if (fd == -1 || fstat(fd, &st) == -1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9233f23b8ec804828e359e9184d98bef8d311550",
      "candidate_info": {
        "commit_hash": "9233f23b8ec804828e359e9184d98bef8d311550",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/9233f23b8ec804828e359e9184d98bef8d311550",
        "files": [
          "src/readelf.c"
        ],
        "message": "implement NetBSD emulation (obsolete)",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.140 2017/11/02 20:25:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.141 2018/04/12 16:50:52 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "310:  \"NetBSD\",",
          "311: };",
          "326: private int",
          "327: dophn_core(struct magic_set *ms, int clazz, int swap, int fd, off_t off,",
          "",
          "[Removed Lines]",
          "313: #define FLAGS_CORE_STYLE  0x003",
          "315: #define FLAGS_DID_CORE   0x004",
          "316: #define FLAGS_DID_OS_NOTE  0x008",
          "317: #define FLAGS_DID_BUILD_ID  0x010",
          "318: #define FLAGS_DID_CORE_STYLE  0x020",
          "319: #define FLAGS_DID_NETBSD_PAX  0x040",
          "320: #define FLAGS_DID_NETBSD_MARCH  0x080",
          "321: #define FLAGS_DID_NETBSD_CMODEL  0x100",
          "322: #define FLAGS_DID_NETBSD_UNKNOWN 0x200",
          "323: #define FLAGS_IS_CORE   0x400",
          "324: #define FLAGS_DID_AUXV   0x800",
          "",
          "[Added Lines]",
          "313: #define FLAGS_CORE_STYLE  0x0003",
          "315: #define FLAGS_DID_CORE   0x0004",
          "316: #define FLAGS_DID_OS_NOTE  0x0008",
          "317: #define FLAGS_DID_BUILD_ID  0x0010",
          "318: #define FLAGS_DID_CORE_STYLE  0x0020",
          "319: #define FLAGS_DID_NETBSD_PAX  0x0040",
          "320: #define FLAGS_DID_NETBSD_MARCH  0x0080",
          "321: #define FLAGS_DID_NETBSD_CMODEL  0x0100",
          "322: #define FLAGS_DID_NETBSD_EMULATION 0x0200",
          "323: #define FLAGS_DID_NETBSD_UNKNOWN 0x0400",
          "324: #define FLAGS_IS_CORE   0x0800",
          "325: #define FLAGS_DID_AUXV   0x1000",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1135:        (int)descsz, (const char *)&nbuf[doff]) == -1)",
          "1136:     return offset;",
          "1137:    break;",
          "1138:   default:",
          "1139:    if (*flags & FLAGS_DID_NETBSD_UNKNOWN)",
          "1140:     return offset;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1139:   case NT_NETBSD_EMULATION:",
          "1140:    if (*flags & FLAGS_DID_NETBSD_EMULATION)",
          "1141:     return offset;",
          "1143:    if (file_printf(ms, \", emulation: %.*s\",",
          "1144:        (int)descsz, (const char *)&nbuf[doff]) == -1)",
          "1145:     return offset;",
          "1146:    break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9c3137904e59d68debb97fceaced46a691ba241a",
      "candidate_info": {
        "commit_hash": "9c3137904e59d68debb97fceaced46a691ba241a",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/9c3137904e59d68debb97fceaced46a691ba241a",
        "files": [
          "src/readelf.c"
        ],
        "message": "Since this is an elf file and we produced some information for it, return 1 instead of 0. Reported by Kamil Dudka",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.145 2018/07/25 06:12:09 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.146 2018/07/27 07:50:14 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "69: {",
          "70:  if (file_printf(ms, \", too many %s (%u)\", name, num) == -1)",
          "71:   return -1;",
          "73: }",
          "75: private uint16_t",
          "",
          "[Removed Lines]",
          "72:  return 0;",
          "",
          "[Added Lines]",
          "72:  return 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "24c9c086cd7c55b7b0a003a145b32466468e2608",
      "candidate_info": {
        "commit_hash": "24c9c086cd7c55b7b0a003a145b32466468e2608",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/24c9c086cd7c55b7b0a003a145b32466468e2608",
        "files": [
          "src/readelf.c"
        ],
        "message": "PR/93: iaeiaeiaeiae: Do as the comment says, and count as dynamically linked only the binaries that have an interpreter, not the ones that contain a dynamic section. Fixes issue with -static-pie from gcc-9.x",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.165 2019/05/07 02:27:11 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.166 2019/07/23 21:33:45 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1629:   switch (xph_type) {",
          "1630:   case PT_DYNAMIC:",
          "1632:    doread = 1;",
          "1633:    break;",
          "1634:   case PT_NOTE:",
          "",
          "[Removed Lines]",
          "1631:    linking_style = \"dynamically\";",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1644:    }",
          "1646:   case PT_INTERP:",
          "1647:    doread = 1;",
          "1648:    break;",
          "1649:   default:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1646:    linking_style = \"dynamically\";",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "813f1b8a37bc1384b33d6598ec5bad0c8e754caf",
      "candidate_info": {
        "commit_hash": "813f1b8a37bc1384b33d6598ec5bad0c8e754caf",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/813f1b8a37bc1384b33d6598ec5bad0c8e754caf",
        "files": [
          "src/readelf.c"
        ],
        "message": "correct error handling for file_printf() (coverity)",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.149 2018/08/01 10:09:47 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.150 2018/08/02 12:46:02 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "565:      type == NT_GO_BUILD_ID && descsz < 128) {",
          "566:   if (file_printf(ms, \", Go BuildID=%s\",",
          "567:       (char *)&nbuf[doff]) == -1)",
          "569:   return 1;",
          "570:  }",
          "571:  return 0;",
          "",
          "[Removed Lines]",
          "568:    return 1;",
          "",
          "[Added Lines]",
          "568:    return -1;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1118:  }",
          "1120:  if (namesz & 0x80000000) {",
          "1123:      return 0;",
          "1124:  }",
          "1126:  if (descsz & 0x80000000) {",
          "1129:      return 0;",
          "1130:  }",
          "",
          "[Removed Lines]",
          "1121:      file_printf(ms, \", bad note name size %#lx\",",
          "1122:   CAST(unsigned long, namesz));",
          "1127:      file_printf(ms, \", bad note description size %#lx\",",
          "1128:   CAST(unsigned long, descsz));",
          "",
          "[Added Lines]",
          "1121:   if (((file_printf(ms, \", bad note name size %#lx\",",
          "1122:       CAST(unsigned long, namesz)) == -1)",
          "1123:    return -1;",
          "1128:   if (file_printf(ms, \", bad note description size %#lx\",",
          "1129:       CAST(unsigned long, descsz)) == -1)",
          "1130:        return -1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}