{
  "cve_id": "CVE-2020-14416",
  "cve_desc": "In the Linux kernel before 5.4.16, a race condition in tty->disc_data handling in the slip and slcan line discipline could lead to a use-after-free, aka CID-0ace17d56824. This affects drivers/net/slip/slip.c and drivers/net/can/slcan.c.",
  "repo": "torvalds/linux",
  "patch_hash": "0ace17d56824165c7f4c68785d6b58971db954dd",
  "patch_info": {
    "commit_hash": "0ace17d56824165c7f4c68785d6b58971db954dd",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/0ace17d56824165c7f4c68785d6b58971db954dd",
    "files": [
      "drivers/net/can/slcan.c",
      "drivers/net/slip/slip.c"
    ],
    "message": "can, slip: Protect tty->disc_data in write_wakeup and close with RCU\n\nwrite_wakeup can happen in parallel with close/hangup where tty->disc_data\nis set to NULL and the netdevice is freed thus also freeing\ndisc_data. write_wakeup accesses disc_data so we must prevent close from\nfreeing the netdev while write_wakeup has a non-NULL view of\ntty->disc_data.\n\nWe also need to make sure that accesses to disc_data are atomic. Which can\nall be done with RCU.\n\nThis problem was found by Syzkaller on SLCAN, but the same issue is\nreproducible with the SLIP line discipline using an LTP test based on the\nSyzkaller reproducer.\n\nA fix which didn't use RCU was posted by Hillf Danton.\n\nFixes: 661f7fda21b1 (\"slip: Fix deadlock in write_wakeup\")\nFixes: a8e83b17536a (\"slcan: Port write_wakeup deadlock fix from slip\")\nReported-by: syzbot+017e491ae13c0068598a@syzkaller.appspotmail.com\nSigned-off-by: Richard Palethorpe <rpalethorpe@suse.com>\nCc: Wolfgang Grandegger <wg@grandegger.com>\nCc: Marc Kleine-Budde <mkl@pengutronix.de>\nCc: \"David S. Miller\" <davem@davemloft.net>\nCc: Tyler Hall <tylerwhall@gmail.com>\nCc: linux-can@vger.kernel.org\nCc: netdev@vger.kernel.org\nCc: linux-kernel@vger.kernel.org\nCc: syzkaller@googlegroups.com\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "drivers/net/can/slcan.c||drivers/net/can/slcan.c",
      "drivers/net/slip/slip.c||drivers/net/slip/slip.c"
    ]
  },
  "patch_diff": {
    "drivers/net/can/slcan.c||drivers/net/can/slcan.c": [
      "File: drivers/net/can/slcan.c -> drivers/net/can/slcan.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "345: static void slcan_write_wakeup(struct tty_struct *tty)",
      "346: {",
      "349:  schedule_work(&sl->tx_work);",
      "350: }",
      "",
      "[Removed Lines]",
      "347:  struct slcan *sl = tty->disc_data;",
      "",
      "[Added Lines]",
      "347:  struct slcan *sl;",
      "349:  rcu_read_lock();",
      "350:  sl = rcu_dereference(tty->disc_data);",
      "351:  if (!sl)",
      "352:   goto out;",
      "355: out:",
      "356:  rcu_read_unlock();",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "644:   return;",
      "646:  spin_lock_bh(&sl->lock);",
      "648:  sl->tty = NULL;",
      "649:  spin_unlock_bh(&sl->lock);",
      "651:  flush_work(&sl->tx_work);",
      "",
      "[Removed Lines]",
      "647:  tty->disc_data = NULL;",
      "",
      "[Added Lines]",
      "654:  rcu_assign_pointer(tty->disc_data, NULL);",
      "658:  synchronize_rcu();",
      "",
      "---------------"
    ],
    "drivers/net/slip/slip.c||drivers/net/slip/slip.c": [
      "File: drivers/net/slip/slip.c -> drivers/net/slip/slip.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "453: static void slip_write_wakeup(struct tty_struct *tty)",
      "454: {",
      "457:  schedule_work(&sl->tx_work);",
      "458: }",
      "460: static void sl_tx_timeout(struct net_device *dev)",
      "",
      "[Removed Lines]",
      "455:  struct slip *sl = tty->disc_data;",
      "",
      "[Added Lines]",
      "455:  struct slip *sl;",
      "457:  rcu_read_lock();",
      "458:  sl = rcu_dereference(tty->disc_data);",
      "459:  if (!sl)",
      "460:   goto out;",
      "463: out:",
      "464:  rcu_read_unlock();",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "882:   return;",
      "884:  spin_lock_bh(&sl->lock);",
      "886:  sl->tty = NULL;",
      "887:  spin_unlock_bh(&sl->lock);",
      "889:  flush_work(&sl->tx_work);",
      "",
      "[Removed Lines]",
      "885:  tty->disc_data = NULL;",
      "",
      "[Added Lines]",
      "892:  rcu_assign_pointer(tty->disc_data, NULL);",
      "896:  synchronize_rcu();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dacf470b26418e91bef195342b25a234c94052e3",
      "candidate_info": {
        "commit_hash": "dacf470b26418e91bef195342b25a234c94052e3",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/dacf470b26418e91bef195342b25a234c94052e3",
        "files": [
          "drivers/net/can/slcan.c",
          "drivers/net/slip/slip.c"
        ],
        "message": "net: slcan, slip -- no need for goto when if () will do\n\nNo need to play with gotos to jump over single statement.\n\nSigned-off-by: Pavel Machek <pavel@ucw.cz>\nAcked-by: Oliver Hartkopp <socketcan@hartkopp.net>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/can/slcan.c||drivers/net/can/slcan.c",
          "drivers/net/slip/slip.c||drivers/net/slip/slip.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/can/slcan.c||drivers/net/can/slcan.c",
            "drivers/net/slip/slip.c||drivers/net/slip/slip.c"
          ],
          "candidate": [
            "drivers/net/can/slcan.c||drivers/net/can/slcan.c",
            "drivers/net/slip/slip.c||drivers/net/slip/slip.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/can/slcan.c||drivers/net/can/slcan.c": [
          "File: drivers/net/can/slcan.c -> drivers/net/can/slcan.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "349:  rcu_read_lock();",
          "350:  sl = rcu_dereference(tty->disc_data);",
          "356:  rcu_read_unlock();",
          "357: }",
          "",
          "[Removed Lines]",
          "351:  if (!sl)",
          "352:   goto out;",
          "354:  schedule_work(&sl->tx_work);",
          "355: out:",
          "",
          "[Added Lines]",
          "351:  if (sl)",
          "352:   schedule_work(&sl->tx_work);",
          "",
          "---------------"
        ],
        "drivers/net/slip/slip.c||drivers/net/slip/slip.c": [
          "File: drivers/net/slip/slip.c -> drivers/net/slip/slip.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "457:  rcu_read_lock();",
          "458:  sl = rcu_dereference(tty->disc_data);",
          "464:  rcu_read_unlock();",
          "465: }",
          "",
          "[Removed Lines]",
          "459:  if (!sl)",
          "460:   goto out;",
          "462:  schedule_work(&sl->tx_work);",
          "463: out:",
          "",
          "[Added Lines]",
          "459:  if (sl)",
          "460:   schedule_work(&sl->tx_work);",
          "",
          "---------------"
        ]
      }
    }
  ]
}