{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "85cd24b5626e295e702ebc508eba63ac4727a6c5",
      "candidate_info": {
        "commit_hash": "85cd24b5626e295e702ebc508eba63ac4727a6c5",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/85cd24b5626e295e702ebc508eba63ac4727a6c5",
        "files": [
          "bindings/python/BUILDING.txt",
          "bindings/python/MANIFEST.in",
          "bindings/python/PKG-INFO.src",
          "bindings/python/PKG-INFO.win",
          "bindings/python/README.TXT",
          "bindings/python/README.pypi-src",
          "bindings/python/README.pypi-win",
          "bindings/python/README.txt",
          "bindings/python/prebuilt/win32/.gitignore",
          "bindings/python/prebuilt/win64/.gitignore",
          "bindings/python/setup.py"
        ],
        "message": "Python: Clean up the capstone-windows stuff with extreme prejudice",
        "before_after_code_files": [
          "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in",
          "bindings/python/PKG-INFO.src||bindings/python/PKG-INFO.src",
          "bindings/python/PKG-INFO.win||bindings/python/PKG-INFO.win",
          "bindings/python/README.pypi-src||bindings/python/README.pypi-src",
          "bindings/python/setup.py||bindings/python/setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in": [
          "File: bindings/python/MANIFEST.in -> bindings/python/MANIFEST.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: recursive-include src *",
          "2: include LICENSE.TXT",
          "",
          "[Removed Lines]",
          "3: include README",
          "",
          "[Added Lines]",
          "3: include README.txt",
          "4: include BUILDING.txt",
          "5: include Makefile",
          "",
          "---------------"
        ],
        "bindings/python/PKG-INFO.src||bindings/python/PKG-INFO.src": [
          "File: bindings/python/PKG-INFO.src -> bindings/python/PKG-INFO.src",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/PKG-INFO.win||bindings/python/PKG-INFO.win": [
          "File: bindings/python/PKG-INFO.win -> bindings/python/PKG-INFO.win",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/README.pypi-src||bindings/python/README.pypi-src": [
          "File: bindings/python/README.pypi-src -> bindings/python/README.pypi-src",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:     print \"Proper 'develop' support unavailable.\"",
          "158: if 'bdist_wheel' in sys.argv and '--plat-name' not in sys.argv:",
          "160:     name = get_platform()",
          "161:     if 'linux' in name:",
          "162:         # linux_* platform tags are disallowed because the python ecosystem is fubar",
          "163:         # linux builds should be built in the centos 5 vm for maximum compatibility",
          "164:         # see https://github.com/pypa/manylinux",
          "165:         # see also https://github.com/angr/angr-dev/blob/master/bdist.sh",
          "167:     else:",
          "168:         # https://www.python.org/dev/peps/pep-0425/",
          "171: setup(",
          "172:     provides=['capstone'],",
          "",
          "[Removed Lines]",
          "159:     sys.argv.append('--plat-name')",
          "166:         sys.argv.append('manylinux1_' + platform.machine())",
          "169:         sys.argv.append(name.replace('.', '_').replace('-', '_'))",
          "",
          "[Added Lines]",
          "159:     idx = sys.argv.index('bdist_wheel') + 1",
          "160:     sys.argv.insert(idx, '--plat-name')",
          "167:         sys.argv.insert(idx + 1, 'manylinux1_' + platform.machine())",
          "170:         sys.argv.insert(idx + 1, name.replace('.', '_').replace('-', '_'))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
      "candidate_info": {
        "commit_hash": "7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
        "files": [
          "bindings/java/TestX86.java",
          "bindings/java/capstone/X86.java",
          "bindings/java/capstone/X86_const.java",
          "bindings/ocaml/ocaml.c",
          "bindings/ocaml/test_x86.ml",
          "bindings/ocaml/x86.ml",
          "bindings/ocaml/x86_const.ml",
          "bindings/python/capstone/x86.py",
          "bindings/python/capstone/x86_const.py",
          "bindings/python/test_x86.py"
        ],
        "message": "binding: remove cx_x86_op::fp following the change in the core",
        "before_after_code_files": [
          "bindings/javTestX86.java||bindings/java/TestX86.java",
          "bindings/javcapstone/X86.java||bindings/java/capstone/X86.java",
          "bindings/javcapstone/X86_const.java||bindings/java/capstone/X86_const.java",
          "bindings/ocaml/ocaml.c||bindings/ocaml/ocaml.c",
          "bindings/ocaml/test_x86.ml||bindings/ocaml/test_x86.ml",
          "bindings/ocaml/x86.ml||bindings/ocaml/x86.ml",
          "bindings/ocaml/x86_const.ml||bindings/ocaml/x86_const.ml",
          "bindings/python/capstone/x86.py||bindings/python/capstone/x86.py",
          "bindings/python/capstone/x86_const.py||bindings/python/capstone/x86_const.py",
          "bindings/python/test_x86.py||bindings/python/test_x86.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javTestX86.java||bindings/java/TestX86.java": [
          "File: bindings/javTestX86.java -> bindings/java/TestX86.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/javcapstone/X86.java||bindings/java/capstone/X86.java": [
          "File: bindings/javcapstone/X86.java -> bindings/java/capstone/X86.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36:       return Arrays.asList(\"reg\", \"imm\", \"mem\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/javcapstone/X86_const.java||bindings/java/capstone/X86_const.java": [
          "File: bindings/javcapstone/X86_const.java -> bindings/java/capstone/X86_const.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/ocaml.c||bindings/ocaml/ocaml.c": [
          "File: bindings/ocaml/ocaml.c -> bindings/ocaml/ocaml.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:           tmp = caml_alloc(5, 2);",
          "377:           Store_field(tmp, 0, Val_int(insn[j-1].detail->x86.operands[i].imm));",
          "378:           break;",
          "383:          case X86_OP_MEM:",
          "385:           tmp2 = caml_alloc(5, 0);",
          "386:           Store_field(tmp2, 0, Val_int(insn[j-1].detail->x86.operands[i].mem.segment));",
          "387:           Store_field(tmp2, 1, Val_int(insn[j-1].detail->x86.operands[i].mem.base));",
          "",
          "[Removed Lines]",
          "379:          case X86_OP_FP:",
          "380:           tmp = caml_alloc(5, 3);",
          "381:           Store_field(tmp, 0, caml_copy_double(insn[j-1].detail->x86.operands[i].fp));",
          "382:           break;",
          "384:           tmp = caml_alloc(5, 4);",
          "",
          "[Added Lines]",
          "380:           tmp = caml_alloc(5, 3);",
          "",
          "---------------"
        ],
        "bindings/ocaml/test_x86.ml||bindings/ocaml/test_x86.ml": [
          "File: bindings/ocaml/test_x86.ml -> bindings/ocaml/test_x86.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:  | X86_OP_INVALID _ -> (); (* this would never happens *)",
          "33:  | X86_OP_REG reg -> printf \"\\t\\top[%d]: REG = %s\\n\" i (cs_reg_name handle reg);",
          "34:  | X86_OP_IMM imm -> printf \"\\t\\top[%d]: IMM = 0x%x\\n\" i imm;",
          "36:  | X86_OP_MEM mem -> ( printf \"\\t\\top[%d]: MEM\\n\" i;",
          "37:   if mem.base != 0 then",
          "38:    printf \"\\t\\t\\toperands[%u].mem.base: REG = %s\\n\" i (cs_reg_name handle  mem.base);",
          "",
          "[Removed Lines]",
          "35:  | X86_OP_FP fp -> printf \"\\t\\top[%d]: FP = %f\\n\" i fp;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/x86.ml||bindings/ocaml/x86.ml": [
          "File: bindings/ocaml/x86.ml -> bindings/ocaml/x86.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "16:  | X86_OP_INVALID of int",
          "17:  | X86_OP_REG of int",
          "18:  | X86_OP_IMM of int",
          "20:  | X86_OP_MEM of x86_op_mem",
          "22: type x86_op = {",
          "",
          "[Removed Lines]",
          "19:  | X86_OP_FP of float",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/x86_const.ml||bindings/ocaml/x86_const.ml": [
          "File: bindings/ocaml/x86_const.ml -> bindings/ocaml/x86_const.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "300: let _X86_OP_REG = 1;;",
          "301: let _X86_OP_IMM = 2;;",
          "302: let _X86_OP_MEM = 3;;",
          "305: (* XOP Code Condition type *)",
          "",
          "[Removed Lines]",
          "303: let _X86_OP_FP = 4;;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/capstone/x86.py||bindings/python/capstone/x86.py": [
          "File: bindings/python/capstone/x86.py -> bindings/python/capstone/x86.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17:     _fields_ = (",
          "18:         ('reg', ctypes.c_uint),",
          "19:         ('imm', ctypes.c_int64),",
          "21:         ('mem', X86OpMem),",
          "22:     )",
          "",
          "[Removed Lines]",
          "20:         ('fp', ctypes.c_double),",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39:     def reg(self):",
          "40:         return self.value.reg",
          "46:     @property",
          "47:     def mem(self):",
          "48:         return self.value.mem",
          "",
          "[Removed Lines]",
          "42:     @property",
          "43:     def fp(self):",
          "44:         return self.value.fp",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/capstone/x86_const.py||bindings/python/capstone/x86_const.py": [
          "File: bindings/python/capstone/x86_const.py -> bindings/python/capstone/x86_const.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "300: X86_OP_REG = 1",
          "301: X86_OP_IMM = 2",
          "302: X86_OP_MEM = 3",
          "305: # XOP Code Condition type",
          "",
          "[Removed Lines]",
          "303: X86_OP_FP = 4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/test_x86.py||bindings/python/test_x86.py": [
          "File: bindings/python/test_x86.py -> bindings/python/test_x86.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "99:                 print(\"\\t\\toperands[%u].type: REG = %s\" % (c, insn.reg_name(i.reg)))",
          "100:             if i.type == X86_OP_IMM:",
          "101:                 print(\"\\t\\toperands[%u].type: IMM = 0x%s\" % (c, to_x(i.imm)))",
          "104:             if i.type == X86_OP_MEM:",
          "105:                 print(\"\\t\\toperands[%u].type: MEM\" % c)",
          "106:                 if i.mem.segment != 0:",
          "",
          "[Removed Lines]",
          "102:             if i.type == X86_OP_FP:",
          "103:                 print(\"\\t\\toperands[%u].type: FP = %f\" % (c, i.fp))",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "232825380243f3cc8bb9dd7afc2cba9bc7459099",
      "candidate_info": {
        "commit_hash": "232825380243f3cc8bb9dd7afc2cba9bc7459099",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/232825380243f3cc8bb9dd7afc2cba9bc7459099",
        "files": [
          "bindings/powershell/Capstone/Capstone.psm1"
        ],
        "message": "$Address -> UInt64 !Int32",
        "before_after_code_files": [
          "bindings/powershell/Capstone/Capstone.psm1||bindings/powershell/Capstone/Capstone.psm1"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/powershell/Capstone/Capstone.psm1||bindings/powershell/Capstone/Capstone.psm1": [
          "File: bindings/powershell/Capstone/Capstone.psm1 -> bindings/powershell/Capstone/Capstone.psm1",
          "--- Hunk 1 ---",
          "[Context before]",
          "125:   [String]$Syntax = \"Intel\",",
          "127:   [Parameter(ParameterSetName='Capstone', Mandatory = $False)]",
          "130:   [Parameter(ParameterSetName='Capstone', Mandatory = $False)]",
          "131:   [switch]$Detailed = $null,",
          "",
          "[Removed Lines]",
          "128:   [Int]$Address = 0x100000,",
          "",
          "[Added Lines]",
          "128:   [UInt64]$Address = 0x100000,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
      "candidate_info": {
        "commit_hash": "4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4a4418a0d3ec77bdedf3755020a4b5bdde5440a8",
        "files": [
          ".appveyor.yml",
          "appveyor.yml",
          "arch/X86/X86IntelInstPrinter.c"
        ],
        "message": "Revert \"rename appveyor.yml to .appveyor.yml\"\n\nThis reverts commit 3abf30552812fdfb07a1cbe5fff187ba9103d104.",
        "before_after_code_files": [
          "arch/X86/X86IntelInstPrinter.c||arch/X86/X86IntelInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86IntelInstPrinter.c||arch/X86/X86IntelInstPrinter.c": [
          "File: arch/X86/X86IntelInstPrinter.c -> arch/X86/X86IntelInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "420:   printRegName(O, MCOperand_getReg(Op));",
          "421:  } else if (MCOperand_isImm(Op)) {",
          "422:   int64_t imm = MCOperand_getImm(Op);",
          "427:  }",
          "428: }",
          "",
          "[Removed Lines]",
          "423:   if (MI->csh->imm_unsigned == CS_OPT_ON)",
          "424:    printImm(MI->csh->syntax, O, imm, true);",
          "425:   else",
          "426:    printImm(MI->csh->syntax, O, imm, false);",
          "",
          "[Added Lines]",
          "423:   printImm(MI->csh->syntax, O, imm, false);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "849:   switch(MI->flat_insn->id) {",
          "850:    default:",
          "855:     break;",
          "857:    case X86_INS_MOVABS:",
          "",
          "[Removed Lines]",
          "851:     if (MI->csh->imm_unsigned == CS_OPT_ON)",
          "852:      printImm(MI->csh->syntax, O, imm, true);",
          "853:     else",
          "854:      printImm(MI->csh->syntax, O, imm, false);",
          "",
          "[Added Lines]",
          "848:     printImm(MI->csh->syntax, O, imm, false);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "edc72e6a7be31d46e17400f661edddb8388d83b4",
      "candidate_info": {
        "commit_hash": "edc72e6a7be31d46e17400f661edddb8388d83b4",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/edc72e6a7be31d46e17400f661edddb8388d83b4",
        "files": [
          "bindings/python/capstone/m68k.py"
        ],
        "message": "Replace copy.deepcopy by  copy_ctypes_list for get_arch_info\n\nThis replacement was done for commit\n16477206564745782854e0ec5c68defa02429dd8, allowing the python binding to\nbe used in PyPy. It seems the m68k arch has been forgotten.",
        "before_after_code_files": [
          "bindings/python/capstone/m68k.py||bindings/python/capstone/m68k.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/capstone/m68k.py||bindings/python/capstone/m68k.py": [
          "File: bindings/python/capstone/m68k.py -> bindings/python/capstone/m68k.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "86:     )",
          "88: def get_arch_info(a):",
          "",
          "[Removed Lines]",
          "89:     return (copy.deepcopy(a.operands[:a.op_count]), a.op_size)",
          "",
          "[Added Lines]",
          "89:     return (copy_ctypes_list(a.operands[:a.op_count]), a.op_size)",
          "",
          "---------------"
        ]
      }
    }
  ]
}