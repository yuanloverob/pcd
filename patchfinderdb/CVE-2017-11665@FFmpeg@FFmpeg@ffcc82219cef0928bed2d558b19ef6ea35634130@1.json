{
  "cve_id": "CVE-2017-11665",
  "cve_desc": "The ff_amf_get_field_value function in libavformat/rtmppkt.c in FFmpeg 3.3.2 allows remote RTMP servers to cause a denial of service (Segmentation Violation and application crash) via a crafted stream.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "ffcc82219cef0928bed2d558b19ef6ea35634130",
  "patch_info": {
    "commit_hash": "ffcc82219cef0928bed2d558b19ef6ea35634130",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/ffcc82219cef0928bed2d558b19ef6ea35634130",
    "files": [
      "libavformat/rtmppkt.c"
    ],
    "message": "avformat/rtmppkt: Convert ff_amf_get_field_value() to bytestream2\n\nFixes: out of array accesses\n\nFound-by: JunDong Xie of Ant-financial Light-Year Security Lab\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
    ]
  },
  "patch_diff": {
    "libavformat/rtmppkt.c||libavformat/rtmppkt.c": [
      "File: libavformat/rtmppkt.c -> libavformat/rtmppkt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "505:     return bytestream2_tell(&gb);",
      "506: }",
      "509:                            const uint8_t *name, uint8_t *dst, int dst_size)",
      "510: {",
      "511:     int namelen = strlen(name);",
      "512:     int len;",
      "519:     }",
      "521:         return -1;",
      "523:     for (;;) {",
      "525:         if (!size)",
      "526:             break;",
      "528:             return -1;",
      "532:             case AMF_DATA_TYPE_NUMBER:",
      "534:                 break;",
      "535:             case AMF_DATA_TYPE_BOOL:",
      "537:                 break;",
      "538:             case AMF_DATA_TYPE_STRING:",
      "541:                 break;",
      "542:             default:",
      "543:                 return -1;",
      "544:             }",
      "545:             return 0;",
      "546:         }",
      "549:             return -1;",
      "551:     }",
      "552:     return -1;",
      "553: }",
      "555: static const char* rtmp_packet_type(int type)",
      "556: {",
      "557:     switch (type) {",
      "",
      "[Removed Lines]",
      "508: int ff_amf_get_field_value(const uint8_t *data, const uint8_t *data_end,",
      "514:     while (*data != AMF_DATA_TYPE_OBJECT && data < data_end) {",
      "515:         len = ff_amf_tag_size(data, data_end);",
      "516:         if (len < 0)",
      "517:             len = data_end - data;",
      "518:         data += len;",
      "520:     if (data_end - data < 3)",
      "522:     data++;",
      "524:         int size = bytestream_get_be16(&data);",
      "527:         if (size < 0 || size >= data_end - data)",
      "529:         data += size;",
      "530:         if (size == namelen && !memcmp(data-size, name, namelen)) {",
      "531:             switch (*data++) {",
      "533:                 snprintf(dst, dst_size, \"%g\", av_int2double(AV_RB64(data)));",
      "536:                 snprintf(dst, dst_size, \"%s\", *data ? \"true\" : \"false\");",
      "539:                 len = bytestream_get_be16(&data);",
      "540:                 av_strlcpy(dst, data, FFMIN(len+1, dst_size));",
      "547:         len = ff_amf_tag_size(data, data_end);",
      "548:         if (len < 0 || len >= data_end - data)",
      "550:         data += len;",
      "",
      "[Added Lines]",
      "508: static int amf_get_field_value2(GetByteContext *gb,",
      "514:     while (bytestream2_peek_byte(gb) != AMF_DATA_TYPE_OBJECT && bytestream2_get_bytes_left(gb) > 0) {",
      "515:         int ret = amf_tag_skip(gb);",
      "516:         if (ret < 0)",
      "517:             return -1;",
      "519:     if (bytestream2_get_bytes_left(gb) < 3)",
      "521:     bytestream2_get_byte(gb);",
      "524:         int size = bytestream2_get_be16(gb);",
      "527:         if (size < 0 || size >= bytestream2_get_bytes_left(gb))",
      "529:         bytestream2_skip(gb, size);",
      "530:         if (size == namelen && !memcmp(gb->buffer-size, name, namelen)) {",
      "531:             switch (bytestream2_get_byte(gb)) {",
      "533:                 snprintf(dst, dst_size, \"%g\", av_int2double(bytestream2_get_be64(gb)));",
      "536:                 snprintf(dst, dst_size, \"%s\", bytestream2_get_byte(gb) ? \"true\" : \"false\");",
      "539:                 len = bytestream2_get_be16(gb);",
      "540:                 if (dst_size < 1)",
      "541:                     return -1;",
      "542:                 if (dst_size < len + 1)",
      "543:                     len = dst_size - 1;",
      "544:                 bytestream2_get_buffer(gb, dst, len);",
      "545:                 dst[len] = 0;",
      "552:         len = amf_tag_skip(gb);",
      "553:         if (len < 0 || bytestream2_get_bytes_left(gb) <= 0)",
      "559: int ff_amf_get_field_value(const uint8_t *data, const uint8_t *data_end,",
      "560:                            const uint8_t *name, uint8_t *dst, int dst_size)",
      "561: {",
      "562:     GetByteContext gb;",
      "564:     if (data >= data_end)",
      "565:         return -1;",
      "567:     bytestream2_init(&gb, data, data_end - data);",
      "569:     return amf_get_field_value2(&gb, name, dst, dst_size);",
      "570: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "52bb9d6d58c2df3044c793871bcbe8fe71002aff",
      "candidate_info": {
        "commit_hash": "52bb9d6d58c2df3044c793871bcbe8fe71002aff",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/52bb9d6d58c2df3044c793871bcbe8fe71002aff",
        "files": [
          "libavformat/rtmppkt.c"
        ],
        "message": "avformat/rtmppkt: Convert ff_amf_get_field_value() to bytestream2\n\nFixes: out of array accesses\n\nFound-by: JunDong Xie of Ant-financial Light-Year Security Lab\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit ffcc82219cef0928bed2d558b19ef6ea35634130)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
          ],
          "candidate": [
            "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/rtmppkt.c||libavformat/rtmppkt.c": [
          "File: libavformat/rtmppkt.c -> libavformat/rtmppkt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "495:     return bytestream2_tell(&gb);",
          "496: }",
          "499:                            const uint8_t *name, uint8_t *dst, int dst_size)",
          "500: {",
          "501:     int namelen = strlen(name);",
          "502:     int len;",
          "509:     }",
          "511:         return -1;",
          "513:     for (;;) {",
          "515:         if (!size)",
          "516:             break;",
          "518:             return -1;",
          "522:             case AMF_DATA_TYPE_NUMBER:",
          "524:                 break;",
          "525:             case AMF_DATA_TYPE_BOOL:",
          "527:                 break;",
          "528:             case AMF_DATA_TYPE_STRING:",
          "531:                 break;",
          "532:             default:",
          "533:                 return -1;",
          "534:             }",
          "535:             return 0;",
          "536:         }",
          "539:             return -1;",
          "541:     }",
          "542:     return -1;",
          "543: }",
          "545: static const char* rtmp_packet_type(int type)",
          "546: {",
          "547:     switch (type) {",
          "",
          "[Removed Lines]",
          "498: int ff_amf_get_field_value(const uint8_t *data, const uint8_t *data_end,",
          "504:     while (*data != AMF_DATA_TYPE_OBJECT && data < data_end) {",
          "505:         len = ff_amf_tag_size(data, data_end);",
          "506:         if (len < 0)",
          "507:             len = data_end - data;",
          "508:         data += len;",
          "510:     if (data_end - data < 3)",
          "512:     data++;",
          "514:         int size = bytestream_get_be16(&data);",
          "517:         if (size < 0 || size >= data_end - data)",
          "519:         data += size;",
          "520:         if (size == namelen && !memcmp(data-size, name, namelen)) {",
          "521:             switch (*data++) {",
          "523:                 snprintf(dst, dst_size, \"%g\", av_int2double(AV_RB64(data)));",
          "526:                 snprintf(dst, dst_size, \"%s\", *data ? \"true\" : \"false\");",
          "529:                 len = bytestream_get_be16(&data);",
          "530:                 av_strlcpy(dst, data, FFMIN(len+1, dst_size));",
          "537:         len = ff_amf_tag_size(data, data_end);",
          "538:         if (len < 0 || len >= data_end - data)",
          "540:         data += len;",
          "",
          "[Added Lines]",
          "498: static int amf_get_field_value2(GetByteContext *gb,",
          "504:     while (bytestream2_peek_byte(gb) != AMF_DATA_TYPE_OBJECT && bytestream2_get_bytes_left(gb) > 0) {",
          "505:         int ret = amf_tag_skip(gb);",
          "506:         if (ret < 0)",
          "507:             return -1;",
          "509:     if (bytestream2_get_bytes_left(gb) < 3)",
          "511:     bytestream2_get_byte(gb);",
          "514:         int size = bytestream2_get_be16(gb);",
          "517:         if (size < 0 || size >= bytestream2_get_bytes_left(gb))",
          "519:         bytestream2_skip(gb, size);",
          "520:         if (size == namelen && !memcmp(gb->buffer-size, name, namelen)) {",
          "521:             switch (bytestream2_get_byte(gb)) {",
          "523:                 snprintf(dst, dst_size, \"%g\", av_int2double(bytestream2_get_be64(gb)));",
          "526:                 snprintf(dst, dst_size, \"%s\", bytestream2_get_byte(gb) ? \"true\" : \"false\");",
          "529:                 len = bytestream2_get_be16(gb);",
          "530:                 if (dst_size < 1)",
          "531:                     return -1;",
          "532:                 if (dst_size < len + 1)",
          "533:                     len = dst_size - 1;",
          "534:                 bytestream2_get_buffer(gb, dst, len);",
          "535:                 dst[len] = 0;",
          "542:         len = amf_tag_skip(gb);",
          "543:         if (len < 0 || bytestream2_get_bytes_left(gb) <= 0)",
          "549: int ff_amf_get_field_value(const uint8_t *data, const uint8_t *data_end,",
          "550:                            const uint8_t *name, uint8_t *dst, int dst_size)",
          "551: {",
          "552:     GetByteContext gb;",
          "554:     if (data >= data_end)",
          "555:         return -1;",
          "557:     bytestream2_init(&gb, data, data_end - data);",
          "559:     return amf_get_field_value2(&gb, name, dst, dst_size);",
          "560: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7d57ca4d9a75562fa32e40766211de150f8b3ee7",
      "candidate_info": {
        "commit_hash": "7d57ca4d9a75562fa32e40766211de150f8b3ee7",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/7d57ca4d9a75562fa32e40766211de150f8b3ee7",
        "files": [
          "libavformat/rtmppkt.c"
        ],
        "message": "avformat/rtmppkt: Check for packet size mismatches\n\nFixes out of array access\n\nFound-by: Paul Cher <paulcher@icloud.com>\nReviewed-by: Paul Cher <paulcher@icloud.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
          ],
          "candidate": [
            "libavformat/rtmppkt.c||libavformat/rtmppkt.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/rtmppkt.c||libavformat/rtmppkt.c": [
          "File: libavformat/rtmppkt.c -> libavformat/rtmppkt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "235:     if (hdr != RTMP_PS_TWELVEBYTES)",
          "236:         timestamp += prev_pkt[channel_id].timestamp;",
          "238:     if (!prev_pkt[channel_id].read) {",
          "239:         if ((ret = ff_rtmp_packet_create(p, channel_id, type, timestamp,",
          "240:                                          size)) < 0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "238:     if (prev_pkt[channel_id].read && size != prev_pkt[channel_id].size) {",
          "239:         av_log(NULL, AV_LOG_ERROR, \"RTMP packet size mismatch %d != %d\\n\",",
          "240:                 size,",
          "241:                 prev_pkt[channel_id].size);",
          "242:         ff_rtmp_packet_destroy(&prev_pkt[channel_id]);",
          "243:         prev_pkt[channel_id].read = 0;",
          "244:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}