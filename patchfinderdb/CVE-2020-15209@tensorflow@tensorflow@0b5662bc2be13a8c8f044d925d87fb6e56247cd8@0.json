{
  "cve_id": "CVE-2020-15209",
  "cve_desc": "In tensorflow-lite before versions 1.15.4, 2.0.3, 2.1.2, 2.2.1 and 2.3.1, a crafted TFLite model can force a node to have as input a tensor backed by a `nullptr` buffer. This can be achieved by changing a buffer index in the flatbuffer serialization to convert a read-only tensor to a read-write one. The runtime assumes that these buffers are written to before a possible read, hence they are initialized with `nullptr`. However, by changing the buffer index for a tensor and implicitly converting that tensor to be a read-write one, as there is nothing in the model that writes to it, we get a null pointer dereference. The issue is patched in commit 0b5662bc, and is released in TensorFlow versions 1.15.4, 2.0.3, 2.1.2, 2.2.1, or 2.3.1.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "0b5662bc2be13a8c8f044d925d87fb6e56247cd8",
  "patch_info": {
    "commit_hash": "0b5662bc2be13a8c8f044d925d87fb6e56247cd8",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/0b5662bc2be13a8c8f044d925d87fb6e56247cd8",
    "files": [
      "tensorflow/lite/BUILD",
      "tensorflow/lite/core/subgraph.cc",
      "tensorflow/lite/model_test.cc",
      "tensorflow/lite/testdata/segment_sum_invalid_buffer.bin"
    ],
    "message": "[tflite] Ensure input tensors don't have `nullptr` buffers.\n\nA crafted TFLite model can force a node to have as input a tensor backed by a `nullptr` buffer. That is, by carefully changing the buffer index in the flatbuffer serialization, we can force the TFLite interpreter to consider a read-only tensor to be a read-write one and assume that there is an operator that has this tensor as output, writing to it and allocating memory before the tensor is used as input. If this does not happen, we get memory corruption.\n\nPiperOrigin-RevId: 332524692\nChange-Id: I57ef175152a29020af9ab041dc959e5631dce40f",
    "before_after_code_files": [
      "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
      "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
      "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: #include <cstdint>",
      "21: #include \"tensorflow/lite/arena_planner.h\"",
      "22: #include \"tensorflow/lite/c/common.h\"",
      "23: #include \"tensorflow/lite/context_util.h\"",
      "24: #include \"tensorflow/lite/core/api/tensor_utils.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: #include \"tensorflow/lite/builtin_ops.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1030:           tensor->data_is_stale) {",
      "1031:         TF_LITE_ENSURE_STATUS(EnsureTensorDataIsReadable(tensor_index));",
      "1032:       }",
      "1033:     }",
      "1035:     if (check_cancelled_func_ != nullptr &&",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1034:       if (tensor->data.raw == nullptr && tensor->bytes > 0) {",
      "1035:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1) {",
      "1039:           continue;",
      "1040:         } else {",
      "1043:           ReportError(\"Input tensor %d lacks data\", tensor_index);",
      "1044:           return kTfLiteError;",
      "1045:         }",
      "1046:       }",
      "",
      "---------------"
    ],
    "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc": [
      "File: tensorflow/lite/model_test.cc -> tensorflow/lite/model_test.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "438: }",
      "459: }",
      "",
      "[Removed Lines]",
      "441: TEST(BasicFlatBufferModel, TestHandleMalformedModel) {",
      "442:   const auto model_paths = {",
      "444:       \"tensorflow/lite/testdata/add_shared_tensors.bin\",",
      "445:   };",
      "447:   for (const auto& model_path : model_paths) {",
      "448:     std::unique_ptr<tflite::FlatBufferModel> model =",
      "449:         FlatBufferModel::BuildFromFile(model_path);",
      "450:     ASSERT_NE(model, nullptr);",
      "452:     tflite::ops::builtin::BuiltinOpResolver resolver;",
      "453:     InterpreterBuilder builder(*model, resolver);",
      "454:     std::unique_ptr<Interpreter> interpreter;",
      "455:     ASSERT_EQ(builder(&interpreter), kTfLiteOk);",
      "456:     ASSERT_NE(interpreter, nullptr);",
      "457:     ASSERT_NE(interpreter->AllocateTensors(), kTfLiteOk);",
      "458:   }",
      "",
      "[Added Lines]",
      "447: TEST(BasicFlatBufferModel, TestHandleMalformedModelReuseTensor) {",
      "448:   const auto model_path =",
      "449:       \"tensorflow/lite/testdata/add_shared_tensors.bin\";",
      "451:   std::unique_ptr<tflite::FlatBufferModel> model =",
      "452:       FlatBufferModel::BuildFromFile(model_path);",
      "453:   ASSERT_NE(model, nullptr);",
      "455:   tflite::ops::builtin::BuiltinOpResolver resolver;",
      "456:   InterpreterBuilder builder(*model, resolver);",
      "457:   std::unique_ptr<Interpreter> interpreter;",
      "458:   ASSERT_EQ(builder(&interpreter), kTfLiteOk);",
      "459:   ASSERT_NE(interpreter, nullptr);",
      "460:   ASSERT_NE(interpreter->AllocateTensors(), kTfLiteOk);",
      "461: }",
      "468: TEST(BasicFlatBufferModel, TestHandleMalformedModelInvalidBuffer) {",
      "469:   const auto model_path =",
      "470:       \"tensorflow/lite/testdata/segment_sum_invalid_buffer.bin\";",
      "472:   std::unique_ptr<tflite::FlatBufferModel> model =",
      "473:       FlatBufferModel::BuildFromFile(model_path);",
      "474:   ASSERT_NE(model, nullptr);",
      "476:   tflite::ops::builtin::BuiltinOpResolver resolver;",
      "477:   InterpreterBuilder builder(*model, resolver);",
      "478:   std::unique_ptr<Interpreter> interpreter;",
      "479:   ASSERT_EQ(builder(&interpreter), kTfLiteOk);",
      "480:   ASSERT_NE(interpreter, nullptr);",
      "481:   ASSERT_EQ(interpreter->AllocateTensors(), kTfLiteOk);",
      "482:   ASSERT_NE(interpreter->Invoke(), kTfLiteOk);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d58c96946b2880991d63d1dacacb32f0a4dfa453",
      "candidate_info": {
        "commit_hash": "d58c96946b2880991d63d1dacacb32f0a4dfa453",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d58c96946b2880991d63d1dacacb32f0a4dfa453",
        "files": [
          "tensorflow/lite/BUILD",
          "tensorflow/lite/core/subgraph.cc",
          "tensorflow/lite/core/subgraph.h",
          "tensorflow/lite/model_test.cc",
          "tensorflow/lite/testdata/add_shared_tensors.bin",
          "tensorflow/lite/testdata/sparse_tensor.bin"
        ],
        "message": "[tflite] Ensure inputs and outputs don't overlap.\n\nIf a model uses the same tensor for both an input and an output then this can result in data loss and memory corruption. This should not happen.\n\nPiperOrigin-RevId: 332522916\nChange-Id: If0905b142415a9dfceaf2d181872f2a8fb88f48a",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
          "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h",
          "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
            "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
            "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "581:   return kTfLiteOk;",
          "582: }",
          "584: namespace {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "594: TfLiteStatus Subgraph::CheckInputAndOutputForOverlap(const int* input_indices,",
          "595:                                                      int num_inputs,",
          "596:                                                      const int* output_indices,",
          "597:                                                      int num_outputs) {",
          "598:   for (int i = 0; i < num_inputs; i++) {",
          "599:     for (int j = 0; j < num_outputs; j++) {",
          "600:       if (input_indices[i] == output_indices[j]) {",
          "601:         ReportError(\"Tensor %d is both input %d and output %d\\n\",",
          "602:                     input_indices[i], i, j);",
          "603:         consistent_ = false;",
          "604:         return kTfLiteError;",
          "605:       }",
          "606:     }",
          "607:   }",
          "608:   return kTfLiteOk;",
          "609: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "707:       &context_,",
          "708:       CheckTensorIndices(\"node outputs\", outputs.data(), outputs.size()));",
          "710:   int new_node_index = nodes_and_registration_.size();",
          "711:   if (node_index) *node_index = new_node_index;",
          "712:   nodes_and_registration_.resize(nodes_and_registration_.size() + 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "741:   if (builtin_data != nullptr) {",
          "742:     TF_LITE_ENSURE_OK(&context_, CheckInputAndOutputForOverlap(",
          "743:                                      inputs.data(), inputs.size(),",
          "744:                                      outputs.data(), outputs.size()));",
          "745:   }",
          "",
          "---------------"
        ],
        "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h": [
          "File: tensorflow/lite/core/subgraph.h -> tensorflow/lite/core/subgraph.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "451:   TfLiteStatus CheckTensorIndices(const char* label, const int* indices,",
          "452:                                   int length);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "458:   TfLiteStatus CheckInputAndOutputForOverlap(const int* input_indices,",
          "459:                                              int num_inputs,",
          "460:                                              const int* output_indices,",
          "461:                                              int num_outputs);",
          "",
          "---------------"
        ],
        "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc": [
          "File: tensorflow/lite/model_test.cc -> tensorflow/lite/model_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "438: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "441: TEST(BasicFlatBufferModel, TestHandleMalformedModel) {",
          "442:   const auto model_paths = {",
          "444:       \"tensorflow/lite/testdata/add_shared_tensors.bin\",",
          "445:   };",
          "447:   for (const auto& model_path : model_paths) {",
          "448:     std::unique_ptr<tflite::FlatBufferModel> model =",
          "449:         FlatBufferModel::BuildFromFile(model_path);",
          "450:     ASSERT_NE(model, nullptr);",
          "452:     tflite::ops::builtin::BuiltinOpResolver resolver;",
          "453:     InterpreterBuilder builder(*model, resolver);",
          "454:     std::unique_ptr<Interpreter> interpreter;",
          "455:     ASSERT_EQ(builder(&interpreter), kTfLiteOk);",
          "456:     ASSERT_NE(interpreter, nullptr);",
          "457:     ASSERT_NE(interpreter->AllocateTensors(), kTfLiteOk);",
          "458:   }",
          "459: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8ff3556aa71576a2be66bf761a5ba48bf57eeccf",
      "candidate_info": {
        "commit_hash": "8ff3556aa71576a2be66bf761a5ba48bf57eeccf",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8ff3556aa71576a2be66bf761a5ba48bf57eeccf",
        "files": [
          "tensorflow/lite/core/subgraph.cc"
        ],
        "message": "Prevent a null pointer dereference in TFLite.\n\nPiperOrigin-RevId: 370800353\nChange-Id: Ic9c9712ce5c6e384c954dcd640a5bd9ff05c9a05",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1037:         TF_LITE_ENSURE_STATUS(EnsureTensorDataIsReadable(tensor_index));",
          "1038:       }",
          "1039:       if (tensor->data.raw == nullptr && tensor->bytes > 0) {",
          "1044:           continue;",
          "1045:         } else {",
          "",
          "[Removed Lines]",
          "1040:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1) {",
          "",
          "[Added Lines]",
          "1040:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1 &&",
          "1041:             tensor->dims->size != 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f8378920345f4f4604202d4ab15ef64b2aceaa16",
      "candidate_info": {
        "commit_hash": "f8378920345f4f4604202d4ab15ef64b2aceaa16",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f8378920345f4f4604202d4ab15ef64b2aceaa16",
        "files": [
          "tensorflow/lite/core/subgraph.cc"
        ],
        "message": "Prevent a null pointer dereference in TFLite.\n\nPiperOrigin-RevId: 370800353\nChange-Id: Ic9c9712ce5c6e384c954dcd640a5bd9ff05c9a05",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1060:         TF_LITE_ENSURE_STATUS(EnsureTensorDataIsReadable(tensor_index));",
          "1061:       }",
          "1062:       if (tensor->data.raw == nullptr && tensor->bytes > 0) {",
          "1067:           continue;",
          "1068:         } else {",
          "",
          "[Removed Lines]",
          "1063:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1) {",
          "",
          "[Added Lines]",
          "1063:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1 &&",
          "1064:             tensor->dims->size != 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8e07cdb62febb3e165f2e20c45db4c76132d69f0",
      "candidate_info": {
        "commit_hash": "8e07cdb62febb3e165f2e20c45db4c76132d69f0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8e07cdb62febb3e165f2e20c45db4c76132d69f0",
        "files": [
          "tensorflow/lite/core/subgraph.cc"
        ],
        "message": "Prevent a null pointer dereference in TFLite.\n\nPiperOrigin-RevId: 370800353\nChange-Id: Ic9c9712ce5c6e384c954dcd640a5bd9ff05c9a05",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1033:         TF_LITE_ENSURE_STATUS(EnsureTensorDataIsReadable(tensor_index));",
          "1034:       }",
          "1035:       if (tensor->data.raw == nullptr && tensor->bytes > 0) {",
          "1040:           continue;",
          "1041:         } else {",
          "",
          "[Removed Lines]",
          "1036:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1) {",
          "",
          "[Added Lines]",
          "1036:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1 &&",
          "1037:             tensor->dims->size != 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6b9c3f29a35a2d8547692f561da35f2eff4b77d9",
      "candidate_info": {
        "commit_hash": "6b9c3f29a35a2d8547692f561da35f2eff4b77d9",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6b9c3f29a35a2d8547692f561da35f2eff4b77d9",
        "files": [
          "tensorflow/lite/core/subgraph.cc"
        ],
        "message": "[tflite] Ensure input tensors don't have `nullptr` buffers.\n\nA crafted TFLite model can force a node to have as input a tensor backed by a `nullptr` buffer. That is, by carefully changing the buffer index in the flatbuffer serialization, we can force the TFLite interpreter to consider a read-only tensor to be a read-write one and assume that there is an operator that has this tensor as output, writing to it and allocating memory before the tensor is used as input. If this does not happen, we get memory corruption.\n\nPiperOrigin-RevId: 332524692\nChange-Id: I57ef175152a29020af9ab041dc959e5631dce40f",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <algorithm>",
          "20: #include \"tensorflow/lite/arena_planner.h\"",
          "21: #include \"tensorflow/lite/c/c_api_internal.h\"",
          "22: #include \"tensorflow/lite/context_util.h\"",
          "23: #include \"tensorflow/lite/core/api/tensor_utils.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: #include \"third_party/tensorflow/lite/builtin_ops.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "792:           tensor->data_is_stale) {",
          "793:         TF_LITE_ENSURE_STATUS(EnsureTensorDataIsReadable(tensor_index));",
          "794:       }",
          "795:     }",
          "797:     if (check_cancelled_func_ != nullptr &&",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "796:       if (tensor->data.raw == nullptr && tensor->bytes > 0) {",
          "797:         if (registration.builtin_code == kTfLiteBuiltinReshape && i == 1) {",
          "801:           continue;",
          "802:         } else {",
          "805:           ReportError(\"Input tensor %d lacks data\", tensor_index);",
          "806:           return kTfLiteError;",
          "807:         }",
          "808:       }",
          "",
          "---------------"
        ]
      }
    }
  ]
}