{
  "cve_id": "CVE-2015-3175",
  "cve_desc": "Multiple open redirect vulnerabilities in Moodle through 2.5.9, 2.6.x before 2.6.11, 2.7.x before 2.7.8, and 2.8.x before 2.8.6 allow remote attackers to redirect users to arbitrary web sites and conduct phishing attacks via vectors involving an error page that links to a URL from an HTTP Referer header.",
  "repo": "moodle/moodle",
  "patch_hash": "db200a8e9f88c8c4a2141ac264062dca74ee2f29",
  "patch_info": {
    "commit_hash": "db200a8e9f88c8c4a2141ac264062dca74ee2f29",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/db200a8e9f88c8c4a2141ac264062dca74ee2f29",
    "files": [
      "lib/setuplib.php",
      "lib/tests/setuplib_test.php"
    ],
    "message": "MDL-49179 setuplib: print_error() uses local URLs exclusively",
    "before_after_code_files": [
      "lib/setuplib.php||lib/setuplib.php",
      "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
    ]
  },
  "patch_diff": {
    "lib/setuplib.php||lib/setuplib.php": [
      "File: lib/setuplib.php -> lib/setuplib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "557:         }",
      "558:     }",
      "564:     }",
      "566:     $info = new stdClass();",
      "",
      "[Removed Lines]",
      "561:     if (stripos($link, $CFG->wwwroot) === false &&",
      "562:         stripos($link, $CFG->httpswwwroot) === false) {",
      "563:         $link = $CFG->wwwroot.'/';",
      "",
      "[Added Lines]",
      "562:     $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
      "563:     if (stripos($link, $CFG->wwwroot) === 0) {",
      "565:     } else if (!empty($CFG->loginhttps) && stripos($link, $httpswwwroot) === 0) {",
      "567:     } else {",
      "569:         $link = $CFG->wwwroot . '/';",
      "",
      "---------------"
    ],
    "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php": [
      "File: lib/tests/setuplib_test.php -> lib/tests/setuplib_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "399:         $this->assertNotSame($expected, array_merge_recursive($original, $chunk));",
      "400:     }",
      "401: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "405:     public function test_get_exception_info_link() {",
      "406:         global $CFG, $SESSION;",
      "408:         $initialloginhttps = $CFG->loginhttps;",
      "409:         $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
      "410:         $CFG->loginhttps = false;",
      "413:         $url = $CFG->wwwroot . '/something/here?really=yes';",
      "414:         $exception = new moodle_exception('none', 'error', $url);",
      "415:         $infos = $this->get_exception_info($exception);",
      "416:         $this->assertSame($url, $infos->link);",
      "419:         $url = '/something/here?really=yes';",
      "420:         $exception = new moodle_exception('none', 'error', $url);",
      "421:         $infos = $this->get_exception_info($exception);",
      "422:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "425:         $url = $httpswwwroot . '/something/here?really=yes';",
      "426:         $exception = new moodle_exception('none', 'error', $url);",
      "427:         $infos = $this->get_exception_info($exception);",
      "428:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "431:         $CFG->loginhttps = true;",
      "432:         $url = $httpswwwroot . '/something/here?really=yes';",
      "433:         $exception = new moodle_exception('none', 'error', $url);",
      "434:         $infos = $this->get_exception_info($exception);",
      "435:         $this->assertSame($url, $infos->link);",
      "438:         $url = 'http://moodle.org/something/here?really=yes';",
      "439:         $exception = new moodle_exception('none', 'error', $url);",
      "440:         $infos = $this->get_exception_info($exception);",
      "441:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "444:         $url = 'https://moodle.org/something/here?really=yes';",
      "445:         $exception = new moodle_exception('none', 'error', $url);",
      "446:         $infos = $this->get_exception_info($exception);",
      "447:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "450:         $url = 'http://moodle.org/something/here?' . $CFG->wwwroot;",
      "451:         $exception = new moodle_exception('none', 'error', $url);",
      "452:         $infos = $this->get_exception_info($exception);",
      "453:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "456:         $SESSION->fromurl = $url = $CFG->wwwroot . '/something/here?really=yes';",
      "457:         $exception = new moodle_exception('none');",
      "458:         $infos = $this->get_exception_info($exception);",
      "459:         $this->assertSame($url, $infos->link);",
      "462:         $SESSION->fromurl = $url = $httpswwwroot . '/something/here?really=yes';",
      "463:         $exception = new moodle_exception('none');",
      "464:         $infos = $this->get_exception_info($exception);",
      "465:         $this->assertSame($url, $infos->link);",
      "468:         $CFG->loginhttps = false;",
      "469:         $SESSION->fromurl = $httpswwwroot . '/something/here?really=yes';",
      "470:         $exception = new moodle_exception('none');",
      "471:         $infos = $this->get_exception_info($exception);",
      "472:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "475:         $SESSION->fromurl = 'http://moodle.org/something/here?really=yes';",
      "476:         $exception = new moodle_exception('none');",
      "477:         $infos = $this->get_exception_info($exception);",
      "478:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "481:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
      "482:         $exception = new moodle_exception('none');",
      "483:         $infos = $this->get_exception_info($exception);",
      "484:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "487:         $CFG->loginhttps = true;",
      "488:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
      "489:         $exception = new moodle_exception('none');",
      "490:         $infos = $this->get_exception_info($exception);",
      "491:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
      "493:         $CFG->loginhttps = $initialloginhttps;",
      "494:         $SESSION->fromurl = '';",
      "495:     }",
      "503:     public function get_exception_info($ex) {",
      "504:         try {",
      "505:             throw $ex;",
      "506:         } catch (moodle_exception $e) {",
      "507:             return get_exception_info($e);",
      "508:         }",
      "509:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8c45d46d36e1064393de56bcac999c0e86402adb",
      "candidate_info": {
        "commit_hash": "8c45d46d36e1064393de56bcac999c0e86402adb",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8c45d46d36e1064393de56bcac999c0e86402adb",
        "files": [
          "lib/setuplib.php",
          "lib/tests/setuplib_test.php"
        ],
        "message": "MDL-49179 setuplib: print_error() uses local URLs exclusively",
        "before_after_code_files": [
          "lib/setuplib.php||lib/setuplib.php",
          "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ],
          "candidate": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setuplib.php||lib/setuplib.php": [
          "File: lib/setuplib.php -> lib/setuplib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "557:         }",
          "558:     }",
          "564:     }",
          "566:     $info = new stdClass();",
          "",
          "[Removed Lines]",
          "561:     if (stripos($link, $CFG->wwwroot) === false &&",
          "562:         stripos($link, $CFG->httpswwwroot) === false) {",
          "563:         $link = $CFG->wwwroot.'/';",
          "",
          "[Added Lines]",
          "562:     $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "563:     if (stripos($link, $CFG->wwwroot) === 0) {",
          "565:     } else if (!empty($CFG->loginhttps) && stripos($link, $httpswwwroot) === 0) {",
          "567:     } else {",
          "569:         $link = $CFG->wwwroot . '/';",
          "",
          "---------------"
        ],
        "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php": [
          "File: lib/tests/setuplib_test.php -> lib/tests/setuplib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "295:         $this->assertNotSame($expected, array_merge_recursive($original, $chunk));",
          "296:     }",
          "297: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "301:     public function test_get_exception_info_link() {",
          "302:         global $CFG, $SESSION;",
          "304:         $initialloginhttps = $CFG->loginhttps;",
          "305:         $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "306:         $CFG->loginhttps = false;",
          "309:         $url = $CFG->wwwroot . '/something/here?really=yes';",
          "310:         $exception = new moodle_exception('none', 'error', $url);",
          "311:         $infos = $this->get_exception_info($exception);",
          "312:         $this->assertSame($url, $infos->link);",
          "315:         $url = '/something/here?really=yes';",
          "316:         $exception = new moodle_exception('none', 'error', $url);",
          "317:         $infos = $this->get_exception_info($exception);",
          "318:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "321:         $url = $httpswwwroot . '/something/here?really=yes';",
          "322:         $exception = new moodle_exception('none', 'error', $url);",
          "323:         $infos = $this->get_exception_info($exception);",
          "324:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "327:         $CFG->loginhttps = true;",
          "328:         $url = $httpswwwroot . '/something/here?really=yes';",
          "329:         $exception = new moodle_exception('none', 'error', $url);",
          "330:         $infos = $this->get_exception_info($exception);",
          "331:         $this->assertSame($url, $infos->link);",
          "334:         $url = 'http://moodle.org/something/here?really=yes';",
          "335:         $exception = new moodle_exception('none', 'error', $url);",
          "336:         $infos = $this->get_exception_info($exception);",
          "337:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "340:         $url = 'https://moodle.org/something/here?really=yes';",
          "341:         $exception = new moodle_exception('none', 'error', $url);",
          "342:         $infos = $this->get_exception_info($exception);",
          "343:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "346:         $url = 'http://moodle.org/something/here?' . $CFG->wwwroot;",
          "347:         $exception = new moodle_exception('none', 'error', $url);",
          "348:         $infos = $this->get_exception_info($exception);",
          "349:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "352:         $SESSION->fromurl = $url = $CFG->wwwroot . '/something/here?really=yes';",
          "353:         $exception = new moodle_exception('none');",
          "354:         $infos = $this->get_exception_info($exception);",
          "355:         $this->assertSame($url, $infos->link);",
          "358:         $SESSION->fromurl = $url = $httpswwwroot . '/something/here?really=yes';",
          "359:         $exception = new moodle_exception('none');",
          "360:         $infos = $this->get_exception_info($exception);",
          "361:         $this->assertSame($url, $infos->link);",
          "364:         $CFG->loginhttps = false;",
          "365:         $SESSION->fromurl = $httpswwwroot . '/something/here?really=yes';",
          "366:         $exception = new moodle_exception('none');",
          "367:         $infos = $this->get_exception_info($exception);",
          "368:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "371:         $SESSION->fromurl = 'http://moodle.org/something/here?really=yes';",
          "372:         $exception = new moodle_exception('none');",
          "373:         $infos = $this->get_exception_info($exception);",
          "374:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "377:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "378:         $exception = new moodle_exception('none');",
          "379:         $infos = $this->get_exception_info($exception);",
          "380:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "383:         $CFG->loginhttps = true;",
          "384:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "385:         $exception = new moodle_exception('none');",
          "386:         $infos = $this->get_exception_info($exception);",
          "387:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "389:         $CFG->loginhttps = $initialloginhttps;",
          "390:         $SESSION->fromurl = '';",
          "391:     }",
          "399:     public function get_exception_info($ex) {",
          "400:         try {",
          "401:             throw $ex;",
          "402:         } catch (moodle_exception $e) {",
          "403:             return get_exception_info($e);",
          "404:         }",
          "405:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "19bf8ae268d4c03dda30a422547b9971b69d1036",
      "candidate_info": {
        "commit_hash": "19bf8ae268d4c03dda30a422547b9971b69d1036",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/19bf8ae268d4c03dda30a422547b9971b69d1036",
        "files": [
          "lib/setuplib.php",
          "lib/tests/setuplib_test.php"
        ],
        "message": "MDL-49179 setuplib: print_error() uses local URLs exclusively",
        "before_after_code_files": [
          "lib/setuplib.php||lib/setuplib.php",
          "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ],
          "candidate": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setuplib.php||lib/setuplib.php": [
          "File: lib/setuplib.php -> lib/setuplib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "557:         }",
          "558:     }",
          "564:     }",
          "566:     $info = new stdClass();",
          "",
          "[Removed Lines]",
          "561:     if (stripos($link, $CFG->wwwroot) === false &&",
          "562:         stripos($link, $CFG->httpswwwroot) === false) {",
          "563:         $link = $CFG->wwwroot.'/';",
          "",
          "[Added Lines]",
          "562:     $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "563:     if (stripos($link, $CFG->wwwroot) === 0) {",
          "565:     } else if (!empty($CFG->loginhttps) && stripos($link, $httpswwwroot) === 0) {",
          "567:     } else {",
          "569:         $link = $CFG->wwwroot . '/';",
          "",
          "---------------"
        ],
        "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php": [
          "File: lib/tests/setuplib_test.php -> lib/tests/setuplib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "295:         $this->assertNotSame($expected, array_merge_recursive($original, $chunk));",
          "296:     }",
          "297: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "301:     public function test_get_exception_info_link() {",
          "302:         global $CFG, $SESSION;",
          "304:         $initialloginhttps = $CFG->loginhttps;",
          "305:         $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "306:         $CFG->loginhttps = false;",
          "309:         $url = $CFG->wwwroot . '/something/here?really=yes';",
          "310:         $exception = new moodle_exception('none', 'error', $url);",
          "311:         $infos = $this->get_exception_info($exception);",
          "312:         $this->assertSame($url, $infos->link);",
          "315:         $url = '/something/here?really=yes';",
          "316:         $exception = new moodle_exception('none', 'error', $url);",
          "317:         $infos = $this->get_exception_info($exception);",
          "318:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "321:         $url = $httpswwwroot . '/something/here?really=yes';",
          "322:         $exception = new moodle_exception('none', 'error', $url);",
          "323:         $infos = $this->get_exception_info($exception);",
          "324:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "327:         $CFG->loginhttps = true;",
          "328:         $url = $httpswwwroot . '/something/here?really=yes';",
          "329:         $exception = new moodle_exception('none', 'error', $url);",
          "330:         $infos = $this->get_exception_info($exception);",
          "331:         $this->assertSame($url, $infos->link);",
          "334:         $url = 'http://moodle.org/something/here?really=yes';",
          "335:         $exception = new moodle_exception('none', 'error', $url);",
          "336:         $infos = $this->get_exception_info($exception);",
          "337:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "340:         $url = 'https://moodle.org/something/here?really=yes';",
          "341:         $exception = new moodle_exception('none', 'error', $url);",
          "342:         $infos = $this->get_exception_info($exception);",
          "343:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "346:         $url = 'http://moodle.org/something/here?' . $CFG->wwwroot;",
          "347:         $exception = new moodle_exception('none', 'error', $url);",
          "348:         $infos = $this->get_exception_info($exception);",
          "349:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "352:         $SESSION->fromurl = $url = $CFG->wwwroot . '/something/here?really=yes';",
          "353:         $exception = new moodle_exception('none');",
          "354:         $infos = $this->get_exception_info($exception);",
          "355:         $this->assertSame($url, $infos->link);",
          "358:         $SESSION->fromurl = $url = $httpswwwroot . '/something/here?really=yes';",
          "359:         $exception = new moodle_exception('none');",
          "360:         $infos = $this->get_exception_info($exception);",
          "361:         $this->assertSame($url, $infos->link);",
          "364:         $CFG->loginhttps = false;",
          "365:         $SESSION->fromurl = $httpswwwroot . '/something/here?really=yes';",
          "366:         $exception = new moodle_exception('none');",
          "367:         $infos = $this->get_exception_info($exception);",
          "368:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "371:         $SESSION->fromurl = 'http://moodle.org/something/here?really=yes';",
          "372:         $exception = new moodle_exception('none');",
          "373:         $infos = $this->get_exception_info($exception);",
          "374:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "377:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "378:         $exception = new moodle_exception('none');",
          "379:         $infos = $this->get_exception_info($exception);",
          "380:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "383:         $CFG->loginhttps = true;",
          "384:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "385:         $exception = new moodle_exception('none');",
          "386:         $infos = $this->get_exception_info($exception);",
          "387:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "389:         $CFG->loginhttps = $initialloginhttps;",
          "390:         $SESSION->fromurl = '';",
          "391:     }",
          "399:     public function get_exception_info($ex) {",
          "400:         try {",
          "401:             throw $ex;",
          "402:         } catch (moodle_exception $e) {",
          "403:             return get_exception_info($e);",
          "404:         }",
          "405:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e691eeb160145143e0faf658b87f64575169ec23",
      "candidate_info": {
        "commit_hash": "e691eeb160145143e0faf658b87f64575169ec23",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e691eeb160145143e0faf658b87f64575169ec23",
        "files": [
          "lib/setuplib.php",
          "lib/tests/setuplib_test.php"
        ],
        "message": "MDL-49179 setuplib: print_error() uses local URLs exclusively",
        "before_after_code_files": [
          "lib/setuplib.php||lib/setuplib.php",
          "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ],
          "candidate": [
            "lib/setuplib.php||lib/setuplib.php",
            "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setuplib.php||lib/setuplib.php": [
          "File: lib/setuplib.php -> lib/setuplib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "557:         }",
          "558:     }",
          "564:     }",
          "566:     $info = new stdClass();",
          "",
          "[Removed Lines]",
          "561:     if (stripos($link, $CFG->wwwroot) === false &&",
          "562:         stripos($link, $CFG->httpswwwroot) === false) {",
          "563:         $link = $CFG->wwwroot.'/';",
          "",
          "[Added Lines]",
          "562:     $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "563:     if (stripos($link, $CFG->wwwroot) === 0) {",
          "565:     } else if (!empty($CFG->loginhttps) && stripos($link, $httpswwwroot) === 0) {",
          "567:     } else {",
          "569:         $link = $CFG->wwwroot . '/';",
          "",
          "---------------"
        ],
        "lib/tests/setuplib_test.php||lib/tests/setuplib_test.php": [
          "File: lib/tests/setuplib_test.php -> lib/tests/setuplib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "295:         $this->assertNotSame($expected, array_merge_recursive($original, $chunk));",
          "296:     }",
          "297: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "301:     public function test_get_exception_info_link() {",
          "302:         global $CFG, $SESSION;",
          "304:         $initialloginhttps = $CFG->loginhttps;",
          "305:         $httpswwwroot = str_replace('http:', 'https:', $CFG->wwwroot);",
          "306:         $CFG->loginhttps = false;",
          "309:         $url = $CFG->wwwroot . '/something/here?really=yes';",
          "310:         $exception = new moodle_exception('none', 'error', $url);",
          "311:         $infos = $this->get_exception_info($exception);",
          "312:         $this->assertSame($url, $infos->link);",
          "315:         $url = '/something/here?really=yes';",
          "316:         $exception = new moodle_exception('none', 'error', $url);",
          "317:         $infos = $this->get_exception_info($exception);",
          "318:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "321:         $url = $httpswwwroot . '/something/here?really=yes';",
          "322:         $exception = new moodle_exception('none', 'error', $url);",
          "323:         $infos = $this->get_exception_info($exception);",
          "324:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "327:         $CFG->loginhttps = true;",
          "328:         $url = $httpswwwroot . '/something/here?really=yes';",
          "329:         $exception = new moodle_exception('none', 'error', $url);",
          "330:         $infos = $this->get_exception_info($exception);",
          "331:         $this->assertSame($url, $infos->link);",
          "334:         $url = 'http://moodle.org/something/here?really=yes';",
          "335:         $exception = new moodle_exception('none', 'error', $url);",
          "336:         $infos = $this->get_exception_info($exception);",
          "337:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "340:         $url = 'https://moodle.org/something/here?really=yes';",
          "341:         $exception = new moodle_exception('none', 'error', $url);",
          "342:         $infos = $this->get_exception_info($exception);",
          "343:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "346:         $url = 'http://moodle.org/something/here?' . $CFG->wwwroot;",
          "347:         $exception = new moodle_exception('none', 'error', $url);",
          "348:         $infos = $this->get_exception_info($exception);",
          "349:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "352:         $SESSION->fromurl = $url = $CFG->wwwroot . '/something/here?really=yes';",
          "353:         $exception = new moodle_exception('none');",
          "354:         $infos = $this->get_exception_info($exception);",
          "355:         $this->assertSame($url, $infos->link);",
          "358:         $SESSION->fromurl = $url = $httpswwwroot . '/something/here?really=yes';",
          "359:         $exception = new moodle_exception('none');",
          "360:         $infos = $this->get_exception_info($exception);",
          "361:         $this->assertSame($url, $infos->link);",
          "364:         $CFG->loginhttps = false;",
          "365:         $SESSION->fromurl = $httpswwwroot . '/something/here?really=yes';",
          "366:         $exception = new moodle_exception('none');",
          "367:         $infos = $this->get_exception_info($exception);",
          "368:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "371:         $SESSION->fromurl = 'http://moodle.org/something/here?really=yes';",
          "372:         $exception = new moodle_exception('none');",
          "373:         $infos = $this->get_exception_info($exception);",
          "374:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "377:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "378:         $exception = new moodle_exception('none');",
          "379:         $infos = $this->get_exception_info($exception);",
          "380:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "383:         $CFG->loginhttps = true;",
          "384:         $SESSION->fromurl = 'https://moodle.org/something/here?really=yes';",
          "385:         $exception = new moodle_exception('none');",
          "386:         $infos = $this->get_exception_info($exception);",
          "387:         $this->assertSame($CFG->wwwroot . '/', $infos->link);",
          "389:         $CFG->loginhttps = $initialloginhttps;",
          "390:         $SESSION->fromurl = '';",
          "391:     }",
          "399:     public function get_exception_info($ex) {",
          "400:         try {",
          "401:             throw $ex;",
          "402:         } catch (moodle_exception $e) {",
          "403:             return get_exception_info($e);",
          "404:         }",
          "405:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}