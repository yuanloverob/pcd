{
  "cve_id": "CVE-2014-3553",
  "cve_desc": "mod/forum/classes/post_form.php in Moodle through 2.3.11, 2.4.x before 2.4.11, 2.5.x before 2.5.7, 2.6.x before 2.6.4, and 2.7.x before 2.7.1 does not enforce the moodle/site:accessallgroups capability requirement before proceeding with a post to all groups, which allows remote authenticated users to bypass intended access restrictions by leveraging two or more group memberships.",
  "repo": "moodle/moodle",
  "patch_hash": "f2946a5419a94f19cb3490a249fe0bb50161f254",
  "patch_info": {
    "commit_hash": "f2946a5419a94f19cb3490a249fe0bb50161f254",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/f2946a5419a94f19cb3490a249fe0bb50161f254",
    "files": [
      "mod/forum/classes/post_form.php",
      "mod/forum/tests/behat/separate_group_discussions.feature",
      "mod/forum/tests/behat/separate_group_single_group_discussions.feature"
    ],
    "message": "MDL-38990 mod_forum: Restrict ability to post to all groups in a forum\n\nIn order to post to all groups in a forum, you must have the\nmoodle/site:accessallgroups capability.\n\nThanks to Jakob Ackermann <jackermann@onlineschool.ca> for part of the fix\non this one.",
    "before_after_code_files": [
      "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
      "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
      "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
    ]
  },
  "patch_diff": {
    "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php": [
      "File: mod/forum/classes/post_form.php -> mod/forum/classes/post_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "164:             $mform->setConstants(array('timestart'=> 0, 'timeend'=>0));",
      "165:         }",
      "168:             $groupdata = groups_get_activity_allowed_groups($cm);",
      "169:             $groupcount = count($groupdata);",
      "170:             $modulecontext = context_module::instance($cm->id);",
      "173:                 $groupinfo = array('0' => get_string('allparticipants'));",
      "174:                 foreach ($groupdata as $grouptemp) {",
      "175:                     $groupinfo[$grouptemp->id] = $grouptemp->name;",
      "176:                 }",
      "",
      "[Removed Lines]",
      "167:         if (groups_get_activity_groupmode($cm, $course)) { // hack alert",
      "171:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount;",
      "172:             if ($contextcheck) {",
      "",
      "[Added Lines]",
      "167:         if ($groupmode = groups_get_activity_groupmode($cm, $course)) { // hack alert",
      "170:             $groupinfo = array();",
      "174:             if ($groupmode == VISIBLEGROUPS || has_capability('moodle/site:accessallgroups', $modulecontext)) {",
      "177:                 $groupcount++;",
      "178:             }",
      "180:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount > 1;",
      "181:             if ($contextcheck) {",
      "",
      "---------------"
    ],
    "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature": [
      "File: mod/forum/tests/behat/separate_group_discussions.feature -> mod/forum/tests/behat/separate_group_discussions.feature",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: @mod @mod_forum",
      "2: Feature: Posting to all groups in a separate group discussion is restricted to users with access to all groups",
      "3:   In order to post to all groups in a forum with separate groups",
      "4:   As a teacher",
      "5:   I need to have the accessallgroups capability or be a member of all of the groups",
      "7:   Background:",
      "8:     Given the following \"users\" exist:",
      "9:       | username | firstname | lastname | email |",
      "10:       | teacher1 | Teacher | 1 | teacher1@asd.com |",
      "11:       | noneditor1 | Non-editing teacher | 1 | noneditor1@asd.com |",
      "12:       | noneditor2 | Non-editing teacher | 2 | noneditor2@asd.com |",
      "13:       | student1 | Student | 1 | student1@asd.com |",
      "14:     And the following \"courses\" exist:",
      "15:       | fullname | shortname | category |",
      "16:       | Course 1 | C1 | 0 |",
      "17:     And the following \"course enrolments\" exist:",
      "18:       | user | course | role |",
      "19:       | teacher1 | C1 | editingteacher |",
      "20:       | noneditor1 | C1 | teacher |",
      "21:       | noneditor2 | C1 | teacher |",
      "22:       | student1 | C1 | student |",
      "23:     And the following \"groups\" exist:",
      "24:       | name | course | idnumber |",
      "25:       | Group A | C1 | G1 |",
      "26:       | Group B | C1 | G2 |",
      "27:       | Group C | C1 | G3 |",
      "28:     And the following \"group members\" exist:",
      "29:       | user | group |",
      "30:       | teacher1 | G1 |",
      "31:       | teacher1 | G2 |",
      "32:       | noneditor1 | G1 |",
      "33:       | noneditor1 | G2 |",
      "34:       | noneditor1 | G3 |",
      "35:       | noneditor2 | G1 |",
      "36:       | noneditor2 | G2 |",
      "37:       | student1 | G1 |",
      "38:       | student1 | G2 |",
      "39:     And I log in as \"teacher1\"",
      "40:     And I follow \"Course 1\"",
      "41:     And I turn editing mode on",
      "42:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
      "43:       | Forum name | Standard forum name |",
      "44:       | Forum type | Standard forum for general use |",
      "45:       | Description | Standard forum description |",
      "46:       | Group mode | Separate groups |",
      "47:     And I log out",
      "49:   Scenario: Teacher with accessallgroups can post in all groups",
      "50:     Given I log in as \"teacher1\"",
      "51:     And I follow \"Course 1\"",
      "52:     And I follow \"Standard forum name\"",
      "53:     When I click on \"Add a new discussion topic\" \"button\"",
      "54:     Then the \"Group\" select box should contain \"All participants\"",
      "55:     And the \"Group\" select box should contain \"Group A\"",
      "56:     And the \"Group\" select box should contain \"Group B\"",
      "58:   @javascript",
      "59:   Scenario: Teacher in all groups but without accessallgroups can only post in their groups",
      "60:     And I log in as \"admin\"",
      "61:     And I set the following system permissions of \"Non-editing teacher\" role:",
      "62:       | moodle/site:accessallgroups | Prohibit |",
      "63:     And I log out",
      "64:     Given I log in as \"noneditor1\"",
      "65:     And I follow \"Course 1\"",
      "66:     And I follow \"Standard forum name\"",
      "67:     When I click on \"Add a new discussion topic\" \"button\"",
      "68:     Then the \"Group\" select box should not contain \"All participants\"",
      "69:     And the \"Group\" select box should contain \"Group A\"",
      "70:     And the \"Group\" select box should contain \"Group B\"",
      "72:   @javascript",
      "73:   Scenario: Teacher in some groups and without accessallgroups can only post in their groups",
      "74:     And I log in as \"admin\"",
      "75:     And I set the following system permissions of \"Non-editing teacher\" role:",
      "76:       | moodle/site:accessallgroups | Prohibit |",
      "77:     And I log out",
      "78:     Given I log in as \"noneditor1\"",
      "79:     And I follow \"Course 1\"",
      "80:     And I follow \"Standard forum name\"",
      "81:     When I click on \"Add a new discussion topic\" \"button\"",
      "82:     Then the \"Group\" select box should not contain \"All participants\"",
      "83:     And the \"Group\" select box should contain \"Group A\"",
      "84:     And the \"Group\" select box should contain \"Group B\"",
      "",
      "---------------"
    ],
    "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature": [
      "File: mod/forum/tests/behat/separate_group_single_group_discussions.feature -> mod/forum/tests/behat/separate_group_single_group_discussions.feature",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: @mod @mod_forum",
      "2: Feature: Posting to groups in a separate group discussion when restricted to groupings",
      "3:   In order to post to groups in a forum with separate groups and groupings",
      "4:   As a teacher",
      "5:   I need to have groups configured to post to a group",
      "7:   Background:",
      "8:     Given the following \"users\" exist:",
      "9:       | username | firstname | lastname | email            |",
      "10:       | teacher1 | teacher1  | teacher1 | teacher1@asd.com |",
      "11:     And the following \"courses\" exist:",
      "12:       | fullname | shortname | category |",
      "13:       | Course 1 | C1 | 0 |",
      "14:     And the following \"course enrolments\" exist:",
      "15:       | user | course | role |",
      "16:       | teacher1 | C1 | teacher |",
      "17:     And the following \"groups\" exist:",
      "18:       | name | course | idnumber |",
      "19:       | G1G1 | C1 | G1G1 |",
      "20:       | G1G2 | C1 | G1G2 |",
      "21:       | G2G1 | C1 | G2G1 |",
      "22:     And the following \"groupings\" exist:",
      "23:       | name | course | idnumber |",
      "24:       | G1   | C1     | G1       |",
      "25:       | G2   | C1     | G2       |",
      "26:     And the following \"group members\" exist:",
      "27:       | user        | group |",
      "28:       | teacher1    | G1G1  |",
      "29:       | teacher1    | G1G2  |",
      "30:       | teacher1    | G2G1  |",
      "31:     And the following \"grouping groups\" exist:",
      "32:       | grouping | group |",
      "33:       | G1       | G1G1    |",
      "34:       | G1       | G1G2    |",
      "35:       | G2       | G2G1    |",
      "36:     And I log in as \"admin\"",
      "37:     And I follow \"Course 1\"",
      "38:     And I turn editing mode on",
      "39:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
      "40:       | Forum name  | Multiple groups forum             |",
      "41:       | Forum type  | Standard forum for general use    |",
      "42:       | Description | Standard forum description        |",
      "43:       | Group mode  | Separate groups                   |",
      "44:       | Grouping    | G1                                |",
      "45:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
      "46:       | Forum name  | Single groups forum               |",
      "47:       | Forum type  | Standard forum for general use    |",
      "48:       | Description | Standard forum description        |",
      "49:       | Group mode  | Separate groups                   |",
      "50:       | Grouping    | G2                                |",
      "51:     And I log out",
      "53:   Scenario: Teacher with accessallgroups can post in all groups",
      "54:     Given I log in as \"teacher1\"",
      "55:     And I follow \"Course 1\"",
      "56:     And I follow \"Multiple groups forum\"",
      "57:     When I click on \"Add a new discussion topic\" \"button\"",
      "58:     Then the \"Group\" select box should contain \"All participants\"",
      "59:     And the \"Group\" select box should contain \"G1G1\"",
      "60:     And the \"Group\" select box should contain \"G1G2\"",
      "61:     And I follow \"Course 1\"",
      "62:     And I follow \"Single groups forum\"",
      "63:     And I click on \"Add a new discussion topic\" \"button\"",
      "64:     And the \"Group\" select box should contain \"All participants\"",
      "65:     And the \"Group\" select box should contain \"G2G1\"",
      "67:   @javascript",
      "68:   Scenario: Teacher in all groups but without accessallgroups can post in either group but not to All Participants",
      "69:     And I log in as \"admin\"",
      "70:     And I set the following system permissions of \"Non-editing teacher\" role:",
      "71:       | moodle/site:accessallgroups | Prohibit |",
      "72:     And I log out",
      "73:     Given I log in as \"teacher1\"",
      "74:     And I follow \"Course 1\"",
      "75:     And I follow \"Multiple groups forum\"",
      "76:     When I click on \"Add a new discussion topic\" \"button\"",
      "77:     Then the \"Group\" select box should not contain \"All participants\"",
      "78:     And the \"Group\" select box should contain \"G1G1\"",
      "79:     And the \"Group\" select box should contain \"G1G2\"",
      "80:     And I follow \"Course 1\"",
      "81:     And I follow \"Single groups forum\"",
      "82:     And I click on \"Add a new discussion topic\" \"button\"",
      "83:     And I should see \"G2G1\"",
      "84:     And \"Group\" \"select\" should not exist",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5c74e0daca748ffbbbf17a410abd8c85335b2116",
      "candidate_info": {
        "commit_hash": "5c74e0daca748ffbbbf17a410abd8c85335b2116",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5c74e0daca748ffbbbf17a410abd8c85335b2116",
        "files": [
          "mod/forum/classes/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ],
        "message": "MDL-38990 mod_forum: Restrict ability to post to all groups in a forum\n\nIn order to post to all groups in a forum, you must have the\nmoodle/site:accessallgroups capability.\n\nThanks to Jakob Ackermann <jackermann@onlineschool.ca> for part of the fix\non this one.",
        "before_after_code_files": [
          "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ],
          "candidate": [
            "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php": [
          "File: mod/forum/classes/post_form.php -> mod/forum/classes/post_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "162:             $mform->setConstants(array('timestart'=> 0, 'timeend'=>0));",
          "163:         }",
          "166:             $groupdata = groups_get_activity_allowed_groups($cm);",
          "167:             $groupcount = count($groupdata);",
          "168:             $modulecontext = context_module::instance($cm->id);",
          "171:                 $groupinfo = array('0' => get_string('allparticipants'));",
          "172:                 foreach ($groupdata as $grouptemp) {",
          "173:                     $groupinfo[$grouptemp->id] = $grouptemp->name;",
          "174:                 }",
          "",
          "[Removed Lines]",
          "165:         if (groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "169:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount;",
          "170:             if ($contextcheck) {",
          "",
          "[Added Lines]",
          "165:         if ($groupmode = groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "168:             $groupinfo = array();",
          "172:             if ($groupmode == VISIBLEGROUPS || has_capability('moodle/site:accessallgroups', $modulecontext)) {",
          "175:                 $groupcount++;",
          "176:             }",
          "178:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount > 1;",
          "179:             if ($contextcheck) {",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_discussions.feature -> mod/forum/tests/behat/separate_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to all groups in a separate group discussion is restricted to users with access to all groups",
          "3:   In order to post to all groups in a forum with separate groups",
          "4:   As a teacher",
          "5:   I need to have the accessallgroups capability or be a member of all of the groups",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email |",
          "10:       | teacher1 | Teacher | 1 | teacher1@asd.com |",
          "11:       | noneditor1 | Non-editing teacher | 1 | noneditor1@asd.com |",
          "12:       | noneditor2 | Non-editing teacher | 2 | noneditor2@asd.com |",
          "13:       | student1 | Student | 1 | student1@asd.com |",
          "14:     And the following \"courses\" exist:",
          "15:       | fullname | shortname | category |",
          "16:       | Course 1 | C1 | 0 |",
          "17:     And the following \"course enrolments\" exist:",
          "18:       | user | course | role |",
          "19:       | teacher1 | C1 | editingteacher |",
          "20:       | noneditor1 | C1 | teacher |",
          "21:       | noneditor2 | C1 | teacher |",
          "22:       | student1 | C1 | student |",
          "23:     And the following \"groups\" exist:",
          "24:       | name | course | idnumber |",
          "25:       | Group A | C1 | G1 |",
          "26:       | Group B | C1 | G2 |",
          "27:       | Group C | C1 | G3 |",
          "28:     And the following \"group members\" exist:",
          "29:       | user | group |",
          "30:       | teacher1 | G1 |",
          "31:       | teacher1 | G2 |",
          "32:       | noneditor1 | G1 |",
          "33:       | noneditor1 | G2 |",
          "34:       | noneditor1 | G3 |",
          "35:       | noneditor2 | G1 |",
          "36:       | noneditor2 | G2 |",
          "37:       | student1 | G1 |",
          "38:       | student1 | G2 |",
          "39:     And I log in as \"teacher1\"",
          "40:     And I follow \"Course 1\"",
          "41:     And I turn editing mode on",
          "42:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "43:       | Forum name | Standard forum name |",
          "44:       | Forum type | Standard forum for general use |",
          "45:       | Description | Standard forum description |",
          "46:       | Group mode | Separate groups |",
          "47:     And I log out",
          "49:   Scenario: Teacher with accessallgroups can post in all groups",
          "50:     Given I log in as \"teacher1\"",
          "51:     And I follow \"Course 1\"",
          "52:     And I follow \"Standard forum name\"",
          "53:     When I click on \"Add a new discussion topic\" \"button\"",
          "54:     Then the \"Group\" select box should contain \"All participants\"",
          "55:     And the \"Group\" select box should contain \"Group A\"",
          "56:     And the \"Group\" select box should contain \"Group B\"",
          "58:   @javascript",
          "59:   Scenario: Teacher in all groups but without accessallgroups can only post in their groups",
          "60:     And I log in as \"admin\"",
          "61:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "62:       | moodle/site:accessallgroups | Prohibit |",
          "63:     And I log out",
          "64:     Given I log in as \"noneditor1\"",
          "65:     And I follow \"Course 1\"",
          "66:     And I follow \"Standard forum name\"",
          "67:     When I click on \"Add a new discussion topic\" \"button\"",
          "68:     Then the \"Group\" select box should not contain \"All participants\"",
          "69:     And the \"Group\" select box should contain \"Group A\"",
          "70:     And the \"Group\" select box should contain \"Group B\"",
          "72:   @javascript",
          "73:   Scenario: Teacher in some groups and without accessallgroups can only post in their groups",
          "74:     And I log in as \"admin\"",
          "75:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "76:       | moodle/site:accessallgroups | Prohibit |",
          "77:     And I log out",
          "78:     Given I log in as \"noneditor1\"",
          "79:     And I follow \"Course 1\"",
          "80:     And I follow \"Standard forum name\"",
          "81:     When I click on \"Add a new discussion topic\" \"button\"",
          "82:     Then the \"Group\" select box should not contain \"All participants\"",
          "83:     And the \"Group\" select box should contain \"Group A\"",
          "84:     And the \"Group\" select box should contain \"Group B\"",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_single_group_discussions.feature -> mod/forum/tests/behat/separate_group_single_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to groups in a separate group discussion when restricted to groupings",
          "3:   In order to post to groups in a forum with separate groups and groupings",
          "4:   As a teacher",
          "5:   I need to have groups configured to post to a group",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email            |",
          "10:       | teacher1 | teacher1  | teacher1 | teacher1@asd.com |",
          "11:     And the following \"courses\" exist:",
          "12:       | fullname | shortname | category |",
          "13:       | Course 1 | C1 | 0 |",
          "14:     And the following \"course enrolments\" exist:",
          "15:       | user | course | role |",
          "16:       | teacher1 | C1 | teacher |",
          "17:     And the following \"groups\" exist:",
          "18:       | name | course | idnumber |",
          "19:       | G1G1 | C1 | G1G1 |",
          "20:       | G1G2 | C1 | G1G2 |",
          "21:       | G2G1 | C1 | G2G1 |",
          "22:     And the following \"groupings\" exist:",
          "23:       | name | course | idnumber |",
          "24:       | G1   | C1     | G1       |",
          "25:       | G2   | C1     | G2       |",
          "26:     And the following \"group members\" exist:",
          "27:       | user        | group |",
          "28:       | teacher1    | G1G1  |",
          "29:       | teacher1    | G1G2  |",
          "30:       | teacher1    | G2G1  |",
          "31:     And the following \"grouping groups\" exist:",
          "32:       | grouping | group |",
          "33:       | G1       | G1G1    |",
          "34:       | G1       | G1G2    |",
          "35:       | G2       | G2G1    |",
          "36:     And I log in as \"admin\"",
          "37:     And I follow \"Course 1\"",
          "38:     And I turn editing mode on",
          "39:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "40:       | Forum name  | Multiple groups forum             |",
          "41:       | Forum type  | Standard forum for general use    |",
          "42:       | Description | Standard forum description        |",
          "43:       | Group mode  | Separate groups                   |",
          "44:       | Grouping    | G1                                |",
          "45:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "46:       | Forum name  | Single groups forum               |",
          "47:       | Forum type  | Standard forum for general use    |",
          "48:       | Description | Standard forum description        |",
          "49:       | Group mode  | Separate groups                   |",
          "50:       | Grouping    | G2                                |",
          "51:     And I log out",
          "53:   Scenario: Teacher with accessallgroups can post in all groups",
          "54:     Given I log in as \"teacher1\"",
          "55:     And I follow \"Course 1\"",
          "56:     And I follow \"Multiple groups forum\"",
          "57:     When I click on \"Add a new discussion topic\" \"button\"",
          "58:     Then the \"Group\" select box should contain \"All participants\"",
          "59:     And the \"Group\" select box should contain \"G1G1\"",
          "60:     And the \"Group\" select box should contain \"G1G2\"",
          "61:     And I follow \"Course 1\"",
          "62:     And I follow \"Single groups forum\"",
          "63:     And I click on \"Add a new discussion topic\" \"button\"",
          "64:     And the \"Group\" select box should contain \"All participants\"",
          "65:     And the \"Group\" select box should contain \"G2G1\"",
          "67:   @javascript",
          "68:   Scenario: Teacher in all groups but without accessallgroups can post in either group but not to All Participants",
          "69:     And I log in as \"admin\"",
          "70:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "71:       | moodle/site:accessallgroups | Prohibit |",
          "72:     And I log out",
          "73:     Given I log in as \"teacher1\"",
          "74:     And I follow \"Course 1\"",
          "75:     And I follow \"Multiple groups forum\"",
          "76:     When I click on \"Add a new discussion topic\" \"button\"",
          "77:     Then the \"Group\" select box should not contain \"All participants\"",
          "78:     And the \"Group\" select box should contain \"G1G1\"",
          "79:     And the \"Group\" select box should contain \"G1G2\"",
          "80:     And I follow \"Course 1\"",
          "81:     And I follow \"Single groups forum\"",
          "82:     And I click on \"Add a new discussion topic\" \"button\"",
          "83:     And I should see \"G2G1\"",
          "84:     And \"Group\" \"select\" should not exist",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e3fd900dcda7b603d7e0749008abd0d01290bbc3",
      "candidate_info": {
        "commit_hash": "e3fd900dcda7b603d7e0749008abd0d01290bbc3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e3fd900dcda7b603d7e0749008abd0d01290bbc3",
        "files": [
          "mod/forum/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ],
        "message": "MDL-38990 mod_forum: Restrict ability to post to all groups in a forum\n\nIn order to post to all groups in a forum, you must have the\nmoodle/site:accessallgroups capability.\n\nThanks to Jakob Ackermann <jackermann@onlineschool.ca> for part of the fix\non this one.",
        "before_after_code_files": [
          "mod/forum/post_form.php||mod/forum/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ],
          "candidate": [
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/post_form.php||mod/forum/post_form.php": [
          "File: mod/forum/post_form.php -> mod/forum/post_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "147:             $mform->setConstants(array('timestart'=> 0, 'timeend'=>0));",
          "148:         }",
          "151:             $groupdata = groups_get_activity_allowed_groups($cm);",
          "152:             $groupcount = count($groupdata);",
          "153:             $modulecontext = context_module::instance($cm->id);",
          "156:                 $groupinfo = array('0' => get_string('allparticipants'));",
          "157:                 foreach ($groupdata as $grouptemp) {",
          "158:                     $groupinfo[$grouptemp->id] = $grouptemp->name;",
          "159:                 }",
          "",
          "[Removed Lines]",
          "150:         if (groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "154:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount;",
          "155:             if ($contextcheck) {",
          "",
          "[Added Lines]",
          "150:         if ($groupmode = groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "153:             $groupinfo = array();",
          "157:             if ($groupmode == VISIBLEGROUPS || has_capability('moodle/site:accessallgroups', $modulecontext)) {",
          "160:                 $groupcount++;",
          "161:             }",
          "163:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount > 1;",
          "164:             if ($contextcheck) {",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_discussions.feature -> mod/forum/tests/behat/separate_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to all groups in a separate group discussion is restricted to users with access to all groups",
          "3:   In order to post to all groups in a forum with separate groups",
          "4:   As a teacher",
          "5:   I need to have the accessallgroups capability or be a member of all of the groups",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email |",
          "10:       | teacher1 | Teacher | 1 | teacher1@asd.com |",
          "11:       | noneditor1 | Non-editing teacher | 1 | noneditor1@asd.com |",
          "12:       | noneditor2 | Non-editing teacher | 2 | noneditor2@asd.com |",
          "13:       | student1 | Student | 1 | student1@asd.com |",
          "14:     And the following \"courses\" exist:",
          "15:       | fullname | shortname | category |",
          "16:       | Course 1 | C1 | 0 |",
          "17:     And the following \"course enrolments\" exist:",
          "18:       | user | course | role |",
          "19:       | teacher1 | C1 | editingteacher |",
          "20:       | noneditor1 | C1 | teacher |",
          "21:       | noneditor2 | C1 | teacher |",
          "22:       | student1 | C1 | student |",
          "23:     And the following \"groups\" exist:",
          "24:       | name | course | idnumber |",
          "25:       | Group A | C1 | G1 |",
          "26:       | Group B | C1 | G2 |",
          "27:       | Group C | C1 | G3 |",
          "28:     And the following \"group members\" exist:",
          "29:       | user | group |",
          "30:       | teacher1 | G1 |",
          "31:       | teacher1 | G2 |",
          "32:       | noneditor1 | G1 |",
          "33:       | noneditor1 | G2 |",
          "34:       | noneditor1 | G3 |",
          "35:       | noneditor2 | G1 |",
          "36:       | noneditor2 | G2 |",
          "37:       | student1 | G1 |",
          "38:       | student1 | G2 |",
          "39:     And I log in as \"teacher1\"",
          "40:     And I follow \"Course 1\"",
          "41:     And I turn editing mode on",
          "42:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "43:       | Forum name | Standard forum name |",
          "44:       | Forum type | Standard forum for general use |",
          "45:       | Description | Standard forum description |",
          "46:       | Group mode | Separate groups |",
          "47:     And I log out",
          "49:   Scenario: Teacher with accessallgroups can post in all groups",
          "50:     Given I log in as \"teacher1\"",
          "51:     And I follow \"Course 1\"",
          "52:     And I follow \"Standard forum name\"",
          "53:     When I click on \"Add a new discussion topic\" \"button\"",
          "54:     Then the \"Group\" select box should contain \"All participants\"",
          "55:     And the \"Group\" select box should contain \"Group A\"",
          "56:     And the \"Group\" select box should contain \"Group B\"",
          "58:   @javascript",
          "59:   Scenario: Teacher in all groups but without accessallgroups can only post in their groups",
          "60:     And I log in as \"admin\"",
          "61:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "62:       | moodle/site:accessallgroups | Prohibit |",
          "63:     And I log out",
          "64:     Given I log in as \"noneditor1\"",
          "65:     And I follow \"Course 1\"",
          "66:     And I follow \"Standard forum name\"",
          "67:     When I click on \"Add a new discussion topic\" \"button\"",
          "68:     Then the \"Group\" select box should not contain \"All participants\"",
          "69:     And the \"Group\" select box should contain \"Group A\"",
          "70:     And the \"Group\" select box should contain \"Group B\"",
          "72:   @javascript",
          "73:   Scenario: Teacher in some groups and without accessallgroups can only post in their groups",
          "74:     And I log in as \"admin\"",
          "75:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "76:       | moodle/site:accessallgroups | Prohibit |",
          "77:     And I log out",
          "78:     Given I log in as \"noneditor1\"",
          "79:     And I follow \"Course 1\"",
          "80:     And I follow \"Standard forum name\"",
          "81:     When I click on \"Add a new discussion topic\" \"button\"",
          "82:     Then the \"Group\" select box should not contain \"All participants\"",
          "83:     And the \"Group\" select box should contain \"Group A\"",
          "84:     And the \"Group\" select box should contain \"Group B\"",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_single_group_discussions.feature -> mod/forum/tests/behat/separate_group_single_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to groups in a separate group discussion when restricted to groupings",
          "3:   In order to post to groups in a forum with separate groups and groupings",
          "4:   As a teacher",
          "5:   I need to have groups configured to post to a group",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email            |",
          "10:       | teacher1 | teacher1  | teacher1 | teacher1@asd.com |",
          "11:     And the following \"courses\" exist:",
          "12:       | fullname | shortname | category |",
          "13:       | Course 1 | C1 | 0 |",
          "14:     And the following \"course enrolments\" exist:",
          "15:       | user | course | role |",
          "16:       | teacher1 | C1 | teacher |",
          "17:     And the following \"groups\" exist:",
          "18:       | name | course | idnumber |",
          "19:       | G1G1 | C1 | G1G1 |",
          "20:       | G1G2 | C1 | G1G2 |",
          "21:       | G2G1 | C1 | G2G1 |",
          "22:     And the following \"groupings\" exist:",
          "23:       | name | course | idnumber |",
          "24:       | G1   | C1     | G1       |",
          "25:       | G2   | C1     | G2       |",
          "26:     And the following \"group members\" exist:",
          "27:       | user        | group |",
          "28:       | teacher1    | G1G1  |",
          "29:       | teacher1    | G1G2  |",
          "30:       | teacher1    | G2G1  |",
          "31:     And the following \"grouping groups\" exist:",
          "32:       | grouping | group |",
          "33:       | G1       | G1G1    |",
          "34:       | G1       | G1G2    |",
          "35:       | G2       | G2G1    |",
          "36:     And I log in as \"admin\"",
          "37:     And I follow \"Course 1\"",
          "38:     And I turn editing mode on",
          "39:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "40:       | Forum name  | Multiple groups forum             |",
          "41:       | Forum type  | Standard forum for general use    |",
          "42:       | Description | Standard forum description        |",
          "43:       | Group mode  | Separate groups                   |",
          "44:       | Grouping    | G1                                |",
          "45:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "46:       | Forum name  | Single groups forum               |",
          "47:       | Forum type  | Standard forum for general use    |",
          "48:       | Description | Standard forum description        |",
          "49:       | Group mode  | Separate groups                   |",
          "50:       | Grouping    | G2                                |",
          "51:     And I log out",
          "53:   Scenario: Teacher with accessallgroups can post in all groups",
          "54:     Given I log in as \"teacher1\"",
          "55:     And I follow \"Course 1\"",
          "56:     And I follow \"Multiple groups forum\"",
          "57:     When I click on \"Add a new discussion topic\" \"button\"",
          "58:     Then the \"Group\" select box should contain \"All participants\"",
          "59:     And the \"Group\" select box should contain \"G1G1\"",
          "60:     And the \"Group\" select box should contain \"G1G2\"",
          "61:     And I follow \"Course 1\"",
          "62:     And I follow \"Single groups forum\"",
          "63:     And I click on \"Add a new discussion topic\" \"button\"",
          "64:     And the \"Group\" select box should contain \"All participants\"",
          "65:     And the \"Group\" select box should contain \"G2G1\"",
          "67:   @javascript",
          "68:   Scenario: Teacher in all groups but without accessallgroups can post in either group but not to All Participants",
          "69:     And I log in as \"admin\"",
          "70:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "71:       | moodle/site:accessallgroups | Prohibit |",
          "72:     And I log out",
          "73:     Given I log in as \"teacher1\"",
          "74:     And I follow \"Course 1\"",
          "75:     And I follow \"Multiple groups forum\"",
          "76:     When I click on \"Add a new discussion topic\" \"button\"",
          "77:     Then the \"Group\" select box should not contain \"All participants\"",
          "78:     And the \"Group\" select box should contain \"G1G1\"",
          "79:     And the \"Group\" select box should contain \"G1G2\"",
          "80:     And I follow \"Course 1\"",
          "81:     And I follow \"Single groups forum\"",
          "82:     And I click on \"Add a new discussion topic\" \"button\"",
          "83:     And I should see \"G2G1\"",
          "84:     And \"Group\" \"select\" should not exist",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "91c8d4da71a6706c70071f9182e8ae6110c86d70",
      "candidate_info": {
        "commit_hash": "91c8d4da71a6706c70071f9182e8ae6110c86d70",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/91c8d4da71a6706c70071f9182e8ae6110c86d70",
        "files": [
          "mod/forum/classes/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ],
        "message": "MDL-38990 mod_forum: Restrict ability to post to all groups in a forum\n\nIn order to post to all groups in a forum, you must have the\nmoodle/site:accessallgroups capability.\n\nThanks to Jakob Ackermann <jackermann@onlineschool.ca> for part of the fix\non this one.",
        "before_after_code_files": [
          "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
          "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
          "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ],
          "candidate": [
            "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php",
            "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature",
            "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/classes/post_form.php||mod/forum/classes/post_form.php": [
          "File: mod/forum/classes/post_form.php -> mod/forum/classes/post_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "162:             $mform->setConstants(array('timestart'=> 0, 'timeend'=>0));",
          "163:         }",
          "166:             $groupdata = groups_get_activity_allowed_groups($cm);",
          "167:             $groupcount = count($groupdata);",
          "168:             $modulecontext = context_module::instance($cm->id);",
          "171:                 $groupinfo = array('0' => get_string('allparticipants'));",
          "172:                 foreach ($groupdata as $grouptemp) {",
          "173:                     $groupinfo[$grouptemp->id] = $grouptemp->name;",
          "174:                 }",
          "",
          "[Removed Lines]",
          "165:         if (groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "169:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount;",
          "170:             if ($contextcheck) {",
          "",
          "[Added Lines]",
          "165:         if ($groupmode = groups_get_activity_groupmode($cm, $course)) { // hack alert",
          "168:             $groupinfo = array();",
          "172:             if ($groupmode == VISIBLEGROUPS || has_capability('moodle/site:accessallgroups', $modulecontext)) {",
          "175:                 $groupcount++;",
          "176:             }",
          "178:             $contextcheck = has_capability('mod/forum:movediscussions', $modulecontext) && empty($post->parent) && $groupcount > 1;",
          "179:             if ($contextcheck) {",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_discussions.feature||mod/forum/tests/behat/separate_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_discussions.feature -> mod/forum/tests/behat/separate_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to all groups in a separate group discussion is restricted to users with access to all groups",
          "3:   In order to post to all groups in a forum with separate groups",
          "4:   As a teacher",
          "5:   I need to have the accessallgroups capability or be a member of all of the groups",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email |",
          "10:       | teacher1 | Teacher | 1 | teacher1@asd.com |",
          "11:       | noneditor1 | Non-editing teacher | 1 | noneditor1@asd.com |",
          "12:       | noneditor2 | Non-editing teacher | 2 | noneditor2@asd.com |",
          "13:       | student1 | Student | 1 | student1@asd.com |",
          "14:     And the following \"courses\" exist:",
          "15:       | fullname | shortname | category |",
          "16:       | Course 1 | C1 | 0 |",
          "17:     And the following \"course enrolments\" exist:",
          "18:       | user | course | role |",
          "19:       | teacher1 | C1 | editingteacher |",
          "20:       | noneditor1 | C1 | teacher |",
          "21:       | noneditor2 | C1 | teacher |",
          "22:       | student1 | C1 | student |",
          "23:     And the following \"groups\" exist:",
          "24:       | name | course | idnumber |",
          "25:       | Group A | C1 | G1 |",
          "26:       | Group B | C1 | G2 |",
          "27:       | Group C | C1 | G3 |",
          "28:     And the following \"group members\" exist:",
          "29:       | user | group |",
          "30:       | teacher1 | G1 |",
          "31:       | teacher1 | G2 |",
          "32:       | noneditor1 | G1 |",
          "33:       | noneditor1 | G2 |",
          "34:       | noneditor1 | G3 |",
          "35:       | noneditor2 | G1 |",
          "36:       | noneditor2 | G2 |",
          "37:       | student1 | G1 |",
          "38:       | student1 | G2 |",
          "39:     And I log in as \"teacher1\"",
          "40:     And I follow \"Course 1\"",
          "41:     And I turn editing mode on",
          "42:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "43:       | Forum name | Standard forum name |",
          "44:       | Forum type | Standard forum for general use |",
          "45:       | Description | Standard forum description |",
          "46:       | Group mode | Separate groups |",
          "47:     And I log out",
          "49:   Scenario: Teacher with accessallgroups can post in all groups",
          "50:     Given I log in as \"teacher1\"",
          "51:     And I follow \"Course 1\"",
          "52:     And I follow \"Standard forum name\"",
          "53:     When I click on \"Add a new discussion topic\" \"button\"",
          "54:     Then the \"Group\" select box should contain \"All participants\"",
          "55:     And the \"Group\" select box should contain \"Group A\"",
          "56:     And the \"Group\" select box should contain \"Group B\"",
          "58:   @javascript",
          "59:   Scenario: Teacher in all groups but without accessallgroups can only post in their groups",
          "60:     And I log in as \"admin\"",
          "61:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "62:       | moodle/site:accessallgroups | Prohibit |",
          "63:     And I log out",
          "64:     Given I log in as \"noneditor1\"",
          "65:     And I follow \"Course 1\"",
          "66:     And I follow \"Standard forum name\"",
          "67:     When I click on \"Add a new discussion topic\" \"button\"",
          "68:     Then the \"Group\" select box should not contain \"All participants\"",
          "69:     And the \"Group\" select box should contain \"Group A\"",
          "70:     And the \"Group\" select box should contain \"Group B\"",
          "72:   @javascript",
          "73:   Scenario: Teacher in some groups and without accessallgroups can only post in their groups",
          "74:     And I log in as \"admin\"",
          "75:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "76:       | moodle/site:accessallgroups | Prohibit |",
          "77:     And I log out",
          "78:     Given I log in as \"noneditor1\"",
          "79:     And I follow \"Course 1\"",
          "80:     And I follow \"Standard forum name\"",
          "81:     When I click on \"Add a new discussion topic\" \"button\"",
          "82:     Then the \"Group\" select box should not contain \"All participants\"",
          "83:     And the \"Group\" select box should contain \"Group A\"",
          "84:     And the \"Group\" select box should contain \"Group B\"",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/separate_group_single_group_discussions.feature||mod/forum/tests/behat/separate_group_single_group_discussions.feature": [
          "File: mod/forum/tests/behat/separate_group_single_group_discussions.feature -> mod/forum/tests/behat/separate_group_single_group_discussions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_forum",
          "2: Feature: Posting to groups in a separate group discussion when restricted to groupings",
          "3:   In order to post to groups in a forum with separate groups and groupings",
          "4:   As a teacher",
          "5:   I need to have groups configured to post to a group",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email            |",
          "10:       | teacher1 | teacher1  | teacher1 | teacher1@asd.com |",
          "11:     And the following \"courses\" exist:",
          "12:       | fullname | shortname | category |",
          "13:       | Course 1 | C1 | 0 |",
          "14:     And the following \"course enrolments\" exist:",
          "15:       | user | course | role |",
          "16:       | teacher1 | C1 | teacher |",
          "17:     And the following \"groups\" exist:",
          "18:       | name | course | idnumber |",
          "19:       | G1G1 | C1 | G1G1 |",
          "20:       | G1G2 | C1 | G1G2 |",
          "21:       | G2G1 | C1 | G2G1 |",
          "22:     And the following \"groupings\" exist:",
          "23:       | name | course | idnumber |",
          "24:       | G1   | C1     | G1       |",
          "25:       | G2   | C1     | G2       |",
          "26:     And the following \"group members\" exist:",
          "27:       | user        | group |",
          "28:       | teacher1    | G1G1  |",
          "29:       | teacher1    | G1G2  |",
          "30:       | teacher1    | G2G1  |",
          "31:     And the following \"grouping groups\" exist:",
          "32:       | grouping | group |",
          "33:       | G1       | G1G1    |",
          "34:       | G1       | G1G2    |",
          "35:       | G2       | G2G1    |",
          "36:     And I log in as \"admin\"",
          "37:     And I follow \"Course 1\"",
          "38:     And I turn editing mode on",
          "39:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "40:       | Forum name  | Multiple groups forum             |",
          "41:       | Forum type  | Standard forum for general use    |",
          "42:       | Description | Standard forum description        |",
          "43:       | Group mode  | Separate groups                   |",
          "44:       | Grouping    | G1                                |",
          "45:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "46:       | Forum name  | Single groups forum               |",
          "47:       | Forum type  | Standard forum for general use    |",
          "48:       | Description | Standard forum description        |",
          "49:       | Group mode  | Separate groups                   |",
          "50:       | Grouping    | G2                                |",
          "51:     And I log out",
          "53:   Scenario: Teacher with accessallgroups can post in all groups",
          "54:     Given I log in as \"teacher1\"",
          "55:     And I follow \"Course 1\"",
          "56:     And I follow \"Multiple groups forum\"",
          "57:     When I click on \"Add a new discussion topic\" \"button\"",
          "58:     Then the \"Group\" select box should contain \"All participants\"",
          "59:     And the \"Group\" select box should contain \"G1G1\"",
          "60:     And the \"Group\" select box should contain \"G1G2\"",
          "61:     And I follow \"Course 1\"",
          "62:     And I follow \"Single groups forum\"",
          "63:     And I click on \"Add a new discussion topic\" \"button\"",
          "64:     And the \"Group\" select box should contain \"All participants\"",
          "65:     And the \"Group\" select box should contain \"G2G1\"",
          "67:   @javascript",
          "68:   Scenario: Teacher in all groups but without accessallgroups can post in either group but not to All Participants",
          "69:     And I log in as \"admin\"",
          "70:     And I set the following system permissions of \"Non-editing teacher\" role:",
          "71:       | moodle/site:accessallgroups | Prohibit |",
          "72:     And I log out",
          "73:     Given I log in as \"teacher1\"",
          "74:     And I follow \"Course 1\"",
          "75:     And I follow \"Multiple groups forum\"",
          "76:     When I click on \"Add a new discussion topic\" \"button\"",
          "77:     Then the \"Group\" select box should not contain \"All participants\"",
          "78:     And the \"Group\" select box should contain \"G1G1\"",
          "79:     And the \"Group\" select box should contain \"G1G2\"",
          "80:     And I follow \"Course 1\"",
          "81:     And I follow \"Single groups forum\"",
          "82:     And I click on \"Add a new discussion topic\" \"button\"",
          "83:     And I should see \"G2G1\"",
          "84:     And \"Group\" \"select\" should not exist",
          "",
          "---------------"
        ]
      }
    }
  ]
}