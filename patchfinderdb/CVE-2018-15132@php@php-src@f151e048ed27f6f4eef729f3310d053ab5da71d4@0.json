{
  "cve_id": "CVE-2018-15132",
  "cve_desc": "An issue was discovered in ext/standard/link_win32.c in PHP before 5.6.37, 7.0.x before 7.0.31, 7.1.x before 7.1.20, and 7.2.x before 7.2.8. The linkinfo function on Windows doesn't implement the open_basedir check. This could be abused to find files on paths outside of the allowed directories.",
  "repo": "php/php-src",
  "patch_hash": "f151e048ed27f6f4eef729f3310d053ab5da71d4",
  "patch_info": {
    "commit_hash": "f151e048ed27f6f4eef729f3310d053ab5da71d4",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/f151e048ed27f6f4eef729f3310d053ab5da71d4",
    "files": [
      "ext/standard/link_win32.c"
    ],
    "message": "Fixed bug #76459 windows linkinfo lacks openbasedir check",
    "before_after_code_files": [
      "ext/standard/link_win32.c||ext/standard/link_win32.c"
    ]
  },
  "patch_diff": {
    "ext/standard/link_win32.c||ext/standard/link_win32.c": [
      "File: ext/standard/link_win32.c -> ext/standard/link_win32.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "87: PHP_FUNCTION(linkinfo)",
      "88: {",
      "89:  char *link;",
      "90:  size_t link_len;",
      "91:  zend_stat_t sb;",
      "92:  int ret;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "90:  char *dirname;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "95:   return;",
      "96:  }",
      "98:  ret = VCWD_STAT(link, &sb);",
      "99:  if (ret == -1) {",
      "100:   php_error_docref(NULL, E_WARNING, \"%s\", strerror(errno));",
      "101:   RETURN_LONG(Z_L(-1));",
      "102:  }",
      "104:  RETURN_LONG((zend_long) sb.st_dev);",
      "105: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "99:  dirname = estrndup(link, link_len);",
      "100:  php_dirname(dirname, link_len);",
      "102:  if (php_check_open_basedir(dirname)) {",
      "103:   efree(dirname);",
      "104:   RETURN_FALSE;",
      "105:  }",
      "110:   efree(dirname);",
      "114:  efree(dirname);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "289cb0f77c28b80a779170711f5e4e92cdd4fbdb",
      "candidate_info": {
        "commit_hash": "289cb0f77c28b80a779170711f5e4e92cdd4fbdb",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/289cb0f77c28b80a779170711f5e4e92cdd4fbdb",
        "files": [
          "ext/standard/link_win32.c"
        ],
        "message": "Fixed bug #76459 windows linkinfo lacks openbasedir check",
        "before_after_code_files": [
          "ext/standard/link_win32.c||ext/standard/link_win32.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ],
          "candidate": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/link_win32.c||ext/standard/link_win32.c": [
          "File: ext/standard/link_win32.c -> ext/standard/link_win32.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "87: PHP_FUNCTION(linkinfo)",
          "88: {",
          "89:  char *link;",
          "91:  struct stat sb;",
          "92:  int ret;",
          "",
          "[Removed Lines]",
          "90:  int link_len;",
          "",
          "[Added Lines]",
          "90:  char *dirname;",
          "91:  int link_len, dir_len;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:   return;",
          "96:  }",
          "98:  ret = VCWD_STAT(link, &sb);",
          "99:  if (ret == -1) {",
          "100:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"%s\", strerror(errno));",
          "101:   RETURN_LONG(-1L);",
          "102:  }",
          "104:  RETURN_LONG((long) sb.st_dev);",
          "105: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99:  dirname = estrndup(link, link_len);",
          "100:  dir_len = php_dirname(dirname, link_len);",
          "102:  if (php_check_open_basedir(dirname TSRMLS_CC)) {",
          "103:   efree(dirname);",
          "104:   RETURN_FALSE;",
          "105:  }",
          "110:   efree(dirname);",
          "114:  efree(dirname);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2fa74ad7c4f7f716183860e81489490b83277ccc",
      "candidate_info": {
        "commit_hash": "2fa74ad7c4f7f716183860e81489490b83277ccc",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/2fa74ad7c4f7f716183860e81489490b83277ccc",
        "files": [
          "ext/standard/link_win32.c"
        ],
        "message": "Fixed bug #76459 windows linkinfo lacks openbasedir check",
        "before_after_code_files": [
          "ext/standard/link_win32.c||ext/standard/link_win32.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ],
          "candidate": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/link_win32.c||ext/standard/link_win32.c": [
          "File: ext/standard/link_win32.c -> ext/standard/link_win32.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "87: PHP_FUNCTION(linkinfo)",
          "88: {",
          "89:  char *link;",
          "90:  size_t link_len;",
          "91:  zend_stat_t sb;",
          "92:  int ret;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "90:  char *dirname;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:   return;",
          "96:  }",
          "98:  ret = VCWD_STAT(link, &sb);",
          "99:  if (ret == -1) {",
          "100:   php_error_docref(NULL, E_WARNING, \"%s\", strerror(errno));",
          "101:   RETURN_LONG(Z_L(-1));",
          "102:  }",
          "104:  RETURN_LONG((zend_long) sb.st_dev);",
          "105: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99:  dirname = estrndup(link, link_len);",
          "100:  php_dirname(dirname, link_len);",
          "102:  if (php_check_open_basedir(dirname)) {",
          "103:   efree(dirname);",
          "104:   RETURN_FALSE;",
          "105:  }",
          "110:   efree(dirname);",
          "114:  efree(dirname);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0a421c7f5820f11cc37e32edd60eb8f0f92eb754",
      "candidate_info": {
        "commit_hash": "0a421c7f5820f11cc37e32edd60eb8f0f92eb754",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/0a421c7f5820f11cc37e32edd60eb8f0f92eb754",
        "files": [
          "ext/exif/exif.c",
          "ext/exif/tests/bug76423.jpg",
          "ext/exif/tests/bug76423.phpt",
          "ext/exif/tests/bug76557.jpg",
          "ext/exif/tests/bug76557.phpt",
          "ext/standard/link_win32.c"
        ],
        "message": "Merge branch 'PHP-7.1' into PHP-7.2\n\n* PHP-7.1:\n  Fixed bug #76459 windows linkinfo lacks openbasedir check\n  Add NEWS\n  Fixed bug #76459 windows linkinfo lacks openbasedir check\n  Fix bug #76557: heap-buffer-overflow (READ of size 48) while reading exif data\n  Fix bug #76423 - Int Overflow lead to Heap OverFlow in exif_thumbnail_extract of exif.c",
        "before_after_code_files": [
          "ext/exif/exif.c||ext/exif/exif.c",
          "ext/exif/tests/bug76423.phpt||ext/exif/tests/bug76423.phpt",
          "ext/exif/tests/bug76557.phpt||ext/exif/tests/bug76557.phpt",
          "ext/standard/link_win32.c||ext/standard/link_win32.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ],
          "candidate": [
            "ext/standard/link_win32.c||ext/standard/link_win32.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/exif/exif.c||ext/exif/exif.c": [
          "File: ext/exif/exif.c -> ext/exif/exif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2944:   return;",
          "2945:  }",
          "2948:   EXIF_ERRLOG_THUMBEOF(ImageInfo)",
          "2949:   return;",
          "2950:  }",
          "",
          "[Removed Lines]",
          "2947:  if ((ImageInfo->Thumbnail.offset + ImageInfo->Thumbnail.size) > length) {",
          "",
          "[Added Lines]",
          "2947:  if (ImageInfo->Thumbnail.size > length",
          "2948:   || (ImageInfo->Thumbnail.offset + ImageInfo->Thumbnail.size) > length",
          "2949:   || ImageInfo->Thumbnail.offset > length - ImageInfo->Thumbnail.size",
          "2950:  ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3126: #endif",
          "3127:  const maker_note_type *maker_note;",
          "3128:  char *dir_start;",
          "3130:  for (i=0; i<=sizeof(maker_note_array)/sizeof(maker_note_type); i++) {",
          "3131:   if (i==sizeof(maker_note_array)/sizeof(maker_note_type)) {",
          "3132: #ifdef EXIF_DEBUG",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3132:  int data_len;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3180:  switch (maker_note->offset_mode) {",
          "3181:   case MN_OFFSET_MAKER:",
          "3182:    offset_base = value_ptr;",
          "3183:    break;",
          "3184: #ifdef KALLE_0",
          "3185:   case MN_OFFSET_GUESS:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3187:    data_len = value_len;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3197:     return FALSE;",
          "3198:    }",
          "3199:    offset_base = value_ptr + offset_diff;",
          "3200:    break;",
          "3201: #endif",
          "3202:   default:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3205:    data_len = value_len - offset_diff;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "3212:  for (de=0;de<NumDirEntries;de++) {",
          "3213:   if (!exif_process_IFD_TAG(ImageInfo, dir_start + 2 + 12 * de,",
          "3215:    return FALSE;",
          "3216:   }",
          "3217:  }",
          "",
          "[Removed Lines]",
          "3214:           offset_base, IFDlength, displacement, section_index, 0, maker_note->tag_table)) {",
          "",
          "[Added Lines]",
          "3220:           offset_base, data_len, displacement, section_index, 0, maker_note->tag_table)) {",
          "",
          "---------------"
        ],
        "ext/exif/tests/bug76423.phpt||ext/exif/tests/bug76423.phpt": [
          "File: ext/exif/tests/bug76423.phpt -> ext/exif/tests/bug76423.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #76423 (Int Overflow lead to Heap OverFlow in exif_thumbnail_extract of exif.c)",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!extension_loaded('exif')) die('skip exif extension not available');",
          "6: ?>",
          "7: --FILE--",
          "8: <?php",
          "9: exif_read_data(__DIR__ . '/bug76423.jpg', 0, true, true);",
          "10: ?>",
          "11: ===DONE===",
          "12: --EXPECTF--",
          "14: Warning: exif_read_data(%s.jpg): Thumbnail goes IFD boundary or end of file reached in %s on line %d",
          "16: Warning: exif_read_data(%s.jpg): File structure corrupted in %s on line %d",
          "18: Warning: exif_read_data(%s.jpg): Invalid JPEG file in %s on line %d",
          "19: ===DONE===",
          "",
          "---------------"
        ],
        "ext/exif/tests/bug76557.phpt||ext/exif/tests/bug76557.phpt": [
          "File: ext/exif/tests/bug76557.phpt -> ext/exif/tests/bug76557.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug 76557 (heap-buffer-overflow (READ of size 48) while reading exif data)",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded('exif')) print 'skip exif extension not available';?>",
          "5: --FILE--",
          "6: <?php",
          "7: var_dump(count(exif_read_data(dirname(__FILE__) . \"/bug76557.jpg\")));",
          "8: ?>",
          "9: DONE",
          "10: --EXPECTF--",
          "11: Warning: exif_read_data(bug76557.jpg): Process tag(x010F=Make       ): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "13: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "15: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "17: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "19: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "21: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "23: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "25: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "27: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "29: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "31: Warning: exif_read_data(bug76557.jpg): Process tag(x8769=Exif_IFD_Po): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "33: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "35: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "37: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "39: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "41: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "43: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "45: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "47: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "49: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "51: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "53: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "55: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "57: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "59: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "61: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "63: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "65: Warning: exif_read_data(bug76557.jpg): Process tag(x927C=MakerNote  ): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "67: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "69: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "71: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal format code 0x3030, suppose BYTE in %sbug76557.php on line %d",
          "73: Warning: exif_read_data(bug76557.jpg): Process tag(x3030=UndefinedTa): Illegal pointer offset(x30303030 + x30303030 = x60606060 > x00EE) in %sbug76557.php on line %d",
          "75: Warning: exif_read_data(bug76557.jpg): File structure corrupted in %sbug76557.php on line %d",
          "77: Warning: exif_read_data(bug76557.jpg): Invalid JPEG file in %sbug76557.php on line %d",
          "78: int(1)",
          "79: DONE",
          "",
          "---------------"
        ],
        "ext/standard/link_win32.c||ext/standard/link_win32.c": [
          "File: ext/standard/link_win32.c -> ext/standard/link_win32.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "87: PHP_FUNCTION(linkinfo)",
          "88: {",
          "89:  char *link;",
          "90:  size_t link_len;",
          "91:  zend_stat_t sb;",
          "92:  int ret;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "90:  char *dirname;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:   return;",
          "96:  }",
          "98:  ret = VCWD_STAT(link, &sb);",
          "99:  if (ret == -1) {",
          "100:   php_error_docref(NULL, E_WARNING, \"%s\", strerror(errno));",
          "101:   RETURN_LONG(Z_L(-1));",
          "102:  }",
          "104:  RETURN_LONG((zend_long) sb.st_dev);",
          "105: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99:  dirname = estrndup(link, link_len);",
          "100:  php_dirname(dirname, link_len);",
          "102:  if (php_check_open_basedir(dirname)) {",
          "103:   efree(dirname);",
          "104:   RETURN_FALSE;",
          "105:  }",
          "110:   efree(dirname);",
          "114:  efree(dirname);",
          "",
          "---------------"
        ]
      }
    }
  ]
}