{
  "cve_id": "CVE-2017-14170",
  "cve_desc": "In libavformat/mxfdec.c in FFmpeg 3.3.3 -> 2.4, a DoS in mxf_read_index_entry_array() due to lack of an EOF (End of File) check might cause huge CPU consumption. When a crafted MXF file, which claims a large \"nb_index_entries\" field in the header but does not contain sufficient backing data, is provided, the loop would consume huge CPU resources, since there is no EOF check inside the loop. Moreover, this big loop can be invoked multiple times if there is more than one applicable data segment in the crafted MXF file.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "900f39692ca0337a98a7cf047e4e2611071810c2",
  "patch_info": {
    "commit_hash": "900f39692ca0337a98a7cf047e4e2611071810c2",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/900f39692ca0337a98a7cf047e4e2611071810c2",
    "files": [
      "libavformat/mxfdec.c"
    ],
    "message": "avformat/mxfdec: Fix DoS issues in mxf_read_index_entry_array()\n\nFixes: 20170829A.mxf\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavformat/mxfdec.c||libavformat/mxfdec.c"
    ]
  },
  "patch_diff": {
    "libavformat/mxfdec.c||libavformat/mxfdec.c": [
      "File: libavformat/mxfdec.c -> libavformat/mxfdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "899:     segment->nb_index_entries = avio_rb32(pb);",
      "901:     length = avio_rb32(pb);",
      "903:     if (!(segment->temporal_offset_entries=av_calloc(segment->nb_index_entries, sizeof(*segment->temporal_offset_entries))) ||",
      "904:         !(segment->flag_entries          = av_calloc(segment->nb_index_entries, sizeof(*segment->flag_entries))) ||",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "902:     if(segment->nb_index_entries && length < 11)",
      "903:         return AVERROR_INVALIDDATA;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "909:     }",
      "911:     for (i = 0; i < segment->nb_index_entries; i++) {",
      "912:         segment->temporal_offset_entries[i] = avio_r8(pb);",
      "914:         segment->flag_entries[i] = avio_r8(pb);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "914:         if(avio_feof(pb))",
      "915:             return AVERROR_INVALIDDATA;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d6860265076607811de68e6ac03ad5df9dfdb681",
      "candidate_info": {
        "commit_hash": "d6860265076607811de68e6ac03ad5df9dfdb681",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/d6860265076607811de68e6ac03ad5df9dfdb681",
        "files": [
          "libavformat/mxfdec.c"
        ],
        "message": "avformat/mxfdec: Fix Sign error in mxf_read_primer_pack()\n\nFixes: 20170829B.mxf\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 9d00fb9d70ee8c0cc7002b89318c5be00f1bbdad)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/mxfdec.c||libavformat/mxfdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/mxfdec.c||libavformat/mxfdec.c"
          ],
          "candidate": [
            "libavformat/mxfdec.c||libavformat/mxfdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/mxfdec.c||libavformat/mxfdec.c": [
          "File: libavformat/mxfdec.c -> libavformat/mxfdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "491:         avpriv_request_sample(pb, \"Primer pack item length %d\", item_len);",
          "492:         return AVERROR_PATCHWELCOME;",
          "493:     }",
          "495:         av_log(mxf->fc, AV_LOG_ERROR, \"item_num %d is too large\\n\", item_num);",
          "496:         return AVERROR_INVALIDDATA;",
          "497:     }",
          "",
          "[Removed Lines]",
          "494:     if (item_num > 65536) {",
          "",
          "[Added Lines]",
          "494:     if (item_num > 65536 || item_num < 0) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5b3986023bbf3a8beb36d30ae580132b8bd66670",
      "candidate_info": {
        "commit_hash": "5b3986023bbf3a8beb36d30ae580132b8bd66670",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/5b3986023bbf3a8beb36d30ae580132b8bd66670",
        "files": [
          "libavformat/nsvdec.c"
        ],
        "message": "avformat/nsvdec: Fix DoS due to lack of eof check in nsvs_file_offset loop.\n\nFixes: 20170829.nsv\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit c24bcb553650b91e9eff15ef6e54ca73de2453b7)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/nsvdec.c||libavformat/nsvdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavformat/nsvdec.c||libavformat/nsvdec.c": [
          "File: libavformat/nsvdec.c -> libavformat/nsvdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "350:         if (!nsv->nsvs_file_offset)",
          "351:             return AVERROR(ENOMEM);",
          "354:             nsv->nsvs_file_offset[i] = avio_rl32(pb) + size;",
          "356:         if(table_entries > table_entries_used &&",
          "357:            avio_rl32(pb) == MKTAG('T','O','C','2')) {",
          "",
          "[Removed Lines]",
          "353:         for(i=0;i<table_entries_used;i++)",
          "",
          "[Added Lines]",
          "353:         for(i=0;i<table_entries_used;i++) {",
          "354:             if (avio_feof(pb))",
          "355:                 return AVERROR_INVALIDDATA;",
          "357:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4fedc4ceabe32bb3bea68ab71cb42f0b6e409586",
      "candidate_info": {
        "commit_hash": "4fedc4ceabe32bb3bea68ab71cb42f0b6e409586",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/4fedc4ceabe32bb3bea68ab71cb42f0b6e409586",
        "files": [
          "libavformat/nsvdec.c"
        ],
        "message": "avformat/nsvdec: Fix DoS due to lack of eof check in nsvs_file_offset loop.\n\nFixes: 20170829.nsv\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit c24bcb553650b91e9eff15ef6e54ca73de2453b7)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/nsvdec.c||libavformat/nsvdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavformat/nsvdec.c||libavformat/nsvdec.c": [
          "File: libavformat/nsvdec.c -> libavformat/nsvdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "350:         if (!nsv->nsvs_file_offset)",
          "351:             return AVERROR(ENOMEM);",
          "354:             nsv->nsvs_file_offset[i] = avio_rl32(pb) + size;",
          "356:         if(table_entries > table_entries_used &&",
          "357:            avio_rl32(pb) == MKTAG('T','O','C','2')) {",
          "",
          "[Removed Lines]",
          "353:         for(i=0;i<table_entries_used;i++)",
          "",
          "[Added Lines]",
          "353:         for(i=0;i<table_entries_used;i++) {",
          "354:             if (avio_feof(pb))",
          "355:                 return AVERROR_INVALIDDATA;",
          "357:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c6d3640cf71ce1ada67a5d488fc4db92f84a0dd6",
      "candidate_info": {
        "commit_hash": "c6d3640cf71ce1ada67a5d488fc4db92f84a0dd6",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/c6d3640cf71ce1ada67a5d488fc4db92f84a0dd6",
        "files": [
          "libavformat/nsvdec.c"
        ],
        "message": "avformat/nsvdec: Fix DoS due to lack of eof check in nsvs_file_offset loop.\n\nFixes: 20170829.nsv\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit c24bcb553650b91e9eff15ef6e54ca73de2453b7)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/nsvdec.c||libavformat/nsvdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavformat/nsvdec.c||libavformat/nsvdec.c": [
          "File: libavformat/nsvdec.c -> libavformat/nsvdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "350:         if (!nsv->nsvs_file_offset)",
          "351:             return AVERROR(ENOMEM);",
          "354:             nsv->nsvs_file_offset[i] = avio_rl32(pb) + size;",
          "356:         if(table_entries > table_entries_used &&",
          "357:            avio_rl32(pb) == MKTAG('T','O','C','2')) {",
          "",
          "[Removed Lines]",
          "353:         for(i=0;i<table_entries_used;i++)",
          "",
          "[Added Lines]",
          "353:         for(i=0;i<table_entries_used;i++) {",
          "354:             if (avio_feof(pb))",
          "355:                 return AVERROR_INVALIDDATA;",
          "357:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a051de092e9c709b69d24d94b66a382909be67d5",
      "candidate_info": {
        "commit_hash": "a051de092e9c709b69d24d94b66a382909be67d5",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/a051de092e9c709b69d24d94b66a382909be67d5",
        "files": [
          "libavformat/nsvdec.c"
        ],
        "message": "avformat/nsvdec: Fix DoS due to lack of eof check in nsvs_file_offset loop.\n\nFixes: 20170829.nsv\n\nCo-Author: \u5f20\u6d2a\u4eae(\u671b\u521d)\" <wangchu.zhl@alibaba-inc.com>\nFound-by: Xiaohei and Wangchu from Alibaba Security Team\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit c24bcb553650b91e9eff15ef6e54ca73de2453b7)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/nsvdec.c||libavformat/nsvdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavformat/nsvdec.c||libavformat/nsvdec.c": [
          "File: libavformat/nsvdec.c -> libavformat/nsvdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "350:         if (!nsv->nsvs_file_offset)",
          "351:             return AVERROR(ENOMEM);",
          "354:             nsv->nsvs_file_offset[i] = avio_rl32(pb) + size;",
          "356:         if(table_entries > table_entries_used &&",
          "357:            avio_rl32(pb) == MKTAG('T','O','C','2')) {",
          "",
          "[Removed Lines]",
          "353:         for(i=0;i<table_entries_used;i++)",
          "",
          "[Added Lines]",
          "353:         for(i=0;i<table_entries_used;i++) {",
          "354:             if (avio_feof(pb))",
          "355:                 return AVERROR_INVALIDDATA;",
          "357:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}