{
  "cve_id": "CVE-2016-0792",
  "cve_desc": "Multiple unspecified API endpoints in Jenkins before 1.650 and LTS before 1.642.2 allow remote authenticated users to execute arbitrary code via serialized data in an XML file, related to XStream and groovy.util.Expando.",
  "repo": "jenkinsci/jenkins",
  "patch_hash": "18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
  "patch_info": {
    "commit_hash": "18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
    "repo": "jenkinsci/jenkins",
    "commit_url": "https://github.com/jenkinsci/jenkins/commit/18cc8e0eb7d8c9910ce8ce2a9c8dab4c4df8b9c2",
    "files": [
      "core/src/main/java/hudson/util/XStream2.java",
      "test/src/test/java/hudson/util/XStream2Security247Test.java",
      "test/src/test/resources/hudson/util/XStream2Security247Test/config.xml"
    ],
    "message": "[FIX SECURITY-247] Prevent loading of MethodClosure from XML",
    "before_after_code_files": [
      "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java",
      "test/src/test/java/hudson/util/XStream2Security247Test.java||test/src/test/java/hudson/util/XStream2Security247Test.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/hudson/util/XStream2.java||core/src/main/java/hudson/util/XStream2.java": [
      "File: core/src/main/java/hudson/util/XStream2.java -> core/src/main/java/hudson/util/XStream2.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "160:         registerConverter(new AssociatedConverterImpl(this), -10);",
      "162:         registerConverter(new DynamicProxyConverter(getMapper()) { // SECURITY-105 defense",
      "163:             @Override public boolean canConvert(Class type) {",
      "164:                 return /* this precedes NullConverter */ type != null && super.canConvert(type);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "162:         registerConverter(new BlacklistedTypesConverter(), PRIORITY_VERY_HIGH); // SECURITY-247 defense",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "435:     }",
      "437: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "439:     private static class BlacklistedTypesConverter implements Converter {",
      "440:         @Override",
      "441:         public void marshal(Object source, HierarchicalStreamWriter writer, MarshallingContext context) {",
      "442:             throw new UnsupportedOperationException(\"Cannot marshal MethodClosure\");",
      "443:         }",
      "445:         @Override",
      "446:         public Object unmarshal(HierarchicalStreamReader reader, UnmarshallingContext context) {",
      "447:             throw new ConversionException(\"Cannot load MethodClosure for security reasons\");",
      "448:         }",
      "450:         @Override",
      "451:         public boolean canConvert(Class type) {",
      "452:             return type != null && \"org.codehaus.groovy.runtime.MethodClosure\".equals(type.getName());",
      "453:         }",
      "454:     }",
      "",
      "---------------"
    ],
    "test/src/test/java/hudson/util/XStream2Security247Test.java||test/src/test/java/hudson/util/XStream2Security247Test.java": [
      "File: test/src/test/java/hudson/util/XStream2Security247Test.java -> test/src/test/java/hudson/util/XStream2Security247Test.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: package hudson.util;",
      "3: import hudson.Functions;",
      "4: import hudson.model.Items;",
      "5: import org.apache.commons.io.FileUtils;",
      "6: import org.junit.Rule;",
      "7: import org.junit.Test;",
      "8: import org.jvnet.hudson.test.Issue;",
      "9: import org.jvnet.hudson.test.JenkinsRule;",
      "11: import java.io.File;",
      "13: import static org.junit.Assert.assertFalse;",
      "15: public class XStream2Security247Test {",
      "17:     @Rule",
      "18:     public JenkinsRule j = new JenkinsRule();",
      "20:     @Test",
      "21:     @Issue(\"SECURITY-247\")",
      "22:     public void dontUnmarshalMethodClosure() throws Exception {",
      "23:         if (Functions.isWindows())  return;",
      "24:         File exploitFile = new File(\"/tmp/jenkins-security247test\");",
      "25:         try {",
      "27:             if (exploitFile.exists() && !exploitFile.delete()) {",
      "28:                 throw new IllegalStateException(\"file exists and cannot be deleted\");",
      "29:             }",
      "30:             File tempJobDir = new File(j.jenkins.getRootDir(), \"security247\");",
      "31:             FileUtils.copyInputStreamToFile(XStream2Security247Test.class.getResourceAsStream(\"/hudson/util/XStream2Security247Test/config.xml\"),",
      "32:                     new File(tempJobDir, \"config.xml\"));",
      "33:             try {",
      "34:                 Items.load(j.jenkins, tempJobDir);",
      "35:             } catch (Exception e) {",
      "37:             }",
      "38:             assertFalse(\"no file should be created here\", exploitFile.exists());",
      "39:         } finally {",
      "40:             exploitFile.delete();",
      "41:         }",
      "42:     }",
      "43: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "559566b1ac62ebe966613933baf1714137daeb8c",
      "candidate_info": {
        "commit_hash": "559566b1ac62ebe966613933baf1714137daeb8c",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/559566b1ac62ebe966613933baf1714137daeb8c",
        "files": [
          "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java"
        ],
        "message": "[FIX SECURITY-245] Compare crumbs in constant time",
        "before_after_code_files": [
          "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java||core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java||core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java": [
          "File: core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java -> core/src/main/java/hudson/security/csrf/DefaultCrumbIssuer.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:         if (request instanceof HttpServletRequest) {",
          "96:             String newCrumb = issueCrumb(request, salt);",
          "97:             if ((newCrumb != null) && (crumb != null)) {",
          "99:             }",
          "100:         }",
          "101:         return false;",
          "",
          "[Removed Lines]",
          "98:                 return newCrumb.equals(crumb);",
          "",
          "[Added Lines]",
          "98:                 return MessageDigest.isEqual(newCrumb.getBytes(), crumb.getBytes());",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8713646a47b964f9b25d6eb1f7ee610cc5686404",
      "candidate_info": {
        "commit_hash": "8713646a47b964f9b25d6eb1f7ee610cc5686404",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/8713646a47b964f9b25d6eb1f7ee610cc5686404",
        "files": [
          "core/pom.xml",
          "core/src/main/java/hudson/WebAppMain.java",
          "war/src/main/webapp/WEB-INF/web.xml"
        ],
        "message": "[JENKINS-23378] Servlet 3.1\n\nStart declaring servlet 3.1 dependency",
        "before_after_code_files": [
          "core/src/main/java/hudson/WebAppMain.java||core/src/main/java/hudson/WebAppMain.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/WebAppMain.java||core/src/main/java/hudson/WebAppMain.java": [
          "File: core/src/main/java/hudson/WebAppMain.java -> core/src/main/java/hudson/WebAppMain.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "118:             installLogger();",
          "122:             final FileAndDescription describedHomeDir = getHomeDir(event);",
          "123:             home = describedHomeDir.file.getAbsoluteFile();",
          "",
          "[Removed Lines]",
          "120:             markCookieAsHttpOnly(context);",
          "",
          "[Added Lines]",
          "122:             context.getSessionCookieConfig().setHttpOnly(true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "254:         }",
          "255:     }",
          "282:     public void joinInit() throws InterruptedException {",
          "283:         initThread.join();",
          "284:     }",
          "",
          "[Removed Lines]",
          "262:     private void markCookieAsHttpOnly(ServletContext context) {",
          "263:         try {",
          "264:             Method m;",
          "265:             try {",
          "266:                 m = context.getClass().getMethod(\"getSessionCookieConfig\");",
          "267:             } catch (NoSuchMethodException x) { // 3.0+",
          "268:                 LOGGER.log(Level.FINE, \"Failed to set secure cookie flag\", x);",
          "269:                 return;",
          "270:             }",
          "271:             Object sessionCookieConfig = m.invoke(context);",
          "274:             Class scc = Class.forName(\"javax.servlet.SessionCookieConfig\");",
          "275:             Method setHttpOnly = scc.getMethod(\"setHttpOnly\",boolean.class);",
          "276:             setHttpOnly.invoke(sessionCookieConfig,true);",
          "277:         } catch (Exception e) {",
          "278:             LOGGER.log(Level.WARNING, \"Failed to set HTTP-only cookie flag\", e);",
          "279:         }",
          "280:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d0bad0f037cfad293faa2b101e0d5b2e41c01f57",
      "candidate_info": {
        "commit_hash": "d0bad0f037cfad293faa2b101e0d5b2e41c01f57",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/d0bad0f037cfad293faa2b101e0d5b2e41c01f57",
        "files": [
          "changelog.html"
        ],
        "message": "typo",
        "before_after_code_files": [
          "changelog.html||changelog.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "changelog.html||changelog.html": [
          "File: changelog.html -> changelog.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "56: <div id=\"trunk\" style=\"display:none\"><!--=TRUNK-BEGIN=-->",
          "57: <ul class=image>",
          "58:   <li class=\"rfe\">",
          "60:     (<a href-\"https://issues.jenkins-ci.org/browse/JENKINS-33068\">issue 33068</a>)",
          "61: </ul>",
          "62: </div><!--=TRUNK-END=-->",
          "",
          "[Removed Lines]",
          "59:     Move periodic task logfiles from <code>JENKINS_HOME/*.log</code> to <code>JENKINS_HOME/logs/tasks/*.log</code> and rotate them periodically rather than overwrite every execution",
          "",
          "[Added Lines]",
          "59:     Move periodic task log files from <code>JENKINS_HOME/*.log</code> to <code>JENKINS_HOME/logs/tasks/*.log</code> and rotate them periodically rather than overwrite every execution",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f286bc27bd09e7bd5e76783658888bd63fc38a49",
      "candidate_info": {
        "commit_hash": "f286bc27bd09e7bd5e76783658888bd63fc38a49",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/f286bc27bd09e7bd5e76783658888bd63fc38a49",
        "files": [
          "core/src/main/java/hudson/WebAppMain.java",
          "war/src/main/webapp/WEB-INF/web.xml"
        ],
        "message": "With servlet 3.0 this is a better place to set this config",
        "before_after_code_files": [
          "core/src/main/java/hudson/WebAppMain.java||core/src/main/java/hudson/WebAppMain.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/WebAppMain.java||core/src/main/java/hudson/WebAppMain.java": [
          "File: core/src/main/java/hudson/WebAppMain.java -> core/src/main/java/hudson/WebAppMain.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "118:             installLogger();",
          "124:             final FileAndDescription describedHomeDir = getHomeDir(event);",
          "125:             home = describedHomeDir.file.getAbsoluteFile();",
          "126:             home.mkdirs();",
          "",
          "[Removed Lines]",
          "122:             context.getSessionCookieConfig().setHttpOnly(true);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "669e1b5b89cf057d44d85120ac24d7d7e3ce3730",
      "candidate_info": {
        "commit_hash": "669e1b5b89cf057d44d85120ac24d7d7e3ce3730",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/669e1b5b89cf057d44d85120ac24d7d7e3ce3730",
        "files": [
          "changelog.html"
        ],
        "message": "updated changelog for release",
        "before_after_code_files": [
          "changelog.html||changelog.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/jenkinsci/jenkins/pull/2063"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "changelog.html||changelog.html": [
          "File: changelog.html -> changelog.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:   <li class=>",
          "59: </ul>",
          "60: </div><!--=TRUNK-END=-->",
          "61: <h3><a name=v1.649>What's new in 1.649</a> (2016/02/21)</h3>",
          "62: <ul class=image>",
          "63:   <li class=\"rfe\">",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: <h3><a name=v1.650>What's new in 1.650</a> (2016/02/24)</h3>",
          "62: <ul class=image>",
          "63:   <li class=>",
          "64: </ul>",
          "",
          "---------------"
        ]
      }
    }
  ]
}