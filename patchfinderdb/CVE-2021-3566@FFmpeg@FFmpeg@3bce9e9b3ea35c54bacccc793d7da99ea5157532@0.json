{
  "cve_id": "CVE-2021-3566",
  "cve_desc": "Prior to ffmpeg version 4.3, the tty demuxer did not have a 'read_probe' function assigned to it. By crafting a legitimate \"ffconcat\" file that references an image, followed by a file the triggers the tty demuxer, the contents of the second file will be copied into the output file verbatim (as long as the `-vcodec copy` option is passed to ffmpeg).",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "3bce9e9b3ea35c54bacccc793d7da99ea5157532",
  "patch_info": {
    "commit_hash": "3bce9e9b3ea35c54bacccc793d7da99ea5157532",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/3bce9e9b3ea35c54bacccc793d7da99ea5157532",
    "files": [
      "libavformat/tty.c"
    ],
    "message": "avformat/tty: add probe function",
    "before_after_code_files": [
      "libavformat/tty.c||libavformat/tty.c"
    ]
  },
  "patch_diff": {
    "libavformat/tty.c||libavformat/tty.c": [
      "File: libavformat/tty.c -> libavformat/tty.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "34: #include \"internal.h\"",
      "35: #include \"sauce.h\"",
      "37: typedef struct TtyDemuxContext {",
      "38:     AVClass *class;",
      "39:     int chars_per_frame;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "37: static int isansicode(int x)",
      "38: {",
      "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
      "40: }",
      "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "43: } TtyDemuxContext;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "52: static int read_probe(const AVProbeData *p)",
      "53: {",
      "54:     int cnt = 0;",
      "56:     for (int i = 0; i < p->buf_size; i++)",
      "57:         cnt += !!isansicode(p->buf[i]);",
      "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
      "60:         !!av_match_ext(p->filename, tty_extensions);",
      "61: }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "153:     .name           = \"tty\",",
      "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
      "155:     .priv_data_size = sizeof(TtyDemuxContext),",
      "156:     .read_header    = read_header,",
      "157:     .read_packet    = read_packet,",
      "159:     .priv_class     = &tty_demuxer_class,",
      "160: };",
      "",
      "[Removed Lines]",
      "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
      "",
      "[Added Lines]",
      "174:     .read_probe     = read_probe,",
      "177:     .extensions     = tty_extensions,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f126288f23443675c40e9017a725d5458a47c9f7",
      "candidate_info": {
        "commit_hash": "f126288f23443675c40e9017a725d5458a47c9f7",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/f126288f23443675c40e9017a725d5458a47c9f7",
        "files": [
          "libavformat/tty.c"
        ],
        "message": "avformat/tty: add probe function\n\n(cherry picked from commit 3bce9e9b3ea35c54bacccc793d7da99ea5157532)",
        "before_after_code_files": [
          "libavformat/tty.c||libavformat/tty.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/tty.c||libavformat/tty.c"
          ],
          "candidate": [
            "libavformat/tty.c||libavformat/tty.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/tty.c||libavformat/tty.c": [
          "File: libavformat/tty.c -> libavformat/tty.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"internal.h\"",
          "35: #include \"sauce.h\"",
          "37: typedef struct TtyDemuxContext {",
          "38:     AVClass *class;",
          "39:     int chars_per_frame;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: static int isansicode(int x)",
          "38: {",
          "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
          "40: }",
          "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: } TtyDemuxContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: static int read_probe(const AVProbeData *p)",
          "53: {",
          "54:     int cnt = 0;",
          "56:     for (int i = 0; i < p->buf_size; i++)",
          "57:         cnt += !!isansicode(p->buf[i]);",
          "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
          "60:         !!av_match_ext(p->filename, tty_extensions);",
          "61: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "153:     .name           = \"tty\",",
          "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
          "155:     .priv_data_size = sizeof(TtyDemuxContext),",
          "156:     .read_header    = read_header,",
          "157:     .read_packet    = read_packet,",
          "159:     .priv_class     = &tty_demuxer_class,",
          "160: };",
          "",
          "[Removed Lines]",
          "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
          "",
          "[Added Lines]",
          "174:     .read_probe     = read_probe,",
          "177:     .extensions     = tty_extensions,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7df2ff54e8ffc1ce59f3642de9658a789c8782aa",
      "candidate_info": {
        "commit_hash": "7df2ff54e8ffc1ce59f3642de9658a789c8782aa",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/7df2ff54e8ffc1ce59f3642de9658a789c8782aa",
        "files": [
          "libavformat/tty.c"
        ],
        "message": "avformat/tty: add probe function\n\n(cherry picked from commit 3bce9e9b3ea35c54bacccc793d7da99ea5157532)",
        "before_after_code_files": [
          "libavformat/tty.c||libavformat/tty.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/tty.c||libavformat/tty.c"
          ],
          "candidate": [
            "libavformat/tty.c||libavformat/tty.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/tty.c||libavformat/tty.c": [
          "File: libavformat/tty.c -> libavformat/tty.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"internal.h\"",
          "35: #include \"sauce.h\"",
          "37: typedef struct TtyDemuxContext {",
          "38:     AVClass *class;",
          "39:     int chars_per_frame;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: static int isansicode(int x)",
          "38: {",
          "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
          "40: }",
          "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: } TtyDemuxContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: static int read_probe(const AVProbeData *p)",
          "53: {",
          "54:     int cnt = 0;",
          "56:     for (int i = 0; i < p->buf_size; i++)",
          "57:         cnt += !!isansicode(p->buf[i]);",
          "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
          "60:         !!av_match_ext(p->filename, tty_extensions);",
          "61: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "153:     .name           = \"tty\",",
          "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
          "155:     .priv_data_size = sizeof(TtyDemuxContext),",
          "156:     .read_header    = read_header,",
          "157:     .read_packet    = read_packet,",
          "159:     .priv_class     = &tty_demuxer_class,",
          "160: };",
          "",
          "[Removed Lines]",
          "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
          "",
          "[Added Lines]",
          "174:     .read_probe     = read_probe,",
          "177:     .extensions     = tty_extensions,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b5873ca4f527570814420adf10bec529f76b2402",
      "candidate_info": {
        "commit_hash": "b5873ca4f527570814420adf10bec529f76b2402",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b5873ca4f527570814420adf10bec529f76b2402",
        "files": [
          "libavformat/tty.c"
        ],
        "message": "avformat/tty: add probe function\n\n(cherry picked from commit 3bce9e9b3ea35c54bacccc793d7da99ea5157532)",
        "before_after_code_files": [
          "libavformat/tty.c||libavformat/tty.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/tty.c||libavformat/tty.c"
          ],
          "candidate": [
            "libavformat/tty.c||libavformat/tty.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/tty.c||libavformat/tty.c": [
          "File: libavformat/tty.c -> libavformat/tty.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"internal.h\"",
          "35: #include \"sauce.h\"",
          "37: typedef struct TtyDemuxContext {",
          "38:     AVClass *class;",
          "39:     int chars_per_frame;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: static int isansicode(int x)",
          "38: {",
          "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
          "40: }",
          "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: } TtyDemuxContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: static int read_probe(const AVProbeData *p)",
          "53: {",
          "54:     int cnt = 0;",
          "56:     for (int i = 0; i < p->buf_size; i++)",
          "57:         cnt += !!isansicode(p->buf[i]);",
          "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
          "60:         !!av_match_ext(p->filename, tty_extensions);",
          "61: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "153:     .name           = \"tty\",",
          "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
          "155:     .priv_data_size = sizeof(TtyDemuxContext),",
          "156:     .read_header    = read_header,",
          "157:     .read_packet    = read_packet,",
          "159:     .priv_class     = &tty_demuxer_class,",
          "160: };",
          "",
          "[Removed Lines]",
          "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
          "",
          "[Added Lines]",
          "174:     .read_probe     = read_probe,",
          "177:     .extensions     = tty_extensions,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e5d1808aa54f344a0189ec9428b648906ba5e123",
      "candidate_info": {
        "commit_hash": "e5d1808aa54f344a0189ec9428b648906ba5e123",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e5d1808aa54f344a0189ec9428b648906ba5e123",
        "files": [
          "libavformat/tty.c"
        ],
        "message": "avformat/tty: add probe function\n\n(cherry picked from commit 3bce9e9b3ea35c54bacccc793d7da99ea5157532)",
        "before_after_code_files": [
          "libavformat/tty.c||libavformat/tty.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/tty.c||libavformat/tty.c"
          ],
          "candidate": [
            "libavformat/tty.c||libavformat/tty.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/tty.c||libavformat/tty.c": [
          "File: libavformat/tty.c -> libavformat/tty.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"internal.h\"",
          "35: #include \"sauce.h\"",
          "37: typedef struct TtyDemuxContext {",
          "38:     AVClass *class;",
          "39:     int chars_per_frame;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: static int isansicode(int x)",
          "38: {",
          "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
          "40: }",
          "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: } TtyDemuxContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: static int read_probe(const AVProbeData *p)",
          "53: {",
          "54:     int cnt = 0;",
          "56:     for (int i = 0; i < p->buf_size; i++)",
          "57:         cnt += !!isansicode(p->buf[i]);",
          "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
          "60:         !!av_match_ext(p->filename, tty_extensions);",
          "61: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "153:     .name           = \"tty\",",
          "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
          "155:     .priv_data_size = sizeof(TtyDemuxContext),",
          "156:     .read_header    = read_header,",
          "157:     .read_packet    = read_packet,",
          "159:     .priv_class     = &tty_demuxer_class,",
          "160: };",
          "",
          "[Removed Lines]",
          "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
          "",
          "[Added Lines]",
          "174:     .read_probe     = read_probe,",
          "177:     .extensions     = tty_extensions,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "97ee4a451b5b1eb0010664b4a8c048d6c8c06a8a",
      "candidate_info": {
        "commit_hash": "97ee4a451b5b1eb0010664b4a8c048d6c8c06a8a",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/97ee4a451b5b1eb0010664b4a8c048d6c8c06a8a",
        "files": [
          "libavformat/tty.c"
        ],
        "message": "avformat/tty: add probe function\n\n(cherry picked from commit 3bce9e9b3ea35c54bacccc793d7da99ea5157532)",
        "before_after_code_files": [
          "libavformat/tty.c||libavformat/tty.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/tty.c||libavformat/tty.c"
          ],
          "candidate": [
            "libavformat/tty.c||libavformat/tty.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/tty.c||libavformat/tty.c": [
          "File: libavformat/tty.c -> libavformat/tty.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"internal.h\"",
          "35: #include \"sauce.h\"",
          "37: typedef struct TtyDemuxContext {",
          "38:     AVClass *class;",
          "39:     int chars_per_frame;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: static int isansicode(int x)",
          "38: {",
          "39:     return x == 0x1B || x == 0x0A || x == 0x0D || (x >= 0x20 && x < 0x7f);",
          "40: }",
          "42: static const char tty_extensions[31] = \"ans,art,asc,diz,ice,nfo,txt,vt\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: } TtyDemuxContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: static int read_probe(const AVProbeData *p)",
          "53: {",
          "54:     int cnt = 0;",
          "56:     for (int i = 0; i < p->buf_size; i++)",
          "57:         cnt += !!isansicode(p->buf[i]);",
          "59:     return (cnt * 100LL / p->buf_size) * (cnt > 400) *",
          "60:         !!av_match_ext(p->filename, tty_extensions);",
          "61: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "153:     .name           = \"tty\",",
          "154:     .long_name      = NULL_IF_CONFIG_SMALL(\"Tele-typewriter\"),",
          "155:     .priv_data_size = sizeof(TtyDemuxContext),",
          "156:     .read_header    = read_header,",
          "157:     .read_packet    = read_packet,",
          "159:     .priv_class     = &tty_demuxer_class,",
          "160: };",
          "",
          "[Removed Lines]",
          "158:     .extensions     = \"ans,art,asc,diz,ice,nfo,txt,vt\",",
          "",
          "[Added Lines]",
          "174:     .read_probe     = read_probe,",
          "177:     .extensions     = tty_extensions,",
          "",
          "---------------"
        ]
      }
    }
  ]
}