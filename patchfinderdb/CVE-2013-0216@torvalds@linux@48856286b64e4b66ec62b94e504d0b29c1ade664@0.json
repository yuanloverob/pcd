{
  "cve_id": "CVE-2013-0216",
  "cve_desc": "The Xen netback functionality in the Linux kernel before 3.7.8 allows guest OS users to cause a denial of service (loop) by triggering ring pointer corruption.",
  "repo": "torvalds/linux",
  "patch_hash": "48856286b64e4b66ec62b94e504d0b29c1ade664",
  "patch_info": {
    "commit_hash": "48856286b64e4b66ec62b94e504d0b29c1ade664",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/48856286b64e4b66ec62b94e504d0b29c1ade664",
    "files": [
      "drivers/net/xen-netback/common.h",
      "drivers/net/xen-netback/interface.c",
      "drivers/net/xen-netback/netback.c"
    ],
    "message": "xen/netback: shutdown the ring if it contains garbage.\n\nA buggy or malicious frontend should not be able to confuse netback.\nIf we spot anything which is not as it should be then shutdown the\ndevice and don't try to continue with the ring in a potentially\nhostile state. Well behaved and non-hostile frontends will not be\npenalised.\n\nAs well as making the existing checks for such errors fatal also add a\nnew check that ensures that there isn't an insane number of requests\non the ring (i.e. more than would fit in the ring). If the ring\ncontains garbage then previously is was possible to loop over this\ninsane number, getting an error each time and therefore not generating\nany more pending requests and therefore not exiting the loop in\nxen_netbk_tx_build_gops for an externded period.\n\nAlso turn various netdev_dbg calls which no precipitate a fatal error\ninto netdev_err, they are rate limited because the device is shutdown\nafterwards.\n\nThis fixes at least one known DoS/softlockup of the backend domain.\n\nSigned-off-by: Ian Campbell <ian.campbell@citrix.com>\nReviewed-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>\nAcked-by: Jan Beulich <JBeulich@suse.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h",
      "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c",
      "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
    ]
  },
  "patch_diff": {
    "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h": [
      "File: drivers/net/xen-netback/common.h -> drivers/net/xen-netback/common.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "152: void xenvif_notify_tx_completion(struct xenvif *vif);",
      "155: unsigned int xen_netbk_count_skb_slots(struct xenvif *vif, struct sk_buff *skb);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "155: void xenvif_carrier_off(struct xenvif *vif);",
      "",
      "---------------"
    ],
    "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c": [
      "File: drivers/net/xen-netback/interface.c -> drivers/net/xen-netback/interface.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "343:  return err;",
      "344: }",
      "347: {",
      "348:  struct net_device *dev = vif->dev;",
      "358:  atomic_dec(&vif->refcnt);",
      "359:  wait_event(vif->waiting_to_free, atomic_read(&vif->refcnt) == 0);",
      "",
      "[Removed Lines]",
      "346: void xenvif_disconnect(struct xenvif *vif)",
      "349:  if (netif_carrier_ok(dev)) {",
      "350:   rtnl_lock();",
      "352:   if (netif_running(dev))",
      "353:    xenvif_down(vif);",
      "354:   rtnl_unlock();",
      "355:   xenvif_put(vif);",
      "356:  }",
      "",
      "[Added Lines]",
      "346: void xenvif_carrier_off(struct xenvif *vif)",
      "350:  rtnl_lock();",
      "352:  if (netif_running(dev))",
      "353:   xenvif_down(vif);",
      "354:  rtnl_unlock();",
      "355:  xenvif_put(vif);",
      "356: }",
      "358: void xenvif_disconnect(struct xenvif *vif)",
      "359: {",
      "360:  if (netif_carrier_ok(vif->dev))",
      "361:   xenvif_carrier_off(vif);",
      "",
      "---------------"
    ],
    "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
      "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "888:  xenvif_put(vif);",
      "889: }",
      "891: static int netbk_count_requests(struct xenvif *vif,",
      "892:     struct xen_netif_tx_request *first,",
      "893:     struct xen_netif_tx_request *txp,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "891: static void netbk_fatal_tx_err(struct xenvif *vif)",
      "892: {",
      "893:  netdev_err(vif->dev, \"fatal error; disabling device\\n\");",
      "894:  xenvif_carrier_off(vif);",
      "895:  xenvif_put(vif);",
      "896: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "902:  do {",
      "903:   if (frags >= work_to_do) {",
      "905:    return -frags;",
      "906:   }",
      "908:   if (unlikely(frags >= MAX_SKB_FRAGS)) {",
      "910:    return -frags;",
      "911:   }",
      "913:   memcpy(txp, RING_GET_REQUEST(&vif->tx, cons + frags),",
      "914:          sizeof(*txp));",
      "915:   if (txp->size > first->size) {",
      "917:    return -frags;",
      "918:   }",
      "",
      "[Removed Lines]",
      "904:    netdev_dbg(vif->dev, \"Need more frags\\n\");",
      "909:    netdev_dbg(vif->dev, \"Too many frags\\n\");",
      "916:    netdev_dbg(vif->dev, \"Frags galore\\n\");",
      "",
      "[Added Lines]",
      "911:    netdev_err(vif->dev, \"Need more frags\\n\");",
      "912:    netbk_fatal_tx_err(vif);",
      "917:    netdev_err(vif->dev, \"Too many frags\\n\");",
      "918:    netbk_fatal_tx_err(vif);",
      "925:    netdev_err(vif->dev, \"Frag is bigger than frame.\\n\");",
      "926:    netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "921:   frags++;",
      "923:   if (unlikely((txp->offset + txp->size) > PAGE_SIZE)) {",
      "925:      txp->offset, txp->size);",
      "926:    return -frags;",
      "927:   }",
      "928:  } while ((txp++)->flags & XEN_NETTXF_more_data);",
      "",
      "[Removed Lines]",
      "924:    netdev_dbg(vif->dev, \"txp->offset: %x, size: %u\\n\",",
      "",
      "[Added Lines]",
      "934:    netdev_err(vif->dev, \"txp->offset: %x, size: %u\\n\",",
      "936:    netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1096:  do {",
      "1097:   if (unlikely(work_to_do-- <= 0)) {",
      "1099:    return -EBADR;",
      "1100:   }",
      "",
      "[Removed Lines]",
      "1098:    netdev_dbg(vif->dev, \"Missing extra info\\n\");",
      "",
      "[Added Lines]",
      "1109:    netdev_err(vif->dev, \"Missing extra info\\n\");",
      "1110:    netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1104:   if (unlikely(!extra.type ||",
      "1105:         extra.type >= XEN_NETIF_EXTRA_TYPE_MAX)) {",
      "1106:    vif->tx.req_cons = ++cons;",
      "1108:        \"Invalid extra type: %d\\n\", extra.type);",
      "1109:    return -EINVAL;",
      "1110:   }",
      "",
      "[Removed Lines]",
      "1107:    netdev_dbg(vif->dev,",
      "",
      "[Added Lines]",
      "1119:    netdev_err(vif->dev,",
      "1121:    netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1121:         struct xen_netif_extra_info *gso)",
      "1122: {",
      "1123:  if (!gso->u.gso.size) {",
      "1125:   return -EINVAL;",
      "1126:  }",
      "1129:  if (gso->u.gso.type != XEN_NETIF_GSO_TYPE_TCPV4) {",
      "1131:   return -EINVAL;",
      "1132:  }",
      "",
      "[Removed Lines]",
      "1124:   netdev_dbg(vif->dev, \"GSO size must not be zero.\\n\");",
      "1130:   netdev_dbg(vif->dev, \"Bad GSO type %d.\\n\", gso->u.gso.type);",
      "",
      "[Added Lines]",
      "1137:   netdev_err(vif->dev, \"GSO size must not be zero.\\n\");",
      "1138:   netbk_fatal_tx_err(vif);",
      "1144:   netdev_err(vif->dev, \"Bad GSO type %d.\\n\", gso->u.gso.type);",
      "1145:   netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1266:   vif = poll_net_schedule_list(netbk);",
      "1267:   if (!vif)",
      "1268:    continue;",
      "1270:   RING_FINAL_CHECK_FOR_REQUESTS(&vif->tx, work_to_do);",
      "1271:   if (!work_to_do) {",
      "1272:    xenvif_put(vif);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1290:   if (vif->tx.sring->req_prod - vif->tx.req_cons >",
      "1291:       XEN_NETIF_TX_RING_SIZE) {",
      "1292:    netdev_err(vif->dev,",
      "1293:        \"Impossible number of requests. \"",
      "1294:        \"req_prod %d, req_cons %d, size %ld\\n\",",
      "1295:        vif->tx.sring->req_prod, vif->tx.req_cons,",
      "1296:        XEN_NETIF_TX_RING_SIZE);",
      "1297:    netbk_fatal_tx_err(vif);",
      "1298:    continue;",
      "1299:   }",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1294:    work_to_do = xen_netbk_get_extras(vif, extras,",
      "1295:          work_to_do);",
      "1296:    idx = vif->tx.req_cons;",
      "1299:     continue;",
      "1301:   }",
      "1303:   ret = netbk_count_requests(vif, &txreq, txfrags, work_to_do);",
      "1306:    continue;",
      "1308:   idx += ret;",
      "1310:   if (unlikely(txreq.size < ETH_HLEN)) {",
      "",
      "[Removed Lines]",
      "1297:    if (unlikely(work_to_do < 0)) {",
      "1298:     netbk_tx_err(vif, &txreq, idx);",
      "1300:    }",
      "1304:   if (unlikely(ret < 0)) {",
      "1305:    netbk_tx_err(vif, &txreq, idx - ret);",
      "1307:   }",
      "",
      "[Added Lines]",
      "1328:    if (unlikely(work_to_do < 0))",
      "1333:   if (unlikely(ret < 0))",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1318:   if (unlikely((txreq.offset + txreq.size) > PAGE_SIZE)) {",
      "1320:        \"txreq.offset: %x, size: %u, end: %lu\\n\",",
      "1321:        txreq.offset, txreq.size,",
      "1322:        (txreq.offset&~PAGE_MASK) + txreq.size);",
      "1324:    continue;",
      "1325:   }",
      "",
      "[Removed Lines]",
      "1319:    netdev_dbg(vif->dev,",
      "1323:    netbk_tx_err(vif, &txreq, idx);",
      "",
      "[Added Lines]",
      "1347:    netdev_err(vif->dev,",
      "1351:    netbk_fatal_tx_err(vif);",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1348:    gso = &extras[XEN_NETIF_EXTRA_TYPE_GSO - 1];",
      "1350:    if (netbk_set_skb_gso(vif, skb, gso)) {",
      "1351:     kfree_skb(skb);",
      "1353:     continue;",
      "1354:    }",
      "1355:   }",
      "",
      "[Removed Lines]",
      "1352:     netbk_tx_err(vif, &txreq, idx);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "376414945d15aa636e65f7e773c1e398b7a21cb9",
      "candidate_info": {
        "commit_hash": "376414945d15aa636e65f7e773c1e398b7a21cb9",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/376414945d15aa636e65f7e773c1e398b7a21cb9",
        "files": [
          "drivers/net/xen-netback/netback.c"
        ],
        "message": "xen-netback: better names for thresholds\n\nThis patch only changes some names to avoid confusion.\n\nIn this patch we have:\n\n  MAX_SKB_SLOTS_DEFAULT -> FATAL_SKB_SLOTS_DEFAULT\n  max_skb_slots -> fatal_skb_slots\n  #define XEN_NETBK_LEGACY_SLOTS_MAX XEN_NETIF_NR_SLOTS_MIN\n\nThe fatal_skb_slots is the threshold to determine whether a packet is\nmalicious.\n\nXEN_NETBK_LEGACY_SLOTS_MAX is the maximum slots a valid packet can have at\nthis point. It is defined to be XEN_NETIF_NR_SLOTS_MIN because that's\nguaranteed to be supported by all backends.\n\nSuggested-by: Ian Campbell <ian.campbell@citrix.com>\nSigned-off-by: Wei Liu <wei.liu2@citrix.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ],
          "candidate": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
          "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "58: typedef unsigned int pending_ring_idx_t;",
          "59: #define INVALID_PENDING_RING_IDX (~0U)",
          "",
          "[Removed Lines]",
          "54: #define MAX_SKB_SLOTS_DEFAULT 20",
          "55: static unsigned int max_skb_slots = MAX_SKB_SLOTS_DEFAULT;",
          "56: module_param(max_skb_slots, uint, 0444);",
          "",
          "[Added Lines]",
          "54: #define FATAL_SKB_SLOTS_DEFAULT 20",
          "55: static unsigned int fatal_skb_slots = FATAL_SKB_SLOTS_DEFAULT;",
          "56: module_param(fatal_skb_slots, uint, 0444);",
          "64: #define XEN_NETBK_LEGACY_SLOTS_MAX XEN_NETIF_NR_SLOTS_MIN",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "957:    netdev_err(vif->dev,",
          "958:        \"Malicious frontend using %d slots, threshold %u\\n\",",
          "960:    netbk_fatal_tx_err(vif);",
          "961:    return -E2BIG;",
          "962:   }",
          "971:    if (net_ratelimit())",
          "972:     netdev_dbg(vif->dev,",
          "973:         \"Too many slots (%d) exceeding limit (%d), dropping packet\\n\",",
          "975:    drop_err = -E2BIG;",
          "976:   }",
          "",
          "[Removed Lines]",
          "956:   if (unlikely(slots >= max_skb_slots)) {",
          "959:        slots, max_skb_slots);",
          "970:   if (!drop_err && slots >= XEN_NETIF_NR_SLOTS_MIN) {",
          "974:         slots, XEN_NETIF_NR_SLOTS_MIN);",
          "",
          "[Added Lines]",
          "964:   if (unlikely(slots >= fatal_skb_slots)) {",
          "967:        slots, fatal_skb_slots);",
          "979:   if (!drop_err && slots >= XEN_NETBK_LEGACY_SLOTS_MAX) {",
          "983:         slots, XEN_NETBK_LEGACY_SLOTS_MAX);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1415:  struct sk_buff *skb;",
          "1416:  int ret;",
          "1419:   < MAX_PENDING_REQS) &&",
          "1420:   !list_empty(&netbk->net_schedule_list)) {",
          "1421:   struct xenvif *vif;",
          "1422:   struct xen_netif_tx_request txreq;",
          "1424:   struct page *page;",
          "1425:   struct xen_netif_extra_info extras[XEN_NETIF_EXTRA_TYPE_MAX-1];",
          "1426:   u16 pending_idx;",
          "",
          "[Removed Lines]",
          "1418:  while ((nr_pending_reqs(netbk) + XEN_NETIF_NR_SLOTS_MIN",
          "1423:   struct xen_netif_tx_request txfrags[XEN_NETIF_NR_SLOTS_MIN];",
          "",
          "[Added Lines]",
          "1427:  while ((nr_pending_reqs(netbk) + XEN_NETBK_LEGACY_SLOTS_MAX",
          "1432:   struct xen_netif_tx_request txfrags[XEN_NETBK_LEGACY_SLOTS_MAX];",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1508:   pending_idx = netbk->pending_ring[index];",
          "1510:   data_len = (txreq.size > PKT_PROT_LEN &&",
          "1512:    PKT_PROT_LEN : txreq.size;",
          "1514:   skb = alloc_skb(data_len + NET_SKB_PAD + NET_IP_ALIGN,",
          "",
          "[Removed Lines]",
          "1511:        ret < XEN_NETIF_NR_SLOTS_MIN) ?",
          "",
          "[Added Lines]",
          "1520:        ret < XEN_NETBK_LEGACY_SLOTS_MAX) ?",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1787: static inline int tx_work_todo(struct xen_netbk *netbk)",
          "1788: {",
          "1791:       < MAX_PENDING_REQS) &&",
          "1792:       !list_empty(&netbk->net_schedule_list))",
          "1793:   return 1;",
          "",
          "[Removed Lines]",
          "1790:  if ((nr_pending_reqs(netbk) + XEN_NETIF_NR_SLOTS_MIN",
          "",
          "[Added Lines]",
          "1799:  if ((nr_pending_reqs(netbk) + XEN_NETBK_LEGACY_SLOTS_MAX",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1872:  if (!xen_domain())",
          "1873:   return -ENODEV;",
          "1876:   printk(KERN_INFO",
          "1880:  }",
          "1882:  xen_netbk_group_nr = num_online_cpus();",
          "",
          "[Removed Lines]",
          "1875:  if (max_skb_slots < XEN_NETIF_NR_SLOTS_MIN) {",
          "1877:          \"xen-netback: max_skb_slots too small (%d), bump it to XEN_NETIF_NR_SLOTS_MIN (%d)\\n\",",
          "1878:          max_skb_slots, XEN_NETIF_NR_SLOTS_MIN);",
          "1879:   max_skb_slots = XEN_NETIF_NR_SLOTS_MIN;",
          "",
          "[Added Lines]",
          "1884:  if (fatal_skb_slots < XEN_NETBK_LEGACY_SLOTS_MAX) {",
          "1886:          \"xen-netback: fatal_skb_slots too small (%d), bump it to XEN_NETBK_LEGACY_SLOTS_MAX (%d)\\n\",",
          "1887:          fatal_skb_slots, XEN_NETBK_LEGACY_SLOTS_MAX);",
          "1888:   fatal_skb_slots = XEN_NETBK_LEGACY_SLOTS_MAX;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "35876b5ffc154c357476b2c3bdab10feaf4bd8f0",
      "candidate_info": {
        "commit_hash": "35876b5ffc154c357476b2c3bdab10feaf4bd8f0",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/35876b5ffc154c357476b2c3bdab10feaf4bd8f0",
        "files": [
          "drivers/net/xen-netback/netback.c"
        ],
        "message": "xen-netback: correctly return errors from netbk_count_requests()\n\nnetbk_count_requests() could detect an error, call\nnetbk_fatal_tx_error() but return 0.  The vif may then be used\nafterwards (e.g., in a call to netbk_tx_error().\n\nSince netbk_fatal_tx_error() could set vif->refcnt to 1, the vif may\nbe freed immediately after the call to netbk_fatal_tx_error() (e.g.,\nif the vif is also removed).\n\nNetback thread              Xenwatch thread\n-------------------------------------------\nnetbk_fatal_tx_err()        netback_remove()\n                              xenvif_disconnect()\n                                ...\n                                free_netdev()\nnetbk_tx_err() Oops!\n\nSigned-off-by: Wei Liu <wei.liu2@citrix.com>\nSigned-off-by: Jan Beulich <JBeulich@suse.com>\nSigned-off-by: David Vrabel <david.vrabel@citrix.com>\nReported-by: Christopher S. Aker <caker@theshore.net>\nAcked-by: Ian Campbell <ian.campbell@citrix.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ],
          "candidate": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
          "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "911:   if (frags >= work_to_do) {",
          "912:    netdev_err(vif->dev, \"Need more frags\\n\");",
          "913:    netbk_fatal_tx_err(vif);",
          "915:   }",
          "917:   if (unlikely(frags >= MAX_SKB_FRAGS)) {",
          "918:    netdev_err(vif->dev, \"Too many frags\\n\");",
          "919:    netbk_fatal_tx_err(vif);",
          "921:   }",
          "923:   memcpy(txp, RING_GET_REQUEST(&vif->tx, cons + frags),",
          "",
          "[Removed Lines]",
          "914:    return -frags;",
          "920:    return -frags;",
          "",
          "[Added Lines]",
          "914:    return -ENODATA;",
          "920:    return -E2BIG;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "925:   if (txp->size > first->size) {",
          "926:    netdev_err(vif->dev, \"Frag is bigger than frame.\\n\");",
          "927:    netbk_fatal_tx_err(vif);",
          "929:   }",
          "931:   first->size -= txp->size;",
          "",
          "[Removed Lines]",
          "928:    return -frags;",
          "",
          "[Added Lines]",
          "928:    return -EIO;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "935:    netdev_err(vif->dev, \"txp->offset: %x, size: %u\\n\",",
          "936:      txp->offset, txp->size);",
          "937:    netbk_fatal_tx_err(vif);",
          "939:   }",
          "940:  } while ((txp++)->flags & XEN_NETTXF_more_data);",
          "941:  return frags;",
          "",
          "[Removed Lines]",
          "938:    return -frags;",
          "",
          "[Added Lines]",
          "938:    return -EINVAL;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7376419a4697657b2e0ab904a592aacc2e485bf1",
      "candidate_info": {
        "commit_hash": "7376419a4697657b2e0ab904a592aacc2e485bf1",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/7376419a4697657b2e0ab904a592aacc2e485bf1",
        "files": [
          "drivers/net/xen-netback/common.h",
          "drivers/net/xen-netback/interface.c",
          "drivers/net/xen-netback/netback.c"
        ],
        "message": "xen-netback: rename functions\n\nAs we move to 1:1 model and melt xen_netbk and xenvif together, it would\nbe better to use single prefix for all functions in xen-netback.\n\nSigned-off-by: Wei Liu <wei.liu2@citrix.com>\nAcked-by: Ian Campbell <ian.campbell@citrix.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h",
          "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c",
          "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h",
            "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c",
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ],
          "candidate": [
            "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h",
            "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c",
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/xen-netback/common.h||drivers/net/xen-netback/common.h": [
          "File: drivers/net/xen-netback/common.h -> drivers/net/xen-netback/common.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "191: int xenvif_schedulable(struct xenvif *vif);",
          "209: void xenvif_notify_tx_completion(struct xenvif *vif);",
          "",
          "[Removed Lines]",
          "193: int xen_netbk_rx_ring_full(struct xenvif *vif);",
          "195: int xen_netbk_must_stop_queue(struct xenvif *vif);",
          "198: void xen_netbk_unmap_frontend_rings(struct xenvif *vif);",
          "199: int xen_netbk_map_frontend_rings(struct xenvif *vif,",
          "200:      grant_ref_t tx_ring_ref,",
          "201:      grant_ref_t rx_ring_ref);",
          "204: void xen_netbk_check_rx_xenvif(struct xenvif *vif);",
          "207: void xen_netbk_queue_tx_skb(struct xenvif *vif, struct sk_buff *skb);",
          "",
          "[Added Lines]",
          "193: int xenvif_rx_ring_full(struct xenvif *vif);",
          "195: int xenvif_must_stop_queue(struct xenvif *vif);",
          "198: void xenvif_unmap_frontend_rings(struct xenvif *vif);",
          "199: int xenvif_map_frontend_rings(struct xenvif *vif,",
          "200:          grant_ref_t tx_ring_ref,",
          "201:          grant_ref_t rx_ring_ref);",
          "204: void xenvif_check_rx_xenvif(struct xenvif *vif);",
          "207: void xenvif_queue_tx_skb(struct xenvif *vif, struct sk_buff *skb);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "212: void xenvif_carrier_off(struct xenvif *vif);",
          "222: extern bool separate_tx_rx_irq;",
          "",
          "[Removed Lines]",
          "215: unsigned int xen_netbk_count_skb_slots(struct xenvif *vif, struct sk_buff *skb);",
          "217: int xen_netbk_tx_action(struct xenvif *vif, int budget);",
          "218: void xen_netbk_rx_action(struct xenvif *vif);",
          "220: int xen_netbk_kthread(void *data);",
          "",
          "[Added Lines]",
          "215: unsigned int xenvif_count_skb_slots(struct xenvif *vif, struct sk_buff *skb);",
          "217: int xenvif_tx_action(struct xenvif *vif, int budget);",
          "218: void xenvif_rx_action(struct xenvif *vif);",
          "220: int xenvif_kthread(void *data);",
          "",
          "---------------"
        ],
        "drivers/net/xen-netback/interface.c||drivers/net/xen-netback/interface.c": [
          "File: drivers/net/xen-netback/interface.c -> drivers/net/xen-netback/interface.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "49: static int xenvif_rx_schedulable(struct xenvif *vif)",
          "50: {",
          "52: }",
          "54: static irqreturn_t xenvif_tx_interrupt(int irq, void *dev_id)",
          "",
          "[Removed Lines]",
          "51:  return xenvif_schedulable(vif) && !xen_netbk_rx_ring_full(vif);",
          "",
          "[Added Lines]",
          "51:  return xenvif_schedulable(vif) && !xenvif_rx_ring_full(vif);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "66:  struct xenvif *vif = container_of(napi, struct xenvif, napi);",
          "67:  int work_done;",
          "71:  if (work_done < budget) {",
          "72:   int more_to_do = 0;",
          "",
          "[Removed Lines]",
          "69:  work_done = xen_netbk_tx_action(vif, budget);",
          "",
          "[Added Lines]",
          "69:  work_done = xenvif_tx_action(vif, budget);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "133:   goto drop;",
          "139:   netif_stop_queue(dev);",
          "143:  return NETDEV_TX_OK;",
          "",
          "[Removed Lines]",
          "136:  vif->rx_req_cons_peek += xen_netbk_count_skb_slots(vif, skb);",
          "138:  if (vif->can_queue && xen_netbk_must_stop_queue(vif))",
          "141:  xen_netbk_queue_tx_skb(vif, skb);",
          "",
          "[Added Lines]",
          "136:  vif->rx_req_cons_peek += xenvif_count_skb_slots(vif, skb);",
          "138:  if (vif->can_queue && xenvif_must_stop_queue(vif))",
          "141:  xenvif_queue_tx_skb(vif, skb);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "166:  enable_irq(vif->tx_irq);",
          "167:  if (vif->tx_irq != vif->rx_irq)",
          "168:   enable_irq(vif->rx_irq);",
          "170: }",
          "172: static void xenvif_down(struct xenvif *vif)",
          "",
          "[Removed Lines]",
          "169:  xen_netbk_check_rx_xenvif(vif);",
          "",
          "[Added Lines]",
          "169:  xenvif_check_rx_xenvif(vif);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "369:  __module_get(THIS_MODULE);",
          "372:  if (err < 0)",
          "373:   goto err;",
          "",
          "[Removed Lines]",
          "371:  err = xen_netbk_map_frontend_rings(vif, tx_ring_ref, rx_ring_ref);",
          "",
          "[Added Lines]",
          "371:  err = xenvif_map_frontend_rings(vif, tx_ring_ref, rx_ring_ref);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "405:  }",
          "407:  init_waitqueue_head(&vif->wq);",
          "409:        (void *)vif, vif->dev->name);",
          "410:  if (IS_ERR(vif->task)) {",
          "411:   pr_warn(\"Could not allocate kthread for %s\\n\", vif->dev->name);",
          "",
          "[Removed Lines]",
          "408:  vif->task = kthread_create(xen_netbk_kthread,",
          "",
          "[Added Lines]",
          "408:  vif->task = kthread_create(xenvif_kthread,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "433:  unbind_from_irqhandler(vif->tx_irq, vif);",
          "434:  vif->tx_irq = 0;",
          "435: err_unmap:",
          "437: err:",
          "438:  module_put(THIS_MODULE);",
          "439:  return err;",
          "",
          "[Removed Lines]",
          "436:  xen_netbk_unmap_frontend_rings(vif);",
          "",
          "[Added Lines]",
          "436:  xenvif_unmap_frontend_rings(vif);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "482:  unregister_netdev(vif->dev);",
          "486:  free_netdev(vif->dev);",
          "",
          "[Removed Lines]",
          "484:  xen_netbk_unmap_frontend_rings(vif);",
          "",
          "[Added Lines]",
          "484:  xenvif_unmap_frontend_rings(vif);",
          "",
          "---------------"
        ],
        "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
          "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:  return vif->pending_tx_info[idx].head != INVALID_PENDING_RING_IDX;",
          "81: }",
          "85: static void make_tx_response(struct xenvif *vif,",
          "86:         struct xen_netif_tx_request *txp,",
          "87:         s8       st);",
          "",
          "[Removed Lines]",
          "83: static void xen_netbk_idx_release(struct xenvif *vif, u16 pending_idx,",
          "84:       u8 status);",
          "",
          "[Added Lines]",
          "83: static void xenvif_idx_release(struct xenvif *vif, u16 pending_idx,",
          "84:           u8 status);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "150:  return max;",
          "151: }",
          "154: {",
          "155:  RING_IDX peek   = vif->rx_req_cons_peek;",
          "156:  RING_IDX needed = max_required_rx_slots(vif);",
          "",
          "[Removed Lines]",
          "153: int xen_netbk_rx_ring_full(struct xenvif *vif)",
          "",
          "[Added Lines]",
          "154: int xenvif_rx_ring_full(struct xenvif *vif)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "159:         ((vif->rx.rsp_prod_pvt + XEN_NETIF_RX_RING_SIZE - peek) < needed);",
          "160: }",
          "163: {",
          "165:   return 0;",
          "167:  vif->rx.sring->req_event = vif->rx_req_cons_peek +",
          "168:   max_required_rx_slots(vif);",
          "172: }",
          "",
          "[Removed Lines]",
          "162: int xen_netbk_must_stop_queue(struct xenvif *vif)",
          "164:  if (!xen_netbk_rx_ring_full(vif))",
          "171:  return xen_netbk_rx_ring_full(vif);",
          "",
          "[Added Lines]",
          "163: int xenvif_must_stop_queue(struct xenvif *vif)",
          "165:  if (!xenvif_rx_ring_full(vif))",
          "172:  return xenvif_rx_ring_full(vif);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "220: {",
          "221:  unsigned int count;",
          "222:  int i, copy_off;",
          "",
          "[Removed Lines]",
          "219: unsigned int xen_netbk_count_skb_slots(struct xenvif *vif, struct sk_buff *skb)",
          "",
          "[Added Lines]",
          "220: unsigned int xenvif_count_skb_slots(struct xenvif *vif, struct sk_buff *skb)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "303: {",
          "304:  struct gnttab_copy *copy_gop;",
          "305:  struct xenvif_rx_meta *meta;",
          "",
          "[Removed Lines]",
          "299: static void netbk_gop_frag_copy(struct xenvif *vif, struct sk_buff *skb,",
          "300:     struct netrx_pending_operations *npo,",
          "301:     struct page *page, unsigned long size,",
          "302:     unsigned long offset, int *head)",
          "",
          "[Added Lines]",
          "300: static void xenvif_gop_frag_copy(struct xenvif *vif, struct sk_buff *skb,",
          "301:      struct netrx_pending_operations *npo,",
          "302:      struct page *page, unsigned long size,",
          "303:      unsigned long offset, int *head)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "387: {",
          "388:  struct xenvif *vif = netdev_priv(skb->dev);",
          "389:  int nr_frags = skb_shinfo(skb)->nr_frags;",
          "",
          "[Removed Lines]",
          "385: static int netbk_gop_skb(struct sk_buff *skb,",
          "386:     struct netrx_pending_operations *npo)",
          "",
          "[Added Lines]",
          "386: static int xenvif_gop_skb(struct sk_buff *skb,",
          "387:      struct netrx_pending_operations *npo)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "426:   if (data + len > skb_tail_pointer(skb))",
          "427:    len = skb_tail_pointer(skb) - data;",
          "431:   data += len;",
          "432:  }",
          "434:  for (i = 0; i < nr_frags; i++) {",
          "440:  }",
          "442:  return npo->meta_prod - old_meta_prod;",
          "443: }",
          "453: {",
          "454:  struct gnttab_copy     *copy_op;",
          "455:  int status = XEN_NETIF_RSP_OKAY;",
          "",
          "[Removed Lines]",
          "429:   netbk_gop_frag_copy(vif, skb, npo,",
          "430:         virt_to_page(data), len, offset, &head);",
          "435:   netbk_gop_frag_copy(vif, skb, npo,",
          "436:         skb_frag_page(&skb_shinfo(skb)->frags[i]),",
          "437:         skb_frag_size(&skb_shinfo(skb)->frags[i]),",
          "438:         skb_shinfo(skb)->frags[i].page_offset,",
          "439:         &head);",
          "451: static int netbk_check_gop(struct xenvif *vif, int nr_meta_slots,",
          "452:       struct netrx_pending_operations *npo)",
          "",
          "[Added Lines]",
          "430:   xenvif_gop_frag_copy(vif, skb, npo,",
          "431:          virt_to_page(data), len, offset, &head);",
          "436:   xenvif_gop_frag_copy(vif, skb, npo,",
          "437:          skb_frag_page(&skb_shinfo(skb)->frags[i]),",
          "438:          skb_frag_size(&skb_shinfo(skb)->frags[i]),",
          "439:          skb_shinfo(skb)->frags[i].page_offset,",
          "440:          &head);",
          "452: static int xenvif_check_gop(struct xenvif *vif, int nr_meta_slots,",
          "453:        struct netrx_pending_operations *npo)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "468:  return status;",
          "469: }",
          "474: {",
          "475:  int i;",
          "476:  unsigned long offset;",
          "",
          "[Removed Lines]",
          "471: static void netbk_add_frag_responses(struct xenvif *vif, int status,",
          "472:          struct xenvif_rx_meta *meta,",
          "473:          int nr_meta_slots)",
          "",
          "[Added Lines]",
          "472: static void xenvif_add_frag_responses(struct xenvif *vif, int status,",
          "473:           struct xenvif_rx_meta *meta,",
          "474:           int nr_meta_slots)",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "498:  int meta_slots_used;",
          "499: };",
          "502: {",
          "503:  wake_up(&vif->wq);",
          "504: }",
          "507: {",
          "508:  s8 status;",
          "509:  u16 flags;",
          "",
          "[Removed Lines]",
          "501: static void xen_netbk_kick_thread(struct xenvif *vif)",
          "506: void xen_netbk_rx_action(struct xenvif *vif)",
          "",
          "[Added Lines]",
          "502: static void xenvif_kick_thread(struct xenvif *vif)",
          "507: void xenvif_rx_action(struct xenvif *vif)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "532:   nr_frags = skb_shinfo(skb)->nr_frags;",
          "534:   sco = (struct skb_cb_overlay *)skb->cb;",
          "537:   count += nr_frags + 1;",
          "",
          "[Removed Lines]",
          "535:   sco->meta_slots_used = netbk_gop_skb(skb, &npo);",
          "",
          "[Added Lines]",
          "536:   sco->meta_slots_used = xenvif_gop_skb(skb, &npo);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "575:   vif->dev->stats.tx_bytes += skb->len;",
          "576:   vif->dev->stats.tx_packets++;",
          "580:   if (sco->meta_slots_used == 1)",
          "581:    flags = 0;",
          "",
          "[Removed Lines]",
          "578:   status = netbk_check_gop(vif, sco->meta_slots_used, &npo);",
          "",
          "[Added Lines]",
          "579:   status = xenvif_check_gop(vif, sco->meta_slots_used, &npo);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "611:    gso->flags = 0;",
          "612:   }",
          "618:   RING_PUSH_RESPONSES_AND_CHECK_NOTIFY(&vif->rx, ret);",
          "",
          "[Removed Lines]",
          "614:   netbk_add_frag_responses(vif, status,",
          "615:       vif->meta + npo.meta_cons + 1,",
          "616:       sco->meta_slots_used);",
          "",
          "[Added Lines]",
          "615:   xenvif_add_frag_responses(vif, status,",
          "616:        vif->meta + npo.meta_cons + 1,",
          "617:        sco->meta_slots_used);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "633:  if (!skb_queue_empty(&vif->rx_queue))",
          "635: }",
          "638: {",
          "639:  skb_queue_tail(&vif->rx_queue, skb);",
          "642: }",
          "645: {",
          "646:  int more_to_do;",
          "",
          "[Removed Lines]",
          "634:   xen_netbk_kick_thread(vif);",
          "637: void xen_netbk_queue_tx_skb(struct xenvif *vif, struct sk_buff *skb)",
          "641:  xen_netbk_kick_thread(vif);",
          "644: void xen_netbk_check_rx_xenvif(struct xenvif *vif)",
          "",
          "[Added Lines]",
          "635:   xenvif_kick_thread(vif);",
          "638: void xenvif_queue_tx_skb(struct xenvif *vif, struct sk_buff *skb)",
          "642:  xenvif_kick_thread(vif);",
          "645: void xenvif_check_rx_xenvif(struct xenvif *vif)",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "675: {",
          "676:  struct xenvif *vif = (struct xenvif *)data;",
          "677:  tx_add_credit(vif);",
          "679: }",
          "683: {",
          "684:  RING_IDX cons = vif->tx.req_cons;",
          "",
          "[Removed Lines]",
          "678:  xen_netbk_check_rx_xenvif(vif);",
          "681: static void netbk_tx_err(struct xenvif *vif,",
          "682:     struct xen_netif_tx_request *txp, RING_IDX end)",
          "",
          "[Added Lines]",
          "679:  xenvif_check_rx_xenvif(vif);",
          "682: static void xenvif_tx_err(struct xenvif *vif,",
          "683:      struct xen_netif_tx_request *txp, RING_IDX end)",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "692:  vif->tx.req_cons = cons;",
          "693: }",
          "696: {",
          "697:  netdev_err(vif->dev, \"fatal error; disabling device\\n\");",
          "698:  xenvif_carrier_off(vif);",
          "699: }",
          "705: {",
          "706:  RING_IDX cons = vif->tx.req_cons;",
          "707:  int slots = 0;",
          "",
          "[Removed Lines]",
          "695: static void netbk_fatal_tx_err(struct xenvif *vif)",
          "701: static int netbk_count_requests(struct xenvif *vif,",
          "702:     struct xen_netif_tx_request *first,",
          "703:     struct xen_netif_tx_request *txp,",
          "704:     int work_to_do)",
          "",
          "[Added Lines]",
          "696: static void xenvif_fatal_tx_err(struct xenvif *vif)",
          "702: static int xenvif_count_requests(struct xenvif *vif,",
          "703:      struct xen_netif_tx_request *first,",
          "704:      struct xen_netif_tx_request *txp,",
          "705:      int work_to_do)",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "718:    netdev_err(vif->dev,",
          "719:        \"Asked for %d slots but exceeds this limit\\n\",",
          "720:        work_to_do);",
          "722:    return -ENODATA;",
          "723:   }",
          "",
          "[Removed Lines]",
          "721:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "722:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "729:    netdev_err(vif->dev,",
          "730:        \"Malicious frontend using %d slots, threshold %u\\n\",",
          "731:        slots, fatal_skb_slots);",
          "733:    return -E2BIG;",
          "734:   }",
          "",
          "[Removed Lines]",
          "732:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "733:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "777:   if (unlikely((txp->offset + txp->size) > PAGE_SIZE)) {",
          "778:    netdev_err(vif->dev, \"Cross page boundary, txp->offset: %x, size: %u\\n\",",
          "779:      txp->offset, txp->size);",
          "781:    return -EINVAL;",
          "782:   }",
          "",
          "[Removed Lines]",
          "780:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "781:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "789:  } while (more_data);",
          "791:  if (drop_err) {",
          "793:   return drop_err;",
          "794:  }",
          "796:  return slots;",
          "797: }",
          "801: {",
          "802:  struct page *page;",
          "",
          "[Removed Lines]",
          "792:   netbk_tx_err(vif, first, cons + slots);",
          "799: static struct page *xen_netbk_alloc_page(struct xenvif *vif,",
          "800:       u16 pending_idx)",
          "",
          "[Added Lines]",
          "793:   xenvif_tx_err(vif, first, cons + slots);",
          "800: static struct page *xenvif_alloc_page(struct xenvif *vif,",
          "801:           u16 pending_idx)",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "809:  return page;",
          "810: }",
          "816: {",
          "817:  struct skb_shared_info *shinfo = skb_shinfo(skb);",
          "818:  skb_frag_t *frags = shinfo->frags;",
          "",
          "[Removed Lines]",
          "812: static struct gnttab_copy *xen_netbk_get_requests(struct xenvif *vif,",
          "813:         struct sk_buff *skb,",
          "814:         struct xen_netif_tx_request *txp,",
          "815:         struct gnttab_copy *gop)",
          "",
          "[Added Lines]",
          "813: static struct gnttab_copy *xenvif_get_requests(struct xenvif *vif,",
          "814:             struct sk_buff *skb,",
          "815:             struct xen_netif_tx_request *txp,",
          "816:             struct gnttab_copy *gop)",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "918: err:",
          "920:  while (shinfo->nr_frags-- > start) {",
          "922:     frag_get_pending_idx(&frags[shinfo->nr_frags]),",
          "923:     XEN_NETIF_RSP_ERROR);",
          "924:  }",
          "926:  if (start)",
          "929:  return NULL;",
          "930: }",
          "935: {",
          "936:  struct gnttab_copy *gop = *gopp;",
          "937:  u16 pending_idx = *((u16 *)skb->data);",
          "",
          "[Removed Lines]",
          "921:   xen_netbk_idx_release(vif,",
          "927:   xen_netbk_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "932: static int xen_netbk_tx_check_gop(struct xenvif *vif,",
          "933:       struct sk_buff *skb,",
          "934:       struct gnttab_copy **gopp)",
          "",
          "[Added Lines]",
          "922:   xenvif_idx_release(vif,",
          "928:   xenvif_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "933: static int xenvif_tx_check_gop(struct xenvif *vif,",
          "934:           struct sk_buff *skb,",
          "935:           struct gnttab_copy **gopp)",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "945:  err = gop->status;",
          "946:  if (unlikely(err))",
          "950:  start = (frag_get_pending_idx(&shinfo->frags[0]) == pending_idx);",
          "",
          "[Removed Lines]",
          "947:   xen_netbk_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "",
          "[Added Lines]",
          "948:   xenvif_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "968:   if (likely(!newerr)) {",
          "970:    if (unlikely(err))",
          "973:    continue;",
          "974:   }",
          "980:   if (err)",
          "",
          "[Removed Lines]",
          "971:     xen_netbk_idx_release(vif, pending_idx,",
          "972:             XEN_NETIF_RSP_OKAY);",
          "977:   xen_netbk_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "",
          "[Added Lines]",
          "972:     xenvif_idx_release(vif, pending_idx,",
          "973:          XEN_NETIF_RSP_OKAY);",
          "978:   xenvif_idx_release(vif, pending_idx, XEN_NETIF_RSP_ERROR);",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "984:   pending_idx = *((u16 *)skb->data);",
          "986:   for (j = start; j < i; j++) {",
          "987:    pending_idx = frag_get_pending_idx(&shinfo->frags[j]);",
          "990:   }",
          "",
          "[Removed Lines]",
          "985:   xen_netbk_idx_release(vif, pending_idx, XEN_NETIF_RSP_OKAY);",
          "988:    xen_netbk_idx_release(vif, pending_idx,",
          "989:            XEN_NETIF_RSP_OKAY);",
          "",
          "[Added Lines]",
          "986:   xenvif_idx_release(vif, pending_idx, XEN_NETIF_RSP_OKAY);",
          "989:    xenvif_idx_release(vif, pending_idx,",
          "990:         XEN_NETIF_RSP_OKAY);",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "997:  return err;",
          "998: }",
          "1001: {",
          "1002:  struct skb_shared_info *shinfo = skb_shinfo(skb);",
          "1003:  int nr_frags = shinfo->nr_frags;",
          "",
          "[Removed Lines]",
          "1000: static void xen_netbk_fill_frags(struct xenvif *vif, struct sk_buff *skb)",
          "",
          "[Added Lines]",
          "1001: static void xenvif_fill_frags(struct xenvif *vif, struct sk_buff *skb)",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "1018:   skb->data_len += txp->size;",
          "1019:   skb->truesize += txp->size;",
          "1022:   get_page(vif->mmap_pages[pending_idx]);",
          "1024:  }",
          "1025: }",
          "1028:     struct xen_netif_extra_info *extras,",
          "1029:     int work_to_do)",
          "1030: {",
          "",
          "[Removed Lines]",
          "1023:   xen_netbk_idx_release(vif, pending_idx, XEN_NETIF_RSP_OKAY);",
          "1027: static int xen_netbk_get_extras(struct xenvif *vif,",
          "",
          "[Added Lines]",
          "1024:   xenvif_idx_release(vif, pending_idx, XEN_NETIF_RSP_OKAY);",
          "1028: static int xenvif_get_extras(struct xenvif *vif,",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "1034:  do {",
          "1035:   if (unlikely(work_to_do-- <= 0)) {",
          "1036:    netdev_err(vif->dev, \"Missing extra info\\n\");",
          "1038:    return -EBADR;",
          "1039:   }",
          "",
          "[Removed Lines]",
          "1037:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "1038:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "1045:    vif->tx.req_cons = ++cons;",
          "1046:    netdev_err(vif->dev,",
          "1047:        \"Invalid extra type: %d\\n\", extra.type);",
          "1049:    return -EINVAL;",
          "1050:   }",
          "",
          "[Removed Lines]",
          "1048:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "1049:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "1056:  return work_to_do;",
          "1057: }",
          "1062: {",
          "1063:  if (!gso->u.gso.size) {",
          "1064:   netdev_err(vif->dev, \"GSO size must not be zero.\\n\");",
          "1066:   return -EINVAL;",
          "1067:  }",
          "1070:  if (gso->u.gso.type != XEN_NETIF_GSO_TYPE_TCPV4) {",
          "1071:   netdev_err(vif->dev, \"Bad GSO type %d.\\n\", gso->u.gso.type);",
          "1073:   return -EINVAL;",
          "1074:  }",
          "",
          "[Removed Lines]",
          "1059: static int netbk_set_skb_gso(struct xenvif *vif,",
          "1060:         struct sk_buff *skb,",
          "1061:         struct xen_netif_extra_info *gso)",
          "1065:   netbk_fatal_tx_err(vif);",
          "1072:   netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "1060: static int xenvif_set_skb_gso(struct xenvif *vif,",
          "1061:          struct sk_buff *skb,",
          "1062:          struct xen_netif_extra_info *gso)",
          "1066:   xenvif_fatal_tx_err(vif);",
          "1073:   xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "1180:  return false;",
          "1181: }",
          "1184: {",
          "1185:  struct gnttab_copy *gop = vif->tx_copy_ops, *request_gop;",
          "1186:  struct sk_buff *skb;",
          "",
          "[Removed Lines]",
          "1183: static unsigned xen_netbk_tx_build_gops(struct xenvif *vif)",
          "",
          "[Added Lines]",
          "1184: static unsigned xenvif_tx_build_gops(struct xenvif *vif)",
          "",
          "---------------",
          "--- Hunk 31 ---",
          "[Context before]",
          "1205:        \"req_prod %d, req_cons %d, size %ld\\n\",",
          "1206:        vif->tx.sring->req_prod, vif->tx.req_cons,",
          "1207:        XEN_NETIF_TX_RING_SIZE);",
          "1209:    continue;",
          "1210:   }",
          "",
          "[Removed Lines]",
          "1208:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "1209:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 32 ---",
          "[Context before]",
          "1230:   memset(extras, 0, sizeof(extras));",
          "1231:   if (txreq.flags & XEN_NETTXF_extra_info) {",
          "1234:    idx = vif->tx.req_cons;",
          "1235:    if (unlikely(work_to_do < 0))",
          "1236:     break;",
          "1237:   }",
          "1240:   if (unlikely(ret < 0))",
          "1241:    break;",
          "",
          "[Removed Lines]",
          "1232:    work_to_do = xen_netbk_get_extras(vif, extras,",
          "1233:          work_to_do);",
          "1239:   ret = netbk_count_requests(vif, &txreq, txfrags, work_to_do);",
          "",
          "[Added Lines]",
          "1233:    work_to_do = xenvif_get_extras(vif, extras,",
          "1234:              work_to_do);",
          "1240:   ret = xenvif_count_requests(vif, &txreq, txfrags, work_to_do);",
          "",
          "---------------",
          "--- Hunk 33 ---",
          "[Context before]",
          "1245:   if (unlikely(txreq.size < ETH_HLEN)) {",
          "1246:    netdev_dbg(vif->dev,",
          "1247:        \"Bad packet size: %d\\n\", txreq.size);",
          "1249:    break;",
          "1250:   }",
          "",
          "[Removed Lines]",
          "1248:    netbk_tx_err(vif, &txreq, idx);",
          "",
          "[Added Lines]",
          "1249:    xenvif_tx_err(vif, &txreq, idx);",
          "",
          "---------------",
          "--- Hunk 34 ---",
          "[Context before]",
          "1255:        \"txreq.offset: %x, size: %u, end: %lu\\n\",",
          "1256:        txreq.offset, txreq.size,",
          "1257:        (txreq.offset&~PAGE_MASK) + txreq.size);",
          "1259:    break;",
          "1260:   }",
          "",
          "[Removed Lines]",
          "1258:    netbk_fatal_tx_err(vif);",
          "",
          "[Added Lines]",
          "1259:    xenvif_fatal_tx_err(vif);",
          "",
          "---------------",
          "--- Hunk 35 ---",
          "[Context before]",
          "1271:   if (unlikely(skb == NULL)) {",
          "1272:    netdev_dbg(vif->dev,",
          "1273:        \"Can't allocate a skb in start_xmit.\\n\");",
          "1275:    break;",
          "1276:   }",
          "",
          "[Removed Lines]",
          "1274:    netbk_tx_err(vif, &txreq, idx);",
          "",
          "[Added Lines]",
          "1275:    xenvif_tx_err(vif, &txreq, idx);",
          "",
          "---------------",
          "--- Hunk 36 ---",
          "[Context before]",
          "1282:    struct xen_netif_extra_info *gso;",
          "1283:    gso = &extras[XEN_NETIF_EXTRA_TYPE_GSO - 1];",
          "1287:     kfree_skb(skb);",
          "1288:     break;",
          "1289:    }",
          "1290:   }",
          "1294:   if (!page) {",
          "1295:    kfree_skb(skb);",
          "1297:    break;",
          "1298:   }",
          "",
          "[Removed Lines]",
          "1285:    if (netbk_set_skb_gso(vif, skb, gso)) {",
          "1293:   page = xen_netbk_alloc_page(vif, pending_idx);",
          "1296:    netbk_tx_err(vif, &txreq, idx);",
          "",
          "[Added Lines]",
          "1286:    if (xenvif_set_skb_gso(vif, skb, gso)) {",
          "1294:   page = xenvif_alloc_page(vif, pending_idx);",
          "1297:    xenvif_tx_err(vif, &txreq, idx);",
          "",
          "---------------",
          "--- Hunk 37 ---",
          "[Context before]",
          "1330:   vif->pending_cons++;",
          "1333:   if (request_gop == NULL) {",
          "1334:    kfree_skb(skb);",
          "1336:    break;",
          "1337:   }",
          "1338:   gop = request_gop;",
          "",
          "[Removed Lines]",
          "1332:   request_gop = xen_netbk_get_requests(vif, skb, txfrags, gop);",
          "1335:    netbk_tx_err(vif, &txreq, idx);",
          "",
          "[Added Lines]",
          "1333:   request_gop = xenvif_get_requests(vif, skb, txfrags, gop);",
          "1336:    xenvif_tx_err(vif, &txreq, idx);",
          "",
          "---------------",
          "--- Hunk 38 ---",
          "[Context before]",
          "1349: }",
          "1353: {",
          "1354:  struct gnttab_copy *gop = vif->tx_copy_ops;",
          "1355:  struct sk_buff *skb;",
          "",
          "[Removed Lines]",
          "1352: static int xen_netbk_tx_submit(struct xenvif *vif, int budget)",
          "",
          "[Added Lines]",
          "1353: static int xenvif_tx_submit(struct xenvif *vif, int budget)",
          "",
          "---------------",
          "--- Hunk 39 ---",
          "[Context before]",
          "1365:   txp = &vif->pending_tx_info[pending_idx].req;",
          "1369:    netdev_dbg(vif->dev, \"netback grant failed.\\n\");",
          "1370:    skb_shinfo(skb)->nr_frags = 0;",
          "1371:    kfree_skb(skb);",
          "",
          "[Removed Lines]",
          "1368:   if (unlikely(xen_netbk_tx_check_gop(vif, skb, &gop))) {",
          "",
          "[Added Lines]",
          "1369:   if (unlikely(xenvif_tx_check_gop(vif, skb, &gop))) {",
          "",
          "---------------",
          "--- Hunk 40 ---",
          "[Context before]",
          "1382:    txp->size -= data_len;",
          "1383:   } else {",
          "1387:   }",
          "1389:   if (txp->flags & XEN_NETTXF_csum_blank)",
          "",
          "[Removed Lines]",
          "1385:    xen_netbk_idx_release(vif, pending_idx,",
          "1386:            XEN_NETIF_RSP_OKAY);",
          "",
          "[Added Lines]",
          "1386:    xenvif_idx_release(vif, pending_idx,",
          "1387:         XEN_NETIF_RSP_OKAY);",
          "",
          "---------------",
          "--- Hunk 41 ---",
          "[Context before]",
          "1391:   else if (txp->flags & XEN_NETTXF_data_validated)",
          "1392:    skb->ip_summed = CHECKSUM_UNNECESSARY;",
          "",
          "[Removed Lines]",
          "1394:   xen_netbk_fill_frags(vif, skb);",
          "",
          "[Added Lines]",
          "1395:   xenvif_fill_frags(vif, skb);",
          "",
          "---------------",
          "--- Hunk 42 ---",
          "[Context before]",
          "1428: }",
          "1432: {",
          "1433:  unsigned nr_gops;",
          "1434:  int work_done;",
          "",
          "[Removed Lines]",
          "1431: int xen_netbk_tx_action(struct xenvif *vif, int budget)",
          "",
          "[Added Lines]",
          "1432: int xenvif_tx_action(struct xenvif *vif, int budget)",
          "",
          "---------------",
          "--- Hunk 43 ---",
          "[Context before]",
          "1436:  if (unlikely(!tx_work_todo(vif)))",
          "1437:   return 0;",
          "1441:  if (nr_gops == 0)",
          "1442:   return 0;",
          "1444:  gnttab_batch_copy(vif->tx_copy_ops, nr_gops);",
          "1448:  return work_done;",
          "1449: }",
          "1453: {",
          "1454:  struct pending_tx_info *pending_tx_info;",
          "1455:  pending_ring_idx_t head;",
          "",
          "[Removed Lines]",
          "1439:  nr_gops = xen_netbk_tx_build_gops(vif);",
          "1446:  work_done = xen_netbk_tx_submit(vif, nr_gops);",
          "1451: static void xen_netbk_idx_release(struct xenvif *vif, u16 pending_idx,",
          "1452:       u8 status)",
          "",
          "[Added Lines]",
          "1440:  nr_gops = xenvif_tx_build_gops(vif);",
          "1447:  work_done = xenvif_tx_submit(vif, nr_gops);",
          "1452: static void xenvif_idx_release(struct xenvif *vif, u16 pending_idx,",
          "1453:           u8 status)",
          "",
          "---------------",
          "--- Hunk 44 ---",
          "[Context before]",
          "1554:  return 0;",
          "1555: }",
          "1558: {",
          "1559:  if (vif->tx.sring)",
          "1560:   xenbus_unmap_ring_vfree(xenvif_to_xenbus_device(vif),",
          "",
          "[Removed Lines]",
          "1557: void xen_netbk_unmap_frontend_rings(struct xenvif *vif)",
          "",
          "[Added Lines]",
          "1558: void xenvif_unmap_frontend_rings(struct xenvif *vif)",
          "",
          "---------------",
          "--- Hunk 45 ---",
          "[Context before]",
          "1564:      vif->rx.sring);",
          "1565: }",
          "1570: {",
          "1571:  void *addr;",
          "1572:  struct xen_netif_tx_sring *txs;",
          "",
          "[Removed Lines]",
          "1567: int xen_netbk_map_frontend_rings(struct xenvif *vif,",
          "1568:      grant_ref_t tx_ring_ref,",
          "1569:      grant_ref_t rx_ring_ref)",
          "",
          "[Added Lines]",
          "1568: int xenvif_map_frontend_rings(struct xenvif *vif,",
          "1569:          grant_ref_t tx_ring_ref,",
          "1570:          grant_ref_t rx_ring_ref)",
          "",
          "---------------",
          "--- Hunk 46 ---",
          "[Context before]",
          "1595:  return 0;",
          "1597: err:",
          "1599:  return err;",
          "1600: }",
          "1603: {",
          "1604:  struct xenvif *vif = data;",
          "",
          "[Removed Lines]",
          "1598:  xen_netbk_unmap_frontend_rings(vif);",
          "1602: int xen_netbk_kthread(void *data)",
          "",
          "[Added Lines]",
          "1599:  xenvif_unmap_frontend_rings(vif);",
          "1603: int xenvif_kthread(void *data)",
          "",
          "---------------",
          "--- Hunk 47 ---",
          "[Context before]",
          "1611:    break;",
          "1613:   if (rx_work_todo(vif))",
          "1616:   cond_resched();",
          "1617:  }",
          "",
          "[Removed Lines]",
          "1614:    xen_netbk_rx_action(vif);",
          "",
          "[Added Lines]",
          "1615:    xenvif_rx_action(vif);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "03393fd5cc2b6cdeec32b704ecba64dbb0feae3c",
      "candidate_info": {
        "commit_hash": "03393fd5cc2b6cdeec32b704ecba64dbb0feae3c",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/03393fd5cc2b6cdeec32b704ecba64dbb0feae3c",
        "files": [
          "drivers/net/xen-netback/netback.c"
        ],
        "message": "xen-netback: don't disconnect frontend when seeing oversize packet\n\nSome frontend drivers are sending packets > 64 KiB in length. This length\noverflows the length field in the first slot making the following slots have\nan invalid length.\n\nTurn this error back into a non-fatal error by dropping the packet. To avoid\nhaving the following slots having fatal errors, consume all slots in the\npacket.\n\nThis does not reopen the security hole in XSA-39 as if the packet as an\ninvalid number of slots it will still hit fatal error case.\n\nSigned-off-by: David Vrabel <david.vrabel@citrix.com>\nSigned-off-by: Wei Liu <wei.liu2@citrix.com>\nAcked-by: Ian Campbell <ian.campbell@citrix.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ],
          "candidate": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
          "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "976:   memcpy(txp, RING_GET_REQUEST(&vif->tx, cons + slots),",
          "977:          sizeof(*txp));",
          "984:   }",
          "986:   first->size -= txp->size;",
          "",
          "[Removed Lines]",
          "978:   if (txp->size > first->size) {",
          "979:    netdev_err(vif->dev,",
          "980:        \"Invalid tx request, slot size %u > remaining size %u\\n\",",
          "981:        txp->size, first->size);",
          "982:    netbk_fatal_tx_err(vif);",
          "983:    return -EIO;",
          "",
          "[Added Lines]",
          "988:   if (!drop_err && txp->size > first->size) {",
          "989:    if (net_ratelimit())",
          "990:     netdev_dbg(vif->dev,",
          "991:         \"Invalid tx request, slot size %u > remaining size %u\\n\",",
          "992:         txp->size, first->size);",
          "993:    drop_err = -EIO;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2810e5b9a7731ca5fce22bfbe12c96e16ac44b6f",
      "candidate_info": {
        "commit_hash": "2810e5b9a7731ca5fce22bfbe12c96e16ac44b6f",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/2810e5b9a7731ca5fce22bfbe12c96e16ac44b6f",
        "files": [
          "drivers/net/xen-netback/netback.c",
          "include/xen/interface/io/netif.h"
        ],
        "message": "xen-netback: coalesce slots in TX path and fix regressions\n\nThis patch tries to coalesce tx requests when constructing grant copy\nstructures. It enables netback to deal with situation when frontend's\nMAX_SKB_FRAGS is larger than backend's MAX_SKB_FRAGS.\n\nWith the help of coalescing, this patch tries to address two regressions\navoid reopening the security hole in XSA-39.\n\nRegression 1. The reduction of the number of supported ring entries (slots)\nper packet (from 18 to 17). This regression has been around for some time but\nremains unnoticed until XSA-39 security fix. This is fixed by coalescing\nslots.\n\nRegression 2. The XSA-39 security fix turning \"too many frags\" errors from\njust dropping the packet to a fatal error and disabling the VIF. This is fixed\nby coalescing slots (handling 18 slots when backend's MAX_SKB_FRAGS is 17)\nwhich rules out false positive (using 18 slots is legit) and dropping packets\nusing 19 to `max_skb_slots` slots.\n\nTo avoid reopening security hole in XSA-39, frontend sending packet using more\nthan max_skb_slots is considered malicious.\n\nThe behavior of netback for packet is thus:\n\n    1-18            slots: valid\n   19-max_skb_slots slots: drop and respond with an error\n   max_skb_slots+   slots: fatal error\n\nmax_skb_slots is configurable by admin, default value is 20.\n\nAlso change variable name from \"frags\" to \"slots\" in netbk_count_requests.\n\nPlease note that RX path still has dependency on MAX_SKB_FRAGS. This will be\nfixed with separate patch.\n\nSigned-off-by: Wei Liu <wei.liu2@citrix.com>\nAcked-by: Ian Campbell <ian.campbell@citrix.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c",
          "include/xen/interface/io/netif.h||include/xen/interface/io/netif.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ],
          "candidate": [
            "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/xen-netback/netback.c||drivers/net/xen-netback/netback.c": [
          "File: drivers/net/xen-netback/netback.c -> drivers/net/xen-netback/netback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47: #include <asm/xen/hypercall.h>",
          "48: #include <asm/xen/page.h>",
          "50: struct pending_tx_info {",
          "52:  struct xenvif *vif;",
          "53: };",
          "56: struct netbk_rx_meta {",
          "57:  int id;",
          "",
          "[Removed Lines]",
          "51:  struct xen_netif_tx_request req;",
          "54: typedef unsigned int pending_ring_idx_t;",
          "",
          "[Added Lines]",
          "54: #define MAX_SKB_SLOTS_DEFAULT 20",
          "55: static unsigned int max_skb_slots = MAX_SKB_SLOTS_DEFAULT;",
          "56: module_param(max_skb_slots, uint, 0444);",
          "58: typedef unsigned int pending_ring_idx_t;",
          "59: #define INVALID_PENDING_RING_IDX (~0U)",
          "64:  pending_ring_idx_t head; /* head != INVALID_PENDING_RING_IDX",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "102:  atomic_t netfront_count;",
          "104:  struct pending_tx_info pending_tx_info[MAX_PENDING_REQS];",
          "107:  u16 pending_ring[MAX_PENDING_REQS];",
          "",
          "[Removed Lines]",
          "105:  struct gnttab_copy tx_copy_ops[MAX_PENDING_REQS];",
          "",
          "[Added Lines]",
          "123:  struct gnttab_copy tx_copy_ops[2*MAX_PENDING_REQS];",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "118: static struct xen_netbk *xen_netbk;",
          "119: static int xen_netbk_group_nr;",
          "121: void xen_netbk_add_xenvif(struct xenvif *vif)",
          "122: {",
          "123:  int i;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "144: static inline int pending_tx_is_head(struct xen_netbk *netbk, RING_IDX idx)",
          "145: {",
          "146:  return netbk->pending_tx_info[idx].head != INVALID_PENDING_RING_IDX;",
          "147: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "899: static int netbk_count_requests(struct xenvif *vif,",
          "900:     struct xen_netif_tx_request *first,",
          "901:     struct xen_netif_tx_request *txp,",
          "902:     int work_to_do)",
          "903: {",
          "904:  RING_IDX cons = vif->tx.req_cons;",
          "907:  if (!(first->flags & XEN_NETTXF_more_data))",
          "908:   return 0;",
          "910:  do {",
          "913:    netbk_fatal_tx_err(vif);",
          "914:    return -ENODATA;",
          "915:   }",
          "919:    netbk_fatal_tx_err(vif);",
          "920:    return -E2BIG;",
          "921:   }",
          "924:          sizeof(*txp));",
          "925:   if (txp->size > first->size) {",
          "927:    netbk_fatal_tx_err(vif);",
          "928:    return -EIO;",
          "929:   }",
          "931:   first->size -= txp->size;",
          "934:   if (unlikely((txp->offset + txp->size) > PAGE_SIZE)) {",
          "936:      txp->offset, txp->size);",
          "937:    netbk_fatal_tx_err(vif);",
          "938:    return -EINVAL;",
          "939:   }",
          "940:  } while ((txp++)->flags & XEN_NETTXF_more_data);",
          "942: }",
          "944: static struct page *xen_netbk_alloc_page(struct xen_netbk *netbk,",
          "",
          "[Removed Lines]",
          "905:  int frags = 0;",
          "911:   if (frags >= work_to_do) {",
          "912:    netdev_err(vif->dev, \"Need more frags\\n\");",
          "917:   if (unlikely(frags >= MAX_SKB_FRAGS)) {",
          "918:    netdev_err(vif->dev, \"Too many frags\\n\");",
          "923:   memcpy(txp, RING_GET_REQUEST(&vif->tx, cons + frags),",
          "926:    netdev_err(vif->dev, \"Frag is bigger than frame.\\n\");",
          "932:   frags++;",
          "935:    netdev_err(vif->dev, \"txp->offset: %x, size: %u\\n\",",
          "941:  return frags;",
          "",
          "[Added Lines]",
          "931:     RING_IDX first_idx,",
          "936:  int slots = 0;",
          "937:  int drop_err = 0;",
          "943:   if (slots >= work_to_do) {",
          "944:    netdev_err(vif->dev,",
          "945:        \"Asked for %d slots but exceeds this limit\\n\",",
          "946:        work_to_do);",
          "954:   if (unlikely(slots >= max_skb_slots)) {",
          "955:    netdev_err(vif->dev,",
          "956:        \"Malicious frontend using %d slots, threshold %u\\n\",",
          "957:        slots, max_skb_slots);",
          "968:   if (!drop_err && slots >= XEN_NETIF_NR_SLOTS_MIN) {",
          "969:    if (net_ratelimit())",
          "970:     netdev_dbg(vif->dev,",
          "971:         \"Too many slots (%d) exceeding limit (%d), dropping packet\\n\",",
          "972:         slots, XEN_NETIF_NR_SLOTS_MIN);",
          "973:    drop_err = -E2BIG;",
          "974:   }",
          "976:   memcpy(txp, RING_GET_REQUEST(&vif->tx, cons + slots),",
          "979:    netdev_err(vif->dev,",
          "980:        \"Invalid tx request, slot size %u > remaining size %u\\n\",",
          "981:        txp->size, first->size);",
          "987:   slots++;",
          "990:    netdev_err(vif->dev, \"Cross page boundary, txp->offset: %x, size: %u\\n\",",
          "997:  if (drop_err) {",
          "998:   netbk_tx_err(vif, first, first_idx + slots);",
          "999:   return drop_err;",
          "1000:  }",
          "1002:  return slots;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "962:  struct skb_shared_info *shinfo = skb_shinfo(skb);",
          "963:  skb_frag_t *frags = shinfo->frags;",
          "964:  u16 pending_idx = *((u16 *)skb->data);",
          "968:  start = (frag_get_pending_idx(&shinfo->frags[0]) == pending_idx);",
          "973:   struct pending_tx_info *pending_tx_info =",
          "974:    netbk->pending_tx_info;",
          "979:   if (!page)",
          "980:    goto err;",
          "999:  }",
          "1001:  return gop;",
          "1002: err:",
          "1007:  }",
          "1009:  if (start)",
          "",
          "[Removed Lines]",
          "965:  int i, start;",
          "970:  for (i = start; i < shinfo->nr_frags; i++, txp++) {",
          "971:   struct page *page;",
          "972:   pending_ring_idx_t index;",
          "976:   index = pending_index(netbk->pending_cons++);",
          "977:   pending_idx = netbk->pending_ring[index];",
          "978:   page = xen_netbk_alloc_page(netbk, pending_idx);",
          "982:   gop->source.u.ref = txp->gref;",
          "983:   gop->source.domid = vif->domid;",
          "984:   gop->source.offset = txp->offset;",
          "986:   gop->dest.u.gmfn = virt_to_mfn(page_address(page));",
          "987:   gop->dest.domid = DOMID_SELF;",
          "988:   gop->dest.offset = txp->offset;",
          "990:   gop->len = txp->size;",
          "991:   gop->flags = GNTCOPY_source_gref;",
          "993:   gop++;",
          "995:   memcpy(&pending_tx_info[pending_idx].req, txp, sizeof(*txp));",
          "996:   xenvif_get(vif);",
          "997:   pending_tx_info[pending_idx].vif = vif;",
          "998:   frag_set_pending_idx(&frags[i], pending_idx);",
          "1004:  while (i-- > start) {",
          "1005:   xen_netbk_idx_release(netbk, frag_get_pending_idx(&frags[i]),",
          "1006:           XEN_NETIF_RSP_ERROR);",
          "",
          "[Added Lines]",
          "1026:  u16 head_idx = 0;",
          "1027:  int slot, start;",
          "1028:  struct page *page;",
          "1029:  pending_ring_idx_t index, start_idx = 0;",
          "1030:  uint16_t dst_offset;",
          "1031:  unsigned int nr_slots;",
          "1032:  struct pending_tx_info *first = NULL;",
          "1037:  nr_slots = shinfo->nr_frags;",
          "1046:  for (shinfo->nr_frags = slot = start; slot < nr_slots;",
          "1047:       shinfo->nr_frags++) {",
          "1051:   page = alloc_page(GFP_KERNEL|__GFP_COLD);",
          "1055:   dst_offset = 0;",
          "1056:   first = NULL;",
          "1057:   while (dst_offset < PAGE_SIZE && slot < nr_slots) {",
          "1058:    gop->flags = GNTCOPY_source_gref;",
          "1060:    gop->source.u.ref = txp->gref;",
          "1061:    gop->source.domid = vif->domid;",
          "1062:    gop->source.offset = txp->offset;",
          "1064:    gop->dest.domid = DOMID_SELF;",
          "1066:    gop->dest.offset = dst_offset;",
          "1067:    gop->dest.u.gmfn = virt_to_mfn(page_address(page));",
          "1069:    if (dst_offset + txp->size > PAGE_SIZE) {",
          "1077:     gop->len = PAGE_SIZE - dst_offset;",
          "1078:     txp->offset += gop->len;",
          "1079:     txp->size -= gop->len;",
          "1081:    } else {",
          "1083:     gop->len = txp->size;",
          "1084:     dst_offset += gop->len;",
          "1086:     index = pending_index(netbk->pending_cons++);",
          "1088:     pending_idx = netbk->pending_ring[index];",
          "1090:     memcpy(&pending_tx_info[pending_idx].req, txp,",
          "1091:            sizeof(*txp));",
          "1092:     xenvif_get(vif);",
          "1094:     pending_tx_info[pending_idx].vif = vif;",
          "1100:     netbk->mmap_pages[pending_idx] = (void *)(~0UL);",
          "1101:     pending_tx_info[pending_idx].head =",
          "1102:      INVALID_PENDING_RING_IDX;",
          "1104:     if (!first) {",
          "1105:      first = &pending_tx_info[pending_idx];",
          "1106:      start_idx = index;",
          "1107:      head_idx = pending_idx;",
          "1108:     }",
          "1110:     txp++;",
          "1111:     slot++;",
          "1112:    }",
          "1114:    gop++;",
          "1115:   }",
          "1117:   first->req.offset = 0;",
          "1118:   first->req.size = dst_offset;",
          "1119:   first->head = start_idx;",
          "1120:   set_page_ext(page, netbk, head_idx);",
          "1121:   netbk->mmap_pages[head_idx] = page;",
          "1122:   frag_set_pending_idx(&frags[shinfo->nr_frags], head_idx);",
          "1125:  BUG_ON(shinfo->nr_frags > MAX_SKB_FRAGS);",
          "1130:  while (shinfo->nr_frags-- > start) {",
          "1131:   xen_netbk_idx_release(netbk,",
          "1132:     frag_get_pending_idx(&frags[shinfo->nr_frags]),",
          "1133:     XEN_NETIF_RSP_ERROR);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1019:  struct gnttab_copy *gop = *gopp;",
          "1020:  u16 pending_idx = *((u16 *)skb->data);",
          "1021:  struct skb_shared_info *shinfo = skb_shinfo(skb);",
          "1022:  int nr_frags = shinfo->nr_frags;",
          "1023:  int i, err, start;",
          "1026:  err = gop->status;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1149:  struct pending_tx_info *tx_info;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1033:  for (i = start; i < nr_frags; i++) {",
          "1034:   int j, newerr;",
          "1036:   pending_idx = frag_get_pending_idx(&shinfo->frags[i]);",
          "1040:   if (likely(!newerr)) {",
          "1042:    if (unlikely(err))",
          "",
          "[Removed Lines]",
          "1039:   newerr = (++gop)->status;",
          "",
          "[Added Lines]",
          "1164:   pending_ring_idx_t head;",
          "1167:   tx_info = &netbk->pending_tx_info[pending_idx];",
          "1168:   head = tx_info->head;",
          "1171:   do {",
          "1172:    newerr = (++gop)->status;",
          "1173:    if (newerr)",
          "1174:     break;",
          "1175:    peek = netbk->pending_ring[pending_index(++head)];",
          "1176:   } while (!pending_tx_is_head(netbk, peek));",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1256:  struct sk_buff *skb;",
          "1257:  int ret;",
          "1260:   !list_empty(&netbk->net_schedule_list)) {",
          "1261:   struct xenvif *vif;",
          "1262:   struct xen_netif_tx_request txreq;",
          "1264:   struct page *page;",
          "1265:   struct xen_netif_extra_info extras[XEN_NETIF_EXTRA_TYPE_MAX-1];",
          "1266:   u16 pending_idx;",
          "",
          "[Removed Lines]",
          "1259:  while (((nr_pending_reqs(netbk) + MAX_SKB_FRAGS) < MAX_PENDING_REQS) &&",
          "1263:   struct xen_netif_tx_request txfrags[MAX_SKB_FRAGS];",
          "",
          "[Added Lines]",
          "1397:  while ((nr_pending_reqs(netbk) + XEN_NETIF_NR_SLOTS_MIN",
          "1398:   < MAX_PENDING_REQS) &&",
          "1402:   struct xen_netif_tx_request txfrags[max_skb_slots];",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1321:     continue;",
          "1322:   }",
          "1325:   if (unlikely(ret < 0))",
          "1326:    continue;",
          "",
          "[Removed Lines]",
          "1324:   ret = netbk_count_requests(vif, &txreq, txfrags, work_to_do);",
          "",
          "[Added Lines]",
          "1463:   ret = netbk_count_requests(vif, &txreq, idx,",
          "1464:         txfrags, work_to_do);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1348:   pending_idx = netbk->pending_ring[index];",
          "1350:   data_len = (txreq.size > PKT_PROT_LEN &&",
          "1352:    PKT_PROT_LEN : txreq.size;",
          "1354:   skb = alloc_skb(data_len + NET_SKB_PAD + NET_IP_ALIGN,",
          "",
          "[Removed Lines]",
          "1351:        ret < MAX_SKB_FRAGS) ?",
          "",
          "[Added Lines]",
          "1491:        ret < XEN_NETIF_NR_SLOTS_MIN) ?",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1398:   memcpy(&netbk->pending_tx_info[pending_idx].req,",
          "1399:          &txreq, sizeof(txreq));",
          "1400:   netbk->pending_tx_info[pending_idx].vif = vif;",
          "1403:   __skb_put(skb, data_len);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1541:   netbk->pending_tx_info[pending_idx].head = index;",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1528: {",
          "1529:  struct xenvif *vif;",
          "1530:  struct pending_tx_info *pending_tx_info;",
          "1534:  if (netbk->mmap_pages[pending_idx] == NULL)",
          "",
          "[Removed Lines]",
          "1531:  pending_ring_idx_t index;",
          "",
          "[Added Lines]",
          "1672:  pending_ring_idx_t head;",
          "1675:  BUG_ON(netbk->mmap_pages[pending_idx] == (void *)(~0UL));",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1537:  pending_tx_info = &netbk->pending_tx_info[pending_idx];",
          "1539:  vif = pending_tx_info->vif;",
          "1549:  put_page(netbk->mmap_pages[pending_idx]);",
          "1550:  netbk->mmap_pages[pending_idx] = NULL;",
          "1551: }",
          "1553: static void make_tx_response(struct xenvif *vif,",
          "1554:         struct xen_netif_tx_request *txp,",
          "1555:         s8       st)",
          "",
          "[Removed Lines]",
          "1541:  make_tx_response(vif, &pending_tx_info->req, status);",
          "1543:  index = pending_index(netbk->pending_prod++);",
          "1544:  netbk->pending_ring[index] = pending_idx;",
          "1546:  xenvif_put(vif);",
          "1548:  netbk->mmap_pages[pending_idx]->mapping = NULL;",
          "",
          "[Added Lines]",
          "1684:  head = pending_tx_info->head;",
          "1686:  BUG_ON(!pending_tx_is_head(netbk, head));",
          "1687:  BUG_ON(netbk->pending_ring[pending_index(head)] != pending_idx);",
          "1689:  do {",
          "1690:   pending_ring_idx_t index;",
          "1691:   pending_ring_idx_t idx = pending_index(head);",
          "1692:   u16 info_idx = netbk->pending_ring[idx];",
          "1694:   pending_tx_info = &netbk->pending_tx_info[info_idx];",
          "1695:   make_tx_response(vif, &pending_tx_info->req, status);",
          "1701:   pending_tx_info->head = 0;",
          "1703:   index = pending_index(netbk->pending_prod++);",
          "1704:   netbk->pending_ring[index] = netbk->pending_ring[info_idx];",
          "1706:   xenvif_put(vif);",
          "1708:   peek = netbk->pending_ring[pending_index(++head)];",
          "1710:  } while (!pending_tx_is_head(netbk, peek));",
          "1712:  netbk->mmap_pages[pending_idx]->mapping = 0;",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1602: static inline int tx_work_todo(struct xen_netbk *netbk)",
          "1603: {",
          "1607:   return 1;",
          "1609:  return 0;",
          "",
          "[Removed Lines]",
          "1605:  if (((nr_pending_reqs(netbk) + MAX_SKB_FRAGS) < MAX_PENDING_REQS) &&",
          "1606:    !list_empty(&netbk->net_schedule_list))",
          "",
          "[Added Lines]",
          "1770:  if ((nr_pending_reqs(netbk) + XEN_NETIF_NR_SLOTS_MIN",
          "1771:       < MAX_PENDING_REQS) &&",
          "1772:       !list_empty(&netbk->net_schedule_list))",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1686:  if (!xen_domain())",
          "1687:   return -ENODEV;",
          "1689:  xen_netbk_group_nr = num_online_cpus();",
          "1690:  xen_netbk = vzalloc(sizeof(struct xen_netbk) * xen_netbk_group_nr);",
          "1691:  if (!xen_netbk)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1855:  if (max_skb_slots < XEN_NETIF_NR_SLOTS_MIN) {",
          "1856:   printk(KERN_INFO",
          "1857:          \"xen-netback: max_skb_slots too small (%d), bump it to XEN_NETIF_NR_SLOTS_MIN (%d)\\n\",",
          "1858:          max_skb_slots, XEN_NETIF_NR_SLOTS_MIN);",
          "1859:   max_skb_slots = XEN_NETIF_NR_SLOTS_MIN;",
          "1860:  }",
          "",
          "---------------"
        ],
        "include/xen/interface/io/netif.h||include/xen/interface/io/netif.h": [
          "File: include/xen/interface/io/netif.h -> include/xen/interface/io/netif.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: #include <xen/interface/io/ring.h>",
          "13: #include <xen/interface/grant_table.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #define XEN_NETIF_NR_SLOTS_MIN 18",
          "",
          "---------------"
        ]
      }
    }
  ]
}