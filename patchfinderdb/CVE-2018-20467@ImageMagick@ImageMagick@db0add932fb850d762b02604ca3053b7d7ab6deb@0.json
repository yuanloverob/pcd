{
  "cve_id": "CVE-2018-20467",
  "cve_desc": "In coders/bmp.c in ImageMagick before 7.0.8-16, an input file can result in an infinite loop and hang, with high CPU and memory consumption. Remote attackers could leverage this vulnerability to cause a denial of service via a crafted file.",
  "repo": "ImageMagick/ImageMagick",
  "patch_hash": "db0add932fb850d762b02604ca3053b7d7ab6deb",
  "patch_info": {
    "commit_hash": "db0add932fb850d762b02604ca3053b7d7ab6deb",
    "repo": "ImageMagick/ImageMagick",
    "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/db0add932fb850d762b02604ca3053b7d7ab6deb",
    "files": [
      "coders/bmp.c"
    ],
    "message": "Prevent infinite loop",
    "before_after_code_files": [
      "coders/bmp.c||coders/bmp.c"
    ]
  },
  "patch_diff": {
    "coders/bmp.c||coders/bmp.c": [
      "File: coders/bmp.c -> coders/bmp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "660:         if (bmp_info.size < 40)",
      "661:           ThrowReaderException(CorruptImageError,\"NonOS2HeaderSizeError\");",
      "662:         bmp_info.width=(ssize_t) ReadBlobLSBSignedLong(image);",
      "664:         bmp_info.planes=ReadBlobLSBShort(image);",
      "665:         bmp_info.bits_per_pixel=ReadBlobLSBShort(image);",
      "666:         bmp_info.compression=ReadBlobLSBLong(image);",
      "",
      "[Removed Lines]",
      "663:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
      "",
      "[Added Lines]",
      "663:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1444:             DuplicateBlob(flipped_image,image);",
      "1445:             ReplaceImageInList(&image, flipped_image);",
      "1446:             image=flipped_image;",
      "1447:           }",
      "1454:         break;",
      "1456:     if (bmp_info.ba_offset != 0)",
      "",
      "[Removed Lines]",
      "1448:       }",
      "1450:       Proceed to next image.",
      "1452:     if (image_info->number_scenes != 0)",
      "1453:       if (image->scene >= (image_info->scene+image_info->number_scenes-1))",
      "",
      "[Added Lines]",
      "1447:           }",
      "1448:       }",
      "1450:       Proceed to next image.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5120e639728c4c7df87cfb5035adba21a8daa95e",
      "candidate_info": {
        "commit_hash": "5120e639728c4c7df87cfb5035adba21a8daa95e",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/5120e639728c4c7df87cfb5035adba21a8daa95e",
        "files": [
          "coders/bmp.c"
        ],
        "message": "https://imagemagick.org/discourse-server/viewtopic.php?f=3&t=37077",
        "before_after_code_files": [
          "coders/bmp.c||coders/bmp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/bmp.c||coders/bmp.c"
          ],
          "candidate": [
            "coders/bmp.c||coders/bmp.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/bmp.c||coders/bmp.c": [
          "File: coders/bmp.c -> coders/bmp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "657:               \"  Format: OS/2 Bitmap\");",
          "658:             (void) LogMagickEvent(CoderEvent,GetMagickModule(),",
          "659:               \"  Geometry: %.20gx%.20g\",(double) bmp_info.width,(double)",
          "662:       }",
          "663:     else",
          "664:       {",
          "666:           Microsoft Windows BMP image file.",
          "674:         bmp_info.compression=ReadBlobLSBLong(image);",
          "675:         bmp_info.image_size=ReadBlobLSBLong(image);",
          "676:         bmp_info.x_pixels=ReadBlobLSBLong(image);",
          "",
          "[Removed Lines]",
          "660:               bmp_info.height);",
          "661:           }",
          "668:         if (bmp_info.size < 40)",
          "669:           ThrowReaderException(CorruptImageError,\"NonOS2HeaderSizeError\");",
          "670:         bmp_info.width=(ssize_t) ReadBlobLSBSignedLong(image);",
          "671:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "672:         bmp_info.planes=ReadBlobLSBShort(image);",
          "673:         bmp_info.bits_per_pixel=ReadBlobLSBShort(image);",
          "",
          "[Added Lines]",
          "666:           Microsoft Windows BMP image file.",
          "668:         bmp_info.width=(ssize_t) ReadBlobLSBSignedLong(image);",
          "669:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "670:         bmp_info.planes=ReadBlobLSBShort(image);",
          "671:         bmp_info.bits_per_pixel=ReadBlobLSBShort(image);",
          "672:         bmp_info.compression=ReadBlobLSBLong(image);",
          "673:         if (bmp_info.size > 16)",
          "674:           {",
          "675:             bmp_info.image_size=ReadBlobLSBLong(image);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ecb31dbad39ccdc65868d5d2a37f0f0521250832",
      "candidate_info": {
        "commit_hash": "ecb31dbad39ccdc65868d5d2a37f0f0521250832",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/ecb31dbad39ccdc65868d5d2a37f0f0521250832",
        "files": [
          "coders/bmp.c"
        ],
        "message": "https://github.com/ImageMagick/ImageMagick/issues/1268",
        "before_after_code_files": [
          "coders/bmp.c||coders/bmp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/bmp.c||coders/bmp.c"
          ],
          "candidate": [
            "coders/bmp.c||coders/bmp.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/bmp.c||coders/bmp.c": [
          "File: coders/bmp.c -> coders/bmp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "661:         if (bmp_info.size < 40)",
          "662:           ThrowReaderException(CorruptImageError,\"NonOS2HeaderSizeError\");",
          "663:         bmp_info.width=(ssize_t) ReadBlobLSBSignedLong(image);",
          "664:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "665:         bmp_info.planes=ReadBlobLSBShort(image);",
          "666:         bmp_info.bits_per_pixel=ReadBlobLSBShort(image);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "664:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "665:         bmp_info.planes=ReadBlobLSBShort(image);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a7bd2810758a0bb6fa5cdebb38246a7fbdc996d5",
      "candidate_info": {
        "commit_hash": "a7bd2810758a0bb6fa5cdebb38246a7fbdc996d5",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/a7bd2810758a0bb6fa5cdebb38246a7fbdc996d5",
        "files": [
          "coders/bmp.c"
        ],
        "message": "Raise a warning instead of an error when the file_size includes an extra 4 bytes.",
        "before_after_code_files": [
          "coders/bmp.c||coders/bmp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/bmp.c||coders/bmp.c"
          ],
          "candidate": [
            "coders/bmp.c||coders/bmp.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/bmp.c||coders/bmp.c": [
          "File: coders/bmp.c -> coders/bmp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "526:   MagickBooleanType",
          "527:     status;",
          "529:   MagickOffsetType",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "527:     status;",
          "529:   MagickOffsetType",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "586:     }",
          "588:     Determine if this a BMP file.",
          "590:   (void) memset(&bmp_info,0,sizeof(bmp_info));",
          "591:   bmp_info.ba_offset=0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "664:         if (bmp_info.size < 40)",
          "665:           ThrowReaderException(CorruptImageError,\"NonOS2HeaderSizeError\");",
          "666:         bmp_info.width=(ssize_t) ReadBlobLSBSignedLong(image);",
          "668:         bmp_info.planes=ReadBlobLSBShort(image);",
          "669:         bmp_info.bits_per_pixel=ReadBlobLSBShort(image);",
          "670:         bmp_info.compression=ReadBlobLSBLong(image);",
          "",
          "[Removed Lines]",
          "667:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "",
          "[Added Lines]",
          "671:         bmp_info.height=(ssize_t) ReadBlobLSBSignedLong(image);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "829:               case LCS_GM_ABS_COLORIMETRIC:",
          "830:               {",
          "831:                 image->rendering_intent=AbsoluteIntent;",
          "840:     if ((MagickSizeType) bmp_info.file_size > GetBlobSize(image))",
          "841:       (void) ThrowMagickException(exception,GetMagickModule(),CorruptImageError,",
          "842:         \"LengthAndFilesizeDoNotMatch\",\"`%s'\",image->filename);",
          "",
          "[Removed Lines]",
          "832:                 break;",
          "833:               }",
          "834:             }",
          "835:             profile_data=(MagickOffsetType)ReadBlobLSBLong(image);",
          "836:             profile_size=(MagickOffsetType)ReadBlobLSBLong(image);",
          "838:           }",
          "839:       }",
          "",
          "[Added Lines]",
          "836:                 break;",
          "837:               }",
          "838:             }",
          "839:             profile_data=(MagickOffsetType)ReadBlobLSBLong(image);",
          "840:             profile_size=(MagickOffsetType)ReadBlobLSBLong(image);",
          "842:           }",
          "843:       }",
          "844:     if ((MagickSizeType) bmp_info.file_size != blob_size)",
          "845:       {",
          "846:         ExceptionType",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "962:     if (bmp_info.offset_bits == offset_bits)",
          "963:       ThrowReaderException(CorruptImageError,\"ImproperImageHeader\");",
          "965:     offset=SeekBlob(image,start_position+bmp_info.offset_bits,SEEK_SET);",
          "966:     if (offset < 0)",
          "967:       ThrowReaderException(CorruptImageError,\"ImproperImageHeader\");",
          "",
          "[Removed Lines]",
          "964:     offset_bits=bmp_info.offset_bits;",
          "",
          "[Added Lines]",
          "971:     offset_bits=bmp_info.offset_bits;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1460:         (profile_size > 0))",
          "1461:       {",
          "1462:         StringInfo",
          "1465:         unsigned char",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1512:       {",
          "1514:           Acquire next image structure.",
          "1517:         if (GetNextImageInList(image) == (Image *) NULL)",
          "1518:           {",
          "1519:             status=MagickFalse;",
          "",
          "[Removed Lines]",
          "1516:         AcquireNextImage(image_info,image,exception);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}