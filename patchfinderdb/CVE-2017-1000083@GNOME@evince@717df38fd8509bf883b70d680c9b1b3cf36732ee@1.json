{
  "cve_id": "CVE-2017-1000083",
  "cve_desc": "backend/comics/comics-document.c (aka the comic book backend) in GNOME Evince before 3.24.1 allows remote attackers to execute arbitrary commands via a .cbt file that is a TAR archive containing a filename beginning with a \"--\" command-line option substring, as demonstrated by a --checkpoint-action=exec=bash at the beginning of the filename.",
  "repo": "GNOME/evince",
  "patch_hash": "717df38fd8509bf883b70d680c9b1b3cf36732ee",
  "patch_info": {
    "commit_hash": "717df38fd8509bf883b70d680c9b1b3cf36732ee",
    "repo": "GNOME/evince",
    "commit_url": "https://github.com/GNOME/evince/commit/717df38fd8509bf883b70d680c9b1b3cf36732ee",
    "files": [
      "backend/comics/comics-document.c",
      "configure.ac"
    ],
    "message": "comics: Remove support for tar and tar-like commands\n\nWhen handling tar files, or using a command with tar-compatible syntax,\nto open comic-book archives, both the archive name (the name of the\ncomics file) and the filename (the name of a page within the archive)\nare quoted to not be interpreted by the shell.\n\nBut the filename is completely with the attacker's control and can start\nwith \"--\" which leads to tar interpreting it as a command line flag.\n\nThis can be exploited by creating a CBT file (a tar archive with the\n.cbt suffix) with an embedded file named something like this:\n\"--checkpoint-action=exec=bash -c 'touch ~/hacked;'.jpg\"\n\nCBT files are infinitely rare (CBZ is usually used for DRM-free\ncommercial releases, CBR for those from more dubious provenance), so\nremoving support is the easiest way to avoid the bug triggering. All\nthis code was rewritten in the development release for GNOME 3.26 to not\nshell out to any command, closing off this particular attack vector.\n\nThis also removes the ability to use libarchive's bsdtar-compatible\nbinary for CBZ (ZIP), CB7 (7zip), and CBR (RAR) formats. The first two\nare already supported by unzip and 7zip respectively. libarchive's RAR\nsupport is limited, so unrar is a requirement anyway.\n\nDiscovered by Felix Wilhelm from the Google Security Team.\n\nhttps://bugzilla.gnome.org/show_bug.cgi?id=784630",
    "before_after_code_files": [
      "backend/comics/comics-document.c||backend/comics/comics-document.c",
      "configure.ac||configure.ac"
    ]
  },
  "patch_diff": {
    "backend/comics/comics-document.c||backend/comics/comics-document.c": [
      "File: backend/comics/comics-document.c -> backend/comics/comics-document.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "56:  RARLABS,",
      "57:  GNAUNRAR,",
      "58:  UNZIP,",
      "61: } ComicBookDecompressType;",
      "63: typedef struct _ComicsDocumentClass ComicsDocumentClass;",
      "",
      "[Removed Lines]",
      "59:  P7ZIP,",
      "60:  TAR",
      "",
      "[Added Lines]",
      "59:  P7ZIP",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "119:  {NULL               , \"%s l -- %s\"     , \"%s x -y %s -o%s\", FALSE, OFFSET_7Z},",
      "123: };",
      "125: static GSList*    get_supported_image_extensions (void);",
      "",
      "[Removed Lines]",
      "122:  {\"%s -xOf\"          , \"%s -tf %s\"      , NULL             , FALSE, NO_OFFSET}",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "364:    comics_document->command_usage = GNAUNRAR;",
      "365:    return TRUE;",
      "366:   }",
      "374:  } else if (g_content_type_is_a (mime_type, \"application/x-cbz\") ||",
      "375:      g_content_type_is_a (mime_type, \"application/zip\")) {",
      "",
      "[Removed Lines]",
      "367:   comics_document->selected_command =",
      "368:     g_find_program_in_path (\"bsdtar\");",
      "369:   if (comics_document->selected_command) {",
      "370:    comics_document->command_usage = TAR;",
      "371:    return TRUE;",
      "372:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "396:    comics_document->command_usage = P7ZIP;",
      "397:    return TRUE;",
      "398:   }",
      "406:  } else if (g_content_type_is_a (mime_type, \"application/x-cb7\") ||",
      "407:      g_content_type_is_a (mime_type, \"application/x-7z-compressed\")) {",
      "",
      "[Removed Lines]",
      "399:   comics_document->selected_command =",
      "400:     g_find_program_in_path (\"bsdtar\");",
      "401:   if (comics_document->selected_command) {",
      "402:    comics_document->command_usage = TAR;",
      "403:    return TRUE;",
      "404:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "425:    comics_document->command_usage = P7ZIP;",
      "426:    return TRUE;",
      "427:   }",
      "449:  } else {",
      "450:   g_set_error (error,",
      "451:         EV_DOCUMENT_ERROR,",
      "",
      "[Removed Lines]",
      "428:   comics_document->selected_command =",
      "429:     g_find_program_in_path (\"bsdtar\");",
      "430:   if (comics_document->selected_command) {",
      "431:    comics_document->command_usage = TAR;",
      "432:    return TRUE;",
      "433:   }",
      "434:  } else if (g_content_type_is_a (mime_type, \"application/x-cbt\") ||",
      "435:      g_content_type_is_a (mime_type, \"application/x-tar\")) {",
      "437:   comics_document->selected_command =",
      "438:     g_find_program_in_path (\"tar\");",
      "439:   if (comics_document->selected_command) {",
      "440:    comics_document->command_usage = TAR;",
      "441:    return TRUE;",
      "442:   }",
      "443:   comics_document->selected_command =",
      "444:     g_find_program_in_path (\"bsdtar\");",
      "445:   if (comics_document->selected_command) {",
      "446:    comics_document->command_usage = TAR;",
      "447:    return TRUE;",
      "448:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "configure.ac||configure.ac": [
      "File: configure.ac -> configure.ac",
      "--- Hunk 1 ---",
      "[Context before]",
      "795: AC_SUBST(APPDATA_TIFF_MIME_TYPES)",
      "796: AM_SUBST_NOTMAKE(APPDATA_TIFF_MIME_TYPES)",
      "797: if test \"x$enable_comics\" = \"xyes\"; then",
      "799:         APPDATA_COMICS_MIME_TYPES=$(echo \"<mimetype>$COMICS_MIME_TYPES</mimetype>\" | sed -e 's/;/<\\/mimetype>\\n    <mimetype>/g')",
      "800:         if test -z \"$EVINCE_MIME_TYPES\"; then",
      "801:            EVINCE_MIME_TYPES=\"${COMICS_MIME_TYPES}\"",
      "",
      "[Removed Lines]",
      "798:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-cbt;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;application/x-ext-cbt\"",
      "",
      "[Added Lines]",
      "798:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8bbcdee7aacd2a1c0e5015108978321a31c9ef66",
      "candidate_info": {
        "commit_hash": "8bbcdee7aacd2a1c0e5015108978321a31c9ef66",
        "repo": "GNOME/evince",
        "commit_url": "https://github.com/GNOME/evince/commit/8bbcdee7aacd2a1c0e5015108978321a31c9ef66",
        "files": [
          "backend/comics/comics-document.c",
          "configure.ac"
        ],
        "message": "comics: Remove support for tar and tar-like commands\n\nWhen handling tar files, or using a command with tar-compatible syntax,\nto open comic-book archives, both the archive name (the name of the\ncomics file) and the filename (the name of a page within the archive)\nare quoted to not be interpreted by the shell.\n\nBut the filename is completely with the attacker's control and can start\nwith \"--\" which leads to tar interpreting it as a command line flag.\n\nThis can be exploited by creating a CBT file (a tar archive with the\n.cbt suffix) with an embedded file named something like this:\n\"--checkpoint-action=exec=bash -c 'touch ~/hacked;'.jpg\"\n\nCBT files are infinitely rare (CBZ is usually used for DRM-free\ncommercial releases, CBR for those from more dubious provenance), so\nremoving support is the easiest way to avoid the bug triggering. All\nthis code was rewritten in the development release for GNOME 3.26 to not\nshell out to any command, closing off this particular attack vector.\n\nThis also removes the ability to use libarchive's bsdtar-compatible\nbinary for CBZ (ZIP), CB7 (7zip), and CBR (RAR) formats. The first two\nare already supported by unzip and 7zip respectively. libarchive's RAR\nsupport is limited, so unrar is a requirement anyway.\n\nDiscovered by Felix Wilhelm from the Google Security Team.\n\nhttps://bugzilla.gnome.org/show_bug.cgi?id=784630",
        "before_after_code_files": [
          "backend/comics/comics-document.c||backend/comics/comics-document.c",
          "configure.ac||configure.ac"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "backend/comics/comics-document.c||backend/comics/comics-document.c",
            "configure.ac||configure.ac"
          ],
          "candidate": [
            "backend/comics/comics-document.c||backend/comics/comics-document.c",
            "configure.ac||configure.ac"
          ]
        }
      },
      "candidate_diff": {
        "backend/comics/comics-document.c||backend/comics/comics-document.c": [
          "File: backend/comics/comics-document.c -> backend/comics/comics-document.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:  RARLABS,",
          "57:  GNAUNRAR,",
          "58:  UNZIP,",
          "61: } ComicBookDecompressType;",
          "63: typedef struct _ComicsDocumentClass ComicsDocumentClass;",
          "",
          "[Removed Lines]",
          "59:  P7ZIP,",
          "60:  TAR",
          "",
          "[Added Lines]",
          "59:  P7ZIP",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "119:  {NULL               , \"%s l -- %s\"     , \"%s x -y %s -o%s\", FALSE, OFFSET_7Z},",
          "123: };",
          "125: static GSList*    get_supported_image_extensions (void);",
          "",
          "[Removed Lines]",
          "122:  {\"%s -xOf\"          , \"%s -tf %s\"      , NULL             , FALSE, NO_OFFSET}",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "364:    comics_document->command_usage = GNAUNRAR;",
          "365:    return TRUE;",
          "366:   }",
          "374:  } else if (g_content_type_is_a (mime_type, \"application/x-cbz\") ||",
          "375:      g_content_type_is_a (mime_type, \"application/zip\")) {",
          "",
          "[Removed Lines]",
          "367:   comics_document->selected_command =",
          "368:     g_find_program_in_path (\"bsdtar\");",
          "369:   if (comics_document->selected_command) {",
          "370:    comics_document->command_usage = TAR;",
          "371:    return TRUE;",
          "372:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "396:    comics_document->command_usage = P7ZIP;",
          "397:    return TRUE;",
          "398:   }",
          "406:  } else if (g_content_type_is_a (mime_type, \"application/x-cb7\") ||",
          "407:      g_content_type_is_a (mime_type, \"application/x-7z-compressed\")) {",
          "",
          "[Removed Lines]",
          "399:   comics_document->selected_command =",
          "400:     g_find_program_in_path (\"bsdtar\");",
          "401:   if (comics_document->selected_command) {",
          "402:    comics_document->command_usage = TAR;",
          "403:    return TRUE;",
          "404:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "425:    comics_document->command_usage = P7ZIP;",
          "426:    return TRUE;",
          "427:   }",
          "449:  } else {",
          "450:   g_set_error (error,",
          "451:         EV_DOCUMENT_ERROR,",
          "",
          "[Removed Lines]",
          "428:   comics_document->selected_command =",
          "429:     g_find_program_in_path (\"bsdtar\");",
          "430:   if (comics_document->selected_command) {",
          "431:    comics_document->command_usage = TAR;",
          "432:    return TRUE;",
          "433:   }",
          "434:  } else if (g_content_type_is_a (mime_type, \"application/x-cbt\") ||",
          "435:      g_content_type_is_a (mime_type, \"application/x-tar\")) {",
          "437:   comics_document->selected_command =",
          "438:     g_find_program_in_path (\"tar\");",
          "439:   if (comics_document->selected_command) {",
          "440:    comics_document->command_usage = TAR;",
          "441:    return TRUE;",
          "442:   }",
          "443:   comics_document->selected_command =",
          "444:     g_find_program_in_path (\"bsdtar\");",
          "445:   if (comics_document->selected_command) {",
          "446:    comics_document->command_usage = TAR;",
          "447:    return TRUE;",
          "448:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "configure.ac||configure.ac": [
          "File: configure.ac -> configure.ac",
          "--- Hunk 1 ---",
          "[Context before]",
          "784: AC_SUBST(APPDATA_TIFF_MIME_TYPES)",
          "785: AM_SUBST_NOTMAKE(APPDATA_TIFF_MIME_TYPES)",
          "786: if test \"x$enable_comics\" = \"xyes\"; then",
          "788:         APPDATA_COMICS_MIME_TYPES=$(echo \"<mimetype>$COMICS_MIME_TYPES</mimetype>\" | sed -e 's/;/<\\/mimetype>\\n    <mimetype>/g')",
          "789:         if test -z \"$EVINCE_MIME_TYPES\"; then",
          "790:            EVINCE_MIME_TYPES=\"${COMICS_MIME_TYPES}\"",
          "",
          "[Removed Lines]",
          "787:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-cbt;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;application/x-ext-cbt\"",
          "",
          "[Added Lines]",
          "787:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fa072dbbfd964e85b4a54f8e34751cf62c77d0ea",
      "candidate_info": {
        "commit_hash": "fa072dbbfd964e85b4a54f8e34751cf62c77d0ea",
        "repo": "GNOME/evince",
        "commit_url": "https://github.com/GNOME/evince/commit/fa072dbbfd964e85b4a54f8e34751cf62c77d0ea",
        "files": [
          "backend/comics/comics-document.c",
          "configure.ac"
        ],
        "message": "comics: Remove support for tar and tar-like commands\n\nWhen handling tar files, or using a command with tar-compatible syntax,\nto open comic-book archives, both the archive name (the name of the\ncomics file) and the filename (the name of a page within the archive)\nare quoted to not be interpreted by the shell.\n\nBut the filename is completely with the attacker's control and can start\nwith \"--\" which leads to tar interpreting it as a command line flag.\n\nThis can be exploited by creating a CBT file (a tar archive with the\n.cbt suffix) with an embedded file named something like this:\n\"--checkpoint-action=exec=bash -c 'touch ~/hacked;'.jpg\"\n\nCBT files are infinitely rare (CBZ is usually used for DRM-free\ncommercial releases, CBR for those from more dubious provenance), so\nremoving support is the easiest way to avoid the bug triggering. All\nthis code was rewritten in the development release for GNOME 3.26 to not\nshell out to any command, closing off this particular attack vector.\n\nThis also removes the ability to use libarchive's bsdtar-compatible\nbinary for CBZ (ZIP), CB7 (7zip), and CBR (RAR) formats. The first two\nare already supported by unzip and 7zip respectively. libarchive's RAR\nsupport is limited, so unrar is a requirement anyway.\n\nDiscovered by Felix Wilhelm from the Google Security Team.\n\nhttps://bugzilla.gnome.org/show_bug.cgi?id=784630",
        "before_after_code_files": [
          "backend/comics/comics-document.c||backend/comics/comics-document.c",
          "configure.ac||configure.ac"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "backend/comics/comics-document.c||backend/comics/comics-document.c",
            "configure.ac||configure.ac"
          ],
          "candidate": [
            "backend/comics/comics-document.c||backend/comics/comics-document.c",
            "configure.ac||configure.ac"
          ]
        }
      },
      "candidate_diff": {
        "backend/comics/comics-document.c||backend/comics/comics-document.c": [
          "File: backend/comics/comics-document.c -> backend/comics/comics-document.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:  RARLABS,",
          "57:  GNAUNRAR,",
          "58:  UNZIP,",
          "61: } ComicBookDecompressType;",
          "63: typedef struct _ComicsDocumentClass ComicsDocumentClass;",
          "",
          "[Removed Lines]",
          "59:  P7ZIP,",
          "60:  TAR",
          "",
          "[Added Lines]",
          "59:  P7ZIP",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "119:  {NULL               , \"%s l -- %s\"     , \"%s x -y %s -o%s\", FALSE, OFFSET_7Z},",
          "123: };",
          "125: static GSList*    get_supported_image_extensions (void);",
          "",
          "[Removed Lines]",
          "122:  {\"%s -xOf\"          , \"%s -tf %s\"      , NULL             , FALSE, NO_OFFSET}",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "364:    comics_document->command_usage = GNAUNRAR;",
          "365:    return TRUE;",
          "366:   }",
          "374:  } else if (g_content_type_is_a (mime_type, \"application/x-cbz\") ||",
          "375:      g_content_type_is_a (mime_type, \"application/zip\")) {",
          "",
          "[Removed Lines]",
          "367:   comics_document->selected_command =",
          "368:     g_find_program_in_path (\"bsdtar\");",
          "369:   if (comics_document->selected_command) {",
          "370:    comics_document->command_usage = TAR;",
          "371:    return TRUE;",
          "372:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "396:    comics_document->command_usage = P7ZIP;",
          "397:    return TRUE;",
          "398:   }",
          "406:  } else if (g_content_type_is_a (mime_type, \"application/x-cb7\") ||",
          "407:      g_content_type_is_a (mime_type, \"application/x-7z-compressed\")) {",
          "",
          "[Removed Lines]",
          "399:   comics_document->selected_command =",
          "400:     g_find_program_in_path (\"bsdtar\");",
          "401:   if (comics_document->selected_command) {",
          "402:    comics_document->command_usage = TAR;",
          "403:    return TRUE;",
          "404:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "425:    comics_document->command_usage = P7ZIP;",
          "426:    return TRUE;",
          "427:   }",
          "449:  } else {",
          "450:   g_set_error (error,",
          "451:         EV_DOCUMENT_ERROR,",
          "",
          "[Removed Lines]",
          "428:   comics_document->selected_command =",
          "429:     g_find_program_in_path (\"bsdtar\");",
          "430:   if (comics_document->selected_command) {",
          "431:    comics_document->command_usage = TAR;",
          "432:    return TRUE;",
          "433:   }",
          "434:  } else if (g_content_type_is_a (mime_type, \"application/x-cbt\") ||",
          "435:      g_content_type_is_a (mime_type, \"application/x-tar\")) {",
          "437:   comics_document->selected_command =",
          "438:     g_find_program_in_path (\"tar\");",
          "439:   if (comics_document->selected_command) {",
          "440:    comics_document->command_usage = TAR;",
          "441:    return TRUE;",
          "442:   }",
          "443:   comics_document->selected_command =",
          "444:     g_find_program_in_path (\"bsdtar\");",
          "445:   if (comics_document->selected_command) {",
          "446:    comics_document->command_usage = TAR;",
          "447:    return TRUE;",
          "448:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "configure.ac||configure.ac": [
          "File: configure.ac -> configure.ac",
          "--- Hunk 1 ---",
          "[Context before]",
          "795: AC_SUBST(APPDATA_TIFF_MIME_TYPES)",
          "796: AM_SUBST_NOTMAKE(APPDATA_TIFF_MIME_TYPES)",
          "797: if test \"x$enable_comics\" = \"xyes\"; then",
          "799:         APPDATA_COMICS_MIME_TYPES=$(echo \"<mimetype>$COMICS_MIME_TYPES</mimetype>\" | sed -e 's/;/<\\/mimetype>\\n    <mimetype>/g')",
          "800:         if test -z \"$EVINCE_MIME_TYPES\"; then",
          "801:            EVINCE_MIME_TYPES=\"${COMICS_MIME_TYPES}\"",
          "",
          "[Removed Lines]",
          "798:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-cbt;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;application/x-ext-cbt\"",
          "",
          "[Added Lines]",
          "798:         COMICS_MIME_TYPES=\"application/x-cbr;application/x-cbz;application/x-cb7;application/x-ext-cbr;application/x-ext-cbz;application/vnd.comicbook+zip;application/x-ext-cb7;\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}