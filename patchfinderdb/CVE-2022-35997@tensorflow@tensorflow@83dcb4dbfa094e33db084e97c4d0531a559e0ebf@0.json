{
  "cve_id": "CVE-2022-35997",
  "cve_desc": "TensorFlow is an open source platform for machine learning. If `tf.sparse.cross` receives an input `separator` that is not a scalar, it gives a `CHECK` fail that can be used to trigger a denial of service attack. We have patched the issue in GitHub commit 83dcb4dbfa094e33db084e97c4d0531a559e0ebf. The fix will be included in TensorFlow 2.10.0. We will also cherrypick this commit on TensorFlow 2.9.1, TensorFlow 2.8.1, and TensorFlow 2.7.2, as these are also affected and still in supported range. There are no known workarounds for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "83dcb4dbfa094e33db084e97c4d0531a559e0ebf",
  "patch_info": {
    "commit_hash": "83dcb4dbfa094e33db084e97c4d0531a559e0ebf",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/83dcb4dbfa094e33db084e97c4d0531a559e0ebf",
    "files": [
      "tensorflow/core/kernels/sparse_cross_op.cc",
      "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
    ],
    "message": "Fix check failure in SparseCrossV2Op by adding check for scalar value for separator.\n\nPiperOrigin-RevId: 461001180",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
      "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc": [
      "File: tensorflow/core/kernels/sparse_cross_op.cc -> tensorflow/core/kernels/sparse_cross_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: #include \"tensorflow/core/framework/kernel_def_builder.h\"",
      "25: #include \"tensorflow/core/framework/op_def_builder.h\"",
      "26: #include \"tensorflow/core/framework/op_kernel.h\"",
      "27: #include \"tensorflow/core/framework/tensor.h\"",
      "28: #include \"tensorflow/core/framework/tensor_shape.h\"",
      "29: #include \"tensorflow/core/framework/types.h\"",
      "30: #include \"tensorflow/core/framework/types.pb.h\"",
      "31: #include \"tensorflow/core/lib/core/stringpiece.h\"",
      "32: #include \"tensorflow/core/lib/strings/str_util.h\"",
      "33: #include \"tensorflow/core/platform/fingerprint.h\"",
      "34: #include \"tensorflow/core/platform/strong_hash.h\"",
      "35: #include \"tensorflow/core/util/work_sharder.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27: #include \"tensorflow/core/framework/op_requires.h\"",
      "34: #include \"tensorflow/core/platform/errors.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "833:     const Tensor* sep_t;",
      "834:     OP_REQUIRES_OK(context, context->input(\"sep\", &sep_t));",
      "835:     const tstring separator = sep_t->scalar<tstring>()();",
      "837:     std::vector<std::unique_ptr<ColumnInterface<tstring>>> columns =",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "837:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(sep_t->shape()),",
      "838:                 errors::InvalidArgument(\"Input separator should be a scalar. \"",
      "839:                                         \"Received: \",",
      "840:                                         sep_t->DebugString()));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py": [
      "File: tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py -> tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "873:     with self.cached_session():",
      "874:       self._assert_sparse_tensor_empty(self.evaluate(out))",
      "877: class SparseCrossHashedOpTest(BaseSparseCrossOpTest):",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "876:   def testNonScalarInput(self):",
      "877:     with self.assertRaisesRegex(errors.InvalidArgumentError,",
      "878:                                 'Input separator should be a scalar.'):",
      "879:       self.evaluate(sparse_ops.sparse_cross(",
      "880:           inputs=[],",
      "881:           name='a',",
      "882:           separator=constant_op.constant(['a', 'b'], dtype=dtypes.string)))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e759b3d06da957e112aacc449219789ad8f46cd6",
      "candidate_info": {
        "commit_hash": "e759b3d06da957e112aacc449219789ad8f46cd6",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e759b3d06da957e112aacc449219789ad8f46cd6",
        "files": [
          "tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
        ],
        "message": "Fix check failure in SparseCrossV2Op by adding check for scalar value for separator.\n\nPiperOrigin-RevId: 461001180",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
            "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
            "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc": [
          "File: tensorflow/core/kernels/sparse_cross_op.cc -> tensorflow/core/kernels/sparse_cross_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"tensorflow/core/framework/kernel_def_builder.h\"",
          "25: #include \"tensorflow/core/framework/op_def_builder.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/tensor.h\"",
          "28: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "29: #include \"tensorflow/core/framework/types.h\"",
          "30: #include \"tensorflow/core/framework/types.pb.h\"",
          "31: #include \"tensorflow/core/lib/core/stringpiece.h\"",
          "32: #include \"tensorflow/core/lib/strings/str_util.h\"",
          "33: #include \"tensorflow/core/platform/fingerprint.h\"",
          "34: #include \"tensorflow/core/platform/strong_hash.h\"",
          "35: #include \"tensorflow/core/util/work_sharder.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "34: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "833:     const Tensor* sep_t;",
          "834:     OP_REQUIRES_OK(context, context->input(\"sep\", &sep_t));",
          "835:     const tstring separator = sep_t->scalar<tstring>()();",
          "837:     std::vector<std::unique_ptr<ColumnInterface<tstring>>> columns =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "837:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(sep_t->shape()),",
          "838:                 errors::InvalidArgument(\"Input separator should be a scalar. \"",
          "839:                                         \"Received: \",",
          "840:                                         sep_t->DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py": [
          "File: tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py -> tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "873:     with self.cached_session():",
          "874:       self._assert_sparse_tensor_empty(self.evaluate(out))",
          "877: class SparseCrossHashedOpTest(BaseSparseCrossOpTest):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "876:   def testNonScalarInput(self):",
          "877:     with self.assertRaisesRegex(errors.InvalidArgumentError,",
          "878:                                 'Input separator should be a scalar.'):",
          "879:       self.evaluate(sparse_ops.sparse_cross(",
          "880:           inputs=[],",
          "881:           name='a',",
          "882:           separator=constant_op.constant(['a', 'b'], dtype=dtypes.string)))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "744f2bc35ae3f62cf53b866f0a279435b074afed",
      "candidate_info": {
        "commit_hash": "744f2bc35ae3f62cf53b866f0a279435b074afed",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/744f2bc35ae3f62cf53b866f0a279435b074afed",
        "files": [
          "tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_cross_op_test.py"
        ],
        "message": "Fix check failure in SparseCrossV2Op by adding check for scalar value for separator.\n\nPiperOrigin-RevId: 461001180",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_cross_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc": [
          "File: tensorflow/core/kernels/sparse_cross_op.cc -> tensorflow/core/kernels/sparse_cross_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"tensorflow/core/framework/kernel_def_builder.h\"",
          "25: #include \"tensorflow/core/framework/op_def_builder.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/tensor.h\"",
          "28: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "29: #include \"tensorflow/core/framework/types.h\"",
          "30: #include \"tensorflow/core/framework/types.pb.h\"",
          "31: #include \"tensorflow/core/lib/core/stringpiece.h\"",
          "32: #include \"tensorflow/core/lib/strings/str_util.h\"",
          "33: #include \"tensorflow/core/platform/fingerprint.h\"",
          "34: #include \"tensorflow/core/platform/strong_hash.h\"",
          "35: #include \"tensorflow/core/util/work_sharder.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "34: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "833:     const Tensor* sep_t;",
          "834:     OP_REQUIRES_OK(context, context->input(\"sep\", &sep_t));",
          "835:     const tstring separator = sep_t->scalar<tstring>()();",
          "837:     std::vector<std::unique_ptr<ColumnInterface<tstring>>> columns =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "837:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(sep_t->shape()),",
          "838:                 errors::InvalidArgument(\"Input separator should be a scalar. \"",
          "839:                                         \"Received: \",",
          "840:                                         sep_t->DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_cross_op_test.py": [
          "File: tensorflow/python/kernel_tests/sparse_cross_op_test.py -> tensorflow/python/kernel_tests/sparse_cross_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "877:     with self.cached_session():",
          "878:       self._assert_sparse_tensor_empty(self.evaluate(out))",
          "881: class SparseCrossHashedOpTest(BaseSparseCrossOpTest):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "880:   def testNonScalarInput(self):",
          "881:     with self.assertRaisesRegex(errors.InvalidArgumentError,",
          "882:                                 'Input separator should be a scalar.'):",
          "883:       self.evaluate(sparse_ops.sparse_cross(",
          "884:           inputs=[],",
          "885:           name='a',",
          "886:           separator=constant_op.constant(['a', 'b'], dtype=dtypes.string)))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e9adae82a5b73f9d5ef3a9bc0a68b2b1e918be52",
      "candidate_info": {
        "commit_hash": "e9adae82a5b73f9d5ef3a9bc0a68b2b1e918be52",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e9adae82a5b73f9d5ef3a9bc0a68b2b1e918be52",
        "files": [
          "tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
        ],
        "message": "Fix check failure in SparseCrossV2Op by adding check for scalar value for separator.\n\nPiperOrigin-RevId: 461001180",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
          "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
            "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc",
            "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_cross_op.cc||tensorflow/core/kernels/sparse_cross_op.cc": [
          "File: tensorflow/core/kernels/sparse_cross_op.cc -> tensorflow/core/kernels/sparse_cross_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"tensorflow/core/framework/kernel_def_builder.h\"",
          "25: #include \"tensorflow/core/framework/op_def_builder.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/tensor.h\"",
          "28: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "29: #include \"tensorflow/core/framework/types.h\"",
          "30: #include \"tensorflow/core/framework/types.pb.h\"",
          "31: #include \"tensorflow/core/lib/core/stringpiece.h\"",
          "32: #include \"tensorflow/core/lib/strings/str_util.h\"",
          "33: #include \"tensorflow/core/platform/fingerprint.h\"",
          "34: #include \"tensorflow/core/platform/strong_hash.h\"",
          "35: #include \"tensorflow/core/util/work_sharder.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "34: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "833:     const Tensor* sep_t;",
          "834:     OP_REQUIRES_OK(context, context->input(\"sep\", &sep_t));",
          "835:     const tstring separator = sep_t->scalar<tstring>()();",
          "837:     std::vector<std::unique_ptr<ColumnInterface<tstring>>> columns =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "837:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(sep_t->shape()),",
          "838:                 errors::InvalidArgument(\"Input separator should be a scalar. \"",
          "839:                                         \"Received: \",",
          "840:                                         sep_t->DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py||tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py": [
          "File: tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py -> tensorflow/python/kernel_tests/sparse_ops/sparse_cross_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "873:     with self.cached_session():",
          "874:       self._assert_sparse_tensor_empty(self.evaluate(out))",
          "877: class SparseCrossHashedOpTest(BaseSparseCrossOpTest):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "876:   def testNonScalarInput(self):",
          "877:     with self.assertRaisesRegex(errors.InvalidArgumentError,",
          "878:                                 'Input separator should be a scalar.'):",
          "879:       self.evaluate(sparse_ops.sparse_cross(",
          "880:           inputs=[],",
          "881:           name='a',",
          "882:           separator=constant_op.constant(['a', 'b'], dtype=dtypes.string)))",
          "",
          "---------------"
        ]
      }
    }
  ]
}