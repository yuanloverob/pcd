{
  "cve_id": "CVE-2014-1874",
  "cve_desc": "The security_context_to_sid_core function in security/selinux/ss/services.c in the Linux kernel before 3.13.4 allows local users to cause a denial of service (system crash) by leveraging the CAP_MAC_ADMIN capability to set a zero-length security context.",
  "repo": "torvalds/linux",
  "patch_hash": "2172fa709ab32ca60e86179dc67d0857be8e2c98",
  "patch_info": {
    "commit_hash": "2172fa709ab32ca60e86179dc67d0857be8e2c98",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/2172fa709ab32ca60e86179dc67d0857be8e2c98",
    "files": [
      "security/selinux/ss/services.c"
    ],
    "message": "SELinux:  Fix kernel BUG on empty security contexts.\n\nSetting an empty security context (length=0) on a file will\nlead to incorrectly dereferencing the type and other fields\nof the security context structure, yielding a kernel BUG.\nAs a zero-length security context is never valid, just reject\nall such security contexts whether coming from userspace\nvia setxattr or coming from the filesystem upon a getxattr\nrequest by SELinux.\n\nSetting a security context value (empty or otherwise) unknown to\nSELinux in the first place is only possible for a root process\n(CAP_MAC_ADMIN), and, if running SELinux in enforcing mode, only\nif the corresponding SELinux mac_admin permission is also granted\nto the domain by policy.  In Fedora policies, this is only allowed for\nspecific domains such as livecd for setting down security contexts\nthat are not defined in the build host policy.\n\nReproducer:\nsu\nsetenforce 0\ntouch foo\nsetfattr -n security.selinux foo\n\nCaveat:\nRelabeling or removing foo after doing the above may not be possible\nwithout booting with SELinux disabled.  Any subsequent access to foo\nafter doing the above will also trigger the BUG.\n\nBUG output from Matthew Thode:\n[  473.893141] ------------[ cut here ]------------\n[  473.962110] kernel BUG at security/selinux/ss/services.c:654!\n[  473.995314] invalid opcode: 0000 [#6] SMP\n[  474.027196] Modules linked in:\n[  474.058118] CPU: 0 PID: 8138 Comm: ls Tainted: G      D   I\n3.13.0-grsec #1\n[  474.116637] Hardware name: Supermicro X8ST3/X8ST3, BIOS 2.0\n07/29/10\n[  474.149768] task: ffff8805f50cd010 ti: ffff8805f50cd488 task.ti:\nffff8805f50cd488\n[  474.183707] RIP: 0010:[<ffffffff814681c7>]  [<ffffffff814681c7>]\ncontext_struct_compute_av+0xce/0x308\n[  474.219954] RSP: 0018:ffff8805c0ac3c38  EFLAGS: 00010246\n[  474.252253] RAX: 0000000000000000 RBX: ffff8805c0ac3d94 RCX:\n0000000000000100\n[  474.287018] RDX: ffff8805e8aac000 RSI: 00000000ffffffff RDI:\nffff8805e8aaa000\n[  474.321199] RBP: ffff8805c0ac3cb8 R08: 0000000000000010 R09:\n0000000000000006\n[  474.357446] R10: 0000000000000000 R11: ffff8805c567a000 R12:\n0000000000000006\n[  474.419191] R13: ffff8805c2b74e88 R14: 00000000000001da R15:\n0000000000000000\n[  474.453816] FS:  00007f2e75220800(0000) GS:ffff88061fc00000(0000)\nknlGS:0000000000000000\n[  474.489254] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n[  474.522215] CR2: 00007f2e74716090 CR3: 00000005c085e000 CR4:\n00000000000207f0\n[  474.556058] Stack:\n[  474.584325]  ffff8805c0ac3c98 ffffffff811b549b ffff8805c0ac3c98\nffff8805f1190a40\n[  474.618913]  ffff8805a6202f08 ffff8805c2b74e88 00068800d0464990\nffff8805e8aac860\n[  474.653955]  ffff8805c0ac3cb8 000700068113833a ffff880606c75060\nffff8805c0ac3d94\n[  474.690461] Call Trace:\n[  474.723779]  [<ffffffff811b549b>] ? lookup_fast+0x1cd/0x22a\n[  474.778049]  [<ffffffff81468824>] security_compute_av+0xf4/0x20b\n[  474.811398]  [<ffffffff8196f419>] avc_compute_av+0x2a/0x179\n[  474.843813]  [<ffffffff8145727b>] avc_has_perm+0x45/0xf4\n[  474.875694]  [<ffffffff81457d0e>] inode_has_perm+0x2a/0x31\n[  474.907370]  [<ffffffff81457e76>] selinux_inode_getattr+0x3c/0x3e\n[  474.938726]  [<ffffffff81455cf6>] security_inode_getattr+0x1b/0x22\n[  474.970036]  [<ffffffff811b057d>] vfs_getattr+0x19/0x2d\n[  475.000618]  [<ffffffff811b05e5>] vfs_fstatat+0x54/0x91\n[  475.030402]  [<ffffffff811b063b>] vfs_lstat+0x19/0x1b\n[  475.061097]  [<ffffffff811b077e>] SyS_newlstat+0x15/0x30\n[  475.094595]  [<ffffffff8113c5c1>] ? __audit_syscall_entry+0xa1/0xc3\n[  475.148405]  [<ffffffff8197791e>] system_call_fastpath+0x16/0x1b\n[  475.179201] Code: 00 48 85 c0 48 89 45 b8 75 02 0f 0b 48 8b 45 a0 48\n8b 3d 45 d0 b6 00 8b 40 08 89 c6 ff ce e8 d1 b0 06 00 48 85 c0 49 89 c7\n75 02 <0f> 0b 48 8b 45 b8 4c 8b 28 eb 1e 49 8d 7d 08 be 80 01 00 00 e8\n[  475.255884] RIP  [<ffffffff814681c7>]\ncontext_struct_compute_av+0xce/0x308\n[  475.296120]  RSP <ffff8805c0ac3c38>\n[  475.328734] ---[ end trace f076482e9d754adc ]---\n\nReported-by:  Matthew Thode <mthode@mthode.org>\nSigned-off-by: Stephen Smalley <sds@tycho.nsa.gov>\nCc: stable@vger.kernel.org\nSigned-off-by: Paul Moore <pmoore@redhat.com>",
    "before_after_code_files": [
      "security/selinux/ss/services.c||security/selinux/ss/services.c"
    ]
  },
  "patch_diff": {
    "security/selinux/ss/services.c||security/selinux/ss/services.c": [
      "File: security/selinux/ss/services.c -> security/selinux/ss/services.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1232:  struct context context;",
      "1233:  int rc = 0;",
      "1235:  if (!ss_initialized) {",
      "1236:   int i;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1236:  if (!scontext_len)",
      "1237:   return -EINVAL;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "79040cad3f8235937e229f1b9401ba36dd5ad69b",
      "candidate_info": {
        "commit_hash": "79040cad3f8235937e229f1b9401ba36dd5ad69b",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/79040cad3f8235937e229f1b9401ba36dd5ad69b",
        "files": [
          "drivers/edac/edac_mc_sysfs.c"
        ],
        "message": "drivers/edac/edac_mc_sysfs.c: poll timeout cannot be zero\n\nIf you do\n\n  echo 0 > /sys/module/edac_core/parameters/edac_mc_poll_msec\n\nthe following stack trace is output because the edac module is not\ndesigned to poll with a timeout of zero.\n\n  WARNING: CPU: 12 PID: 0 at lib/list_debug.c:33 __list_add+0xac/0xc0()\n  list_add corruption. prev->next should be next (ffff8808291dd1b8), but was           (null). (prev=ffff8808286fe3f8).\n  Modules linked in: sg nfsv3 rpcsec_gss_krb5 nfsv4 dns_resolver nfs fscache cfg80211 rfkill x86_pkg_temp_thermal coretemp kvm_intel kvm ixgbe e1000e crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd iTCO_wdt ptp sb_edac iTCO_vendor_support pps_core mdio ipmi_devintf edac_core ioatdma microcode shpchp lpc_ich pcspkr i2c_i801 dca mfd_core ipmi_si wmi ipmi_msghandler nfsd auth_rpcgss nfs_acl lockd sunrpc xfs libcrc32c sd_mod sr_mod cdrom crc_t10dif crct10dif_common mgag200 syscopyarea sysfillrect sysimgblt isci i2c_algo_bit drm_kms_helper ttm drm libsas ahci libahci scsi_transport_sas libata i2c_core dm_mirror dm_region_hash dm_log dm_mod\n  CPU: 12 PID: 0 Comm: swapper/12 Not tainted 3.13.0+ #1\n  Hardware name: Intel Corporation LH Pass ........../SVRBD-ROW_T, BIOS SE5C600.86B.01.08.0003.022620131521 02/26/2013\n  Call Trace:\n   <IRQ>\n    __list_add+0xac/0xc0\n    __internal_add_timer+0xab/0x130\n    internal_add_timer+0x17/0x40\n    mod_timer_pinned+0xca/0x170\n    intel_pstate_timer_func+0x28a/0x380\n    call_timer_fn+0x36/0x100\n    run_timer_softirq+0x1ff/0x2f0\n    __do_softirq+0xf5/0x2e0\n    irq_exit+0x10d/0x120\n    smp_apic_timer_interrupt+0x45/0x60\n    apic_timer_interrupt+0x6d/0x80\n   <EOI>\n    cpuidle_idle_call+0xb9/0x1f0\n    arch_cpu_idle+0xe/0x30\n    cpu_startup_entry+0x9e/0x240\n    start_secondary+0x1e4/0x290\n\n  kernel BUG at kernel/timer.c:1084!\n  invalid opcode: 0000 [#1] SMP\n  Modules linked in: sg nfsv3 rpcsec_gss_krb5 nfsv4 dns_resolver nfs fscache cfg80211 rfkill x86_pkg_temp_thermal coretemp kvm_intel kvm ixgbe e1000e crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd iTCO_wdt ptp sb_edac iTCO_vendor_support pps_core mdio ipmi_devintf edac_core ioatdma microcode shpchp lpc_ich pcspkr i2c_i801 dca mfd_core ipmi_si wmi ipmi_msghandler nfsd auth_rpcgss nfs_acl lockd sunrpc xfs libcrc32c sd_mod sr_mod cdrom crc_t10dif crct10dif_common mgag200 syscopyarea sysfillrect sysimgblt isci i2c_algo_bit drm_kms_helper ttm drm libsas ahci libahci scsi_transport_sas libata i2c_core dm_mirror dm_region_hash dm_log dm_mod\n  CPU: 12 PID: 0 Comm: swapper/12 Tainted: G        W    3.13.0+ #1\n  Hardware name: Intel Corporation LH Pass ........../SVRBD-ROW_T, BIOS SE5C600.86B.01.08.0003.022620131521 02/26/2013\n  Call Trace:\n   <IRQ>\n    run_timer_softirq+0x245/0x2f0\n    __do_softirq+0xf5/0x2e0\n    irq_exit+0x10d/0x120\n    smp_apic_timer_interrupt+0x45/0x60\n    apic_timer_interrupt+0x6d/0x80\n   <EOI>\n    cpuidle_idle_call+0xb9/0x1f0\n    arch_cpu_idle+0xe/0x30\n    cpu_startup_entry+0x9e/0x240\n    start_secondary+0x1e4/0x290\n  RIP   cascade+0x93/0xa0\n\n  WARNING: CPU: 36 PID: 1154 at kernel/workqueue.c:1461 __queue_delayed_work+0xed/0x1a0()\n  Modules linked in: sg nfsv3 rpcsec_gss_krb5 nfsv4 dns_resolver nfs fscache cfg80211 rfkill x86_pkg_temp_thermal coretemp kvm_intel kvm ixgbe e1000e crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd iTCO_wdt ptp sb_edac iTCO_vendor_support pps_core mdio ipmi_devintf edac_core ioatdma microcode shpchp lpc_ich pcspkr i2c_i801 dca mfd_core ipmi_si wmi ipmi_msghandler nfsd auth_rpcgss nfs_acl lockd sunrpc xfs libcrc32c sd_mod sr_mod cdrom crc_t10dif crct10dif_common mgag200 syscopyarea sysfillrect sysimgblt isci i2c_algo_bit drm_kms_helper ttm drm libsas ahci libahci scsi_transport_sas libata i2c_core dm_mirror dm_region_hash dm_log dm_mod\n  CPU: 36 PID: 1154 Comm: kworker/u481:3 Tainted: G        W    3.13.0+ #1\n  Hardware name: Intel Corporation LH Pass ........../SVRBD-ROW_T, BIOS SE5C600.86B.01.08.0003.022620131521 02/26/2013\n  Workqueue: edac-poller edac_mc_workq_function [edac_core]\n  Call Trace:\n    dump_stack+0x45/0x56\n    warn_slowpath_common+0x7d/0xa0\n    warn_slowpath_null+0x1a/0x20\n    __queue_delayed_work+0xed/0x1a0\n    queue_delayed_work_on+0x27/0x50\n    edac_mc_workq_function+0x72/0xa0 [edac_core]\n    process_one_work+0x17b/0x460\n    worker_thread+0x11b/0x400\n    kthread+0xd2/0xf0\n    ret_from_fork+0x7c/0xb0\n\nThis patch adds a range check in the edac_mc_poll_msec code to check for 0.\n\nSigned-off-by: Prarit Bhargava <prarit@redhat.com>\nCc: Doug Thompson <dougthompson@xmission.com>\nCc: Mauro Carvalho Chehab <mchehab@infradead.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
        "before_after_code_files": [
          "drivers/edac/edac_mc_sysfs.c||drivers/edac/edac_mc_sysfs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/edac/edac_mc_sysfs.c||drivers/edac/edac_mc_sysfs.c": [
          "File: drivers/edac/edac_mc_sysfs.c -> drivers/edac/edac_mc_sysfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "61:  ret = kstrtol(val, 0, &l);",
          "62:  if (ret)",
          "63:   return ret;",
          "65:   return -EINVAL;",
          "",
          "[Removed Lines]",
          "64:  if ((int)l != l)",
          "",
          "[Added Lines]",
          "64:  if (!l || ((int)l != l))",
          "",
          "---------------"
        ]
      }
    }
  ]
}