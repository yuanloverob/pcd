{
  "cve_id": "CVE-2016-6351",
  "cve_desc": "The esp_do_dma function in hw/scsi/esp.c in QEMU (aka Quick Emulator), when built with ESP/NCR53C9x controller emulation support, allows local guest OS administrators to cause a denial of service (out-of-bounds write and QEMU process crash) or execute arbitrary code on the QEMU host via vectors involving DMA read into ESP command buffer.",
  "repo": "qemu/qemu",
  "patch_hash": "926cde5f3e4d2504ed161ed0cb771ac7cad6fd11",
  "patch_info": {
    "commit_hash": "926cde5f3e4d2504ed161ed0cb771ac7cad6fd11",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/926cde5f3e4d2504ed161ed0cb771ac7cad6fd11",
    "files": [
      "hw/scsi/esp.c",
      "include/hw/scsi/esp.h"
    ],
    "message": "scsi: esp: make cmdbuf big enough for maximum CDB size\n\nWhile doing DMA read into ESP command buffer 's->cmdbuf', it could\nwrite past the 's->cmdbuf' area, if it was transferring more than 16\nbytes.  Increase the command buffer size to 32, which is maximum when\n's->do_cmd' is set, and add a check on 'len' to avoid OOB access.\n\nReported-by: Li Qiang <liqiang6-s@360.cn>\nSigned-off-by: Prasad J Pandit <pjp@fedoraproject.org>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
    "before_after_code_files": [
      "hw/scsi/esp.c||hw/scsi/esp.c",
      "include/hw/scsi/esp.h||include/hw/scsi/esp.h"
    ]
  },
  "patch_diff": {
    "hw/scsi/esp.c||hw/scsi/esp.c": [
      "File: hw/scsi/esp.c -> hw/scsi/esp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "248:     len = s->dma_left;",
      "249:     if (s->do_cmd) {",
      "250:         trace_esp_do_dma(s->cmdlen, len);",
      "251:         s->dma_memory_read(s->dma_opaque, &s->cmdbuf[s->cmdlen], len);",
      "252:         return;",
      "253:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "251:         assert (s->cmdlen <= sizeof(s->cmdbuf) &&",
      "252:                 len <= sizeof(s->cmdbuf) - s->cmdlen);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "345:     s->dma_counter = dmalen;",
      "347:     if (s->do_cmd)",
      "349:     else if (s->ti_size < 0)",
      "350:         minlen = (dmalen < -s->ti_size) ? dmalen : -s->ti_size;",
      "351:     else",
      "",
      "[Removed Lines]",
      "348:         minlen = (dmalen < 32) ? dmalen : 32;",
      "",
      "[Added Lines]",
      "350:         minlen = (dmalen < ESP_CMDBUF_SZ) ? dmalen : ESP_CMDBUF_SZ;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "449:         break;",
      "450:     case ESP_FIFO:",
      "451:         if (s->do_cmd) {",
      "453:                 s->cmdbuf[s->cmdlen++] = val & 0xff;",
      "454:             } else {",
      "455:                 trace_esp_error_fifo_overrun();",
      "",
      "[Removed Lines]",
      "452:             if (s->cmdlen < TI_BUFSZ) {",
      "",
      "[Added Lines]",
      "454:             if (s->cmdlen < ESP_CMDBUF_SZ) {",
      "",
      "---------------"
    ],
    "include/hw/scsi/esp.h||include/hw/scsi/esp.h": [
      "File: include/hw/scsi/esp.h -> include/hw/scsi/esp.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "15: #define ESP_REGS 16",
      "16: #define TI_BUFSZ 16",
      "18: typedef struct ESPState ESPState;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "17: #define ESP_CMDBUF_SZ 32",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "31:     SCSIBus bus;",
      "32:     SCSIDevice *current_dev;",
      "33:     SCSIRequest *current_req;",
      "35:     uint32_t cmdlen;",
      "36:     uint32_t do_cmd;",
      "",
      "[Removed Lines]",
      "34:     uint8_t cmdbuf[TI_BUFSZ];",
      "",
      "[Added Lines]",
      "35:     uint8_t cmdbuf[ESP_CMDBUF_SZ];",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "27fa5e735a267d21b3ae040b059636d5063bb7e4",
      "candidate_info": {
        "commit_hash": "27fa5e735a267d21b3ae040b059636d5063bb7e4",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/27fa5e735a267d21b3ae040b059636d5063bb7e4",
        "files": [
          "hw/scsi/esp.c",
          "include/hw/scsi/esp.h"
        ],
        "message": "scsi: esp: make cmdbuf big enough for maximum CDB size\n\nWhile doing DMA read into ESP command buffer 's->cmdbuf', it could\nwrite past the 's->cmdbuf' area, if it was transferring more than 16\nbytes.  Increase the command buffer size to 32, which is maximum when\n's->do_cmd' is set, and add a check on 'len' to avoid OOB access.\n\nReported-by: Li Qiang <liqiang6-s@360.cn>\nSigned-off-by: Prasad J Pandit <pjp@fedoraproject.org>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\n(cherry picked from commit 926cde5f3e4d2504ed161ed0cb771ac7cad6fd11)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/scsi/esp.c||hw/scsi/esp.c",
          "include/hw/scsi/esp.h||include/hw/scsi/esp.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/scsi/esp.c||hw/scsi/esp.c",
            "include/hw/scsi/esp.h||include/hw/scsi/esp.h"
          ],
          "candidate": [
            "hw/scsi/esp.c||hw/scsi/esp.c",
            "include/hw/scsi/esp.h||include/hw/scsi/esp.h"
          ]
        }
      },
      "candidate_diff": {
        "hw/scsi/esp.c||hw/scsi/esp.c": [
          "File: hw/scsi/esp.c -> hw/scsi/esp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "248:     len = s->dma_left;",
          "249:     if (s->do_cmd) {",
          "250:         trace_esp_do_dma(s->cmdlen, len);",
          "251:         s->dma_memory_read(s->dma_opaque, &s->cmdbuf[s->cmdlen], len);",
          "252:         return;",
          "253:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "251:         assert (s->cmdlen <= sizeof(s->cmdbuf) &&",
          "252:                 len <= sizeof(s->cmdbuf) - s->cmdlen);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "345:     s->dma_counter = dmalen;",
          "347:     if (s->do_cmd)",
          "349:     else if (s->ti_size < 0)",
          "350:         minlen = (dmalen < -s->ti_size) ? dmalen : -s->ti_size;",
          "351:     else",
          "",
          "[Removed Lines]",
          "348:         minlen = (dmalen < 32) ? dmalen : 32;",
          "",
          "[Added Lines]",
          "350:         minlen = (dmalen < ESP_CMDBUF_SZ) ? dmalen : ESP_CMDBUF_SZ;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "451:         break;",
          "452:     case ESP_FIFO:",
          "453:         if (s->do_cmd) {",
          "455:                 s->cmdbuf[s->cmdlen++] = val & 0xff;",
          "456:             } else {",
          "457:                 trace_esp_error_fifo_overrun();",
          "",
          "[Removed Lines]",
          "454:             if (s->cmdlen < TI_BUFSZ) {",
          "",
          "[Added Lines]",
          "456:             if (s->cmdlen < ESP_CMDBUF_SZ) {",
          "",
          "---------------"
        ],
        "include/hw/scsi/esp.h||include/hw/scsi/esp.h": [
          "File: include/hw/scsi/esp.h -> include/hw/scsi/esp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: #define ESP_REGS 16",
          "16: #define TI_BUFSZ 16",
          "18: typedef struct ESPState ESPState;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "17: #define ESP_CMDBUF_SZ 32",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "31:     SCSIBus bus;",
          "32:     SCSIDevice *current_dev;",
          "33:     SCSIRequest *current_req;",
          "35:     uint32_t cmdlen;",
          "36:     uint32_t do_cmd;",
          "",
          "[Removed Lines]",
          "34:     uint8_t cmdbuf[TI_BUFSZ];",
          "",
          "[Added Lines]",
          "35:     uint8_t cmdbuf[ESP_CMDBUF_SZ];",
          "",
          "---------------"
        ]
      }
    }
  ]
}