{
  "cve_id": "CVE-2021-29577",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The implementation of `tf.raw_ops.AvgPool3DGrad` is vulnerable to a heap buffer overflow. The implementation(https://github.com/tensorflow/tensorflow/blob/d80ffba9702dc19d1fac74fc4b766b3fa1ee976b/tensorflow/core/kernels/pooling_ops_3d.cc#L376-L450) assumes that the `orig_input_shape` and `grad` tensors have similar first and last dimensions but does not check that this assumption is validated. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "6fc9141f42f6a72180ecd24021c3e6b36165fe0d",
  "patch_info": {
    "commit_hash": "6fc9141f42f6a72180ecd24021c3e6b36165fe0d",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/6fc9141f42f6a72180ecd24021c3e6b36165fe0d",
    "files": [
      "tensorflow/core/kernels/pooling_ops_3d.cc"
    ],
    "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
    "before_after_code_files": [
      "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
      "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "383:                      const std::array<int64, 3>& output_shape,",
      "384:                      const std::array<int64, 3>& padding,",
      "385:                      TensorFormat data_format, Tensor* output) {",
      "386:     output->flat<T>().setZero();",
      "387:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
      "388:                                         tensor_in_shape.dim_size(2),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "386:     OP_REQUIRES(",
      "387:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
      "388:         errors::InvalidArgument(",
      "389:             \"Expected first dimension of tensor_in_shape and \"",
      "390:             \"out_backprop to match, got \",",
      "391:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
      "392:     OP_REQUIRES(",
      "393:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
      "394:         errors::InvalidArgument(",
      "395:             \"Expected last dimension of tensor_in_shape and \"",
      "396:             \"out_backprop to match, got \",",
      "397:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "048d50007d3f6ace106c066d00cc21c8b565b0b5",
      "candidate_info": {
        "commit_hash": "048d50007d3f6ace106c066d00cc21c8b565b0b5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/048d50007d3f6ace106c066d00cc21c8b565b0b5",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "383:                      const std::array<int64, 3>& output_shape,",
          "384:                      const std::array<int64, 3>& padding,",
          "385:                      TensorFormat data_format, Tensor* output) {",
          "386:     output->flat<T>().setZero();",
          "387:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
          "388:                                         tensor_in_shape.dim_size(2),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "386:     OP_REQUIRES(",
          "387:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
          "388:         errors::InvalidArgument(",
          "389:             \"Expected first dimension of tensor_in_shape and \"",
          "390:             \"out_backprop to match, got \",",
          "391:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
          "392:     OP_REQUIRES(",
          "393:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
          "394:         errors::InvalidArgument(",
          "395:             \"Expected last dimension of tensor_in_shape and \"",
          "396:             \"out_backprop to match, got \",",
          "397:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "74aa90d23fa083b9d58a00c43f1c7c207ed151ab",
      "candidate_info": {
        "commit_hash": "74aa90d23fa083b9d58a00c43f1c7c207ed151ab",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/74aa90d23fa083b9d58a00c43f1c7c207ed151ab",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "383:                      const std::array<int64, 3>& output_shape,",
          "384:                      const std::array<int64, 3>& padding,",
          "385:                      TensorFormat data_format, Tensor* output) {",
          "386:     output->flat<T>().setZero();",
          "387:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
          "388:                                         tensor_in_shape.dim_size(2),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "386:     OP_REQUIRES(",
          "387:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
          "388:         errors::InvalidArgument(",
          "389:             \"Expected first dimension of tensor_in_shape and \"",
          "390:             \"out_backprop to match, got \",",
          "391:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
          "392:     OP_REQUIRES(",
          "393:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
          "394:         errors::InvalidArgument(",
          "395:             \"Expected last dimension of tensor_in_shape and \"",
          "396:             \"out_backprop to match, got \",",
          "397:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a9be6e544b6ac2849caf96ece65c3a17704e63ab",
      "candidate_info": {
        "commit_hash": "a9be6e544b6ac2849caf96ece65c3a17704e63ab",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a9be6e544b6ac2849caf96ece65c3a17704e63ab",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "389:                      const std::array<int64, 3>& output_shape,",
          "390:                      const std::array<int64, 3>& padding,",
          "391:                      TensorFormat data_format, Tensor* output) {",
          "392:     output->flat<T>().setZero();",
          "393:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
          "394:                                         tensor_in_shape.dim_size(2),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "392:     OP_REQUIRES(",
          "393:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
          "394:         errors::InvalidArgument(",
          "395:             \"Expected first dimension of tensor_in_shape and \"",
          "396:             \"out_backprop to match, got \",",
          "397:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
          "398:     OP_REQUIRES(",
          "399:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
          "400:         errors::InvalidArgument(",
          "401:             \"Expected last dimension of tensor_in_shape and \"",
          "402:             \"out_backprop to match, got \",",
          "403:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3e3a28fcde7163d435981ae5cfe9745720ebf8a9",
      "candidate_info": {
        "commit_hash": "3e3a28fcde7163d435981ae5cfe9745720ebf8a9",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3e3a28fcde7163d435981ae5cfe9745720ebf8a9",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "387:                      const std::array<int64, 3>& output_shape,",
          "388:                      const std::array<int64, 3>& padding,",
          "389:                      TensorFormat data_format, Tensor* output) {",
          "390:     output->flat<T>().setZero();",
          "391:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
          "392:                                         tensor_in_shape.dim_size(2),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "390:     OP_REQUIRES(",
          "391:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
          "392:         errors::InvalidArgument(",
          "393:             \"Expected first dimension of tensor_in_shape and \"",
          "394:             \"out_backprop to match, got \",",
          "395:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
          "396:     OP_REQUIRES(",
          "397:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
          "398:         errors::InvalidArgument(",
          "399:             \"Expected last dimension of tensor_in_shape and \"",
          "400:             \"out_backprop to match, got \",",
          "401:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f6852e7ee8753180ee8d0812c646990079693ad0",
      "candidate_info": {
        "commit_hash": "f6852e7ee8753180ee8d0812c646990079693ad0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f6852e7ee8753180ee8d0812c646990079693ad0",
        "files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc"
        ],
        "message": "Fix assertion failure in pooling_ops_3d\n\nPiperOrigin-RevId: 372364504\nChange-Id: Iecde4fe26b47a8fa935d6e2611b5585ed5777781",
        "before_after_code_files": [
          "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/pooling_ops_3d.cc||tensorflow/core/kernels/pooling_ops_3d.cc": [
          "File: tensorflow/core/kernels/pooling_ops_3d.cc -> tensorflow/core/kernels/pooling_ops_3d.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "387:                      const std::array<int64, 3>& output_shape,",
          "388:                      const std::array<int64, 3>& padding,",
          "389:                      TensorFormat data_format, Tensor* output) {",
          "390:     output->flat<T>().setZero();",
          "391:     std::array<int64, 3> input_size = {{tensor_in_shape.dim_size(3),",
          "392:                                         tensor_in_shape.dim_size(2),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "390:     OP_REQUIRES(",
          "391:         context, tensor_in_shape.dim_size(0) == out_backprop.dim_size(0),",
          "392:         errors::InvalidArgument(",
          "393:             \"Expected first dimension of tensor_in_shape and \"",
          "394:             \"out_backprop to match, got \",",
          "395:             tensor_in_shape.dim_size(0), \" and \", out_backprop.dim_size(0)));",
          "396:     OP_REQUIRES(",
          "397:         context, tensor_in_shape.dim_size(4) == out_backprop.dim_size(4),",
          "398:         errors::InvalidArgument(",
          "399:             \"Expected last dimension of tensor_in_shape and \"",
          "400:             \"out_backprop to match, got \",",
          "401:             tensor_in_shape.dim_size(4), \" and \", out_backprop.dim_size(4)));",
          "",
          "---------------"
        ]
      }
    }
  ]
}