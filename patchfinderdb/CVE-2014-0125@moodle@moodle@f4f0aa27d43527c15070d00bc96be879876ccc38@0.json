{
  "cve_id": "CVE-2014-0125",
  "cve_desc": "repository/alfresco/lib.php in Moodle through 2.3.11, 2.4.x before 2.4.9, 2.5.x before 2.5.5, and 2.6.x before 2.6.2 places a session key in a URL, which allows remote attackers to bypass intended Alfresco Repository file restrictions by impersonating a file's owner.",
  "repo": "moodle/moodle",
  "patch_hash": "f4f0aa27d43527c15070d00bc96be879876ccc38",
  "patch_info": {
    "commit_hash": "f4f0aa27d43527c15070d00bc96be879876ccc38",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/f4f0aa27d43527c15070d00bc96be879876ccc38",
    "files": [
      "repository/alfresco/db/upgrade.php",
      "repository/alfresco/db/upgradelib.php",
      "repository/alfresco/lang/en/repository_alfresco.php",
      "repository/alfresco/lib.php",
      "repository/alfresco/version.php"
    ],
    "message": "MDL-29409 repository_alfresco: Drop support for URL/link\n\nThe current solution has two major issues. Firstly, it is using the\nsession key in the file URL, allowing anyone with the link to steal\nthe identify of the poster. Secondly, the links are not presistent\nand become broken as soon as the server is restarted. Let's not\nsupport this any more until a proper solution is found in MDL-26454.",
    "before_after_code_files": [
      "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
      "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
      "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
      "repository/alfresco/lib.php||repository/alfresco/lib.php",
      "repository/alfresco/version.php||repository/alfresco/version.php"
    ]
  },
  "patch_diff": {
    "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php": [
      "File: repository/alfresco/db/upgrade.php -> repository/alfresco/db/upgrade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "25: defined('MOODLE_INTERNAL') || die();",
      "33: function xmldb_repository_alfresco_upgrade($oldversion) {",
      "34:     global $CFG, $DB;",
      "36:     $dbman = $DB->get_manager();",
      "38:     if ($oldversion < 2014020301) {",
      "39:         require_once($CFG->dirroot . '/repository/lib.php');",
      "40:         require_once($CFG->dirroot . '/repository/alfresco/db/upgradelib.php');",
      "42:         $params = array();",
      "43:         $params['context'] = array();",
      "44:         $params['onlyvisible'] = false;",
      "45:         $params['type'] = 'alfresco';",
      "46:         $instances = repository::get_instances($params);",
      "49:         if (!empty($instances)) {",
      "50:             repository_alfresco_admin_security_key_notice();",
      "51:         }",
      "53:         upgrade_plugin_savepoint(true, 2014020301, 'repository', 'alfresco');",
      "54:     }",
      "56:     return true;",
      "57: }",
      "",
      "---------------"
    ],
    "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php": [
      "File: repository/alfresco/db/upgradelib.php -> repository/alfresco/db/upgradelib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "25: defined('MOODLE_INTERNAL') || die();",
      "32: function repository_alfresco_admin_security_key_notice() {",
      "33:     $admins = get_admins();",
      "35:     if (empty($admins)) {",
      "36:         return;",
      "37:     }",
      "39:     foreach ($admins as $admin) {",
      "40:         $message = new stdClass();",
      "41:         $message->component         = 'moodle';",
      "42:         $message->name              = 'notices';",
      "43:         $message->userfrom          = get_admin();",
      "44:         $message->userto            = $admin;",
      "45:         $message->smallmessage      = get_string('security_key_notice_message_small', 'repository_alfresco');",
      "46:         $message->subject           = get_string('security_key_notice_message_subject', 'repository_alfresco');",
      "47:         $message->fullmessage       = get_string('security_key_notice_message_content', 'repository_alfresco');",
      "48:         $message->fullmessagehtml   = get_string('security_key_notice_message_content', 'repository_alfresco');",
      "49:         $message->fullmessageformat = FORMAT_PLAIN;",
      "50:         $message->notification      = 1;",
      "51:         message_send($message);",
      "52:     }",
      "53: }",
      "",
      "---------------"
    ],
    "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php": [
      "File: repository/alfresco/lang/en/repository_alfresco.php -> repository/alfresco/lang/en/repository_alfresco.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "31: $string['password'] = 'Password';",
      "32: $string['pluginname_help'] = 'A plug-in for Alfresco CMS';",
      "33: $string['pluginname'] = 'Alfresco repository';",
      "34: $string['soapmustbeenabled'] = 'SOAP extension must be enabled for alfresco plugin';",
      "35: $string['space'] = 'Space';",
      "36: $string['username'] = 'User name';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "34: $string['security_key_notice_message_small'] = 'Due to a recent security issue found in the Alfresco repository, we advice you to restart your Alfresco server.';",
      "35: $string['security_key_notice_message_subject'] = 'Alfresco repository security notice';",
      "36: $string['security_key_notice_message_content'] = 'A recent security issue was discovered when using external links to the Alfresco Moodle repository. Users were able to gain access to the accounts of other users on the Alfresco server through the use of information contained in these links (tokens). This feature has now been disabled, but it is possible that the tokens contained within these links still allow access to another user\\'s account. For your own protection, it is important that you restart your Alfresco server in order to expire the tokens.';",
      "",
      "---------------"
    ],
    "repository/alfresco/lib.php||repository/alfresco/lib.php": [
      "File: repository/alfresco/lib.php -> repository/alfresco/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "205:         return parent::get_file($url, $file);",
      "206:     }",
      "220:     public function print_search() {",
      "221:         $str = parent::print_search();",
      "222:         $str .= html_writer::label(get_string('space', 'repository_alfresco'), 'space', false, array('class' => 'accesshide'));",
      "",
      "[Removed Lines]",
      "214:     public function get_link($uuid) {",
      "215:         $node = $this->user_session->getNode($this->store, $uuid);",
      "216:         $url = $this->get_url($node);",
      "217:         return $url;",
      "218:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "294:         }",
      "295:     }",
      "296:     public function supported_returntypes() {",
      "298:     }",
      "299: }",
      "",
      "[Removed Lines]",
      "297:         return (FILE_INTERNAL | FILE_EXTERNAL);",
      "",
      "[Added Lines]",
      "285:         return FILE_INTERNAL;",
      "",
      "---------------"
    ],
    "repository/alfresco/version.php||repository/alfresco/version.php": [
      "File: repository/alfresco/version.php -> repository/alfresco/version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: defined('MOODLE_INTERNAL') || die();",
      "30: $plugin->requires  = 2013110500;        // Requires this Moodle version",
      "31: $plugin->component = 'repository_alfresco'; // Full name of the plugin (used for diagnostics)",
      "",
      "[Removed Lines]",
      "29: $plugin->version   = 2013110500;        // The current plugin version (Date: YYYYMMDDXX)",
      "",
      "[Added Lines]",
      "29: $plugin->version   = 2014020301;        // The current plugin version (Date: YYYYMMDDXX)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8373c7e38e70afcb65550625c5938d9ec753f706",
      "candidate_info": {
        "commit_hash": "8373c7e38e70afcb65550625c5938d9ec753f706",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8373c7e38e70afcb65550625c5938d9ec753f706",
        "files": [
          "repository/alfresco/version.php"
        ],
        "message": "MDL-44547 repository_alfresco: version bump",
        "before_after_code_files": [
          "repository/alfresco/version.php||repository/alfresco/version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ],
          "candidate": [
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ]
        }
      },
      "candidate_diff": {
        "repository/alfresco/version.php||repository/alfresco/version.php": [
          "File: repository/alfresco/version.php -> repository/alfresco/version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "30: $plugin->requires  = 2013110500;        // Requires this Moodle version",
          "31: $plugin->component = 'repository_alfresco'; // Full name of the plugin (used for diagnostics)",
          "",
          "[Removed Lines]",
          "29: $plugin->version   = 2014020301;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "[Added Lines]",
          "29: $plugin->version   = 2014022700;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a71a6de914bec01df4268d0547c7a52917c4192f",
      "candidate_info": {
        "commit_hash": "a71a6de914bec01df4268d0547c7a52917c4192f",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a71a6de914bec01df4268d0547c7a52917c4192f",
        "files": [
          "repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php",
          "repository/alfresco/version.php"
        ],
        "message": "MDL-29409 repository_alfresco: Drop support for URL/link\n\nThe current solution has two major issues. Firstly, it is using the\nsession key in the file URL, allowing anyone with the link to steal\nthe identify of the poster. Secondly, the links are not presistent\nand become broken as soon as the server is restarted. Let's not\nsupport this any more until a proper solution is found in MDL-26454.",
        "before_after_code_files": [
          "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php||repository/alfresco/lib.php",
          "repository/alfresco/version.php||repository/alfresco/version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ],
          "candidate": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ]
        }
      },
      "candidate_diff": {
        "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php": [
          "File: repository/alfresco/db/upgrade.php -> repository/alfresco/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "33: function xmldb_repository_alfresco_upgrade($oldversion) {",
          "34:     global $CFG, $DB;",
          "36:     $dbman = $DB->get_manager();",
          "38:     if ($oldversion < 2014020301) {",
          "39:         require_once($CFG->dirroot . '/repository/lib.php');",
          "40:         require_once($CFG->dirroot . '/repository/alfresco/db/upgradelib.php');",
          "42:         $params = array();",
          "43:         $params['context'] = array();",
          "44:         $params['onlyvisible'] = false;",
          "45:         $params['type'] = 'alfresco';",
          "46:         $instances = repository::get_instances($params);",
          "49:         if (!empty($instances)) {",
          "50:             repository_alfresco_admin_security_key_notice();",
          "51:         }",
          "53:         upgrade_plugin_savepoint(true, 2014020301, 'repository', 'alfresco');",
          "54:     }",
          "56:     return true;",
          "57: }",
          "",
          "---------------"
        ],
        "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php": [
          "File: repository/alfresco/db/upgradelib.php -> repository/alfresco/db/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "32: function repository_alfresco_admin_security_key_notice() {",
          "33:     $admins = get_admins();",
          "35:     if (empty($admins)) {",
          "36:         return;",
          "37:     }",
          "39:     foreach ($admins as $admin) {",
          "40:         $message = new stdClass();",
          "41:         $message->component         = 'moodle';",
          "42:         $message->name              = 'notices';",
          "43:         $message->userfrom          = get_admin();",
          "44:         $message->userto            = $admin;",
          "45:         $message->smallmessage      = get_string('security_key_notice_message_small', 'repository_alfresco');",
          "46:         $message->subject           = get_string('security_key_notice_message_subject', 'repository_alfresco');",
          "47:         $message->fullmessage       = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "48:         $message->fullmessagehtml   = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "49:         $message->fullmessageformat = FORMAT_PLAIN;",
          "50:         $message->notification      = 1;",
          "51:         message_send($message);",
          "52:     }",
          "53: }",
          "",
          "---------------"
        ],
        "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php": [
          "File: repository/alfresco/lang/en/repository_alfresco.php -> repository/alfresco/lang/en/repository_alfresco.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: $string['password'] = 'Password';",
          "32: $string['pluginname_help'] = 'A plug-in for Alfresco CMS';",
          "33: $string['pluginname'] = 'Alfresco repository';",
          "34: $string['soapmustbeenabled'] = 'SOAP extension must be enabled for alfresco plugin';",
          "35: $string['space'] = 'Space';",
          "36: $string['username'] = 'User name';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: $string['security_key_notice_message_small'] = 'Due to a recent security issue found in the Alfresco repository, we advice you to restart your Alfresco server.';",
          "35: $string['security_key_notice_message_subject'] = 'Alfresco repository security notice';",
          "36: $string['security_key_notice_message_content'] = 'A recent security issue was discovered when using external links to the Alfresco Moodle repository. Users were able to gain access to the accounts of other users on the Alfresco server through the use of information contained in these links (tokens). This feature has now been disabled, but it is possible that the tokens contained within these links still allow access to another user\\'s account. For your own protection, it is important that you restart your Alfresco server in order to expire the tokens.';",
          "",
          "---------------"
        ],
        "repository/alfresco/lib.php||repository/alfresco/lib.php": [
          "File: repository/alfresco/lib.php -> repository/alfresco/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:         return parent::get_file($url, $file);",
          "206:     }",
          "220:     public function print_search() {",
          "221:         $str = parent::print_search();",
          "222:         $str .= html_writer::label(get_string('space', 'repository_alfresco'), 'space', false, array('class' => 'accesshide'));",
          "",
          "[Removed Lines]",
          "214:     public function get_link($uuid) {",
          "215:         $node = $this->user_session->getNode($this->store, $uuid);",
          "216:         $url = $this->get_url($node);",
          "217:         return $url;",
          "218:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "294:         }",
          "295:     }",
          "296:     public function supported_returntypes() {",
          "298:     }",
          "299: }",
          "",
          "[Removed Lines]",
          "297:         return (FILE_INTERNAL | FILE_EXTERNAL);",
          "",
          "[Added Lines]",
          "285:         return FILE_INTERNAL;",
          "",
          "---------------"
        ],
        "repository/alfresco/version.php||repository/alfresco/version.php": [
          "File: repository/alfresco/version.php -> repository/alfresco/version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "30: $plugin->requires  = 2013050100;        // Requires this Moodle version",
          "31: $plugin->component = 'repository_alfresco'; // Full name of the plugin (used for diagnostics)",
          "",
          "[Removed Lines]",
          "29: $plugin->version   = 2013050100;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "[Added Lines]",
          "29: $plugin->version   = 2014020301;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee8f17db890d7fa1bfc2cfd49ff8d21b41d29331",
      "candidate_info": {
        "commit_hash": "ee8f17db890d7fa1bfc2cfd49ff8d21b41d29331",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ee8f17db890d7fa1bfc2cfd49ff8d21b41d29331",
        "files": [
          "repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php",
          "repository/alfresco/version.php"
        ],
        "message": "MDL-29409 repository_alfresco: Drop support for URL/link\n\nThe current solution has two major issues. Firstly, it is using the\nsession key in the file URL, allowing anyone with the link to steal\nthe identify of the poster. Secondly, the links are not presistent\nand become broken as soon as the server is restarted. Let's not\nsupport this any more until a proper solution is found in MDL-26454.",
        "before_after_code_files": [
          "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php||repository/alfresco/lib.php",
          "repository/alfresco/version.php||repository/alfresco/version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ],
          "candidate": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ]
        }
      },
      "candidate_diff": {
        "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php": [
          "File: repository/alfresco/db/upgrade.php -> repository/alfresco/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "33: function xmldb_repository_alfresco_upgrade($oldversion) {",
          "34:     global $CFG, $DB;",
          "36:     $dbman = $DB->get_manager();",
          "38:     if ($oldversion < 2014020301) {",
          "39:         require_once($CFG->dirroot . '/repository/lib.php');",
          "40:         require_once($CFG->dirroot . '/repository/alfresco/db/upgradelib.php');",
          "42:         $params = array();",
          "43:         $params['context'] = array();",
          "44:         $params['onlyvisible'] = false;",
          "45:         $params['type'] = 'alfresco';",
          "46:         $instances = repository::get_instances($params);",
          "49:         if (!empty($instances)) {",
          "50:             repository_alfresco_admin_security_key_notice();",
          "51:         }",
          "53:         upgrade_plugin_savepoint(true, 2014020301, 'repository', 'alfresco');",
          "54:     }",
          "56:     return true;",
          "57: }",
          "",
          "---------------"
        ],
        "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php": [
          "File: repository/alfresco/db/upgradelib.php -> repository/alfresco/db/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "32: function repository_alfresco_admin_security_key_notice() {",
          "33:     $admins = get_admins();",
          "35:     if (empty($admins)) {",
          "36:         return;",
          "37:     }",
          "39:     foreach ($admins as $admin) {",
          "40:         $message = new stdClass();",
          "41:         $message->component         = 'moodle';",
          "42:         $message->name              = 'notices';",
          "43:         $message->userfrom          = get_admin();",
          "44:         $message->userto            = $admin;",
          "45:         $message->smallmessage      = get_string('security_key_notice_message_small', 'repository_alfresco');",
          "46:         $message->subject           = get_string('security_key_notice_message_subject', 'repository_alfresco');",
          "47:         $message->fullmessage       = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "48:         $message->fullmessagehtml   = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "49:         $message->fullmessageformat = FORMAT_PLAIN;",
          "50:         $message->notification      = 1;",
          "51:         message_send($message);",
          "52:     }",
          "53: }",
          "",
          "---------------"
        ],
        "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php": [
          "File: repository/alfresco/lang/en/repository_alfresco.php -> repository/alfresco/lang/en/repository_alfresco.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: $string['password'] = 'Password';",
          "32: $string['pluginname_help'] = 'A plug-in for Alfresco CMS';",
          "33: $string['pluginname'] = 'Alfresco repository';",
          "34: $string['soapmustbeenabled'] = 'SOAP extension must be enabled for alfresco plugin';",
          "35: $string['space'] = 'Space';",
          "36: $string['username'] = 'User name';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: $string['security_key_notice_message_small'] = 'Due to a recent security issue found in the Alfresco repository, we advice you to restart your Alfresco server.';",
          "35: $string['security_key_notice_message_subject'] = 'Alfresco repository security notice';",
          "36: $string['security_key_notice_message_content'] = 'A recent security issue was discovered when using external links to the Alfresco Moodle repository. Users were able to gain access to the accounts of other users on the Alfresco server through the use of information contained in these links (tokens). This feature has now been disabled, but it is possible that the tokens contained within these links still allow access to another user\\'s account. For your own protection, it is important that you restart your Alfresco server in order to expire the tokens.';",
          "",
          "---------------"
        ],
        "repository/alfresco/lib.php||repository/alfresco/lib.php": [
          "File: repository/alfresco/lib.php -> repository/alfresco/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:         return parent::get_file($url, $file);",
          "206:     }",
          "220:     public function print_search() {",
          "221:         $str = parent::print_search();",
          "222:         $str .= html_writer::label(get_string('space', 'repository_alfresco'), 'space', false, array('class' => 'accesshide'));",
          "",
          "[Removed Lines]",
          "214:     public function get_link($uuid) {",
          "215:         $node = $this->user_session->getNode($this->store, $uuid);",
          "216:         $url = $this->get_url($node);",
          "217:         return $url;",
          "218:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "294:         }",
          "295:     }",
          "296:     public function supported_returntypes() {",
          "298:     }",
          "299: }",
          "",
          "[Removed Lines]",
          "297:         return (FILE_INTERNAL | FILE_EXTERNAL);",
          "",
          "[Added Lines]",
          "285:         return FILE_INTERNAL;",
          "",
          "---------------"
        ],
        "repository/alfresco/version.php||repository/alfresco/version.php": [
          "File: repository/alfresco/version.php -> repository/alfresco/version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "30: $plugin->requires  = 2013110500;        // Requires this Moodle version",
          "31: $plugin->component = 'repository_alfresco'; // Full name of the plugin (used for diagnostics)",
          "",
          "[Removed Lines]",
          "29: $plugin->version   = 2013110500;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "[Added Lines]",
          "29: $plugin->version   = 2014020301;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4bc5dd32178cbaa62c466f74bf6d0ebafb697818",
      "candidate_info": {
        "commit_hash": "4bc5dd32178cbaa62c466f74bf6d0ebafb697818",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4bc5dd32178cbaa62c466f74bf6d0ebafb697818",
        "files": [
          "repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php",
          "repository/alfresco/version.php"
        ],
        "message": "MDL-29409 repository_alfresco: Drop support for URL/link\n\nThe current solution has two major issues. Firstly, it is using the\nsession key in the file URL, allowing anyone with the link to steal\nthe identify of the poster. Secondly, the links are not presistent\nand become broken as soon as the server is restarted. Let's not\nsupport this any more until a proper solution is found in MDL-26454.",
        "before_after_code_files": [
          "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
          "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
          "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
          "repository/alfresco/lib.php||repository/alfresco/lib.php",
          "repository/alfresco/version.php||repository/alfresco/version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ],
          "candidate": [
            "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php",
            "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php",
            "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php",
            "repository/alfresco/lib.php||repository/alfresco/lib.php",
            "repository/alfresco/version.php||repository/alfresco/version.php"
          ]
        }
      },
      "candidate_diff": {
        "repository/alfresco/db/upgrade.php||repository/alfresco/db/upgrade.php": [
          "File: repository/alfresco/db/upgrade.php -> repository/alfresco/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "33: function xmldb_repository_alfresco_upgrade($oldversion) {",
          "34:     global $CFG, $DB;",
          "36:     $dbman = $DB->get_manager();",
          "38:     if ($oldversion < 2014020301) {",
          "39:         require_once($CFG->dirroot . '/repository/lib.php');",
          "40:         require_once($CFG->dirroot . '/repository/alfresco/db/upgradelib.php');",
          "42:         $params = array();",
          "43:         $params['context'] = array();",
          "44:         $params['onlyvisible'] = false;",
          "45:         $params['type'] = 'alfresco';",
          "46:         $instances = repository::get_instances($params);",
          "49:         if (!empty($instances)) {",
          "50:             repository_alfresco_admin_security_key_notice();",
          "51:         }",
          "53:         upgrade_plugin_savepoint(true, 2014020301, 'repository', 'alfresco');",
          "54:     }",
          "56:     return true;",
          "57: }",
          "",
          "---------------"
        ],
        "repository/alfresco/db/upgradelib.php||repository/alfresco/db/upgradelib.php": [
          "File: repository/alfresco/db/upgradelib.php -> repository/alfresco/db/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "32: function repository_alfresco_admin_security_key_notice() {",
          "33:     $admins = get_admins();",
          "35:     if (empty($admins)) {",
          "36:         return;",
          "37:     }",
          "39:     foreach ($admins as $admin) {",
          "40:         $message = new stdClass();",
          "41:         $message->component         = 'moodle';",
          "42:         $message->name              = 'notices';",
          "43:         $message->userfrom          = get_admin();",
          "44:         $message->userto            = $admin;",
          "45:         $message->smallmessage      = get_string('security_key_notice_message_small', 'repository_alfresco');",
          "46:         $message->subject           = get_string('security_key_notice_message_subject', 'repository_alfresco');",
          "47:         $message->fullmessage       = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "48:         $message->fullmessagehtml   = get_string('security_key_notice_message_content', 'repository_alfresco');",
          "49:         $message->fullmessageformat = FORMAT_PLAIN;",
          "50:         $message->notification      = 1;",
          "51:         message_send($message);",
          "52:     }",
          "53: }",
          "",
          "---------------"
        ],
        "repository/alfresco/lang/en/repository_alfresco.php||repository/alfresco/lang/en/repository_alfresco.php": [
          "File: repository/alfresco/lang/en/repository_alfresco.php -> repository/alfresco/lang/en/repository_alfresco.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: $string['password'] = 'Password';",
          "32: $string['pluginname_help'] = 'A plug-in for Alfresco CMS';",
          "33: $string['pluginname'] = 'Alfresco repository';",
          "34: $string['soapmustbeenabled'] = 'SOAP extension must be enabled for alfresco plugin';",
          "35: $string['space'] = 'Space';",
          "36: $string['username'] = 'User name';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: $string['security_key_notice_message_small'] = 'Due to a recent security issue found in the Alfresco repository, we advice you to restart your Alfresco server.';",
          "35: $string['security_key_notice_message_subject'] = 'Alfresco repository security notice';",
          "36: $string['security_key_notice_message_content'] = 'A recent security issue was discovered when using external links to the Alfresco Moodle repository. Users were able to gain access to the accounts of other users on the Alfresco server through the use of information contained in these links (tokens). This feature has now been disabled, but it is possible that the tokens contained within these links still allow access to another user\\'s account. For your own protection, it is important that you restart your Alfresco server in order to expire the tokens.';",
          "",
          "---------------"
        ],
        "repository/alfresco/lib.php||repository/alfresco/lib.php": [
          "File: repository/alfresco/lib.php -> repository/alfresco/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:         return parent::get_file($url, $file);",
          "206:     }",
          "220:     public function print_search() {",
          "221:         $str = parent::print_search();",
          "222:         $str .= html_writer::label(get_string('space', 'repository_alfresco'), 'space', false, array('class' => 'accesshide'));",
          "",
          "[Removed Lines]",
          "214:     public function get_link($uuid) {",
          "215:         $node = $this->user_session->getNode($this->store, $uuid);",
          "216:         $url = $this->get_url($node);",
          "217:         return $url;",
          "218:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "293:         }",
          "294:     }",
          "295:     public function supported_returntypes() {",
          "297:     }",
          "298: }",
          "",
          "[Removed Lines]",
          "296:         return (FILE_INTERNAL | FILE_EXTERNAL);",
          "",
          "[Added Lines]",
          "284:         return FILE_INTERNAL;",
          "",
          "---------------"
        ],
        "repository/alfresco/version.php||repository/alfresco/version.php": [
          "File: repository/alfresco/version.php -> repository/alfresco/version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "30: $plugin->requires  = 2012112900;        // Requires this Moodle version",
          "31: $plugin->component = 'repository_alfresco'; // Full name of the plugin (used for diagnostics)",
          "",
          "[Removed Lines]",
          "29: $plugin->version   = 2012112900;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "[Added Lines]",
          "29: $plugin->version   = 2014020301;        // The current plugin version (Date: YYYYMMDDXX)",
          "",
          "---------------"
        ]
      }
    }
  ]
}