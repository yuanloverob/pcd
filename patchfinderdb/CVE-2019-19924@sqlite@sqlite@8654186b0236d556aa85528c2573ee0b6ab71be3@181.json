{
  "cve_id": "CVE-2019-19924",
  "cve_desc": "SQLite 3.30.1 mishandles certain parser-tree rewriting, related to expr.c, vdbeaux.c, and window.c. This is caused by incorrect sqlite3WindowRewrite() error handling.",
  "repo": "sqlite/sqlite",
  "patch_hash": "8654186b0236d556aa85528c2573ee0b6ab71be3",
  "patch_info": {
    "commit_hash": "8654186b0236d556aa85528c2573ee0b6ab71be3",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/8654186b0236d556aa85528c2573ee0b6ab71be3",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/expr.c",
      "src/vdbeaux.c",
      "src/window.c"
    ],
    "message": "When an error occurs while rewriting the parser tree for window functions in the sqlite3WindowRewrite() routine, make sure that pParse->nErr is set, and make sure that this shuts down any subsequent code generation that might depend on the transformations that were implemented.  This fixes a problem discovered by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: e2bddcd4c55ba3cbe0130332679ff4b048630d0ced9a8899982edb5a3569ba7f",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/expr.c||src/expr.c",
      "src/vdbeaux.c||src/vdbeaux.c",
      "src/window.c||src/window.c"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 4417c5bf0aabb34ed174f01afd981c924ae965a42128719d8d6735536631d12f",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/expr.c||src/expr.c": [
      "File: src/expr.c -> src/expr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "376:   int addr;",
      "377:   CollSeq *p4;",
      "379:   if( isCommuted ){",
      "380:     p4 = sqlite3BinaryCompareCollSeq(pParse, pRight, pLeft);",
      "381:   }else{",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "379:   if( pParse->nErr ) return 0;",
      "",
      "---------------"
    ],
    "src/vdbeaux.c||src/vdbeaux.c": [
      "File: src/vdbeaux.c -> src/vdbeaux.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1304: static void vdbeVComment(Vdbe *p, const char *zFormat, va_list ap){",
      "1305:   assert( p->nOp>0 || p->aOp==0 );",
      "1307:   if( p->nOp ){",
      "1308:     assert( p->aOp );",
      "1309:     sqlite3DbFree(p->db, p->aOp[p->nOp-1].zComment);",
      "",
      "[Removed Lines]",
      "1306:   assert( p->aOp==0 || p->aOp[p->nOp-1].zComment==0 || p->db->mallocFailed );",
      "",
      "[Added Lines]",
      "1306:   assert( p->aOp==0 || p->aOp[p->nOp-1].zComment==0 || p->db->mallocFailed",
      "1307:           || p->pParse->nErr>0 );",
      "",
      "---------------"
    ],
    "src/window.c||src/window.c": [
      "File: src/window.c -> src/window.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "935:     pTab = sqlite3DbMallocZero(db, sizeof(Table));",
      "936:     if( pTab==0 ){",
      "938:     }",
      "940:     p->pSrc = 0;",
      "",
      "[Removed Lines]",
      "937:       return SQLITE_NOMEM;",
      "",
      "[Added Lines]",
      "937:       return sqlite3ErrorToParser(db, SQLITE_NOMEM);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1039:     sqlite3DbFree(db, pTab);",
      "1040:   }",
      "1042:   return rc;",
      "1043: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1042:   if( rc && pParse->nErr==0 ){",
      "1043:     assert( pParse->db->mallocFailed );",
      "1044:     return sqlite3ErrorToParser(pParse->db, SQLITE_NOMEM);",
      "1045:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4acd754c794d601c9825301580a5af5738befe92",
      "candidate_info": {
        "commit_hash": "4acd754c794d601c9825301580a5af5738befe92",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/4acd754c794d601c9825301580a5af5738befe92",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/select.c",
          "test/with1.test"
        ],
        "message": "If the query flattener detects an error, cause the SELECT code generator to abort immediately.\n\nFossilOrigin-Name: 3d3b142f1045080beb775a9cfe88ec143aa460750132e20059fd510291449850",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/select.c||src/select.c",
          "test/with1.test||test/with1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 9dbf512d1c4627a28d60f4e7238cb100d7a4e11f976139b07ad1c59e9b584c7d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/select.c||src/select.c": [
          "File: src/select.c -> src/select.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5743:     }",
          "5745:     if( flattenSubquery(pParse, p, i, isAgg) ){",
          "5747:       i = -1;",
          "5748:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5746:       if( pParse->nErr ) goto select_end;",
          "",
          "---------------"
        ],
        "test/with1.test||test/with1.test": [
          "File: test/with1.test -> test/with1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1089:      SELECT 3 FROM c,c,c,c,c,c,c,c,c",
          "1090:   )",
          "1091:   SELECT 4 FROM c,c,c,c,c,c,c,c,c;",
          "1094: finish_test",
          "",
          "[Removed Lines]",
          "1092: } {1 {at most 64 tables in a join}}",
          "",
          "[Added Lines]",
          "1092: } {1 {too many FROM clause terms, max: 200}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "58eaf763551db55e78bce1c9f99ba291e29b92eb",
      "candidate_info": {
        "commit_hash": "58eaf763551db55e78bce1c9f99ba291e29b92eb",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/58eaf763551db55e78bce1c9f99ba291e29b92eb",
        "files": [
          "README.md",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Simplify the \"Verifying Code Authenticity\" section of the README.md file. No code changes.\n\nFossilOrigin-Name: adebffc18e6165672947a6bda5ca23ea7723cca7ab8da4feb81fca8f83e4fcaf",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: bc7d2c1656396bb4f5f1f814e60dbf816cc91c5a521b54ad593cd3da0fe8dcb4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "91f473b5cc179b8bfa6521ff339665754a15462a",
      "candidate_info": {
        "commit_hash": "91f473b5cc179b8bfa6521ff339665754a15462a",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/91f473b5cc179b8bfa6521ff339665754a15462a",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/whereexpr.c",
          "test/like3.test"
        ],
        "message": "Do not attempt the LIKE optimization for non-text columns and a pattern prefix of \"-\".  Ticket [0f0428096f17252a]\n\nFossilOrigin-Name: 6fe0367f9a337b7c62886b7771f3ce0642faa13f4e4f3d9a0c848abbab514cd0",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/whereexpr.c||src/whereexpr.c",
          "test/like3.test||test/like3.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f06ef3d75d85545dd58c6dda10f7ad04fafbb7ae8706b3821be21f86a94795f1",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/whereexpr.c||src/whereexpr.c": [
          "File: src/whereexpr.c -> src/whereexpr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "293:           double rDummy;",
          "294:           isNum = sqlite3AtoF(zNew, &rDummy, iTo, SQLITE_UTF8);",
          "295:           if( isNum<=0 ){",
          "299:           }",
          "300:           if( isNum>0 ){",
          "301:             sqlite3ExprDelete(db, pPrefix);",
          "",
          "[Removed Lines]",
          "296:             zNew[iTo-1]++;",
          "297:             isNum = sqlite3AtoF(zNew, &rDummy, iTo, SQLITE_UTF8);",
          "298:             zNew[iTo-1]--;",
          "",
          "[Added Lines]",
          "297:             if( iTo==1 && zNew[0]=='-' ){",
          "298:               isNum = +1;",
          "299:             }else{",
          "300:               zNew[iTo-1]++;",
          "301:               isNum = sqlite3AtoF(zNew, &rDummy, iTo, SQLITE_UTF8);",
          "302:               zNew[iTo-1]--;",
          "303:             }",
          "",
          "---------------"
        ],
        "test/like3.test||test/like3.test": [
          "File: test/like3.test -> test/like3.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "207:   SELECT * FROM t0 WHERE t0.c0 LIKE '.1%';",
          "208: } {.1%}",
          "211: # 2019-02-27",
          "212: # Verify that the LIKE optimization works with an ESCAPE clause when",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "210: # 2019-09-03",
          "211: # Ticket https://www.sqlite.org/src/info/0f0428096f",
          "212: do_execsql_test like3-5.420 {",
          "213:   DROP TABLE IF EXISTS t0;",
          "214:   CREATE TABLE t0(c0 UNIQUE);",
          "215:   INSERT INTO t0(c0) VALUES(-1);",
          "216:   SELECT * FROM t0 WHERE t0.c0 GLOB '-*';",
          "217: } {-1}",
          "218: do_execsql_test like3-5.421 {",
          "219:   SELECT t0.c0 GLOB '-*' FROM t0;",
          "220: } {1}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e5166e070a6590c40ca99ca66d0d97ea37e0b1cd",
      "candidate_info": {
        "commit_hash": "e5166e070a6590c40ca99ca66d0d97ea37e0b1cd",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/e5166e070a6590c40ca99ca66d0d97ea37e0b1cd",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c",
          "src/window.c",
          "test/window1.test"
        ],
        "message": "Revert the OP_MustBeInt opcode implementation on this branch so that it again matches trunk. The extra functionality is no longer required.\n\nFossilOrigin-Name: c02f77b1b4d025d4243f883d6f3a2b3abcaf4944e0209f641b62c576415343dc",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c",
          "src/window.c||src/window.c",
          "test/window1.test||test/window1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 98cc26598718e5557ee00aa77336024c91e483ec6de650e172ad1b44a6f0a77b",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1723:   break;",
          "1724: }",
          "1740:   pIn1 = &aMem[pOp->p1];",
          "1742:     applyAffinity(pIn1, SQLITE_AFF_NUMERIC, encoding);",
          "1745:       if( pOp->p2==0 ){",
          "1746:         rc = SQLITE_MISMATCH;",
          "1747:         goto abort_due_to_error;",
          "",
          "[Removed Lines]",
          "1738:   u8 f;",
          "1739:   f = (pOp->p5 ? (MEM_Int|MEM_Real) : MEM_Int);",
          "1741:   if( (pIn1->flags & f)==0 ){",
          "1743:     VdbeBranchTaken((pIn1->flags&f)==0, 2);",
          "1744:     if( (pIn1->flags & f)==0 ){",
          "",
          "[Added Lines]",
          "1735:   if( (pIn1->flags & MEM_Int)==0 ){",
          "1737:     VdbeBranchTaken((pIn1->flags&MEM_Int)==0, 2);",
          "1738:     if( (pIn1->flags & MEM_Int)==0 ){",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1750:       }",
          "1751:     }",
          "1752:   }",
          "1754:   break;",
          "1755: }",
          "",
          "[Removed Lines]",
          "1753:   if( f==MEM_Int ) MemSetTypeFlag(pIn1, MEM_Int);",
          "",
          "[Added Lines]",
          "1747:   MemSetTypeFlag(pIn1, MEM_Int);",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1302:   int regZero = sqlite3GetTempReg(pParse);",
          "1303:   assert( eCond>=0 && eCond<ArraySize(azErr) );",
          "1304:   sqlite3VdbeAddOp2(v, OP_Integer, 0, regZero);",
          "1307:   VdbeCoverageIf(v, eCond==0);",
          "1308:   VdbeCoverageIf(v, eCond==1);",
          "1309:   VdbeCoverageIf(v, eCond==2);",
          "",
          "[Removed Lines]",
          "1305:   sqlite3VdbeAddOp2(v, OP_MustBeInt, reg, sqlite3VdbeCurrentAddr(v)+2);",
          "1306:   if( eCond>=WINDOW_STARTING_NUM ) sqlite3VdbeChangeP5(v, 1);",
          "",
          "[Added Lines]",
          "1305:   if( eCond>=WINDOW_STARTING_NUM ){",
          "1306:     int regString = sqlite3GetTempReg(pParse);",
          "1307:     sqlite3VdbeAddOp4(v, OP_String8, 0, regString, 0, \"\", P4_STATIC);",
          "1308:     sqlite3VdbeAddOp3(v, OP_Ge, regString, sqlite3VdbeCurrentAddr(v)+2, reg);",
          "1309:     sqlite3VdbeChangeP5(v, SQLITE_AFF_NUMERIC);",
          "1310:   }else{",
          "1311:     sqlite3VdbeAddOp2(v, OP_MustBeInt, reg, sqlite3VdbeCurrentAddr(v)+2);",
          "1312:   }",
          "",
          "---------------"
        ],
        "test/window1.test||test/window1.test": [
          "File: test/window1.test -> test/window1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "938:   FROM keyword_tab",
          "939: }",
          "941: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "941: #-------------------------------------------------------------------------",
          "942: foreach {tn expr err} {",
          "943:   1   4.5      0",
          "944:   2   NULL     1",
          "945:   3   0.0      0",
          "946:   4   0.1      0",
          "947:   5  -0.1      1",
          "948:   6  ''        1",
          "949:   7  '2.0'     0",
          "950:   8  '2.0x'    1",
          "951:   9  x'1234'   1",
          "952:  10  '1.2'     0",
          "953: } {",
          "954:   set res {0 1}",
          "955:   if {$err} {set res {1 {frame starting offset must be a non-negative number}} }",
          "956:   do_catchsql_test 22.$tn.1 \"",
          "957:     WITH a(x, y) AS ( VALUES(1, 2) )",
          "958:     SELECT sum(x) OVER (",
          "959:       ORDER BY y RANGE BETWEEN $expr PRECEDING AND UNBOUNDED FOLLOWING",
          "960:     ) FROM a",
          "961:   \" $res",
          "963:   set res {0 1}",
          "964:   if {$err} {set res {1 {frame ending offset must be a non-negative number}} }",
          "965:   do_catchsql_test 22.$tn.2 \"",
          "966:     WITH a(x, y) AS ( VALUES(1, 2) )",
          "967:     SELECT sum(x) OVER (",
          "968:       ORDER BY y RANGE BETWEEN UNBOUNDED PRECEDING AND $expr FOLLOWING",
          "969:     ) FROM a",
          "970:   \" $res",
          "971: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "22e6f67c51175cbde19fa108b124f227775bc319",
      "candidate_info": {
        "commit_hash": "22e6f67c51175cbde19fa108b124f227775bc319",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/22e6f67c51175cbde19fa108b124f227775bc319",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbemem.c"
        ],
        "message": "Avoid computing a zero offset of a null pointer, which though this is technically harmless, is upsetting to pedantic run-time checkers.\n\nFossilOrigin-Name: 3ce804e99bbef83d49ec309157448a7c1422725606516cef904e6122aadd3922",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbemem.c||src/vdbemem.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 4066a34da7bcdcece6c438c27f3a11bc49b8c8373b7e1603f30f6225e2bc800a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbemem.c||src/vdbemem.c": [
          "File: src/vdbemem.c -> src/vdbemem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "590:     return pMem->u.i;",
          "591:   }else if( flags & MEM_Real ){",
          "592:     return doubleToInt64(pMem->u.r);",
          "595:     return memIntValue(pMem);",
          "596:   }else{",
          "597:     return 0;",
          "",
          "[Removed Lines]",
          "593:   }else if( flags & (MEM_Str|MEM_Blob) ){",
          "594:     assert( pMem->z || pMem->n==0 );",
          "",
          "[Added Lines]",
          "593:   }else if( (flags & (MEM_Str|MEM_Blob))!=0 && pMem->z!=0 ){",
          "",
          "---------------"
        ]
      }
    }
  ]
}