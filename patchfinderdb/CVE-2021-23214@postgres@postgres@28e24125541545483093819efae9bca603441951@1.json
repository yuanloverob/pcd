{
  "cve_id": "CVE-2021-23214",
  "cve_desc": "When the server is configured to use trust authentication with a clientcert requirement or to use cert authentication, a man-in-the-middle attacker can inject arbitrary SQL queries when a connection is first established, despite the use of SSL certificate verification and encryption.",
  "repo": "postgres/postgres",
  "patch_hash": "28e24125541545483093819efae9bca603441951",
  "patch_info": {
    "commit_hash": "28e24125541545483093819efae9bca603441951",
    "repo": "postgres/postgres",
    "commit_url": "https://github.com/postgres/postgres/commit/28e24125541545483093819efae9bca603441951",
    "files": [
      "src/backend/libpq/pqcomm.c",
      "src/backend/postmaster/postmaster.c",
      "src/include/libpq/libpq.h"
    ],
    "message": "Reject extraneous data after SSL or GSS encryption handshake.\n\nThe server collects up to a bufferload of data whenever it reads data\nfrom the client socket.  When SSL or GSS encryption is requested\nduring startup, any additional data received with the initial\nrequest message remained in the buffer, and would be treated as\nalready-decrypted data once the encryption handshake completed.\nThus, a man-in-the-middle with the ability to inject data into the\nTCP connection could stuff some cleartext data into the start of\na supposedly encryption-protected database session.\n\nThis could be abused to send faked SQL commands to the server,\nalthough that would only work if the server did not demand any\nauthentication data.  (However, a server relying on SSL certificate\nauthentication might well not do so.)\n\nTo fix, throw a protocol-violation error if the internal buffer\nis not empty after the encryption handshake.\n\nOur thanks to Jacob Champion for reporting this problem.\n\nSecurity: CVE-2021-23214",
    "before_after_code_files": [
      "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c",
      "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c",
      "src/include/libpq/libpq.h||src/include/libpq/libpq.h"
    ]
  },
  "patch_diff": {
    "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c": [
      "File: src/backend/libpq/pqcomm.c -> src/backend/libpq/pqcomm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1141:  return 0;",
      "1142: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1150: bool",
      "1151: pq_buffer_has_data(void)",
      "1152: {",
      "1153:  return (PqRecvPointer < PqRecvLength);",
      "1154: }",
      "",
      "---------------"
    ],
    "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c": [
      "File: src/backend/postmaster/postmaster.c -> src/backend/postmaster/postmaster.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2110:    return STATUS_ERROR;",
      "2111: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2119:   if (pq_buffer_has_data())",
      "2120:    ereport(FATAL,",
      "2121:      (errcode(ERRCODE_PROTOCOL_VIOLATION),",
      "2122:       errmsg(\"received unencrypted data after SSL request\"),",
      "2123:       errdetail(\"This could be either a client-software bug or evidence of an attempted man-in-the-middle attack.\")));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2142:    return STATUS_ERROR;",
      "2143: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2163:   if (pq_buffer_has_data())",
      "2164:    ereport(FATAL,",
      "2165:      (errcode(ERRCODE_PROTOCOL_VIOLATION),",
      "2166:       errmsg(\"received unencrypted data after GSSAPI encryption request\"),",
      "2167:       errdetail(\"This could be either a client-software bug or evidence of an attempted man-in-the-middle attack.\")));",
      "",
      "---------------"
    ],
    "src/include/libpq/libpq.h||src/include/libpq/libpq.h": [
      "File: src/include/libpq/libpq.h -> src/include/libpq/libpq.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "79: extern int pq_getbyte(void);",
      "80: extern int pq_peekbyte(void);",
      "81: extern int pq_getbyte_if_available(unsigned char *c);",
      "82: extern int pq_putmessage_v2(char msgtype, const char *s, size_t len);",
      "83: extern bool pq_check_connection(void);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "82: extern bool pq_buffer_has_data(void);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d1bd26740a62b979e9aacb6507593946a402e39c",
      "candidate_info": {
        "commit_hash": "d1bd26740a62b979e9aacb6507593946a402e39c",
        "repo": "postgres/postgres",
        "commit_url": "https://github.com/postgres/postgres/commit/d1bd26740a62b979e9aacb6507593946a402e39c",
        "files": [
          "src/backend/libpq/pqcomm.c",
          "src/backend/postmaster/postmaster.c",
          "src/include/libpq/libpq.h"
        ],
        "message": "Reject extraneous data after SSL or GSS encryption handshake.\n\nThe server collects up to a bufferload of data whenever it reads data\nfrom the client socket.  When SSL or GSS encryption is requested\nduring startup, any additional data received with the initial\nrequest message remained in the buffer, and would be treated as\nalready-decrypted data once the encryption handshake completed.\nThus, a man-in-the-middle with the ability to inject data into the\nTCP connection could stuff some cleartext data into the start of\na supposedly encryption-protected database session.\n\nThis could be abused to send faked SQL commands to the server,\nalthough that would only work if the server did not demand any\nauthentication data.  (However, a server relying on SSL certificate\nauthentication might well not do so.)\n\nTo fix, throw a protocol-violation error if the internal buffer\nis not empty after the encryption handshake.\n\nOur thanks to Jacob Champion for reporting this problem.\n\nSecurity: CVE-2021-23214",
        "before_after_code_files": [
          "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c",
          "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c",
          "src/include/libpq/libpq.h||src/include/libpq/libpq.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c",
            "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c",
            "src/include/libpq/libpq.h||src/include/libpq/libpq.h"
          ],
          "candidate": [
            "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c",
            "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c",
            "src/include/libpq/libpq.h||src/include/libpq/libpq.h"
          ]
        }
      },
      "candidate_diff": {
        "src/backend/libpq/pqcomm.c||src/backend/libpq/pqcomm.c": [
          "File: src/backend/libpq/pqcomm.c -> src/backend/libpq/pqcomm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1197:  }",
          "1198: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1206: bool",
          "1207: pq_buffer_has_data(void)",
          "1208: {",
          "1209:  return (PqRecvPointer < PqRecvLength);",
          "1210: }",
          "",
          "---------------"
        ],
        "src/backend/postmaster/postmaster.c||src/backend/postmaster/postmaster.c": [
          "File: src/backend/postmaster/postmaster.c -> src/backend/postmaster/postmaster.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2034:   if (SSLok == 'S' && secure_open_server(port) == -1)",
          "2035:    return STATUS_ERROR;",
          "2036: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2044:   if (pq_buffer_has_data())",
          "2045:    ereport(FATAL,",
          "2046:      (errcode(ERRCODE_PROTOCOL_VIOLATION),",
          "2047:       errmsg(\"received unencrypted data after SSL request\"),",
          "2048:       errdetail(\"This could be either a client-software bug or evidence of an attempted man-in-the-middle attack.\")));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2065:   if (GSSok == 'G' && secure_open_gssapi(port) == -1)",
          "2066:    return STATUS_ERROR;",
          "2067: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2088:   if (pq_buffer_has_data())",
          "2089:    ereport(FATAL,",
          "2090:      (errcode(ERRCODE_PROTOCOL_VIOLATION),",
          "2091:       errmsg(\"received unencrypted data after GSSAPI encryption request\"),",
          "2092:       errdetail(\"This could be either a client-software bug or evidence of an attempted man-in-the-middle attack.\")));",
          "",
          "---------------"
        ],
        "src/include/libpq/libpq.h||src/include/libpq/libpq.h": [
          "File: src/include/libpq/libpq.h -> src/include/libpq/libpq.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "72: extern int pq_getbyte(void);",
          "73: extern int pq_peekbyte(void);",
          "74: extern int pq_getbyte_if_available(unsigned char *c);",
          "75: extern int pq_putbytes(const char *s, size_t len);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75: extern bool pq_buffer_has_data(void);",
          "",
          "---------------"
        ]
      }
    }
  ]
}