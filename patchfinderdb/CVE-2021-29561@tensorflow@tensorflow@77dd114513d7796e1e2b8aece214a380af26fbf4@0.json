{
  "cve_id": "CVE-2021-29561",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can cause a denial of service by exploiting a `CHECK`-failure coming from `tf.raw_ops.LoadAndRemapMatrix`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/d94227d43aa125ad8b54115c03cece54f6a1977b/tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc#L219-L222) assumes that the `ckpt_path` is always a valid scalar. However, an attacker can send any other tensor as the first argument of `LoadAndRemapMatrix`. This would cause the rank `CHECK` in `scalar<T>()()` to trigger and terminate the process. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "77dd114513d7796e1e2b8aece214a380af26fbf4",
  "patch_info": {
    "commit_hash": "77dd114513d7796e1e2b8aece214a380af26fbf4",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/77dd114513d7796e1e2b8aece214a380af26fbf4",
    "files": [
      "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
    ],
    "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
    "before_after_code_files": [
      "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
      "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "124:     const Tensor* ckpt_path_t;",
      "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
      "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
      "127:     const Tensor* old_tensor_name_t;",
      "128:     OP_REQUIRES_OK(context,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "126:     OP_REQUIRES(",
      "127:         context, ckpt_path_t->NumElements() == 1,",
      "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
      "129:                                 \"element, got tensor of shape \",",
      "130:                                 ckpt_path_t->shape().DebugString()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8849f473e567aae07c38f89e69c51823258d5c98",
      "candidate_info": {
        "commit_hash": "8849f473e567aae07c38f89e69c51823258d5c98",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8849f473e567aae07c38f89e69c51823258d5c98",
        "files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ],
        "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
        "before_after_code_files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
          "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     const Tensor* ckpt_path_t;",
          "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
          "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
          "127:     const Tensor* old_tensor_name_t;",
          "128:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     OP_REQUIRES(",
          "127:         context, ckpt_path_t->NumElements() == 1,",
          "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
          "129:                                 \"element, got tensor of shape \",",
          "130:                                 ckpt_path_t->shape().DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "06deb49868e34da7f26c7d0364db68c9e051ad5c",
      "candidate_info": {
        "commit_hash": "06deb49868e34da7f26c7d0364db68c9e051ad5c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/06deb49868e34da7f26c7d0364db68c9e051ad5c",
        "files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ],
        "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
        "before_after_code_files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
          "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     const Tensor* ckpt_path_t;",
          "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
          "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
          "127:     const Tensor* old_tensor_name_t;",
          "128:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     OP_REQUIRES(",
          "127:         context, ckpt_path_t->NumElements() == 1,",
          "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
          "129:                                 \"element, got tensor of shape \",",
          "130:                                 ckpt_path_t->shape().DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ecb3ae3c09f3b17620f574acf0e179a6d2ef4579",
      "candidate_info": {
        "commit_hash": "ecb3ae3c09f3b17620f574acf0e179a6d2ef4579",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ecb3ae3c09f3b17620f574acf0e179a6d2ef4579",
        "files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ],
        "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
        "before_after_code_files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
          "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     const Tensor* ckpt_path_t;",
          "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
          "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
          "127:     const Tensor* old_tensor_name_t;",
          "128:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     OP_REQUIRES(",
          "127:         context, ckpt_path_t->NumElements() == 1,",
          "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
          "129:                                 \"element, got tensor of shape \",",
          "130:                                 ckpt_path_t->shape().DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "db29e8f0457a9aca36808e2b10dfc7b79e4a2872",
      "candidate_info": {
        "commit_hash": "db29e8f0457a9aca36808e2b10dfc7b79e4a2872",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/db29e8f0457a9aca36808e2b10dfc7b79e4a2872",
        "files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ],
        "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
        "before_after_code_files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
          "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     const Tensor* ckpt_path_t;",
          "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
          "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
          "127:     const Tensor* old_tensor_name_t;",
          "128:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     OP_REQUIRES(",
          "127:         context, ckpt_path_t->NumElements() == 1,",
          "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
          "129:                                 \"element, got tensor of shape \",",
          "130:                                 ckpt_path_t->shape().DebugString()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "46d534ac9380e18ecb8c4ec41bab9e2cc3fe85c1",
      "candidate_info": {
        "commit_hash": "46d534ac9380e18ecb8c4ec41bab9e2cc3fe85c1",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/46d534ac9380e18ecb8c4ec41bab9e2cc3fe85c1",
        "files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ],
        "message": "Fix a check fail\n\nPiperOrigin-RevId: 372011072\nChange-Id: I1062cfaed0aa16884e9a16312483794d188db76f",
        "before_after_code_files": [
          "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/load_and_remap_matrix_op.cc||tensorflow/core/kernels/load_and_remap_matrix_op.cc": [
          "File: tensorflow/core/kernels/load_and_remap_matrix_op.cc -> tensorflow/core/kernels/load_and_remap_matrix_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     const Tensor* ckpt_path_t;",
          "125:     OP_REQUIRES_OK(context, context->input(\"ckpt_path\", &ckpt_path_t));",
          "126:     const string& ckpt_path = ckpt_path_t->scalar<tstring>()();",
          "127:     const Tensor* old_tensor_name_t;",
          "128:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     OP_REQUIRES(",
          "127:         context, ckpt_path_t->NumElements() == 1,",
          "128:         errors::InvalidArgument(\"The `ckpt_path` tensor must have exactly one \"",
          "129:                                 \"element, got tensor of shape \",",
          "130:                                 ckpt_path_t->shape().DebugString()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}