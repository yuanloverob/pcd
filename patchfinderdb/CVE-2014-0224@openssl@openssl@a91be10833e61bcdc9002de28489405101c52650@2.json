{
  "cve_id": "CVE-2014-0224",
  "cve_desc": "OpenSSL before 0.9.8za, 1.0.0 before 1.0.0m, and 1.0.1 before 1.0.1h does not properly restrict processing of ChangeCipherSpec messages, which allows man-in-the-middle attackers to trigger use of a zero-length master key in certain OpenSSL-to-OpenSSL communications, and consequently hijack sessions or obtain sensitive information, via a crafted TLS handshake, aka the \"CCS Injection\" vulnerability.",
  "repo": "openssl/openssl",
  "patch_hash": "a91be10833e61bcdc9002de28489405101c52650",
  "patch_info": {
    "commit_hash": "a91be10833e61bcdc9002de28489405101c52650",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/a91be10833e61bcdc9002de28489405101c52650",
    "files": [
      "ssl/s3_clnt.c",
      "ssl/s3_pkt.c",
      "ssl/s3_srvr.c",
      "ssl/ssl3.h"
    ],
    "message": "Fix for CVE-2014-0224\n\nOnly accept change cipher spec when it is expected instead of at any\ntime. This prevents premature setting of session keys before the master\nsecret is determined which an attacker could use as a MITM attack.\n\nThanks to KIKUCHI Masashi (Lepidum Co. Ltd.) for reporting this issue\nand providing the initial fix this patch is based on.\n(cherry picked from commit bc8923b1ec9c467755cd86f7848c50ee8812e441)",
    "before_after_code_files": [
      "ssl/s3_clnt.c||ssl/s3_clnt.c",
      "ssl/s3_pkt.c||ssl/s3_pkt.c",
      "ssl/s3_srvr.c||ssl/s3_srvr.c",
      "ssl/ssl3.h||ssl/ssl3.h"
    ]
  },
  "patch_diff": {
    "ssl/s3_clnt.c||ssl/s3_clnt.c": [
      "File: ssl/s3_clnt.c -> ssl/s3_clnt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "599:   case SSL3_ST_CR_FINISHED_A:",
      "600:   case SSL3_ST_CR_FINISHED_B:",
      "602:    ret=ssl3_get_finished(s,SSL3_ST_CR_FINISHED_A,",
      "603:     SSL3_ST_CR_FINISHED_B);",
      "604:    if (ret <= 0) goto end;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "602:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1051:   SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_ATTEMPT_TO_REUSE_SESSION_IN_DIFFERENT_CONTEXT);",
      "1052:   goto f_err;",
      "1053:   }",
      "1054:      s->hit=1;",
      "1055:      }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1055:      s->s3->flags |= SSL3_FLAGS_CCS_OK;",
      "",
      "---------------"
    ],
    "ssl/s3_pkt.c||ssl/s3_pkt.c": [
      "File: ssl/s3_pkt.c -> ssl/s3_pkt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1593:    goto f_err;",
      "1594:    }",
      "1596:   rr->length=0;",
      "1598:   if (s->msg_callback)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1596:   if (!(s->s3->flags & SSL3_FLAGS_CCS_OK))",
      "1597:    {",
      "1598:    al=SSL_AD_UNEXPECTED_MESSAGE;",
      "1599:    SSLerr(SSL_F_SSL3_READ_BYTES,SSL_R_CCS_RECEIVED_EARLY);",
      "1600:    goto f_err;",
      "1601:    }",
      "1603:   s->s3->flags &= ~SSL3_FLAGS_CCS_OK;",
      "",
      "---------------"
    ],
    "ssl/s3_srvr.c||ssl/s3_srvr.c": [
      "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "708:   case SSL3_ST_SR_CERT_VRFY_A:",
      "709:   case SSL3_ST_SR_CERT_VRFY_B:",
      "712:    ret=ssl3_get_cert_verify(s);",
      "713:    if (ret <= 0) goto end;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "711:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "736:   case SSL3_ST_SR_FINISHED_A:",
      "737:   case SSL3_ST_SR_FINISHED_B:",
      "738:    ret=ssl3_get_finished(s,SSL3_ST_SR_FINISHED_A,",
      "739:     SSL3_ST_SR_FINISHED_B);",
      "740:    if (ret <= 0) goto end;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "739:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "805:     s->s3->tmp.next_state=SSL3_ST_SR_FINISHED_A;",
      "806: #else",
      "807:     if (s->s3->next_proto_neg_seen)",
      "808:      s->s3->tmp.next_state=SSL3_ST_SR_NEXT_PROTO_A;",
      "809:     else",
      "810:      s->s3->tmp.next_state=SSL3_ST_SR_FINISHED_A;",
      "811: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "810:      {",
      "811:      s->s3->flags |= SSL3_FLAGS_CCS_OK;",
      "813:      }",
      "",
      "---------------"
    ],
    "ssl/ssl3.h||ssl/ssl3.h": [
      "File: ssl/ssl3.h -> ssl/ssl3.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "428: #define TLS1_FLAGS_TLS_PADDING_BUG  0x0008",
      "429: #define TLS1_FLAGS_SKIP_CERT_VERIFY  0x0010",
      "430: #define TLS1_FLAGS_KEEP_HANDSHAKE  0x0020",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "431: #define SSL3_FLAGS_CCS_OK   0x0080",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "410a49a4fa1d2a1a9775ee29f9e40cbbda79c149",
      "candidate_info": {
        "commit_hash": "410a49a4fa1d2a1a9775ee29f9e40cbbda79c149",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/410a49a4fa1d2a1a9775ee29f9e40cbbda79c149",
        "files": [
          "ssl/s3_clnt.c",
          "ssl/s3_pkt.c",
          "ssl/s3_srvr.c",
          "ssl/ssl3.h"
        ],
        "message": "Fix for CVE-2014-0224\n\nOnly accept change cipher spec when it is expected instead of at any\ntime. This prevents premature setting of session keys before the master\nsecret is determined which an attacker could use as a MITM attack.\n\nThanks to KIKUCHI Masashi (Lepidum Co. Ltd.) for reporting this issue\nand providing the initial fix this patch is based on.",
        "before_after_code_files": [
          "ssl/s3_clnt.c||ssl/s3_clnt.c",
          "ssl/s3_pkt.c||ssl/s3_pkt.c",
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/ssl3.h||ssl/ssl3.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_clnt.c||ssl/s3_clnt.c",
            "ssl/s3_pkt.c||ssl/s3_pkt.c",
            "ssl/s3_srvr.c||ssl/s3_srvr.c",
            "ssl/ssl3.h||ssl/ssl3.h"
          ],
          "candidate": [
            "ssl/s3_clnt.c||ssl/s3_clnt.c",
            "ssl/s3_pkt.c||ssl/s3_pkt.c",
            "ssl/s3_srvr.c||ssl/s3_srvr.c",
            "ssl/ssl3.h||ssl/ssl3.h"
          ]
        }
      },
      "candidate_diff": {
        "ssl/s3_clnt.c||ssl/s3_clnt.c": [
          "File: ssl/s3_clnt.c -> ssl/s3_clnt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "491:   case SSL3_ST_CR_FINISHED_A:",
          "492:   case SSL3_ST_CR_FINISHED_B:",
          "494:    ret=ssl3_get_finished(s,SSL3_ST_CR_FINISHED_A,",
          "495:     SSL3_ST_CR_FINISHED_B);",
          "496:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "494:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "777:   SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_ATTEMPT_TO_REUSE_SESSION_IN_DIFFERENT_CONTEXT);",
          "778:   goto f_err;",
          "779:   }",
          "780:      s->hit=1;",
          "781:      }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "781:      s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/s3_pkt.c||ssl/s3_pkt.c": [
          "File: ssl/s3_pkt.c -> ssl/s3_pkt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1166:    goto f_err;",
          "1167:    }",
          "1169:   rr->length=0;",
          "1171:   if (s->msg_callback)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1169:   if (!(s->s3->flags & SSL3_FLAGS_CCS_OK))",
          "1170:    {",
          "1171:    al=SSL_AD_UNEXPECTED_MESSAGE;",
          "1172:    SSLerr(SSL_F_SSL3_READ_BYTES,SSL_R_CCS_RECEIVED_EARLY);",
          "1173:    goto f_err;",
          "1174:    }",
          "1176:   s->s3->flags &= ~SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "523:   case SSL3_ST_SR_CERT_VRFY_A:",
          "524:   case SSL3_ST_SR_CERT_VRFY_B:",
          "527:    ret=ssl3_get_cert_verify(s);",
          "528:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "526:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "534:   case SSL3_ST_SR_FINISHED_A:",
          "535:   case SSL3_ST_SR_FINISHED_B:",
          "536:    ret=ssl3_get_finished(s,SSL3_ST_SR_FINISHED_A,",
          "537:     SSL3_ST_SR_FINISHED_B);",
          "538:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "537:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/ssl3.h||ssl/ssl3.h": [
          "File: ssl/ssl3.h -> ssl/ssl3.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "333: #define SSL3_FLAGS_DELAY_CLIENT_FINISHED 0x0002",
          "334: #define SSL3_FLAGS_POP_BUFFER   0x0004",
          "335: #define TLS1_FLAGS_TLS_PADDING_BUG  0x0008",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "336: #define SSL3_FLAGS_CCS_OK   0x0080",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c97e457d53441c6cb377cdda08905203db8afa0f",
      "candidate_info": {
        "commit_hash": "c97e457d53441c6cb377cdda08905203db8afa0f",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/c97e457d53441c6cb377cdda08905203db8afa0f",
        "files": [
          "ssl/s3_clnt.c",
          "ssl/s3_pkt.c",
          "ssl/s3_srvr.c",
          "ssl/ssl3.h"
        ],
        "message": "Fix for CVE-2014-0224\n\nOnly accept change cipher spec when it is expected instead of at any\ntime. This prevents premature setting of session keys before the master\nsecret is determined which an attacker could use as a MITM attack.\n\nThanks to KIKUCHI Masashi (Lepidum Co. Ltd.) for reporting this issue\nand providing the initial fix this patch is based on.",
        "before_after_code_files": [
          "ssl/s3_clnt.c||ssl/s3_clnt.c",
          "ssl/s3_pkt.c||ssl/s3_pkt.c",
          "ssl/s3_srvr.c||ssl/s3_srvr.c",
          "ssl/ssl3.h||ssl/ssl3.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ssl/s3_clnt.c||ssl/s3_clnt.c",
            "ssl/s3_pkt.c||ssl/s3_pkt.c",
            "ssl/s3_srvr.c||ssl/s3_srvr.c",
            "ssl/ssl3.h||ssl/ssl3.h"
          ],
          "candidate": [
            "ssl/s3_clnt.c||ssl/s3_clnt.c",
            "ssl/s3_pkt.c||ssl/s3_pkt.c",
            "ssl/s3_srvr.c||ssl/s3_srvr.c",
            "ssl/ssl3.h||ssl/ssl3.h"
          ]
        }
      },
      "candidate_diff": {
        "ssl/s3_clnt.c||ssl/s3_clnt.c": [
          "File: ssl/s3_clnt.c -> ssl/s3_clnt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "516:   case SSL3_ST_CR_FINISHED_A:",
          "517:   case SSL3_ST_CR_FINISHED_B:",
          "519:    ret=ssl3_get_finished(s,SSL3_ST_CR_FINISHED_A,",
          "520:     SSL3_ST_CR_FINISHED_B);",
          "521:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "519:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "829:   SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_ATTEMPT_TO_REUSE_SESSION_IN_DIFFERENT_CONTEXT);",
          "830:   goto f_err;",
          "831:   }",
          "832:      s->hit=1;",
          "833:      }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "833:      s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/s3_pkt.c||ssl/s3_pkt.c": [
          "File: ssl/s3_pkt.c -> ssl/s3_pkt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1258:    goto f_err;",
          "1259:    }",
          "1261:   rr->length=0;",
          "1263:   if (s->msg_callback)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1261:   if (!(s->s3->flags & SSL3_FLAGS_CCS_OK))",
          "1262:    {",
          "1263:    al=SSL_AD_UNEXPECTED_MESSAGE;",
          "1264:    SSLerr(SSL_F_SSL3_READ_BYTES,SSL_R_CCS_RECEIVED_EARLY);",
          "1265:    goto f_err;",
          "1266:    }",
          "1268:   s->s3->flags &= ~SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/s3_srvr.c||ssl/s3_srvr.c": [
          "File: ssl/s3_srvr.c -> ssl/s3_srvr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "578:   case SSL3_ST_SR_CERT_VRFY_A:",
          "579:   case SSL3_ST_SR_CERT_VRFY_B:",
          "582:    ret=ssl3_get_cert_verify(s);",
          "583:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "581:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "589:   case SSL3_ST_SR_FINISHED_A:",
          "590:   case SSL3_ST_SR_FINISHED_B:",
          "591:    ret=ssl3_get_finished(s,SSL3_ST_SR_FINISHED_A,",
          "592:     SSL3_ST_SR_FINISHED_B);",
          "593:    if (ret <= 0) goto end;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "592:    s->s3->flags |= SSL3_FLAGS_CCS_OK;",
          "",
          "---------------"
        ],
        "ssl/ssl3.h||ssl/ssl3.h": [
          "File: ssl/ssl3.h -> ssl/ssl3.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "379: #define SSL3_FLAGS_POP_BUFFER   0x0004",
          "380: #define TLS1_FLAGS_TLS_PADDING_BUG  0x0008",
          "381: #define TLS1_FLAGS_SKIP_CERT_VERIFY  0x0010",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "382: #define SSL3_FLAGS_CCS_OK   0x0080",
          "",
          "---------------"
        ]
      }
    }
  ]
}