{
  "cve_id": "CVE-2016-7417",
  "cve_desc": "ext/spl/spl_array.c in PHP before 5.6.26 and 7.x before 7.0.11 proceeds with SplArray unserialization without validating a return value and data type, which allows remote attackers to cause a denial of service or possibly have unspecified other impact via crafted serialized data.",
  "repo": "php/php-src",
  "patch_hash": "ecb7f58a069be0dec4a6131b6351a761f808f22e",
  "patch_info": {
    "commit_hash": "ecb7f58a069be0dec4a6131b6351a761f808f22e",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/ecb7f58a069be0dec4a6131b6351a761f808f22e",
    "files": [
      "ext/spl/spl_array.c",
      "ext/spl/tests/bug73029.phpt"
    ],
    "message": "Fix bug #73029 - Missing type check when unserializing SplArray",
    "before_after_code_files": [
      "ext/spl/spl_array.c||ext/spl/spl_array.c",
      "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
    ]
  },
  "patch_diff": {
    "ext/spl/spl_array.c||ext/spl/spl_array.c": [
      "File: ext/spl/spl_array.c -> ext/spl/spl_array.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "308:  long index;",
      "309:  HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);",
      "312:   return &EG(uninitialized_zval_ptr);",
      "313:  }",
      "",
      "[Removed Lines]",
      "311:  if (!offset) {",
      "",
      "[Added Lines]",
      "311:  if (!offset || !ht) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "626:   HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);",
      "628:   switch(Z_TYPE_P(offset)) {",
      "630:     if (zend_symtable_find(ht, Z_STRVAL_P(offset), Z_STRLEN_P(offset)+1, (void **) &tmp) != FAILURE) {",
      "631:      if (check_empty == 2) {",
      "632:       return 1;",
      "",
      "[Removed Lines]",
      "629:    case IS_STRING:",
      "",
      "[Added Lines]",
      "629:    case IS_STRING:",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "639:    case IS_DOUBLE:",
      "640:    case IS_RESOURCE:",
      "642:    case IS_LONG:",
      "643:     if (offset->type == IS_DOUBLE) {",
      "644:      index = (long)Z_DVAL_P(offset);",
      "",
      "[Removed Lines]",
      "641:    case IS_BOOL:",
      "",
      "[Added Lines]",
      "641:    case IS_BOOL:",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1810:   intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;",
      "1811:   zval_ptr_dtor(&intern->array);",
      "1812:   ALLOC_INIT_ZVAL(intern->array);",
      "1814:    goto outexcept;",
      "1815:   }",
      "1816:   var_push_dtor(&var_hash, &intern->array);",
      "",
      "[Removed Lines]",
      "1813:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash TSRMLS_CC)) {",
      "",
      "[Added Lines]",
      "1813:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash TSRMLS_CC)",
      "1814:     || (Z_TYPE_P(intern->array) != IS_ARRAY && Z_TYPE_P(intern->array) != IS_OBJECT)) {",
      "1815:    zval_ptr_dtor(&intern->array);",
      "",
      "---------------"
    ],
    "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt": [
      "File: ext/spl/tests/bug73029.phpt -> ext/spl/tests/bug73029.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #73029: Missing type check when unserializing SplArray",
      "3: --FILE--",
      "4: <?php",
      "5: try {",
      "6: $a = 'C:11:\"ArrayObject\":19:0x:i:0;r:2;;m:a:0:{}}';",
      "7: $m = unserialize($a);",
      "8: $x = $m[2];",
      "9: } catch(UnexpectedValueException $e) {",
      "10:  print $e->getMessage() . \"\\n\";",
      "11: }",
      "12: ?>",
      "13: DONE",
      "14: --EXPECTF--",
      "15: Error at offset 10 of 19 bytes",
      "16: DONE",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "022e75cba104c52ccfb494ce224c2c4d0ff2dddc",
      "candidate_info": {
        "commit_hash": "022e75cba104c52ccfb494ce224c2c4d0ff2dddc",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/022e75cba104c52ccfb494ce224c2c4d0ff2dddc",
        "files": [
          "ext/spl/spl_array.c",
          "ext/spl/tests/bug73029.phpt"
        ],
        "message": "Fix bug #73029 - Missing type check when unserializing SplArray\n\n(cherry picked from commit 6d16288150be33392a3249e417a0929881feb9a2)\n\nConflicts:\n\text/spl/spl_array.c",
        "before_after_code_files": [
          "ext/spl/spl_array.c||ext/spl/spl_array.c",
          "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c",
            "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
          ],
          "candidate": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c",
            "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/spl_array.c||ext/spl/spl_array.c": [
          "File: ext/spl/spl_array.c -> ext/spl/spl_array.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "295:  zend_string *offset_key;",
          "296:  HashTable *ht = spl_array_get_hash_table(intern);",
          "299:   return &EG(uninitialized_zval);",
          "300:  }",
          "",
          "[Removed Lines]",
          "298:  if (!offset || Z_ISUNDEF_P(offset)) {",
          "",
          "[Added Lines]",
          "298:  if (!offset || Z_ISUNDEF_P(offset) || !ht) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1796:   intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;",
          "1797:   zval_ptr_dtor(&intern->array);",
          "1798:   ZVAL_UNDEF(&intern->array);",
          "1800:    goto outexcept;",
          "1801:   }",
          "1802:   var_push_dtor(&var_hash, &intern->array);",
          "",
          "[Removed Lines]",
          "1799:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash)) {",
          "",
          "[Added Lines]",
          "1799:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash)",
          "1800:     || (Z_TYPE(intern->array) != IS_ARRAY && Z_TYPE(intern->array) != IS_OBJECT)) {",
          "",
          "---------------"
        ],
        "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt": [
          "File: ext/spl/tests/bug73029.phpt -> ext/spl/tests/bug73029.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #73029: Missing type check when unserializing SplArray",
          "3: --FILE--",
          "4: <?php",
          "5: try {",
          "6: $a = 'C:11:\"ArrayObject\":19:0x:i:0;r:2;;m:a:0:{}}';",
          "7: $m = unserialize($a);",
          "8: $x = $m[2];",
          "9: } catch(UnexpectedValueException $e) {",
          "10:  print $e->getMessage() . \"\\n\";",
          "11: }",
          "12: ?>",
          "13: DONE",
          "14: --EXPECTF--",
          "15: Error at offset 10 of 19 bytes",
          "16: DONE",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "589cfc7d0ebbc2399b6cbac3351ae26d569e9600",
      "candidate_info": {
        "commit_hash": "589cfc7d0ebbc2399b6cbac3351ae26d569e9600",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/589cfc7d0ebbc2399b6cbac3351ae26d569e9600",
        "files": [
          "ext/spl/spl_array.c",
          "ext/spl/tests/bug73029.phpt"
        ],
        "message": "Fix bug #73029 - Missing type check when unserializing SplArray",
        "before_after_code_files": [
          "ext/spl/spl_array.c||ext/spl/spl_array.c",
          "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c",
            "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
          ],
          "candidate": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c",
            "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/spl_array.c||ext/spl/spl_array.c": [
          "File: ext/spl/spl_array.c -> ext/spl/spl_array.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "308:  long index;",
          "309:  HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);",
          "312:   return &EG(uninitialized_zval_ptr);",
          "313:  }",
          "",
          "[Removed Lines]",
          "311:  if (!offset) {",
          "",
          "[Added Lines]",
          "311:  if (!offset || !ht) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "626:   HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);",
          "628:   switch(Z_TYPE_P(offset)) {",
          "630:     if (zend_symtable_find(ht, Z_STRVAL_P(offset), Z_STRLEN_P(offset)+1, (void **) &tmp) != FAILURE) {",
          "631:      if (check_empty == 2) {",
          "632:       return 1;",
          "",
          "[Removed Lines]",
          "629:    case IS_STRING:",
          "",
          "[Added Lines]",
          "629:    case IS_STRING:",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "639:    case IS_DOUBLE:",
          "640:    case IS_RESOURCE:",
          "642:    case IS_LONG:",
          "643:     if (offset->type == IS_DOUBLE) {",
          "644:      index = (long)Z_DVAL_P(offset);",
          "",
          "[Removed Lines]",
          "641:    case IS_BOOL:",
          "",
          "[Added Lines]",
          "641:    case IS_BOOL:",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1810:   intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;",
          "1811:   zval_ptr_dtor(&intern->array);",
          "1812:   ALLOC_INIT_ZVAL(intern->array);",
          "1814:    goto outexcept;",
          "1815:   }",
          "1816:   var_push_dtor(&var_hash, &intern->array);",
          "",
          "[Removed Lines]",
          "1813:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash TSRMLS_CC)) {",
          "",
          "[Added Lines]",
          "1813:   if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash TSRMLS_CC)",
          "1814:     || (Z_TYPE_P(intern->array) != IS_ARRAY && Z_TYPE_P(intern->array) != IS_OBJECT)) {",
          "1815:    zval_ptr_dtor(&intern->array);",
          "",
          "---------------"
        ],
        "ext/spl/tests/bug73029.phpt||ext/spl/tests/bug73029.phpt": [
          "File: ext/spl/tests/bug73029.phpt -> ext/spl/tests/bug73029.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #73029: Missing type check when unserializing SplArray",
          "3: --FILE--",
          "4: <?php",
          "5: try {",
          "6: $a = 'C:11:\"ArrayObject\":19:0x:i:0;r:2;;m:a:0:{}}';",
          "7: $m = unserialize($a);",
          "8: $x = $m[2];",
          "9: } catch(UnexpectedValueException $e) {",
          "10:  print $e->getMessage() . \"\\n\";",
          "11: }",
          "12: ?>",
          "13: DONE",
          "14: --EXPECTF--",
          "15: Error at offset 10 of 19 bytes",
          "16: DONE",
          "",
          "---------------"
        ]
      }
    }
  ]
}