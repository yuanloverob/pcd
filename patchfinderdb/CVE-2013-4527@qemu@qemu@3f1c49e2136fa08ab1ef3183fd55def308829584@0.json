{
  "cve_id": "CVE-2013-4527",
  "cve_desc": "Buffer overflow in hw/timer/hpet.c in QEMU before 1.7.2 might allow remote attackers to execute arbitrary code via vectors related to the number of timers.",
  "repo": "qemu/qemu",
  "patch_hash": "3f1c49e2136fa08ab1ef3183fd55def308829584",
  "patch_info": {
    "commit_hash": "3f1c49e2136fa08ab1ef3183fd55def308829584",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/3f1c49e2136fa08ab1ef3183fd55def308829584",
    "files": [
      "hw/timer/hpet.c"
    ],
    "message": "hpet: fix buffer overrun on invalid state load\n\nCVE-2013-4527 hw/timer/hpet.c buffer overrun\n\nhpet is a VARRAY with a uint8 size but static array of 32\n\nTo fix, make sure num_timers is valid using VMSTATE_VALID hook.\n\nReported-by: Anthony Liguori <anthony@codemonkey.ws>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
    "before_after_code_files": [
      "hw/timer/hpet.c||hw/timer/hpet.c"
    ]
  },
  "patch_diff": {
    "hw/timer/hpet.c||hw/timer/hpet.c": [
      "File: hw/timer/hpet.c -> hw/timer/hpet.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "239:     return 0;",
      "240: }",
      "242: static int hpet_post_load(void *opaque, int version_id)",
      "243: {",
      "244:     HPETState *s = opaque;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "242: static bool hpet_validate_num_timers(void *opaque, int version_id)",
      "243: {",
      "244:     HPETState *s = opaque;",
      "246:     if (s->num_timers < HPET_MIN_TIMERS) {",
      "247:         return false;",
      "248:     } else if (s->num_timers > HPET_MAX_TIMERS) {",
      "249:         return false;",
      "250:     }",
      "251:     return true;",
      "252: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "307:         VMSTATE_UINT64(isr, HPETState),",
      "308:         VMSTATE_UINT64(hpet_counter, HPETState),",
      "309:         VMSTATE_UINT8_V(num_timers, HPETState, 2),",
      "310:         VMSTATE_STRUCT_VARRAY_UINT8(timer, HPETState, num_timers, 0,",
      "311:                                     vmstate_hpet_timer, HPETTimer),",
      "312:         VMSTATE_END_OF_LIST()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "322:         VMSTATE_VALIDATE(\"num_timers in range\", hpet_validate_num_timers),",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d8aba740f274514bdda2a240f8b881f8d928f5cd",
      "candidate_info": {
        "commit_hash": "d8aba740f274514bdda2a240f8b881f8d928f5cd",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/d8aba740f274514bdda2a240f8b881f8d928f5cd",
        "files": [
          "hw/timer/hpet.c"
        ],
        "message": "hpet: fix buffer overrun on invalid state load\n\nCVE-2013-4527 hw/timer/hpet.c buffer overrun\n\nhpet is a VARRAY with a uint8 size but static array of 32\n\nTo fix, make sure num_timers is valid using VMSTATE_VALID hook.\n\nReported-by: Anthony Liguori <anthony@codemonkey.ws>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 3f1c49e2136fa08ab1ef3183fd55def308829584)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/timer/hpet.c||hw/timer/hpet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/timer/hpet.c||hw/timer/hpet.c"
          ],
          "candidate": [
            "hw/timer/hpet.c||hw/timer/hpet.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/timer/hpet.c||hw/timer/hpet.c": [
          "File: hw/timer/hpet.c -> hw/timer/hpet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "227:     return 0;",
          "228: }",
          "230: static int hpet_post_load(void *opaque, int version_id)",
          "231: {",
          "232:     HPETState *s = opaque;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "230: static bool hpet_validate_num_timers(void *opaque, int version_id)",
          "231: {",
          "232:     HPETState *s = opaque;",
          "234:     if (s->num_timers < HPET_MIN_TIMERS) {",
          "235:         return false;",
          "236:     } else if (s->num_timers > HPET_MAX_TIMERS) {",
          "237:         return false;",
          "238:     }",
          "239:     return true;",
          "240: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "295:         VMSTATE_UINT64(isr, HPETState),",
          "296:         VMSTATE_UINT64(hpet_counter, HPETState),",
          "297:         VMSTATE_UINT8_V(num_timers, HPETState, 2),",
          "298:         VMSTATE_STRUCT_VARRAY_UINT8(timer, HPETState, num_timers, 0,",
          "299:                                     vmstate_hpet_timer, HPETTimer),",
          "300:         VMSTATE_END_OF_LIST()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "310:         VMSTATE_VALIDATE(\"num_timers in range\", hpet_validate_num_timers),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3c6066172ff591512e015ac933e056f6cc069527",
      "candidate_info": {
        "commit_hash": "3c6066172ff591512e015ac933e056f6cc069527",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/3c6066172ff591512e015ac933e056f6cc069527",
        "files": [
          "hw/timer/hpet.c"
        ],
        "message": "hpet: fix buffer overrun on invalid state load\n\nCVE-2013-4527 hw/timer/hpet.c buffer overrun\n\nhpet is a VARRAY with a uint8 size but static array of 32\n\nTo fix, make sure num_timers is valid using VMSTATE_VALID hook.\n\nReported-by: Anthony Liguori <anthony@codemonkey.ws>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 3f1c49e2136fa08ab1ef3183fd55def308829584)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/timer/hpet.c||hw/timer/hpet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/timer/hpet.c||hw/timer/hpet.c"
          ],
          "candidate": [
            "hw/timer/hpet.c||hw/timer/hpet.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/timer/hpet.c||hw/timer/hpet.c": [
          "File: hw/timer/hpet.c -> hw/timer/hpet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "239:     return 0;",
          "240: }",
          "242: static int hpet_post_load(void *opaque, int version_id)",
          "243: {",
          "244:     HPETState *s = opaque;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "242: static bool hpet_validate_num_timers(void *opaque, int version_id)",
          "243: {",
          "244:     HPETState *s = opaque;",
          "246:     if (s->num_timers < HPET_MIN_TIMERS) {",
          "247:         return false;",
          "248:     } else if (s->num_timers > HPET_MAX_TIMERS) {",
          "249:         return false;",
          "250:     }",
          "251:     return true;",
          "252: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "307:         VMSTATE_UINT64(isr, HPETState),",
          "308:         VMSTATE_UINT64(hpet_counter, HPETState),",
          "309:         VMSTATE_UINT8_V(num_timers, HPETState, 2),",
          "310:         VMSTATE_STRUCT_VARRAY_UINT8(timer, HPETState, num_timers, 0,",
          "311:                                     vmstate_hpet_timer, HPETTimer),",
          "312:         VMSTATE_END_OF_LIST()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "322:         VMSTATE_VALIDATE(\"num_timers in range\", hpet_validate_num_timers),",
          "",
          "---------------"
        ]
      }
    }
  ]
}