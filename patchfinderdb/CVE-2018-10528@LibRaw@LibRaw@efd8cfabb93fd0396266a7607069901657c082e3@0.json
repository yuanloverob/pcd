{
  "cve_id": "CVE-2018-10528",
  "cve_desc": "An issue was discovered in LibRaw 0.18.9. There is a stack-based buffer overflow in the utf2char function in libraw_cxx.cpp.",
  "repo": "LibRaw/LibRaw",
  "patch_hash": "efd8cfabb93fd0396266a7607069901657c082e3",
  "patch_info": {
    "commit_hash": "efd8cfabb93fd0396266a7607069901657c082e3",
    "repo": "LibRaw/LibRaw",
    "commit_url": "https://github.com/LibRaw/LibRaw/commit/efd8cfabb93fd0396266a7607069901657c082e3",
    "files": [
      "src/libraw_cxx.cpp"
    ],
    "message": "X3F parser possible buffer overrun",
    "before_after_code_files": [
      "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
    ]
  },
  "patch_diff": {
    "src/libraw_cxx.cpp||src/libraw_cxx.cpp": [
      "File: src/libraw_cxx.cpp -> src/libraw_cxx.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "5484:   x3f_delete((x3f_t*)p);",
      "5485: }",
      "5488: {",
      "5489:   char *b = buffer;",
      "5492:     char *chr = (char *)str;",
      "5494:     str++;",
      "5495:   }",
      "5498: }",
      "5500: static void *lr_memmem(const void *l, size_t l_len, const void *s, size_t s_len)",
      "",
      "[Removed Lines]",
      "5487: static char *utf2char(utf16_t *str, char *buffer)",
      "5491:   while (*str != 0x00) {",
      "5497:   return buffer;",
      "",
      "[Added Lines]",
      "5487: void utf2char(utf16_t *str, char *buffer, unsigned bufsz)",
      "5489:  if(bufsz<1) return;",
      "5490:  buffer[bufsz-1] = 0;",
      "5493:   while (*str != 0x00 && --bufsz>0)",
      "5494:   {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "5555:     x3f_property_t *P = PL->property_table.element;",
      "5556:     for (i=0; i<PL->num_properties; i++) {",
      "5557:      char name[100], value[100];",
      "5560:      if (!strcmp (name, \"ISO\"))",
      "5561:       imgdata.other.iso_speed = atoi(value);",
      "5562:      if (!strcmp (name, \"CAMMANUF\"))",
      "",
      "[Removed Lines]",
      "5558:      utf2char(P[i].name,name);",
      "5559:      utf2char(P[i].value,value);",
      "",
      "[Added Lines]",
      "5560:      utf2char(P[i].name,name,sizeof(name));",
      "5561:      utf2char(P[i].value,value,sizeof(value));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "94f1092aee585cb988cd409e5501b567a0730fee",
      "candidate_info": {
        "commit_hash": "94f1092aee585cb988cd409e5501b567a0730fee",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/94f1092aee585cb988cd409e5501b567a0730fee",
        "files": [
          "src/libraw_cxx.cpp"
        ],
        "message": "restored static for utf2char() lost in previous bugfix",
        "before_after_code_files": [
          "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ],
          "candidate": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/libraw_cxx.cpp||src/libraw_cxx.cpp": [
          "File: src/libraw_cxx.cpp -> src/libraw_cxx.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "5484:   x3f_delete((x3f_t*)p);",
          "5485: }",
          "5488: {",
          "5489:  if(bufsz<1) return;",
          "5490:  buffer[bufsz-1] = 0;",
          "",
          "[Removed Lines]",
          "5487: void utf2char(utf16_t *str, char *buffer, unsigned bufsz)",
          "",
          "[Added Lines]",
          "5487: static void utf2char(utf16_t *str, char *buffer, unsigned bufsz)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f2fe20136936bb79d93b9b0a535f2c058d545f37",
      "candidate_info": {
        "commit_hash": "f2fe20136936bb79d93b9b0a535f2c058d545f37",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/f2fe20136936bb79d93b9b0a535f2c058d545f37",
        "files": [
          "Changelog.txt",
          "internal/libraw_x3f.cpp",
          "libraw/libraw_version.h",
          "src/libraw_cxx.cpp"
        ],
        "message": "X3F parser fixes",
        "before_after_code_files": [
          "internal/libraw_x3f.cpp||internal/libraw_x3f.cpp",
          "libraw/libraw_version.h||libraw/libraw_version.h",
          "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ],
          "candidate": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ]
        }
      },
      "candidate_diff": {
        "internal/libraw_x3f.cpp||internal/libraw_x3f.cpp": [
          "File: internal/libraw_x3f.cpp -> internal/libraw_x3f.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "516:   int _cur = _file->_func(_buffer,1,_left); \\",
          "517:   if (_cur == 0) {       \\",
          "518:    throw LIBRAW_EXCEPTION_IO_CORRUPT;  \\",
          "520:   }           \\",
          "521:   _left -= _cur;        \\",
          "522:  }            \\",
          "",
          "[Removed Lines]",
          "519:    exit(1);        \\",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "909:   x3f_directory_entry_header_t *DEH = &DE->header;",
          "910:   if (DEH->identifier == X3F_SECp) {",
          "911:    x3f_property_list_t *PL = &DEH->data_subsection.property_list;",
          "921:    FREE(PL->property_table.element);",
          "922:    FREE(PL->data);",
          "923:   }",
          "",
          "[Removed Lines]",
          "912:    if (PL)",
          "913:    {",
          "914:     int i;",
          "916:     for (i = 0; i < PL->property_table.size; i++) {",
          "917:      FREE(PL->property_table.element[i].name_utf8);",
          "918:      FREE(PL->property_table.element[i].value_utf8);",
          "919:     }",
          "920:    }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1625:  if (!PL->data_size)",
          "1626:   PL->data_size = read_data_block(&PL->data, I, DE, 0);",
          "1628:  for (i=0; i<PL->num_properties; i++) {",
          "1629:   x3f_property_t *P = &PL->property_table.element[i];",
          "1631:   P->name = ((utf16_t *)PL->data + P->name_offset);",
          "1632:   P->value = ((utf16_t *)PL->data + P->value_offset);",
          "1635:  }",
          "1636: }",
          "",
          "[Removed Lines]",
          "1633:   P->name_utf8 = 0;// utf16le_to_utf8(P->name);",
          "1634:   P->value_utf8 = 0;//utf16le_to_utf8(P->value);",
          "",
          "[Added Lines]",
          "1615:         uint32_t maxoffset = PL->data_size/sizeof(utf16_t)-2; // at least 2 chars, value + terminating 0x0000",
          "1619:                 if(P->name_offset > maxoffset || P->value_offset > maxoffset)",
          "1620:                   throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "",
          "---------------"
        ],
        "libraw/libraw_version.h||libraw/libraw_version.h": [
          "File: libraw/libraw_version.h -> libraw/libraw_version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #define LIBRAW_MAJOR_VERSION  0",
          "24: #define LIBRAW_MINOR_VERSION  18",
          "26: #define LIBRAW_VERSION_TAIL   Release",
          "28: #define LIBRAW_SHLIB_CURRENT   16",
          "",
          "[Removed Lines]",
          "25: #define LIBRAW_PATCH_VERSION  9",
          "",
          "[Added Lines]",
          "25: #define LIBRAW_PATCH_VERSION  10",
          "",
          "---------------"
        ],
        "src/libraw_cxx.cpp||src/libraw_cxx.cpp": [
          "File: src/libraw_cxx.cpp -> src/libraw_cxx.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "5553:    DEH = &DE->header;",
          "5554:    x3f_property_list_t *PL = &DEH->data_subsection.property_list;",
          "5555:    if (PL->property_table.size != 0) {",
          "5556:     int i;",
          "5557:     x3f_property_t *P = PL->property_table.element;",
          "5558:     for (i=0; i<PL->num_properties; i++) {",
          "5559:      char name[100], value[100];",
          "5562:      if (!strcmp (name, \"ISO\"))",
          "5563:       imgdata.other.iso_speed = atoi(value);",
          "5564:      if (!strcmp (name, \"CAMMANUF\"))",
          "",
          "[Removed Lines]",
          "5560:      utf2char(P[i].name,name,sizeof(name));",
          "5561:      utf2char(P[i].value,value,sizeof(value));",
          "",
          "[Added Lines]",
          "5555:           utf16_t *datap = (utf16_t*) PL->data;",
          "5556:           uint32_t maxitems = PL->data_size/sizeof(utf16_t);",
          "5562:      int noffset = (P[i].name - datap);",
          "5563:                           int voffset = (P[i].value - datap);",
          "5564:                           if(noffset < 0 || noffset>maxitems || voffset<0 || voffset>maxitems)",
          "5565:                               throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "5566:                           int maxnsize = maxitems - (P[i].name - datap);",
          "5567:                           int maxvsize = maxitems - (P[i].value - datap);",
          "5568:                           utf2char(P[i].name, name,MIN(maxnsize,sizeof(name)));",
          "5569:                           utf2char(P[i].value, value,MIN(maxvsize,sizeof(value)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6f89e5505b1759b788f15cd14d0958b262b82f97",
      "candidate_info": {
        "commit_hash": "6f89e5505b1759b788f15cd14d0958b262b82f97",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/6f89e5505b1759b788f15cd14d0958b262b82f97",
        "files": [
          "src/libraw_cxx.cpp"
        ],
        "message": "X3F parser possible buffer overrun",
        "before_after_code_files": [
          "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ],
          "candidate": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/libraw_cxx.cpp||src/libraw_cxx.cpp": [
          "File: src/libraw_cxx.cpp -> src/libraw_cxx.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "6099: void x3f_clear(void *p) { x3f_delete((x3f_t *)p); }",
          "6102: {",
          "6103:   char *b = buffer;",
          "6106:   {",
          "6107:     char *chr = (char *)str;",
          "6109:     str++;",
          "6110:   }",
          "6113: }",
          "6115: static void *lr_memmem(const void *l, size_t l_len, const void *s, size_t s_len)",
          "",
          "[Removed Lines]",
          "6101: static char *utf2char(utf16_t *str, char *buffer)",
          "6105:   while (*str != 0x00)",
          "6112:   return buffer;",
          "",
          "[Added Lines]",
          "6101: void utf2char(utf16_t *str, char *buffer, unsigned bufsz)",
          "6103:  if(bufsz<1) return;",
          "6104:  buffer[bufsz-1] = 0;",
          "6107:   while (*str != 0x00 && --bufsz>0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6173:       for (i = 0; i < PL->num_properties; i++)",
          "6174:       {",
          "6175:         char name[100], value[100];",
          "6178:         if (!strcmp(name, \"ISO\"))",
          "6179:           imgdata.other.iso_speed = atoi(value);",
          "6180:         if (!strcmp(name, \"CAMMANUF\"))",
          "",
          "[Removed Lines]",
          "6176:         utf2char(P[i].name, name);",
          "6177:         utf2char(P[i].value, value);",
          "",
          "[Added Lines]",
          "6177:         utf2char(P[i].name, name,sizeof(name));",
          "6178:         utf2char(P[i].value, value,sizeof(value));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fc89bc96ea973eee17c232346e49404c036a3530",
      "candidate_info": {
        "commit_hash": "fc89bc96ea973eee17c232346e49404c036a3530",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/fc89bc96ea973eee17c232346e49404c036a3530",
        "files": [
          "src/libraw_cxx.cpp"
        ],
        "message": "X3F parser possible buffer overrun",
        "before_after_code_files": [
          "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ],
          "candidate": [
            "src/libraw_cxx.cpp||src/libraw_cxx.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/libraw_cxx.cpp||src/libraw_cxx.cpp": [
          "File: src/libraw_cxx.cpp -> src/libraw_cxx.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "6237: void x3f_clear(void *p) { x3f_delete((x3f_t *)p); }",
          "6240: {",
          "6241:   char *b = buffer;",
          "6244:   {",
          "6245:     char *chr = (char *)str;",
          "6247:     str++;",
          "6248:   }",
          "6251: }",
          "6253: static void *lr_memmem(const void *l, size_t l_len, const void *s, size_t s_len)",
          "",
          "[Removed Lines]",
          "6239: static char *utf2char(utf16_t *str, char *buffer)",
          "6243:   while (*str != 0x00)",
          "6250:   return buffer;",
          "",
          "[Added Lines]",
          "6239: void utf2char(utf16_t *str, char *buffer, unsigned bufsz)",
          "6241:  if(bufsz<1) return;",
          "6242:  buffer[bufsz-1] = 0;",
          "6245:   while (*str != 0x00 && --bufsz>0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6311:       for (i = 0; i < PL->num_properties; i++)",
          "6312:       {",
          "6313:         char name[100], value[100];",
          "6316:         if (!strcmp(name, \"ISO\"))",
          "6317:           imgdata.other.iso_speed = atoi(value);",
          "6318:         if (!strcmp(name, \"CAMMANUF\"))",
          "",
          "[Removed Lines]",
          "6314:         utf2char(P[i].name, name);",
          "6315:         utf2char(P[i].value, value);",
          "",
          "[Added Lines]",
          "6315:         utf2char(P[i].name, name,sizeof(name));",
          "6316:         utf2char(P[i].value, value,sizeof(value));",
          "",
          "---------------"
        ]
      }
    }
  ]
}