{
  "cve_id": "CVE-2013-4542",
  "cve_desc": "The virtio_scsi_load_request function in hw/scsi/scsi-bus.c in QEMU before 1.7.2 might allow remote attackers to execute arbitrary code via a crafted savevm image, which triggers an out-of-bounds array access.",
  "repo": "qemu/qemu",
  "patch_hash": "3c3ce981423e0d6c18af82ee62f1850c2cda5976",
  "patch_info": {
    "commit_hash": "3c3ce981423e0d6c18af82ee62f1850c2cda5976",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/3c3ce981423e0d6c18af82ee62f1850c2cda5976",
    "files": [
      "hw/scsi/virtio-scsi.c"
    ],
    "message": "virtio-scsi: fix buffer overrun on invalid state load\n\nCVE-2013-4542\n\nhw/scsi/scsi-bus.c invokes load_request.\n\n virtio_scsi_load_request does:\n    qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));\n\nthis probably can make elem invalid, for example,\nmake in_num or out_num huge, then:\n\n    virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);\n\nwill do:\n\n    if (req->elem.out_num > 1) {\n        qemu_sgl_init_external(req, &req->elem.out_sg[1],\n                               &req->elem.out_addr[1],\n                               req->elem.out_num - 1);\n    } else {\n        qemu_sgl_init_external(req, &req->elem.in_sg[1],\n                               &req->elem.in_addr[1],\n                               req->elem.in_num - 1);\n    }\n\nand this will access out of array bounds.\n\nNote: this adds security checks within assert calls since\nSCSIBusInfo's load_request cannot fail.\nFor now simply disable builds with NDEBUG - there seems\nto be little value in supporting these.\n\nCc: Andreas F\u00e4rber <afaerber@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
    "before_after_code_files": [
      "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
    ]
  },
  "patch_diff": {
    "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c": [
      "File: hw/scsi/virtio-scsi.c -> hw/scsi/virtio-scsi.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "147:     qemu_get_be32s(f, &n);",
      "148:     assert(n < vs->conf.num_queues);",
      "149:     qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));",
      "150:     virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);",
      "152:     scsi_req_ref(sreq);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "154: #ifdef NDEBUG",
      "155: #error building with NDEBUG is not supported",
      "156: #endif",
      "157:     assert(req->elem.in_num <= ARRAY_SIZE(req->elem.in_sg));",
      "158:     assert(req->elem.out_num <= ARRAY_SIZE(req->elem.out_sg));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5ad12b32352696f8c9c779bda6a900c7b6cb0b4d",
      "candidate_info": {
        "commit_hash": "5ad12b32352696f8c9c779bda6a900c7b6cb0b4d",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/5ad12b32352696f8c9c779bda6a900c7b6cb0b4d",
        "files": [
          "hw/scsi/virtio-scsi.c"
        ],
        "message": "virtio-scsi: fix buffer overrun on invalid state load\n\nCVE-2013-4542\n\nhw/scsi/scsi-bus.c invokes load_request.\n\n virtio_scsi_load_request does:\n    qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));\n\nthis probably can make elem invalid, for example,\nmake in_num or out_num huge, then:\n\n    virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);\n\nwill do:\n\n    if (req->elem.out_num > 1) {\n        qemu_sgl_init_external(req, &req->elem.out_sg[1],\n                               &req->elem.out_addr[1],\n                               req->elem.out_num - 1);\n    } else {\n        qemu_sgl_init_external(req, &req->elem.in_sg[1],\n                               &req->elem.in_addr[1],\n                               req->elem.in_num - 1);\n    }\n\nand this will access out of array bounds.\n\nNote: this adds security checks within assert calls since\nSCSIBusInfo's load_request cannot fail.\nFor now simply disable builds with NDEBUG - there seems\nto be little value in supporting these.\n\nCc: Andreas F\u00e4rber <afaerber@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 3c3ce981423e0d6c18af82ee62f1850c2cda5976)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
          ],
          "candidate": [
            "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c": [
          "File: hw/scsi/virtio-scsi.c -> hw/scsi/virtio-scsi.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "147:     qemu_get_be32s(f, &n);",
          "148:     assert(n < vs->conf.num_queues);",
          "149:     qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));",
          "150:     virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);",
          "152:     scsi_req_ref(sreq);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "154: #ifdef NDEBUG",
          "155: #error building with NDEBUG is not supported",
          "156: #endif",
          "157:     assert(req->elem.in_num <= ARRAY_SIZE(req->elem.in_sg));",
          "158:     assert(req->elem.out_num <= ARRAY_SIZE(req->elem.out_sg));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a7fcb4c5e0ef930e102efba44cb04a8d8182b321",
      "candidate_info": {
        "commit_hash": "a7fcb4c5e0ef930e102efba44cb04a8d8182b321",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/a7fcb4c5e0ef930e102efba44cb04a8d8182b321",
        "files": [
          "hw/scsi/virtio-scsi.c"
        ],
        "message": "virtio-scsi: fix buffer overrun on invalid state load\n\nCVE-2013-4542\n\nhw/scsi/scsi-bus.c invokes load_request.\n\n virtio_scsi_load_request does:\n    qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));\n\nthis probably can make elem invalid, for example,\nmake in_num or out_num huge, then:\n\n    virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);\n\nwill do:\n\n    if (req->elem.out_num > 1) {\n        qemu_sgl_init_external(req, &req->elem.out_sg[1],\n                               &req->elem.out_addr[1],\n                               req->elem.out_num - 1);\n    } else {\n        qemu_sgl_init_external(req, &req->elem.in_sg[1],\n                               &req->elem.in_addr[1],\n                               req->elem.in_num - 1);\n    }\n\nand this will access out of array bounds.\n\nNote: this adds security checks within assert calls since\nSCSIBusInfo's load_request cannot fail.\nFor now simply disable builds with NDEBUG - there seems\nto be little value in supporting these.\n\nCc: Andreas F\u00e4rber <afaerber@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 3c3ce981423e0d6c18af82ee62f1850c2cda5976)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
          ],
          "candidate": [
            "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/scsi/virtio-scsi.c||hw/scsi/virtio-scsi.c": [
          "File: hw/scsi/virtio-scsi.c -> hw/scsi/virtio-scsi.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "147:     qemu_get_be32s(f, &n);",
          "148:     assert(n < vs->conf.num_queues);",
          "149:     qemu_get_buffer(f, (unsigned char *)&req->elem, sizeof(req->elem));",
          "150:     virtio_scsi_parse_req(s, vs->cmd_vqs[n], req);",
          "152:     scsi_req_ref(sreq);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "154: #ifdef NDEBUG",
          "155: #error building with NDEBUG is not supported",
          "156: #endif",
          "157:     assert(req->elem.in_num <= ARRAY_SIZE(req->elem.in_sg));",
          "158:     assert(req->elem.out_num <= ARRAY_SIZE(req->elem.out_sg));",
          "",
          "---------------"
        ]
      }
    }
  ]
}