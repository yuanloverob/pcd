{
  "cve_id": "CVE-2021-36086",
  "cve_desc": "The CIL compiler in SELinux 3.2 has a use-after-free in cil_reset_classpermission (called from cil_reset_classperms_set and cil_reset_classperms_list).",
  "repo": "SELinuxProject/selinux",
  "patch_hash": "c49a8ea09501ad66e799ea41b8154b6770fec2c8",
  "patch_info": {
    "commit_hash": "c49a8ea09501ad66e799ea41b8154b6770fec2c8",
    "repo": "SELinuxProject/selinux",
    "commit_url": "https://github.com/SELinuxProject/selinux/commit/c49a8ea09501ad66e799ea41b8154b6770fec2c8",
    "files": [
      "libsepol/cil/src/cil_reset_ast.c"
    ],
    "message": "libsepol/cil: cil_reset_classperms_set() should not reset classpermission\n\nIn struct cil_classperms_set, the set field is a pointer to a\nstruct cil_classpermission which is looked up in the symbol table.\nSince the cil_classperms_set does not create the cil_classpermission,\nit should not reset it.\n\nSet the set field to NULL instead of resetting the classpermission\nthat it points to.\n\nSigned-off-by: James Carter <jwcart2@gmail.com>",
    "before_after_code_files": [
      "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c"
    ]
  },
  "patch_diff": {
    "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c": [
      "File: libsepol/cil/src/cil_reset_ast.c -> libsepol/cil/src/cil_reset_ast.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "60: static void cil_reset_classperms_set(struct cil_classperms_set *cp_set)",
      "61: {",
      "63: }",
      "65: static inline void cil_reset_classperms_list(struct cil_list *cp_list)",
      "",
      "[Removed Lines]",
      "62:  cil_reset_classpermission(cp_set->set);",
      "",
      "[Added Lines]",
      "62:  if (cp_set == NULL) {",
      "63:   return;",
      "64:  }",
      "66:  cp_set->set = NULL;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2d2c76fc613ba338476a3a1741c2a3af5e04d154",
      "candidate_info": {
        "commit_hash": "2d2c76fc613ba338476a3a1741c2a3af5e04d154",
        "repo": "SELinuxProject/selinux",
        "commit_url": "https://github.com/SELinuxProject/selinux/commit/2d2c76fc613ba338476a3a1741c2a3af5e04d154",
        "files": [
          "libsepol/cil/src/cil_reset_ast.c"
        ],
        "message": "libsepol/cil: Properly reset an anonymous classperm set\n\nIn struct cil_classperms_set, the \"set\" field is a pointer to a\nstruct cil_classpermission. Normally the classpermission is created\nin a classpermissionset rule with a name declared in a\nclasspermission rule and stored in a symbol table. Commit c49a8ea0\n(\"libsepol/cil: cil_reset_classperms_set() should not reset\nclasspermission\") fixed the resetting of classperms sets by setting\nthe \"set\" field to NULL rather than resetting the classpermission\nthat it pointed to.\n\nBut this fix mixed the special case where an anonymous classperm\nset is passed as an argument to a call. In this case the\nclasspermission is not named and not stored in a symtab, it is\ncreated just for the classperms set and its classperms list needs\nto be reset.\n\nReset the classperms list if the classperms set is anonymous (which\nis when the datum name is NULL).\n\nSigned-off-by: James Carter <jwcart2@gmail.com>",
        "before_after_code_files": [
          "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c"
          ],
          "candidate": [
            "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c"
          ]
        }
      },
      "candidate_diff": {
        "libsepol/cil/src/cil_reset_ast.c||libsepol/cil/src/cil_reset_ast.c": [
          "File: libsepol/cil/src/cil_reset_ast.c -> libsepol/cil/src/cil_reset_ast.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: static void cil_reset_classperms_set(struct cil_classperms_set *cp_set)",
          "62: {",
          "64:   return;",
          "65:  }",
          "67:  cp_set->set = NULL;",
          "68: }",
          "",
          "[Removed Lines]",
          "63:  if (cp_set == NULL) {",
          "",
          "[Added Lines]",
          "63:  if (cp_set == NULL || cp_set->set == NULL) {",
          "67:  if (cp_set->set->datum.name == NULL) {",
          "68:   cil_reset_classperms_list(cp_set->set->classperms);",
          "69:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}