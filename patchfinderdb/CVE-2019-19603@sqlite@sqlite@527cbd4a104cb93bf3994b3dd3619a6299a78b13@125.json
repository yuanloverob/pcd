{
  "cve_id": "CVE-2019-19603",
  "cve_desc": "SQLite 3.30.1 mishandles certain SELECT statements with a nonexistent VIEW, leading to an application crash.",
  "repo": "sqlite/sqlite",
  "patch_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
  "patch_info": {
    "commit_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/build.c",
      "src/sqliteInt.h",
      "test/altertab.test"
    ],
    "message": "Do not allow CREATE TABLE or CREATE VIEW of an object with a name that looks like a shadow table name.\n\nFossilOrigin-Name: 6aef58b629d89955f85f65191ba2be67b2adfac4f0327fe9a7141cb2705dbc00",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/build.c||src/build.c",
      "src/sqliteInt.h||src/sqliteInt.h",
      "test/altertab.test||test/altertab.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8ad34d36a141fa8f5d9bd784dfeb892c983897a6dc6b867607cc668508acf944",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/build.c||src/build.c": [
      "File: src/build.c -> src/build.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "856:       }",
      "857:     }",
      "858:   }else{",
      "861:     ){",
      "862:       sqlite3ErrorMsg(pParse, \"object name reserved for internal use: %s\",",
      "863:                       zName);",
      "864:       return SQLITE_ERROR;",
      "865:     }",
      "866:   }",
      "867:   return SQLITE_OK;",
      "868: }",
      "",
      "[Removed Lines]",
      "859:     if( pParse->nested==0",
      "860:      && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7)",
      "",
      "[Added Lines]",
      "859:     if( (pParse->nested==0 && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7))",
      "860:      || (sqlite3ReadOnlyShadowTables(db) && sqlite3ShadowTableName(db, zName))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "2132: static int isShadowTableName(sqlite3 *db, char *zName){",
      "",
      "[Added Lines]",
      "2133: int sqlite3ShadowTableName(sqlite3 *db, const char *zName){",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2147:   if( pMod->pModule->xShadowName==0 ) return 0;",
      "2148:   return pMod->pModule->xShadowName(zTail+1);",
      "2149: }",
      "",
      "[Removed Lines]",
      "2150: #else",
      "2151: # define isShadowTableName(x,y) 0",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2190:   p = pParse->pNewTable;",
      "2191:   if( p==0 ) return;",
      "2194:     p->tabFlags |= TF_Shadow;",
      "2195:   }",
      "",
      "[Removed Lines]",
      "2193:   if( pSelect==0 && isShadowTableName(db, p->zName) ){",
      "",
      "[Added Lines]",
      "2192:   if( pSelect==0 && sqlite3ShadowTableName(db, p->zName) ){",
      "",
      "---------------"
    ],
    "src/sqliteInt.h||src/sqliteInt.h": [
      "File: src/sqliteInt.h -> src/sqliteInt.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "4548: #  define sqlite3VtabInSync(db) ((db)->nVTrans>0 && (db)->aVTrans==0)",
      "4549: #endif",
      "4550: int sqlite3ReadOnlyShadowTables(sqlite3 *db);",
      "4551: int sqlite3VtabEponymousTableInit(Parse*,Module*);",
      "4552: void sqlite3VtabEponymousTableClear(sqlite3*,Module*);",
      "4553: void sqlite3VtabMakeWritable(Parse*,Table*);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4551: #ifndef SQLITE_OMIT_VIRTUALTABLE",
      "4552:   int sqlite3ShadowTableName(sqlite3 *db, const char *zName);",
      "4553: #else",
      "4554: # define sqlite3ShadowTableName(A,B) 0",
      "4555: #endif",
      "",
      "---------------"
    ],
    "test/altertab.test||test/altertab.test": [
      "File: test/altertab.test -> test/altertab.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "547:   } {1 {table y1_segments may not be modified}}",
      "549:   do_catchsql_test 16.20 {",
      "554:     DROP TABLE y1_segments;",
      "555:   } {1 {table y1_segments may not be dropped}}",
      "557:   do_execsql_test 16.30 {",
      "558:     ALTER TABLE y1 RENAME TO z1;",
      "559:   }",
      "",
      "[Removed Lines]",
      "550:     ALTER TABLE y1_segments RENAME TO abc;",
      "551:   } {1 {table y1_segments may not be altered}}",
      "553:   do_catchsql_test 16.21 {",
      "",
      "[Added Lines]",
      "553:   do_catchsql_test 16.20 {",
      "554:     ALTER TABLE y1_segments RENAME TO abc;",
      "555:   } {1 {table y1_segments may not be altered}}",
      "556:   sqlite3_db_config db DEFENSIVE 0",
      "557:   do_catchsql_test 16.22 {",
      "558:     ALTER TABLE y1_segments RENAME TO abc;",
      "559:   } {0 {}}",
      "560:   sqlite3_db_config db DEFENSIVE 1",
      "561:   do_catchsql_test 16.23 {",
      "562:     CREATE TABLE y1_segments AS SELECT * FROM abc;",
      "563:   } {1 {object name reserved for internal use: y1_segments}}",
      "564:   do_catchsql_test 16.24 {",
      "565:     CREATE VIEW y1_segments AS SELECT * FROM abc;",
      "566:   } {1 {object name reserved for internal use: y1_segments}}",
      "567:   sqlite3_db_config db DEFENSIVE 0",
      "568:   do_catchsql_test 16.25 {",
      "569:     ALTER TABLE abc RENAME TO y1_segments;",
      "570:   } {0 {}}",
      "571:   sqlite3_db_config db DEFENSIVE 1",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "818a3b548647d7a314771f455c93be5ff6440047",
      "candidate_info": {
        "commit_hash": "818a3b548647d7a314771f455c93be5ff6440047",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/818a3b548647d7a314771f455c93be5ff6440047",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "src/sqliteInt.h"
        ],
        "message": "Fix sqlite3ExprCompare() so that it ignores differences in the Expr.iTable field for IN operators, as otherwise it can lead to false negatives, which is usually harmless, but can cause problems for an assert() in the window function logic.\n\nFossilOrigin-Name: 6a204b192a6c6f21988cab217366f21b14c672b81ceadc43675761a6d8c4484f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "src/sqliteInt.h||src/sqliteInt.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 352878fe1cbcf7b6803624544bba5a95565d1638d4dd09e91764ddad17889301",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4957:       if( pA->iColumn!=pB->iColumn ) return 2;",
          "4958:       if( pA->op2!=pB->op2 ) return 2;",
          "4959:       if( pA->iTable!=pB->iTable",
          "4960:        && (pA->iTable!=iTab || NEVER(pB->iTable>=0)) ) return 2;",
          "4961:     }",
          "4962:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4960:        && pA->op!=TK_IN",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h"
        ]
      }
    },
    {
      "candidate_hash": "844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
      "candidate_info": {
        "commit_hash": "844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/tokenize.c"
        ],
        "message": "Fix harmless compiler warning.\n\nFossilOrigin-Name: dddda685f3443d8a38901f758543fcde73d7b8cfe72b0ad5f419cd7459343bf5",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/tokenize.c||src/tokenize.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 1aee70d6de8a9b17ebb74a7cb1dad65139cde1b615dcce4d15d3a476fda8676b",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/tokenize.c||src/tokenize.c": [
          "File: src/tokenize.c -> src/tokenize.c"
        ]
      }
    },
    {
      "candidate_hash": "38e3853240798ae59815320f745a6325f1da10cc",
      "candidate_info": {
        "commit_hash": "38e3853240798ae59815320f745a6325f1da10cc",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/38e3853240798ae59815320f745a6325f1da10cc",
        "files": [
          "ext/fts5/test/fts5circref.test",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Add tests for the use of SQLITE_PREPARE_NO_VTAB in fts5.\n\nFossilOrigin-Name: 1999612010e310fc2430d1f00076f69fade0c66d202771dbb0f3d5597ac0a03c",
        "before_after_code_files": [
          "ext/fts5/test/fts5circref.test||ext/fts5/test/fts5circref.test",
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts5/test/fts5circref.test||ext/fts5/test/fts5circref.test": [
          "File: ext/fts5/test/fts5circref.test -> ext/fts5/test/fts5circref.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # 2018 Dec 22",
          "2: #",
          "3: # The author disclaims copyright to this source code.  In place of",
          "4: # a legal notice, here is a blessing:",
          "5: #",
          "6: #    May you do good and not evil.",
          "7: #    May you find forgiveness for yourself and forgive others.",
          "8: #    May you share freely, never taking more than you give.",
          "9: #",
          "10: #*************************************************************************",
          "11: # This file implements regression tests for SQLite library.  The",
          "12: # focus of this script is testing the FTS5 module.",
          "13: #",
          "15: source [file join [file dirname [info script]] fts5_common.tcl]",
          "16: set testprefix fts5circref",
          "18: # If SQLITE_ENABLE_FTS5 is not defined, omit this file.",
          "19: ifcapable !fts5 {",
          "20:   finish_test",
          "21:   return",
          "22: }",
          "24: do_execsql_test 1.0 {",
          "25:   CREATE VIRTUAL TABLE tt USING fts5(a);",
          "26:   SELECT name FROM sqlite_master ORDER BY 1;",
          "27: } {",
          "28:   tt tt_config tt_content tt_data tt_docsize tt_idx",
          "29: }",
          "30: db_save_and_close",
          "32: foreach {tn schema sql} {",
          "33:   1 {",
          "34:     CREATE TRIGGER tr1 AFTER INSERT ON tt_config BEGIN",
          "35:       SELECT * FROM tt;",
          "36:     END;",
          "37:   } {",
          "38:     INSERT INTO tt(tt, rank) VALUES('usermerge', 4);",
          "39:   }",
          "41:   2 {",
          "42:     CREATE TRIGGER tr1 AFTER INSERT ON tt_docsize BEGIN",
          "43:       SELECT * FROM tt;",
          "44:     END;",
          "45:   } {",
          "46:     INSERT INTO tt(a) VALUES('one two three');",
          "47:   }",
          "49:   3 {",
          "50:     CREATE TRIGGER tr1 AFTER INSERT ON tt_content BEGIN",
          "51:       SELECT * FROM tt;",
          "52:     END;",
          "53:   } {",
          "54:     INSERT INTO tt(a) VALUES('one two three');",
          "55:   }",
          "57:   4 {",
          "58:     CREATE TRIGGER tr1 AFTER INSERT ON tt_data BEGIN",
          "59:       SELECT * FROM tt;",
          "60:     END;",
          "61:   } {",
          "62:     INSERT INTO tt(a) VALUES('one two three');",
          "63:   }",
          "65:   5 {",
          "66:     CREATE TRIGGER tr1 AFTER INSERT ON tt_idx BEGIN",
          "67:       SELECT * FROM tt;",
          "68:     END;",
          "69:   } {",
          "70:     INSERT INTO tt(a) VALUES('one two three');",
          "71:   }",
          "72: } {",
          "73:   db_restore_and_reopen",
          "74:   do_execsql_test 1.1.$tn.1 $schema",
          "75:   do_catchsql_test 1.1.$tn.2 $sql {1 {SQL logic error}}",
          "76:   db close",
          "77: }",
          "80: finish_test",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 25666e3d03950caf753295cdb55df162e07dbcf6840b05875c6e0b127c469ecb",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c542fa85735fbea00c9620f72e551041855e4505",
      "candidate_info": {
        "commit_hash": "c542fa85735fbea00c9620f72e551041855e4505",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c542fa85735fbea00c9620f72e551041855e4505",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/with1.test"
        ],
        "message": "Add test cases for the fix in the previous commit.\n\nFossilOrigin-Name: c1057b2a60add08e5c80ef2a53932a690b096f2eb03c7de863844deaa8fc9d53",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/with1.test||test/with1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: d2fe370cafa9b11f6c3eb4e1c3be48d9d2610b9d2f9d9ebf9e50267f9079dfc0",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/with1.test||test/with1.test": [
          "File: test/with1.test -> test/with1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1117:   SELECT * FROM v3;",
          "1118: } {1 A C D E 1 A F G H 1 B C D E 1 B F G H 2 A C D E 2 A F G H 2 B C D E 2 B F G H 3 A C D E 3 A F G H 3 B C D E 3 B F G H 4 A C D E 4 A F G H 4 B C D E 4 B F G H 5 A C D E 5 A F G H 5 B C D E 5 B F G H}",
          "1120: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1120: #-------------------------------------------------------------------------",
          "1121: reset_db",
          "1122: do_execsql_test 24.1 {",
          "1123:   CREATE TABLE t1(a, b, c);",
          "1124:   CREATE VIEW v1 AS SELECT max(a), min(b) FROM t1 GROUP BY c;",
          "1125: }",
          "1126: do_test 24.1 {",
          "1127:   set program [db eval {EXPLAIN SELECT 1 FROM v1,v1,v1}]",
          "1128:   expr [lsearch $program OpenDup]>0",
          "1129: } {1}",
          "1130: do_execsql_test 24.2 {",
          "1131:   ATTACH \"\" AS aux;",
          "1132:   CREATE VIEW aux.v3 AS VALUES(1);",
          "1133:   CREATE VIEW main.v3 AS VALUES(3);",
          "1135:   CREATE VIEW aux.v2 AS SELECT * FROM v3;",
          "1136:   CREATE VIEW main.v2 AS SELECT * FROM v3;",
          "1138:   SELECT * FROM main.v2 AS a, aux.v2 AS b, aux.v2 AS c, main.v2 AS d;",
          "1139: } {",
          "1140:   3 1 1 3",
          "1141: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "be812624006aa7ca3acef17161ed6ea8de24d004",
      "candidate_info": {
        "commit_hash": "be812624006aa7ca3acef17161ed6ea8de24d004",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/be812624006aa7ca3acef17161ed6ea8de24d004",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c",
          "test/intreal.test"
        ],
        "message": "Always store a REAL value in a column with REAL affinity if the integer equivalent would require 8 bytes of storage. Fix for [3c27b97e3].\n\nFossilOrigin-Name: 14c00b1016ba53ab2dc177c59a27b6b9209202973685f0f274112d296ba7dfcb",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c",
          "test/intreal.test||test/intreal.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 1eb2a628e4bfae51fea43e8f40fedfe23f2118024d9cce35828c3cbe92a9b392",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2884:     pRec = pData0;",
          "2885:     do{",
          "2886:       applyAffinity(pRec, zAffinity[0], encoding);",
          "2887:       REGISTER_TRACE((int)(pRec-aMem), pRec);",
          "2888:       zAffinity++;",
          "2889:       pRec++;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2887:       if( zAffinity[0]==SQLITE_AFF_REAL && (pRec->flags & MEM_Int) ){",
          "2888:         pRec->flags |= MEM_IntReal;",
          "2889:         pRec->flags &= ~(MEM_Int);",
          "2890:       }",
          "",
          "---------------"
        ],
        "test/intreal.test||test/intreal.test": [
          "File: test/intreal.test -> test/intreal.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "46:          max(1,intreal(5),intreal(3),4);",
          "47: } {5.0 5.0}",
          "52: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "49: #-------------------------------------------------------------------------",
          "50: do_execsql_test 2.1 {",
          "51:   CREATE TABLE t2(a REAL);",
          "52:   INSERT INTO t2 VALUES( 836627109860825358 );",
          "53:   SELECT substr(a,1,4) FROM t2 WHERE a = CAST(836627109860825358 AS REAL);",
          "54: } {8.36}",
          "56: do_execsql_test 2.2 {",
          "57:   CREATE INDEX i2 ON t2(a);",
          "58:   SELECT substr(a,1,4) FROM t2 WHERE a = CAST(836627109860825358 AS REAL);",
          "59: } {8.36}",
          "61: do_execsql_test 2.3 {",
          "62:   CREATE TABLE t0 (c0);",
          "63:   CREATE TABLE t1 (c1 REAL);",
          "64:   INSERT INTO t1(c1) VALUES (8366271098608253588);",
          "65:   INSERT INTO t0(c0) VALUES ('a');",
          "66: }",
          "67: set D [db one {SELECT c1 FROM t1}]",
          "69: do_execsql_test 2.4 {",
          "70:   SELECT * FROM t1 WHERE (t1.c1 = CAST(8366271098608253588 AS REAL));",
          "71: } $D",
          "73: do_execsql_test 2.5 {",
          "74:   SELECT * FROM t0, t1 WHERE (t1.c1 = CAST(8366271098608253588 AS REAL));",
          "75: } [list a $D]",
          "77: do_execsql_test 2.6 {",
          "78:   SELECT * FROM t0, t1",
          "79:   WHERE (",
          "80:         t1.c1 >= CAST(8366271098608253588 AS REAL)",
          "81:     AND t1.c1 <= CAST(8366271098608253588 AS REAL)",
          "82:   );",
          "83: } [list a $D]",
          "",
          "---------------"
        ]
      }
    }
  ]
}