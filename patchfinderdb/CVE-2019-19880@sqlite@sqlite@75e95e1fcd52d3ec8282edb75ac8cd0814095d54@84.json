{
  "cve_id": "CVE-2019-19880",
  "cve_desc": "exprListAppendList in window.c in SQLite 3.30.1 allows attackers to trigger an invalid pointer dereference because constant integer values in ORDER BY clauses of window definitions are mishandled.",
  "repo": "sqlite/sqlite",
  "patch_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
  "patch_info": {
    "commit_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/window.c"
    ],
    "message": "When processing constant integer values in ORDER BY clauses of window definitions (see check-in [7e4809eadfe99ebf]) be sure to fully disable the constant value to avoid an invalid pointer dereference if the expression is ever duplicated. This fixes a crash report from Yongheng and Rui.\n\nFossilOrigin-Name: 1ca0bd982ab1183bbafce0d260e4dceda5eb766ed2e7793374a88d1ae0bdd2ca",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/window.c||src/window.c"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8223e79f987feda5c8e51ec52cec6798cca16d070b10558939e2888ca1a25b8e",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/window.c||src/window.c": [
      "File: src/window.c -> src/window.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "895:     int nInit = pList ? pList->nExpr : 0;",
      "896:     for(i=0; i<pAppend->nExpr; i++){",
      "897:       Expr *pDup = sqlite3ExprDup(pParse->db, pAppend->a[i].pExpr, 0);",
      "898:       if( bIntToNull && pDup && pDup->op==TK_INTEGER ){",
      "899:         pDup->op = TK_NULL;",
      "900:         pDup->flags &= ~(EP_IntValue|EP_IsTrue|EP_IsFalse);",
      "901:       }",
      "902:       pList = sqlite3ExprListAppend(pParse, pList, pDup);",
      "903:       if( pList ) pList->a[nInit+i].sortFlags = pAppend->a[i].sortFlags;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "898:       assert( pDup==0 || !ExprHasProperty(pDup, EP_MemToken) );",
      "902:         pDup->u.zToken = 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f4b1d8dc17dcd01eb01f3cafb3614d37eee31e56",
      "candidate_info": {
        "commit_hash": "f4b1d8dc17dcd01eb01f3cafb3614d37eee31e56",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/f4b1d8dc17dcd01eb01f3cafb3614d37eee31e56",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c"
        ],
        "message": "Do not allow generated columns in the PRIMARY KEY.\n\nFossilOrigin-Name: 1a54743a3d327efc8ecc45b9fde91ddfea3fca36408f9b753453c31f2e4cc69c",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: d38176e93a628e03f1bd8b689fbc4152a1495388da917c2d89cefed04353d2d6",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1456:   }",
          "1457: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1462: static void makeColumnPartOfPrimaryKey(Parse *pParse, Column *pCol){",
          "1463:   pCol->colFlags |= COLFLAG_PRIMKEY;",
          "1464: #ifndef SQLITE_OMIT_GENERATED_COLUMNS",
          "1465:   if( pCol->colFlags & COLFLAG_GENERATED ){",
          "1466:     testcase( pCol->colFlags & COLFLAG_VIRTUAL );",
          "1467:     testcase( pCol->colFlags & COLFLAG_STORED );",
          "1468:     sqlite3ErrorMsg(pParse,",
          "1469:       \"generated columns cannot be part of the PRIMARY KEY\");",
          "1470:   }",
          "1471: #endif",
          "1472: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1495:   if( pList==0 ){",
          "1496:     iCol = pTab->nCol - 1;",
          "1497:     pCol = &pTab->aCol[iCol];",
          "1499:     nTerm = 1;",
          "1500:   }else{",
          "1501:     nTerm = pList->nExpr;",
          "",
          "[Removed Lines]",
          "1498:     pCol->colFlags |= COLFLAG_PRIMKEY;",
          "",
          "[Added Lines]",
          "1513:     makeColumnPartOfPrimaryKey(pParse, pCol);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1508:         for(iCol=0; iCol<pTab->nCol; iCol++){",
          "1509:           if( sqlite3StrICmp(zCName, pTab->aCol[iCol].zName)==0 ){",
          "1510:             pCol = &pTab->aCol[iCol];",
          "1512:             break;",
          "1513:           }",
          "1514:         }",
          "",
          "[Removed Lines]",
          "1511:             pCol->colFlags |= COLFLAG_PRIMKEY;",
          "",
          "[Added Lines]",
          "1526:             makeColumnPartOfPrimaryKey(pParse, pCol);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cc3f3d1f055e5bce28d7c7fa122ac5f922a7706b",
      "candidate_info": {
        "commit_hash": "cc3f3d1f055e5bce28d7c7fa122ac5f922a7706b",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/cc3f3d1f055e5bce28d7c7fa122ac5f922a7706b",
        "files": [
          "Makefile.in",
          "Makefile.msc",
          "main.mk",
          "manifest",
          "manifest.uuid",
          "src/pragma.c",
          "src/pragma.h",
          "src/shell.c.in",
          "test/pragma5.test",
          "tool/mkpragmatab.tcl"
        ],
        "message": "Activate introspection pragmas by default.  The new option SQLITE_OMIT_INTROSPECTION_PRAGMAS must be provided to keep them out.\n\nFossilOrigin-Name: 9c4bca64fb5f635296a8d7d7c1bf2808e02ca734a9983e5cee9132f5352a9a6d",
        "before_after_code_files": [
          "Makefile.in||Makefile.in",
          "Makefile.msc||Makefile.msc",
          "main.mk||main.mk",
          "manifest.uuid||manifest.uuid",
          "src/pragma.c||src/pragma.c",
          "src/pragma.h||src/pragma.h",
          "src/shell.c.in||src/shell.c.in",
          "test/pragma5.test||test/pragma5.test",
          "tool/mkpragmatab.tcl||tool/mkpragmatab.tcl"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "Makefile.in||Makefile.in": [
          "File: Makefile.in -> Makefile.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "609: SHELL_OPT += -DSQLITE_ENABLE_DBSTAT_VTAB",
          "610: SHELL_OPT += -DSQLITE_ENABLE_OFFSET_SQL_FUNC",
          "611: SHELL_OPT += -DSQLITE_ENABLE_DESERIALIZE",
          "613: FUZZERSHELL_OPT = -DSQLITE_ENABLE_JSON1",
          "614: FUZZCHECK_OPT = -DSQLITE_ENABLE_JSON1 -DSQLITE_ENABLE_MEMSYS5 -DSQLITE_OSS_FUZZ",
          "615: FUZZCHECK_OPT += -DSQLITE_MAX_MEMORY=50000000",
          "",
          "[Removed Lines]",
          "612: SHELL_OPT += -DSQLITE_INTROSPECTION_PRAGMAS",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "Makefile.msc||Makefile.msc": [
          "File: Makefile.msc -> Makefile.msc",
          "--- Hunk 1 ---",
          "[Context before]",
          "351: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_ENABLE_STMTVTAB=1",
          "352: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_ENABLE_DBPAGE_VTAB=1",
          "353: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_ENABLE_DBSTAT_VTAB=1",
          "355: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_ENABLE_DESERIALIZE=1",
          "356: !ENDIF",
          "357: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_ENABLE_COLUMN_METADATA=1",
          "",
          "[Removed Lines]",
          "354: OPT_FEATURE_FLAGS = $(OPT_FEATURE_FLAGS) -DSQLITE_INTROSPECTION_PRAGMAS=1",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "main.mk||main.mk": [
          "File: main.mk -> main.mk",
          "--- Hunk 1 ---",
          "[Context before]",
          "527: SHELL_OPT += -DSQLITE_ENABLE_DBPAGE_VTAB",
          "528: SHELL_OPT += -DSQLITE_ENABLE_DBSTAT_VTAB",
          "529: SHELL_OPT += -DSQLITE_ENABLE_OFFSET_SQL_FUNC",
          "531: FUZZERSHELL_OPT = -DSQLITE_ENABLE_JSON1",
          "532: FUZZCHECK_OPT = -DSQLITE_ENABLE_JSON1 -DSQLITE_ENABLE_MEMSYS5",
          "533: FUZZCHECK_OPT += -DSQLITE_MAX_MEMORY=50000000",
          "",
          "[Removed Lines]",
          "530: SHELL_OPT += -DSQLITE_INTROSPECTION_PRAGMAS",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: de767376987f7668b0770c4920f1532e341b5a27f797d69c0f5e92b87d036170",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/pragma.c||src/pragma.c": [
          "File: src/pragma.c -> src/pragma.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1245:   }",
          "1246:   break;",
          "1249:   case PragTyp_FUNCTION_LIST: {",
          "1250:     int i;",
          "1251:     HashElem *j;",
          "",
          "[Removed Lines]",
          "1248: #ifdef SQLITE_INTROSPECTION_PRAGMAS",
          "",
          "[Added Lines]",
          "1248: #ifndef SQLITE_OMIT_INTROSPECTION_PRAGMAS",
          "",
          "---------------"
        ],
        "src/pragma.h||src/pragma.h": [
          "File: src/pragma.h -> src/pragma.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "312: #endif",
          "313: #if !defined(SQLITE_OMIT_SCHEMA_PRAGMAS)",
          "315:  {/* zName:     */ \"function_list\",",
          "",
          "[Removed Lines]",
          "314: #if defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "",
          "[Added Lines]",
          "314: #if !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "435: #endif",
          "436: #if !defined(SQLITE_OMIT_SCHEMA_PRAGMAS)",
          "437: #if !defined(SQLITE_OMIT_VIRTUALTABLE)",
          "439:  {/* zName:     */ \"module_list\",",
          "",
          "[Removed Lines]",
          "438: #if defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "",
          "[Added Lines]",
          "438: #if !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "471: #endif",
          "472: #endif",
          "474:  {/* zName:     */ \"pragma_list\",",
          "",
          "[Removed Lines]",
          "473: #if defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "",
          "[Added Lines]",
          "473: #if !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "8461:         appendText(&sSelect, \".sqlite_master\", 0);",
          "8462:       }",
          "8463:       sqlite3_finalize(pStmt);",
          "8465:       if( zName ){",
          "8466:         appendText(&sSelect,",
          "8467:            \" UNION ALL SELECT shell_module_schema(name),\"",
          "",
          "[Removed Lines]",
          "8464: #ifdef SQLITE_INTROSPECTION_PRAGMAS",
          "",
          "[Added Lines]",
          "8464: #ifndef SQLITE_OMIT_INTROSPECTION_PRAGMAS",
          "",
          "---------------"
        ],
        "test/pragma5.test||test/pragma5.test": [
          "File: test/pragma5.test -> test/pragma5.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: # This file implements regression tests for SQLite library.",
          "12: #",
          "13: # This file implements tests for the PRAGMA command. Specifically,",
          "15: #",
          "17: #",
          "19: set testdir [file dirname $argv0]",
          "",
          "[Removed Lines]",
          "14: # those pragmas enabled at build time by setting:",
          "16: #   -DSQLITE_INTROSPECTION_PRAGMAS",
          "",
          "[Added Lines]",
          "14: # those pragmas that are not disabled at build time by setting:",
          "16: #   -DSQLITE_OMIT_INTROSPECTION_PRAGMAS",
          "",
          "---------------"
        ],
        "tool/mkpragmatab.tcl||tool/mkpragmatab.tcl": [
          "File: tool/mkpragmatab.tcl -> tool/mkpragmatab.tcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "264:   FLAG: Result0",
          "265:   COLS: name builtin",
          "266:   IF:   !defined(SQLITE_OMIT_SCHEMA_PRAGMAS)",
          "269:   NAME: module_list",
          "270:   FLAG: Result0",
          "271:   COLS: name",
          "272:   IF:   !defined(SQLITE_OMIT_SCHEMA_PRAGMAS)",
          "273:   IF:   !defined(SQLITE_OMIT_VIRTUALTABLE)",
          "276:   NAME: pragma_list",
          "277:   FLAG: Result0",
          "278:   COLS: name",
          "281:   NAME: collation_list",
          "282:   FLAG: Result0",
          "",
          "[Removed Lines]",
          "267:   IF:   defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "274:   IF:   defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "279:   IF:   defined(SQLITE_INTROSPECTION_PRAGMAS)",
          "",
          "[Added Lines]",
          "267:   IF:   !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "274:   IF:   !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "279:   IF:   !defined(SQLITE_OMIT_INTROSPECTION_PRAGMAS)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c7694a6d1d9c0c3f6b5a0bcfb8ba07d999b9992f",
      "candidate_info": {
        "commit_hash": "c7694a6d1d9c0c3f6b5a0bcfb8ba07d999b9992f",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c7694a6d1d9c0c3f6b5a0bcfb8ba07d999b9992f",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/window.c",
          "test/window1.test"
        ],
        "message": "Remove assert() statements based on the counter-factual proposition that 0 is not a valid cursor number.\n\nFossilOrigin-Name: c7b336181aac6785a515f275c0f50ad4bf2dee20abde959b56d968a7fdce3e5b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/window.c||src/window.c",
          "test/window1.test||test/window1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: ec7e224f50271a69a28074270b01328ec0ee38751fcb93b2c598d8be2b77a95d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1262:     else if( p->zName==nth_valueName || p->zName==first_valueName ){",
          "1266:       pWin->regApp = pParse->nMem+1;",
          "1267:       pWin->csrApp = pParse->nTab++;",
          "1268:       pParse->nMem += 2;",
          "1269:       sqlite3VdbeAddOp2(v, OP_OpenDup, pWin->csrApp, pMWin->iEphCsr);",
          "1270:     }",
          "1271:     else if( p->zName==leadName || p->zName==lagName ){",
          "1273:       pWin->csrApp = pParse->nTab++;",
          "1274:       sqlite3VdbeAddOp2(v, OP_OpenDup, pWin->csrApp, pMWin->iEphCsr);",
          "1275:     }",
          "",
          "[Removed Lines]",
          "1265:       assert( pMWin->iEphCsr );",
          "1272:       assert( pMWin->iEphCsr );",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/window1.test||test/window1.test": [
          "File: test/window1.test -> test/window1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1027:   FROM t5",
          "1028: } 3",
          "1030: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1030: do_execsql_test 24.1 {",
          "1031:   SELECT sum(44) OVER ()",
          "1032: } {44}",
          "1034: do_execsql_test 24.2 {",
          "1035:   SELECT lead(44) OVER ()",
          "1036: } {{}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4bec44bdfa1fea3374a8e262b6a8da6fc79f08b8",
      "candidate_info": {
        "commit_hash": "4bec44bdfa1fea3374a8e262b6a8da6fc79f08b8",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/4bec44bdfa1fea3374a8e262b6a8da6fc79f08b8",
        "files": [
          "ext/misc/fossildelta.c",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Add the fossildelta.c extension in ext/misc with implementations of the Fossil delta functions.\n\nFossilOrigin-Name: b80cafa6f8a5c6ff1dc9efd2f670777ab131ace2df1eb431cedc8cfa901baf18",
        "before_after_code_files": [
          "ext/misc/fossildelta.c||ext/misc/fossildelta.c",
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/misc/fossildelta.c||ext/misc/fossildelta.c": [
          "File: ext/misc/fossildelta.c -> ext/misc/fossildelta.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: #include <string.h>",
          "16: #include <assert.h>",
          "17: #include <stdlib.h>",
          "18: #include \"sqlite3ext.h\"",
          "19: SQLITE_EXTENSION_INIT1",
          "24: typedef unsigned int u32;",
          "29: typedef short int s16;",
          "30: typedef unsigned short int u16;",
          "37: #define NHASH 16",
          "51: typedef struct hash hash;",
          "52: struct hash {",
          "56: };",
          "61: static void hash_init(hash *pHash, const char *z){",
          "62:   u16 a, b, i;",
          "63:   a = b = z[0];",
          "64:   for(i=1; i<NHASH; i++){",
          "65:     a += z[i];",
          "66:     b += a;",
          "67:   }",
          "68:   memcpy(pHash->z, z, NHASH);",
          "69:   pHash->a = a & 0xffff;",
          "70:   pHash->b = b & 0xffff;",
          "71:   pHash->i = 0;",
          "72: }",
          "77: static void hash_next(hash *pHash, int c){",
          "78:   u16 old = pHash->z[pHash->i];",
          "79:   pHash->z[pHash->i] = c;",
          "80:   pHash->i = (pHash->i+1)&(NHASH-1);",
          "81:   pHash->a = pHash->a - old + c;",
          "82:   pHash->b = pHash->b - NHASH*old + pHash->a;",
          "83: }",
          "88: static u32 hash_32bit(hash *pHash){",
          "89:   return (pHash->a & 0xffff) | (((u32)(pHash->b & 0xffff))<<16);",
          "90: }",
          "100: static u32 hash_once(const char *z){",
          "101:   u16 a, b, i;",
          "102:   a = b = z[0];",
          "103:   for(i=1; i<NHASH; i++){",
          "104:     a += z[i];",
          "105:     b += a;",
          "106:   }",
          "107:   return a | (((u32)b)<<16);",
          "108: }",
          "113: static void putInt(unsigned int v, char **pz){",
          "114:   static const char zDigits[] =",
          "115:     \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz~\";",
          "117:   int i, j;",
          "118:   char zBuf[20];",
          "119:   if( v==0 ){",
          "121:     return;",
          "122:   }",
          "123:   for(i=0; v>0; i++, v>>=6){",
          "124:     zBuf[i] = zDigits[v&0x3f];",
          "125:   }",
          "126:   for(j=i-1; j>=0; j--){",
          "128:   }",
          "129: }",
          "137: static unsigned int getInt(const char **pz, int *pLen){",
          "138:   static const signed char zValue[] = {",
          "139:     -1, -1, -1, -1, -1, -1, -1, -1,   -1, -1, -1, -1, -1, -1, -1, -1,",
          "140:     -1, -1, -1, -1, -1, -1, -1, -1,   -1, -1, -1, -1, -1, -1, -1, -1,",
          "141:     -1, -1, -1, -1, -1, -1, -1, -1,   -1, -1, -1, -1, -1, -1, -1, -1,",
          "142:      0,  1,  2,  3,  4,  5,  6,  7,    8,  9, -1, -1, -1, -1, -1, -1,",
          "143:     -1, 10, 11, 12, 13, 14, 15, 16,   17, 18, 19, 20, 21, 22, 23, 24,",
          "144:     25, 26, 27, 28, 29, 30, 31, 32,   33, 34, 35, -1, -1, -1, -1, 36,",
          "145:     -1, 37, 38, 39, 40, 41, 42, 43,   44, 45, 46, 47, 48, 49, 50, 51,",
          "146:     52, 53, 54, 55, 56, 57, 58, 59,   60, 61, 62, -1, -1, -1, 63, -1,",
          "147:   };",
          "148:   unsigned int v = 0;",
          "149:   int c;",
          "150:   unsigned char *z = (unsigned char*)*pz;",
          "151:   unsigned char *zStart = z;",
          "152:   while( (c = zValue[0x7f&*(z++)])>=0 ){",
          "153:      v = (v<<6) + c;",
          "154:   }",
          "155:   z--;",
          "158:   return v;",
          "159: }",
          "164: static int digit_count(int v){",
          "165:   unsigned int i, x;",
          "166:   for(i=1, x=64; v>=x; i++, x <<= 6){}",
          "167:   return i;",
          "168: }",
          "170: #ifdef __GNUC__",
          "171: # define GCC_VERSION (__GNUC__*1000000+__GNUC_MINOR__*1000+__GNUC_PATCHLEVEL__)",
          "172: #else",
          "173: # define GCC_VERSION 0",
          "174: #endif",
          "182: static unsigned int checksum(const char *zIn, size_t N){",
          "183:   static const int byteOrderTest = 1;",
          "184:   const unsigned char *z = (const unsigned char *)zIn;",
          "185:   const unsigned char *zEnd = (const unsigned char*)&zIn[N&~3];",
          "186:   unsigned sum = 0;",
          "188:   if( 0==*(char*)&byteOrderTest ){",
          "190:     while( z<zEnd ){",
          "191:       sum += *(unsigned*)z;",
          "192:       z += 4;",
          "193:     }",
          "194:   }else{",
          "196: #if GCC_VERSION>=4003000",
          "197:     while( z<zEnd ){",
          "198:       sum += __builtin_bswap32(*(unsigned*)z);",
          "199:       z += 4;",
          "200:     }",
          "201: #elif defined(_MSC_VER) && _MSC_VER>=1300",
          "202:     while( z<zEnd ){",
          "203:       sum += _byteswap_ulong(*(unsigned*)z);",
          "204:       z += 4;",
          "205:     }",
          "206: #else",
          "207:     unsigned sum0 = 0;",
          "208:     unsigned sum1 = 0;",
          "209:     unsigned sum2 = 0;",
          "210:     while(N >= 16){",
          "211:       sum0 += ((unsigned)z[0] + z[4] + z[8] + z[12]);",
          "212:       sum1 += ((unsigned)z[1] + z[5] + z[9] + z[13]);",
          "213:       sum2 += ((unsigned)z[2] + z[6] + z[10]+ z[14]);",
          "214:       sum  += ((unsigned)z[3] + z[7] + z[11]+ z[15]);",
          "215:       z += 16;",
          "216:       N -= 16;",
          "217:     }",
          "218:     while(N >= 4){",
          "219:       sum0 += z[0];",
          "220:       sum1 += z[1];",
          "221:       sum2 += z[2];",
          "222:       sum  += z[3];",
          "223:       z += 4;",
          "224:       N -= 4;",
          "225:     }",
          "226:     sum += (sum2 << 8) + (sum1 << 16) + (sum0 << 24);",
          "227: #endif",
          "228:   }",
          "229:   switch(N&3){",
          "230:     case 3:   sum += (z[2] << 8);",
          "231:     case 2:   sum += (z[1] << 16);",
          "232:     case 1:   sum += (z[0] << 24);",
          "233:     default:  ;",
          "234:   }",
          "235:   return sum;",
          "236: }",
          "299: static int delta_create(",
          "305: ){",
          "306:   int i, base;",
          "307:   char *zOrigDelta = zDelta;",
          "308:   hash h;",
          "316:   putInt(lenOut, &zDelta);",
          "323:   if( lenSrc<=NHASH ){",
          "324:     putInt(lenOut, &zDelta);",
          "326:     memcpy(zDelta, zOut, lenOut);",
          "327:     zDelta += lenOut;",
          "328:     putInt(checksum(zOut, lenOut), &zDelta);",
          "330:     return zDelta - zOrigDelta;",
          "331:   }",
          "336:   nHash = lenSrc/NHASH;",
          "337:   collide = sqlite3_malloc64( (sqlite3_int64)nHash*2*sizeof(int) );",
          "338:   memset(collide, -1, nHash*2*sizeof(int));",
          "339:   landmark = &collide[nHash];",
          "340:   for(i=0; i<lenSrc-NHASH; i+=NHASH){",
          "341:     int hv = hash_once(&zSrc[i]) % nHash;",
          "342:     collide[i/NHASH] = landmark[hv];",
          "343:     landmark[hv] = i/NHASH;",
          "344:   }",
          "350:   while( base+NHASH<lenOut ){",
          "351:     int iSrc, iBlock;",
          "352:     unsigned int bestCnt, bestOfst=0, bestLitsz=0;",
          "353:     hash_init(&h, &zOut[base]);",
          "355:     bestCnt = 0;",
          "356:     while( 1 ){",
          "357:       int hv;",
          "358:       int limit = 250;",
          "360:       hv = hash_32bit(&h) % nHash;",
          "361:       iBlock = landmark[hv];",
          "362:       while( iBlock>=0 && (limit--)>0 ){",
          "378:         int cnt, ofst, litsz;",
          "379:         int j, k, x, y;",
          "380:         int sz;",
          "381:         int limitX;",
          "385:         iSrc = iBlock*NHASH;",
          "386:         y = base+i;",
          "387:         limitX = ( lenSrc-iSrc <= lenOut-y ) ? lenSrc : iSrc + lenOut - y;",
          "388:         for(x=iSrc; x<limitX; x++, y++){",
          "389:           if( zSrc[x]!=zOut[y] ) break;",
          "390:         }",
          "391:         j = x - iSrc - 1;",
          "395:         for(k=1; k<iSrc && k<=i; k++){",
          "396:           if( zSrc[iSrc-k]!=zOut[base+i-k] ) break;",
          "397:         }",
          "398:         k--;",
          "401:         ofst = iSrc-k;",
          "402:         cnt = j+k+1;",
          "406:         sz = digit_count(i-k)+digit_count(cnt)+digit_count(ofst)+3;",
          "407:         if( cnt>=sz && cnt>bestCnt ){",
          "410:           bestCnt = cnt;",
          "411:           bestOfst = iSrc-k;",
          "412:           bestLitsz = litsz;",
          "413:         }",
          "416:         iBlock = collide[iBlock];",
          "417:       }",
          "422:       if( bestCnt>0 ){",
          "423:         if( bestLitsz>0 ){",
          "425:           putInt(bestLitsz,&zDelta);",
          "427:           memcpy(zDelta, &zOut[base], bestLitsz);",
          "428:           zDelta += bestLitsz;",
          "429:           base += bestLitsz;",
          "430:         }",
          "431:         base += bestCnt;",
          "432:         putInt(bestCnt, &zDelta);",
          "434:         putInt(bestOfst, &zDelta);",
          "436:         if( bestOfst + bestCnt -1 > lastRead ){",
          "437:           lastRead = bestOfst + bestCnt - 1;",
          "438:         }",
          "439:         bestCnt = 0;",
          "440:         break;",
          "441:       }",
          "444:       if( base+i+NHASH>=lenOut ){",
          "447:         putInt(lenOut-base, &zDelta);",
          "449:         memcpy(zDelta, &zOut[base], lenOut-base);",
          "450:         zDelta += lenOut-base;",
          "451:         base = lenOut;",
          "452:         break;",
          "453:       }",
          "456:       hash_next(&h, zOut[base+i+NHASH]);",
          "457:       i++;",
          "458:     }",
          "459:   }",
          "463:   if( base<lenOut ){",
          "464:     putInt(lenOut-base, &zDelta);",
          "466:     memcpy(zDelta, &zOut[base], lenOut-base);",
          "467:     zDelta += lenOut-base;",
          "468:   }",
          "470:   putInt(checksum(zOut, lenOut), &zDelta);",
          "472:   sqlite3_free(collide);",
          "473:   return zDelta - zOrigDelta;",
          "474: }",
          "485: static int delta_output_size(const char *zDelta, int lenDelta){",
          "486:   int size;",
          "487:   size = getInt(&zDelta, &lenDelta);",
          "488:   if( *zDelta!='\\n' ){",
          "490:     return -1;",
          "491:   }",
          "492:   return size;",
          "493: }",
          "516: static int delta_apply(",
          "522: ){",
          "523:   unsigned int limit;",
          "524:   unsigned int total = 0;",
          "525: #ifdef FOSSIL_ENABLE_DELTA_CKSUM_TEST",
          "526:   char *zOrigOut = zOut;",
          "527: #endif",
          "529:   limit = getInt(&zDelta, &lenDelta);",
          "530:   if( *zDelta!='\\n' ){",
          "532:     return -1;",
          "533:   }",
          "534:   zDelta++; lenDelta--;",
          "535:   while( *zDelta && lenDelta>0 ){",
          "536:     unsigned int cnt, ofst;",
          "537:     cnt = getInt(&zDelta, &lenDelta);",
          "538:     switch( zDelta[0] ){",
          "539:       case '@': {",
          "540:         zDelta++; lenDelta--;",
          "541:         ofst = getInt(&zDelta, &lenDelta);",
          "542:         if( lenDelta>0 && zDelta[0]!=',' ){",
          "544:           return -1;",
          "545:         }",
          "546:         zDelta++; lenDelta--;",
          "547:         total += cnt;",
          "548:         if( total>limit ){",
          "550:           return -1;",
          "551:         }",
          "552:         if( ofst+cnt > lenSrc ){",
          "554:           return -1;",
          "555:         }",
          "556:         memcpy(zOut, &zSrc[ofst], cnt);",
          "557:         zOut += cnt;",
          "558:         break;",
          "559:       }",
          "560:       case ':': {",
          "561:         zDelta++; lenDelta--;",
          "562:         total += cnt;",
          "563:         if( total>limit ){",
          "565:           return -1;",
          "566:         }",
          "567:         if( cnt>lenDelta ){",
          "569:           return -1;",
          "570:         }",
          "571:         memcpy(zOut, zDelta, cnt);",
          "572:         zOut += cnt;",
          "573:         zDelta += cnt;",
          "574:         lenDelta -= cnt;",
          "575:         break;",
          "576:       }",
          "577:       case ';': {",
          "578:         zDelta++; lenDelta--;",
          "579:         zOut[0] = 0;",
          "580: #ifdef FOSSIL_ENABLE_DELTA_CKSUM_TEST",
          "581:         if( cnt!=checksum(zOrigOut, total) ){",
          "583:           return -1;",
          "584:         }",
          "585: #endif",
          "586:         if( total!=limit ){",
          "588:           return -1;",
          "589:         }",
          "590:         return total;",
          "591:       }",
          "592:       default: {",
          "594:         return -1;",
          "595:       }",
          "596:     }",
          "597:   }",
          "599:   return -1;",
          "600: }",
          "607: static int delta_analyze(",
          "612: ){",
          "613:   unsigned int nInsert = 0;",
          "614:   unsigned int nCopy = 0;",
          "616:   (void)getInt(&zDelta, &lenDelta);",
          "617:   if( *zDelta!='\\n' ){",
          "619:     return -1;",
          "620:   }",
          "621:   zDelta++; lenDelta--;",
          "622:   while( *zDelta && lenDelta>0 ){",
          "623:     unsigned int cnt;",
          "624:     cnt = getInt(&zDelta, &lenDelta);",
          "625:     switch( zDelta[0] ){",
          "626:       case '@': {",
          "627:         zDelta++; lenDelta--;",
          "628:         (void)getInt(&zDelta, &lenDelta);",
          "629:         if( lenDelta>0 && zDelta[0]!=',' ){",
          "631:           return -1;",
          "632:         }",
          "633:         zDelta++; lenDelta--;",
          "634:         nCopy += cnt;",
          "635:         break;",
          "636:       }",
          "637:       case ':': {",
          "638:         zDelta++; lenDelta--;",
          "639:         nInsert += cnt;",
          "640:         if( cnt>lenDelta ){",
          "642:           return -1;",
          "643:         }",
          "644:         zDelta += cnt;",
          "645:         lenDelta -= cnt;",
          "646:         break;",
          "647:       }",
          "648:       case ';': {",
          "651:         return 0;",
          "652:       }",
          "653:       default: {",
          "655:         return -1;",
          "656:       }",
          "657:     }",
          "658:   }",
          "660:   return -1;",
          "661: }",
          "668: static void deltaCreateFunc(",
          "669:   sqlite3_context *context,",
          "670:   int argc,",
          "671:   sqlite3_value **argv",
          "672: ){",
          "677:   assert( argc==2 );",
          "678:   if( sqlite3_value_type(argv[0])==SQLITE_NULL ) return;",
          "679:   if( sqlite3_value_type(argv[1])==SQLITE_NULL ) return;",
          "680:   nOrig = sqlite3_value_bytes(argv[0]);",
          "681:   aOrig = (const char*)sqlite3_value_blob(argv[0]);",
          "682:   nNew = sqlite3_value_bytes(argv[1]);",
          "683:   aNew = (const char*)sqlite3_value_blob(argv[1]);",
          "684:   aOut = sqlite3_malloc64(nNew+70);",
          "685:   if( aOut==0 ){",
          "686:     sqlite3_result_error_nomem(context);",
          "687:   }else{",
          "688:     nOut = delta_create(aOrig, nOrig, aNew, nNew, aOut);",
          "689:     if( nOut<0 ){",
          "690:       sqlite3_free(aOut);",
          "691:       sqlite3_result_error(context, \"cannot create fossil delta\", -1);",
          "692:     }else{",
          "693:       sqlite3_result_blob(context, aOut, nOut, sqlite3_free);",
          "694:     }",
          "695:   }",
          "696: }",
          "703: static void deltaApplyFunc(",
          "704:   sqlite3_context *context,",
          "705:   int argc,",
          "706:   sqlite3_value **argv",
          "707: ){",
          "712:   assert( argc==2 );",
          "713:   if( sqlite3_value_type(argv[0])==SQLITE_NULL ) return;",
          "714:   if( sqlite3_value_type(argv[1])==SQLITE_NULL ) return;",
          "715:   nOrig = sqlite3_value_bytes(argv[0]);",
          "716:   aOrig = (const char*)sqlite3_value_blob(argv[0]);",
          "717:   nDelta = sqlite3_value_bytes(argv[1]);",
          "718:   aDelta = (const char*)sqlite3_value_blob(argv[1]);",
          "721:   nOut = delta_output_size(aDelta, nDelta);",
          "722:   if( nOut<0 ){",
          "723:     sqlite3_result_error(context, \"corrupt fossil delta\", -1);",
          "724:     return;",
          "725:   }",
          "726:   aOut = sqlite3_malloc64((sqlite3_int64)nOut+1);",
          "727:   if( aOut==0 ){",
          "728:     sqlite3_result_error_nomem(context);",
          "729:   }else{",
          "730:     nOut2 = delta_apply(aOrig, nOrig, aDelta, nDelta, aOut);",
          "731:     if( nOut2!=nOut ){",
          "732:       sqlite3_free(aOut);",
          "733:       sqlite3_result_error(context, \"corrupt fossil delta\", -1);",
          "734:     }else{",
          "735:       sqlite3_result_blob(context, aOut, nOut, sqlite3_free);",
          "736:     }",
          "737:   }",
          "738: }",
          "746: static void deltaOutputSizeFunc(",
          "747:   sqlite3_context *context,",
          "748:   int argc,",
          "749:   sqlite3_value **argv",
          "750: ){",
          "753:   assert( argc==1 );",
          "754:   if( sqlite3_value_type(argv[0])==SQLITE_NULL ) return;",
          "755:   nDelta = sqlite3_value_bytes(argv[0]);",
          "756:   aDelta = (const char*)sqlite3_value_blob(argv[0]);",
          "759:   nOut = delta_output_size(aDelta, nDelta);",
          "760:   if( nOut<0 ){",
          "761:     sqlite3_result_error(context, \"corrupt fossil delta\", -1);",
          "762:     return;",
          "763:   }else{",
          "764:     sqlite3_result_int(context, nOut);",
          "765:   }",
          "766: }",
          "769: #ifdef _WIN32",
          "770: __declspec(dllexport)",
          "771: #endif",
          "772: int sqlite3_fossildelta_init(",
          "773:   sqlite3 *db,",
          "774:   char **pzErrMsg,",
          "775:   const sqlite3_api_routines *pApi",
          "776: ){",
          "777:   int rc = SQLITE_OK;",
          "778:   SQLITE_EXTENSION_INIT2(pApi);",
          "780:   rc = sqlite3_create_function(db, \"delta_create\", 2, SQLITE_UTF8, 0,",
          "781:                                deltaCreateFunc, 0, 0);",
          "782:   if( rc==SQLITE_OK ){",
          "783:     rc = sqlite3_create_function(db, \"delta_apply\", 2, SQLITE_UTF8, 0,",
          "784:                                  deltaApplyFunc, 0, 0);",
          "785:   }",
          "786:   if( rc==SQLITE_OK ){",
          "787:     rc = sqlite3_create_function(db, \"delta_output_size\", 1, SQLITE_UTF8, 0,",
          "788:                                  deltaOutputSizeFunc, 0, 0);",
          "789:   }",
          "790:   return rc;",
          "791: }",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 12517d1b15da46bc90bd95bb9c161d7f2ecdd7f28b1b3a5ed4397939ef986061",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "58ed374370522f7da3ec6d81d3c968e172399bb1",
      "candidate_info": {
        "commit_hash": "58ed374370522f7da3ec6d81d3c968e172399bb1",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/58ed374370522f7da3ec6d81d3c968e172399bb1",
        "files": [
          "ext/rtree/rtree6.test",
          "manifest",
          "manifest.uuid",
          "src/where.c"
        ],
        "message": "Fix a problem triggered by DELETE statements with WHERE clauses that use the OR-optimization on some virtual tables.\n\nFossilOrigin-Name: ecf5caa7e9825a8b03d15ee525ec68be78c55926ddfaca27a040a7614caf0e85",
        "before_after_code_files": [
          "ext/rtree/rtree6.test||ext/rtree/rtree6.test",
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/rtree/rtree6.test||ext/rtree/rtree6.test": [
          "File: ext/rtree/rtree6.test -> ext/rtree/rtree6.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "15:   set testdir [file join [file dirname [info script]] .. .. test]",
          "16: }",
          "17: source $testdir/tester.tcl",
          "19: ifcapable {!rtree || rtree_int_only} {",
          "20:   finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "18: set testprefix rtree6",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "167:     x1>0.5 AND x1>0.5 AND x1>0.5 AND x1>0.5 AND x1>1.1",
          "168: } {}",
          "170: expand_all_sql db",
          "171: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "171: #-------------------------------------------------------------------------",
          "172: reset_db",
          "173: do_execsql_test 4.0 {",
          "174:   CREATE VIRTUAL TABLE t1 USING rtree(id,x0,x1,y0,y1);",
          "175: }",
          "176: do_execsql_test 4.1 {",
          "177:   DELETE FROM t1 WHERE x0>1 AND x1<2 OR y0<92;",
          "178: }",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 0bf1550507d9d3c8a41f8a50db3a59bf808f0a4e24637dc0905d35579305eca7",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4919:   if( (wctrlFlags & WHERE_ONEPASS_DESIRED)!=0 ){",
          "4920:     int wsFlags = pWInfo->a[0].pWLoop->wsFlags;",
          "4921:     int bOnerow = (wsFlags & WHERE_ONEROW)!=0;",
          "4922:     if( bOnerow || (",
          "4923:         0!=(wctrlFlags & WHERE_ONEPASS_MULTIROW)",
          "4925:      && (0==(wsFlags & WHERE_MULTI_OR) || (wctrlFlags & WHERE_DUPLICATES_OK))",
          "4926:     )){",
          "4927:       pWInfo->eOnePass = bOnerow ? ONEPASS_SINGLE : ONEPASS_MULTI;",
          "",
          "[Removed Lines]",
          "4924:      && 0==(wsFlags & WHERE_VIRTUALTABLE)",
          "",
          "[Added Lines]",
          "4922:     assert( !(wsFlags & WHERE_VIRTUALTABLE) || IsVirtual(pTabList->a[0].pTab) );",
          "4925:      && !IsVirtual(pTabList->a[0].pTab)",
          "",
          "---------------"
        ]
      }
    }
  ]
}