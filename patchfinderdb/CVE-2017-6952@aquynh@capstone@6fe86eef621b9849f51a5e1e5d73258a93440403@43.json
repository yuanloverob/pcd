{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7a274e24fb56e8af961ff5d7e6ff74ca5a168f0a",
      "candidate_info": {
        "commit_hash": "7a274e24fb56e8af961ff5d7e6ff74ca5a168f0a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/7a274e24fb56e8af961ff5d7e6ff74ca5a168f0a",
        "files": [
          "Makefile",
          "make.sh"
        ],
        "message": "Add posibility to disable universal build for osx",
        "before_after_code_files": [
          "make.sh||make.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "make.sh||make.sh": [
          "File: make.sh -> make.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "140:   \"ios_armv7s\" ) build_iOS armv7s $*;;",
          "141:   \"ios_arm64\" ) build_iOS arm64 $*;;",
          "142:   \"osx-kernel\" ) CAPSTONE_USE_SYS_DYN_MEM=yes CAPSTONE_HAS_OSXKERNEL=yes CAPSTONE_ARCHS=x86 CAPSTONE_SHARED=no CAPSTONE_BUILD_CORE_ONLY=yes build $*;;",
          "144:     echo \"Usage: $0 [\"`grep '^  \"' $0 | cut -d '\"' -f 2 | tr \"\\\\n\" \"|\"`\"]\"",
          "145:     exit 1;;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "143:   \"mac-universal-no\" ) MACOS_UNIVERSAL=no ${MAKE} $*;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cbb151b026485ebb2f8f693e0c38f5a0b5313867",
      "candidate_info": {
        "commit_hash": "cbb151b026485ebb2f8f693e0c38f5a0b5313867",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/cbb151b026485ebb2f8f693e0c38f5a0b5313867",
        "files": [
          "arch/X86/X86MappingInsnOp.inc",
          "arch/X86/X86MappingInsnOp_reduce.inc"
        ],
        "message": "fixed MOVABS flags",
        "before_after_code_files": [
          "arch/X86/X86MappingInsnOp.inc||arch/X86/X86MappingInsnOp.inc",
          "arch/X86/X86MappingInsnOp_reduce.inc||arch/X86/X86MappingInsnOp_reduce.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86MappingInsnOp.inc||arch/X86/X86MappingInsnOp.inc": [
          "File: arch/X86/X86MappingInsnOp.inc -> arch/X86/X86MappingInsnOp.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "5615: },",
          "5617:  0,",
          "5619: },",
          "5621:  0,",
          "",
          "[Removed Lines]",
          "5618:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "5618:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5683: },",
          "5685:  0,",
          "5687: },",
          "5689:  0,",
          "",
          "[Removed Lines]",
          "5686:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "5686:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "5763: },",
          "5765:  0,",
          "5767: },",
          "5769:  0,",
          "",
          "[Removed Lines]",
          "5766:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "5766:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "5859: },",
          "5861:  0,",
          "5863: },",
          "5865:  0,",
          "",
          "[Removed Lines]",
          "5862:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "5862:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------"
        ],
        "arch/X86/X86MappingInsnOp_reduce.inc||arch/X86/X86MappingInsnOp_reduce.inc": [
          "File: arch/X86/X86MappingInsnOp_reduce.inc -> arch/X86/X86MappingInsnOp_reduce.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "2871: },",
          "2873:  0,",
          "2875: },",
          "2877:  0,",
          "",
          "[Removed Lines]",
          "2874:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "2874:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2939: },",
          "2941:  0,",
          "2943: },",
          "2945:  0,",
          "",
          "[Removed Lines]",
          "2942:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "2942:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3019: },",
          "3021:  0,",
          "3023: },",
          "3025:  0,",
          "",
          "[Removed Lines]",
          "3022:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "3022:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3099: },",
          "3101:  0,",
          "3103: },",
          "3105:  0,",
          "",
          "[Removed Lines]",
          "3102:  { CS_AC_IGNORE, CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "3102:  { CS_AC_WRITE, CS_AC_READ, 0 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3e6f90376eba980beb5a9c05df81fc9ccef1e272",
      "candidate_info": {
        "commit_hash": "3e6f90376eba980beb5a9c05df81fc9ccef1e272",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/3e6f90376eba980beb5a9c05df81fc9ccef1e272",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: version 2 could print all debug information for all arch.",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "324:     }",
          "325:    }",
          "326:    printf(\"  %s\\t%s\\n\", insn[i].mnemonic, insn[i].op_str);",
          "328:                 if (!strcmp(arch, \"x86\")) {",
          "329:                     print_insn_detail_x86(handle, md, &insn[i]);",
          "330:                 }",
          "",
          "[Removed Lines]",
          "327:             if (debug_flag) {//different mode should call different print functions",
          "",
          "[Added Lines]",
          "327:             if (debug_flag) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "59df5507c1b20f65c8360050e61cceccd5bc4d5e",
      "candidate_info": {
        "commit_hash": "59df5507c1b20f65c8360050e61cceccd5bc4d5e",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/59df5507c1b20f65c8360050e61cceccd5bc4d5e",
        "files": [
          "HACK.TXT",
          "contrib/cs_driver/cs_driver/cs_driver.c",
          "cs.c",
          "include/platform.h",
          "tests/README",
          "tests/test_winkernel.cpp"
        ],
        "message": "edit documents and comments",
        "before_after_code_files": [
          "contrib/cs_driver/cs_driver/cs_driver.c||contrics_driver/cs_driver/cs_driver.c",
          "cs.c||cs.c",
          "include/platform.h||include/platform.h",
          "tests/test_winkernel.cpp||tests/test_winkernel.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "contrib/cs_driver/cs_driver/cs_driver.c||contrics_driver/cs_driver/cs_driver.c": [
          "File: contrib/cs_driver/cs_driver/cs_driver.c -> contrics_driver/cs_driver/cs_driver.c"
        ],
        "cs.c||cs.c": [
          "File: cs.c -> cs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "340:  switch(handle->arch) {",
          "341:   default:",
          "344:   case CS_ARCH_ARM:",
          "346:    if (handle->mode & CS_MODE_THUMB)",
          "",
          "[Removed Lines]",
          "343:    return -1;",
          "",
          "[Added Lines]",
          "343:    return (uint8_t)-1;",
          "",
          "---------------"
        ],
        "include/platform.h||include/platform.h": [
          "File: include/platform.h -> include/platform.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: #include <stdbool.h>",
          "23: #endif",
          "27: #include <stdbool.h>",
          "28: #endif",
          "",
          "[Removed Lines]",
          "25: #else",
          "",
          "[Added Lines]",
          "25: #else",
          "",
          "---------------"
        ],
        "tests/test_winkernel.cpp||tests/test_winkernel.cpp": [
          "File: tests/test_winkernel.cpp -> tests/test_winkernel.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: }",
          "14: #endif",
          "16: #pragma warning(push)",
          "",
          "[Removed Lines]",
          "17: #pragma warning(disable : 4005)  // 'identifier' : macro redefinition",
          "18: #pragma warning(disable : 4007)  // 'main': must be '__cdecl'",
          "",
          "[Added Lines]",
          "16: EXTERN_C DRIVER_INITIALIZE DriverEntry;",
          "19: #pragma warning(disable : 4005)   // 'identifier' : macro redefinition",
          "20: #pragma warning(disable : 4007)   // 'main': must be '__cdecl'",
          "25: #pragma warning(disable : 28110)  // Suppress this, as it is false positive.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "26: #include \"test.c\"",
          "27: }  // namespace unnamed",
          "37: namespace detail {",
          "38: #include \"test_detail.c\"",
          "39: }  // namespace detail",
          "41: namespace iter {",
          "42: #include \"test_iter.c\"",
          "43: }  // namespace iter",
          "45: namespace mips {",
          "46: #include \"test_mips.c\"",
          "47: }  // namespace mips",
          "",
          "[Removed Lines]",
          "29: namespace arm {",
          "30: #include \"test_arm.c\"",
          "31: }  // namespace arm",
          "33: namespace arm64 {",
          "34: #include \"test_arm64.c\"",
          "35: }  // namespace arm64",
          "",
          "[Added Lines]",
          "40: namespace skipdata {",
          "41: #include \"test_skipdata.c\"",
          "42: }  // namespace skipdata",
          "48: namespace arm {",
          "49: #include \"test_arm.c\"",
          "50: }  // namespace arm",
          "52: namespace arm64 {",
          "53: #include \"test_arm64.c\"",
          "54: }  // namespace arm64",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "50: #include \"test_ppc.c\"",
          "51: }  // namespace ppc",
          "57: namespace sparc {",
          "58: #include \"test_sparc.c\"",
          "59: }  // namespace sparc",
          "",
          "[Removed Lines]",
          "53: namespace skipdata {",
          "54: #include \"test_skipdata.c\"",
          "55: }  // namespace skipdata",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "95:  }",
          "97:  unnamed::test();",
          "100:  detail::test();",
          "101:  iter::test();",
          "102:  mips::test();",
          "103:  ppc::test();",
          "105:  sparc::test();",
          "106:  systemz::test();",
          "107:  x86::test();",
          "",
          "[Removed Lines]",
          "98:  arm::test();",
          "99:  arm64::test();",
          "104:  skipdata::test();",
          "",
          "[Added Lines]",
          "106:  skipdata::test();",
          "108:  arm::test();",
          "109:  arm64::test();",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "128: }",
          "133: {",
          "134:  UNREFERENCED_PARAMETER(DriverObject);",
          "135:  UNREFERENCED_PARAMETER(RegistryPath);",
          "",
          "[Removed Lines]",
          "131: EXTERN_C NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject,",
          "132:   PUNICODE_STRING RegistryPath)",
          "",
          "[Added Lines]",
          "138: EXTERN_C NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "143: int __cdecl printf(const char * format, ...)",
          "144: {",
          "145:  NTSTATUS status;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "149: _Use_decl_annotations_",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f15f3bc6f23465c9f19e544cce9329d7570e03f2",
      "candidate_info": {
        "commit_hash": "f15f3bc6f23465c9f19e544cce9329d7570e03f2",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f15f3bc6f23465c9f19e544cce9329d7570e03f2",
        "files": [
          "arch/PowerPC/PPCInstPrinter.c"
        ],
        "message": "ppc: print 0 offset for memory operand. see issue #856",
        "before_after_code_files": [
          "arch/PowerPC/PPCInstPrinter.c||arch/PowerPC/PPCInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/PowerPC/PPCInstPrinter.c||arch/PowerPC/PPCInstPrinter.c": [
          "File: arch/PowerPC/PPCInstPrinter.c -> arch/PowerPC/PPCInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "468: {",
          "469:  if (MCOperand_isImm(MCInst_getOperand(MI, OpNo))) {",
          "470:   short Imm = (short)MCOperand_getImm(MCInst_getOperand(MI, OpNo));",
          "475:   if (Imm >= 0) {",
          "476:    if (Imm > HEX_THRESHOLD)",
          "",
          "[Removed Lines]",
          "472:   if (Imm == 0)",
          "473:    return;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}