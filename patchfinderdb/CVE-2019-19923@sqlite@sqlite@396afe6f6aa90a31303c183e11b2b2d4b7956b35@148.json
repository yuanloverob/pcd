{
  "cve_id": "CVE-2019-19923",
  "cve_desc": "flattenSubquery in select.c in SQLite 3.30.1 mishandles certain uses of SELECT DISTINCT involving a LEFT JOIN in which the right-hand side is a view. This can cause a NULL pointer dereference (or incorrect results).",
  "repo": "sqlite/sqlite",
  "patch_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
  "patch_info": {
    "commit_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/join.test"
    ],
    "message": "Continue to back away from the LEFT JOIN optimization of check-in [41c27bc0ff1d3135] by disallowing query flattening if the outer query is DISTINCT.  Without this fix, if an index scan is run on the table within the view on the right-hand side of the LEFT JOIN, stale result registers might be accessed yielding incorrect results, and/or an OP_IfNullRow opcode might be invoked on the un-opened table, resulting in a NULL-pointer dereference.  This problem was found by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: 862974312edf00e9d1068115d1a39b7235b7db68b6d86b81d38a12f025a4748e",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/join.test||test/join.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 289158aa24b066c453d2bce4bc2dead1c56fb0b23c3f7c4810b34b13627cef34",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3797:   if( (pSubitem->fg.jointype & JT_OUTER)!=0 ){",
      "3798:     isLeftJoin = 1;",
      "3801:       return 0;",
      "3802:     }",
      "3803:   }",
      "",
      "[Removed Lines]",
      "3799:     if( pSubSrc->nSrc>1 || isAgg || IsVirtual(pSubSrc->a[0].pTab) ){",
      "",
      "[Added Lines]",
      "3804:     ){",
      "",
      "---------------"
    ],
    "test/join.test||test/join.test": [
      "File: test/join.test -> test/join.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
      "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
      "978: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "978: # 2019-12-18 problem with a LEFT JOIN where the RHS is a view.",
      "979: # Detected by Yongheng and Rui.",
      "980: # Follows from the optimization attempt of check-in 41c27bc0ff1d3135",
      "981: # on 2017-04-18",
      "982: #",
      "983: reset_db",
      "984: do_execsql_test join-22.10 {",
      "985:   CREATE TABLE t0(a, b);",
      "986:   CREATE INDEX t0a ON t0(a);",
      "987:   INSERT INTO t0 VALUES(10,10),(10,11),(10,12);",
      "988:   SELECT DISTINCT c FROM t0 LEFT JOIN (SELECT a+1 AS c FROM t0) ORDER BY c ;",
      "989: } {11}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "41e0717bcb409de9ec296c3215b572dfab2697c9",
      "candidate_info": {
        "commit_hash": "41e0717bcb409de9ec296c3215b572dfab2697c9",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/41e0717bcb409de9ec296c3215b572dfab2697c9",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/resetdb.test"
        ],
        "message": "Update test file \"resetdb.test\" so that it works with the \"prepare\" permutation.\n\nFossilOrigin-Name: 95d338124be2e0e18f17354b28f4320336202f1a4ec1177df753b2800e954bfb",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/resetdb.test||test/resetdb.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 2c8769c69f301307db6663adb8b7c0b89f5959516bf6110cb8ff4b21bd903f70",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/resetdb.test||test/resetdb.test": [
          "File: test/resetdb.test -> test/resetdb.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:   db eval VACUUM",
          "84:   sqlite3_db_config db RESET_DB 0",
          "86:   # Verify that the reset took, even on the separate database connection",
          "87:   catchsql {",
          "88:      PRAGMA page_count;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:   # If using sqlite3_prepare() instead of _v2() or _v3(), the block",
          "87:   # below raises an SQLITE_SCHEMA error. The following fixes this.",
          "88:   if {[permutation]==\"prepare\"} { catchsql \"SELECT * FROM sqlite_master\" db2 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1cb0263bcd2fcce37ff203527033bea8aeb08ef2",
      "candidate_info": {
        "commit_hash": "1cb0263bcd2fcce37ff203527033bea8aeb08ef2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/1cb0263bcd2fcce37ff203527033bea8aeb08ef2",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "Fix an obsolete comment in the CLI.  No code changes.\n\nFossilOrigin-Name: fade103cbac1b067f9544935b767f36dc266aceb3269cc84a3ae3b04ad9a4823",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: e775ef002dd33e6bcbeec8d4b6ad7f59749e35548c7a59c9fa3bcfdc5cc50730",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in"
        ]
      }
    },
    {
      "candidate_hash": "b33487b0b6df3b669ba76d386b3a42c75fd904af",
      "candidate_info": {
        "commit_hash": "b33487b0b6df3b669ba76d386b3a42c75fd904af",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/b33487b0b6df3b669ba76d386b3a42c75fd904af",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/sqliteInt.h",
          "src/window.c",
          "test/window4.tcl"
        ],
        "message": "Improvements to the way built-in window functions are handled.\n\nFossilOrigin-Name: e8eee566dfca6f4c8af074731dfe91f7fbcd9ca72f0303235b52e4e2e80d5b71",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/sqliteInt.h||src/sqliteInt.h",
          "src/window.c||src/window.c",
          "test/window4.tcl||test/window4.tcl"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: af0ea1363548461b2aad8fd54ee3f2f616111dcae2d6480f5294da44c87a0a5d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "3581:   int regFirst;",
          "3582: };",
          "3584: #ifndef SQLITE_OMIT_WINDOWFUNC",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3582:   int regSize;",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1093:   pMWin->regFirst = ++pParse->nMem;",
          "1094:   sqlite3VdbeAddOp2(v, OP_Integer, 1, pMWin->regFirst);",
          "1096:   for(pWin=pMWin; pWin; pWin=pWin->pNextWin){",
          "1097:     FuncDef *p = pWin->pFunc;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1095:   pMWin->regSize = ++pParse->nMem;",
          "1096:   sqlite3VdbeAddOp2(v, OP_Integer, 0, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1841:   sqlite3VdbeJumpHere(v, addrGoto);",
          "1842: }",
          "1844: static void windowCodeStep(",
          "1845:   Parse *pParse,",
          "1846:   Select *p,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1850: static int windowCachePartition(Window *pMWin){",
          "1851:   Window *pWin;",
          "1852:   for(pWin=pMWin; pWin; pWin=pWin->pNextWin){",
          "1853:     FuncDef *pFunc = pWin->pFunc;",
          "1854:     if( (pFunc->funcFlags & SQLITE_FUNC_WINDOW_SIZE)",
          "1855:      || (pFunc->zName==nth_valueName)",
          "1856:      || (pFunc->zName==first_valueName)",
          "1857:      || (pFunc->zName==leadName)",
          "1858:      || (pFunc->zName==lagName)",
          "1859:     ){",
          "1860:       return 1;",
          "1861:     }",
          "1862:   }",
          "1863:   return 0;",
          "1864: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1871:   int addrIfStart;",
          "1872:   int addrGosubFlush;",
          "1873:   int addrInteger;",
          "1875:   int addrShortcut = 0;",
          "1877:   int reg = pParse->nMem+1;",
          "1878:   int regRecord = reg+nSub;",
          "1879:   int regRowid = regRecord+1;",
          "1881:   pParse->nMem += 1 + nSub + 1;",
          "1883:   regFlushPart = ++pParse->nMem;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1896:   int addrCacheRewind;",
          "1897:   int addrCacheNext;",
          "1901:   int bCache = windowCachePartition(pMWin);",
          "1907:   bCache = 1;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1914:     addrIf = sqlite3VdbeAddOp1(v, OP_If, pMWin->regFirst);",
          "1915:     addr = sqlite3VdbeAddOp3(v, OP_Compare, regNewPart, pMWin->regPart, nPart);",
          "1916:     sqlite3VdbeAppendP4(v, (void*)pKeyInfo, P4_KEYINFO);",
          "1918:     VdbeCoverageEqNe(v);",
          "1919:     addrGosubFlush = sqlite3VdbeAddOp1(v, OP_Gosub, regFlushPart);",
          "1920:     VdbeComment((v, \"call flush_partition\"));",
          "1921:     sqlite3VdbeJumpHere(v, addrIf);",
          "1922:   }",
          "1925:   sqlite3VdbeAddOp2(v, OP_NewRowid, csrWrite, regRowid);",
          "1926:   sqlite3VdbeAddOp3(v, OP_Insert, csrWrite, regRecord, regRowid);",
          "1934:   }",
          "1936:   regArg = windowInitAccum(pParse, pMWin);",
          "1938:   sqlite3ExprCode(pParse, pMWin->pStart, regStart);",
          "",
          "[Removed Lines]",
          "1917:     sqlite3VdbeAddOp3(v, OP_Jump, addr+2, addr+3, addr+2);",
          "1929:   addrIf = sqlite3VdbeAddOp1(v, OP_IfNot, pMWin->regFirst);",
          "1930:   if( pMWin->pPartition ){",
          "1931:     sqlite3VdbeAddOp3(v, OP_Copy,",
          "1932:         reg+pMWin->nBufferCol, pMWin->regPart, pMWin->pPartition->nExpr-1",
          "1933:     );",
          "",
          "[Added Lines]",
          "1950:     sqlite3VdbeAddOp3(v, OP_Jump, addr+2, addr+4, addr+2);",
          "1955:     sqlite3VdbeAddOp3(v, OP_Copy, regNewPart, pMWin->regPart, nPart-1);",
          "1961:   sqlite3VdbeAddOp2(v, OP_AddImm, pMWin->regSize, 1);",
          "1963:   if( bCache ){",
          "1964:     sqlite3VdbeAddOp2(v, OP_Integer, 0, pMWin->regFirst);",
          "1965:     sqlite3WhereEnd(pWInfo);",
          "1966:     addrInteger = sqlite3VdbeAddOp2(v, OP_Integer, 0, regFlushPart);",
          "1967:     if( pMWin->pPartition ){",
          "1968:       sqlite3VdbeJumpHere(v, addrGosubFlush);",
          "1969:     }",
          "1970:     addrCacheRewind = sqlite3VdbeAddOp1(v, OP_Rewind, csrWrite);",
          "1971:   }else{",
          "1972:     addrIf = sqlite3VdbeAddOp1(v, OP_IfNot, pMWin->regFirst);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1944:     int op = ((pMWin->eStart==TK_FOLLOWING) ? OP_Ge : OP_Le);",
          "1945:     int addrGe = sqlite3VdbeAddOp3(v, op, regStart, 0, regEnd);",
          "1946:     windowAggFinal(pParse, pMWin, 0);",
          "1950:     addrShortcut = sqlite3VdbeAddOp0(v, OP_Goto);",
          "1951:     sqlite3VdbeJumpHere(v, addrGe);",
          "1952:   }",
          "",
          "[Removed Lines]",
          "1947:     sqlite3VdbeAddOp2(v, OP_Rewind, csrCurrent, 1);",
          "1948:     windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "1949:     sqlite3VdbeAddOp1(v, OP_ResetSorter, csrCurrent);",
          "",
          "[Added Lines]",
          "1987:     if( bCache ){",
          "1988:       sqlite3VdbeAddOp2(v, OP_Rowid, csrWrite, regRowid);",
          "1989:       sqlite3VdbeAddOp3(v, OP_NotExists, csrCurrent, 0, regRowid);",
          "1990:       windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "1991:       sqlite3VdbeAddOp2(v, OP_Next, csrWrite, addrCacheRewind+1);",
          "1992:     }else{",
          "1993:       sqlite3VdbeAddOp2(v, OP_Rewind, csrCurrent, 1);",
          "1994:       windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "1995:       sqlite3VdbeAddOp1(v, OP_ResetSorter, csrCurrent);",
          "1996:     }",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1962:   addrGoto = sqlite3VdbeAddOp0(v, OP_Goto);",
          "1967:   if( pMWin->eStart==TK_FOLLOWING ){",
          "1968:     addrIfEnd = sqlite3VdbeAddOp3(v, OP_IfPos, regEnd, 0, 1);",
          "",
          "[Removed Lines]",
          "1965:   sqlite3VdbeJumpHere(v, addrIf);",
          "",
          "[Added Lines]",
          "2012:   if( bCache ){",
          "2013:     addrCacheNext = sqlite3VdbeCurrentAddr(v);",
          "2014:   }else{",
          "2015:     sqlite3VdbeJumpHere(v, addrIf);",
          "2016:   }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1974:     addrIfStart = sqlite3VdbeAddOp3(v, OP_IfPos, regStart, 0, 1);",
          "1975:     sqlite3VdbeAddOp2(v, OP_Next, csrStart, sqlite3VdbeCurrentAddr(v)+1);",
          "1977:     sqlite3VdbeJumpHere(v, addrIfStart);",
          "1978:   }else",
          "1979:   if( pMWin->eEnd==TK_PRECEDING ){",
          "1980:     addrIfEnd = sqlite3VdbeAddOp3(v, OP_IfPos, regEnd, 0, 1);",
          "1981:     sqlite3VdbeAddOp2(v, OP_Next, csrEnd, sqlite3VdbeCurrentAddr(v)+1);",
          "1983:     sqlite3VdbeJumpHere(v, addrIfEnd);",
          "1985:     windowAggFinal(pParse, pMWin, 0);",
          "",
          "[Removed Lines]",
          "1976:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, 0);",
          "1982:     windowAggStep(pParse, pMWin, csrEnd, 0, regArg, 0);",
          "",
          "[Added Lines]",
          "2027:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, pMWin->regSize);",
          "2033:     windowAggStep(pParse, pMWin, csrEnd, 0, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1989:     addrIfStart = sqlite3VdbeAddOp3(v, OP_IfPos, regStart, 0, 1);",
          "1990:     sqlite3VdbeAddOp2(v, OP_Next, csrStart, sqlite3VdbeCurrentAddr(v)+1);",
          "1992:     sqlite3VdbeJumpHere(v, addrIfStart);",
          "1993:   }else{",
          "1994:     addrIfEnd = sqlite3VdbeAddOp3(v, OP_IfPos, regEnd, 0, 1);",
          "",
          "[Removed Lines]",
          "1991:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, 0);",
          "",
          "[Added Lines]",
          "2042:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1997:     windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "1998:     addrIfStart = sqlite3VdbeAddOp3(v, OP_IfPos, regStart, 0, 1);",
          "1999:     sqlite3VdbeAddOp2(v, OP_Next, csrStart, sqlite3VdbeCurrentAddr(v)+1);",
          "2001:     sqlite3VdbeJumpHere(v, addrIfStart);",
          "2002:     sqlite3VdbeJumpHere(v, addrIfEnd);",
          "2003:   }",
          "",
          "[Removed Lines]",
          "2000:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, 0);",
          "",
          "[Added Lines]",
          "2051:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2005:   sqlite3VdbeJumpHere(v, addrGoto);",
          "2006:   if( pMWin->eEnd!=TK_PRECEDING ){",
          "2007:     sqlite3VdbeAddOp2(v, OP_Next, csrEnd, sqlite3VdbeCurrentAddr(v)+1);",
          "2009:   }",
          "2018:     addrInteger = sqlite3VdbeAddOp2(v, OP_Integer, 0, regFlushPart);",
          "2019:     sqlite3VdbeJumpHere(v, addrGosubFlush);",
          "2020:   }",
          "",
          "[Removed Lines]",
          "2008:     windowAggStep(pParse, pMWin, csrEnd, 0, regArg, 0);",
          "2012:   if( addrShortcut>0 ) sqlite3VdbeJumpHere(v, addrShortcut);",
          "2013:   sqlite3WhereEnd(pWInfo);",
          "2017:   if( pMWin->pPartition ){",
          "",
          "[Added Lines]",
          "2059:     windowAggStep(pParse, pMWin, csrEnd, 0, regArg, pMWin->regSize);",
          "2063:   if( bCache ){",
          "2064:     sqlite3VdbeAddOp2(v, OP_Next, csrWrite, addrCacheNext);",
          "2065:     sqlite3VdbeJumpHere(v, addrCacheRewind);",
          "2066:   }else{",
          "2067:     if( addrShortcut>0 ) sqlite3VdbeJumpHere(v, addrShortcut);",
          "2068:     sqlite3WhereEnd(pWInfo);",
          "2069:   }",
          "2073:   if( pMWin->pPartition && bCache==0 ){",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2031:     addrIfStart = sqlite3VdbeAddOp3(v, OP_IfPos, regStart, 0, 1);",
          "2032:     sqlite3VdbeAddOp2(v, OP_Next, csrStart, sqlite3VdbeCurrentAddr(v)+2);",
          "2033:     sqlite3VdbeAddOp0(v, OP_Goto);",
          "2035:     sqlite3VdbeJumpHere(v, addrIfStart);",
          "2036:     sqlite3VdbeJumpHere(v, addrIfStart+2);",
          "",
          "[Removed Lines]",
          "2034:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, 0);",
          "",
          "[Added Lines]",
          "2090:     windowAggStep(pParse, pMWin, csrStart, 1, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2043:     if( pMWin->eEnd==TK_PRECEDING ){",
          "2044:       addrIfEnd = sqlite3VdbeAddOp3(v, OP_IfPos, regEnd, 0, 1);",
          "2045:       sqlite3VdbeAddOp2(v, OP_Next, csrEnd, sqlite3VdbeCurrentAddr(v)+1);",
          "2047:       sqlite3VdbeJumpHere(v, addrIfEnd);",
          "2048:       windowAggFinal(pParse, pMWin, 0);",
          "2049:       windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "",
          "[Removed Lines]",
          "2046:       windowAggStep(pParse, pMWin, csrEnd, 0, regArg, 0);",
          "",
          "[Added Lines]",
          "2102:       windowAggStep(pParse, pMWin, csrEnd, 0, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "2052:       windowReturnOneRow(pParse, pMWin, regGosub, addrGosub);",
          "2053:       addrIfStart = sqlite3VdbeAddOp3(v, OP_IfPos, regStart, 0, 1);",
          "2054:       sqlite3VdbeAddOp2(v, OP_Next, csrStart, sqlite3VdbeCurrentAddr(v)+1);",
          "2056:       sqlite3VdbeJumpHere(v, addrIfStart);",
          "2057:       sqlite3VdbeAddOp2(v, OP_Goto, 0, addrGoto-1);",
          "2058:     }",
          "",
          "[Removed Lines]",
          "2055:       windowAggStep(pParse, pMWin, csrStart, 1, regArg, 0);",
          "",
          "[Added Lines]",
          "2111:       windowAggStep(pParse, pMWin, csrStart, 1, regArg, pMWin->regSize);",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "2060:   }",
          "2063:   sqlite3VdbeAddOp1(v, OP_ResetSorter, csrCurrent);",
          "2065:   if( pMWin->pPartition ){",
          "2066:     sqlite3VdbeChangeP1(v, addrInteger, sqlite3VdbeCurrentAddr(v));",
          "2067:     sqlite3VdbeAddOp1(v, OP_Return, regFlushPart);",
          "",
          "[Removed Lines]",
          "2064:   sqlite3VdbeAddOp2(v, OP_Integer, 1, pMWin->regFirst);",
          "",
          "[Added Lines]",
          "2119:   if( bCache && addrShortcut>0 ) sqlite3VdbeJumpHere(v, addrShortcut);",
          "2121:   sqlite3VdbeAddOp2(v, OP_Integer, 0, pMWin->regSize);",
          "2122:   if( bCache==0 ) sqlite3VdbeAddOp2(v, OP_Integer, 1, pMWin->regFirst);",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "2530:   if( pMWin->eType==TK_ROWS",
          "2531:    && (pMWin->eStart!=TK_UNBOUNDED||pMWin->eEnd!=TK_CURRENT||!pMWin->pOrderBy)",
          "2532:   ){",
          "2550:     ){",
          "2551:       VdbeModuleComment((pParse->pVdbe, \"Begin RowExprStep()\"));",
          "2552:       windowCodeRowExprStep(pParse, p, pWInfo, regGosub, addrGosub);",
          "",
          "[Removed Lines]",
          "2533:     Window *pWin;",
          "2535:     for(pWin=pMWin; pWin; pWin=pWin->pNextWin){",
          "2536:       FuncDef *pFunc = pWin->pFunc;",
          "2537:       if( (pFunc->funcFlags & SQLITE_FUNC_WINDOW_SIZE)",
          "2538:         || (pFunc->zName==nth_valueName)",
          "2539:         || (pFunc->zName==first_valueName)",
          "2540:         || (pFunc->zName==leadName)",
          "2541:         || (pFunc->zName==lagName)",
          "2542:       ){",
          "2543:         bCache = 1;",
          "2544:         break;",
          "2545:       }",
          "2546:     }",
          "2547:     if( bCache",
          "2548:     || (pMWin->eStart!=TK_PRECEDING && pMWin->eStart!=TK_FOLLOWING)",
          "2549:     || (pMWin->eEnd!=TK_FOLLOWING && pMWin->eEnd!=TK_PRECEDING)",
          "",
          "[Added Lines]",
          "2591:     if( (pMWin->eStart!=TK_PRECEDING && pMWin->eStart!=TK_FOLLOWING)",
          "2592:      || (pMWin->eEnd!=TK_FOLLOWING && pMWin->eEnd!=TK_PRECEDING)",
          "",
          "---------------"
        ],
        "test/window4.tcl||test/window4.tcl": [
          "File: test/window4.tcl -> test/window4.tcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: #",
          "3: # The author disclaims copyright to this source code.  In place of",
          "4: # a legal notice, here is a blessing:",
          "",
          "[Removed Lines]",
          "1: # 2018 May 19",
          "",
          "[Added Lines]",
          "1: ## 2018 May 19",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e8975ac9e1e5f9cf5bf394fb8e3f5e9f4d0f2470",
      "candidate_info": {
        "commit_hash": "e8975ac9e1e5f9cf5bf394fb8e3f5e9f4d0f2470",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/e8975ac9e1e5f9cf5bf394fb8e3f5e9f4d0f2470",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/sqlite3ext.h"
        ],
        "message": "Add new APIs to the extension loading mechanism.\n\nFossilOrigin-Name: 6f122faf8a34b986e58ba4622cff918c6d133d6f91d4b723b50bd086d5bed8e1",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/sqlite3ext.h||src/sqlite3ext.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b3f2c3205a28dc21ea7080e5e1ba246ce9c9b90c1309262ca11d8e40943ed677",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/sqlite3ext.h||src/sqlite3ext.h": [
          "File: src/sqlite3ext.h -> src/sqlite3ext.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "319:                             void(*xDestroy)(void*));",
          "321:   const char *(*normalized_sql)(sqlite3_stmt*);",
          "322: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "323:   int (*stmt_isexplain)(sqlite3_stmt*);",
          "324:   int (*value_frombind)(sqlite3_value*);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "608: #define sqlite3_create_window_function sqlite3_api->create_window_function",
          "610: #define sqlite3_normalized_sql         sqlite3_api->normalized_sql",
          "613: #if !defined(SQLITE_CORE) && !defined(SQLITE_OMIT_LOAD_EXTENSION)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "615: #define sqlite3_stmt_isexplain         sqlite3_api->isexplain",
          "616: #define sqlite3_value_frombind         sqlite3_api->frombind",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dcc427cf19603d5060742745dfca76352f9ced43",
      "candidate_info": {
        "commit_hash": "dcc427cf19603d5060742745dfca76352f9ced43",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/dcc427cf19603d5060742745dfca76352f9ced43",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/btree.c",
          "test/corruptL.test"
        ],
        "message": "Add an extra test for database corruption to defragmentPage().\n\nFossilOrigin-Name: 80e951fce3e5aaa224c8dba6449832d2efabcdc24e86eb6b7833f85cf08ecc00",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/btree.c||src/btree.c",
          "test/corruptL.test||test/corruptL.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 3649a77b79001ea6c5defe882f9934521b20b9d36aab26d03b5d42006c7fa228",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/btree.c||src/btree.c": [
          "File: src/btree.c -> src/btree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1455:           if( iFree2+sz2 > usableSize ) return SQLITE_CORRUPT_PAGE(pPage);",
          "1456:           memmove(&data[iFree+sz+sz2], &data[iFree+sz], iFree2-(iFree+sz));",
          "1457:           sz += sz2;",
          "1458:         }",
          "1459:         cbrk = top+sz;",
          "1460:         assert( cbrk+(iFree-top) <= usableSize );",
          "1461:         memmove(&data[cbrk], &data[top], iFree-top);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1458:         }else if( iFree+sz>usableSize ){",
          "1459:           return SQLITE_CORRUPT_PAGE(pPage);",
          "",
          "---------------"
        ],
        "test/corruptL.test||test/corruptL.test": [
          "File: test/corruptL.test -> test/corruptL.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "727:   SELECT * FROM sqlite_master;",
          "728: } {1 {malformed database schema (t1x1) - invalid rootpage}}",
          "730: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "730: #-------------------------------------------------------------------------",
          "731: reset_db",
          "732: do_test 8.0 {",
          "733:   sqlite3 db {}",
          "734:   db deserialize [decode_hexdb {",
          "735: | size 2048 pagesize 512 filename a.db",
          "736: | page 1 offset 0",
          "737: |      0: 53 51 4c 69 74 65 20 66 6f 72 6d 61 74 20 33 00   SQLite format 3.",
          "738: |     16: 02 00 01 01 00 40 20 20 ff ff 00 0c 00 00 00 07   .....@  ........",
          "739: |     32: 0b 00 00 00 00 00 00 00 00 00 00 08 9c 00 00 04   ................",
          "740: |     48: 00 00 00 e0 09 00 00 01 00 00 00 01 00 00 00 00   ................",
          "741: |     64: 00 00 00 00 f2 ff 00 00 00 00 00 00 00 00 00 00   ................",
          "742: |     80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0c   ................",
          "743: |     96: 00 2e 2c 50 0d 00 00 00 06 01 06 00 01 da 01 b0   ..,P............",
          "744: |    112: 05 56 01 86 01 2a 01 06 00 00 00 00 00 06 00 00   .V...*..........",
          "745: |    128: 00 ff 00 00 ff ff ff e1 00 00 00 00 00 00 00 00   ................",
          "746: |    144: 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00   ................",
          "747: |    160: 00 00 00 00 00 00 00 00 f2 00 00 00 00 00 00 00   ................",
          "748: |    176: 00 00 f9 ff ff ff ff ff ff ff 00 00 00 5f 00 fb   ............._..",
          "749: |    192: 00 00 00 00 00 00 00 00 00 e1 ff 00 00 00 00 00   ................",
          "750: |    208: 00 00 10 00 00 00 00 00 1e 00 00 00 fe 00 00 00   ................",
          "751: |    224: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ca 00   ................",
          "752: |    240: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 35   ...............5",
          "753: |    256: 00 00 00 00 ef ff 22 07 06 17 11 11 01 30 39 38   .............098",
          "754: |    272: 62 6c 65 74 38 38 74 04 43 52 45 41 54 45 20 54   blet88t.CREATE T",
          "755: |    288: 41 42 4c 45 20 74 34 28 87 29 2a 06 06 17 13 11   ABLE t4(.)*.....",
          "756: |    304: 01 3f 69 4f 64 65 78 74 33 78 74 40 05 43 52 45   .?iOdext3xt@.CRE",
          "757: |    320: 41 54 45 20 49 6e 44 45 58 20 74 33 78 20 4f 4e   ATE InDEX t3x ON",
          "758: |    336: 20 74 33 28 78 29 2e 04 06 17 15 11 01 45 69 6e    t3(x).......Ein",
          "759: |    352: 00 04 00 00 34 63 64 74 3d 05 43 52 45 41 54 45   ....4cdt=.CREATE",
          "760: |    368: 20 49 4e 44 45 58 20 63 74 64 32 20 4f 4e 20 74    INDEX ctd2 ON t",
          "761: |    384: 32 28 0a 0c 44 29 28 05 06 17 11 11 01 3d 74 6c   2(..D)(......=tl",
          "762: |    400: 62 61 d4 65 33 74 33 04 43 52 45 41 54 45 20 54   ba.e3t3.CREATE T",
          "763: |    416: 41 42 4c 45 20 74 33 28 63 2c 78 2c 65 2c 66 29   ABLE t3(c,x,e,f)",
          "764: |    432: 28 02 06 17 11 11 01 3d 74 61 62 6c 65 74 32 74   (......=tablet2t",
          "765: |    448: 32 03 43 52 45 41 54 45 20 54 41 42 4c 45 20 74   2.CREATE TABLE t",
          "766: |    464: 32 28 63 2c 64 2c 65 2c 66 29 24 01 06 17 11 11   2(c,d,e,f)$.....",
          "767: |    480: 01 35 74 60 62 6c 65 74 31 74 31 02 43 52 45 41   .5t`blet1t1.CREA",
          "768: |    496: 54 45 20 54 41 42 4c 45 20 74 30 28 61 2c 62 29   TE TABLE t0(a,b)",
          "769: | page 2 offset 512",
          "770: |      0: 0d 00 ff 11 04 01 cf 80 01 fa 01 09 00 de 01 cf   ................",
          "771: |     16: 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00   ................",
          "772: |     32: 00 00 08 00 00 00 00 00 00 11 00 00 00 00 00 13   ................",
          "773: |     48: 00 00 00 00 00 00 00 00 00 00 00 01 00 e0 ff ff   ................",
          "774: |     64: ff d2 ff ff ff 00 f8 ff ff ff 00 00 00 00 00 00   ................",
          "775: |     80: 00 ff ff 00 00 00 00 00 00 00 00 00 00 00 00 00   ................",
          "776: |     96: 00 00 00 00 ff de 00 00 00 00 00 00 00 00 00 00   ................",
          "777: |    112: 00 00 00 00 00 00 00 00 00 00 00 00 00 40 00 00   .............@..",
          "778: |    128: 2a 00 00 00 00 00 00 00 00 f7 00 00 00 00 00 00   *...............",
          "779: |    144: 00 00 00 00 00 21 00 00 00 00 00 00 00 00 00 00   .....!..........",
          "780: |    160: 01 64 00 00 00 00 04 80 ff ff ff 00 00 00 00 00   .d..............",
          "781: |    176: 00 00 00 00 00 00 00 00 1f 00 00 00 00 00 00 00   ................",
          "782: |    192: 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00   ..@.............",
          "783: |    208: b5 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00   .......@........",
          "784: |    224: 00 00 00 f6 00 ee ff ff ff 00 00 00 00 00 00 00   ................",
          "785: |    272: f2 00 00 00 00 00 00 00 00 00 f9 ff ff ff ff ff   ................",
          "786: |    288: ff ff 00 00 00 5f 00 fb 00 00 00 00 00 00 00 00   ....._..........",
          "787: |    320: 1e 00 00 00 fe 00 00 00 00 00 00 00 00 00 00 00   ................",
          "788: |    336: 00 00 00 00 00 00 ca 00 00 00 00 00 00 00 ff ec   ................",
          "789: |    352: 00 00 00 00 00 00 00 32 00 00 00 00 ef ff 22 07   .......2........",
          "790: |    368: 06 17 11 11 01 30 74 61 62 6c 65 74 38 38 74 04   .....0tablet88t.",
          "791: |    384: 43 52 45 41 54 45 20 54 41 42 4c 45 20 8c cb d7   CREATE TABLE ...",
          "792: |    400: 78 d6 d5 f9 f9 17 13 11 01 3f 69 4f 64 65 78 74   x........?iOdext",
          "793: |    416: 33 78 74 33 05 43 52 45 41 54 45 26 49 6e 44 45   3xt3.CREATE&InDE",
          "794: |    432: 58 20 74 33 78 00 00 00 00 00 00 00 00 00 00 00   X t3x...........",
          "795: |    464: 00 00 00 00 00 13 76 65 6e 65 69 67 68 74 13 03   ......veneight..",
          "796: |    480: 03 40 07 07 15 00 54 45 20 49 4e 44 45 58 20 74   .@....TE INDEX t",
          "797: |    496: 31 63 64 20 4f 4e 20 74 ce d7 f5 f0 44 09 01 02   1cd ON t....D...",
          "798: | page 3 offset 1024",
          "799: |      0: 0d 00 00 00 48 01 54 00 01 f6 e2 ec 01 c5 01 aa   ....H.T.........",
          "800: |     16: 30 34 28 87 29 32 06 f5 16 13 11 01 8e 61 24 64   04(.)2.......a$d",
          "801: |     32: 65 78 74 37 78 1f 33 6d 6d 6d 6d 6d 00 00 04 06   ext7x.3mmmmm....",
          "802: |     48: 6d 41 6d 6d 6e 6d 6d 00 00 02 00 6d 6d 6d 6d 6d   mAmmnmm....mmmmm",
          "803: |     64: 15 11 01 45 45 45 45 45 45 45 45 45 45 45 45 45   ...EEEEEEEEEEEEE",
          "804: |     80: 45 45 45 45 45 45 45 45 45 45 45 00 45 63 74 64   EEEEEEEEEEE.Ectd",
          "805: |     96: 34 20 4f 4e 20 61 62 6c 5d 74 38 38 74 04 43 52   4 ON abl]t88t.CR",
          "806: |    112: 45 41 54 45 20 54 41 42 4c 45 20 74 34 28 87 29   EATE TABLE t4(.)",
          "807: |    128: 2a 06 06 13 13 01 00 00 00 4f 64 6e 78 74 33 44   *........Odnxt3D",
          "808: |    144: 74 13 05 43 52 45 41 54 45 20 49 6e 44 45 00 00   t..CREATE InDE..",
          "809: |    160: 00 00 00 00 00 00 00 f9 ff ff ff ff ff ff ff 00   ................",
          "810: |    176: 00 00 5f 00 fb 00 00 2d 00 00 00 00 00 00 00 00   .._....-........",
          "811: |    192: 00 00 00 00 00 00 00 00 00 00 00 00 00 1e 00 00   ................",
          "812: |    208: 00 fe 00 00 00 00 17 15 11 01 45 69 6e 64 65 2e   ..........Einde.",
          "813: |    224: 5b 38 63 64 74 3d 05 43 52 45 41 54 45 20 49 4e   [8cdt=.CREATE IN",
          "814: |    240: 44 45 58 20 63 20 64 32 20 4f 4e 20 74 32 28 0a   DEX c d2 ON t2(.",
          "815: |    256: 0c 44 32 05 00 10 00 00 11 11 3d 74 6c 62 61 d4   .D2.......=tlba.",
          "816: |    272: 65 33 74 33 04 43 52 45 41 54 45 20 54 41 42 4c   e3t3.CREATE TABL",
          "817: |    288: 45 20 74 36 ff ff 7f ff 43 52 45 41 54 45 20 49   E t6....CREATE I",
          "818: |    304: 73 71 6c 69 74 65 5f 73 65 71 75 65 6e 63 65 28   sqlite_sequence(",
          "819: |    320: 0a 0c 44 29 28 05 06 17 11 11 01 3d 74 6c 62 61   ..D)(......=tlba",
          "820: |    336: 20 00 00 00 33 04 43 52 45 41 54 45 20 54 41 42    ...3.CREATE TAB",
          "821: |    352: 4c 45 20 74 33 28 63 2c 78 2c 65 2c 66 29 28 02   LE t3(c,x,e,f)(.",
          "822: |    368: 06 00 00 7f ff 40 41 54 45 20 49 6e 44 45 58 20   .....@ATE InDEX",
          "823: |    384: 74 33 78 20 4f 4e 20 74 31 28 78 29 2e 04 06 17   t3x ON t1(x)....",
          "824: |    400: 15 11 01 45 69 6e 64 65 2e 74 34 63 64 74 3d 05   ...Einde.t4cdt=.",
          "825: |    416: 00 00 00 00 00 00 00 00 00 00 00 4d 00 00 00 00   ...........M....",
          "826: |    432: 01 00 00 00 00 00 00 05 00 00 10 00 00 00 00 00   ................",
          "827: |    448: 00 01 00 00 00 00 01 00 00 00 00 07 40 14 00 00   ............@...",
          "828: |    464: 00 00 21 00 40 18 00 00 00 00 00 00 40 1c 00 00   ..!.@.......@...",
          "829: |    480: 00 00 ff ff ff 00 00 00 5f 00 fb 00 00 2d 00 00   ........_....-..",
          "830: |    496: 00 00 00 1e 00 00 00 fe 00 00 64 00 00 ff fb 02   ..........d.....",
          "831: | page 4 offset 1536",
          "832: |      0: 0d 00 39 00 00 02 00 00 00 00 00 00 00 00 00 00   ..9.............",
          "833: | end a.db",
          "834: }]} {}",
          "837: do_catchsql_test 8.1 {",
          "838:   INSERT INTO t3 SELECT * FROM t2;",
          "839: } {1 {database disk image is malformed}}",
          "",
          "---------------"
        ]
      }
    }
  ]
}