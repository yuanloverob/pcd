{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "02f7296a33098f180bd551bd2c5918da441d43ec",
      "candidate_info": {
        "commit_hash": "02f7296a33098f180bd551bd2c5918da441d43ec",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/02f7296a33098f180bd551bd2c5918da441d43ec",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: Separate instruction bytes by spaces (#1009)",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "328:    int j;",
          "329:    printf(\"%\"PRIx64\"  \", insn[i].address);",
          "330:    for (j = 0; j < insn[i].size; j++) {",
          "331:     printf(\"%02x\", insn[i].bytes[j]);",
          "332:    }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "331:     if (j > 0)",
          "332:      putchar(' ');",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f7a3cc25965e4d7d4f3488394b24f1d4650de905",
      "candidate_info": {
        "commit_hash": "f7a3cc25965e4d7d4f3488394b24f1d4650de905",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f7a3cc25965e4d7d4f3488394b24f1d4650de905",
        "files": [
          "COMPILE_CMAKE.TXT",
          "nmake.bat"
        ],
        "message": "add nmake.bat",
        "before_after_code_files": [
          "nmake.bat||nmake.bat"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "nmake.bat||nmake.bat": [
          "File: nmake.bat -> nmake.bat",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: :: Capstone disassembler engine (www.capstone-engine.org)",
          "2: :: Build Capstone libs (capstone.dll & capstone.lib) on Windows with CMake & Nmake",
          "3: :: By Nguyen Anh Quynh, 2017",
          "5: cmake -DCMAKE_BUILD_TYPE=Release -G \"NMake Makefiles\" ..",
          "6: nmake",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5082248962a55bce1490233021c72e34bc21593",
      "candidate_info": {
        "commit_hash": "c5082248962a55bce1490233021c72e34bc21593",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c5082248962a55bce1490233021c72e34bc21593",
        "files": [
          "arch/X86/X86GenAsmWriter1.inc",
          "arch/X86/X86Mapping.c"
        ],
        "message": "x86: wrong number of operands. fix #950",
        "before_after_code_files": [
          "arch/X86/X86GenAsmWriter1.inc||arch/X86/X86GenAsmWriter1.inc",
          "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86GenAsmWriter1.inc||arch/X86/X86GenAsmWriter1.inc": [
          "File: arch/X86/X86GenAsmWriter1.inc -> arch/X86/X86GenAsmWriter1.inc"
        ],
        "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
          "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47241:  { X86_INSW, X86_REG_DX },",
          "47242:  { X86_INSL, X86_REG_DX },",
          "47244:  { X86_MOV32ao32, X86_REG_EAX },",
          "47245:  { X86_MOV64o64a, X86_REG_RAX },",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47244:  { X86_MOV16ao16, X86_REG_AX },",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "47356:  { X86_MOV64o64a, X86_REG_RAX },",
          "47357:  { X86_MOV64o32a, X86_REG_EAX },",
          "47361:  { X86_MOV64ao32, X86_REG_RAX },   // 64-bit 48 8B04 10203040         // mov     rax, qword ptr [0x40302010]",
          "47363:  { X86_LODSQ, X86_REG_RAX },",
          "",
          "[Removed Lines]",
          "47359:  { X86_MOV16ao16, X86_REG_AX },    // 16-bit A1 1020                  // mov     ax, word ptr [0x2010]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "37b81f21cb175282a21feb18252417373ba069c5",
      "candidate_info": {
        "commit_hash": "37b81f21cb175282a21feb18252417373ba069c5",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/37b81f21cb175282a21feb18252417373ba069c5",
        "files": [
          "ChangeLog",
          "bindings/java/capstone/Arm.java"
        ],
        "message": "Java: Fix a bug where Arm.OpInfo.memBarrier and Arm.OpInfo.op is wrongly calculated",
        "before_after_code_files": [
          "bindings/javcapstone/Arm.java||bindings/java/capstone/Arm.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javcapstone/Arm.java||bindings/java/capstone/Arm.java": [
          "File: bindings/javcapstone/Arm.java -> bindings/java/capstone/Arm.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "96:     public int mem_barrier;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8e9519c56a3a1bb014983963832595bb1310b73f",
      "candidate_info": {
        "commit_hash": "8e9519c56a3a1bb014983963832595bb1310b73f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/8e9519c56a3a1bb014983963832595bb1310b73f",
        "files": [
          "include/capstone/mips.h"
        ],
        "message": "fix merge error",
        "before_after_code_files": [
          "include/capstone/mips.h||include/capstone/mips.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/capstone/mips.h||include/capstone/mips.h": [
          "File: include/capstone/mips.h -> include/capstone/mips.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "18: #include \"platform.h\"",
          "",
          "[Removed Lines]",
          "11: <<<<<<< HEAD",
          "12: #if !defined(_MSC_VER) || !defined(_KERNEL_MODE)",
          "13: #include <stdint.h>",
          "14: #endif",
          "16: =======",
          "17: >>>>>>> upstream/next",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}