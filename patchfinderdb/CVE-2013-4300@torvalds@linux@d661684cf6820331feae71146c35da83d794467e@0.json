{
  "cve_id": "CVE-2013-4300",
  "cve_desc": "The scm_check_creds function in net/core/scm.c in the Linux kernel before 3.11 performs a capability check in an incorrect namespace, which allows local users to gain privileges via PID spoofing.",
  "repo": "torvalds/linux",
  "patch_hash": "d661684cf6820331feae71146c35da83d794467e",
  "patch_info": {
    "commit_hash": "d661684cf6820331feae71146c35da83d794467e",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/d661684cf6820331feae71146c35da83d794467e",
    "files": [
      "net/core/scm.c"
    ],
    "message": "net: Check the correct namespace when spoofing pid over SCM_RIGHTS\n\nThis is a security bug.\n\nThe follow-up will fix nsproxy to discourage this type of issue from\nhappening again.\n\nCc: stable@vger.kernel.org\nSigned-off-by: Andy Lutomirski <luto@amacapital.net>\nReviewed-by: \"Eric W. Biederman\" <ebiederm@xmission.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "net/core/scm.c||net/core/scm.c"
    ]
  },
  "patch_diff": {
    "net/core/scm.c||net/core/scm.c": [
      "File: net/core/scm.c -> net/core/scm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "54:   return -EINVAL;",
      "56:  if ((creds->pid == task_tgid_vnr(current) ||",
      "58:      ((uid_eq(uid, cred->uid)   || uid_eq(uid, cred->euid) ||",
      "59:        uid_eq(uid, cred->suid)) || nsown_capable(CAP_SETUID)) &&",
      "60:      ((gid_eq(gid, cred->gid)   || gid_eq(gid, cred->egid) ||",
      "",
      "[Removed Lines]",
      "57:       ns_capable(current->nsproxy->pid_ns->user_ns, CAP_SYS_ADMIN)) &&",
      "",
      "[Added Lines]",
      "57:       ns_capable(task_active_pid_ns(current)->user_ns, CAP_SYS_ADMIN)) &&",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "92f28d973cce45ef5823209aab3138eb45d8b349",
      "candidate_info": {
        "commit_hash": "92f28d973cce45ef5823209aab3138eb45d8b349",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/92f28d973cce45ef5823209aab3138eb45d8b349",
        "files": [
          "net/core/scm.c"
        ],
        "message": "scm: Require CAP_SYS_ADMIN over the current pidns to spoof pids.\n\nDon't allow spoofing pids over unix domain sockets in the corner\ncases where a user has created a user namespace but has not yet\ncreated a pid namespace.\n\nCc: stable@vger.kernel.org\nReported-by: Andy Lutomirski <luto@amacapital.net>\nSigned-off-by: \"Eric W. Biederman\" <ebiederm@xmission.com>",
        "before_after_code_files": [
          "net/core/scm.c||net/core/scm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "net/core/scm.c||net/core/scm.c"
          ],
          "candidate": [
            "net/core/scm.c||net/core/scm.c"
          ]
        }
      },
      "candidate_diff": {
        "net/core/scm.c||net/core/scm.c": [
          "File: net/core/scm.c -> net/core/scm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include <linux/interrupt.h>",
          "25: #include <linux/netdevice.h>",
          "26: #include <linux/security.h>",
          "27: #include <linux/pid.h>",
          "28: #include <linux/nsproxy.h>",
          "29: #include <linux/slab.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include <linux/pid_namespace.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:  if (!uid_valid(uid) || !gid_valid(gid))",
          "53:   return -EINVAL;",
          "56:      ((uid_eq(uid, cred->uid)   || uid_eq(uid, cred->euid) ||",
          "57:        uid_eq(uid, cred->suid)) || nsown_capable(CAP_SETUID)) &&",
          "58:      ((gid_eq(gid, cred->gid)   || gid_eq(gid, cred->egid) ||",
          "",
          "[Removed Lines]",
          "55:  if ((creds->pid == task_tgid_vnr(current) || nsown_capable(CAP_SYS_ADMIN)) &&",
          "",
          "[Added Lines]",
          "56:  if ((creds->pid == task_tgid_vnr(current) ||",
          "57:       ns_capable(current->nsproxy->pid_ns->user_ns, CAP_SYS_ADMIN)) &&",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "00f70de09c418bfb028d03f046e39c1d301db7b2",
      "candidate_info": {
        "commit_hash": "00f70de09c418bfb028d03f046e39c1d301db7b2",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/00f70de09c418bfb028d03f046e39c1d301db7b2",
        "files": [
          "net/core/scm.c"
        ],
        "message": "net: Allow userns root to force the scm creds\n\nIf the user calling sendmsg has the appropriate privieleges\nin their user namespace allow them to set the uid, gid, and\npid in the SCM_CREDENTIALS control message to any valid value.\n\nSigned-off-by: \"Eric W. Biederman\" <ebiederm@xmission.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "net/core/scm.c||net/core/scm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "net/core/scm.c||net/core/scm.c"
          ],
          "candidate": [
            "net/core/scm.c||net/core/scm.c"
          ]
        }
      },
      "candidate_diff": {
        "net/core/scm.c||net/core/scm.c": [
          "File: net/core/scm.c -> net/core/scm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:  if (!uid_valid(uid) || !gid_valid(gid))",
          "52:   return -EINVAL;",
          "55:      ((uid_eq(uid, cred->uid)   || uid_eq(uid, cred->euid) ||",
          "57:      ((gid_eq(gid, cred->gid)   || gid_eq(gid, cred->egid) ||",
          "59:         return 0;",
          "60:  }",
          "61:  return -EPERM;",
          "",
          "[Removed Lines]",
          "54:  if ((creds->pid == task_tgid_vnr(current) || capable(CAP_SYS_ADMIN)) &&",
          "56:        uid_eq(uid, cred->suid)) || capable(CAP_SETUID)) &&",
          "58:        gid_eq(gid, cred->sgid)) || capable(CAP_SETGID))) {",
          "",
          "[Added Lines]",
          "54:  if ((creds->pid == task_tgid_vnr(current) || nsown_capable(CAP_SYS_ADMIN)) &&",
          "56:        uid_eq(uid, cred->suid)) || nsown_capable(CAP_SETUID)) &&",
          "58:        gid_eq(gid, cred->sgid)) || nsown_capable(CAP_SETGID))) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}