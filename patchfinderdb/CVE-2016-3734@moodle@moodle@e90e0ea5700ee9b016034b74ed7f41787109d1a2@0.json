{
  "cve_id": "CVE-2016-3734",
  "cve_desc": "Cross-site request forgery (CSRF) vulnerability in markposts.php in Moodle 3.0 through 3.0.3, 2.9 through 2.9.5, 2.8 through 2.8.11, 2.7 through 2.7.13 and earlier allows remote attackers to hijack the authentication of users for requests that marks forum posts as read.",
  "repo": "moodle/moodle",
  "patch_hash": "e90e0ea5700ee9b016034b74ed7f41787109d1a2",
  "patch_info": {
    "commit_hash": "e90e0ea5700ee9b016034b74ed7f41787109d1a2",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/e90e0ea5700ee9b016034b74ed7f41787109d1a2",
    "files": [
      "mod/forum/index.php",
      "mod/forum/lib.php",
      "mod/forum/markposts.php"
    ],
    "message": "MDL-53755 forum: Check session when marking posts",
    "before_after_code_files": [
      "mod/forum/index.php||mod/forum/index.php",
      "mod/forum/lib.php||mod/forum/lib.php",
      "mod/forum/markposts.php||mod/forum/markposts.php"
    ]
  },
  "patch_diff": {
    "mod/forum/index.php||mod/forum/index.php": [
      "File: mod/forum/index.php -> mod/forum/index.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "245:                 } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
      "246:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
      "247:                     $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
      "249:                 } else {",
      "250:                     $unreadlink = '<span class=\"read\">0</span>';",
      "251:                 }",
      "",
      "[Removed Lines]",
      "248:                                    $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
      "",
      "[Added Lines]",
      "248:                                    $forum->id.'&amp;mark=read&amp;sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "383:                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
      "384:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
      "385:                         $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
      "387:                     } else {",
      "388:                         $unreadlink = '<span class=\"read\">0</span>';",
      "389:                     }",
      "",
      "[Removed Lines]",
      "386:                                        $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
      "",
      "[Added Lines]",
      "386:                                        $forum->id.'&amp;mark=read&sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
      "",
      "---------------"
    ],
    "mod/forum/lib.php||mod/forum/lib.php": [
      "File: mod/forum/lib.php -> mod/forum/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "3741:                     echo $post->unread;",
      "3742:                     echo '</a>';",
      "3743:                     echo '<a title=\"'.$strmarkalldread.'\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
      "3745:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.$strmarkalldread.'\" /></a>';",
      "3746:                     echo '</span>';",
      "3747:                 } else {",
      "",
      "[Removed Lines]",
      "3744:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php\">' .",
      "",
      "[Added Lines]",
      "3744:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">' .",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "5433:                 if ($forumtracked) {",
      "5434:                     echo '<a title=\"'.get_string('markallread', 'forum').",
      "5435:                          '\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
      "5437:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.get_string('markallread', 'forum').'\" /></a>';",
      "5438:                 }",
      "5439:                 echo '</th>';",
      "",
      "[Removed Lines]",
      "5436:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php\">'.",
      "",
      "[Added Lines]",
      "5436:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">'.",
      "",
      "---------------"
    ],
    "mod/forum/markposts.php||mod/forum/markposts.php": [
      "File: mod/forum/markposts.php -> mod/forum/markposts.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "55: $user = $USER;",
      "57: require_login($course, false, $cm);",
      "59: if ($returnpage == 'index.php') {",
      "60:     $returnto = new moodle_url(\"/mod/forum/$returnpage\", array('id' => $course->id));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "58: require_sesskey();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "01408d619ba89d32f9ad83308990ff9b0374cb57",
      "candidate_info": {
        "commit_hash": "01408d619ba89d32f9ad83308990ff9b0374cb57",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/01408d619ba89d32f9ad83308990ff9b0374cb57",
        "files": [
          "mod/forum/index.php",
          "mod/forum/lib.php",
          "mod/forum/markposts.php"
        ],
        "message": "MDL-53755 forum: Check session when marking posts",
        "before_after_code_files": [
          "mod/forum/index.php||mod/forum/index.php",
          "mod/forum/lib.php||mod/forum/lib.php",
          "mod/forum/markposts.php||mod/forum/markposts.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ],
          "candidate": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/index.php||mod/forum/index.php": [
          "File: mod/forum/index.php -> mod/forum/index.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "230:                 } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "231:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "232:                     $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "234:                 } else {",
          "235:                     $unreadlink = '<span class=\"read\">0</span>';",
          "236:                 }",
          "",
          "[Removed Lines]",
          "233:                                    $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "233:                                    $forum->id.'&amp;mark=read&amp;sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "368:                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "369:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "370:                         $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "372:                     } else {",
          "373:                         $unreadlink = '<span class=\"read\">0</span>';",
          "374:                     }",
          "",
          "[Removed Lines]",
          "371:                                        $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "371:                                        $forum->id.'&amp;mark=read&sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------"
        ],
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3714:                     echo $post->unread;",
          "3715:                     echo '</a>';",
          "3716:                     echo '<a title=\"'.$strmarkalldread.'\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "3718:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.$strmarkalldread.'\" /></a>';",
          "3719:                     echo '</span>';",
          "3720:                 } else {",
          "",
          "[Removed Lines]",
          "3717:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php\">' .",
          "",
          "[Added Lines]",
          "3717:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">' .",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5402:                 if ($forumtracked) {",
          "5403:                     echo '<a title=\"'.get_string('markallread', 'forum').",
          "5404:                          '\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "5406:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.get_string('markallread', 'forum').'\" /></a>';",
          "5407:                 }",
          "5408:                 echo '</th>';",
          "",
          "[Removed Lines]",
          "5405:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php\">'.",
          "",
          "[Added Lines]",
          "5405:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">'.",
          "",
          "---------------"
        ],
        "mod/forum/markposts.php||mod/forum/markposts.php": [
          "File: mod/forum/markposts.php -> mod/forum/markposts.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "55: $user = $USER;",
          "57: require_login($course, false, $cm);",
          "59: if ($returnpage == 'index.php') {",
          "60:     $returnto = new moodle_url(\"/mod/forum/$returnpage\", array('id' => $course->id));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58: require_sesskey();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d98c24659935c1bdff4b35ec0a85ab1a3ab05d9f",
      "candidate_info": {
        "commit_hash": "d98c24659935c1bdff4b35ec0a85ab1a3ab05d9f",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d98c24659935c1bdff4b35ec0a85ab1a3ab05d9f",
        "files": [
          "mod/forum/index.php",
          "mod/forum/lib.php",
          "mod/forum/markposts.php"
        ],
        "message": "MDL-53755 forum: Check session when marking posts",
        "before_after_code_files": [
          "mod/forum/index.php||mod/forum/index.php",
          "mod/forum/lib.php||mod/forum/lib.php",
          "mod/forum/markposts.php||mod/forum/markposts.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ],
          "candidate": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/index.php||mod/forum/index.php": [
          "File: mod/forum/index.php -> mod/forum/index.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "230:                 } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "231:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "232:                     $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "234:                 } else {",
          "235:                     $unreadlink = '<span class=\"read\">0</span>';",
          "236:                 }",
          "",
          "[Removed Lines]",
          "233:                                    $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "233:                                    $forum->id.'&amp;mark=read&amp;sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "368:                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "369:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "370:                         $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "372:                     } else {",
          "373:                         $unreadlink = '<span class=\"read\">0</span>';",
          "374:                     }",
          "",
          "[Removed Lines]",
          "371:                                        $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "371:                                        $forum->id.'&amp;mark=read&sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------"
        ],
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3843:                     echo $post->unread;",
          "3844:                     echo '</a>';",
          "3845:                     echo '<a title=\"'.$strmarkalldread.'\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "3847:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.$strmarkalldread.'\" /></a>';",
          "3848:                     echo '</span>';",
          "3849:                 } else {",
          "",
          "[Removed Lines]",
          "3846:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php\">' .",
          "",
          "[Added Lines]",
          "3846:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">' .",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5530:                 if ($forumtracked) {",
          "5531:                     echo '<a title=\"'.get_string('markallread', 'forum').",
          "5532:                          '\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "5534:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.get_string('markallread', 'forum').'\" /></a>';",
          "5535:                 }",
          "5536:                 echo '</th>';",
          "",
          "[Removed Lines]",
          "5533:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php\">'.",
          "",
          "[Added Lines]",
          "5533:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">'.",
          "",
          "---------------"
        ],
        "mod/forum/markposts.php||mod/forum/markposts.php": [
          "File: mod/forum/markposts.php -> mod/forum/markposts.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "55: $user = $USER;",
          "57: require_login($course, false, $cm);",
          "59: if ($returnpage == 'index.php') {",
          "60:     $returnto = new moodle_url(\"/mod/forum/$returnpage\", array('id' => $course->id));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58: require_sesskey();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7873e36f0cc0ccfd1424ff9302eb1ea9e4e74305",
      "candidate_info": {
        "commit_hash": "7873e36f0cc0ccfd1424ff9302eb1ea9e4e74305",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/7873e36f0cc0ccfd1424ff9302eb1ea9e4e74305",
        "files": [
          "mod/forum/index.php",
          "mod/forum/lib.php",
          "mod/forum/markposts.php"
        ],
        "message": "MDL-53755 forum: Check session when marking posts",
        "before_after_code_files": [
          "mod/forum/index.php||mod/forum/index.php",
          "mod/forum/lib.php||mod/forum/lib.php",
          "mod/forum/markposts.php||mod/forum/markposts.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ],
          "candidate": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/index.php||mod/forum/index.php": [
          "File: mod/forum/index.php -> mod/forum/index.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "230:                 } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "231:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "232:                     $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "234:                 } else {",
          "235:                     $unreadlink = '<span class=\"read\">0</span>';",
          "236:                 }",
          "",
          "[Removed Lines]",
          "233:                                    $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "233:                                    $forum->id.'&amp;mark=read&amp;sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "368:                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "369:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "370:                         $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "372:                     } else {",
          "373:                         $unreadlink = '<span class=\"read\">0</span>';",
          "374:                     }",
          "",
          "[Removed Lines]",
          "371:                                        $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "371:                                        $forum->id.'&amp;mark=read&sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------"
        ],
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3805:                     echo $post->unread;",
          "3806:                     echo '</a>';",
          "3807:                     echo '<a title=\"'.$strmarkalldread.'\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "3809:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.$strmarkalldread.'\" /></a>';",
          "3810:                     echo '</span>';",
          "3811:                 } else {",
          "",
          "[Removed Lines]",
          "3808:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php\">' .",
          "",
          "[Added Lines]",
          "3808:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">' .",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5486:                 if ($forumtracked) {",
          "5487:                     echo '<a title=\"'.get_string('markallread', 'forum').",
          "5488:                          '\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "5490:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.get_string('markallread', 'forum').'\" /></a>';",
          "5491:                 }",
          "5492:                 echo '</th>';",
          "",
          "[Removed Lines]",
          "5489:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php\">'.",
          "",
          "[Added Lines]",
          "5489:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">'.",
          "",
          "---------------"
        ],
        "mod/forum/markposts.php||mod/forum/markposts.php": [
          "File: mod/forum/markposts.php -> mod/forum/markposts.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "55: $user = $USER;",
          "57: require_login($course, false, $cm);",
          "59: if ($returnpage == 'index.php') {",
          "60:     $returnto = forum_go_back_to(new moodle_url(\"/mod/forum/$returnpage\", array('id' => $course->id)));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58: require_sesskey();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1f5c494f761ef7961c449075adf192e149148e1a",
      "candidate_info": {
        "commit_hash": "1f5c494f761ef7961c449075adf192e149148e1a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1f5c494f761ef7961c449075adf192e149148e1a",
        "files": [
          "mod/forum/index.php",
          "mod/forum/lib.php",
          "mod/forum/markposts.php"
        ],
        "message": "MDL-53755 forum: Check session when marking posts",
        "before_after_code_files": [
          "mod/forum/index.php||mod/forum/index.php",
          "mod/forum/lib.php||mod/forum/lib.php",
          "mod/forum/markposts.php||mod/forum/markposts.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ],
          "candidate": [
            "mod/forum/index.php||mod/forum/index.php",
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/markposts.php||mod/forum/markposts.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/index.php||mod/forum/index.php": [
          "File: mod/forum/index.php -> mod/forum/index.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "228:                 } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "229:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "230:                     $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "232:                 } else {",
          "233:                     $unreadlink = '<span class=\"read\">0</span>';",
          "234:                 }",
          "",
          "[Removed Lines]",
          "231:                                    $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "231:                                    $forum->id.'&amp;mark=read&amp;sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "366:                     } else if ($unread = forum_tp_count_forum_unread_posts($cm, $course)) {",
          "367:                         $unreadlink = '<span class=\"unread\"><a href=\"view.php?f='.$forum->id.'\">'.$unread.'</a>';",
          "368:                         $unreadlink .= '<a title=\"'.$strmarkallread.'\" href=\"markposts.php?f='.",
          "370:                     } else {",
          "371:                         $unreadlink = '<span class=\"read\">0</span>';",
          "372:                     }",
          "",
          "[Removed Lines]",
          "369:                                        $forum->id.'&amp;mark=read\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "[Added Lines]",
          "369:                                        $forum->id.'&amp;mark=read&sesskey=' . sesskey() . '\"><img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" alt=\"'.$strmarkallread.'\" class=\"iconsmall\" /></a></span>';",
          "",
          "---------------"
        ],
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3913:                     echo $post->unread;",
          "3914:                     echo '</a>';",
          "3915:                     echo '<a title=\"'.$strmarkalldread.'\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "3917:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.$strmarkalldread.'\" /></a>';",
          "3918:                     echo '</span>';",
          "3919:                 } else {",
          "",
          "[Removed Lines]",
          "3916:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php\">' .",
          "",
          "[Added Lines]",
          "3916:                          $forum->id.'&amp;d='.$post->discussion.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">' .",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5824:                 if ($forumtracked) {",
          "5825:                     echo '<a title=\"'.get_string('markallread', 'forum').",
          "5826:                          '\" href=\"'.$CFG->wwwroot.'/mod/forum/markposts.php?f='.",
          "5828:                          '<img src=\"'.$OUTPUT->pix_url('t/markasread') . '\" class=\"iconsmall\" alt=\"'.get_string('markallread', 'forum').'\" /></a>';",
          "5829:                 }",
          "5830:                 echo '</th>';",
          "",
          "[Removed Lines]",
          "5827:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php\">'.",
          "",
          "[Added Lines]",
          "5827:                          $forum->id.'&amp;mark=read&amp;returnpage=view.php&amp;sesskey=' . sesskey() . '\">'.",
          "",
          "---------------"
        ],
        "mod/forum/markposts.php||mod/forum/markposts.php": [
          "File: mod/forum/markposts.php -> mod/forum/markposts.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "55: $user = $USER;",
          "57: require_login($course, false, $cm);",
          "59: if ($returnpage == 'index.php') {",
          "60:     $returnto = forum_go_back_to($returnpage.'?id='.$course->id);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58: require_sesskey();",
          "",
          "---------------"
        ]
      }
    }
  ]
}