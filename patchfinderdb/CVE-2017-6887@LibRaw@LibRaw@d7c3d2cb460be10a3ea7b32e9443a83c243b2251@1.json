{
  "cve_id": "CVE-2017-6887",
  "cve_desc": "A boundary error within the \"parse_tiff_ifd()\" function (internal/dcraw_common.cpp) in LibRaw versions before 0.18.2 can be exploited to cause a memory corruption via e.g. a specially crafted KDC file with model set to \"DSLR-A100\" and containing multiple sequences of 0x100 and 0x14A TAGs.",
  "repo": "LibRaw/LibRaw",
  "patch_hash": "d7c3d2cb460be10a3ea7b32e9443a83c243b2251",
  "patch_info": {
    "commit_hash": "d7c3d2cb460be10a3ea7b32e9443a83c243b2251",
    "repo": "LibRaw/LibRaw",
    "commit_url": "https://github.com/LibRaw/LibRaw/commit/d7c3d2cb460be10a3ea7b32e9443a83c243b2251",
    "files": [
      "dcraw/dcraw.c",
      "internal/dcraw_common.cpp"
    ],
    "message": "Secunia SA75000 advisory: several buffer overruns",
    "before_after_code_files": [
      "dcraw/dcraw.c||dcraw/dcraw.c",
      "internal/dcraw_common.cpp||internal/dcraw_common.cpp"
    ]
  },
  "patch_diff": {
    "dcraw/dcraw.c||dcraw/dcraw.c": [
      "File: dcraw/dcraw.c -> dcraw/dcraw.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "12870:         load_raw = &CLASS sony_arw_load_raw;",
      "12871:         data_offset = get4() + base;",
      "12872:         ifd++;",
      "12873:         break;",
      "12874:       }",
      "12875: #ifdef LIBRAW_LIBRARY_BUILD",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "12873: #ifdef LIBRAW_LIBRARY_BUILD",
      "12874:  if (ifd >= sizeof tiff_ifd / sizeof tiff_ifd[0])",
      "12875:    throw LIBRAW_EXCEPTION_IO_CORRUPT;",
      "12876: #endif",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "13177:       break;",
      "13179:     case 50455:",
      "13181:         break;",
      "13182: #ifndef LIBRAW_LIBRARY_BUILD",
      "13183:       fread(cbuf, 1, len, ifp);",
      "",
      "[Removed Lines]",
      "13180:       if (len > 2560000 || !(cbuf = (char *)malloc(len)))",
      "",
      "[Added Lines]",
      "13184:       if (len < 1 || len > 2560000 || !(cbuf = (char *)malloc(len)))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "14795:     }",
      "14796:     order = get2();",
      "14797:     hlen = get4();",
      "14799:     {",
      "14800: #ifdef LIBRAW_LIBRARY_BUILD",
      "14801:       imgdata.lens.makernotes.CameraMount = LIBRAW_MOUNT_FixedLens;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14802:     if (get4() == 0x48454150",
      "14803: #ifdef LIBRAW_LIBRARY_BUILD",
      "14804:  && (save+hlen) >= 0 && (save+hlen)<=ifp->size()",
      "14805: #endif",
      "",
      "---------------"
    ],
    "internal/dcraw_common.cpp||internal/dcraw_common.cpp": [
      "File: internal/dcraw_common.cpp -> internal/dcraw_common.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "11542:         load_raw = &CLASS sony_arw_load_raw;",
      "11543:         data_offset = get4() + base;",
      "11544:         ifd++;",
      "11545:         break;",
      "11546:       }",
      "11547: #ifdef LIBRAW_LIBRARY_BUILD",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "11545: #ifdef LIBRAW_LIBRARY_BUILD",
      "11546:  if (ifd >= sizeof tiff_ifd / sizeof tiff_ifd[0])",
      "11547:    throw LIBRAW_EXCEPTION_IO_CORRUPT;",
      "11548: #endif",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "11849:       break;",
      "11851:     case 50455:",
      "11853:         break;",
      "11854: #ifndef LIBRAW_LIBRARY_BUILD",
      "11855:       fread(cbuf, 1, len, ifp);",
      "",
      "[Removed Lines]",
      "11852:       if (len > 2560000 || !(cbuf = (char *)malloc(len)))",
      "",
      "[Added Lines]",
      "11856:       if (len < 1 || len > 2560000 || !(cbuf = (char *)malloc(len)))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "13467:     }",
      "13468:     order = get2();",
      "13469:     hlen = get4();",
      "13471:     {",
      "13472: #ifdef LIBRAW_LIBRARY_BUILD",
      "13473:       imgdata.lens.makernotes.CameraMount = LIBRAW_MOUNT_FixedLens;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13474:     if (get4() == 0x48454150",
      "13475: #ifdef LIBRAW_LIBRARY_BUILD",
      "13476:  && (save+hlen) >= 0 && (save+hlen)<=ifp->size()",
      "13477: #endif",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "82616eff4c7f7437e96bdeeed238c3ef3dc12d60",
      "candidate_info": {
        "commit_hash": "82616eff4c7f7437e96bdeeed238c3ef3dc12d60",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/82616eff4c7f7437e96bdeeed238c3ef3dc12d60",
        "files": [
          "Changelog.txt",
          "dcraw/dcraw.c",
          "internal/dcraw_common.cpp",
          "libraw/libraw_version.h"
        ],
        "message": "0.18.3",
        "before_after_code_files": [
          "dcraw/dcraw.c||dcraw/dcraw.c",
          "internal/dcraw_common.cpp||internal/dcraw_common.cpp",
          "libraw/libraw_version.h||libraw/libraw_version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "dcraw/dcraw.c||dcraw/dcraw.c",
            "internal/dcraw_common.cpp||internal/dcraw_common.cpp"
          ],
          "candidate": [
            "dcraw/dcraw.c||dcraw/dcraw.c",
            "internal/dcraw_common.cpp||internal/dcraw_common.cpp"
          ]
        }
      },
      "candidate_diff": {
        "dcraw/dcraw.c||dcraw/dcraw.c": [
          "File: dcraw/dcraw.c -> dcraw/dcraw.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3004:     checkCancel();",
          "3005: #endif",
          "3006:     FORC3 mul[c] = getbits(6);",
          "3007:     FORC3 {",
          "3008:       val = ((0x1000000/last[c] + 0x7ff) >> 12) * mul[c];",
          "3009:       s = val > 65564 ? 10:12;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3007: #ifdef LIBRAW_LIBRARY_BUILD",
          "3008:     if(!mul[0] || !mul[1] || !mul[2])",
          "3009:       throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "3010: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6159: void CLASS xtrans_interpolate (int passes)",
          "6160: {",
          "6161:   int c, d, f, g, h, i, v, ng, row, col, top, left, mrow, mcol;",
          "6162:   int val, ndir, pass, hm[8], avg[4], color[3][8];",
          "6163:   static const short orth[12] = { 1,0,0,1,-1,0,0,-1,1,0,0,1 },",
          "6164:  patt[2][16] = { { 0,1,0,-1,2,0,-1,0,1,1,1,-1,0,0,0,0 },",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6166: #ifdef LIBRAW_LIBRARY_BUILD",
          "6167:   int cstat[4]={0,0,0,0};",
          "6168: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "6176:     fprintf (stderr,_(\"%d-pass X-Trans interpolation...\\n\"), passes);",
          "6177: #endif",
          "6179:   cielab (0,0);",
          "6180:   ndir = 4 << (passes > 1);",
          "6181:   buffer = (char *) malloc (TS*TS*(ndir*11+6));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6187: #ifdef LIBRAW_LIBRARY_BUILD",
          "6189:   for (row = 0; row < 6; row++)",
          "6190:          for (col = 0; col < 6; col++)",
          "6191:                  cstat[fcol(row,col)]++;",
          "6193:   if(cstat[0] < 6 || cstat[0]>10 || cstat[1]< 16",
          "6194:     || cstat[1]>24 || cstat[2]< 6 || cstat[2]>10 || cstat[3])",
          "6195:          throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "6196: #endif",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "13267:       fuji_width = !(fgetc(ifp) & 8);",
          "13268:     } else if (tag == 0x131) {",
          "13269:       filters = 9;",
          "13271:     } else if (tag == 0x2ff0) {",
          "13272:       FORC4 cam_mul[c ^ 1] = get2();",
          "13273:     }",
          "",
          "[Removed Lines]",
          "13270:       FORC(36) xtrans_abs[0][35-c] = fgetc(ifp) & 3;",
          "",
          "[Added Lines]",
          "13290:       FORC(36)",
          "13291:         {",
          "13292:            int q = fgetc(ifp);",
          "13294:         }",
          "",
          "---------------"
        ],
        "internal/dcraw_common.cpp||internal/dcraw_common.cpp": [
          "File: internal/dcraw_common.cpp -> internal/dcraw_common.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "2716:     checkCancel();",
          "2717: #endif",
          "2718:     FORC3 mul[c] = getbits(6);",
          "2719:     FORC3 {",
          "2720:       val = ((0x1000000/last[c] + 0x7ff) >> 12) * mul[c];",
          "2721:       s = val > 65564 ? 10:12;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2719: #ifdef LIBRAW_LIBRARY_BUILD",
          "2720:     if(!mul[0] || !mul[1] || !mul[2])",
          "2721:       throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "2722: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4981: void CLASS xtrans_interpolate (int passes)",
          "4982: {",
          "4983:   int c, d, f, g, h, i, v, ng, row, col, top, left, mrow, mcol;",
          "4984:   int val, ndir, pass, hm[8], avg[4], color[3][8];",
          "4985:   static const short orth[12] = { 1,0,0,1,-1,0,0,-1,1,0,0,1 },",
          "4986:  patt[2][16] = { { 0,1,0,-1,2,0,-1,0,1,1,1,-1,0,0,0,0 },",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4988: #ifdef LIBRAW_LIBRARY_BUILD",
          "4989:   int cstat[4]={0,0,0,0};",
          "4990: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "4998:     fprintf (stderr,_(\"%d-pass X-Trans interpolation...\\n\"), passes);",
          "4999: #endif",
          "5001:   cielab (0,0);",
          "5002:   ndir = 4 << (passes > 1);",
          "5003:   buffer = (char *) malloc (TS*TS*(ndir*11+6));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5009: #ifdef LIBRAW_LIBRARY_BUILD",
          "5011:   for (row = 0; row < 6; row++)",
          "5012:          for (col = 0; col < 6; col++)",
          "5013:                  cstat[fcol(row,col)]++;",
          "5015:   if(cstat[0] < 6 || cstat[0]>10 || cstat[1]< 16",
          "5016:     || cstat[1]>24 || cstat[2]< 6 || cstat[2]>10 || cstat[3])",
          "5017:          throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "5018: #endif",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "10508:  if (!strcmp(model,\"DSLR-A100\") && tiff_ifd[ifd].t_width == 3872) {",
          "10509:    load_raw = &CLASS sony_arw_load_raw;",
          "10510:    data_offset = get4()+base;",
          "10512:  }",
          "10513: #ifdef LIBRAW_LIBRARY_BUILD",
          "10514:  if (!strncmp(make,\"Hasselblad\",10) && libraw_internal_data.unpacker_data.hasselblad_parser_flag) {",
          "",
          "[Removed Lines]",
          "10511:    ifd++;  break;",
          "",
          "[Added Lines]",
          "10531:    ifd++;",
          "10532: #ifdef LIBRAW_LIBRARY_BUILD",
          "10533:           if (ifd >= sizeof tiff_ifd / sizeof tiff_ifd[0])",
          "10534:           throw LIBRAW_EXCEPTION_IO_CORRUPT;",
          "10535: #endif",
          "10536:    break;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "10776:  break;",
          "10778:       case 50455:",
          "10780: #ifndef LIBRAW_LIBRARY_BUILD",
          "10781:  fread (cbuf, 1, len, ifp);",
          "10782: #else",
          "",
          "[Removed Lines]",
          "10779:  if (len > 2560000 || !(cbuf = (char *) malloc(len))) break;",
          "",
          "[Added Lines]",
          "10804:  if (len < 1 || len > 2560000 || !(cbuf = (char *) malloc(len))) break;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "12073:       fuji_width = !(fgetc(ifp) & 8);",
          "12074:     } else if (tag == 0x131) {",
          "12075:       filters = 9;",
          "12077:     } else if (tag == 0x2ff0) {",
          "12078:       FORC4 cam_mul[c ^ 1] = get2();",
          "12079:     }",
          "",
          "[Removed Lines]",
          "12076:       FORC(36) xtrans_abs[0][35-c] = fgetc(ifp) & 3;",
          "",
          "[Added Lines]",
          "12101:       FORC(36)",
          "12102:         {",
          "12103:            int q = fgetc(ifp);",
          "12105:         }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "12137:     }",
          "12138:     order = get2();",
          "12139:     hlen  = get4();",
          "12141:     {",
          "12142: #ifdef LIBRAW_LIBRARY_BUILD",
          "12143:       imgdata.lens.makernotes.CameraMount = LIBRAW_MOUNT_FixedLens;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12169:     if (get4() == 0x48454150",
          "12170: #ifdef LIBRAW_LIBRARY_BUILD",
          "12171:         && (save+hlen) >= 0 && (save+hlen)<=ifp->size()",
          "12172: #endif",
          "",
          "---------------"
        ],
        "libraw/libraw_version.h||libraw/libraw_version.h": [
          "File: libraw/libraw_version.h -> libraw/libraw_version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #define LIBRAW_MAJOR_VERSION  0",
          "24: #define LIBRAW_MINOR_VERSION  18",
          "26: #define LIBRAW_VERSION_TAIL   Release",
          "28: #define LIBRAW_SHLIB_CURRENT   16",
          "",
          "[Removed Lines]",
          "25: #define LIBRAW_PATCH_VERSION  2",
          "",
          "[Added Lines]",
          "25: #define LIBRAW_PATCH_VERSION  3",
          "",
          "---------------"
        ]
      }
    }
  ]
}