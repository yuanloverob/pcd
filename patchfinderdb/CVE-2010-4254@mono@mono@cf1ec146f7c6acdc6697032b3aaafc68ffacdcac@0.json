{
  "cve_id": "CVE-2010-4254",
  "cve_desc": "Mono, when Moonlight before 2.3.0.1 or 2.99.x before 2.99.0.10 is used, does not properly validate arguments to generic methods, which allows remote attackers to bypass generic constraints, and possibly execute arbitrary code, via a crafted method call.",
  "repo": "mono/mono",
  "patch_hash": "cf1ec146f7c6acdc6697032b3aaafc68ffacdcac",
  "patch_info": {
    "commit_hash": "cf1ec146f7c6acdc6697032b3aaafc68ffacdcac",
    "repo": "mono/mono",
    "commit_url": "https://github.com/mono/mono/commit/cf1ec146f7c6acdc6697032b3aaafc68ffacdcac",
    "files": [
      "mono/metadata/reflection.c",
      "mono/metadata/verify-internals.h",
      "mono/metadata/verify.c"
    ],
    "message": "Handle invalid instantiation of generic methods.\n\n\t* verify.c: Add new function to internal verifier API to check\n\tmethod instantiations.\n\n\t* reflection.c (mono_reflection_bind_generic_method_parameters):\n\tCheck the instantiation before returning it.\n\n\tFixes #655847",
    "before_after_code_files": [
      "mono/metadata/reflection.c||mono/metadata/reflection.c",
      "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
      "mono/metadata/verify.c||mono/metadata/verify.c"
    ]
  },
  "patch_diff": {
    "mono/metadata/reflection.c||mono/metadata/reflection.c": [
      "File: mono/metadata/reflection.c -> mono/metadata/reflection.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "10605:   mono_g_hash_table_insert (image->generic_def_objects, imethod, rmethod);",
      "10606:   mono_loader_unlock ();",
      "10607:  }",
      "10609:  return mono_method_get_object (mono_object_domain (rmethod), inflated, NULL);",
      "10610: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "10609:  if (!mono_verifier_is_method_valid_generic_instantiation (inflated))",
      "10610:   mono_raise_exception (mono_get_exception_argument (\"typeArguments\", \"Invalid generic arguments\"));",
      "",
      "---------------"
    ],
    "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h": [
      "File: mono/metadata/verify-internals.h -> mono/metadata/verify-internals.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: gboolean mono_verifier_is_method_full_trust (MonoMethod *method) MONO_INTERNAL;",
      "23: gboolean mono_verifier_is_class_full_trust (MonoClass *klass) MONO_INTERNAL;",
      "24: gboolean mono_verifier_class_is_valid_generic_instantiation (MonoClass *class) MONO_INTERNAL;",
      "26: gboolean mono_verifier_verify_class (MonoClass *klass) MONO_INTERNAL;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "25: gboolean mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method) MONO_INTERNAL;",
      "",
      "---------------"
    ],
    "mono/metadata/verify.c||mono/metadata/verify.c": [
      "File: mono/metadata/verify.c -> mono/metadata/verify.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "6042:  return mono_class_is_valid_generic_instantiation (NULL, class);",
      "6043: }",
      "6045: #else",
      "6047: gboolean",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6045: gboolean",
      "6046: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
      "6047: {",
      "6048:  if (!method->is_inflated)",
      "6049:   return TRUE;",
      "6050:  return mono_method_is_valid_generic_instantiation (NULL, method);",
      "6051: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "6113:  return TRUE;",
      "6114: }",
      "6117: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6124: gboolean",
      "6125: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
      "6126: {",
      "6127:  return TRUE;",
      "6128: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "eb2fd8e1f0346f6f3d1fe1843170b081e71a3820",
      "candidate_info": {
        "commit_hash": "eb2fd8e1f0346f6f3d1fe1843170b081e71a3820",
        "repo": "mono/mono",
        "commit_url": "https://github.com/mono/mono/commit/eb2fd8e1f0346f6f3d1fe1843170b081e71a3820",
        "files": [
          "mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs"
        ],
        "message": "Add regression test for #655847",
        "before_after_code_files": [
          "mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs||mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs||mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs": [
          "File: mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs -> mcs/class/corlib/Test/System.Reflection/MethodInfoTest.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "691:    Assert.AreSame (gmd, oi);",
          "692:   }",
          "694:   public class MyList<T>",
          "695:   {",
          "696:    public TOutput ConvertAll<TOutput> (Foo<T,TOutput> arg)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "694:   [Test]",
          "695:   [ExpectedException (typeof (ArgumentException))]",
          "696:   public void MakeGenericMethodRespectConstraints ()",
          "697:   {",
          "698:    var m = typeof (MethodInfoTest).GetMethod (\"TestMethod\");",
          "699:    m.MakeGenericMethod (typeof (Type));",
          "700:   }",
          "702:   public void TestMethod <T> () where T : string",
          "703:   {",
          "704:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4905ef1130feb26c3150b28b97e4a96752e0d399",
      "candidate_info": {
        "commit_hash": "4905ef1130feb26c3150b28b97e4a96752e0d399",
        "repo": "mono/mono",
        "commit_url": "https://github.com/mono/mono/commit/4905ef1130feb26c3150b28b97e4a96752e0d399",
        "files": [
          "mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h",
          "mono/metadata/verify.c"
        ],
        "message": "Handle invalid instantiation of generic methods.\n\n\t* verify.c: Add new function to internal verifier API to check\n\tmethod instantiations.\n\n\t* reflection.c (mono_reflection_bind_generic_method_parameters):\n\tCheck the instantiation before returning it.\n\n\tFixes #655847",
        "before_after_code_files": [
          "mono/metadata/reflection.c||mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
          "mono/metadata/verify.c||mono/metadata/verify.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ],
          "candidate": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ]
        }
      },
      "candidate_diff": {
        "mono/metadata/reflection.c||mono/metadata/reflection.c": [
          "File: mono/metadata/reflection.c -> mono/metadata/reflection.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10176:   mono_g_hash_table_insert (image->generic_def_objects, imethod, rmethod);",
          "10177:   mono_loader_unlock ();",
          "10178:  }",
          "10180:  return mono_method_get_object (mono_object_domain (rmethod), inflated, NULL);",
          "10181: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10180:  if (!mono_verifier_is_method_valid_generic_instantiation (inflated))",
          "10181:   mono_raise_exception (mono_get_exception_argument (\"typeArguments\", \"Invalid generic arguments\"));",
          "",
          "---------------"
        ],
        "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h": [
          "File: mono/metadata/verify-internals.h -> mono/metadata/verify-internals.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: gboolean mono_verifier_is_method_full_trust (MonoMethod *method) MONO_INTERNAL;",
          "23: gboolean mono_verifier_is_class_full_trust (MonoClass *klass) MONO_INTERNAL;",
          "24: gboolean mono_verifier_class_is_valid_generic_instantiation (MonoClass *class) MONO_INTERNAL;",
          "26: gboolean mono_verifier_verify_class (MonoClass *klass) MONO_INTERNAL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25: gboolean mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method) MONO_INTERNAL;",
          "",
          "---------------"
        ],
        "mono/metadata/verify.c||mono/metadata/verify.c": [
          "File: mono/metadata/verify.c -> mono/metadata/verify.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6533:  return mono_class_is_valid_generic_instantiation (NULL, class);",
          "6534: }",
          "6536: #else",
          "6538: gboolean",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6536: gboolean",
          "6537: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "6538: {",
          "6539:  if (!method->is_inflated)",
          "6540:   return TRUE;",
          "6541:  return mono_method_is_valid_generic_instantiation (NULL, method);",
          "6542: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6611:  return TRUE;",
          "6612: }",
          "6615: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6622: gboolean",
          "6623: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "6624: {",
          "6625:  return TRUE;",
          "6626: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "65292a69c837b8a5f7a392d34db63de592153358",
      "candidate_info": {
        "commit_hash": "65292a69c837b8a5f7a392d34db63de592153358",
        "repo": "mono/mono",
        "commit_url": "https://github.com/mono/mono/commit/65292a69c837b8a5f7a392d34db63de592153358",
        "files": [
          "mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h",
          "mono/metadata/verify.c"
        ],
        "message": "Handle invalid instantiation of generic methods.\n\n\t* verify.c: Add new function to internal verifier API to check\n\tmethod instantiations.\n\n\t* reflection.c (mono_reflection_bind_generic_method_parameters):\n\tCheck the instantiation before returning it.\n\n\tFixes #655847",
        "before_after_code_files": [
          "mono/metadata/reflection.c||mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
          "mono/metadata/verify.c||mono/metadata/verify.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ],
          "candidate": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ]
        }
      },
      "candidate_diff": {
        "mono/metadata/reflection.c||mono/metadata/reflection.c": [
          "File: mono/metadata/reflection.c -> mono/metadata/reflection.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10539:   mono_g_hash_table_insert (image->generic_def_objects, imethod, rmethod);",
          "10540:   mono_loader_unlock ();",
          "10541:  }",
          "10543:  return mono_method_get_object (mono_object_domain (rmethod), inflated, NULL);",
          "10544: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10543:  if (!mono_verifier_is_method_valid_generic_instantiation (inflated))",
          "10544:   mono_raise_exception (mono_get_exception_argument (\"typeArguments\", \"Invalid generic arguments\"));",
          "",
          "---------------"
        ],
        "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h": [
          "File: mono/metadata/verify-internals.h -> mono/metadata/verify-internals.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: gboolean mono_verifier_is_method_full_trust (MonoMethod *method) MONO_INTERNAL;",
          "23: gboolean mono_verifier_is_class_full_trust (MonoClass *klass) MONO_INTERNAL;",
          "24: gboolean mono_verifier_class_is_valid_generic_instantiation (MonoClass *class) MONO_INTERNAL;",
          "26: gboolean mono_verifier_verify_class (MonoClass *klass) MONO_INTERNAL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25: gboolean mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method) MONO_INTERNAL;",
          "",
          "---------------"
        ],
        "mono/metadata/verify.c||mono/metadata/verify.c": [
          "File: mono/metadata/verify.c -> mono/metadata/verify.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5958:  return mono_class_is_valid_generic_instantiation (NULL, class);",
          "5959: }",
          "5961: #else",
          "5963: gboolean",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5961: gboolean",
          "5962: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "5963: {",
          "5964:  if (!method->is_inflated)",
          "5965:   return TRUE;",
          "5966:  return mono_method_is_valid_generic_instantiation (NULL, method);",
          "5967: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6029:  return TRUE;",
          "6030: }",
          "6033: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6040: gboolean",
          "6041: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "6042: {",
          "6043:  return TRUE;",
          "6044: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6713acfcb51eb977a6260f32331d0173186bb55b",
      "candidate_info": {
        "commit_hash": "6713acfcb51eb977a6260f32331d0173186bb55b",
        "repo": "mono/mono",
        "commit_url": "https://github.com/mono/mono/commit/6713acfcb51eb977a6260f32331d0173186bb55b",
        "files": [
          "mono/metadata/class.c",
          "mono/metadata/icall.c",
          "mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h",
          "mono/metadata/verify.c"
        ],
        "message": "Fix for bnc#655847",
        "before_after_code_files": [
          "mono/metadata/class.c||mono/metadata/class.c",
          "mono/metadata/icall.c||mono/metadata/icall.c",
          "mono/metadata/reflection.c||mono/metadata/reflection.c",
          "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
          "mono/metadata/verify.c||mono/metadata/verify.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ],
          "candidate": [
            "mono/metadata/reflection.c||mono/metadata/reflection.c",
            "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h",
            "mono/metadata/verify.c||mono/metadata/verify.c"
          ]
        }
      },
      "candidate_diff": {
        "mono/metadata/class.c||mono/metadata/class.c": [
          "File: mono/metadata/class.c -> mono/metadata/class.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4467:    setup_interface_offsets (class, 0);",
          "4468:  }",
          "4470:  goto leave;",
          "4472:  leave:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4470:  if (class->generic_class && !mono_verifier_class_is_valid_generic_instantiation (class))",
          "4471:   mono_class_set_failure (class, MONO_EXCEPTION_TYPE_LOAD, g_strdup (\"Invalid generic instantiation\"));",
          "",
          "---------------"
        ],
        "mono/metadata/icall.c||mono/metadata/icall.c": [
          "File: mono/metadata/icall.c -> mono/metadata/icall.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: #include <mono/metadata/security-core-clr.h>",
          "68: #include <mono/metadata/mono-perfcounters.h>",
          "69: #include <mono/metadata/mono-debug.h>",
          "70: #include <mono/io-layer/io-layer.h>",
          "71: #include <mono/utils/strtod.h>",
          "72: #include <mono/utils/monobitset.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: #include <mono/metadata/verify-internals.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2432: static MonoReflectionType*",
          "2433: ves_icall_Type_MakeGenericType (MonoReflectionType *type, MonoArray *type_array)",
          "2434: {",
          "2435:  MonoType *geninst, **types;",
          "2436:  int i, count;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2436:  MonoClass *class;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2450:  if (!geninst)",
          "2451:   return NULL;",
          "2453:  return mono_type_get_object (mono_object_domain (type), geninst);",
          "2454: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2455:  class = mono_class_from_mono_type (geninst);",
          "2458:  if (class->generic_class && !mono_verifier_class_is_valid_generic_instantiation (class))",
          "2459:   mono_raise_exception (mono_get_exception_argument (\"method\", \"Invalid generic arguments\"));",
          "",
          "---------------"
        ],
        "mono/metadata/reflection.c||mono/metadata/reflection.c": [
          "File: mono/metadata/reflection.c -> mono/metadata/reflection.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10057:   mono_g_hash_table_insert (image->generic_def_objects, imethod, rmethod);",
          "10058:   mono_loader_unlock ();",
          "10059:  }",
          "10061:  return mono_method_get_object (mono_object_domain (rmethod), inflated, NULL);",
          "10062: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10061:  if (!mono_verifier_is_method_valid_generic_instantiation (inflated))",
          "10062:   mono_raise_exception (mono_get_exception_argument (\"typeArguments\", \"Invalid generic arguments\"));",
          "",
          "---------------"
        ],
        "mono/metadata/verify-internals.h||mono/metadata/verify-internals.h": [
          "File: mono/metadata/verify-internals.h -> mono/metadata/verify-internals.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: gboolean mono_verifier_is_method_full_trust (MonoMethod *method) MONO_INTERNAL;",
          "23: gboolean mono_verifier_is_class_full_trust (MonoClass *klass) MONO_INTERNAL;",
          "25: gboolean mono_verifier_verify_class (MonoClass *klass) MONO_INTERNAL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: gboolean mono_verifier_class_is_valid_generic_instantiation (MonoClass *class) MONO_INTERNAL;",
          "25: gboolean mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method) MONO_INTERNAL;",
          "",
          "---------------"
        ],
        "mono/metadata/verify.c||mono/metadata/verify.c": [
          "File: mono/metadata/verify.c -> mono/metadata/verify.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6271:   return FALSE;",
          "6272:  return TRUE;",
          "6273: }",
          "6274: #else",
          "6276: gboolean",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6275: gboolean",
          "6276: mono_verifier_class_is_valid_generic_instantiation (MonoClass *class)",
          "6277: {",
          "6278:  if (!mono_verifier_is_enabled_for_class (class))",
          "6279:   return TRUE;",
          "6280:  return mono_class_is_valid_generic_instantiation (NULL, class);",
          "6281: }",
          "6283: gboolean",
          "6284: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "6285: {",
          "6286:  if (!method->is_inflated)",
          "6287:   return TRUE;",
          "6288:  if (!mono_verifier_is_enabled_for_method (method))",
          "6289:   return TRUE;",
          "6290:  return mono_method_is_valid_generic_instantiation (NULL, method);",
          "6291: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6343:  return NULL;",
          "6344: }",
          "6345: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6365: gboolean",
          "6366: mono_verifier_class_is_valid_generic_instantiation (MonoClass *class)",
          "6367: {",
          "6368:  return TRUE;",
          "6369: }",
          "6371: gboolean",
          "6372: mono_verifier_is_method_valid_generic_instantiation (MonoMethod *method)",
          "6373: {",
          "6374:  return TRUE;",
          "6375: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}