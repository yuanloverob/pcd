{
  "cve_id": "CVE-2014-2270",
  "cve_desc": "softmagic.c in file before 5.17 and libmagic allows context-dependent attackers to cause a denial of service (out-of-bounds memory access and crash) via crafted offsets in the softmagic of a PE executable.",
  "repo": "file/file",
  "patch_hash": "447558595a3650db2886cd2f416ad0beba965801",
  "patch_info": {
    "commit_hash": "447558595a3650db2886cd2f416ad0beba965801",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/447558595a3650db2886cd2f416ad0beba965801",
    "files": [
      "src/softmagic.c"
    ],
    "message": "PR/313: Aaron Reffett: Check properly for exceeding the offset.",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.170 2014/01/06 02:25:32 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.171 2014/01/08 22:02:06 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71: private void cvt_32(union VALUETYPE *, const struct magic *);",
      "72: private void cvt_64(union VALUETYPE *, const struct magic *);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "74: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) >= ((n) - (o)))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1223:   }",
      "1224:   switch (in_type = cvt_flip(m->in_type, flip)) {",
      "1225:   case FILE_BYTE:",
      "1227:     return 0;",
      "1228:    if (off) {",
      "1229:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1226:    if (nbytes < offset || nbytes < (offset + 1))",
      "",
      "[Added Lines]",
      "1227:    if (OFFSET_OOB(nbytes, offset, 1))",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1258:     offset = ~offset;",
      "1259:    break;",
      "1260:   case FILE_BESHORT:",
      "1262:     return 0;",
      "1263:    if (off) {",
      "1264:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1261:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1262:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1310:     offset = ~offset;",
      "1311:    break;",
      "1312:   case FILE_LESHORT:",
      "1314:     return 0;",
      "1315:    if (off) {",
      "1316:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1313:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1314:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1362:     offset = ~offset;",
      "1363:    break;",
      "1364:   case FILE_SHORT:",
      "1366:     return 0;",
      "1367:    if (off) {",
      "1368:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1365:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1366:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1399:    break;",
      "1400:   case FILE_BELONG:",
      "1401:   case FILE_BEID3:",
      "1403:     return 0;",
      "1404:    if (off) {",
      "1405:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1402:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1403:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1470:    break;",
      "1471:   case FILE_LELONG:",
      "1472:   case FILE_LEID3:",
      "1474:     return 0;",
      "1475:    if (off) {",
      "1476:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1473:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1474:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1540:     offset = ~offset;",
      "1541:    break;",
      "1542:   case FILE_MELONG:",
      "1544:     return 0;",
      "1545:    if (off) {",
      "1546:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1543:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1544:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1610:     offset = ~offset;",
      "1611:    break;",
      "1612:   case FILE_LONG:",
      "1614:     return 0;",
      "1615:    if (off) {",
      "1616:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1613:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1614:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1688:  switch (m->type) {",
      "1689:  case FILE_BYTE:",
      "1691:    return 0;",
      "1692:   break;",
      "1694:  case FILE_SHORT:",
      "1695:  case FILE_BESHORT:",
      "1696:  case FILE_LESHORT:",
      "1698:    return 0;",
      "1699:   break;",
      "",
      "[Removed Lines]",
      "1697:   if (nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1691:   if (OFFSET_OOB(nbytes, offset, 1))",
      "1698:   if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1713:  case FILE_FLOAT:",
      "1714:  case FILE_BEFLOAT:",
      "1715:  case FILE_LEFLOAT:",
      "1717:    return 0;",
      "1718:   break;",
      "1720:  case FILE_DOUBLE:",
      "1721:  case FILE_BEDOUBLE:",
      "1722:  case FILE_LEDOUBLE:",
      "1724:    return 0;",
      "1725:   break;",
      "1727:  case FILE_STRING:",
      "1728:  case FILE_PSTRING:",
      "1729:  case FILE_SEARCH:",
      "1731:    return 0;",
      "1732:   break;",
      "1734:  case FILE_REGEX:",
      "1736:    return 0;",
      "1737:   break;",
      "1739:  case FILE_INDIRECT:",
      "1741:    return 0;",
      "1742:   sbuf = ms->o.buf;",
      "1743:   soffset = ms->offset;",
      "",
      "[Removed Lines]",
      "1716:   if (nbytes < (offset + 4))",
      "1723:   if (nbytes < (offset + 8))",
      "1730:   if (nbytes < (offset + m->vallen))",
      "1735:   if (nbytes < offset)",
      "1740:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1717:   if (OFFSET_OOB(nbytes, offset, 4))",
      "1724:   if (OFFSET_OOB(nbytes, offset, 8))",
      "1731:   if (OFFSET_OOB(nbytes, offset, m->vallen))",
      "1736:   if (OFFSET_OOB(nbytes, offset, 0))",
      "1741:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1761:   return rv;",
      "1763:  case FILE_USE:",
      "1765:    return 0;",
      "1766:   sbuf = m->value.s;",
      "1767:   if (*sbuf == '^') {",
      "",
      "[Removed Lines]",
      "1764:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1765:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6ce24f35cd4a43c4bdd249e8e0c4952c1f8eac67",
      "candidate_info": {
        "commit_hash": "6ce24f35cd4a43c4bdd249e8e0c4952c1f8eac67",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/6ce24f35cd4a43c4bdd249e8e0c4952c1f8eac67",
        "files": [
          "ChangeLog",
          "doc/file.man",
          "doc/libmagic.man",
          "src/apprentice.c",
          "src/ascmagic.c",
          "src/elfclass.h",
          "src/file.c",
          "src/file.h",
          "src/funcs.c",
          "src/magic.c",
          "src/magic.h.in",
          "src/softmagic.c"
        ],
        "message": "Kill -R and replace with -P param=value. Allow setting of 4 parameters:     indir, name, shnum, phnum.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/ascmagic.c||src/ascmagic.c",
          "src/elfclass.h||src/elfclass.h",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/magic.c||src/magic.c",
          "src/magic.h.in||src/magic.h.in",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.223 2014/11/12 15:28:34 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.224 2014/11/27 15:40:36 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "524:   ms->mlist[i] = NULL;",
          "525:  ms->file = \"unknown\";",
          "526:  ms->line = 0;",
          "528:  return ms;",
          "529: free:",
          "530:  free(ms);",
          "",
          "[Removed Lines]",
          "527:  ms->max_recursion = FILE_MAX_RECURSION;",
          "",
          "[Added Lines]",
          "527:  ms->indir_recursion = FILE_INDIR_RECURSION;",
          "528:  ms->name_recursion = FILE_NAME_RECURSION;",
          "529:  ms->shnum_max = FILE_ELF_SHNUM;",
          "530:  ms->phnum_max = FILE_ELF_PHNUM;",
          "",
          "---------------"
        ],
        "src/ascmagic.c||src/ascmagic.c": [
          "File: src/ascmagic.c -> src/ascmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.87 2013/09/17 15:51:22 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.88 2014/02/12 23:20:53 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:       == NULL)",
          "148:    goto done;",
          "149:   if ((rv = file_softmagic(ms, utf8_buf,",
          "151:    rv = -1;",
          "152:  }",
          "",
          "[Removed Lines]",
          "150:       (size_t)(utf8_end - utf8_buf), 0, TEXTTEST, text)) == 0)",
          "",
          "[Added Lines]",
          "150:       (size_t)(utf8_end - utf8_buf), 0, 0, TEXTTEST, text)) == 0)",
          "",
          "---------------"
        ],
        "src/elfclass.h||src/elfclass.h": [
          "File: src/elfclass.h -> src/elfclass.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: #ifdef ELFCORE",
          "37:  case ET_CORE:",
          "38:   phnum = elf_getu16(swap, elfhdr.e_phnum);",
          "40:    return toomany(ms, \"program\", phnum);",
          "41:   flags |= FLAGS_IS_CORE;",
          "42:   if (dophn_core(ms, clazz, swap, fd,",
          "",
          "[Removed Lines]",
          "39:   if (phnum > MAX_PHNUM)",
          "",
          "[Added Lines]",
          "39:   if (phnum > ms->phnum_max)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49:  case ET_EXEC:",
          "50:  case ET_DYN:",
          "51:   phnum = elf_getu16(swap, elfhdr.e_phnum);",
          "53:    return toomany(ms, \"program\", phnum);",
          "54:   shnum = elf_getu16(swap, elfhdr.e_shnum);",
          "56:    return toomany(ms, \"section\", shnum);",
          "57:   if (dophn_exec(ms, clazz, swap, fd,",
          "58:       (off_t)elf_getu(swap, elfhdr.e_phoff), phnum,",
          "",
          "[Removed Lines]",
          "52:   if (phnum > MAX_PHNUM)",
          "55:   if (shnum > MAX_SHNUM)",
          "",
          "[Added Lines]",
          "52:   if (phnum > ms->phnum_max)",
          "55:   if (shnum > ms->shnum_max)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "63:  case ET_REL:",
          "64:   shnum = elf_getu16(swap, elfhdr.e_shnum);",
          "66:    return toomany(ms, \"section\", shnum);",
          "67:   if (doshn(ms, clazz, swap, fd,",
          "68:       (off_t)elf_getu(swap, elfhdr.e_shoff), shnum,",
          "",
          "[Removed Lines]",
          "65:   if (shnum > MAX_SHNUM)",
          "",
          "[Added Lines]",
          "65:   if (shnum > ms->shnum_max)",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.155 2014/10/11 15:03:16 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.156 2014/11/27 15:40:36 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98: #undef OPT_LONGONLY",
          "99:     {0, 0, NULL, 0}",
          "100: };",
          "103: private const struct {",
          "104:  const char *name;",
          "",
          "[Removed Lines]",
          "101: #define OPTSTRING \"bcCde:Ef:F:hiklLm:nNprR:svz0\"",
          "",
          "[Added Lines]",
          "101: #define OPTSTRING \"bcCde:Ef:F:hiklLm:nNpP:rsvz0\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "117: };",
          "121: private void usage(void);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119: private struct {",
          "120:  const char *name;",
          "121:  int tag;",
          "122:  size_t value;",
          "123: } pm[] = {",
          "124:  { \"indir\", MAGIC_PARAM_INDIR_RECURSION, 0 },",
          "125:  { \"name\", MAGIC_PARAM_NAME_RECURSION, 0 },",
          "126:  { \"phnum\", MAGIC_PARAM_PHNUM_MAX, 0 },",
          "127:  { \"shnum\", MAGIC_PARAM_SHNUM_MAX, 0 },",
          "128: };",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "125: private int unwrap(struct magic_set *, const char *);",
          "126: private int process(struct magic_set *ms, const char *, int);",
          "127: private struct magic_set *load(const char *, int);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "139: private void setparam(const char *);",
          "140: private void applyparam(magic_t);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "137:  size_t i;",
          "138:  int action = 0, didsomefiles = 0, errflg = 0;",
          "139:  int flags = 0, e = 0;",
          "141:  struct magic_set *magic = NULL;",
          "142:  int longindex;",
          "",
          "[Removed Lines]",
          "140:  size_t max_recursion = 0;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "243:    flags |= MAGIC_PRESERVE_ATIME;",
          "244:    break;",
          "245: #endif",
          "246:   case 'r':",
          "247:    flags |= MAGIC_RAW;",
          "248:    break;",
          "251:    break;",
          "252:   case 's':",
          "253:    flags |= MAGIC_DEVICES;",
          "",
          "[Removed Lines]",
          "249:   case 'R':",
          "250:    max_recursion = atoi(optarg);",
          "",
          "[Added Lines]",
          "258:   case 'P':",
          "259:    setparam(optarg);",
          "260:    break;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "326:   if (magic == NULL)",
          "327:    if ((magic = load(magicfile, flags)) == NULL)",
          "328:     return 1;",
          "339:  }",
          "341:  if (optind == argc) {",
          "",
          "[Removed Lines]",
          "329:   if (max_recursion) {",
          "330:    if (magic_setparam(magic, MAGIC_PARAM_MAX_RECURSION,",
          "331:        &max_recursion) == -1) {",
          "332:     (void)fprintf(stderr,",
          "333:         \"%s: Can't set recurision %s\\n\", progname,",
          "334:         strerror(errno));",
          "335:     return 1;",
          "336:    }",
          "337:   }",
          "338:   break;",
          "",
          "[Added Lines]",
          "342:   applyparam(magic);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "365:  return e;",
          "366: }",
          "369: private struct magic_set *",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "372: private void",
          "373: applyparam(magic_t magic)",
          "374: {",
          "375:  size_t i;",
          "377:  for (i = 0; i < __arraycount(pm); i++) {",
          "378:   if (pm[i].value == 0)",
          "379:    continue;",
          "380:   if (magic_setparam(magic, pm[i].tag, &pm[i].value) == -1) {",
          "381:    (void)fprintf(stderr, \"%s: Can't set %s %s\\n\", progname,",
          "382:     pm[i].name, strerror(errno));",
          "383:    exit(1);",
          "384:   }",
          "385:  }",
          "386: }",
          "388: private void",
          "389: setparam(const char *p)",
          "390: {",
          "391:  size_t i;",
          "392:  char *s;",
          "394:  if ((s = strchr(p, '=')) == NULL)",
          "395:   goto badparm;",
          "397:  for (i = 0; i < __arraycount(pm); i++) {",
          "398:   if (strncmp(p, pm[i].name, s - p) != 0)",
          "399:    continue;",
          "400:   pm[i].value = atoi(s + 1);",
          "401:   return;",
          "402:  }",
          "403: badparm:",
          "404:  (void)fprintf(stderr, \"%s: Unknown param %s\\n\", progname, p);",
          "405:  exit(1);",
          "406: }",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "406: };",
          "",
          "[Removed Lines]",
          "404:  size_t max_recursion;",
          "405: #define FILE_MAX_RECURSION 15",
          "",
          "[Added Lines]",
          "404:  uint16_t indir_recursion;",
          "405:  uint16_t name_recursion;",
          "406:  uint16_t shnum_max;",
          "407:  uint16_t phnum_max;",
          "408: #define FILE_INDIR_RECURSION 15",
          "409: #define FILE_NAME_RECURSION 40",
          "410: #define FILE_ELF_SHNUM  32768",
          "411: #define FILE_ELF_PHNUM  128",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "442:     unichar **, size_t *, const char **, const char **, const char **);",
          "443: protected int file_is_tar(struct magic_set *, const unsigned char *, size_t);",
          "444: protected int file_softmagic(struct magic_set *, const unsigned char *, size_t,",
          "446: protected int file_apprentice(struct magic_set *, const char *, int);",
          "447: protected int buffer_apprentice(struct magic_set *, struct magic **,",
          "448:     size_t *, size_t);",
          "",
          "[Removed Lines]",
          "445:     size_t, int, int);",
          "",
          "[Added Lines]",
          "451:     uint16_t, uint16_t, int, int);",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.73 2014/09/10 18:41:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.74 2014/11/23 13:54:27 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "229:  if ((ms->flags & MAGIC_NO_CHECK_SOFT) == 0)",
          "231:       looks_text)) != 0) {",
          "232:    if ((ms->flags & MAGIC_DEBUG) != 0)",
          "233:     (void)fprintf(stderr, \"softmagic %d\\n\", m);",
          "",
          "[Removed Lines]",
          "230:   if ((m = file_softmagic(ms, ubuf, nb, 0, BINTEST,",
          "",
          "[Added Lines]",
          "230:   if ((m = file_softmagic(ms, ubuf, nb, 0, 0, BINTEST,",
          "",
          "---------------"
        ],
        "src/magic.c||src/magic.c": [
          "File: src/magic.c -> src/magic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include \"file.h\"",
          "35: #ifndef lint",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.85 2014/08/04 06:19:44 christos Exp $\")",
          "",
          "[Added Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.86 2014/11/27 15:40:36 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "541: magic_setparam(struct magic_set *ms, int param, const void *val)",
          "542: {",
          "543:  switch (param) {",
          "546:   return 0;",
          "547:  default:",
          "548:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "544:  case MAGIC_PARAM_MAX_RECURSION:",
          "545:   ms->max_recursion = *(const size_t *)val;",
          "",
          "[Added Lines]",
          "544:  case MAGIC_PARAM_INDIR_RECURSION:",
          "545:   ms->indir_recursion = *(const size_t *)val;",
          "546:   return 0;",
          "547:  case MAGIC_PARAM_NAME_RECURSION:",
          "548:   ms->name_recursion = *(const size_t *)val;",
          "549:   return 0;",
          "550:  case MAGIC_PARAM_PHNUM_MAX:",
          "551:   ms->phnum_max = *(const size_t *)val;",
          "552:   return 0;",
          "553:  case MAGIC_PARAM_SHNUM_MAX:",
          "554:   ms->shnum_max = *(const size_t *)val;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "554: magic_getparam(struct magic_set *ms, int param, void *val)",
          "555: {",
          "556:  switch (param) {",
          "559:   return 0;",
          "560:  default:",
          "561:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "557:  case MAGIC_PARAM_MAX_RECURSION:",
          "",
          "[Added Lines]",
          "566:  case MAGIC_PARAM_INDIR_RECURSION:",
          "568:   return 0;",
          "569:  case MAGIC_PARAM_NAME_RECURSION:",
          "571:   return 0;",
          "572:  case MAGIC_PARAM_PHNUM_MAX:",
          "574:   return 0;",
          "575:  case MAGIC_PARAM_SHNUM_MAX:",
          "",
          "---------------"
        ],
        "src/magic.h.in||src/magic.h.in": [
          "File: src/magic.h.in -> src/magic.h.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "103: int magic_list(magic_t, const char *);",
          "104: int magic_errno(magic_t);",
          "107: int magic_setparam(magic_t, int, const void *);",
          "108: int magic_getparam(magic_t, int, void *);",
          "",
          "[Removed Lines]",
          "106: #define MAGIC_PARAM_MAX_RECURSION 0",
          "",
          "[Added Lines]",
          "106: #define MAGIC_PARAM_INDIR_RECURSION 0",
          "107: #define MAGIC_PARAM_NAME_RECURSION 1",
          "108: #define MAGIC_PARAM_PHNUM_MAX  2",
          "109: #define MAGIC_PARAM_SHNUM_MAX  3",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.198 2014/11/23 13:54:27 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.199 2014/11/27 15:40:36 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: #include <time.h>",
          "45: private int match(struct magic_set *, struct magic *, uint32_t,",
          "48: private int mget(struct magic_set *, const unsigned char *,",
          "51: private int magiccheck(struct magic_set *, struct magic *);",
          "52: private int32_t mprint(struct magic_set *, struct magic *);",
          "53: private int32_t moffset(struct magic_set *, struct magic *);",
          "",
          "[Removed Lines]",
          "46:     const unsigned char *, size_t, size_t, int, int, int, size_t, int *, int *,",
          "47:     int *);",
          "49:     struct magic *, size_t, size_t, unsigned int, int, int, int, size_t, int *,",
          "50:     int *, int *);",
          "",
          "[Added Lines]",
          "46:     const unsigned char *, size_t, size_t, int, int, int, uint16_t, uint16_t,",
          "47:     int *, int *, int *);",
          "49:     struct magic *, size_t, size_t, unsigned int, int, int, int, uint16_t,",
          "50:     uint16_t, int *, int *, int *);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "72: protected int",
          "73: file_softmagic(struct magic_set *ms, const unsigned char *buf, size_t nbytes,",
          "75: {",
          "76:  struct mlist *ml;",
          "77:  int rv, printed_something = 0, need_separator = 0;",
          "79:  for (ml = ms->mlist[0]->next; ml != ms->mlist[0]; ml = ml->next)",
          "80:   if ((rv = match(ms, ml->magic, ml->nmagic, buf, nbytes, 0, mode,",
          "83:    return rv;",
          "85:  return 0;",
          "",
          "[Removed Lines]",
          "74:     size_t level, int mode, int text)",
          "81:       text, 0, level, &printed_something, &need_separator,",
          "82:       NULL)) != 0)",
          "",
          "[Added Lines]",
          "74:     uint16_t indir_level, uint16_t name_level, int mode, int text)",
          "81:       text, 0, indir_level, name_level, &printed_something,",
          "82:       &need_separator, NULL)) != 0)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "134: private int",
          "135: match(struct magic_set *ms, struct magic *magic, uint32_t nmagic,",
          "136:     const unsigned char *s, size_t nbytes, size_t offset, int mode, int text,",
          "138:     int *need_separator, int *returnval)",
          "139: {",
          "140:  uint32_t magindex = 0;",
          "",
          "[Removed Lines]",
          "137:     int flip, size_t recursion_level, int *printed_something,",
          "",
          "[Added Lines]",
          "137:     int flip, uint16_t indir_level, uint16_t name_level, int *printed_something,",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "174:   switch (mget(ms, s, m, nbytes, offset, cont_level, mode, text,",
          "176:       need_separator, returnval)) {",
          "177:   case -1:",
          "178:    return -1;",
          "",
          "[Removed Lines]",
          "175:       flip, recursion_level + 1, printed_something,",
          "",
          "[Added Lines]",
          "175:       flip, indir_level, name_level, printed_something,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "261:    }",
          "262: #endif",
          "263:    switch (mget(ms, s, m, nbytes, offset, cont_level, mode,",
          "266:    case -1:",
          "267:     return -1;",
          "268:    case 0:",
          "",
          "[Removed Lines]",
          "264:        text, flip, recursion_level + 1, printed_something,",
          "265:        need_separator, returnval)) {",
          "",
          "[Added Lines]",
          "264:        text, flip, indir_level, name_level,",
          "265:        printed_something, need_separator, returnval)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1215: private int",
          "1216: mget(struct magic_set *ms, const unsigned char *s, struct magic *m,",
          "1217:     size_t nbytes, size_t o, unsigned int cont_level, int mode, int text,",
          "1219:     int *need_separator, int *returnval)",
          "1220: {",
          "1221:  uint32_t offset = ms->offset;",
          "",
          "[Removed Lines]",
          "1218:     int flip, size_t recursion_level, int *printed_something,",
          "",
          "[Added Lines]",
          "1218:     int flip, uint16_t indir_level, uint16_t name_level, int *printed_something,",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1226:  union VALUETYPE *p = &ms->ms_value;",
          "1227:  struct mlist ml;",
          "1232:   return -1;",
          "1233:  }",
          "",
          "[Removed Lines]",
          "1229:  if (recursion_level >= ms->max_recursion) {",
          "1230:   file_error(ms, 0, \"recursion nesting (%zu) exceeded\",",
          "1231:       recursion_level);",
          "",
          "[Added Lines]",
          "1229:  if (indir_level >= ms->indir_recursion) {",
          "1230:   file_error(ms, 0, \"indirect recursion nesting (%hu) exceeded\",",
          "1231:       indir_level);",
          "1232:   return -1;",
          "1233:  }",
          "1235:  if (name_level >= ms->name_recursion) {",
          "1236:   file_error(ms, 0, \"name recursion nesting (%hu) exceeded\",",
          "1237:       name_level);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1680:    return -1;",
          "1682:   rv = file_softmagic(ms, s + offset, nbytes - offset,",
          "1685:   if ((ms->flags & MAGIC_DEBUG) != 0)",
          "1686:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
          "",
          "[Removed Lines]",
          "1683:       recursion_level, BINTEST, text);",
          "",
          "[Added Lines]",
          "1689:       indir_level + 1, name_level, BINTEST, text);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1720:   if (m->flag & NOSPACE)",
          "1722:   rv = match(ms, ml.magic, ml.nmagic, s, nbytes, offset + o,",
          "1725:   if (rv != 1)",
          "1727:   return rv;",
          "",
          "[Removed Lines]",
          "1723:       mode, text, flip, recursion_level, printed_something,",
          "1724:       need_separator, returnval);",
          "",
          "[Added Lines]",
          "1729:       mode, text, flip, indir_level, name_level + 1,",
          "1730:       printed_something, need_separator, returnval);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "67cbe92f0620f11abba534471359afc0688baca4",
      "candidate_info": {
        "commit_hash": "67cbe92f0620f11abba534471359afc0688baca4",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/67cbe92f0620f11abba534471359afc0688baca4",
        "files": [
          "src/softmagic.c"
        ],
        "message": "handle NOSPACE in indirect and use magic.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.161 2013/02/26 21:03:14 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.162 2013/02/27 00:27:15 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1113:  return 0;",
          "1114: }",
          "1116: private int",
          "1117: mget(struct magic_set *ms, const unsigned char *s, struct magic *m,",
          "1118:     size_t nbytes, size_t o, unsigned int cont_level, int mode, int text,",
          "1119:     int flip, int recursion_level, int *returnval)",
          "1120: {",
          "1122:  uint32_t count = m->str_range;",
          "1123:  int rv;",
          "1124:  char *sbuf, *rbuf;",
          "",
          "[Removed Lines]",
          "1121:  uint32_t offset = ms->offset;",
          "",
          "[Added Lines]",
          "1116: static void",
          "1117: trim(char *s) {",
          "1118:  size_t l = strlen(s);",
          "1119:  if (l > 0 && s[l - 1] == ' ')",
          "1120:   s[l - 1] = '\\0';",
          "1121: }",
          "1128:  uint32_t soffset, offset = ms->offset;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1700:   if (nbytes < offset)",
          "1701:    return 0;",
          "1702:   sbuf = ms->o.buf;",
          "1703:   ms->o.buf = NULL;",
          "1704:   ms->offset = 0;",
          "1705:   rv = file_softmagic(ms, s + offset, nbytes - offset,",
          "1706:       BINTEST, text);",
          "1707:   if ((ms->flags & MAGIC_DEBUG) != 0)",
          "1708:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
          "1709:   if (rv == 1) {",
          "1712:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
          "1713:        file_printf(ms, m->desc, offset) == -1)",
          "1714:     return -1;",
          "1715:    if (file_printf(ms, \"%s\", rbuf) == -1)",
          "1716:     return -1;",
          "1717:    free(rbuf);",
          "1720:   return rv;",
          "1722:  case FILE_USE:",
          "",
          "[Removed Lines]",
          "1710:    rbuf = ms->o.buf;",
          "1711:    ms->o.buf = sbuf;",
          "1718:   } else",
          "1719:    ms->o.buf = sbuf;",
          "",
          "[Added Lines]",
          "1710:   soffset = ms->offset;",
          "1717:   rbuf = ms->o.buf;",
          "1718:   ms->o.buf = sbuf;",
          "1719:   ms->offset = offset;",
          "1721:    if (m->flag & NOSPACE)",
          "1722:     trim(rbuf);",
          "1729:   }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1732:    file_error(ms, 0, \"cannot find entry `%s'\", sbuf);",
          "1733:    return -1;",
          "1734:   }",
          "1736:       mode, text, flip, recursion_level, returnval);",
          "1738:  case FILE_NAME:",
          "1739:   if (file_printf(ms, \"%s\", m->desc) == -1)",
          "",
          "[Removed Lines]",
          "1735:   return match(ms, ml.magic, ml.nmagic, s, nbytes, offset + o,",
          "",
          "[Added Lines]",
          "1745:   rv = match(ms, ml.magic, ml.nmagic, s, nbytes, offset + o,",
          "1747:   if (m->flag & NOSPACE)",
          "1748:    trim(ms->o.buf);",
          "1749:   if (rv == 1 && (m->flag & NOSPACE) == 0 &&",
          "1750:       file_printf(ms, \" \") == -1)",
          "1751:    return -1;",
          "1752:   return rv;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "78c2b81ccb511a740049ffe8ca5410433aae7d4e",
      "candidate_info": {
        "commit_hash": "78c2b81ccb511a740049ffe8ca5410433aae7d4e",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/78c2b81ccb511a740049ffe8ca5410433aae7d4e",
        "files": [
          "src/apprentice.c",
          "src/cdf.c",
          "src/compress.c",
          "src/file.c",
          "src/file.h",
          "src/funcs.c",
          "src/magic.c",
          "src/print.c",
          "src/readcdf.c",
          "src/readelf.c",
          "src/softmagic.c"
        ],
        "message": "Bug + portability fixes from the NetBSD build.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/cdf.c||src/cdf.c",
          "src/compress.c||src/compress.c",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/magic.c||src/magic.c",
          "src/print.c||src/print.c",
          "src/readcdf.c||src/readcdf.c",
          "src/readelf.c||src/readelf.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.228 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.229 2015/01/01 17:07:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2199:  size_t i;",
          "2200:  const char *l = line;",
          "2201:  struct magic *m = &me->mp[me->cont_count == 0 ? 0 : me->cont_count - 1];",
          "2204:  if (buf[0] != '\\0') {",
          "2205:   len = nt ? strlen(buf) : len;",
          "",
          "[Removed Lines]",
          "2202:  char *buf = (char *)m + off;",
          "",
          "[Added Lines]",
          "2202:  char *buf = CAST(char *, CAST(void *, m)) + off;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2248: {",
          "2249:  struct magic *m = &me->mp[0];",
          "2252:      sizeof(m->apple), \"APPLE\", \"!+-./\", 0);",
          "2253: }",
          "",
          "[Removed Lines]",
          "2251:  return parse_extra(ms, me, line, offsetof(struct magic, apple),",
          "",
          "[Added Lines]",
          "2251:  return parse_extra(ms, me, line,",
          "2252:      CAST(off_t, offsetof(struct magic, apple)),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2261: {",
          "2262:  struct magic *m = &me->mp[0];",
          "2265:      sizeof(m->mimetype), \"MIME\", \"+-/.\", 1);",
          "2266: }",
          "",
          "[Removed Lines]",
          "2264:  return parse_extra(ms, me, line, offsetof(struct magic, mimetype),",
          "",
          "[Added Lines]",
          "2265:  return parse_extra(ms, me, line,",
          "2266:      CAST(off_t, offsetof(struct magic, mimetype)),",
          "",
          "---------------"
        ],
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.68 2014/10/22 19:27:36 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.69 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73: #define CDF_TOLE8(x) ((uint64_t)(NEED_SWAP ? _cdf_tole8(x) : (uint64_t)(x)))",
          "74: #define CDF_TOLE4(x) ((uint32_t)(NEED_SWAP ? _cdf_tole4(x) : (uint32_t)(x)))",
          "75: #define CDF_TOLE2(x) ((uint16_t)(NEED_SWAP ? _cdf_tole2(x) : (uint16_t)(x)))",
          "78: #define CDF_GETUINT32(x, y) cdf_getuint32(x, y)",
          "",
          "[Removed Lines]",
          "76: #define CDF_TOLE(x) (sizeof(x) == 2 ? CDF_TOLE2(x) : (sizeof(x) == 4 ? \\",
          "77:     CDF_TOLE4(x) : CDF_TOLE8(x)))",
          "",
          "[Added Lines]",
          "76: #define CDF_TOLE(x) (/*CONSTCOND*/sizeof(x) == 2 ? \\",
          "77:        CDF_TOLE2(CAST(uint16_t, x)) : \\",
          "78:    (/*CONSTCOND*/sizeof(x) == 4 ? \\",
          "79:        CDF_TOLE4(CAST(uint32_t, x)) : \\",
          "80:        CDF_TOLE8(CAST(uint64_t, x))))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "271:  const char *e = ((const char *)p) + tail;",
          "272:  size_t ss = sst->sst_dirlen < h->h_min_size_standard_stream ?",
          "273:      CDF_SHORT_SEC_SIZE(h) : CDF_SEC_SIZE(h);",
          "275:  if (e >= b && (size_t)(e - b) <= ss * sst->sst_len)",
          "276:   return 0;",
          "277:  DPRINTF((\"%d: offset begin %p < end %p || %\" SIZE_T_FORMAT \"u\"",
          "",
          "[Removed Lines]",
          "274:  (void)&line;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "998: }",
          "1002:     memcpy(&ce[i].f, b + (l), sizeof(ce[i].f)); \\",
          "1005: int",
          "1006: cdf_unpack_catalog(const cdf_header_t *h, const cdf_stream_t *sst,",
          "",
          "[Removed Lines]",
          "1001: #define extract_catalog_field(f, l) \\",
          "1003:     ce[i].f = CDF_TOLE(ce[i].f)",
          "",
          "[Added Lines]",
          "1004: #define extract_catalog_field(t, f, l) \\",
          "1006:     ce[i].f = CAST(t, CDF_TOLE(ce[i].f))",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1028:  ce = (*cat)->cat_e;",
          "1029:  b = CAST(const char *, sst->sst_tab);",
          "1030:  for (i = 0; i < nr; i++) {",
          "1034:   reclen = ce[i].ce_namlen;",
          "1035:   ce[i].ce_namlen =",
          "1036:       sizeof(ce[i].ce_name) / sizeof(ce[i].ce_name[0]) - 1;",
          "1037:   if (ce[i].ce_namlen > reclen - 14)",
          "1038:    ce[i].ce_namlen = reclen - 14;",
          "1040:   for (k = 0; k < ce[i].ce_namlen; k++) {",
          "1043:   }",
          "1044:   ce[i].ce_name[ce[i].ce_namlen] = 0;",
          "1045:   b += reclen;",
          "",
          "[Removed Lines]",
          "1031:   extract_catalog_field(ce_namlen, 0);",
          "1032:   extract_catalog_field(ce_num, 2);",
          "1033:   extract_catalog_field(ce_timestamp, 6);",
          "1039:   np = CAST(const uint16_t *, (b + 16));",
          "1041:    ce[i].ce_name[k] = np[k];",
          "1042:    CDF_TOLE2(ce[i].ce_name[k]);",
          "",
          "[Added Lines]",
          "1034:   extract_catalog_field(uint16_t, ce_namlen, 0);",
          "1035:   extract_catalog_field(uint16_t, ce_num, 2);",
          "1036:   extract_catalog_field(uint64_t, ce_timestamp, 6);",
          "1042:   np = CAST(const uint16_t *, CAST(const void *, (b + 16)));",
          "",
          "---------------"
        ],
        "src/compress.c||src/compress.c": [
          "File: src/compress.c -> src/compress.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: compress.c,v 1.76 2014/12/11 11:47:08 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: compress.c,v 1.77 2014/12/12 16:33:01 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "383:  int fdin[2], fdout[2];",
          "384:  int status;",
          "385:  ssize_t r;",
          "388: #ifdef BUILTIN_DECOMPRESS",
          "",
          "[Removed Lines]",
          "386:  pid_t pid;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "397:   file_error(ms, errno, \"cannot create pipe\");",
          "398:   return NODATA;",
          "399:  }",
          "402:   (void) close(0);",
          "403:   if (fd != -1) {",
          "",
          "[Removed Lines]",
          "400:  switch (pid = fork()) {",
          "",
          "[Added Lines]",
          "399:  switch (fork()) {",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.159 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.160 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "133: private void usage(void);",
          "134: private void docprint(const char *);",
          "135: private void help(void);",
          "137: private int unwrap(struct magic_set *, const char *);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "133: #ifdef __dead",
          "134: __dead",
          "135: #endif",
          "138: #ifdef __dead",
          "139: __dead",
          "140: #endif",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "590: #else",
          "591: #define FILE_RCSID(id)",
          "592: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "593: #ifndef __RCSID",
          "594: #define __RCSID(a)",
          "595: #endif",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.78 2014/12/11 12:34:24 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.79 2014/12/16 20:52:49 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "159: }",
          "161: #ifndef COMPILE_ONLY",
          "162: protected int",
          "164:     const void *buf, size_t nb)",
          "165: {",
          "166:  int m = 0, rv = 0, looks_text = 0;",
          "",
          "[Removed Lines]",
          "163: file_buffer(struct magic_set *ms, int fd, const char *inname __attribute__ ((unused)),",
          "",
          "[Added Lines]",
          "164: file_buffer(struct magic_set *ms, int fd, const char *inname __attribute__ ((__unused__)),",
          "",
          "---------------"
        ],
        "src/magic.c||src/magic.c": [
          "File: src/magic.c -> src/magic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include \"file.h\"",
          "35: #ifndef lint",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.90 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "[Added Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.91 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "543: {",
          "544:  switch (param) {",
          "545:  case MAGIC_PARAM_INDIR_MAX:",
          "547:   return 0;",
          "548:  case MAGIC_PARAM_NAME_MAX:",
          "550:   return 0;",
          "551:  case MAGIC_PARAM_ELF_PHNUM_MAX:",
          "553:   return 0;",
          "554:  case MAGIC_PARAM_ELF_SHNUM_MAX:",
          "556:   return 0;",
          "557:  case MAGIC_PARAM_ELF_NOTES_MAX:",
          "559:   return 0;",
          "560:  default:",
          "561:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "546:   ms->indir_max = *(const size_t *)val;",
          "549:   ms->name_max = *(const size_t *)val;",
          "552:   ms->elf_phnum_max = *(const size_t *)val;",
          "555:   ms->elf_shnum_max = *(const size_t *)val;",
          "558:   ms->elf_notes_max = *(const size_t *)val;",
          "",
          "[Added Lines]",
          "546:   ms->indir_max = (uint16_t)*(const size_t *)val;",
          "549:   ms->name_max = (uint16_t)*(const size_t *)val;",
          "552:   ms->elf_phnum_max = (uint16_t)*(const size_t *)val;",
          "555:   ms->elf_shnum_max = (uint16_t)*(const size_t *)val;",
          "558:   ms->elf_notes_max = (uint16_t)*(const size_t *)val;",
          "",
          "---------------"
        ],
        "src/print.c||src/print.c": [
          "File: src/print.c -> src/print.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include <string.h>",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: print.c,v 1.75 2012/10/30 23:11:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: print.c,v 1.76 2013/02/26 18:25:00 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "164:   case FILE_MELDATE:",
          "165:    (void)fprintf(stderr, \"%s,\",",
          "166:        file_fmttime(m->value.l, 0, tbuf));",
          "167:   case FILE_QDATE:",
          "168:   case FILE_LEQDATE:",
          "169:   case FILE_BEQDATE:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:    break;",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.48 2014/09/10 18:41:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.49 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39: #include \"cdf.h\"",
          "40: #include \"magic.h\"",
          "42: #define NOTMIME(ms) (((ms)->flags & MAGIC_MIME) == 0)",
          "44: static const struct nv {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: #ifndef __arraycount",
          "43: #define __arraycount(a) (sizeof(a) / sizeof(a[0]))",
          "44: #endif",
          "",
          "---------------"
        ],
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.116 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.117 2014/12/16 23:29:42 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "622:    return 1;",
          "624:   for (i = 0; i < __arraycount(pax); i++) {",
          "626:     continue;",
          "627:    if (file_printf(ms, \"%s%s\", did++ ? \",\" : \"\",",
          "628:        pax[i]) == -1)",
          "",
          "[Removed Lines]",
          "625:    if (((1 << i) & desc) == 0)",
          "",
          "[Added Lines]",
          "626:    if (((1 << (int)i) & desc) == 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1008:  }",
          "1012:   file_badread(ms);",
          "1013:   return -1;",
          "1014:  }",
          "",
          "[Removed Lines]",
          "1011:  if (pread(fd, xsh_addr, xsh_sizeof, off + size * strtab) < (ssize_t)xsh_sizeof) {",
          "",
          "[Added Lines]",
          "1012:  if (pread(fd, xsh_addr, xsh_sizeof, CAST(off_t, (off + size * strtab)))",
          "1013:      < (ssize_t)xsh_sizeof) {",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.205 2015/01/01 04:12:23 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.206 2015/01/01 17:07:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1667:  case FILE_INDIRECT:",
          "1668:   if (m->str_flags & INDIRECT_RELATIVE)",
          "1670:   if (offset == 0)",
          "1671:    return 0;",
          "",
          "[Removed Lines]",
          "1669:    offset += o;",
          "",
          "[Added Lines]",
          "1669:    offset += CAST(uint32_t, o);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "af444af0738468393f40f9d2261b1ea10fc4b2ba",
      "candidate_info": {
        "commit_hash": "af444af0738468393f40f9d2261b1ea10fc4b2ba",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/af444af0738468393f40f9d2261b1ea10fc4b2ba",
        "files": [
          "doc/file.man",
          "doc/libmagic.man",
          "src/apprentice.c",
          "src/ascmagic.c",
          "src/elfclass.h",
          "src/file.c",
          "src/file.h",
          "src/funcs.c",
          "src/magic.c",
          "src/softmagic.c"
        ],
        "message": "Remove name recursion limit, it is always lower than the count... Rename things for consistency.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/ascmagic.c||src/ascmagic.c",
          "src/elfclass.h||src/elfclass.h",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/magic.c||src/magic.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.225 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.226 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "524:   ms->mlist[i] = NULL;",
          "525:  ms->file = \"unknown\";",
          "526:  ms->line = 0;",
          "529:  ms->name_max = FILE_NAME_MAX;",
          "532:  return ms;",
          "533: free:",
          "534:  free(ms);",
          "",
          "[Removed Lines]",
          "527:  ms->indir_recursion = FILE_INDIR_RECURSION;",
          "528:  ms->name_recursion = FILE_NAME_RECURSION;",
          "530:  ms->shnum_max = FILE_ELF_SHNUM;",
          "531:  ms->phnum_max = FILE_ELF_PHNUM;",
          "",
          "[Added Lines]",
          "527:  ms->indir_max = FILE_INDIR_MAX;",
          "529:  ms->elf_shnum_max = FILE_ELF_SHNUM_MAX;",
          "530:  ms->elf_phnum_max = FILE_ELF_PHNUM_MAX;",
          "",
          "---------------"
        ],
        "src/ascmagic.c||src/ascmagic.c": [
          "File: src/ascmagic.c -> src/ascmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.89 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.90 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:       == NULL)",
          "148:    goto done;",
          "149:   if ((rv = file_softmagic(ms, utf8_buf,",
          "151:       TEXTTEST, text)) == 0)",
          "152:    rv = -1;",
          "153:  }",
          "",
          "[Removed Lines]",
          "150:       (size_t)(utf8_end - utf8_buf), 0, 0, NULL,",
          "",
          "[Added Lines]",
          "150:       (size_t)(utf8_end - utf8_buf), 0, NULL,",
          "",
          "---------------"
        ],
        "src/elfclass.h||src/elfclass.h": [
          "File: src/elfclass.h -> src/elfclass.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: #ifdef ELFCORE",
          "37:  case ET_CORE:",
          "38:   phnum = elf_getu16(swap, elfhdr.e_phnum);",
          "40:    return toomany(ms, \"program\", phnum);",
          "41:   flags |= FLAGS_IS_CORE;",
          "42:   if (dophn_core(ms, clazz, swap, fd,",
          "",
          "[Removed Lines]",
          "39:   if (phnum > ms->phnum_max)",
          "",
          "[Added Lines]",
          "39:   if (phnum > ms->elf_phnum_max)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49:  case ET_EXEC:",
          "50:  case ET_DYN:",
          "51:   phnum = elf_getu16(swap, elfhdr.e_phnum);",
          "53:    return toomany(ms, \"program\", phnum);",
          "54:   shnum = elf_getu16(swap, elfhdr.e_shnum);",
          "56:    return toomany(ms, \"section\", shnum);",
          "57:   if (dophn_exec(ms, clazz, swap, fd,",
          "58:       (off_t)elf_getu(swap, elfhdr.e_phoff), phnum,",
          "",
          "[Removed Lines]",
          "52:   if (phnum > ms->phnum_max)",
          "55:   if (shnum > ms->shnum_max)",
          "",
          "[Added Lines]",
          "52:   if (phnum > ms->elf_phnum_max)",
          "55:   if (shnum > ms->elf_shnum_max)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "63:  case ET_REL:",
          "64:   shnum = elf_getu16(swap, elfhdr.e_shnum);",
          "66:    return toomany(ms, \"section\", shnum);",
          "67:   if (doshn(ms, clazz, swap, fd,",
          "68:       (off_t)elf_getu(swap, elfhdr.e_shoff), shnum,",
          "",
          "[Removed Lines]",
          "65:   if (shnum > ms->shnum_max)",
          "",
          "[Added Lines]",
          "65:   if (shnum > ms->elf_shnum_max)",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.157 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.158 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "121:  int tag;",
          "122:  size_t value;",
          "123: } pm[] = {",
          "129: };",
          "",
          "[Removed Lines]",
          "124:  { \"indir\", MAGIC_PARAM_INDIR_RECURSION, 0 },",
          "125:  { \"name\", MAGIC_PARAM_NAME_RECURSION, 0 },",
          "126:  { \"namenum\", MAGIC_PARAM_NAME_MAX, 0 },",
          "127:  { \"phnum\", MAGIC_PARAM_PHNUM_MAX, 0 },",
          "128:  { \"shnum\", MAGIC_PARAM_SHNUM_MAX, 0 },",
          "",
          "[Added Lines]",
          "124:  { \"indir\", MAGIC_PARAM_INDIR_MAX, 0 },",
          "125:  { \"name\", MAGIC_PARAM_NAME_MAX, 0 },",
          "126:  { \"elf_phnum\", MAGIC_PARAM_ELF_PHNUM_MAX, 0 },",
          "127:  { \"elf_shnum\", MAGIC_PARAM_ELF_SHNUM_MAX, 0 },",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "406:  uint16_t name_max;",
          "414: };",
          "",
          "[Removed Lines]",
          "404:  uint16_t indir_recursion;",
          "405:  uint16_t name_recursion;",
          "407:  uint16_t shnum_max;",
          "408:  uint16_t phnum_max;",
          "409: #define FILE_INDIR_RECURSION 15",
          "410: #define FILE_NAME_RECURSION 40",
          "411: #define FILE_NAME_MAX  30",
          "412: #define FILE_ELF_SHNUM  32768",
          "413: #define FILE_ELF_PHNUM  128",
          "",
          "[Added Lines]",
          "404:  uint16_t indir_max;",
          "406:  uint16_t elf_shnum_max;",
          "407:  uint16_t elf_phnum_max;",
          "408: #define FILE_INDIR_MAX   15",
          "409: #define FILE_NAME_MAX   30",
          "410: #define FILE_ELF_SHNUM_MAX  32768",
          "411: #define FILE_ELF_PHNUM_MAX  128",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "450:     unichar **, size_t *, const char **, const char **, const char **);",
          "451: protected int file_is_tar(struct magic_set *, const unsigned char *, size_t);",
          "452: protected int file_softmagic(struct magic_set *, const unsigned char *, size_t,",
          "454: protected int file_apprentice(struct magic_set *, const char *, int);",
          "455: protected int buffer_apprentice(struct magic_set *, struct magic **,",
          "456:     size_t *, size_t);",
          "",
          "[Removed Lines]",
          "453:     uint16_t, uint16_t, uint16_t *, int, int);",
          "",
          "[Added Lines]",
          "451:     uint16_t, uint16_t *, int, int);",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.75 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.76 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "229:  if ((ms->flags & MAGIC_NO_CHECK_SOFT) == 0)",
          "231:       looks_text)) != 0) {",
          "232:    if ((ms->flags & MAGIC_DEBUG) != 0)",
          "233:     (void)fprintf(stderr, \"softmagic %d\\n\", m);",
          "",
          "[Removed Lines]",
          "230:   if ((m = file_softmagic(ms, ubuf, nb, 0, 0, NULL, BINTEST,",
          "",
          "[Added Lines]",
          "230:   if ((m = file_softmagic(ms, ubuf, nb, 0, NULL, BINTEST,",
          "",
          "---------------"
        ],
        "src/magic.c||src/magic.c": [
          "File: src/magic.c -> src/magic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include \"file.h\"",
          "35: #ifndef lint",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.87 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.88 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "541: magic_setparam(struct magic_set *ms, int param, const void *val)",
          "542: {",
          "543:  switch (param) {",
          "549:   return 0;",
          "550:  case MAGIC_PARAM_NAME_MAX:",
          "551:   ms->name_max = *(const size_t *)val;",
          "552:   return 0;",
          "555:   return 0;",
          "558:   return 0;",
          "559:  default:",
          "560:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "544:  case MAGIC_PARAM_INDIR_RECURSION:",
          "545:   ms->indir_recursion = *(const size_t *)val;",
          "546:   return 0;",
          "547:  case MAGIC_PARAM_NAME_RECURSION:",
          "548:   ms->name_recursion = *(const size_t *)val;",
          "553:  case MAGIC_PARAM_PHNUM_MAX:",
          "554:   ms->phnum_max = *(const size_t *)val;",
          "556:  case MAGIC_PARAM_SHNUM_MAX:",
          "557:   ms->shnum_max = *(const size_t *)val;",
          "",
          "[Added Lines]",
          "544:  case MAGIC_PARAM_INDIR_MAX:",
          "545:   ms->indir_max = *(const size_t *)val;",
          "550:  case MAGIC_PARAM_ELF_PHNUM_MAX:",
          "551:   ms->elf_phnum_max = *(const size_t *)val;",
          "553:  case MAGIC_PARAM_ELF_SHNUM_MAX:",
          "554:   ms->elf_shnum_max = *(const size_t *)val;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "566: magic_getparam(struct magic_set *ms, int param, void *val)",
          "567: {",
          "568:  switch (param) {",
          "574:   return 0;",
          "575:  case MAGIC_PARAM_NAME_MAX:",
          "577:   return 0;",
          "580:   return 0;",
          "583:   return 0;",
          "584:  default:",
          "585:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "569:  case MAGIC_PARAM_INDIR_RECURSION:",
          "571:   return 0;",
          "572:  case MAGIC_PARAM_NAME_RECURSION:",
          "578:  case MAGIC_PARAM_PHNUM_MAX:",
          "581:  case MAGIC_PARAM_SHNUM_MAX:",
          "",
          "[Added Lines]",
          "566:  case MAGIC_PARAM_INDIR_MAX:",
          "572:  case MAGIC_PARAM_ELF_PHNUM_MAX:",
          "575:  case MAGIC_PARAM_ELF_SHNUM_MAX:",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.200 2014/11/27 23:42:58 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.201 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: #include <time.h>",
          "45: private int match(struct magic_set *, struct magic *, uint32_t,",
          "47:     uint16_t *, int *, int *, int *);",
          "48: private int mget(struct magic_set *, const unsigned char *,",
          "49:     struct magic *, size_t, size_t, unsigned int, int, int, int, uint16_t,",
          "51: private int magiccheck(struct magic_set *, struct magic *);",
          "52: private int32_t mprint(struct magic_set *, struct magic *);",
          "53: private int32_t moffset(struct magic_set *, struct magic *);",
          "",
          "[Removed Lines]",
          "46:     const unsigned char *, size_t, size_t, int, int, int, uint16_t, uint16_t,",
          "50:     uint16_t, uint16_t *, int *, int *, int *);",
          "",
          "[Added Lines]",
          "46:     const unsigned char *, size_t, size_t, int, int, int, uint16_t,",
          "50:     uint16_t *, int *, int *, int *);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "72: protected int",
          "73: file_softmagic(struct magic_set *ms, const unsigned char *buf, size_t nbytes,",
          "76: {",
          "77:  struct mlist *ml;",
          "78:  int rv, printed_something = 0, need_separator = 0;",
          "",
          "[Removed Lines]",
          "74:     uint16_t indir_level, uint16_t name_level, uint16_t *name_count,",
          "75:  int mode, int text)",
          "",
          "[Added Lines]",
          "74:     uint16_t indir_level, uint16_t *name_count, int mode, int text)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "86:  for (ml = ms->mlist[0]->next; ml != ms->mlist[0]; ml = ml->next)",
          "87:   if ((rv = match(ms, ml->magic, ml->nmagic, buf, nbytes, 0, mode,",
          "89:       &printed_something, &need_separator, NULL)) != 0)",
          "90:    return rv;",
          "",
          "[Removed Lines]",
          "88:       text, 0, indir_level, name_level, name_count,",
          "",
          "[Added Lines]",
          "87:       text, 0, indir_level, name_count,",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "141: private int",
          "142: match(struct magic_set *ms, struct magic *magic, uint32_t nmagic,",
          "143:     const unsigned char *s, size_t nbytes, size_t offset, int mode, int text,",
          "145:     int *printed_something, int *need_separator, int *returnval)",
          "146: {",
          "147:  uint32_t magindex = 0;",
          "",
          "[Removed Lines]",
          "144:     int flip, uint16_t indir_level, uint16_t name_level, uint16_t *name_count,",
          "",
          "[Added Lines]",
          "143:     int flip, uint16_t indir_level, uint16_t *name_count,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "181:   switch (mget(ms, s, m, nbytes, offset, cont_level, mode, text,",
          "183:       printed_something, need_separator, returnval)) {",
          "184:   case -1:",
          "185:    return -1;",
          "",
          "[Removed Lines]",
          "182:       flip, indir_level, name_level, name_count,",
          "",
          "[Added Lines]",
          "181:       flip, indir_level, name_count,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "268:    }",
          "269: #endif",
          "270:    switch (mget(ms, s, m, nbytes, offset, cont_level, mode,",
          "272:        printed_something, need_separator, returnval)) {",
          "273:    case -1:",
          "274:     return -1;",
          "",
          "[Removed Lines]",
          "271:        text, flip, indir_level, name_level, name_count,",
          "",
          "[Added Lines]",
          "270:        text, flip, indir_level, name_count,",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1222: private int",
          "1223: mget(struct magic_set *ms, const unsigned char *s, struct magic *m,",
          "1224:     size_t nbytes, size_t o, unsigned int cont_level, int mode, int text,",
          "1226:     int *printed_something, int *need_separator, int *returnval)",
          "1227: {",
          "1228:  uint32_t offset = ms->offset;",
          "",
          "[Removed Lines]",
          "1225:     int flip, uint16_t indir_level, uint16_t name_level, uint16_t *name_count,",
          "",
          "[Added Lines]",
          "1224:     int flip, uint16_t indir_level, uint16_t *name_count,",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1233:  union VALUETYPE *p = &ms->ms_value;",
          "1234:  struct mlist ml;",
          "1237:   file_error(ms, 0, \"indirect recursion nesting (%hu) exceeded\",",
          "1238:       indir_level);",
          "1239:   return -1;",
          "1240:  }",
          "1248:  if (*name_count >= ms->name_max) {",
          "1249:   file_error(ms, 0, \"name use count (%hu) exceeded\",",
          "",
          "[Removed Lines]",
          "1236:  if (indir_level >= ms->indir_recursion) {",
          "1242:  if (name_level >= ms->name_recursion) {",
          "1243:   file_error(ms, 0, \"name recursion nesting (%hu) exceeded\",",
          "1244:       name_level);",
          "1245:   return -1;",
          "1246:  }",
          "",
          "[Added Lines]",
          "1235:  if (indir_level >= ms->indir_max) {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1258:  if ((ms->flags & MAGIC_DEBUG) != 0) {",
          "1259:   fprintf(stderr, \"mget(type=%d, flag=%x, offset=%u, o=%\"",
          "1260:       SIZE_T_FORMAT \"u, \" \"nbytes=%\" SIZE_T_FORMAT",
          "1262:       m->type, m->flag, offset, o, nbytes,",
          "1264:   mdebug(offset, (char *)(void *)p, sizeof(union VALUETYPE));",
          "1265: #ifndef COMPILE_ONLY",
          "1266:   file_mdump(m);",
          "",
          "[Removed Lines]",
          "1261:       \"u, il=%hu, nl=%hu nc=%hu)\\n\",",
          "1263:       indir_level, name_level, *name_count);",
          "",
          "[Added Lines]",
          "1254:       \"u, il=%hu, nc=%hu)\\n\",",
          "1256:       indir_level, *name_count);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1701:    return -1;",
          "1703:   rv = file_softmagic(ms, s + offset, nbytes - offset,",
          "1706:   if ((ms->flags & MAGIC_DEBUG) != 0)",
          "1707:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
          "",
          "[Removed Lines]",
          "1704:       indir_level + 1, name_level, name_count, BINTEST, text);",
          "",
          "[Added Lines]",
          "1697:       indir_level + 1, name_count, BINTEST, text);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1741:   if (m->flag & NOSPACE)",
          "1743:   rv = match(ms, ml.magic, ml.nmagic, s, nbytes, offset + o,",
          "1745:       printed_something, need_separator, returnval);",
          "1746:   if (rv != 1)",
          "",
          "[Removed Lines]",
          "1744:       mode, text, flip, indir_level, name_level + 1, name_count,",
          "",
          "[Added Lines]",
          "1737:       mode, text, flip, indir_level, name_count,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0941a20217baa3e48a27c8cc6a9e1863b19e87e0",
      "candidate_info": {
        "commit_hash": "0941a20217baa3e48a27c8cc6a9e1863b19e87e0",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/0941a20217baa3e48a27c8cc6a9e1863b19e87e0",
        "files": [
          "src/softmagic.c"
        ],
        "message": "PR/372: Fix incorrect change made for PR/342: We should not increment magindex, if it is not a continuation.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.190 2014/06/03 19:01:34 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.191 2014/06/04 17:36:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "235:   if (file_check_mem(ms, ++cont_level) == -1)",
          "236:    return -1;",
          "243:    if (cont_level < m->cont_level)",
          "",
          "[Removed Lines]",
          "238:   while (++magindex < nmagic &&",
          "239:       magic[magindex].cont_level != 0) {",
          "240:    m = &magic[magindex];",
          "",
          "[Added Lines]",
          "238:   while (magindex + 1 < nmagic &&",
          "239:       magic[magindex + 1].cont_level != 0) {",
          "240:    m = &magic[++magindex];",
          "",
          "---------------"
        ]
      }
    }
  ]
}