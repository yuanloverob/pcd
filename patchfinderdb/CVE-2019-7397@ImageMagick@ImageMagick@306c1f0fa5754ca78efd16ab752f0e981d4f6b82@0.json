{
  "cve_id": "CVE-2019-7397",
  "cve_desc": "In ImageMagick before 7.0.8-25 and GraphicsMagick through 1.3.31, several memory leaks exist in WritePDFImage in coders/pdf.c.",
  "repo": "ImageMagick/ImageMagick",
  "patch_hash": "306c1f0fa5754ca78efd16ab752f0e981d4f6b82",
  "patch_info": {
    "commit_hash": "306c1f0fa5754ca78efd16ab752f0e981d4f6b82",
    "repo": "ImageMagick/ImageMagick",
    "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/306c1f0fa5754ca78efd16ab752f0e981d4f6b82",
    "files": [
      "coders/pdf.c"
    ],
    "message": "https://github.com/ImageMagick/ImageMagick/issues/1454",
    "before_after_code_files": [
      "coders/pdf.c||coders/pdf.c"
    ]
  },
  "patch_diff": {
    "coders/pdf.c||coders/pdf.c": [
      "File: coders/pdf.c -> coders/pdf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1901:               {",
      "1902:                 (void) HuffmanEncodeImage(image_info,image,image,exception);",
      "1903:                 break;",
      "1904:               }",
      "1905:             (void) Huffman2DEncodeImage(image_info,image,image,exception);",
      "1906:             break;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1904:               }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1911:             if (status == MagickFalse)",
      "1912:               {",
      "1913:                 (void) CloseBlob(image);",
      "1914:                 return(MagickFalse);",
      "1915:               }",
      "1916:             break;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1915:                 return(MagickFalse);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1964: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "1965:             if (compression == ZipCompression)",
      "1966:               status=ZLIBEncodeImage(image,length,pixels,exception);",
      "1967:             else",
      "1968: #endif",
      "1969:               if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1969:             else",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2010:       }",
      "2011:     else",
      "2012:       if ((image->storage_class == DirectClass) || (image->colors > 256) ||",
      "2013:           (compression == JPEGCompression) ||",
      "2014:           (compression == JPEG2000Compression))",
      "2015:         switch (compression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2016:           (compression == JPEGCompression) ||",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2020:             if (status == MagickFalse)",
      "2021:               {",
      "2022:                 (void) CloseBlob(image);",
      "2023:                 return(MagickFalse);",
      "2024:               }",
      "2025:             break;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2027:                 return(MagickFalse);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "2038:           default:",
      "2039:           {",
      "2040:             MemoryInfo",
      "2046:             length=(size_t) number_pixels;",
      "2047:             length*=image->colorspace == CMYKColorspace ? 4UL : 3UL;",
      "",
      "[Removed Lines]",
      "2044:               Allocate pixel array.",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "2081: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2082:             if (compression == ZipCompression)",
      "2083:               status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2084:             else",
      "2085: #endif",
      "2086:               if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2086:             else",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "2138:             case RLECompression:",
      "2139:             default:",
      "2140:             {",
      "2147:               length=(size_t) number_pixels;",
      "2148:               pixel_info=AcquireVirtualMemory(length,sizeof(*pixels));",
      "",
      "[Removed Lines]",
      "2141:               MemoryInfo",
      "2145:                 Allocate pixel array.",
      "",
      "[Added Lines]",
      "2144:               MemoryInfo",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "2178: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2179:               if (compression == ZipCompression)",
      "2180:                 status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2181:               else",
      "2182: #endif",
      "2183:                 if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2180:               else",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "2426:                   exception);",
      "2427:                 break;",
      "2428:               }",
      "2429:             (void) Huffman2DEncodeImage(image_info,image,tile_image,exception);",
      "2430:             break;",
      "2431:           }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2429:             (void) Huffman2DEncodeImage(image_info,image,tile_image,exception);",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "2436:             if (status == MagickFalse)",
      "2437:               {",
      "2438:                 (void) CloseBlob(image);",
      "2439:                 return(MagickFalse);",
      "2440:               }",
      "2441:             break;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2440:                 return(MagickFalse);",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "2487: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2488:             if (compression == ZipCompression)",
      "2489:               status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2490:             else",
      "2491: #endif",
      "2492:               if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2492:             else",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "2528:     else",
      "2529:       if ((tile_image->storage_class == DirectClass) ||",
      "2530:           (tile_image->colors > 256) || (compression == JPEGCompression) ||",
      "2531:           (compression == JPEG2000Compression))",
      "2532:         switch (compression)",
      "2533:         {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2534:           (compression == JPEG2000Compression))",
      "",
      "---------------",
      "--- Hunk 14 ---",
      "[Context before]",
      "2538:             if (status == MagickFalse)",
      "2539:               {",
      "2540:                 (void) CloseBlob(image);",
      "2541:                 return(MagickFalse);",
      "2542:               }",
      "2543:             break;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2545:                 return(MagickFalse);",
      "",
      "---------------",
      "--- Hunk 15 ---",
      "[Context before]",
      "2593: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2594:             if (compression == ZipCompression)",
      "2595:               status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2596:             else",
      "2597: #endif",
      "2598:               if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2601:             else",
      "",
      "---------------",
      "--- Hunk 16 ---",
      "[Context before]",
      "2681: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2682:               if (compression == ZipCompression)",
      "2683:                 status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2684:               else",
      "2685: #endif",
      "2686:                 if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2690:               else",
      "",
      "---------------",
      "--- Hunk 17 ---",
      "[Context before]",
      "2893: #if defined(MAGICKCORE_ZLIB_DELEGATE)",
      "2894:             if (compression == ZipCompression)",
      "2895:               status=ZLIBEncodeImage(image,length,pixels,exception);",
      "2896:             else",
      "2897: #endif",
      "2898:               if (compression == LZWCompression)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2903:             else",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2ad9ed3b3247fc96a47d488cd40db2f63f08d4e3",
      "candidate_info": {
        "commit_hash": "2ad9ed3b3247fc96a47d488cd40db2f63f08d4e3",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/2ad9ed3b3247fc96a47d488cd40db2f63f08d4e3",
        "files": [
          "coders/pdf.c"
        ],
        "message": "...",
        "before_after_code_files": [
          "coders/pdf.c||coders/pdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/pdf.c||coders/pdf.c"
          ],
          "candidate": [
            "coders/pdf.c||coders/pdf.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/pdf.c||coders/pdf.c": [
          "File: coders/pdf.c -> coders/pdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1158:   write_info=DestroyImageInfo(write_info);",
          "1159:   if (WriteBlob(image,length,group4) != (ssize_t) length)",
          "1160:     status=MagickFalse;",
          "1161:   group4=(unsigned char *) RelinquishMagickMemory(group4);",
          "1162:   return(status);",
          "1163: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1161:   group4=(unsigned char *) RelinquishMagickMemory(group4);",
          "1162:   return(status);",
          "1163: }",
          "1165: static MagickBooleanType WritePDFImage(const ImageInfo *image_info,Image *image,",
          "1166:   ExceptionInfo *exception)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1830:         (void) FormatLocaleString(buffer,MagickPathExtent,\"/SMask %.20g 0 R\\n\",",
          "1831:           (double) object+(has_icc_profile != MagickFalse ? 9 : 7));",
          "1832:         (void) WriteBlobString(image,buffer);",
          "1834:     (void) FormatLocaleString(buffer,MagickPathExtent,\"/Length %.20g 0 R\\n\",",
          "1835:       (double) object+1);",
          "1836:     (void) WriteBlobString(image,buffer);",
          "",
          "[Removed Lines]",
          "1833:       }",
          "",
          "[Added Lines]",
          "1839:       }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1880:           case RLECompression:",
          "1881:           default:",
          "1882:           {",
          "",
          "[Removed Lines]",
          "1883:             MemoryInfo",
          "",
          "[Added Lines]",
          "1889:             MemoryInfo",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1992:             MemoryInfo",
          "1998:             length=(size_t) number_pixels;",
          "1999:             length*=image->colorspace == CMYKColorspace ? 4UL : 3UL;",
          "",
          "[Removed Lines]",
          "1996:               Allocate pixel array.",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2093:             {",
          "2094:               MemoryInfo",
          "2098:                 Allocate pixel array.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2408:           {",
          "2409:             MemoryInfo",
          "2413:               Allocate pixel array.",
          "2415:             length=(size_t) number_pixels;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2512:             MemoryInfo",
          "2518:             length=(size_t) number_pixels;",
          "2519:             length*=tile_image->colorspace == CMYKColorspace ? 4UL : 3UL;",
          "",
          "[Removed Lines]",
          "2516:               Allocate pixel array.",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2604:             {",
          "2605:               MemoryInfo",
          "2609:                 Allocate pixel array.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2818:           {",
          "2819:             MemoryInfo",
          "2823:               Allocate pixel array.",
          "2825:             length=(size_t) number_pixels;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}