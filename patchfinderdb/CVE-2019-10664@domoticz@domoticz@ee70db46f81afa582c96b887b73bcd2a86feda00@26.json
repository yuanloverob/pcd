{
  "cve_id": "CVE-2019-10664",
  "cve_desc": "Domoticz before 4.10578 allows SQL Injection via the idx parameter in CWebServer::GetFloorplanImage in WebServer.cpp.",
  "repo": "domoticz/domoticz",
  "patch_hash": "ee70db46f81afa582c96b887b73bcd2a86feda00",
  "patch_info": {
    "commit_hash": "ee70db46f81afa582c96b887b73bcd2a86feda00",
    "repo": "domoticz/domoticz",
    "commit_url": "https://github.com/domoticz/domoticz/commit/ee70db46f81afa582c96b887b73bcd2a86feda00",
    "files": [
      "main/WebServer.cpp"
    ],
    "message": "Fixed possible SQL Injection Vulnerability (Thanks to Fabio Carretto!)",
    "before_after_code_files": [
      "main/WebServer.cpp||main/WebServer.cpp"
    ]
  },
  "patch_diff": {
    "main/WebServer.cpp||main/WebServer.cpp": [
      "File: main/WebServer.cpp -> main/WebServer.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "10772:     return;",
      "10773:    }",
      "10774:    std::vector<std::vector<std::string> > result;",
      "10776:    if (result.empty())",
      "10777:     return;",
      "10778:    reply::set_content(&rep, result[0][0].begin(), result[0][0].end());",
      "",
      "[Removed Lines]",
      "10775:    result = m_sql.safe_queryBlob(\"SELECT Image FROM Floorplans WHERE ID=%s\", idx.c_str());",
      "",
      "[Added Lines]",
      "10775:    result = m_sql.safe_queryBlob(\"SELECT Image FROM Floorplans WHERE ID=%d\", atol(idx.c_str()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2c65161ec2b322aeba255ac41c31756962f50977",
      "candidate_info": {
        "commit_hash": "2c65161ec2b322aeba255ac41c31756962f50977",
        "repo": "domoticz/domoticz",
        "commit_url": "https://github.com/domoticz/domoticz/commit/2c65161ec2b322aeba255ac41c31756962f50977",
        "files": [
          "main/mainworker.cpp"
        ],
        "message": "Fixed Typo",
        "before_after_code_files": [
          "main/mainworker.cpp||main/mainworker.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/domoticz/domoticz/pull/3180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/mainworker.cpp||main/mainworker.cpp": [
          "File: main/mainworker.cpp -> main/mainworker.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10902:   }",
          "10904:   bool bHaveChill = false;",
          "10906:   {",
          "10907:    if (!pResponse->WEATHER.chillsign)",
          "10908:    {",
          "",
          "[Removed Lines]",
          "10905:   if (1 == 0);// subType == sTypeWEATHERx)",
          "",
          "[Added Lines]",
          "10905:   if (1 == 0)// subType == sTypeWEATHERx)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a158d870957368a298ec04d61485d17b12de0b52",
      "candidate_info": {
        "commit_hash": "a158d870957368a298ec04d61485d17b12de0b52",
        "repo": "domoticz/domoticz",
        "commit_url": "https://github.com/domoticz/domoticz/commit/a158d870957368a298ec04d61485d17b12de0b52",
        "files": [
          "hardware/plugins/DelayedLink.h"
        ],
        "message": "Add PyObject_IsTrue",
        "before_after_code_files": [
          "hardware/plugins/DelayedLink.h||hardware/plugins/DelayedLink.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/domoticz/domoticz/pull/3180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hardware/plugins/DelayedLink.h||hardware/plugins/DelayedLink.h": [
          "File: hardware/plugins/DelayedLink.h -> hardware/plugins/DelayedLink.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:   DECLARE_PYTHON_SYMBOL(void, PyEval_SetProfile, Py_tracefunc COMMA PyObject*);",
          "125:   DECLARE_PYTHON_SYMBOL(void, PyEval_SetTrace, Py_tracefunc COMMA PyObject*);",
          "126:   DECLARE_PYTHON_SYMBOL(PyObject*, PyObject_Str, PyObject*);",
          "128: #ifdef _DEBUG",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "127:   DECLARE_PYTHON_SYMBOL(int, PyObject_IsTrue, PyObject*);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "248:      RESOLVE_PYTHON_SYMBOL(PyEval_SetProfile);",
          "249:      RESOLVE_PYTHON_SYMBOL(PyEval_SetTrace);",
          "250:      RESOLVE_PYTHON_SYMBOL(PyObject_Str);",
          "251:     }",
          "252:    }",
          "253:    _Py_NoneStruct.ob_refcnt = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "252:      RESOLVE_PYTHON_SYMBOL(PyObject_IsTrue);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "448: #define PyEval_SetProfile  pythonLib->PyEval_SetProfile",
          "449: #define PyEval_SetTrace   pythonLib->PyEval_SetTrace",
          "450: #define PyObject_Str   pythonLib->PyObject_Str",
          "451: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "453: #define PyObject_IsTrue   pythonLib->PyObject_IsTrue",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e08c9e15c1be6bc0c87c0aa58dfc6dbbd9ecb709",
      "candidate_info": {
        "commit_hash": "e08c9e15c1be6bc0c87c0aa58dfc6dbbd9ecb709",
        "repo": "domoticz/domoticz",
        "commit_url": "https://github.com/domoticz/domoticz/commit/e08c9e15c1be6bc0c87c0aa58dfc6dbbd9ecb709",
        "files": [
          "main/WebServer.cpp",
          "www/app/DashboardController.js",
          "www/app/LightsController.js",
          "www/views/lights.html"
        ],
        "message": "Added support for Westinghouse Fan",
        "before_after_code_files": [
          "main/WebServer.cpp||main/WebServer.cpp",
          "www/app/DashboardController.js||www/app/DashboardController.js",
          "www/app/LightsController.js||www/app/LightsController.js",
          "www/views/lights.html||www/views/lights.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/domoticz/domoticz/pull/3180"
        ],
        "olp_code_files": {
          "patch": [
            "main/WebServer.cpp||main/WebServer.cpp"
          ],
          "candidate": [
            "main/WebServer.cpp||main/WebServer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "main/WebServer.cpp||main/WebServer.cpp": [
          "File: main/WebServer.cpp -> main/WebServer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "4522:       devid = id;",
          "4523:       sunitcode = \"0\";",
          "4524:      }",
          "4525:      else if (lighttype == 400) {",
          "4527:       dtype = pTypeGeneralSwitch;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4525:      else if (lighttype == 307)",
          "4526:      {",
          "4528:       dtype = pTypeFan;",
          "4529:       subtype = sTypeWestinghouse;",
          "4530:       std::string id = request::findValue(&req, \"id\");",
          "4531:       if (id.empty())",
          "4532:        return;",
          "4533:       devid = id;",
          "4534:       sunitcode = \"0\";",
          "4535:      }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5127:       devid = id;",
          "5128:       sunitcode = \"0\";",
          "5129:      }",
          "5130:      else if (lighttype == 400)",
          "5131:      {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5141:      else if (lighttype == 307)",
          "5142:      {",
          "5144:       dtype = pTypeFan;",
          "5145:       subtype = sTypeWestinghouse;",
          "5146:       std::string id = request::findValue(&req, \"id\");",
          "5147:       if (id.empty())",
          "5148:        return;",
          "5149:       devid = id;",
          "5150:       sunitcode = \"0\";",
          "5151:      }",
          "",
          "---------------"
        ],
        "www/app/DashboardController.js||www/app/DashboardController.js": [
          "File: www/app/DashboardController.js -> www/app/DashboardController.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "215:          (item.SubType == \"Smartwares Mode\") ||",
          "216:          (item.SubType == \"Relay\") ||",
          "217:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Itho') == 0)) ||",
          "219:         )",
          "220:         && (item.Favorite != 0)) {",
          "221:         id = \"#dashcontent #light_\" + item.idx;",
          "",
          "[Removed Lines]",
          "218:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Lucci') == 0))",
          "",
          "[Added Lines]",
          "218:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Lucci') == 0)) ||",
          "219:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Westinghouse') == 0))",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "545:             '<button class=\"' + class_3 + '\" type=\"button\" onclick=\"SwitchLight(' + item.idx + ',\\'min\\',RefreshFavorites,' + item.Protected + ');\">' + $.t(\"min\") + '</button> ' +",
          "546:             '<button class=\"' + class_4 + '\" type=\"button\" onclick=\"SwitchLight(' + item.idx + ',\\'light\\',RefreshFavorites,' + item.Protected + ');\">' + $.t(\"light\") + '</button>';",
          "547:           }",
          "549:               var class_1 = \"btn btn-mini\";",
          "550:               var class_2 = \"btn btn-mini\";",
          "551:               var class_3 = \"btn btn-mini\";",
          "",
          "[Removed Lines]",
          "548:           else if (item.SubType.indexOf(\"Lucci Air\") == 0) {",
          "",
          "[Added Lines]",
          "549:           else if (",
          "550:            (item.SubType.indexOf(\"Lucci Air\") == 0) ||",
          "551:            (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "552:           ) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "876:             img += '<img src=\"images/' + item.Image + '48_On.png\" title=\"' + $.t(\"Turn Off\") + '\" onclick=\"SwitchLight(' + item.idx + ',\\'Off\\',RefreshFavorites,' + item.Protected + ');\" class=\"lcursor\" height=\"40\" width=\"40\">';",
          "877:            }",
          "878:           }",
          "880:            img = $(id + \" #img\").html();",
          "881:           }",
          "882:           else {",
          "",
          "[Removed Lines]",
          "879:           else if ((item.SubType.indexOf(\"Itho\") == 0) || (item.SubType.indexOf(\"Lucci\") == 0)) {",
          "",
          "[Added Lines]",
          "883:           else if (",
          "884:            (item.SubType.indexOf(\"Itho\") == 0) ||",
          "885:            (item.SubType.indexOf(\"Lucci\") == 0) ||",
          "886:            (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "887:            ) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1945:          (item.SubType == \"Relay\") ||",
          "1946:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Itho') == 0)) ||",
          "1947:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Lucci') == 0)) ||",
          "1948:          ((item.Type.indexOf('Value') == 0) && (typeof item.SwitchType != 'undefined'))",
          "1949:         )",
          "1950:        ) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1956:          ((typeof item.SubType != 'undefined') && (item.SubType.indexOf('Westinghouse') == 0)) ||",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2247:            '<button class=\"' + class_3 + '\" type=\"button\" onclick=\"SwitchLight(' + item.idx + ',\\'3\\',RefreshFavorites,' + item.Protected + ');\">' + $.t(\"3\") + '</button> ' +",
          "2248:            '<button class=\"' + class_timer + '\" type=\"button\" onclick=\"SwitchLight(' + item.idx + ',\\'timer\\',RefreshFavorites,' + item.Protected + ');\">' + $.t(\"Timer\") + '</button>';",
          "2249:          }",
          "2251:           var class_1 = \"btn btn-mini\";",
          "2252:           var class_2 = \"btn btn-mini\";",
          "2253:           var class_3 = \"btn btn-mini\";",
          "",
          "[Removed Lines]",
          "2250:          else if (item.SubType.indexOf(\"Lucci\") == 0) {",
          "",
          "[Added Lines]",
          "2259:          else if (",
          "2260:           (item.SubType.indexOf(\"Lucci\") == 0) ||",
          "2261:           (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "2262:           ) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2689:          else if (item.SubType.indexOf(\"Lucci Air DC\") == 0) {",
          "2690:           xhtm += '\\t      <td id=\"img\" class=\"img img1\"><img src=\"images/Fan48_On.png\" height=\"40\" width=\"40\" class=\"lcursor\" onclick=\"ShowLucciDCPopup(event, ' + item.idx + ', RefreshFavorites, ' + item.Protected + ');\"></td>\\n';",
          "2691:          }",
          "2693:              xhtm += '\\t      <td id=\"img\" class=\"img img1\"><img src=\"images/Fan48_On.png\" height=\"40\" width=\"40\" class=\"lcursor\" onclick=\"ShowLucciPopup(event, ' + item.idx + ', RefreshFavorites, ' + item.Protected + ');\"></td>\\n';",
          "2694:          }",
          "2695:          else {",
          "",
          "[Removed Lines]",
          "2692:          else if (item.SubType.indexOf(\"Lucci\") == 0) {",
          "",
          "[Added Lines]",
          "2704:          else if (",
          "2705:           (item.SubType.indexOf(\"Lucci\") == 0) ||",
          "2706:           (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "2707:           ) {",
          "",
          "---------------"
        ],
        "www/app/LightsController.js||www/app/LightsController.js": [
          "File: www/app/LightsController.js -> www/app/LightsController.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "677:           img += '<img src=\"images/' + item.Image + '48_On.png\" title=\"' + $.t(\"Turn Off\") + '\" onclick=\"SwitchLight(' + item.idx + ',\\'Off\\',RefreshLights,' + item.Protected + ');\" class=\"lcursor\" height=\"48\" width=\"48\">';",
          "678:          }",
          "679:         }",
          "681:          img = $(id + \" #img\").html();",
          "682:         }",
          "683:         else {",
          "",
          "[Removed Lines]",
          "680:         else if ((item.SubType.indexOf(\"Itho\") == 0) || (item.SubType.indexOf(\"Lucci\") == 0)) {",
          "",
          "[Added Lines]",
          "680:         else if (",
          "681:          (item.SubType.indexOf(\"Itho\") == 0) ||",
          "682:          (item.SubType.indexOf(\"Lucci\") == 0) ||",
          "683:          (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "684:          ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1257:         bAddTimer = false;",
          "1258:         xhtm += '\\t      <td id=\"img\"><img src=\"images/Fan48_On.png\" height=\"48\" width=\"48\" class=\"lcursor\" onclick=\"ShowLucciDCPopup(event, ' + item.idx + ', ShowLights, ' + item.Protected + ');\"></td>\\n';",
          "1259:        }",
          "1261:            bAddTimer = false;",
          "1262:            xhtm += '\\t      <td id=\"img\"><img src=\"images/Fan48_On.png\" height=\"48\" width=\"48\" class=\"lcursor\" onclick=\"ShowLucciPopup(event, ' + item.idx + ', ShowLights, ' + item.Protected + ');\"></td>\\n';",
          "1263:        }",
          "",
          "[Removed Lines]",
          "1260:        else if (item.SubType.indexOf(\"Lucci\") == 0) {",
          "",
          "[Added Lines]",
          "1264:        else if (",
          "1265:         (item.SubType.indexOf(\"Lucci\") == 0) ||",
          "1266:         (item.SubType.indexOf(\"Westinghouse\") == 0)",
          "1267:         ) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1827:     $(\"#dialog-addmanuallightdevice #lighting3params\").hide();",
          "1828:     $(\"#dialog-addmanuallightdevice #fanparams\").show();",
          "1829:    }",
          "1832:     $(\"#dialog-addmanuallightdevice #lighting1params\").hide();",
          "1833:     $(\"#dialog-addmanuallightdevice #lighting2params\").hide();",
          "1834:     $(\"#dialog-addmanuallightdevice #lighting3params\").hide();",
          "",
          "[Removed Lines]",
          "1830:    else if ((lighttype == 305)||(lighttype == 306)) {",
          "",
          "[Added Lines]",
          "1837:    else if ((lighttype == 305)||(lighttype == 306)||(lighttype == 307)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2036:      $(\"#dialog-addmanuallightdevice #fanparams #combocmd3 option:selected\").text();",
          "2037:     mParams += \"&id=\" + ID;",
          "2038:    }",
          "2041:     ID =",
          "2042:      $(\"#dialog-addmanuallightdevice #fanparams #combocmd1 option:selected\").text() +",
          "2043:      $(\"#dialog-addmanuallightdevice #fanparams #combocmd2 option:selected\").text() +",
          "",
          "[Removed Lines]",
          "2039:    else if ((lighttype == 305)||(lighttype == 306)) {",
          "",
          "[Added Lines]",
          "2046:    else if ((lighttype == 305)||(lighttype == 306)||(lighttype == 307)) {",
          "",
          "---------------"
        ],
        "www/views/lights.html||www/views/lights.html": [
          "File: www/views/lights.html -> www/views/lights.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:      <option value=\"304\">Itho CVE RFT</option>",
          "105:      <option value=\"305\">Lucci Air</option>",
          "106:      <option value=\"306\">Lucci Air DC</option>",
          "107:      <option value=\"400\">Blinds OpenWebNet Bus</option>",
          "108:      <option value=\"401\">Lights OpenWebNet Bus</option>",
          "109:      <option value=\"402\">Auxiliary OpenWebNet Bus</option>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "107:      <option value=\"307\">Westinghouse</option>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "574d412df936a84b7e7ca9d6b3f4c1cf1ef7446e",
      "candidate_info": {
        "commit_hash": "574d412df936a84b7e7ca9d6b3f4c1cf1ef7446e",
        "repo": "domoticz/domoticz",
        "commit_url": "https://github.com/domoticz/domoticz/commit/574d412df936a84b7e7ca9d6b3f4c1cf1ef7446e",
        "files": [
          "hardware/Gpio.cpp"
        ],
        "message": "Corrected GPIO StopHardware function",
        "before_after_code_files": [
          "hardware/Gpio.cpp||hardware/Gpio.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/domoticz/domoticz/pull/3180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hardware/Gpio.cpp||hardware/Gpio.cpp": [
          "File: hardware/Gpio.cpp -> hardware/Gpio.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "280:  try",
          "281:  {",
          "283:   {",
          "286:   }",
          "287:  catch (...)",
          "288:  {",
          "289:  }",
          "290:  try",
          "291:  {",
          "293:   {",
          "296:   }",
          "297:  }",
          "298:  catch (...)",
          "",
          "[Removed Lines]",
          "282:   if (m_threadSensors)",
          "284:    m_threadSensors->join();",
          "285:    m_threadSensors.reset();",
          "292:   if (m_threadSwitches)",
          "294:    m_threadSwitches->join();",
          "295:    m_threadSwitches.reset();",
          "",
          "[Added Lines]",
          "282:   if (m_thread_updatestartup)",
          "284:    m_thread_updatestartup->join();",
          "285:    m_thread_updatestartup.reset();",
          "287:  }",
          "293:   if (m_thread_poller)",
          "295:    m_thread_poller->join();",
          "296:    m_thread_poller.reset();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b884b50ad3a6b4675375cda75f29a0ce706e8af0",
      "candidate_info": {
        "commit_hash": "b884b50ad3a6b4675375cda75f29a0ce706e8af0",
        "repo": "domoticz/domoticz",
        "commit_url": "https://github.com/domoticz/domoticz/commit/b884b50ad3a6b4675375cda75f29a0ce706e8af0",
        "files": [
          "hardware/MySensorsBase.cpp"
        ],
        "message": "MySensors, ignoring V_IR_SEND subtype",
        "before_after_code_files": [
          "hardware/MySensorsBase.cpp||hardware/MySensorsBase.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/domoticz/domoticz/pull/3180"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hardware/MySensorsBase.cpp||hardware/MySensorsBase.cpp": [
          "File: hardware/MySensorsBase.cpp -> hardware/MySensorsBase.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "2083:    pChild->SetValue(vType, atoi(payload.c_str()));",
          "2084:    bHaveValue = true;",
          "2085:    break;",
          "2086:   case V_CUSTOM:",
          "2088:    if (!payload.empty())",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2086:   case V_IR_SEND:",
          "2088:    break;",
          "",
          "---------------"
        ]
      }
    }
  ]
}