{
  "cve_id": "CVE-2020-11947",
  "cve_desc": "iscsi_aio_ioctl_cb in block/iscsi.c in QEMU 4.1.0 has a heap-based buffer over-read that may disclose unrelated information from process memory to an attacker.",
  "repo": "qemu/qemu",
  "patch_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
  "patch_info": {
    "commit_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "files": [
      "block/iscsi.c"
    ],
    "message": "block/iscsi:fix heap-buffer-overflow in iscsi_aio_ioctl_cb\n\nThere is an overflow, the source 'datain.data[2]' is 100 bytes,\n but the 'ss' is 252 bytes.This may cause a security issue because\n we can access a lot of unrelated memory data.\n\nThe len for sbp copy data should take the minimum of mx_sb_len and\n sb_len_wr, not the maximum.\n\nIf we use iscsi device for VM backend storage, ASAN show stack:\n\nREAD of size 252 at 0xfffd149dcfc4 thread T0\n    #0 0xaaad433d0d34 in __asan_memcpy (aarch64-softmmu/qemu-system-aarch64+0x2cb0d34)\n    #1 0xaaad45f9d6d0 in iscsi_aio_ioctl_cb /qemu/block/iscsi.c:996:9\n    #2 0xfffd1af0e2dc  (/usr/lib64/iscsi/libiscsi.so.8+0xe2dc)\n    #3 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #4 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #5 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #6 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #7 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #8 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #9 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #10 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #11 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #12 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #13 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #14 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #15 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #16 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #17 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\n0xfffd149dcfc4 is located 0 bytes to the right of 100-byte region [0xfffd149dcf60,0xfffd149dcfc4)\nallocated by thread T0 here:\n    #0 0xaaad433d1e70 in __interceptor_malloc (aarch64-softmmu/qemu-system-aarch64+0x2cb1e70)\n    #1 0xfffd1af0e254  (/usr/lib64/iscsi/libiscsi.so.8+0xe254)\n    #2 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #3 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #4 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #5 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #6 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #7 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #8 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #9 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #10 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #11 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #12 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #13 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #14 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #15 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #16 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Chen Qun <kuhn.chenqun@huawei.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nMessage-id: 20200418062602.10776-1-kuhn.chenqun@huawei.com\nReviewed-by: Daniel P. Berrang\u00e9 <berrange@redhat.com>\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
    "before_after_code_files": [
      "block/iscsi.c||block/iscsi.c"
    ]
  },
  "patch_diff": {
    "block/iscsi.c||block/iscsi.c": [
      "File: block/iscsi.c -> block/iscsi.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "991:         acb->ioh->driver_status |= SG_ERR_DRIVER_SENSE;",
      "993:         acb->ioh->sb_len_wr = acb->task->datain.size - 2;",
      "996:         memcpy(acb->ioh->sbp, &acb->task->datain.data[2], ss);",
      "997:     }",
      "",
      "[Removed Lines]",
      "994:         ss = (acb->ioh->mx_sb_len >= acb->ioh->sb_len_wr) ?",
      "995:              acb->ioh->mx_sb_len : acb->ioh->sb_len_wr;",
      "",
      "[Added Lines]",
      "994:         ss = MIN(acb->ioh->mx_sb_len, acb->ioh->sb_len_wr);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6a0e8bb4956c34328f4624e20bd3a6c2b1d90adc",
      "candidate_info": {
        "commit_hash": "6a0e8bb4956c34328f4624e20bd3a6c2b1d90adc",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/6a0e8bb4956c34328f4624e20bd3a6c2b1d90adc",
        "files": [
          "target/m68k/translate.c"
        ],
        "message": "target/m68k: implement fmove.l #<data>,FPCR\n\nThe immediate value mode was ignored and instruction execution\nends to an invalid access mode.\n\nThis was found running 'R' that set FPSR to 0 at startup with\na 'fmove.l #0,FPSR' in qemu-system-m68k emulation and triggers a\nkernel crash:\n\n[   56.640000] *** ADDRESS ERROR ***   FORMAT=2\n[   56.640000] Current process id is 728\n[   56.640000] BAD KERNEL TRAP: 00000000\n[   56.640000] Modules linked in: sg evdev mac_hid ip_tables x_tables sha1_generic hmac ipv6 nf_defrag_ipv6 autofs4 ext4 crc16 mbcache jbd2 crc32c_generic sd_mod t10_pi crc_t10dif crct10dif_generic crct10dif_common sr_mod cdrom mac_esp macsonic esp_scsi\n[   56.640000] PC: [<00016a2c>] X_UNSUPP+0x2c/0x3c\n[   56.640000] SR: 2004  SP: 3eb5e68c  a2: c02e239a\n[   56.640000] d0: 00000040    d1: 00000002    d2: 8002adec    d3: 8002ad50\n[   56.640000] d4: 8002c768    d5: 0000000d    a0: ffffffc2    a1: ffffffc1\n[   56.640000] Process R (pid: 728, task=a3dfda5d)\n[   56.640000] Frame format=2 instr addr=00000000\n[   56.650000] Stack from 3a4d9f30:\n[   56.650000]         41000000 00000002 00000002 ffffffc2 ffffffc1 1fff0000 80000000 00000000\n[   56.650000]         3fbf0000 80000000 00000000 00000000 20000000 00000000 7fff0000 ffffffff\n[   56.650000]         ffffffff 00000000 00050008 00000000 8000067c c02c2000 efffee20 000002d8\n[   56.650000]         00002a28 3a4d9f98 00000002 00000014 fffffffe 8002c768 00000002 00000041\n[   56.650000]         00000002 c041fc58 c0743758 ffffffff 00000000 0008c075 00002b24 00000012\n[   56.650000]         000007d0 00000024 00000002 c05bef04 c05bef04 0000005e 00000077 c28aca70\n[   56.650000] Call Trace: [<00050008>] copy_overflow+0x10/0x28\n[   56.650000]  [<00002a28>] buserr+0x20/0x28\n[   56.650000]  [<0008c075>] bpf_check+0x57f/0x1cfa\n[   56.650000]  [<00002b24>] syscall+0x8/0xc\n[   56.650000]  [<0000c019>] dn_sched_init+0x75/0x88\n[   56.650000] Code: 1017 0200 00f0 0c00 0040 66ff 0000 05ac <f23c> 8800 0000 0000 f23c 9000 0000 0000 222e ff84 082e 0005 ff1c 6600 000a 0281\n[   56.650000] Disabling lock debugging due to kernel taint\n...\n\nReported-by: John Paul Adrian Glaubitz <glaubitz@physik.fu-berlin.de>\nSigned-off-by: Laurent Vivier <laurent@vivier.eu>\nTested-by: John Paul Adrian Glaubitz <glaubitz@physik.fu-berlin.de>\nReviewed-by: Richard Henderson <richard.henderson@linaro.org>\nMessage-Id: <20200531110231.620711-1-laurent@vivier.eu>\nSigned-off-by: Laurent Vivier <laurent@vivier.eu>",
        "before_after_code_files": [
          "target/m68k/translate.c||target/m68k/translate.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "target/m68k/translate.c||target/m68k/translate.c": [
          "File: target/m68k/translate.c -> target/m68k/translate.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4936:             gen_store_fcr(s, AREG(insn, 0), mask);",
          "4937:         }",
          "4938:         return;",
          "4939:     default:",
          "4940:         break;",
          "4941:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4940:         if (REG(insn, 0) == 4) {",
          "4941:             if (is_write ||",
          "4942:                 (mask != M68K_FPIAR && mask != M68K_FPSR &&",
          "4943:                  mask != M68K_FPCR)) {",
          "4944:                 gen_exception(s, s->base.pc_next, EXCP_ILLEGAL);",
          "4945:                 return;",
          "4946:             }",
          "4947:             tmp = tcg_const_i32(read_im32(env, s));",
          "4948:             gen_store_fcr(s, tmp, mask);",
          "4949:             tcg_temp_free(tmp);",
          "4950:             return;",
          "4951:         }",
          "4952:         break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5abe9f0baacbf824ff690f605cb56b66fd02355d",
      "candidate_info": {
        "commit_hash": "5abe9f0baacbf824ff690f605cb56b66fd02355d",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/5abe9f0baacbf824ff690f605cb56b66fd02355d",
        "files": [
          "tests/acceptance/boot_linux_console.py"
        ],
        "message": "tests/boot_linux_console: Add a quick test for the OrangePi PC board\n\nThis test boots a Linux kernel on a OrangePi PC board and verify\nthe serial output is working.\n\nThe kernel image and DeviceTree blob are built by the Armbian\nproject (based on Debian):\nhttps://www.armbian.com/orange-pi-pc/\n\nIf ARM is a target being built, \"make check-acceptance\" will\nautomatically include this test by the use of the \"arch:arm\" tags.\n\nAlternatively, this test can be run using:\n\n  $ make check-venv\n  $ ./tests/venv/bin/avocado --show=console,app run -t machine:orangepi-pc tests/acceptance/boot_linux_console.py\n  JOB ID     : 2e4d15eceb13c33672af406f08171e6e9de1414a\n  JOB LOG    : ~/job-results/job-2019-12-17T05.46-2e4d15e/job.log\n  (1/1) tests/acceptance/boot_linux_console.py:BootLinuxConsole.test_arm_orangepi:\n  console: Uncompressing Linux... done, booting the kernel.\n  console: Booting Linux on physical CPU 0x0\n  console: Linux version 4.20.7-sunxi (root@armbian.com) (gcc version 7.2.1 20171011 (Linaro GCC 7.2-2017.11)) #5.75 SMP Fri Feb 8 09:02:10 CET 2019\n  console: CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=50c5387d\n  console: CPU: div instructions available: patching division code\n  console: CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache\n  console: OF: fdt: Machine model: Xunlong Orange Pi PC\n  console: Memory policy: Data cache writealloc\n  console: OF: reserved mem: failed to allocate memory for node 'cma@4a000000'\n  console: cma: Failed to reserve 128 MiB\n  console: psci: probing for conduit method from DT.\n  console: psci: PSCIv0.2 detected in firmware.\n  console: psci: Using standard PSCI v0.2 function IDs\n  console: psci: Trusted OS migration not required\n  console: random: get_random_bytes called from start_kernel+0x8d/0x3c2 with crng_init=0\n  console: percpu: Embedded 18 pages/cpu @(ptrval) s41228 r8192 d24308 u73728\n  console: Built 1 zonelists, mobility grouping on.  Total pages: 32480\n  console: Kernel command line: printk.time=0 console=ttyS0,115200\n  PASS (8.59 s)\n  JOB TIME   : 8.81 s\n\nSigned-off-by: Philippe Mathieu-Daud\u00e9 <f4bug@amsat.org>\nSigned-off-by: Niek Linnenbank <nieklinnenbank@gmail.com>\nReviewed-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nTested-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nMessage-id: 20200311221854.30370-14-nieklinnenbank@gmail.com\n[NL: rename in commit message Raspbian to Armbian, remove vm.set_machine()]\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
        "before_after_code_files": [
          "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py": [
          "File: tests/acceptance/boot_linux_console.py -> tests/acceptance/boot_linux_console.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "507:         exec_command_and_wait_for_pattern(self, 'reboot',",
          "508:                                                 'reboot: Restarting system')",
          "510:     def test_s390x_s390_ccw_virtio(self):",
          "511:         \"\"\"",
          "512:         :avocado: tags=arch:s390x",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "510:     def test_arm_orangepi(self):",
          "511:         \"\"\"",
          "512:         :avocado: tags=arch:arm",
          "513:         :avocado: tags=machine:orangepi-pc",
          "514:         \"\"\"",
          "515:         deb_url = ('https://apt.armbian.com/pool/main/l/'",
          "516:                    'linux-4.20.7-sunxi/linux-image-dev-sunxi_5.75_armhf.deb')",
          "517:         deb_hash = '1334c29c44d984ffa05ed10de8c3361f33d78315'",
          "518:         deb_path = self.fetch_asset(deb_url, asset_hash=deb_hash)",
          "519:         kernel_path = self.extract_from_deb(deb_path,",
          "520:                                             '/boot/vmlinuz-4.20.7-sunxi')",
          "521:         dtb_path = '/usr/lib/linux-image-dev-sunxi/sun8i-h3-orangepi-pc.dtb'",
          "522:         dtb_path = self.extract_from_deb(deb_path, dtb_path)",
          "524:         self.vm.set_console()",
          "525:         kernel_command_line = (self.KERNEL_COMMON_COMMAND_LINE +",
          "526:                                'console=ttyS0,115200n8 '",
          "527:                                'earlycon=uart,mmio32,0x1c28000')",
          "528:         self.vm.add_args('-kernel', kernel_path,",
          "529:                          '-dtb', dtb_path,",
          "530:                          '-append', kernel_command_line)",
          "531:         self.vm.launch()",
          "532:         console_pattern = 'Kernel command line: %s' % kernel_command_line",
          "533:         self.wait_for_console_pattern(console_pattern)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c40b1ded0af6ee5b26e4b2eb5e0ce68c308e8de3",
      "candidate_info": {
        "commit_hash": "c40b1ded0af6ee5b26e4b2eb5e0ce68c308e8de3",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/c40b1ded0af6ee5b26e4b2eb5e0ce68c308e8de3",
        "files": [
          "tests/acceptance/boot_linux_console.py"
        ],
        "message": "tests/boot_linux_console: Add initrd test for the Orange Pi PC board\n\nThis test boots a Linux kernel on a OrangePi PC board and verify\nthe serial output is working.\n\nThe kernel image and DeviceTree blob are built by the Armbian\nproject (based on Debian):\nhttps://www.armbian.com/orange-pi-pc/\n\nThe cpio image used comes from the linux-build-test project:\nhttps://github.com/groeck/linux-build-test\n\nIf ARM is a target being built, \"make check-acceptance\" will\nautomatically include this test by the use of the \"arch:arm\" tags.\n\nAlternatively, this test can be run using:\n\n  $ avocado --show=console run -t machine:orangepi-pc tests/acceptance/boot_linux_console.py\n  console: Uncompressing Linux... done, booting the kernel.\n  console: Booting Linux on physical CPU 0x0\n  console: Linux version 4.20.7-sunxi (root@armbian.com) (gcc version 7.2.1 20171011 (Linaro GCC 7.2-2017.11)) #5.75 SMP Fri Feb 8 09:02:10 CET 2019\n  console: CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=50c5387d\n  console: CPU: div instructions available: patching division code\n  console: CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache\n  console: OF: fdt: Machine model: Xunlong Orange Pi PC\n  [...]\n  console: Trying to unpack rootfs image as initramfs...\n  console: Freeing initrd memory: 3256K\n  console: Freeing unused kernel memory: 1024K\n  console: Run /init as init process\n  console: mount: mounting devtmpfs on /dev failed: Device or resource busy\n  console: Starting logging: OK\n  console: Initializing random number generator... random: dd: uninitialized urandom read (512 bytes read)\n  console: done.\n  console: Starting network: OK\n  console: Found console ttyS0\n  console: Linux version 4.20.7-sunxi (root@armbian.com) (gcc version 7.2.1 20171011 (Linaro GCC 7.2-2017.11)) #5.75 SMP Fri Feb 8 09:02:10 CET 2019\n  console: Boot successful.\n  console: cat /proc/cpuinfo\n  console: / # cat /proc/cpuinfo\n  console: processor      : 0\n  console: model name     : ARMv7 Processor rev 5 (v7l)\n  console: BogoMIPS       : 125.00\n  console: Features       : half thumb fastmult vfp edsp neon vfpv3 tls vfpv4 idiva idivt vfpd32 lpae evtstrm\n  console: CPU implementer        : 0x41\n  console: CPU architecture: 7\n  console: CPU variant    : 0x0\n  console: CPU part       : 0xc07\n  console: CPU revision   : 5\n  [...]\n  console: processor      : 3\n  console: model name     : ARMv7 Processor rev 5 (v7l)\n  console: BogoMIPS       : 125.00\n  console: Features       : half thumb fastmult vfp edsp neon vfpv3 tls vfpv4 idiva idivt vfpd32 lpae evtstrm\n  console: CPU implementer        : 0x41\n  console: CPU architecture: 7\n  console: CPU variant    : 0x0\n  console: CPU part       : 0xc07\n  console: CPU revision   : 5\n  console: Hardware       : Allwinner sun8i Family\n  console: Revision       : 0000\n  console: Serial         : 0000000000000000\n  console: cat /proc/iomem\n  console: / # cat /proc/iomem\n  console: 01000000-010fffff : clock@1000000\n  console: 01c00000-01c00fff : system-control@1c00000\n  console: 01c02000-01c02fff : dma-controller@1c02000\n  [...]\n  console: reboot\n  console: / # reboot\n  console: / # Found console ttyS0\n  console: Stopping network: OK\n  console: hrtimer: interrupt took 21852064 ns\n  console: Saving random seed... random: dd: uninitialized urandom read (512 bytes read)\n  console: done.\n  console: Stopping logging: OK\n  console: umount: devtmpfs busy - remounted read-only\n  console: umount: can't unmount /: Invalid argument\n  console: The system is going down NOW!\n  console: Sent SIGTERM to all processes\n  console: Sent SIGKILL to all processes\n  console: Requesting system reboot\n  console: reboot: Restarting system\n  PASS (48.32 s)\n  JOB TIME   : 49.16 s\n\nSigned-off-by: Philippe Mathieu-Daud\u00e9 <philmd@redhat.com>\nSigned-off-by: Niek Linnenbank <nieklinnenbank@gmail.com>\nReviewed-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nTested-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nMessage-id: 20200311221854.30370-15-nieklinnenbank@gmail.com\n[NL: rename in commit message Raspbian to Armbian, remove vm.set_machine()]\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
        "before_after_code_files": [
          "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py": [
          "File: tests/acceptance/boot_linux_console.py -> tests/acceptance/boot_linux_console.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "532:         console_pattern = 'Kernel command line: %s' % kernel_command_line",
          "533:         self.wait_for_console_pattern(console_pattern)",
          "535:     def test_s390x_s390_ccw_virtio(self):",
          "536:         \"\"\"",
          "537:         :avocado: tags=arch:s390x",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "535:     def test_arm_orangepi_initrd(self):",
          "536:         \"\"\"",
          "537:         :avocado: tags=arch:arm",
          "538:         :avocado: tags=machine:orangepi-pc",
          "539:         \"\"\"",
          "540:         deb_url = ('https://apt.armbian.com/pool/main/l/'",
          "541:                    'linux-4.20.7-sunxi/linux-image-dev-sunxi_5.75_armhf.deb')",
          "542:         deb_hash = '1334c29c44d984ffa05ed10de8c3361f33d78315'",
          "543:         deb_path = self.fetch_asset(deb_url, asset_hash=deb_hash)",
          "544:         kernel_path = self.extract_from_deb(deb_path,",
          "545:                                             '/boot/vmlinuz-4.20.7-sunxi')",
          "546:         dtb_path = '/usr/lib/linux-image-dev-sunxi/sun8i-h3-orangepi-pc.dtb'",
          "547:         dtb_path = self.extract_from_deb(deb_path, dtb_path)",
          "548:         initrd_url = ('https://github.com/groeck/linux-build-test/raw/'",
          "549:                       '2eb0a73b5d5a28df3170c546ddaaa9757e1e0848/rootfs/'",
          "550:                       'arm/rootfs-armv7a.cpio.gz')",
          "551:         initrd_hash = '604b2e45cdf35045846b8bbfbf2129b1891bdc9c'",
          "552:         initrd_path_gz = self.fetch_asset(initrd_url, asset_hash=initrd_hash)",
          "553:         initrd_path = os.path.join(self.workdir, 'rootfs.cpio')",
          "554:         archive.gzip_uncompress(initrd_path_gz, initrd_path)",
          "556:         self.vm.set_console()",
          "557:         kernel_command_line = (self.KERNEL_COMMON_COMMAND_LINE +",
          "558:                                'console=ttyS0,115200 '",
          "559:                                'panic=-1 noreboot')",
          "560:         self.vm.add_args('-kernel', kernel_path,",
          "561:                          '-dtb', dtb_path,",
          "562:                          '-initrd', initrd_path,",
          "563:                          '-append', kernel_command_line,",
          "564:                          '-no-reboot')",
          "565:         self.vm.launch()",
          "566:         self.wait_for_console_pattern('Boot successful.')",
          "568:         exec_command_and_wait_for_pattern(self, 'cat /proc/cpuinfo',",
          "569:                                                 'Allwinner sun8i Family')",
          "570:         exec_command_and_wait_for_pattern(self, 'cat /proc/iomem',",
          "571:                                                 'system-control@1c00000')",
          "572:         exec_command_and_wait_for_pattern(self, 'reboot',",
          "573:                                                 'reboot: Restarting system')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "921589fb72441e9f3f91a5291d703ffa64cce860",
      "candidate_info": {
        "commit_hash": "921589fb72441e9f3f91a5291d703ffa64cce860",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/921589fb72441e9f3f91a5291d703ffa64cce860",
        "files": [
          "tests/acceptance/boot_linux_console.py"
        ],
        "message": "tests/boot_linux_console: Test booting NetBSD via U-Boot on OrangePi PC\n\nThis test boots U-Boot then NetBSD (stored on a SD card) on\na OrangePi PC board.\n\nAs it requires ~1.3GB of storage, it is disabled by default.\n\nU-Boot is built by the Debian project [1], and the SD card image\nis provided by the NetBSD organization [2].\n\nOnce the compressed SD card image is downloaded (304MB) and\nextracted, this test is fast:\n\n  $ AVOCADO_ALLOW_LARGE_STORAGE=yes \\\n    avocado --show=app,console run -t machine:orangepi-pc \\\n      tests/acceptance/boot_linux_console.py\n  console: U-Boot SPL 2020.01+dfsg-1 (Jan 08 2020 - 08:19:44 +0000)\n  console: DRAM: 1024 MiB\n  console: U-Boot 2020.01+dfsg-1 (Jan 08 2020 - 08:19:44 +0000) Allwinner Technology\n  console: CPU:   Allwinner H3 (SUN8I 0000)\n  console: scanning bus usb@1c1b000 for devices... 1 USB Device(s) found\n  console: scanning bus usb@1c1d000 for devices... 1 USB Device(s) found\n  console: scanning usb for storage devices... 0 Storage Device(s) found\n  console: Hit any key to stop autoboot:  0\n  console: => setenv bootargs root=ld0a\n  console: => setenv kernel netbsd-GENERIC.ub\n  console: => setenv fdtfile dtb/sun8i-h3-orangepi-pc.dtb\n  console: => boot\n  console: ## Booting kernel from Legacy Image at 42000000 ...\n  console: Image Name:   NetBSD/earmv7hf 9.0_RC1\n  console: Image Type:   ARM Linux Kernel Image (no loading done) (uncompressed)\n  console: XIP Kernel Image (no loading done)\n  console: Loading Device Tree to 49ff6000, end 49fffe01 ... OK\n  console: Starting kernel ...\n  console: [   1.0000000] NetBSD/evbarm (fdt) booting ...\n  console: [   1.0000000] NetBSD 9.0 (GENERIC) #0: Fri Feb 14 00:06:28 UTC 2020\n  console: [   1.0000000]         mkrepro@mkrepro.NetBSD.org:/usr/src/sys/arch/evbarm/compile/GENERIC\n  console: [   1.0000000] total memory = 1024 MB\n  console: [   1.0000000] avail memory = 1003 MB\n  console: [   1.0000000] armfdt0 (root)\n  console: [   1.0000000] simplebus0 at armfdt0: Xunlong Orange Pi PC\n  console: [   1.0000000] cpu0 at cpus0: Cortex-A7 r0p5 (Cortex V7A core)\n  console: [   1.0000000] cpu0: DC enabled IC enabled WB enabled LABT branch prediction enabled\n  console: [   1.0000000] cpu0: 32KB/64B 2-way L1 VIPT Instruction cache\n  console: [   1.0000000] cpu0: 32KB/64B 2-way write-back-locking-C L1 PIPT Data cache\n  console: [   1.0000000] cpu0: 2304KB/64B 16-way write-through L2 PIPT Unified cache\n  console: [   1.0000000] vfp0 at cpu0: NEON MPE (VFP 3.0+), rounding, NaN propagation, denormals\n  ...\n  console: [   2.3812082] sdmmc0: SD card status: 4-bit, C0\n  console: [   2.3812082] ld0 at sdmmc0: <0xaa:0x5859:QEMU!:0x01:0xdeadbeef:0x062>\n  console: [   2.4012856] ld0: 1226 MB, 622 cyl, 64 head, 63 sec, 512 bytes/sect x 2511872 sectors\n  console: [   2.5321222] ld0: 4-bit width, High-Speed/SDR25, 50.000 MHz\n  console: [   3.1068718] WARNING: 4 errors while detecting hardware; check system log.\n  console: [   3.1179868] boot device: ld0\n  console: [   3.1470623] root on ld0a dumps on ld0b\n  console: [   3.2464436] root file system type: ffs\n  console: [   3.2897123] kern.module.path=/stand/evbarm/9.0/modules\n  console: Mon Feb 17 20:33:35 UTC 2020\n  console: Starting root file system check:\n  PASS (35.96 s)\n  RESULTS    : PASS 1 | ERROR 0 | FAIL 0 | SKIP 0 | WARN 0 | INTERRUPT 0 | CANCEL 0\n  JOB TIME   : 36.09 s\n\nNote, this test only took ~65 seconds to run on Travis-CI, see: [3].\n\nThis test is based on a description from Niek Linnenbank from [4].\n\n[1] https://wiki.debian.org/InstallingDebianOn/Allwinner#Creating_a_bootable_SD_Card_with_u-boot\n[2] https://wiki.netbsd.org/ports/evbarm/allwinner/\n[3] https://travis-ci.org/philmd/qemu/jobs/638823612#L3778\n[4] https://www.mail-archive.com/qemu-devel@nongnu.org/msg669347.html\n\nSigned-off-by: Philippe Mathieu-Daud\u00e9 <f4bug@amsat.org>\nSigned-off-by: Niek Linnenbank <nieklinnenbank@gmail.com>\nReviewed-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nTested-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nMessage-id: 20200311221854.30370-18-nieklinnenbank@gmail.com\n[NL: changed test to use NetBSD 9.0 final release and -global allwinner-rtc.base-year]\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
        "before_after_code_files": [
          "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py": [
          "File: tests/acceptance/boot_linux_console.py -> tests/acceptance/boot_linux_console.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: from avocado import skipUnless",
          "17: from avocado_qemu import Test",
          "18: from avocado_qemu import exec_command_and_wait_for_pattern",
          "19: from avocado_qemu import wait_for_console_pattern",
          "20: from avocado.utils import process",
          "21: from avocado.utils import archive",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from avocado_qemu import interrupt_interactive_console_until_pattern",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "667:                                       'to <orangepipc>')",
          "668:         self.wait_for_console_pattern('Starting Load Kernel Modules...')",
          "670:     def test_s390x_s390_ccw_virtio(self):",
          "671:         \"\"\"",
          "672:         :avocado: tags=arch:s390x",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "671:     @skipUnless(os.getenv('AVOCADO_ALLOW_LARGE_STORAGE'), 'storage limited')",
          "672:     def test_arm_orangepi_uboot_netbsd9(self):",
          "673:         \"\"\"",
          "674:         :avocado: tags=arch:arm",
          "675:         :avocado: tags=machine:orangepi-pc",
          "676:         \"\"\"",
          "677:         # This test download a 304MB compressed image and expand it to 1.3GB...",
          "678:         deb_url = ('http://snapshot.debian.org/archive/debian/'",
          "679:                    '20200108T145233Z/pool/main/u/u-boot/'",
          "680:                    'u-boot-sunxi_2020.01%2Bdfsg-1_armhf.deb')",
          "681:         deb_hash = 'f67f404a80753ca3d1258f13e38f2b060e13db99'",
          "682:         deb_path = self.fetch_asset(deb_url, asset_hash=deb_hash)",
          "683:         # We use the common OrangePi PC 'plus' build of U-Boot for our secondary",
          "684:         # program loader (SPL). We will then set the path to the more specific",
          "685:         # OrangePi \"PC\" device tree blob with 'setenv fdtfile' in U-Boot prompt,",
          "686:         # before to boot NetBSD.",
          "687:         uboot_path = '/usr/lib/u-boot/orangepi_plus/u-boot-sunxi-with-spl.bin'",
          "688:         uboot_path = self.extract_from_deb(deb_path, uboot_path)",
          "689:         image_url = ('https://cdn.netbsd.org/pub/NetBSD/NetBSD-9.0/'",
          "690:                      'evbarm-earmv7hf/binary/gzimg/armv7.img.gz')",
          "691:         image_hash = '2babb29d36d8360adcb39c09e31060945259917a'",
          "692:         image_path_gz = self.fetch_asset(image_url, asset_hash=image_hash)",
          "693:         image_path = os.path.join(self.workdir, 'armv7.img')",
          "694:         image_drive_args = 'if=sd,format=raw,snapshot=on,file=' + image_path",
          "695:         archive.gzip_uncompress(image_path_gz, image_path)",
          "697:         # dd if=u-boot-sunxi-with-spl.bin of=armv7.img bs=1K seek=8 conv=notrunc",
          "698:         with open(uboot_path, 'rb') as f_in:",
          "699:             with open(image_path, 'r+b') as f_out:",
          "700:                 f_out.seek(8 * 1024)",
          "701:                 shutil.copyfileobj(f_in, f_out)",
          "703:                 # Extend image, to avoid that NetBSD thinks the partition",
          "704:                 # inside the image is larger than device size itself",
          "705:                 f_out.seek(0, 2)",
          "706:                 f_out.seek(64 * 1024 * 1024, 1)",
          "707:                 f_out.write(bytearray([0x00]))",
          "709:         self.vm.set_console()",
          "710:         self.vm.add_args('-nic', 'user',",
          "711:                          '-drive', image_drive_args,",
          "712:                          '-global', 'allwinner-rtc.base-year=2000',",
          "713:                          '-no-reboot')",
          "714:         self.vm.launch()",
          "715:         wait_for_console_pattern(self, 'U-Boot 2020.01+dfsg-1')",
          "716:         interrupt_interactive_console_until_pattern(self,",
          "717:                                        'Hit any key to stop autoboot:',",
          "718:                                        'switch to partitions #0, OK')",
          "720:         exec_command_and_wait_for_pattern(self, '', '=>')",
          "721:         cmd = 'setenv bootargs root=ld0a'",
          "722:         exec_command_and_wait_for_pattern(self, cmd, '=>')",
          "723:         cmd = 'setenv kernel netbsd-GENERIC.ub'",
          "724:         exec_command_and_wait_for_pattern(self, cmd, '=>')",
          "725:         cmd = 'setenv fdtfile dtb/sun8i-h3-orangepi-pc.dtb'",
          "726:         exec_command_and_wait_for_pattern(self, cmd, '=>')",
          "727:         cmd = (\"setenv bootcmd 'fatload mmc 0:1 ${kernel_addr_r} ${kernel}; \"",
          "728:                \"fatload mmc 0:1 ${fdt_addr_r} ${fdtfile}; \"",
          "729:                \"fdt addr ${fdt_addr_r}; \"",
          "730:                \"bootm ${kernel_addr_r} - ${fdt_addr_r}'\")",
          "731:         exec_command_and_wait_for_pattern(self, cmd, '=>')",
          "733:         exec_command_and_wait_for_pattern(self, 'boot',",
          "734:                                           'Booting kernel from Legacy Image')",
          "735:         wait_for_console_pattern(self, 'Starting kernel ...')",
          "736:         wait_for_console_pattern(self, 'NetBSD 9.0 (GENERIC)')",
          "737:         # Wait for user-space",
          "738:         wait_for_console_pattern(self, 'Starting root file system check')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cfaf757edd77ccbab1097c9972d1163074c30d6a",
      "candidate_info": {
        "commit_hash": "cfaf757edd77ccbab1097c9972d1163074c30d6a",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/cfaf757edd77ccbab1097c9972d1163074c30d6a",
        "files": [
          "hw/block/virtio-blk.c"
        ],
        "message": "virtio-blk: delete vqs on the error path in realize()\n\nvirtio_vqs forgot to free on the error path in realize(). Fix that.\n\nThe asan stack:\nDirect leak of 14336 byte(s) in 1 object(s) allocated from:\n    #0 0x7f58b93fd970 in __interceptor_calloc (/lib64/libasan.so.5+0xef970)\n    #1 0x7f58b858249d in g_malloc0 (/lib64/libglib-2.0.so.0+0x5249d)\n    #2 0x5562cc627f49 in virtio_add_queue /mnt/sdb/qemu/hw/virtio/virtio.c:2413\n    #3 0x5562cc4b524a in virtio_blk_device_realize /mnt/sdb/qemu/hw/block/virtio-blk.c:1202\n    #4 0x5562cc613050 in virtio_device_realize /mnt/sdb/qemu/hw/virtio/virtio.c:3615\n    #5 0x5562ccb7a568 in device_set_realized /mnt/sdb/qemu/hw/core/qdev.c:891\n    #6 0x5562cd39cd45 in property_set_bool /mnt/sdb/qemu/qom/object.c:2238\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nReviewed-by: Stefano Garzarella <sgarzare@redhat.com>\nMessage-Id: <20200328005705.29898-2-pannengyuan@huawei.com>\nReviewed-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "hw/block/virtio-blk.c||hw/block/virtio-blk.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hw/block/virtio-blk.c||hw/block/virtio-blk.c": [
          "File: hw/block/virtio-blk.c -> hw/block/virtio-blk.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1204:     virtio_blk_data_plane_create(vdev, conf, &s->dataplane, &err);",
          "1205:     if (err != NULL) {",
          "1206:         error_propagate(errp, err);",
          "1207:         virtio_cleanup(vdev);",
          "1208:         return;",
          "1209:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1207:         for (i = 0; i < conf->num_queues; i++) {",
          "1208:             virtio_del_queue(vdev, i);",
          "1209:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}