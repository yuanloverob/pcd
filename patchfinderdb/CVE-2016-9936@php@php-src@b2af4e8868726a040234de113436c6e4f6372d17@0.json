{
  "cve_id": "CVE-2016-9936",
  "cve_desc": "The unserialize implementation in ext/standard/var.c in PHP 7.x before 7.0.14 allows remote attackers to cause a denial of service (use-after-free) or possibly have unspecified other impact via crafted serialized data.  NOTE: this vulnerability exists because of an incomplete fix for CVE-2015-6834.",
  "repo": "php/php-src",
  "patch_hash": "b2af4e8868726a040234de113436c6e4f6372d17",
  "patch_info": {
    "commit_hash": "b2af4e8868726a040234de113436c6e4f6372d17",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/b2af4e8868726a040234de113436c6e4f6372d17",
    "files": [
      "ext/standard/tests/serialize/bug70172_2.phpt",
      "ext/standard/var.c"
    ],
    "message": "Complete the fix of bug #70172 for PHP 7",
    "before_after_code_files": [
      "ext/standard/tests/serialize/bug70172_2.phpt||ext/standard/tests/serialize/bug70172_2.phpt",
      "ext/standard/var.c||ext/standard/var.c"
    ]
  },
  "patch_diff": {
    "ext/standard/tests/serialize/bug70172_2.phpt||ext/standard/tests/serialize/bug70172_2.phpt": [
      "File: ext/standard/tests/serialize/bug70172_2.phpt -> ext/standard/tests/serialize/bug70172_2.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: --TEST--",
      "2: Bug #70172 - Use After Free Vulnerability in unserialize()",
      "5: --FILE--",
      "6: <?php",
      "7: class obj implements Serializable {",
      "",
      "[Removed Lines]",
      "3: --XFAIL--",
      "4: Unfinished merge, needs fix.",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "61:     [0]=>",
      "62:     array(1) {",
      "63:       [0]=>",
      "65:         [\"ryat\"]=>",
      "66:         int(1)",
      "67:       }",
      "68:     }",
      "69:   }",
      "",
      "[Removed Lines]",
      "64:       &object(obj2)#%d (1) {",
      "70: }",
      "",
      "[Added Lines]",
      "62:       object(obj2)#%d (1) {",
      "",
      "---------------"
    ],
    "ext/standard/var.c||ext/standard/var.c": [
      "File: ext/standard/var.c -> ext/standard/var.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1036:  const unsigned char *p;",
      "1037:  php_unserialize_data_t var_hash;",
      "1038:  zval *options = NULL, *classes = NULL;",
      "1039:  HashTable *class_hash = NULL;",
      "1041:  if (zend_parse_parameters(ZEND_NUM_ARGS(), \"s|a\", &buf, &buf_len, &options) == FAILURE) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1039:  zval *retval;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1067:   }",
      "1068:  }",
      "1071:   PHP_VAR_UNSERIALIZE_DESTROY(var_hash);",
      "1072:   if (class_hash) {",
      "1073:    zend_hash_destroy(class_hash);",
      "1074:    FREE_HASHTABLE(class_hash);",
      "1075:   }",
      "1077:   if (!EG(exception)) {",
      "1078:    php_error_docref(NULL, E_NOTICE, \"Error at offset \" ZEND_LONG_FMT \" of %zd bytes\",",
      "1079:     (zend_long)((char*)p - buf), buf_len);",
      "1080:   }",
      "1081:   RETURN_FALSE;",
      "1082:  }",
      "1087:  PHP_VAR_UNSERIALIZE_DESTROY(var_hash);",
      "1088:  if (class_hash) {",
      "",
      "[Removed Lines]",
      "1070:  if (!php_var_unserialize_ex(return_value, &p, p + buf_len, &var_hash, class_hash)) {",
      "1076:   zval_ptr_dtor(return_value);",
      "1085:  var_push_dtor(&var_hash, return_value);",
      "",
      "[Added Lines]",
      "1071:  retval = var_tmp_var(&var_hash);",
      "1072:  if (!php_var_unserialize_ex(retval, &p, p + buf_len, &var_hash, class_hash)) {",
      "1085:  ZVAL_COPY(return_value, retval);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c85907682a14a6fa174cb4619c4afc8984260202",
      "candidate_info": {
        "commit_hash": "c85907682a14a6fa174cb4619c4afc8984260202",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/c85907682a14a6fa174cb4619c4afc8984260202",
        "files": [
          "ext/standard/var.c",
          "ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re"
        ],
        "message": "Improved fix for #71940",
        "before_after_code_files": [
          "ext/standard/var.c||ext/standard/var.c",
          "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/var.c||ext/standard/var.c"
          ],
          "candidate": [
            "ext/standard/var.c||ext/standard/var.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/var.c||ext/standard/var.c": [
          "File: ext/standard/var.c -> ext/standard/var.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1040:  if (!php_var_unserialize_ex(return_value, &p, p + buf_len, &var_hash, class_hash)) {",
          "1041:   PHP_VAR_UNSERIALIZE_DESTROY(var_hash);",
          "1043:    zend_hash_destroy(class_hash);",
          "1044:    FREE_HASHTABLE(class_hash);",
          "1045:   }",
          "",
          "[Removed Lines]",
          "1042:   if(class_hash) {",
          "",
          "[Added Lines]",
          "1042:   if (class_hash) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1050:   }",
          "1051:   RETURN_FALSE;",
          "1052:  }",
          "1053:  PHP_VAR_UNSERIALIZE_DESTROY(var_hash);",
          "1055:   zend_hash_destroy(class_hash);",
          "1056:   FREE_HASHTABLE(class_hash);",
          "1057:  }",
          "",
          "[Removed Lines]",
          "1054:  if(class_hash) {",
          "",
          "[Added Lines]",
          "1055:  var_push_dtor(&var_hash, return_value);",
          "1058:  if (class_hash) {",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
          "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "574:  yych = *(YYMARKER = ++YYCURSOR);",
          "575:  if (yych == ':') goto yy95;",
          "576: yy3:",
          "578:  { return 0; }",
          "579: #line 580 \"ext/standard/var_unserializer.c\"",
          "580: yy4:",
          "",
          "[Removed Lines]",
          "577: #line 886 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "577: #line 884 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "619:  goto yy3;",
          "620: yy14:",
          "621:  ++YYCURSOR;",
          "623:  {",
          "625:  php_error_docref(NULL, E_NOTICE, \"Unexpected end of serialized data\");",
          "",
          "[Removed Lines]",
          "622: #line 880 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "622: #line 878 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "655:  yych = *++YYCURSOR;",
          "656:  if (yych != '\"') goto yy18;",
          "657:  ++YYCURSOR;",
          "659:  {",
          "660:  size_t len, len2, len3, maxlen;",
          "661:  zend_long elements;",
          "",
          "[Removed Lines]",
          "658: #line 735 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "658: #line 733 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "825:  yych = *++YYCURSOR;",
          "826:  if (yych != '\"') goto yy18;",
          "827:  ++YYCURSOR;",
          "829:  {",
          "830:     if (!var_hash) return 0;",
          "",
          "[Removed Lines]",
          "828: #line 728 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "828: #line 726 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "871:   zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "872:  }",
          "876:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {",
          "877:   return 0;",
          "878:  }",
          "880:  return finish_nested_data(UNSERIALIZE_PASSTHRU);",
          "881: }",
          "883: yy39:",
          "884:  yych = *++YYCURSOR;",
          "885:  if (yych == '+') goto yy40;",
          "",
          "[Removed Lines]",
          "875:  var_push_dtor(var_hash, rval);",
          "882: #line 883 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "880: #line 881 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "934:  ZVAL_STR(rval, str);",
          "935:  return 1;",
          "936: }",
          "938: yy46:",
          "939:  yych = *++YYCURSOR;",
          "940:  if (yych == '+') goto yy47;",
          "",
          "[Removed Lines]",
          "937: #line 938 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "935: #line 936 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "987:  ZVAL_STRINGL(rval, str, len);",
          "988:  return 1;",
          "989: }",
          "991: yy53:",
          "992:  yych = *++YYCURSOR;",
          "993:  if (yych <= '/') {",
          "",
          "[Removed Lines]",
          "990: #line 991 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "988: #line 989 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1084:  ZVAL_DOUBLE(rval, zend_strtod((const char *)start + 2, NULL));",
          "1085:  return 1;",
          "1086: }",
          "1088: yy65:",
          "1089:  yych = *++YYCURSOR;",
          "1090:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1087: #line 1088 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1085: #line 1086 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1160:  return 1;",
          "1161: }",
          "1163: yy76:",
          "1164:  yych = *++YYCURSOR;",
          "1165:  if (yych == 'N') goto yy73;",
          "",
          "[Removed Lines]",
          "1162: #line 1163 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1160: #line 1161 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1212:  ZVAL_LONG(rval, parse_iv(start + 2));",
          "1213:  return 1;",
          "1214: }",
          "1216: yy83:",
          "1217:  yych = *++YYCURSOR;",
          "1218:  if (yych <= '/') goto yy18;",
          "",
          "[Removed Lines]",
          "1215: #line 1216 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1213: #line 1214 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1226:  ZVAL_BOOL(rval, parse_iv(start + 2));",
          "1227:  return 1;",
          "1228: }",
          "1230: yy87:",
          "1231:  ++YYCURSOR;",
          "1232: #line 573 \"ext/standard/var_unserializer.re\"",
          "",
          "[Removed Lines]",
          "1229: #line 1230 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1227: #line 1228 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1235:  ZVAL_NULL(rval);",
          "1236:  return 1;",
          "1237: }",
          "1239: yy89:",
          "1240:  yych = *++YYCURSOR;",
          "1241:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1238: #line 1239 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1236: #line 1237 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1284:  return 1;",
          "1285: }",
          "1287: yy95:",
          "1288:  yych = *++YYCURSOR;",
          "1289:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1286: #line 1287 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1284: #line 1285 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1333:  return 1;",
          "1334: }",
          "1336: }",
          "1340:  return 0;",
          "",
          "[Removed Lines]",
          "1335: #line 1336 \"ext/standard/var_unserializer.c\"",
          "1337: #line 888 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1333: #line 1334 \"ext/standard/var_unserializer.c\"",
          "1335: #line 886 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re": [
          "File: ext/standard/var_unserializer.re -> ext/standard/var_unserializer.re",
          "--- Hunk 1 ---",
          "[Context before]",
          "716:   zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "717:  }",
          "721:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {",
          "722:   return 0;",
          "723:  }",
          "",
          "[Removed Lines]",
          "720:  var_push_dtor(var_hash, rval);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}