{
  "cve_id": "CVE-2019-11471",
  "cve_desc": "libheif 1.4.0 has a use-after-free in heif::HeifContext::Image::set_alpha_channel in heif_context.h because heif_context.cc mishandles references to non-existing alpha images.",
  "repo": "strukturag/libheif",
  "patch_hash": "995a4283d8ed2d0d2c1ceb1a577b993df2f0e014",
  "patch_info": {
    "commit_hash": "995a4283d8ed2d0d2c1ceb1a577b993df2f0e014",
    "repo": "strukturag/libheif",
    "commit_url": "https://github.com/strukturag/libheif/commit/995a4283d8ed2d0d2c1ceb1a577b993df2f0e014",
    "files": [
      "fuzzing/corpus/uaf_heif_context.h_117_1.heic",
      "libheif/heif_context.cc"
    ],
    "message": "Detect non-existing referenced alpha images (fixes #123)",
    "before_after_code_files": [
      "libheif/heif_context.cc||libheif/heif_context.cc"
    ]
  },
  "patch_diff": {
    "libheif/heif_context.cc||libheif/heif_context.cc": [
      "File: libheif/heif_context.cc -> libheif/heif_context.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "576:             image->set_is_alpha_channel_of(refs[0]);",
      "578:             auto master_iter = m_all_images.find(refs[0]);",
      "579:             if (image.get() == master_iter->second.get()) {",
      "580:               return Error(heif_error_Invalid_input,",
      "581:                            heif_suberror_Nonexisting_item_referenced,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "579:             if (master_iter == m_all_images.end()) {",
      "580:               return Error(heif_error_Invalid_input,",
      "581:                            heif_suberror_Nonexisting_item_referenced,",
      "582:                            \"Non-existing alpha image referenced\");",
      "583:             }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8dc35cda0ae5ad7bf2d2fae7354e08074ac79d18",
      "candidate_info": {
        "commit_hash": "8dc35cda0ae5ad7bf2d2fae7354e08074ac79d18",
        "repo": "strukturag/libheif",
        "commit_url": "https://github.com/strukturag/libheif/commit/8dc35cda0ae5ad7bf2d2fae7354e08074ac79d18",
        "files": [
          "fuzzing/corpus/uaf_heif_context.h_117_1.heic",
          "libheif/heif_context.cc"
        ],
        "message": "Detect non-existing referenced alpha images (fixes #123) / CVE-2019-11471",
        "before_after_code_files": [
          "libheif/heif_context.cc||libheif/heif_context.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libheif/heif_context.cc||libheif/heif_context.cc"
          ],
          "candidate": [
            "libheif/heif_context.cc||libheif/heif_context.cc"
          ]
        }
      },
      "candidate_diff": {
        "libheif/heif_context.cc||libheif/heif_context.cc": [
          "File: libheif/heif_context.cc -> libheif/heif_context.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:             image->set_is_alpha_channel_of(refs[0]);",
          "573:             auto master_iter = m_all_images.find(refs[0]);",
          "574:             master_iter->second->set_alpha_channel(image);",
          "575:           }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "574:             if (master_iter == m_all_images.end()) {",
          "575:               return Error(heif_error_Invalid_input,",
          "576:                            heif_suberror_Nonexisting_item_referenced,",
          "577:                            \"Non-existing alpha image referenced\");",
          "578:             }",
          "579:             if (image.get() == master_iter->second.get()) {",
          "580:               return Error(heif_error_Invalid_input,",
          "581:                            heif_suberror_Nonexisting_item_referenced,",
          "582:                            \"Recursive alpha image detected\");",
          "583:             }",
          "",
          "---------------"
        ]
      }
    }
  ]
}