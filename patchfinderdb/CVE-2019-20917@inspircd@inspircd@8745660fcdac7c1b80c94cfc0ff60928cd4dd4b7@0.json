{
  "cve_id": "CVE-2019-20917",
  "cve_desc": "An issue was discovered in InspIRCd 2 before 2.0.28 and 3 before 3.3.0. The mysql module contains a NULL pointer dereference when built against mariadb-connector-c 3.0.5 or newer. When combined with the sqlauth or sqloper modules, this vulnerability can be used for remote crashing of an InspIRCd server by any user able to connect to a server.",
  "repo": "inspircd/inspircd",
  "patch_hash": "8745660fcdac7c1b80c94cfc0ff60928cd4dd4b7",
  "patch_info": {
    "commit_hash": "8745660fcdac7c1b80c94cfc0ff60928cd4dd4b7",
    "repo": "inspircd/inspircd",
    "commit_url": "https://github.com/inspircd/inspircd/commit/8745660fcdac7c1b80c94cfc0ff60928cd4dd4b7",
    "files": [
      "src/modules/extra/m_mysql.cpp"
    ],
    "message": "Initialise and deallocate the MySQL library correctly.",
    "before_after_code_files": [
      "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp"
    ]
  },
  "patch_diff": {
    "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp": [
      "File: src/modules/extra/m_mysql.cpp -> src/modules/extra/m_mysql.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "413: void ModuleSQL::init()",
      "414: {",
      "415:  Dispatcher = new DispatcherThread(this);",
      "416:  ServerInstance->Threads.Start(Dispatcher);",
      "417: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "415:  if (mysql_library_init(0, NULL, NULL))",
      "416:   throw ModuleException(\"Unable to initialise the MySQL library!\");",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "424:   Dispatcher->OnNotify();",
      "425:   delete Dispatcher;",
      "426:  }",
      "427:  for(ConnMap::iterator i = connections.begin(); i != connections.end(); i++)",
      "428:  {",
      "429:   delete i->second;",
      "430:  }",
      "431: }",
      "433: void ModuleSQL::ReadConfig(ConfigStatus& status)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "436:  mysql_library_end();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2cc35d8625b7ea5cbd1d1ebb116aff86c5280162",
      "candidate_info": {
        "commit_hash": "2cc35d8625b7ea5cbd1d1ebb116aff86c5280162",
        "repo": "inspircd/inspircd",
        "commit_url": "https://github.com/inspircd/inspircd/commit/2cc35d8625b7ea5cbd1d1ebb116aff86c5280162",
        "files": [
          "src/modules/extra/m_mysql.cpp"
        ],
        "message": "Initialise and deallocate the MySQL library correctly.",
        "before_after_code_files": [
          "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp"
          ],
          "candidate": [
            "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/modules/extra/m_mysql.cpp||src/modules/extra/m_mysql.cpp": [
          "File: src/modules/extra/m_mysql.cpp -> src/modules/extra/m_mysql.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "381: void ModuleSQL::init()",
          "382: {",
          "383:  Dispatcher = new DispatcherThread(this);",
          "384:  ServerInstance->Threads->Start(Dispatcher);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "383:  if (mysql_library_init(0, NULL, NULL))",
          "384:   throw ModuleException(\"Unable to initialise the MySQL library!\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "397:   Dispatcher->OnNotify();",
          "398:   delete Dispatcher;",
          "399:  }",
          "400:  for(ConnMap::iterator i = connections.begin(); i != connections.end(); i++)",
          "401:  {",
          "402:   delete i->second;",
          "403:  }",
          "404: }",
          "406: void ModuleSQL::OnRehash(User* user)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "409:  mysql_library_end();",
          "",
          "---------------"
        ]
      }
    }
  ]
}