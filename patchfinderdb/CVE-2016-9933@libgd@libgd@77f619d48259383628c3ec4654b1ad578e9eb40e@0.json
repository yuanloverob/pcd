{
  "cve_id": "CVE-2016-9933",
  "cve_desc": "Stack consumption vulnerability in the gdImageFillToBorder function in gd.c in the GD Graphics Library (aka libgd) before 2.2.2, as used in PHP before 5.6.28 and 7.x before 7.0.13, allows remote attackers to cause a denial of service (segmentation violation) via a crafted imagefilltoborder call that triggers use of a negative color value.",
  "repo": "libgd/libgd",
  "patch_hash": "77f619d48259383628c3ec4654b1ad578e9eb40e",
  "patch_info": {
    "commit_hash": "77f619d48259383628c3ec4654b1ad578e9eb40e",
    "repo": "libgd/libgd",
    "commit_url": "https://github.com/libgd/libgd/commit/77f619d48259383628c3ec4654b1ad578e9eb40e",
    "files": [
      "src/gd.c",
      "tests/gdimagefilltoborder/.gitignore",
      "tests/gdimagefilltoborder/CMakeLists.txt",
      "tests/gdimagefilltoborder/Makemodule.am"
    ],
    "message": "fix #215 gdImageFillToBorder stack-overflow when invalid color is used",
    "before_after_code_files": [
      "src/gd.c||src/gd.c",
      "tests/gdimagefilltoborder/Makemodule.am||tests/gdimagefilltoborder/Makemodule.am"
    ]
  },
  "patch_diff": {
    "src/gd.c||src/gd.c": [
      "File: src/gd.c -> src/gd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1928:  int i;",
      "1929:  int restoreAlphaBleding;",
      "1933:   return;",
      "1934:  }",
      "1936:  leftLimit = (-1);",
      "1938:  restoreAlphaBleding = im->alphaBlendingFlag;",
      "",
      "[Removed Lines]",
      "1931:  if (border < 0) {",
      "",
      "[Added Lines]",
      "1931:  if (border < 0 || color < 0) {",
      "1936:  if (!im->trueColor) {",
      "1937:   if ((color > (im->colorsTotal - 1)) || (border > (im->colorsTotal - 1))) {",
      "1938:    return;",
      "1939:   }",
      "1940:     }",
      "",
      "---------------"
    ],
    "tests/gdimagefilltoborder/Makemodule.am||tests/gdimagefilltoborder/Makemodule.am": [
      "File: tests/gdimagefilltoborder/Makemodule.am -> tests/gdimagefilltoborder/Makemodule.am",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: if HAVE_LIBPNG",
      "2: libgd_test_programs += \\",
      "4: endif",
      "6: EXTRA_DIST += \\",
      "",
      "[Removed Lines]",
      "3:  gdimagefilltoborder/bug00037",
      "",
      "[Added Lines]",
      "3:  gdimagefilltoborder/bug00037 \\",
      "4:  gdimagefilltoborder/github_bug_215",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6156e6645d39cbd59b0339d41f73fdb1208fcddb",
      "candidate_info": {
        "commit_hash": "6156e6645d39cbd59b0339d41f73fdb1208fcddb",
        "repo": "libgd/libgd",
        "commit_url": "https://github.com/libgd/libgd/commit/6156e6645d39cbd59b0339d41f73fdb1208fcddb",
        "files": [
          "tests/gdimagefilltoborder/github_bug_215.c"
        ],
        "message": "fix #215, invalid color index, missing case for invalid border",
        "before_after_code_files": [
          "tests/gdimagefilltoborder/github_bug_215.c||tests/gdimagefilltoborder/github_bug_215.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/gdimagefilltoborder/github_bug_215.c||tests/gdimagefilltoborder/github_bug_215.c": [
          "File: tests/gdimagefilltoborder/github_bug_215.c -> tests/gdimagefilltoborder/github_bug_215.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: int main() {",
          "6:  gdImagePtr im;",
          "8:  im = gdImageCreate(50, 50);",
          "10:  gdImageDestroy(im);",
          "11:  return 0;",
          "12: }",
          "",
          "[Removed Lines]",
          "9:  gdImageFillToBorder(im, 0, 0, 1024, 1024);",
          "",
          "[Added Lines]",
          "7:  int bgd, color, border;",
          "9:  bgd = gdImageColorAllocate(im, 255, 0, 0);",
          "10:  color = gdImageColorAllocate(im, 255, 0, 0);",
          "11:  border = gdImageColorAllocate(im, 255, 0, 0);",
          "12:  gdImageFillToBorder(im, 0, 0, border + 10, color);",
          "13:  gdImageFillToBorder(im, 0, 0, -border, color);",
          "14:  gdImageFillToBorder(im, 0, 0, border, color + 10);",
          "15:  gdImageFillToBorder(im, 0, 0, border, -color);",
          "16:  gdImageFillToBorder(im, 0, 0, border + 10, color + 10);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2a55b0f7a02581b6e8d110ef8d6d067ce095783c",
      "candidate_info": {
        "commit_hash": "2a55b0f7a02581b6e8d110ef8d6d067ce095783c",
        "repo": "libgd/libgd",
        "commit_url": "https://github.com/libgd/libgd/commit/2a55b0f7a02581b6e8d110ef8d6d067ce095783c",
        "files": [
          "tests/gdimagefilltoborder/github_bug_215.c"
        ],
        "message": "fix #215 missing test",
        "before_after_code_files": [
          "tests/gdimagefilltoborder/github_bug_215.c||tests/gdimagefilltoborder/github_bug_215.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/gdimagefilltoborder/github_bug_215.c||tests/gdimagefilltoborder/github_bug_215.c": [
          "File: tests/gdimagefilltoborder/github_bug_215.c -> tests/gdimagefilltoborder/github_bug_215.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: #include <stdio.h>",
          "2: #include \"gd.h\"",
          "3: #include \"gdtest.h\"",
          "5: int main() {",
          "6:  gdImagePtr im;",
          "7:  int  white, red;",
          "9:  im = gdImageCreate(50, 50);",
          "10:  white = gdImageColorAllocate(im, 255, 255, 255);",
          "11:  red = gdImageColorAllocate(im, 255, 0, 0);",
          "12:  gdImageFillToBorder(im, 0, 0, 1024, 1024);",
          "13:  gdImageDestroy(im);",
          "14:  return 0;",
          "15: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6f5c4084c1a94e6312e81b3efc07b736fe938e16",
      "candidate_info": {
        "commit_hash": "6f5c4084c1a94e6312e81b3efc07b736fe938e16",
        "repo": "libgd/libgd",
        "commit_url": "https://github.com/libgd/libgd/commit/6f5c4084c1a94e6312e81b3efc07b736fe938e16",
        "files": [
          "src/gd.c"
        ],
        "message": "fix #215, invalid color index, missing case for invalid border",
        "before_after_code_files": [
          "src/gd.c||src/gd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/gd.c||src/gd.c"
          ],
          "candidate": [
            "src/gd.c||src/gd.c"
          ]
        }
      },
      "candidate_diff": {
        "src/gd.c||src/gd.c": [
          "File: src/gd.c -> src/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1934:  }",
          "1936:  if (!im->trueColor) {",
          "1938:    return;",
          "1939:   }",
          "1942:  leftLimit = (-1);",
          "",
          "[Removed Lines]",
          "1937:   if ((color > (im->colorsTotal - 1)) || (border > (im->colorsTotal - 1))) {",
          "1940:     }",
          "",
          "[Added Lines]",
          "1937:   if ((color > (im->colorsTotal - 1)) || (border > (im->colorsTotal - 1)) || (color < 0)) {",
          "1940:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}