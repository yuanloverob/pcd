{
  "cve_id": "CVE-2019-19880",
  "cve_desc": "exprListAppendList in window.c in SQLite 3.30.1 allows attackers to trigger an invalid pointer dereference because constant integer values in ORDER BY clauses of window definitions are mishandled.",
  "repo": "sqlite/sqlite",
  "patch_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
  "patch_info": {
    "commit_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/window.c"
    ],
    "message": "When processing constant integer values in ORDER BY clauses of window definitions (see check-in [7e4809eadfe99ebf]) be sure to fully disable the constant value to avoid an invalid pointer dereference if the expression is ever duplicated. This fixes a crash report from Yongheng and Rui.\n\nFossilOrigin-Name: 1ca0bd982ab1183bbafce0d260e4dceda5eb766ed2e7793374a88d1ae0bdd2ca",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/window.c||src/window.c"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8223e79f987feda5c8e51ec52cec6798cca16d070b10558939e2888ca1a25b8e",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/window.c||src/window.c": [
      "File: src/window.c -> src/window.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "895:     int nInit = pList ? pList->nExpr : 0;",
      "896:     for(i=0; i<pAppend->nExpr; i++){",
      "897:       Expr *pDup = sqlite3ExprDup(pParse->db, pAppend->a[i].pExpr, 0);",
      "898:       if( bIntToNull && pDup && pDup->op==TK_INTEGER ){",
      "899:         pDup->op = TK_NULL;",
      "900:         pDup->flags &= ~(EP_IntValue|EP_IsTrue|EP_IsFalse);",
      "901:       }",
      "902:       pList = sqlite3ExprListAppend(pParse, pList, pDup);",
      "903:       if( pList ) pList->a[nInit+i].sortFlags = pAppend->a[i].sortFlags;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "898:       assert( pDup==0 || !ExprHasProperty(pDup, EP_MemToken) );",
      "902:         pDup->u.zToken = 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1ff9407198073f488d41782d3a97176018ded973",
      "candidate_info": {
        "commit_hash": "1ff9407198073f488d41782d3a97176018ded973",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/1ff9407198073f488d41782d3a97176018ded973",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c",
          "test/without_rowid7.test"
        ],
        "message": "Fix problems with duplicate fields in the PRIMARY KEYs of WITHOUT ROWID tables.\n\nFossilOrigin-Name: bd9a47a3a2997bfbf9c8a11c5b7196e362974054e58a2fe701778b1580264de8",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c",
          "test/without_rowid7.test||test/without_rowid7.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fe014288ac03cdf0dc5410b7d45cad4768759b52746c0a22bce2fc03779c5d5a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1831:   Index *pIdx;",
          "1832:   Index *pPk;",
          "1833:   int nPk;",
          "1834:   int i, j;",
          "1835:   sqlite3 *db = pParse->db;",
          "1836:   Vdbe *v = pParse->pVdbe;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1834:   int nExtra;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1873:                        SQLITE_IDXTYPE_PRIMARYKEY);",
          "1874:     if( db->mallocFailed || pParse->nErr ) return;",
          "1875:     pPk = sqlite3PrimaryKeyIndex(pTab);",
          "1876:   }else{",
          "1877:     pPk = sqlite3PrimaryKeyIndex(pTab);",
          "1878:     assert( pPk!=0 );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1877:     assert( pPk->nKeyCol==1 );",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1887:         pPk->nColumn--;",
          "1888:       }else{",
          "1889:         testcase( hasColumn(pPk->aiColumn, j, pPk->aiColumn[i]) );",
          "1890:         pPk->aiColumn[j++] = pPk->aiColumn[i];",
          "1891:       }",
          "1892:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1892:         pPk->azColl[j] = pPk->azColl[i];",
          "1893:         pPk->aSortOrder[j] = pPk->aSortOrder[i];",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1895:   assert( pPk!=0 );",
          "1896:   pPk->isCovering = 1;",
          "1897:   if( !db->init.imposterTable ) pPk->uniqNotNull = 1;",
          "",
          "[Removed Lines]",
          "1898:   nPk = pPk->nKeyCol;",
          "",
          "[Added Lines]",
          "1902:   nPk = pPk->nColumn = pPk->nKeyCol;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1957:     }",
          "1962:   }",
          "1963:   recomputeColumnsNotIndexed(pPk);",
          "1964: }",
          "",
          "[Removed Lines]",
          "1948:   if( nPk<pTab->nCol ){",
          "1949:     if( resizeIndexObject(db, pPk, pTab->nCol) ) return;",
          "1950:     for(i=0, j=nPk; i<pTab->nCol; i++){",
          "1951:       if( !hasColumn(pPk->aiColumn, j, i) ){",
          "1952:         assert( j<pPk->nColumn );",
          "1953:         pPk->aiColumn[j] = i;",
          "1954:         pPk->azColl[j] = sqlite3StrBINARY;",
          "1955:         j++;",
          "1956:       }",
          "1958:     assert( pPk->nColumn==j );",
          "1959:     assert( pTab->nCol==j );",
          "1960:   }else{",
          "1961:     pPk->nColumn = pTab->nCol;",
          "",
          "[Added Lines]",
          "1952:   nExtra = 0;",
          "1953:   for(i=0; i<pTab->nCol; i++){",
          "1954:     if( !hasColumn(pPk->aiColumn, nPk, i) ) nExtra++;",
          "1955:   }",
          "1956:   if( resizeIndexObject(db, pPk, nPk+nExtra) ) return;",
          "1957:   for(i=0, j=nPk; i<pTab->nCol; i++){",
          "1958:     if( !hasColumn(pPk->aiColumn, j, i) ){",
          "1959:       assert( j<pPk->nColumn );",
          "1960:       pPk->aiColumn[j] = i;",
          "1961:       pPk->azColl[j] = sqlite3StrBINARY;",
          "1962:       j++;",
          "1965:   assert( pPk->nColumn==j );",
          "1966:   assert( pTab->nCol<=j );",
          "",
          "---------------"
        ],
        "test/without_rowid7.test||test/without_rowid7.test": [
          "File: test/without_rowid7.test -> test/without_rowid7.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # 2019 July 17",
          "2: #",
          "3: # The author disclaims copyright to this source code.  In place of",
          "4: # a legal notice, here is a blessing:",
          "5: #",
          "6: #    May you do good and not evil.",
          "7: #    May you find forgiveness for yourself and forgive others.",
          "8: #    May you share freely, never taking more than you give.",
          "9: #",
          "10: #*************************************************************************",
          "11: # This file implements regression tests for SQLite library.",
          "12: #",
          "14: set testdir [file dirname $argv0]",
          "15: source $testdir/tester.tcl",
          "16: set testprefix without_rowid7",
          "18: do_execsql_test 1.0 {",
          "19:   CREATE TABLE t1(a, b COLLATE nocase, PRIMARY KEY(a, a, b)) WITHOUT ROWID;",
          "20: }",
          "22: do_catchsql_test 1.1 {",
          "23:   INSERT INTO t1 VALUES(1, 'one'), (1, 'ONE');",
          "24: } {1 {UNIQUE constraint failed: t1.a, t1.b}}",
          "27: do_execsql_test 2.0 {",
          "28:   CREATE TABLE t2(a, b, PRIMARY KEY(a, a COLLATE nocase, a)) WITHOUT ROWID;",
          "29: }",
          "31: do_execsql_test 2.1 {",
          "32:   INSERT INTO t2 VALUES(1, 'one');",
          "33:   SELECT b FROM t2;",
          "34: } {one}",
          "37: finish_test",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f3e90dd276208493dd89ef477367a0fe23615091",
      "candidate_info": {
        "commit_hash": "f3e90dd276208493dd89ef477367a0fe23615091",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/f3e90dd276208493dd89ef477367a0fe23615091",
        "files": [
          "ext/fts5/fts5_index.c",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Fix a compiler warning in FTS5.\n\nFossilOrigin-Name: d5acf3af65f9608d4096b9b78289d84b21cd1ea463457f858ffeb20d5bd5d123",
        "before_after_code_files": [
          "ext/fts5/fts5_index.c||ext/fts5/fts5_index.c",
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts5/fts5_index.c||ext/fts5/fts5_index.c": [
          "File: ext/fts5/fts5_index.c -> ext/fts5/fts5_index.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2474:     if( pList ){",
          "2475:       pLeaf = fts5IdxMalloc(p, sizeof(Fts5Data));",
          "2476:       if( pLeaf ){",
          "2478:       }",
          "2479:     }",
          "2480:   }else{",
          "",
          "[Removed Lines]",
          "2477:         pLeaf->p = pList;",
          "",
          "[Added Lines]",
          "2477:         pLeaf->p = (u8*)pList;",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: a420ebd08f5a96b9e61a37cb42e1b3f346c23505630d9c33fe30ce7882959b36",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c49d43a787ae451df9e5483f6cef5f41aa95ed84",
      "candidate_info": {
        "commit_hash": "c49d43a787ae451df9e5483f6cef5f41aa95ed84",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c49d43a787ae451df9e5483f6cef5f41aa95ed84",
        "files": [
          "ext/fts3/fts3_write.c",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Fix the fts3DecodeIntArray() function so that it will not read off the end of the buffer it is handed.  Any unread integers are set to zero.\n\nFossilOrigin-Name: 666cf8f6b39ae1f72e82b45e9cacba23caf61370ca0c695b3b14452accbb1a0d",
        "before_after_code_files": [
          "ext/fts3/fts3_write.c||ext/fts3/fts3_write.c",
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts3/fts3_write.c||ext/fts3/fts3_write.c": [
          "File: ext/fts3/fts3_write.c -> ext/fts3/fts3_write.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3329: ){",
          "3337:   }",
          "3338: }",
          "",
          "[Removed Lines]",
          "3330:   int i, j;",
          "3331:   UNUSED_PARAMETER(nBuf);",
          "3332:   for(i=j=0; i<N; i++){",
          "3333:     sqlite3_int64 x;",
          "3334:     j += sqlite3Fts3GetVarint(&zBuf[j], &x);",
          "3335:     assert(j<=nBuf);",
          "3336:     a[i] = (u32)(x & 0xffffffff);",
          "",
          "[Added Lines]",
          "3330:   int i = 0;",
          "3331:   if( nBuf && (zBuf[nBuf-1]&0x80)==0 ){",
          "3332:     int j;",
          "3333:     for(i=j=0; i<N && j<nBuf; i++){",
          "3334:       sqlite3_int64 x;",
          "3335:       j += sqlite3Fts3GetVarint(&zBuf[j], &x);",
          "3336:       a[i] = (u32)(x & 0xffffffff);",
          "3337:     }",
          "3339:   while( i<N ) a[i++] = 0;",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 931278b257b12ac14fc8fbc82c6dc88ce4ac4b8e0d668543e68f0289d825daa1",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5978a7a525c58e1402b87ba957d287f650e0f9ab",
      "candidate_info": {
        "commit_hash": "5978a7a525c58e1402b87ba957d287f650e0f9ab",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/5978a7a525c58e1402b87ba957d287f650e0f9ab",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c",
          "src/insert.c",
          "src/select.c",
          "src/sqliteInt.h",
          "src/window.c",
          "test/view.test",
          "test/window9.test"
        ],
        "message": "Ensure that columns of views and sub-queries that are expressions with no affinity are not assigned BLOB affinity. This matches the documentation. Fix for [61c853857f40da49].\n\nFossilOrigin-Name: e15a0977ddfad3d0f4c7654c5665ff10830c25b20ecf6ef500b1ba23fb89e31f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c",
          "src/insert.c||src/insert.c",
          "src/select.c||src/select.c",
          "src/sqliteInt.h||src/sqliteInt.h",
          "src/window.c||src/window.c",
          "test/view.test||test/view.test",
          "test/window9.test||test/window9.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/window.c||src/window.c"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: a29f2a7d07beff64e489e8f824babc6228c4a499fadc0ee701caa60a63baadcd",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2160:       addrTop = sqlite3VdbeCurrentAddr(v) + 1;",
          "2161:       sqlite3VdbeAddOp3(v, OP_InitCoroutine, regYield, 0, addrTop);",
          "2162:       if( pParse->nErr ) return;",
          "2164:       if( pSelTab==0 ) return;",
          "2165:       assert( p->aCol==0 );",
          "2166:       p->nCol = pSelTab->nCol;",
          "",
          "[Removed Lines]",
          "2163:       pSelTab = sqlite3ResultSetOfSelect(pParse, pSelect);",
          "",
          "[Added Lines]",
          "2163:       pSelTab = sqlite3ResultSetOfSelect(pParse, pSelect, SQLITE_AFF_BLOB);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2424: #ifndef SQLITE_OMIT_AUTHORIZATION",
          "2425:     xAuth = db->xAuth;",
          "2426:     db->xAuth = 0;",
          "2428:     db->xAuth = xAuth;",
          "2429: #else",
          "2431: #endif",
          "2432:     pParse->nTab = n;",
          "2433:     if( pTable->pCheck ){",
          "",
          "[Removed Lines]",
          "2427:     pSelTab = sqlite3ResultSetOfSelect(pParse, pSel);",
          "2430:     pSelTab = sqlite3ResultSetOfSelect(pParse, pSel);",
          "",
          "[Added Lines]",
          "2427:     pSelTab = sqlite3ResultSetOfSelect(pParse, pSel, 0);",
          "2430:     pSelTab = sqlite3ResultSetOfSelect(pParse, pSel, 0);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2443:        && pParse->nErr==0",
          "2444:        && pTable->nCol==pSel->pEList->nExpr",
          "2445:       ){",
          "2447:       }",
          "2448:     }else if( pSelTab ){",
          "",
          "[Removed Lines]",
          "2446:         sqlite3SelectAddColumnTypeAndCollation(pParse, pTable, pSel);",
          "",
          "[Added Lines]",
          "2446:         sqlite3SelectAddColumnTypeAndCollation(pParse, pTable, pSel, 0);",
          "",
          "---------------"
        ],
        "src/insert.c||src/insert.c": [
          "File: src/insert.c -> src/insert.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:     }",
          "89:     for(n=0; n<pIdx->nColumn; n++){",
          "90:       i16 x = pIdx->aiColumn[n];",
          "91:       if( x>=0 ){",
          "93:       }else if( x==XN_ROWID ){",
          "95:       }else{",
          "97:         assert( x==XN_EXPR );",
          "98:         assert( pIdx->aColExpr!=0 );",
          "99:         aff = sqlite3ExprAffinity(pIdx->aColExpr->a[n].pExpr);",
          "102:       }",
          "103:     }",
          "104:     pIdx->zColAff[n] = 0;",
          "105:   }",
          "",
          "[Removed Lines]",
          "92:         pIdx->zColAff[n] = pTab->aCol[x].affinity;",
          "94:         pIdx->zColAff[n] = SQLITE_AFF_INTEGER;",
          "96:         char aff;",
          "100:         if( aff==0 ) aff = SQLITE_AFF_BLOB;",
          "101:         pIdx->zColAff[n] = aff;",
          "",
          "[Added Lines]",
          "91:       char aff;",
          "93:         aff = pTab->aCol[x].affinity;",
          "95:         aff = SQLITE_AFF_INTEGER;",
          "101:       if( aff==0 ) aff = SQLITE_AFF_BLOB;",
          "102:       pIdx->zColAff[n] = aff;",
          "",
          "---------------"
        ],
        "src/select.c||src/select.c": [
          "File: src/select.c -> src/select.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2068:         pCol->colFlags |= COLFLAG_HASTYPE;",
          "2069:       }",
          "2070:     }",
          "2072:     pColl = sqlite3ExprCollSeq(pParse, p);",
          "2073:     if( pColl && pCol->zColl==0 ){",
          "2074:       pCol->zColl = sqlite3DbStrDup(db, pColl->zName);",
          "",
          "[Removed Lines]",
          "2071:     if( pCol->affinity==0 ) pCol->affinity = SQLITE_AFF_BLOB;",
          "",
          "[Added Lines]",
          "2072:     if( pCol->affinity==0 ) pCol->affinity = aff;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2085:   Table *pTab;",
          "2086:   sqlite3 *db = pParse->db;",
          "2087:   u64 savedFlags;",
          "",
          "[Removed Lines]",
          "2084: Table *sqlite3ResultSetOfSelect(Parse *pParse, Select *pSelect){",
          "",
          "[Added Lines]",
          "2085: Table *sqlite3ResultSetOfSelect(Parse *pParse, Select *pSelect, char aff){",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2101:   pTab->zName = 0;",
          "2102:   pTab->nRowLogEst = 200; assert( 200==sqlite3LogEst(1048576) );",
          "2103:   sqlite3ColumnsFromExprList(pParse, pSelect->pEList, &pTab->nCol, &pTab->aCol);",
          "2105:   pTab->iPKey = -1;",
          "2106:   if( db->mallocFailed ){",
          "2107:     sqlite3DeleteTable(db, pTab);",
          "",
          "[Removed Lines]",
          "2104:   sqlite3SelectAddColumnTypeAndCollation(pParse, pTab, pSelect);",
          "",
          "[Added Lines]",
          "2105:   sqlite3SelectAddColumnTypeAndCollation(pParse, pTab, pSelect, aff);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "5195:       Select *pSel = pFrom->pSelect;",
          "5196:       if( pSel ){",
          "5197:         while( pSel->pPrior ) pSel = pSel->pPrior;",
          "5199:       }",
          "5200:     }",
          "5201:   }",
          "",
          "[Removed Lines]",
          "5198:         sqlite3SelectAddColumnTypeAndCollation(pParse, pTab, pSel);",
          "",
          "[Added Lines]",
          "5199:         sqlite3SelectAddColumnTypeAndCollation(pParse, pTab, pSel, 0);",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "3911: void sqlite3CommitInternalChanges(sqlite3*);",
          "3912: void sqlite3DeleteColumnNames(sqlite3*,Table*);",
          "3913: int sqlite3ColumnsFromExprList(Parse*,ExprList*,i16*,Column**);",
          "3916: void sqlite3OpenMasterTable(Parse *, int);",
          "3917: Index *sqlite3PrimaryKeyIndex(Table*);",
          "3918: i16 sqlite3ColumnOfIndex(Index*, i16);",
          "",
          "[Removed Lines]",
          "3914: void sqlite3SelectAddColumnTypeAndCollation(Parse*,Table*,Select*);",
          "3915: Table *sqlite3ResultSetOfSelect(Parse*,Select*);",
          "",
          "[Added Lines]",
          "3914: void sqlite3SelectAddColumnTypeAndCollation(Parse*,Table*,Select*,char);",
          "3915: Table *sqlite3ResultSetOfSelect(Parse*,Select*,char);",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "994:       p->pSrc->a[0].pSelect = pSub;",
          "995:       sqlite3SrcListAssignCursors(pParse, p->pSrc);",
          "996:       pSub->selFlags |= SF_Expanded;",
          "998:       if( pTab2==0 ){",
          "999:         rc = SQLITE_NOMEM;",
          "1000:       }else{",
          "",
          "[Removed Lines]",
          "997:       pTab2 = sqlite3ResultSetOfSelect(pParse, pSub);",
          "",
          "[Added Lines]",
          "997:       pTab2 = sqlite3ResultSetOfSelect(pParse, pSub, 0);",
          "",
          "---------------"
        ],
        "test/view.test||test/view.test": [
          "File: test/view.test -> test/view.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "724:   1 1 3 3",
          "725: }",
          "727: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "727: #-------------------------------------------------------------------------",
          "728: reset_db",
          "729: do_execsql_test view-27.0 {",
          "730:   CREATE TABLE t0(c0 TEXT, c1);",
          "731:   INSERT INTO t0(c0, c1) VALUES (-1, 0);",
          "732:   CREATE VIEW v0(c0, c1) AS SELECT t0.c0, AVG(t0.c1) FROM t0;",
          "733: }",
          "735: do_execsql_test view-27.1 {",
          "736:   SELECT c0, typeof(c0), affinity(c0), c1, typeof(c1), affinity(c1) FROM v0;",
          "737: } {",
          "738:   -1   text text",
          "739:    0.0 real none",
          "740: }",
          "742: do_execsql_test view-27.2 { SELECT c0<c1 FROM v0 } 1",
          "743: do_execsql_test view-27.3 { SELECT c1<c0 FROM v0 } 0",
          "744: do_execsql_test view-27.4 {",
          "745:   SELECT 1 FROM v0 WHERE c1<c0",
          "746: } {}",
          "747: do_execsql_test view-27.5 {",
          "748:   SELECT 1 FROM v0 WHERE c0<c1",
          "749: } {1}",
          "751: do_execsql_test view-27.6 {",
          "752:   SELECT c0<c1 FROM (SELECT t0.c0 AS c0, AVG(t0.c1) AS c1 FROM t0)",
          "753: } 1",
          "754: do_execsql_test view-27.7 {",
          "755:   SELECT c1<c0 FROM (SELECT t0.c0 AS c0, AVG(t0.c1) AS c1 FROM t0)",
          "756: } 0",
          "757: do_execsql_test view-27.8 {",
          "758:   SELECT 1 FROM (SELECT t0.c0 AS c0, AVG(t0.c1) AS c1 FROM t0) WHERE c1<c0",
          "759: } {}",
          "760: do_execsql_test view-27.9 {",
          "761:   SELECT 1 FROM (SELECT t0.c0 AS c0, AVG(t0.c1) AS c1 FROM t0) WHERE c0<c1",
          "762: } {1}",
          "",
          "---------------"
        ],
        "test/window9.test||test/window9.test": [
          "File: test/window9.test -> test/window9.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "131:       );",
          "132: } {1 {sub-select returns 3 columns - expected 1}}",
          "135: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "134: #-------------------------------------------------------------------------",
          "135: reset_db",
          "136: do_execsql_test 4.0 {",
          "137:   CREATE TABLE t1(a, b TEXT);",
          "138:   INSERT INTO t1 VALUES('A', 1), ('A', 2), ('2', 1), ('2', 2);",
          "139: }",
          "141: do_execsql_test 4.1.1 {",
          "142:   SELECT b, b=count(*), '1,2'                   FROM t1 GROUP BY b;",
          "143: } {1 0 1,2 2 1 1,2}",
          "144: do_execsql_test 4.1.2 {",
          "145:   SELECT b, b=count(*), group_concat(b) OVER () FROM t1 GROUP BY b;",
          "146: } {1 0 1,2 2 1 1,2}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "feb5dcf1a67073c8d48f05d0ee8658139ea403b0",
      "candidate_info": {
        "commit_hash": "feb5dcf1a67073c8d48f05d0ee8658139ea403b0",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/feb5dcf1a67073c8d48f05d0ee8658139ea403b0",
        "files": [
          "ext/fts3/fts3.c",
          "ext/fts3/fts3Int.h",
          "ext/fts3/fts3_snippet.c",
          "ext/fts3/fts3_write.c",
          "manifest",
          "manifest.uuid",
          "test/fts4aa.test"
        ],
        "message": "Better detection of corruption in the %_stat and %_docsize shadow tables of FTS3.\n\nFossilOrigin-Name: 1e449687881f4d388e54a0e51bcabba41ab10cf7e596ff65e31e88a23c70d497",
        "before_after_code_files": [
          "ext/fts3/fts3.c||ext/fts3/fts3.c",
          "ext/fts3/fts3Int.h||ext/fts3/fts3Int.h",
          "ext/fts3/fts3_snippet.c||ext/fts3/fts3_snippet.c",
          "ext/fts3/fts3_write.c||ext/fts3/fts3_write.c",
          "manifest.uuid||manifest.uuid",
          "test/fts4aa.test||test/fts4aa.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts3/fts3.c||ext/fts3/fts3.c": [
          "File: ext/fts3/fts3.c -> ext/fts3/fts3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "391:   return (int)(p - pStart);",
          "392: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "400: int sqlite3Fts3GetVarintBounded(",
          "401:   const char *pBuf,",
          "402:   const char *pEnd,",
          "403:   sqlite_int64 *v",
          "404: ){",
          "405:   const unsigned char *p = (const unsigned char*)pBuf;",
          "406:   const unsigned char *pStart = p;",
          "407:   const unsigned char *pX = (const unsigned char*)pEnd;",
          "408:   u64 b = 0;",
          "409:   int shift;",
          "410:   for(shift=0; shift<=63; shift+=7){",
          "411:     u64 c = p<pX ? *p : 0;",
          "412:     p++;",
          "413:     b += (c&0x7F) << shift;",
          "414:     if( (c & 0x80)==0 ) break;",
          "415:   }",
          "417:   return (int)(p - pStart);",
          "418: }",
          "",
          "---------------"
        ],
        "ext/fts3/fts3Int.h||ext/fts3/fts3Int.h": [
          "File: ext/fts3/fts3Int.h -> ext/fts3/fts3Int.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "577: void sqlite3Fts3ErrMsg(char**,const char*,...);",
          "578: int sqlite3Fts3PutVarint(char *, sqlite3_int64);",
          "579: int sqlite3Fts3GetVarint(const char *, sqlite_int64 *);",
          "580: int sqlite3Fts3GetVarint32(const char *, int *);",
          "581: int sqlite3Fts3VarintLen(sqlite3_uint64);",
          "582: void sqlite3Fts3Dequote(char *);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "580: int sqlite3Fts3GetVarintBounded(const char*,const char*,sqlite3_int64*);",
          "",
          "---------------"
        ],
        "ext/fts3/fts3_snippet.c||ext/fts3/fts3_snippet.c": [
          "File: ext/fts3/fts3_snippet.c -> ext/fts3/fts3_snippet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1038:   Fts3Table *pTab,",
          "1039:   sqlite3_stmt **ppStmt,",
          "1040:   sqlite3_int64 *pnDoc,",
          "1042: ){",
          "1043:   sqlite3_stmt *pStmt;",
          "1044:   const char *a;",
          "1045:   sqlite3_int64 nDoc;",
          "1047:   if( !*ppStmt ){",
          "1048:     int rc = sqlite3Fts3SelectDoctotal(pTab, ppStmt);",
          "",
          "[Removed Lines]",
          "1041:   const char **paLen",
          "",
          "[Added Lines]",
          "1041:   const char **paLen,",
          "1042:   const char **ppEnd",
          "1046:   const char *pEnd;",
          "1048:   int n;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1051:   pStmt = *ppStmt;",
          "1052:   assert( sqlite3_data_count(pStmt)==1 );",
          "1054:   a = sqlite3_column_blob(pStmt, 0);",
          "1059:   if( paLen ) *paLen = a;",
          "1060:   return SQLITE_OK;",
          "1061: }",
          "",
          "[Removed Lines]",
          "1055:   a += sqlite3Fts3GetVarint(a, &nDoc);",
          "1056:   if( nDoc==0 ) return FTS_CORRUPT_VTAB;",
          "",
          "[Added Lines]",
          "1058:   n = sqlite3_column_bytes(pStmt, 0);",
          "1059:   if( n==0 ){",
          "1060:     return FTS_CORRUPT_VTAB;",
          "1061:   }",
          "1063:   if( a==0 ){",
          "1064:     return SQLITE_NOMEM;",
          "1065:   }",
          "1066:   pEnd = a + n;",
          "1067:   a += sqlite3Fts3GetVarintBounded(a, pEnd, &nDoc);",
          "1068:   if( nDoc==0 || a>pEnd ){",
          "1069:     return FTS_CORRUPT_VTAB;",
          "1070:   }",
          "1074:   if( ppEnd ) *ppEnd = pEnd;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1237:       case FTS3_MATCHINFO_NDOC:",
          "1238:         if( bGlobal ){",
          "1239:           sqlite3_int64 nDoc = 0;",
          "1241:           pInfo->aMatchinfo[0] = (u32)nDoc;",
          "1242:         }",
          "1243:         break;",
          "",
          "[Removed Lines]",
          "1240:           rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &nDoc, 0);",
          "",
          "[Added Lines]",
          "1255:           rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &nDoc, 0, 0);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1246:         if( bGlobal ){",
          "1251:           if( rc==SQLITE_OK ){",
          "1252:             int iCol;",
          "1253:             for(iCol=0; iCol<pInfo->nCol; iCol++){",
          "1254:               u32 iVal;",
          "1255:               sqlite3_int64 nToken;",
          "1256:               a += sqlite3Fts3GetVarint(a, &nToken);",
          "1257:               iVal = (u32)(((u32)(nToken&0xffffffff)+nDoc/2)/nDoc);",
          "1258:               pInfo->aMatchinfo[iCol] = iVal;",
          "1259:             }",
          "",
          "[Removed Lines]",
          "1250:           rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &nDoc, &a);",
          "",
          "[Added Lines]",
          "1266:           rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &nDoc, &a, &pEnd);",
          "1273:               if( a>pEnd ){",
          "1274:                 rc = SQLITE_CORRUPT_VTAB;",
          "1275:                 break;",
          "1276:               }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1267:         if( rc==SQLITE_OK ){",
          "1268:           int iCol;",
          "1269:           const char *a = sqlite3_column_blob(pSelectDocsize, 0);",
          "1270:           for(iCol=0; iCol<pInfo->nCol; iCol++){",
          "1271:             sqlite3_int64 nToken;",
          "1273:             pInfo->aMatchinfo[iCol] = (u32)nToken;",
          "1274:           }",
          "1275:         }",
          "",
          "[Removed Lines]",
          "1272:             a += sqlite3Fts3GetVarint(a, &nToken);",
          "",
          "[Added Lines]",
          "1290:           const char *pEnd = a + sqlite3_column_bytes(pSelectDocsize, 0);",
          "1293:             a += sqlite3Fts3GetVarintBounded(a, pEnd, &nToken);",
          "1294:             if( a>pEnd ){",
          "1295:               rc = SQLITE_CORRUPT_VTAB;",
          "1296:               break;",
          "1297:             }",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1300:         if( rc!=SQLITE_OK ) break;",
          "1301:         if( bGlobal ){",
          "1302:           if( pCsr->pDeferred ){",
          "1304:             if( rc!=SQLITE_OK ) break;",
          "1305:           }",
          "1306:           rc = fts3ExprIterate(pExpr, fts3ExprGlobalHitsCb,(void*)pInfo);",
          "",
          "[Removed Lines]",
          "1303:             rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &pInfo->nDoc, 0);",
          "",
          "[Added Lines]",
          "1328:             rc = fts3MatchinfoSelectDoctotal(pTab, &pSelect, &pInfo->nDoc,0,0);",
          "",
          "---------------"
        ],
        "ext/fts3/fts3_write.c||ext/fts3/fts3_write.c": [
          "File: ext/fts3/fts3_write.c -> ext/fts3/fts3_write.c"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 8bd75bf636f72f32d66c6c38e1918f27daf2f13290f00a001f41d50838bbda47",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/fts4aa.test||test/fts4aa.test": [
          "File: test/fts4aa.test -> test/fts4aa.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "191:   } $r",
          "192: }",
          "194: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "194: # 2019-11-16 https://bugs.chromium.org/p/chromium/issues/detail?id=1025472",
          "195: #",
          "196: db close",
          "197: sqlite3 db :memory:",
          "198: do_execsql_test fts4aa-5.10 {",
          "199:   CREATE VIRTUAL TABLE t1 USING fts4(a, b, c, d, e,f,g,h,i,j,k,l,m,n,o,p,q,r);",
          "200:   INSERT INTO t1 VALUES('X Y', '2', '3', '4', '5', '6', '7', '8', '9', '0',",
          "201:                         'a','b','c','d','e','f','g','h');",
          "202:   UPDATE t1_docsize SET size=x'88' WHERE docid=1;",
          "203: } {}",
          "204: do_catchsql_test fts4aa-5.20 {",
          "205:   SELECT quote(matchinfo(t1, 'l')) FROM t1 WHERE t1 MATCH 'X Y';",
          "206: } {1 {database disk image is malformed}}",
          "207: do_execsql_test fts4aa-5.30 {",
          "208:   DROP TABLE t1;",
          "209:   CREATE VIRTUAL TABLE t1 USING fts4(a,b,c,d);",
          "210:   INSERT INTO t1 VALUES('one two','three four','five six','seven eight');",
          "211: } {}",
          "212: do_catchsql_test fts4aa-5.40 {",
          "213:   UPDATE t1_stat SET value=x'01010101' WHERE id=0;",
          "214:   SELECT quote(matchinfo(t1,'a')) FROM t1 WHERE t1 MATCH 'one two';",
          "215: } {1 {database disk image is malformed}}",
          "216: do_catchsql_test fts4aa-5.50 {",
          "217:   UPDATE t1_stat SET value=x'010101' WHERE id=0;",
          "218:   SELECT quote(matchinfo(t1,'a')) FROM t1 WHERE t1 MATCH 'one two';",
          "219: } {1 {database disk image is malformed}}",
          "220: do_catchsql_test fts4aa-5.60 {",
          "221:   UPDATE t1_stat SET value=x'01' WHERE id=0;",
          "222:   SELECT quote(matchinfo(t1,'a')) FROM t1 WHERE t1 MATCH 'one two';",
          "223: } {1 {database disk image is malformed}}",
          "224: do_catchsql_test fts4aa-5.70 {",
          "225:   UPDATE t1_stat SET value=x'' WHERE id=0;",
          "226:   SELECT quote(matchinfo(t1,'a')) FROM t1 WHERE t1 MATCH 'one two';",
          "227: } {1 {database disk image is malformed}}",
          "",
          "---------------"
        ]
      }
    }
  ]
}