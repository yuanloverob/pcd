{
  "cve_id": "CVE-2017-11310",
  "cve_desc": "The read_user_chunk_callback function in coders\\png.c in ImageMagick 7.0.6-1 Q16 2017-06-21 (beta) has memory leak vulnerabilities via crafted PNG files.",
  "repo": "ImageMagick/ImageMagick",
  "patch_hash": "8ca35831e91c3db8c6d281d09b605001003bec08",
  "patch_info": {
    "commit_hash": "8ca35831e91c3db8c6d281d09b605001003bec08",
    "repo": "ImageMagick/ImageMagick",
    "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/8ca35831e91c3db8c6d281d09b605001003bec08",
    "files": [
      "ChangeLog",
      "coders/png.c"
    ],
    "message": "coders/png.c: Stop a memory leak in read_user_chunk_callback() (reference\n\nhttps://github.com/ImageMagick/ImageMagick/issues/517).",
    "before_after_code_files": [
      "coders/png.c||coders/png.c"
    ]
  },
  "patch_diff": {
    "coders/png.c||coders/png.c": [
      "File: coders/png.c -> coders/png.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1907:         }",
      "1908:       else",
      "1909:         {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1907:         }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1919:       s=chunk->data;",
      "1920:       for (i=0; i<chunk->size; i++)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1921:       for (i=0; i<chunk->size; i++)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2290:       ThrowReaderException(ResourceLimitError,\"MemoryAllocationFailed\");",
      "2291:     }",
      "2293:   pixel_info=(MemoryInfo *) NULL;",
      "2295:   if (setjmp(png_jmpbuf(ping)))",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2296:   pixel_info=(MemoryInfo *) NULL;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d949a3258bdb9b7f363f7739761352d222c840be",
      "candidate_info": {
        "commit_hash": "d949a3258bdb9b7f363f7739761352d222c840be",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/d949a3258bdb9b7f363f7739761352d222c840be",
        "files": [
          "coders/png.c"
        ],
        "message": "Corrected checking if the profile starts with Exif\\0\\0 (https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=7499).",
        "before_after_code_files": [
          "coders/png.c||coders/png.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/png.c||coders/png.c"
          ],
          "candidate": [
            "coders/png.c||coders/png.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/png.c||coders/png.c": [
          "File: coders/png.c -> coders/png.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1946:       if (profile == (StringInfo *) NULL)",
          "1947:         {",
          "1949:             ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",",
          "1950:             image->filename);",
          "1951:           return(-1);",
          "1952:         }",
          "1953:       p=GetStringInfoDatum(profile);",
          "1955:       if (*p != 'E')",
          "1956:         {",
          "1958:              already present by accident",
          "1970:               p[4] != '\\0' || p[5] != '\\0')",
          "1971:             {",
          "1974:               return(-1);",
          "1975:             }",
          "1976:          }",
          "",
          "[Removed Lines]",
          "1948:           (void) ThrowMagickException(error_info->exception,GetMagickModule(),",
          "1966:         }",
          "1967:       else",
          "1968:         {",
          "1969:           if (p[1] != 'x' || p[2] != 'i' || p[3] != 'f' ||",
          "1973:               profile=DestroyStringInfo(profile);",
          "",
          "[Added Lines]",
          "1963:       s=chunk->data;",
          "1964:       i=0;",
          "1965:       if (chunk->size > 6)",
          "1966:         {",
          "1968:              already present by accident",
          "1973:             s+=6;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7b4412361d71f930765bc927f88fc377490ae97c",
      "candidate_info": {
        "commit_hash": "7b4412361d71f930765bc927f88fc377490ae97c",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/7b4412361d71f930765bc927f88fc377490ae97c",
        "files": [
          "ChangeLog",
          "coders/png.c"
        ],
        "message": "Added support for reading eXIf chunks to the PNG coder.",
        "before_after_code_files": [
          "coders/png.c||coders/png.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/png.c||coders/png.c"
          ],
          "candidate": [
            "coders/png.c||coders/png.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/png.c||coders/png.c": [
          "File: coders/png.c -> coders/png.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1881:   (void) SetImageProfile(image,&text[ii].key[17],profile,exception);",
          "1882:   profile=DestroyStringInfo(profile);",
          "1884:   if (image_info->verbose)",
          "1885:     (void) printf(\" Found a generic profile, type %s\\n\",&text[ii].key[17]);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1884:   if (image_info->verbose)",
          "1885:     (void) printf(\" Found a generic profile, type %s\\n\",&text[ii].key[17]);",
          "1887:   return MagickTrue;",
          "1888: }",
          "1890: #if defined(PNG_READ_eXIf_SUPPORTED)",
          "1891: static int PNGSetExifProfile(Image *image,png_size_t size,png_byte *data,",
          "1892:   ExceptionInfo *exception)",
          "1893: {",
          "1894:   StringInfo",
          "1897:   unsigned char",
          "1900:   png_byte",
          "1903:   size_t",
          "1904:     i;",
          "1906:   profile=BlobToStringInfo((const void *) NULL,size+6);",
          "1908:   if (profile == (StringInfo *) NULL)",
          "1909:     {",
          "1910:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "1911:         ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",",
          "1912:         image->filename);",
          "1913:       return(-1);",
          "1914:     }",
          "1915:   p=GetStringInfoDatum(profile);",
          "1925:   s=data;",
          "1926:   i=0;",
          "1927:   if (size > 6)",
          "1928:     {",
          "1930:           already present by accident",
          "1932:       if (s[0] == 'E' && s[1] == 'x'  && s[2] == 'i' &&",
          "1933:           s[3] == 'f' && s[4] == '\\0' && s[5] == '\\0')",
          "1934:       {",
          "1935:         s+=6;",
          "1936:         i=6;",
          "1937:         SetStringInfoLength(profile,size);",
          "1938:         p=GetStringInfoDatum(profile);",
          "1939:       }",
          "1940:     }",
          "1943:   for (; i<size; i++)",
          "1946:   (void) SetImageProfile(image,\"exif\",profile,exception);",
          "1948:   profile=DestroyStringInfo(profile);",
          "1950:   return(1);",
          "1951: }",
          "1953: static void read_eXIf_chunk(Image *image,png_struct *ping,png_info *info,",
          "1954:   ExceptionInfo *exception)",
          "1955: {",
          "1956:   png_uint_32",
          "1957:     size;",
          "1959:   png_bytep",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1915:   if (chunk->name[0]  == 101 &&",
          "1916:       (chunk->name[1] ==  88 || chunk->name[1] == 120 ) &&",
          "1917:       chunk->name[2] ==   73 &&",
          "1931:       png_byte",
          "",
          "[Removed Lines]",
          "1918:       chunk-> name[3] == 102)",
          "1919:     {",
          "1922:       PNGErrorInfo",
          "1925:       StringInfo",
          "1928:       unsigned char",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1934:       size_t",
          "1935:         i;",
          "1984:       error_info=(PNGErrorInfo *) png_get_error_ptr(ping);",
          "1985:       (void) SetImageProfile(image,\"exif\",profile,",
          "1986:         error_info->exception);",
          "",
          "[Removed Lines]",
          "1937:       (void) LogMagickEvent(CoderEvent,GetMagickModule(),",
          "1938:         \" recognized eXIf chunk\");",
          "1940:       image=(Image *) png_get_user_chunk_ptr(ping);",
          "1942:       error_info=(PNGErrorInfo *) png_get_error_ptr(ping);",
          "1944:       profile=BlobToStringInfo((const void *) NULL,chunk->size+6);",
          "1946:       if (profile == (StringInfo *) NULL)",
          "1947:         {",
          "1948:           (void) ThrowMagickException(error_info->exception,GetMagickModule(),",
          "1949:             ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",",
          "1950:             image->filename);",
          "1951:           return(-1);",
          "1952:         }",
          "1953:       p=GetStringInfoDatum(profile);",
          "1963:       s=chunk->data;",
          "1964:       i=0;",
          "1965:       if (chunk->size > 6)",
          "1966:         {",
          "1968:              already present by accident",
          "1970:           if (s[0] == 'E' && s[1] == 'x'  && s[2] == 'i' &&",
          "1971:               s[3] == 'f' && s[4] == '\\0' && s[5] == '\\0')",
          "1972:           {",
          "1973:             s+=6;",
          "1974:             i=6;",
          "1975:             SetStringInfoLength(profile,chunk->size);",
          "1976:             p=GetStringInfoDatum(profile);",
          "1977:           }",
          "1978:         }",
          "1981:       for (; i<chunk->size; i++)",
          "",
          "[Added Lines]",
          "2002:       (void) LogMagickEvent(CoderEvent,GetMagickModule(),",
          "2003:         \" recognized eXIf chunk\");",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3328:        {",
          "3329:          (void) FormatLocaleString(msg,MagickPathExtent,\"%d\",",
          "3330:             (int) number_colors);",
          "3331:          (void) SetImageProperty(image,\"png:PLTE.number_colors\",msg,",
          "3332:             exception);",
          "3333:        }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3351:          (void) SetImageProperty(image,\"png:PLTE.number_colors\",msg,",
          "3352:             exception);",
          "3353:        }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "4142:             \"x_off=%.20g, y_off=%.20g\",",
          "4143:             (double) image->page.x,(double) image->page.y);",
          "4144:          (void) SetImageProperty(image,\"png:oFFs\",msg,",
          "4145:                 exception);",
          "4146:        }",
          "4147: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4168:                 exception);",
          "4169:        }",
          "4170: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7e662c07c762dc8a0ee653f0fc5f36a10499ed0e",
      "candidate_info": {
        "commit_hash": "7e662c07c762dc8a0ee653f0fc5f36a10499ed0e",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/7e662c07c762dc8a0ee653f0fc5f36a10499ed0e",
        "files": [
          "coders/png.c"
        ],
        "message": "Fixed refactor mistake (https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=7534)",
        "before_after_code_files": [
          "coders/png.c||coders/png.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/png.c||coders/png.c"
          ],
          "candidate": [
            "coders/png.c||coders/png.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/png.c||coders/png.c": [
          "File: coders/png.c -> coders/png.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1966:         {",
          "1968:              already present by accident",
          "1970:           if (s[0] == 'E' && s[1] == 'x'  && s[2] == 'i' &&",
          "1971:               s[3] == 'f' && s[4] == '\\0' && s[5] == '\\0')",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}