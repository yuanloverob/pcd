{
  "cve_id": "CVE-2021-29608",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Due to lack of validation in `tf.raw_ops.RaggedTensorToTensor`, an attacker can exploit an undefined behavior if input arguments are empty. The implementation(https://github.com/tensorflow/tensorflow/blob/656e7673b14acd7835dc778867f84916c6d1cac2/tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc#L356-L360) only checks that one of the tensors is not empty, but does not check for the other ones. There are multiple `DCHECK` validations to prevent heap OOB, but these are no-op in release builds, hence they don't prevent anything. The fix will be included in TensorFlow 2.5.0. We will also cherrypick these commits on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "f94ef358bb3e91d517446454edff6535bcfe8e4a",
  "patch_info": {
    "commit_hash": "f94ef358bb3e91d517446454edff6535bcfe8e4a",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/f94ef358bb3e91d517446454edff6535bcfe8e4a",
    "files": [
      "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
    ],
    "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
    "before_after_code_files": [
      "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
      "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "346:   void Compute(OpKernelContext* context) override {",
      "347:     INDEX_TYPE first_dimension;",
      "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
      "349:     vector<INDEX_TYPE> output_size;",
      "350:     OP_REQUIRES_OK(context,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "348:     const Tensor first_partition_tensor =",
      "349:         context->input(kFirstPartitionInputIndex);",
      "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
      "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
      "352:                                         \"requires at least one element.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5d2b8e35452b54295971afa174d7dafec1b58135",
      "candidate_info": {
        "commit_hash": "5d2b8e35452b54295971afa174d7dafec1b58135",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5d2b8e35452b54295971afa174d7dafec1b58135",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "346:   void Compute(OpKernelContext* context) override {",
          "347:     INDEX_TYPE first_dimension;",
          "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
          "349:     vector<INDEX_TYPE> output_size;",
          "350:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:     const Tensor first_partition_tensor =",
          "349:         context->input(kFirstPartitionInputIndex);",
          "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
          "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
          "352:                                         \"requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "263e5965656518b139ad93804571a331ebaa42ed",
      "candidate_info": {
        "commit_hash": "263e5965656518b139ad93804571a331ebaa42ed",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/263e5965656518b139ad93804571a331ebaa42ed",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "346:   void Compute(OpKernelContext* context) override {",
          "347:     INDEX_TYPE first_dimension;",
          "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
          "349:     vector<INDEX_TYPE> output_size;",
          "350:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:     const Tensor first_partition_tensor =",
          "349:         context->input(kFirstPartitionInputIndex);",
          "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
          "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
          "352:                                         \"requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "238bc8cac71a807ffa36b7958c09833cddc43894",
      "candidate_info": {
        "commit_hash": "238bc8cac71a807ffa36b7958c09833cddc43894",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/238bc8cac71a807ffa36b7958c09833cddc43894",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "346:   void Compute(OpKernelContext* context) override {",
          "347:     INDEX_TYPE first_dimension;",
          "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
          "349:     vector<INDEX_TYPE> output_size;",
          "350:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:     const Tensor first_partition_tensor =",
          "349:         context->input(kFirstPartitionInputIndex);",
          "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
          "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
          "352:                                         \"requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "98823115253b14ce6bf0e327593907e6c984af98",
      "candidate_info": {
        "commit_hash": "98823115253b14ce6bf0e327593907e6c984af98",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/98823115253b14ce6bf0e327593907e6c984af98",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "346:   void Compute(OpKernelContext* context) override {",
          "347:     INDEX_TYPE first_dimension;",
          "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
          "349:     vector<INDEX_TYPE> output_size;",
          "350:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:     const Tensor first_partition_tensor =",
          "349:         context->input(kFirstPartitionInputIndex);",
          "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
          "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
          "352:                                         \"requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0026804b79e33f0a351fd3d731d765b1072f506d",
      "candidate_info": {
        "commit_hash": "0026804b79e33f0a351fd3d731d765b1072f506d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0026804b79e33f0a351fd3d731d765b1072f506d",
        "files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ],
        "message": "Fix `tf.raw_ops.RaggedTensorToTensor` failing CHECK in `tensor.cc`.\n\nPiperOrigin-RevId: 368300502\nChange-Id: I91255d23c4bfd3aa3c029aac773937c09daf3c64",
        "before_after_code_files": [
          "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc||tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc": [
          "File: tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc -> tensorflow/core/kernels/ragged_tensor_to_tensor_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "346:   void Compute(OpKernelContext* context) override {",
          "347:     INDEX_TYPE first_dimension;",
          "348:     OP_REQUIRES_OK(context, GetFirstDimensionSize(context, &first_dimension));",
          "349:     vector<INDEX_TYPE> output_size;",
          "350:     OP_REQUIRES_OK(context,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:     const Tensor first_partition_tensor =",
          "349:         context->input(kFirstPartitionInputIndex);",
          "350:     OP_REQUIRES(context, first_partition_tensor.NumElements() > 0,",
          "351:                 errors::InvalidArgument(\"Invalid first partition input. Tensor \"",
          "352:                                         \"requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}