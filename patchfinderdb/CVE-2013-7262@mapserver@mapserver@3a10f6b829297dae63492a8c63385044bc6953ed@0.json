{
  "cve_id": "CVE-2013-7262",
  "cve_desc": "SQL injection vulnerability in the msPostGISLayerSetTimeFilter function in mappostgis.c in MapServer before 6.4.1, when a WMS-Time service is used, allows remote attackers to execute arbitrary SQL commands via a crafted string in a PostGIS TIME filter.",
  "repo": "mapserver/mapserver",
  "patch_hash": "3a10f6b829297dae63492a8c63385044bc6953ed",
  "patch_info": {
    "commit_hash": "3a10f6b829297dae63492a8c63385044bc6953ed",
    "repo": "mapserver/mapserver",
    "commit_url": "https://github.com/mapserver/mapserver/commit/3a10f6b829297dae63492a8c63385044bc6953ed",
    "files": [
      "mappostgis.c"
    ],
    "message": "Fix potential SQL Injection with postgis TIME filters (#4834)",
    "before_after_code_files": [
      "mappostgis.c||mappostgis.c"
    ]
  },
  "patch_diff": {
    "mappostgis.c||mappostgis.c": [
      "File: mappostgis.c -> mappostgis.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3212:   if (!lp || !timestring || !timefield)",
      "3213:     return MS_FALSE;",
      "3216:   if (strstr(timestring, \",\") == NULL &&",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3215:   if( strchr(timestring,'\\'') || strchr(timestring, '\\\\') ) {",
      "3216:      msSetError(MS_MISCERR, \"Invalid time filter.\", \"msPostGISLayerSetTimeFilter()\");",
      "3217:      return MS_FALSE;",
      "3218:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bb574ee126c46b9b991ae22806181af1c091348e",
      "candidate_info": {
        "commit_hash": "bb574ee126c46b9b991ae22806181af1c091348e",
        "repo": "mapserver/mapserver",
        "commit_url": "https://github.com/mapserver/mapserver/commit/bb574ee126c46b9b991ae22806181af1c091348e",
        "files": [
          "mappostgis.c"
        ],
        "message": "WFS-2 specific fixes for postgis time sql injections (#4834,#4815)",
        "before_after_code_files": [
          "mappostgis.c||mappostgis.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "mappostgis.c||mappostgis.c"
          ],
          "candidate": [
            "mappostgis.c||mappostgis.c"
          ]
        }
      },
      "candidate_diff": {
        "mappostgis.c||mappostgis.c": [
          "File: mappostgis.c -> mappostgis.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3345:   int numtimes=0,i=0,numranges=0;",
          "3346:   size_t buffer_size = 512;",
          "3347:   char buffer[512], bufferTmp[512];",
          "3349:   buffer[0] = '\\0';",
          "3350:   bufferTmp[0] = '\\0';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3348:   char* escapedTimeField;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3352:   if (!lp || !timestring || !timefield)",
          "3353:     return MS_FALSE;",
          "3355:   if( strchr(timestring,'\\'') || strchr(timestring, '\\\\') ) {",
          "3358:   }",
          "3361:   if (strstr(timestring, \",\") == NULL &&",
          "3364:   } else {",
          "3367:     atimes = msStringSplit (timestring, ',', &numtimes);",
          "3369:       return MS_FALSE;",
          "3371:     strlcat(buffer, \"(\", buffer_size);",
          "3372:     for(i=0; i<numtimes; i++) {",
          "",
          "[Removed Lines]",
          "3356:      msSetError(MS_MISCERR, \"Invalid time filter.\", \"msPostGISLayerSetTimeFilter()\");",
          "3357:      return MS_FALSE;",
          "3363:     createPostgresTimeCompareSimple(timefield, timestring, buffer, buffer_size);",
          "3368:     if (atimes == NULL || numtimes < 1)",
          "",
          "[Added Lines]",
          "3358:     msSetError(MS_MISCERR, \"Invalid time filter.\", \"msPostGISLayerSetTimeFilter()\");",
          "3359:     return MS_FALSE;",
          "3361:   escapedTimeField = msLayerEscapePropertyName(lp, timefield);",
          "3366:     createPostgresTimeCompareSimple(escapedTimeField, timestring, buffer, buffer_size);",
          "3371:     if (atimes == NULL || numtimes < 1) {",
          "3372:       msFree(escapedTimeField);",
          "3374:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3375:       }",
          "3376:       strlcat(buffer, \"(\", buffer_size);",
          "3377:       aranges = msStringSplit(atimes[i],  '/', &numranges);",
          "3379:       if(numranges == 1) {",
          "3382:         strlcat(buffer, bufferTmp, buffer_size);",
          "3383:       } else if(numranges == 2) {",
          "3386:         strlcat(buffer, bufferTmp, buffer_size);",
          "3387:       } else {",
          "3388:         return MS_FALSE;",
          "3389:       }",
          "3390:       msFreeCharArray(aranges, numranges);",
          "",
          "[Removed Lines]",
          "3378:       if(!aranges) return MS_FALSE;",
          "3381:         createPostgresTimeCompareSimple(timefield, atimes[i], bufferTmp, buffer_size);",
          "3385:         createPostgresTimeCompareRange(timefield, aranges[0], aranges[1], bufferTmp, buffer_size);",
          "",
          "[Added Lines]",
          "3383:       if(!aranges) {",
          "3384:         msFree(escapedTimeField);",
          "3385:         msFreeCharArray(atimes, numtimes);",
          "3386:         return MS_FALSE;",
          "3387:       }",
          "3390:         createPostgresTimeCompareSimple(escapedTimeField, atimes[i], bufferTmp, buffer_size);",
          "3394:         createPostgresTimeCompareRange(escapedTimeField, aranges[0], aranges[1], bufferTmp, buffer_size);",
          "3397:         msFree(escapedTimeField);",
          "3398:         msFreeCharArray(aranges, numranges);",
          "3399:         msFreeCharArray(atimes, numtimes);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3393:     strlcat(buffer, \")\", buffer_size);",
          "3394:     msFreeCharArray(atimes, numtimes);",
          "3395:   }",
          "3396:   if(!*buffer) {",
          "3397:     return MS_FALSE;",
          "3398:   }",
          "3399:   if(lp->filteritem) free(lp->filteritem);",
          "3400:   lp->filteritem = msStrdup(timefield);",
          "3411:   }",
          "",
          "[Removed Lines]",
          "3401:   if (&lp->filter) {",
          "3404:     if (lp->filter.type == MS_EXPRESSION) {",
          "3405:       snprintf(bufferTmp, buffer_size, \"(%s) and %s\", lp->filter.string, buffer);",
          "3406:       loadExpressionString(&lp->filter, bufferTmp);",
          "3407:     } else {",
          "3408:       freeExpression(&lp->filter);",
          "3409:       loadExpressionString(&lp->filter, buffer);",
          "3410:     }",
          "",
          "[Added Lines]",
          "3409:   msFree(escapedTimeField);",
          "3420:   if (lp->filter.type == MS_EXPRESSION) {",
          "3421:     snprintf(bufferTmp, buffer_size, \"(%s) and %s\", lp->filter.string, buffer);",
          "3422:     loadExpressionString(&lp->filter, bufferTmp);",
          "3423:   } else {",
          "3424:     freeExpression(&lp->filter);",
          "3425:     loadExpressionString(&lp->filter, buffer);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "610c724c937f7a459da750eb82e81780a2c5b73f",
      "candidate_info": {
        "commit_hash": "610c724c937f7a459da750eb82e81780a2c5b73f",
        "repo": "mapserver/mapserver",
        "commit_url": "https://github.com/mapserver/mapserver/commit/610c724c937f7a459da750eb82e81780a2c5b73f",
        "files": [
          "mappostgis.c"
        ],
        "message": "Fix potential SQL Injection with postgis TIME filters (#4834)",
        "before_after_code_files": [
          "mappostgis.c||mappostgis.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "mappostgis.c||mappostgis.c"
          ],
          "candidate": [
            "mappostgis.c||mappostgis.c"
          ]
        }
      },
      "candidate_diff": {
        "mappostgis.c||mappostgis.c": [
          "File: mappostgis.c -> mappostgis.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2162:     if (!lp || !timestring || !timefield)",
          "2163:       return MS_FALSE;",
          "2165:     if (strstr(timestring, \",\") == NULL &&",
          "2167:       tmpstimestring = strdup(timestring);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2165:     if( strchr(timestring,'\\'') || strchr(timestring, '\\\\') ) {",
          "2166:        msSetError(MS_MISCERR, \"Invalid time filter.\", \"msPostGISLayerSetTimeFilter()\");",
          "2167:        return MS_FALSE;",
          "2168:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f0ee57b12d482e0ff5611d05afd32408949f7f9",
      "candidate_info": {
        "commit_hash": "3f0ee57b12d482e0ff5611d05afd32408949f7f9",
        "repo": "mapserver/mapserver",
        "commit_url": "https://github.com/mapserver/mapserver/commit/3f0ee57b12d482e0ff5611d05afd32408949f7f9",
        "files": [
          "mappostgis.c"
        ],
        "message": "Fix potential SQL Injection with postgis TIME filters (#4834)",
        "before_after_code_files": [
          "mappostgis.c||mappostgis.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "mappostgis.c||mappostgis.c"
          ],
          "candidate": [
            "mappostgis.c||mappostgis.c"
          ]
        }
      },
      "candidate_diff": {
        "mappostgis.c||mappostgis.c": [
          "File: mappostgis.c -> mappostgis.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2970:     if (!lp || !timestring || !timefield)",
          "2971:       return MS_FALSE;",
          "2973:     if (strstr(timestring, \",\") == NULL &&",
          "2975:       tmpstimestring = msStrdup(timestring);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2973:     if( strchr(timestring,'\\'') || strchr(timestring, '\\\\') ) {",
          "2974:        msSetError(MS_MISCERR, \"Invalid time filter.\", \"msPostGISLayerSetTimeFilter()\");",
          "2975:        return MS_FALSE;",
          "2976:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}