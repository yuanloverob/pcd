{
  "cve_id": "CVE-2019-15922",
  "cve_desc": "An issue was discovered in the Linux kernel before 5.0.9. There is a NULL pointer dereference for a pf data structure if alloc_disk fails in drivers/block/paride/pf.c.",
  "repo": "torvalds/linux",
  "patch_hash": "58ccd2d31e502c37e108b285bf3d343eb00c235b",
  "patch_info": {
    "commit_hash": "58ccd2d31e502c37e108b285bf3d343eb00c235b",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/58ccd2d31e502c37e108b285bf3d343eb00c235b",
    "files": [
      "drivers/block/paride/pf.c"
    ],
    "message": "paride/pf: Fix potential NULL pointer dereference\n\nSyzkaller report this:\n\npf: pf version 1.04, major 47, cluster 64, nice 0\npf: No ATAPI disk detected\nkasan: CONFIG_KASAN_INLINE enabled\nkasan: GPF could be caused by NULL-ptr deref or user memory access\ngeneral protection fault: 0000 [#1] SMP KASAN PTI\nCPU: 0 PID: 9887 Comm: syz-executor.0 Tainted: G         C        5.1.0-rc3+ #8\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014\nRIP: 0010:pf_init+0x7af/0x1000 [pf]\nCode: 46 77 d2 48 89 d8 48 c1 e8 03 80 3c 28 00 74 08 48 89 df e8 03 25 a6 d2 4c 8b 23 49 8d bc 24 80 05 00 00 48 89 f8 48 c1 e8 03 <80> 3c 28 00 74 05 e8 e6 24 a6 d2 49 8b bc 24 80 05 00 00 e8 79 34\nRSP: 0018:ffff8881abcbf998 EFLAGS: 00010202\nRAX: 00000000000000b0 RBX: ffffffffc1e4a8a8 RCX: ffffffffaec50788\nRDX: 0000000000039b10 RSI: ffffc9000153c000 RDI: 0000000000000580\nRBP: dffffc0000000000 R08: ffffed103ee44e59 R09: ffffed103ee44e59\nR10: 0000000000000001 R11: ffffed103ee44e58 R12: 0000000000000000\nR13: ffffffffc1e4b028 R14: 0000000000000000 R15: 0000000000000020\nFS:  00007f1b78a91700(0000) GS:ffff8881f7200000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007f6d72b207f8 CR3: 00000001d5790004 CR4: 00000000007606f0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\nDR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nPKRU: 55555554\nCall Trace:\n ? 0xffffffffc1e50000\n do_one_initcall+0xbc/0x47d init/main.c:901\n do_init_module+0x1b5/0x547 kernel/module.c:3456\n load_module+0x6405/0x8c10 kernel/module.c:3804\n __do_sys_finit_module+0x162/0x190 kernel/module.c:3898\n do_syscall_64+0x9f/0x450 arch/x86/entry/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49/0xbe\nRIP: 0033:0x462e99\nCode: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48\nRSP: 002b:00007f1b78a90c58 EFLAGS: 00000246 ORIG_RAX: 0000000000000139\nRAX: ffffffffffffffda RBX: 000000000073bf00 RCX: 0000000000462e99\nRDX: 0000000000000000 RSI: 0000000020000180 RDI: 0000000000000003\nRBP: 00007f1b78a90c70 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246 R12: 00007f1b78a916bc\nR13: 00000000004bcefa R14: 00000000006f6fb0 R15: 0000000000000004\nModules linked in: pf(+) paride gpio_tps65218 tps65218 i2c_cht_wc ati_remote dc395x act_meta_skbtcindex act_ife ife ecdh_generic rc_xbox_dvd sky81452_regulator v4l2_fwnode leds_blinkm snd_usb_hiface comedi(C) aes_ti slhc cfi_cmdset_0020 mtd cfi_util sx8654 mdio_gpio of_mdio fixed_phy mdio_bitbang libphy alcor_pci matrix_keymap hid_uclogic usbhid scsi_transport_fc videobuf2_v4l2 videobuf2_dma_sg snd_soc_pcm179x_spi snd_soc_pcm179x_codec i2c_demux_pinctrl mdev snd_indigodj isl6405 mii enc28j60 cmac adt7316_i2c(C) adt7316(C) fmc_trivial fmc nf_reject_ipv4 authenc rc_dtt200u rtc_ds1672 dvb_usb_dibusb_mc dvb_usb_dibusb_mc_common dib3000mc dibx000_common dvb_usb_dibusb_common dvb_usb dvb_core videobuf2_common videobuf2_vmalloc videobuf2_memops regulator_haptic adf7242 mac802154 ieee802154 s5h1409 da9034_ts snd_intel8x0m wmi cx24120 usbcore sdhci_cadence sdhci_pltfm sdhci mmc_core joydev i2c_algo_bit scsi_transport_iscsi iscsi_boot_sysfs ves1820 lockd grace nfs_acl auth_rpcgss sunrp\n c\n ip_vs snd_soc_adau7002 snd_cs4281 snd_rawmidi gameport snd_opl3_lib snd_seq_device snd_hwdep snd_ac97_codec ad7418 hid_primax hid snd_soc_cs4265 snd_soc_core snd_pcm_dmaengine snd_pcm snd_timer ac97_bus snd_compress snd soundcore ti_adc108s102 eeprom_93cx6 i2c_algo_pca mlxreg_hotplug st_pressure st_sensors industrialio_triggered_buffer kfifo_buf industrialio v4l2_common videodev media snd_soc_adau_utils rc_pinnacle_grey rc_core pps_gpio leds_lm3692x nandcore ledtrig_pattern iptable_security iptable_raw iptable_mangle iptable_nat nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 iptable_filter bpfilter ip6_vti ip_vti ip_gre ipip sit tunnel4 ip_tunnel hsr veth netdevsim vxcan batman_adv cfg80211 rfkill chnl_net caif nlmon dummy team bonding vcan bridge stp llc ip6_gre gre ip6_tunnel tunnel6 tun mousedev ppdev tpm kvm_intel kvm irqbypass crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel ide_pci_generic aes_x86_64 piix crypto_simd input_leds psmouse cryp\n td\n glue_helper ide_core intel_agp serio_raw intel_gtt agpgart ata_generic i2c_piix4 pata_acpi parport_pc parport rtc_cmos floppy sch_fq_codel ip_tables x_tables sha1_ssse3 sha1_generic ipv6 [last unloaded: paride]\nDumping ftrace buffer:\n  (ftrace buffer empty)\n---[ end trace 7a818cf5f210d79e ]---\n\nIf alloc_disk fails in pf_init_units, pf->disk will be\nNULL, however in pf_detect and pf_exit, it's not check\nthis before free.It may result a NULL pointer dereference.\n\nAlso when register_blkdev failed, blk_cleanup_queue() and\nblk_mq_free_tag_set() should be called to free resources.\n\nReported-by: Hulk Robot <hulkci@huawei.com>\nFixes: 6ce59025f118 (\"paride/pf: cleanup queues when detection fails\")\nSigned-off-by: YueHaibing <yuehaibing@huawei.com>\n\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
    "before_after_code_files": [
      "drivers/block/paride/pf.c||drivers/block/paride/pf.c"
    ]
  },
  "patch_diff": {
    "drivers/block/paride/pf.c||drivers/block/paride/pf.c": [
      "File: drivers/block/paride/pf.c -> drivers/block/paride/pf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "763:  printk(\"%s: No ATAPI disk detected\\n\", name);",
      "764:  for (pf = units, unit = 0; unit < PF_UNITS; pf++, unit++) {",
      "765:   blk_cleanup_queue(pf->disk->queue);",
      "766:   pf->disk->queue = NULL;",
      "767:   blk_mq_free_tag_set(&pf->tag_set);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "765:   if (!pf->disk)",
      "766:    continue;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1029:  pf_busy = 0;",
      "1031:  if (register_blkdev(major, name)) {",
      "1033:    put_disk(pf->disk);",
      "1034:   return -EBUSY;",
      "1035:  }",
      "",
      "[Removed Lines]",
      "1032:   for (pf = units, unit = 0; unit < PF_UNITS; pf++, unit++)",
      "",
      "[Added Lines]",
      "1034:   for (pf = units, unit = 0; unit < PF_UNITS; pf++, unit++) {",
      "1035:    if (!pf->disk)",
      "1036:     continue;",
      "1037:    blk_cleanup_queue(pf->disk->queue);",
      "1038:    blk_mq_free_tag_set(&pf->tag_set);",
      "1040:   }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1051:  int unit;",
      "1052:  unregister_blkdev(major, name);",
      "1053:  for (pf = units, unit = 0; unit < PF_UNITS; pf++, unit++) {",
      "1054:   if (pf->present)",
      "1055:    del_gendisk(pf->disk);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1061:   if (!pf->disk)",
      "1062:    continue;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5cdb0ef6144f47440850553579aa923c20a63f23",
      "candidate_info": {
        "commit_hash": "5cdb0ef6144f47440850553579aa923c20a63f23",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/5cdb0ef6144f47440850553579aa923c20a63f23",
        "files": [
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h"
        ],
        "message": "brcmfmac: fix NULL pointer derefence during USB disconnect\n\nIn case USB disconnect happens at the moment transmitting workqueue is in\nprogress the underlying interface may be gone causing a NULL pointer\ndereference. Add synchronization of the workqueue destruction with the\ndetach implementation in core so that the transmitting workqueue is stopped\nduring detach before the interfaces are removed.\n\nFix following Oops:\n\nUnable to handle kernel NULL pointer dereference at virtual address 00000008\npgd = 9e6a802d\n[00000008] *pgd=00000000\nInternal error: Oops: 5 [#1] PREEMPT SMP ARM\nModules linked in: nf_log_ipv4 nf_log_common xt_LOG xt_limit iptable_mangle\nxt_connmark xt_tcpudp xt_conntrack nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4\niptable_filter ip_tables x_tables usb_f_mass_storage usb_f_rndis u_ether\nusb_serial_simple usbserial cdc_acm brcmfmac brcmutil smsc95xx usbnet\nci_hdrc_imx ci_hdrc ulpi usbmisc_imx 8250_exar 8250_pci 8250 8250_base\nlibcomposite configfs udc_core\nCPU: 0 PID: 7 Comm: kworker/u8:0 Not tainted 4.19.23-00076-g03740aa-dirty #102\nHardware name: Freescale i.MX6 Quad/DualLite (Device Tree)\nWorkqueue: brcmf_fws_wq brcmf_fws_dequeue_worker [brcmfmac]\nPC is at brcmf_txfinalize+0x34/0x90 [brcmfmac]\nLR is at brcmf_fws_dequeue_worker+0x218/0x33c [brcmfmac]\npc : [<7f0dee64>]    lr : [<7f0e4140>]    psr: 60010093\nsp : ee8abef0  ip : 00000000  fp : edf38000\nr10: ffffffed  r9 : edf38970  r8 : edf38004\nr7 : edf3e970  r6 : 00000000  r5 : ede69000  r4 : 00000000\nr3 : 00000a97  r2 : 00000000  r1 : 0000888e  r0 : ede69000\nFlags: nZCv  IRQs off  FIQs on  Mode SVC_32  ISA ARM  Segment none\nControl: 10c5387d  Table: 7d03c04a  DAC: 00000051\nProcess kworker/u8:0 (pid: 7, stack limit = 0x24ec3e04)\nStack: (0xee8abef0 to 0xee8ac000)\nbee0:                                     ede69000 00000000 ed56c3e0 7f0e4140\nbf00: 00000001 00000000 edf38004 edf3e99c ed56c3e0 80d03d00 edfea43a edf3e970\nbf20: ee809880 ee804200 ee971100 00000000 edf3e974 00000000 ee804200 80135a70\nbf40: 80d03d00 ee804218 ee809880 ee809894 ee804200 80d03d00 ee804218 ee8aa000\nbf60: 00000088 80135d5c 00000000 ee829f00 ee829dc0 00000000 ee809880 80135d30\nbf80: ee829f1c ee873eac 00000000 8013b1a0 ee829dc0 8013b07c 00000000 00000000\nbfa0: 00000000 00000000 00000000 801010e8 00000000 00000000 00000000 00000000\nbfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\nbfe0: 00000000 00000000 00000000 00000000 00000013 00000000 00000000 00000000\n[<7f0dee64>] (brcmf_txfinalize [brcmfmac]) from [<7f0e4140>] (brcmf_fws_dequeue_worker+0x218/0x33c [brcmfmac])\n[<7f0e4140>] (brcmf_fws_dequeue_worker [brcmfmac]) from [<80135a70>] (process_one_work+0x138/0x3f8)\n[<80135a70>] (process_one_work) from [<80135d5c>] (worker_thread+0x2c/0x554)\n[<80135d5c>] (worker_thread) from [<8013b1a0>] (kthread+0x124/0x154)\n[<8013b1a0>] (kthread) from [<801010e8>] (ret_from_fork+0x14/0x2c)\nException stack(0xee8abfb0 to 0xee8abff8)\nbfa0:                                     00000000 00000000 00000000 00000000\nbfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\nbfe0: 00000000 00000000 00000000 00000000 00000013 00000000\nCode: e1530001 0a000007 e3560000 e1a00005 (05942008)\n---[ end trace 079239dd31c86e90 ]---\n\nSigned-off-by: Piotr Figiel <p.figiel@camlintechnologies.com>\nSigned-off-by: Kalle Valo <kvalo@codeaurora.org>",
        "before_after_code_files": [
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c",
          "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "490:  return -ENOMEM;",
          "491: }",
          "494: {",
          "495:  struct brcmf_bcdc *bcdc = drvr->proto->pd;",
          "497:  drvr->proto->pd = NULL;",
          "499:  kfree(bcdc);",
          "500: }",
          "",
          "[Removed Lines]",
          "493: void brcmf_proto_bcdc_detach(struct brcmf_pub *drvr)",
          "498:  brcmf_fws_detach(bcdc->fws);",
          "",
          "[Added Lines]",
          "493: void brcmf_proto_bcdc_detach_pre_delif(struct brcmf_pub *drvr)",
          "494: {",
          "495:  struct brcmf_bcdc *bcdc = drvr->proto->pd;",
          "497:  brcmf_fws_detach_pre_delif(bcdc->fws);",
          "498: }",
          "500: void brcmf_proto_bcdc_detach_post_delif(struct brcmf_pub *drvr)",
          "505:  brcmf_fws_detach_post_delif(bcdc->fws);",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/bcdc.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: #ifdef CONFIG_BRCMFMAC_PROTO_BCDC",
          "20: int brcmf_proto_bcdc_attach(struct brcmf_pub *drvr);",
          "22: void brcmf_proto_bcdc_txflowblock(struct device *dev, bool state);",
          "23: void brcmf_proto_bcdc_txcomplete(struct device *dev, struct sk_buff *txp,",
          "24:      bool success);",
          "25: struct brcmf_fws_info *drvr_to_fws(struct brcmf_pub *drvr);",
          "26: #else",
          "27: static inline int brcmf_proto_bcdc_attach(struct brcmf_pub *drvr) { return 0; }",
          "29: #endif",
          "",
          "[Removed Lines]",
          "21: void brcmf_proto_bcdc_detach(struct brcmf_pub *drvr);",
          "28: static inline void brcmf_proto_bcdc_detach(struct brcmf_pub *drvr) {}",
          "",
          "[Added Lines]",
          "21: void brcmf_proto_bcdc_detach_pre_delif(struct brcmf_pub *drvr);",
          "22: void brcmf_proto_bcdc_detach_post_delif(struct brcmf_pub *drvr);",
          "29: static void brcmf_proto_bcdc_detach_pre_delif(struct brcmf_pub *drvr) {};",
          "30: static inline void brcmf_proto_bcdc_detach_post_delif(struct brcmf_pub *drvr) {}",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/core.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1322:  brcmf_bus_change_state(bus_if, BRCMF_BUS_DOWN);",
          "1325:  for (i = BRCMF_MAX_IFS-1; i > -1; i--)",
          "1326:   brcmf_remove_interface(drvr->iflist[i], false);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1324:  brcmf_proto_detach_pre_delif(drvr);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1331:  brcmf_bus_stop(drvr->bus_if);",
          "1335:  bus_if->drvr = NULL;",
          "1336:  wiphy_free(drvr->wiphy);",
          "",
          "[Removed Lines]",
          "1333:  brcmf_proto_detach(drvr);",
          "",
          "[Added Lines]",
          "1335:  brcmf_proto_detach_post_delif(drvr);",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2443:  return fws;",
          "2445: fail:",
          "2447:  return ERR_PTR(rc);",
          "2448: }",
          "2451: {",
          "2452:  if (!fws)",
          "2453:   return;",
          "2456:   destroy_workqueue(fws->fws_wq);",
          "2459:  brcmf_fws_lock(fws);",
          "",
          "[Removed Lines]",
          "2446:  brcmf_fws_detach(fws);",
          "2450: void brcmf_fws_detach(struct brcmf_fws_info *fws)",
          "2455:  if (fws->fws_wq)",
          "",
          "[Added Lines]",
          "2446:  brcmf_fws_detach_pre_delif(fws);",
          "2447:  brcmf_fws_detach_post_delif(fws);",
          "2451: void brcmf_fws_detach_pre_delif(struct brcmf_fws_info *fws)",
          "2455:  if (fws->fws_wq) {",
          "2457:   fws->fws_wq = NULL;",
          "2458:  }",
          "2459: }",
          "2461: void brcmf_fws_detach_post_delif(struct brcmf_fws_info *fws)",
          "2462: {",
          "2463:  if (!fws)",
          "2464:   return;",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/fwsignal.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: #define FWSIGNAL_H_",
          "21: struct brcmf_fws_info *brcmf_fws_attach(struct brcmf_pub *drvr);",
          "23: void brcmf_fws_debugfs_create(struct brcmf_pub *drvr);",
          "24: bool brcmf_fws_queue_skbs(struct brcmf_fws_info *fws);",
          "25: bool brcmf_fws_fc_active(struct brcmf_fws_info *fws);",
          "",
          "[Removed Lines]",
          "22: void brcmf_fws_detach(struct brcmf_fws_info *fws);",
          "",
          "[Added Lines]",
          "22: void brcmf_fws_detach_pre_delif(struct brcmf_fws_info *fws);",
          "23: void brcmf_fws_detach_post_delif(struct brcmf_fws_info *fws);",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c||drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "67:  return -ENOMEM;",
          "68: }",
          "71: {",
          "72:  brcmf_dbg(TRACE, \"Enter\\n\");",
          "74:  if (drvr->proto) {",
          "75:   if (drvr->bus_if->proto_type == BRCMF_PROTO_BCDC)",
          "77:   else if (drvr->bus_if->proto_type == BRCMF_PROTO_MSGBUF)",
          "78:    brcmf_proto_msgbuf_detach(drvr);",
          "79:   kfree(drvr->proto);",
          "80:   drvr->proto = NULL;",
          "81:  }",
          "82: }",
          "",
          "[Removed Lines]",
          "70: void brcmf_proto_detach(struct brcmf_pub *drvr)",
          "76:    brcmf_proto_bcdc_detach(drvr);",
          "",
          "[Added Lines]",
          "70: void brcmf_proto_detach_post_delif(struct brcmf_pub *drvr)",
          "76:    brcmf_proto_bcdc_detach_post_delif(drvr);",
          "84: void brcmf_proto_detach_pre_delif(struct brcmf_pub *drvr)",
          "85: {",
          "86:  if (drvr->proto && drvr->bus_if->proto_type == BRCMF_PROTO_BCDC)",
          "87:   brcmf_proto_bcdc_detach_pre_delif(drvr);",
          "88: }",
          "",
          "---------------"
        ],
        "drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h||drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h": [
          "File: drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h -> drivers/net/wireless/broadcom/brcm80211/brcmfmac/proto.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "56: int brcmf_proto_attach(struct brcmf_pub *drvr);",
          "59: static inline int brcmf_proto_hdrpull(struct brcmf_pub *drvr, bool do_fws,",
          "60:           struct sk_buff *skb,",
          "",
          "[Removed Lines]",
          "57: void brcmf_proto_detach(struct brcmf_pub *drvr);",
          "",
          "[Added Lines]",
          "57: void brcmf_proto_detach_pre_delif(struct brcmf_pub *drvr);",
          "58: void brcmf_proto_detach_post_delif(struct brcmf_pub *drvr);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "73f28f714a8fd0ecb692a225bb7a5979d902ecb5",
      "candidate_info": {
        "commit_hash": "73f28f714a8fd0ecb692a225bb7a5979d902ecb5",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/73f28f714a8fd0ecb692a225bb7a5979d902ecb5",
        "files": [
          "drivers/rtc/lib.c"
        ],
        "message": "rtc: lib: check whether tm->tm_year in int32 range\n\nWhen setting rtc alarm (RTC_WKALM_SET), the tm_year is not checked if it\nis in suiteable range. Use INT_MAX - 1900 to check it.\n\nUBSAN: Undefined behaviour in drivers/rtc/rtc-lib.c:119:30\nsigned integer overflow:\n2147483647 + 1900 cannot be represented in type 'int'\nCPU: 1 PID: 20994 Comm: syz-executor0 Not tainted 4.19.18-514.55.6.9.x86_64\n+ #1\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1\n04/01/2014\nCall Trace:\n __dump_stack lib/dump_stack.c:77 [inline]\n dump_stack+0xca/0x13e lib/dump_stack.c:113\n ubsan_epilogue+0xe/0x81 lib/ubsan.c:159\n handle_overflow+0x193/0x1e2 lib/ubsan.c:190\n rtc_tm_to_time64+0x267/0x280 drivers/rtc/rtc-lib.c:119\n rtc_tm_to_ktime+0x16/0x70 drivers/rtc/rtc-lib.c:129\n rtc_set_alarm+0x1a9/0x2d0 drivers/rtc/interface.c:466\n rtc_dev_ioctl+0x6db/0x810 drivers/rtc/rtc-dev.c:380\n vfs_ioctl fs/ioctl.c:46 [inline]\n do_vfs_ioctl+0x1a5/0x10b0 fs/ioctl.c:690\n ksys_ioctl+0x89/0xa0 fs/ioctl.c:705\n __do_sys_ioctl fs/ioctl.c:712 [inline]\n __se_sys_ioctl fs/ioctl.c:710 [inline]\n __x64_sys_ioctl+0x74/0xb0 fs/ioctl.c:710\n do_syscall_64+0xc8/0x580 arch/x86/entry/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49/0xbe\nRIP: 0033:0x462589\nCode: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89\nf8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08\n0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8\n64 89 01 48\nRSP: 002b:00007f5348896c58 EFLAGS: 00000246 ORIG_RAX: 0000000000000010\nRAX: ffffffffffffffda RBX: 000000000072bf00 RCX: 0000000000462589\nRDX: 0000000020000000 RSI: 000000004028700f RDI: 0000000000000003\nRBP: 0000000000000003 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246 R12: 00007f53488976bc\nR13: 00000000004bf67e R14: 00000000006f96e0 R15: 00000000ffffffff\n\n==========================================================================\n\nSigned-off-by: Xuefeng Wang <wxf.wang@hisilicon.com>\nSigned-off-by: Alexandre Belloni <alexandre.belloni@bootlin.com>",
        "before_after_code_files": [
          "drivers/rtc/lib.c||drivers/rtc/lib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/rtc/lib.c||drivers/rtc/lib.c": [
          "File: drivers/rtc/lib.c -> drivers/rtc/lib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "94: int rtc_valid_tm(struct rtc_time *tm)",
          "95: {",
          "96:  if (tm->tm_year < 70 ||",
          "97:      ((unsigned int)tm->tm_mon) >= 12 ||",
          "98:      tm->tm_mday < 1 ||",
          "99:      tm->tm_mday > rtc_month_days(tm->tm_mon,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "97:      tm->tm_year > (INT_MAX - 1900) ||",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6b0868c820ff7370d15d6ddfe71b1ce6bbe8a25d",
      "candidate_info": {
        "commit_hash": "6b0868c820ff7370d15d6ddfe71b1ce6bbe8a25d",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/6b0868c820ff7370d15d6ddfe71b1ce6bbe8a25d",
        "files": [
          "mm/compaction.c"
        ],
        "message": "mm/compaction.c: correct zone boundary handling when resetting pageblock skip hints\n\nMikhail Gavrilo reported the following bug being triggered in a Fedora\nkernel based on 5.1-rc1 but it is relevant to a vanilla kernel.\n\n kernel: page dumped because: VM_BUG_ON_PAGE(PagePoisoned(p))\n kernel: ------------[ cut here ]------------\n kernel: kernel BUG at include/linux/mm.h:1021!\n kernel: invalid opcode: 0000 [#1] SMP NOPTI\n kernel: CPU: 6 PID: 116 Comm: kswapd0 Tainted: G         C        5.1.0-0.rc1.git1.3.fc31.x86_64 #1\n kernel: Hardware name: System manufacturer System Product Name/ROG STRIX X470-I GAMING, BIOS 1201 12/07/2018\n kernel: RIP: 0010:__reset_isolation_pfn+0x244/0x2b0\n kernel: Code: fe 06 e8 0f 8e fc ff 44 0f b6 4c 24 04 48 85 c0 0f 85 dc fe ff ff e9 68 fe ff ff 48 c7 c6 58 b7 2e 8c 4c 89 ff e8 0c 75 00 00 <0f> 0b 48 c7 c6 58 b7 2e 8c e8 fe 74 00 00 0f 0b 48 89 fa 41 b8 01\n kernel: RSP: 0018:ffff9e2d03f0fde8 EFLAGS: 00010246\n kernel: RAX: 0000000000000034 RBX: 000000000081f380 RCX: ffff8cffbddd6c20\n kernel: RDX: 0000000000000000 RSI: 0000000000000006 RDI: ffff8cffbddd6c20\n kernel: RBP: 0000000000000001 R08: 0000009898b94613 R09: 0000000000000000\n kernel: R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000100000\n kernel: R13: 0000000000100000 R14: 0000000000000001 R15: ffffca7de07ce000\n kernel: FS:  0000000000000000(0000) GS:ffff8cffbdc00000(0000) knlGS:0000000000000000\n kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n kernel: CR2: 00007fc1670e9000 CR3: 00000007f5276000 CR4: 00000000003406e0\n kernel: Call Trace:\n kernel:  __reset_isolation_suitable+0x62/0x120\n kernel:  reset_isolation_suitable+0x3b/0x40\n kernel:  kswapd+0x147/0x540\n kernel:  ? finish_wait+0x90/0x90\n kernel:  kthread+0x108/0x140\n kernel:  ? balance_pgdat+0x560/0x560\n kernel:  ? kthread_park+0x90/0x90\n kernel:  ret_from_fork+0x27/0x50\n\nHe bisected it down to e332f741a8dd (\"mm, compaction: be selective about\nwhat pageblocks to clear skip hints\").  The problem is that the patch in\nquestion was sloppy with respect to the handling of zone boundaries.  In\nsome instances, it was possible for PFNs outside of a zone to be examined\nand if those were not properly initialised or poisoned then it would\ntrigger the VM_BUG_ON.  This patch corrects the zone boundary issues when\nresetting pageblock skip hints and Mikhail reported that the bug did not\ntrigger after 30 hours of testing.\n\nLink: http://lkml.kernel.org/r/20190327085424.GL3189@techsingularity.net\nFixes: e332f741a8dd (\"mm, compaction: be selective about what pageblocks to clear skip hints\")\nReported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>\nTested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>\nCc: Daniel Jordan <daniel.m.jordan@oracle.com>\nCc: Qian Cai <cai@lca.pw>\nCc: Vlastimil Babka <vbabka@suse.cz>\nSigned-off-by: Mel Gorman <mgorman@techsingularity.net>",
        "before_after_code_files": [
          "mm/compaction.c||mm/compaction.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "mm/compaction.c||mm/compaction.c": [
          "File: mm/compaction.c -> mm/compaction.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "242:        bool check_target)",
          "243: {",
          "244:  struct page *page = pfn_to_online_page(pfn);",
          "245:  struct page *end_page;",
          "246:  unsigned long block_pfn;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "245:  struct page *block_page;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "267:      get_pageblock_migratetype(page) != MIGRATE_MOVABLE)",
          "268:   return false;",
          "284:  do {",
          "285:   if (pfn_valid_within(pfn)) {",
          "286:    if (check_source && PageLRU(page)) {",
          "",
          "[Removed Lines]",
          "275:  block_pfn = pageblock_start_pfn(pfn);",
          "276:  pfn = max(block_pfn, zone->zone_start_pfn);",
          "277:  page = pfn_to_page(pfn);",
          "278:  if (zone != page_zone(page))",
          "279:   return false;",
          "280:  pfn = block_pfn + pageblock_nr_pages;",
          "281:  pfn = min(pfn, zone_end_pfn(zone));",
          "282:  end_page = pfn_to_page(pfn);",
          "",
          "[Added Lines]",
          "272:  block_pfn = pageblock_start_pfn(pfn);",
          "273:  block_page = pfn_to_online_page(max(block_pfn, zone->zone_start_pfn));",
          "274:  if (block_page) {",
          "275:   page = block_page;",
          "276:   pfn = block_pfn;",
          "277:  }",
          "280:  block_pfn += pageblock_nr_pages;",
          "281:  block_pfn = min(block_pfn, zone_end_pfn(zone) - 1);",
          "282:  end_page = pfn_to_online_page(block_pfn);",
          "283:  if (!end_page)",
          "284:   return false;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "309: static void __reset_isolation_suitable(struct zone *zone)",
          "310: {",
          "311:  unsigned long migrate_pfn = zone->zone_start_pfn;",
          "313:  unsigned long reset_migrate = free_pfn;",
          "314:  unsigned long reset_free = migrate_pfn;",
          "315:  bool source_set = false;",
          "",
          "[Removed Lines]",
          "312:  unsigned long free_pfn = zone_end_pfn(zone);",
          "",
          "[Added Lines]",
          "319:  unsigned long free_pfn = zone_end_pfn(zone) - 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee6df5694a9a2e30566ae05e9c145a0f6d5e087f",
      "candidate_info": {
        "commit_hash": "ee6df5694a9a2e30566ae05e9c145a0f6d5e087f",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/ee6df5694a9a2e30566ae05e9c145a0f6d5e087f",
        "files": [
          "drivers/gpu/drm/i915/i915_debugfs.c"
        ],
        "message": "drm/i915: Always backoff after a drm_modeset_lock() deadlock\n\nIf drm_modeset_lock() reports a deadlock it sets the ctx->contexted\nfield and insists that the caller calls drm_modeset_backoff() or else it\ngenerates a WARN on cleanup.\n\n<4> [1601.870376] WARNING: CPU: 3 PID: 8445 at drivers/gpu/drm/drm_modeset_lock.c:228 drm_modeset_drop_locks+0x35/0x40\n<4> [1601.870395] Modules linked in: vgem snd_hda_codec_hdmi snd_hda_codec_realtek snd_hda_codec_generic x86_pkg_temp_thermal i915 coretemp crct10dif_pclmul\n<6> [1601.870403] Console: switching\n<4> [1601.870403]  snd_hda_intel\n<4> [1601.870406] to colour frame buffer device 320x90\n<4> [1601.870406]  crc32_pclmul snd_hda_codec snd_hwdep ghash_clmulni_intel e1000e snd_hda_core cdc_ether ptp usbnet mii pps_core snd_pcm i2c_i801 mei_me mei prime_numbers\n<4> [1601.870422] CPU: 3 PID: 8445 Comm: cat Tainted: G     U            5.0.0-rc7-CI-CI_DRM_5650+ #1\n<4> [1601.870424] Hardware name: Intel Corporation Ice Lake Client Platform/IceLake U DDR4 SODIMM PD RVP TLC, BIOS ICLSFWR1.R00.2402.AD3.1810170014 10/17/2018\n<4> [1601.870427] RIP: 0010:drm_modeset_drop_locks+0x35/0x40\n<4> [1601.870430] Code: 29 48 8b 43 60 48 8d 6b 60 48 39 c5 74 19 48 8b 43 60 48 8d b8 70 ff ff ff e8 87 ff ff ff 48 8b 43 60 48 39 c5 75 e7 5b 5d c3 <0f> 0b eb d3 0f 1f 80 00 00 00 00 41 56 41 55 41 54 55 53 48 8b 6f\n<4> [1601.870432] RSP: 0018:ffffc90000d67ce8 EFLAGS: 00010282\n<4> [1601.870435] RAX: 00000000ffffffdd RBX: ffffc90000d67d00 RCX: 5dbbe23d00000000\n<4> [1601.870437] RDX: 0000000000000000 RSI: 0000000093e6194a RDI: ffffc90000d67d00\n<4> [1601.870439] RBP: ffff88849e62e678 R08: 0000000003b7329a R09: 0000000000000001\n<4> [1601.870441] R10: 0000000000000000 R11: 0000000000000000 R12: ffff888492100410\n<4> [1601.870442] R13: ffff88849ea50958 R14: ffff8884a67eb028 R15: ffff8884a67eb028\n<4> [1601.870445] FS:  00007fa7a27745c0(0000) GS:ffff8884aff80000(0000) knlGS:0000000000000000\n<4> [1601.870447] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\n<4> [1601.870449] CR2: 000055af07e66000 CR3: 00000004a8cc2006 CR4: 0000000000760ee0\n<4> [1601.870451] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\n<4> [1601.870453] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\n<4> [1601.870454] PKRU: 55555554\n<4> [1601.870456] Call Trace:\n<4> [1601.870505]  i915_dsc_fec_support_show+0x91/0x190 [i915]\n<4> [1601.870522]  seq_read+0xdb/0x3c0\n<4> [1601.870531]  full_proxy_read+0x51/0x80\n<4> [1601.870538]  __vfs_read+0x31/0x190\n<4> [1601.870546]  ? __se_sys_newfstat+0x3c/0x60\n<4> [1601.870552]  vfs_read+0x9e/0x150\n<4> [1601.870557]  ksys_read+0x50/0xc0\n<4> [1601.870564]  do_syscall_64+0x55/0x190\n<4> [1601.870569]  entry_SYSCALL_64_after_hwframe+0x49/0xbe\n<4> [1601.870572] RIP: 0033:0x7fa7a226d081\n<4> [1601.870574] Code: fe ff ff 48 8d 3d 67 9c 0a 00 48 83 ec 08 e8 a6 4c 02 00 66 0f 1f 44 00 00 48 8d 05 81 08 2e 00 8b 00 85 c0 75 13 31 c0 0f 05 <48> 3d 00 f0 ff ff 77 57 f3 c3 0f 1f 44 00 00 41 54 55 49 89 d4 53\n<4> [1601.870576] RSP: 002b:00007ffcc05140c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000000\n<4> [1601.870579] RAX: ffffffffffffffda RBX: 0000000000020000 RCX: 00007fa7a226d081\n<4> [1601.870581] RDX: 0000000000020000 RSI: 000055af07e63000 RDI: 0000000000000007\n<4> [1601.870583] RBP: 0000000000020000 R08: 000000000000007b R09: 0000000000000000\n<4> [1601.870585] R10: 000055af07e60010 R11: 0000000000000246 R12: 000055af07e63000\n<4> [1601.870587] R13: 0000000000000007 R14: 000055af07e634bf R15: 0000000000020000\n\nBugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=109745\nFixes: e845f099f1c6 (\"drm/i915/dsc: Add Per connector debugfs node for DSC support/enable\")\nSigned-off-by: Chris Wilson <chris@chris-wilson.co.uk>\nCc: Rodrigo Vivi <rodrigo.vivi@intel.com>\nCc: Ville Syrjala <ville.syrjala@linux.intel.com>\nCc: Anusha Srivatsa <anusha.srivatsa@intel.com>\nCc: Lyude Paul <lyude@redhat.com>\nCc: Manasi Navare <manasi.d.navare@intel.com>\nReviewed-by: Manasi Navare <manasi.d.navare@intel.com>\nLink: https://patchwork.freedesktop.org/patch/msgid/20190329165152.29259-1-chris@chris-wilson.co.uk",
        "before_after_code_files": [
          "drivers/gpu/drm/i915/i915_debugfs.c||drivers/gpu/drm/i915/i915_debugfs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/gpu/drm/i915/i915_debugfs.c||drivers/gpu/drm/i915/i915_debugfs.c": [
          "File: drivers/gpu/drm/i915/i915_debugfs.c -> drivers/gpu/drm/i915/i915_debugfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4787:   ret = drm_modeset_lock(&dev->mode_config.connection_mutex,",
          "4788:            &ctx);",
          "4789:   if (ret) {",
          "4791:    break;",
          "4792:   }",
          "4793:   crtc = connector->state->crtc;",
          "",
          "[Removed Lines]",
          "4790:    ret = -EINTR;",
          "",
          "[Added Lines]",
          "4790:    if (ret == -EDEADLK && !drm_modeset_backoff(&ctx)) {",
          "4791:     try_again = true;",
          "4792:     continue;",
          "4793:    }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "23da9588037ecdd4901db76a5b79a42b529c4ec3",
      "candidate_info": {
        "commit_hash": "23da9588037ecdd4901db76a5b79a42b529c4ec3",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/23da9588037ecdd4901db76a5b79a42b529c4ec3",
        "files": [
          "fs/proc/proc_sysctl.c"
        ],
        "message": "fs/proc/proc_sysctl.c: fix NULL pointer dereference in put_links\n\nSyzkaller reports:\n\nkasan: GPF could be caused by NULL-ptr deref or user memory access\ngeneral protection fault: 0000 [#1] SMP KASAN PTI\nCPU: 1 PID: 5373 Comm: syz-executor.0 Not tainted 5.0.0-rc8+ #3\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014\nRIP: 0010:put_links+0x101/0x440 fs/proc/proc_sysctl.c:1599\nCode: 00 0f 85 3a 03 00 00 48 8b 43 38 48 89 44 24 20 48 83 c0 38 48 89 c2 48 89 44 24 28 48 b8 00 00 00 00 00 fc ff df 48 c1 ea 03 <80> 3c 02 00 0f 85 fe 02 00 00 48 8b 74 24 20 48 c7 c7 60 2a 9d 91\nRSP: 0018:ffff8881d828f238 EFLAGS: 00010202\nRAX: dffffc0000000000 RBX: ffff8881e01b1140 RCX: ffffffff8ee98267\nRDX: 0000000000000007 RSI: ffffc90001479000 RDI: ffff8881e01b1178\nRBP: dffffc0000000000 R08: ffffed103ee27259 R09: ffffed103ee27259\nR10: 0000000000000001 R11: ffffed103ee27258 R12: fffffffffffffff4\nR13: 0000000000000006 R14: ffff8881f59838c0 R15: dffffc0000000000\nFS:  00007f072254f700(0000) GS:ffff8881f7100000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007fff8b286668 CR3: 00000001f0542002 CR4: 00000000007606e0\nDR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000\nDR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400\nPKRU: 55555554\nCall Trace:\n drop_sysctl_table+0x152/0x9f0 fs/proc/proc_sysctl.c:1629\n get_subdir fs/proc/proc_sysctl.c:1022 [inline]\n __register_sysctl_table+0xd65/0x1090 fs/proc/proc_sysctl.c:1335\n br_netfilter_init+0xbc/0x1000 [br_netfilter]\n do_one_initcall+0xfa/0x5ca init/main.c:887\n do_init_module+0x204/0x5f6 kernel/module.c:3460\n load_module+0x66b2/0x8570 kernel/module.c:3808\n __do_sys_finit_module+0x238/0x2a0 kernel/module.c:3902\n do_syscall_64+0x147/0x600 arch/x86/entry/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49/0xbe\nRIP: 0033:0x462e99\nCode: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48\nRSP: 002b:00007f072254ec58 EFLAGS: 00000246 ORIG_RAX: 0000000000000139\nRAX: ffffffffffffffda RBX: 000000000073bf00 RCX: 0000000000462e99\nRDX: 0000000000000000 RSI: 0000000020000280 RDI: 0000000000000003\nRBP: 00007f072254ec70 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246 R12: 00007f072254f6bc\nR13: 00000000004bcefa R14: 00000000006f6fb0 R15: 0000000000000004\nModules linked in: br_netfilter(+) dvb_usb_dibusb_mc_common dib3000mc dibx000_common dvb_usb_dibusb_common dvb_usb_dw2102 dvb_usb classmate_laptop palmas_regulator cn videobuf2_v4l2 v4l2_common snd_soc_bd28623 mptbase snd_usb_usx2y snd_usbmidi_lib snd_rawmidi wmi libnvdimm lockd sunrpc grace rc_kworld_pc150u rc_core rtc_da9063 sha1_ssse3 i2c_cros_ec_tunnel adxl34x_spi adxl34x nfnetlink lib80211 i5500_temp dvb_as102 dvb_core videobuf2_common videodev media videobuf2_vmalloc videobuf2_memops udc_core lnbp22 leds_lp3952 hid_roccat_ryos s1d13xxxfb mtd vport_geneve openvswitch nf_conncount nf_nat_ipv6 nsh geneve udp_tunnel ip6_udp_tunnel snd_soc_mt6351 sis_agp phylink snd_soc_adau1761_spi snd_soc_adau1761 snd_soc_adau17x1 snd_soc_core snd_pcm_dmaengine ac97_bus snd_compress snd_soc_adau_utils snd_soc_sigmadsp_regmap snd_soc_sigmadsp raid_class hid_roccat_konepure hid_roccat_common hid_roccat c2port_duramar2150 core mdio_bcm_unimac iptable_security iptable_raw iptable_mangle\n iptable_nat nf_nat_ipv4 nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 iptable_filter bpfilter ip6_vti ip_vti ip_gre ipip sit tunnel4 ip_tunnel hsr veth netdevsim devlink vxcan batman_adv cfg80211 rfkill chnl_net caif nlmon dummy team bonding vcan bridge stp llc ip6_gre gre ip6_tunnel tunnel6 tun crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel joydev mousedev ide_pci_generic piix aesni_intel aes_x86_64 ide_core crypto_simd atkbd cryptd glue_helper serio_raw ata_generic pata_acpi i2c_piix4 floppy sch_fq_codel ip_tables x_tables ipv6 [last unloaded: lm73]\nDumping ftrace buffer:\n   (ftrace buffer empty)\n---[ end trace 770020de38961fd0 ]---\n\nA new dir entry can be created in get_subdir and its 'header->parent' is\nset to NULL.  Only after insert_header success, it will be set to 'dir',\notherwise 'header->parent' is set to NULL and drop_sysctl_table is called.\nHowever in err handling path of get_subdir, drop_sysctl_table also be\ncalled on 'new->header' regardless its value of parent pointer.  Then\nput_links is called, which triggers NULL-ptr deref when access member of\nheader->parent.\n\nIn fact we have multiple error paths which call drop_sysctl_table() there,\nupon failure on insert_links() we also call drop_sysctl_table().And even\nin the successful case on __register_sysctl_table() we still always call\ndrop_sysctl_table().This patch fix it.\n\nLink: http://lkml.kernel.org/r/20190314085527.13244-1-yuehaibing@huawei.com\nFixes: 0e47c99d7fe25 (\"sysctl: Replace root_list with links between sysctl_table_sets\")\nSigned-off-by: YueHaibing <yuehaibing@huawei.com>\nReported-by: Hulk Robot <hulkci@huawei.com>\nAcked-by: Luis Chamberlain <mcgrof@kernel.org>\nCc: Kees Cook <keescook@chromium.org>\nCc: Alexey Dobriyan <adobriyan@gmail.com>\nCc: Alexei Starovoitov <ast@kernel.org>\nCc: Daniel Borkmann <daniel@iogearbox.net>\nCc: Al Viro <viro@zeniv.linux.org.uk>\nCc: Eric W. Biederman <ebiederm@xmission.com>\nCc: <stable@vger.kernel.org>    [3.4+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
        "before_after_code_files": [
          "fs/proc/proc_sysctl.c||fs/proc/proc_sysctl.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "fs/proc/proc_sysctl.c||fs/proc/proc_sysctl.c": [
          "File: fs/proc/proc_sysctl.c -> fs/proc/proc_sysctl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1626:  if (--header->nreg)",
          "1627:   return;",
          "1630:  start_unregistering(header);",
          "1631:  if (!--header->count)",
          "1632:   kfree_rcu(header, rcu);",
          "",
          "[Removed Lines]",
          "1629:  put_links(header);",
          "",
          "[Added Lines]",
          "1629:  if (parent)",
          "1630:   put_links(header);",
          "",
          "---------------"
        ]
      }
    }
  ]
}