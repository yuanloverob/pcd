{
  "cve_id": "CVE-2017-3730",
  "cve_desc": "In OpenSSL 1.1.0 before 1.1.0d, if a malicious server supplies bad parameters for a DHE or ECDHE key exchange then this can result in the client attempting to dereference a NULL pointer leading to a client crash. This could be exploited in a Denial of Service attack.",
  "repo": "openssl/openssl",
  "patch_hash": "efbe126e3ebb9123ac9d058aa2bb044261342aaa",
  "patch_info": {
    "commit_hash": "efbe126e3ebb9123ac9d058aa2bb044261342aaa",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/efbe126e3ebb9123ac9d058aa2bb044261342aaa",
    "files": [
      "ssl/statem/statem_clnt.c"
    ],
    "message": "Fix missing NULL checks in CKE processing\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "ssl/statem/statem_clnt.c||ssl/statem/statem_clnt.c"
    ]
  },
  "patch_diff": {
    "ssl/statem/statem_clnt.c||ssl/statem/statem_clnt.c": [
      "File: ssl/statem/statem_clnt.c -> ssl/statem/statem_clnt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2258:         return 0;",
      "2259:     }",
      "2260:     ckey = ssl_generate_pkey(skey);",
      "2261:     dh_clnt = EVP_PKEY_get0_DH(ckey);",
      "2263:     if (dh_clnt == NULL || ssl_derive(s, ckey, skey) == 0) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2261:     if (ckey == NULL) {",
      "2262:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_DHE, ERR_R_INTERNAL_ERROR);",
      "2263:         return 0;",
      "2264:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2296:     }",
      "2298:     ckey = ssl_generate_pkey(skey);",
      "2300:     if (ssl_derive(s, ckey, skey) == 0) {",
      "2301:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_ECDHE, ERR_R_EVP_LIB);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2304:     if (ckey == NULL) {",
      "2305:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_ECDHE, ERR_R_INTERNAL_ERROR);",
      "2306:         goto err;",
      "2307:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3bdc1dc8fcc97a8945ddbc2748e7059207ea3914",
      "candidate_info": {
        "commit_hash": "3bdc1dc8fcc97a8945ddbc2748e7059207ea3914",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/3bdc1dc8fcc97a8945ddbc2748e7059207ea3914",
        "files": [
          "crypto/evp/e_chacha20_poly1305.c"
        ],
        "message": "Properly zero cipher_data for ChaCha20-Poly1305 on cleanup\n\nFix a typo. Probably this has not been found because EVP_CIPHER_CTX is\nsmaller than EVP_CHACHA_AEAD_CTX and heap overflow does not occur.\n\nReviewed-by: Richard Levitte <levitte@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2294)\n(cherry picked from commit a8f957686675194d786b41f6e1f7c48bb85723ec)",
        "before_after_code_files": [
          "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c": [
          "File: crypto/evp/e_chacha20_poly1305.c -> crypto/evp/e_chacha20_poly1305.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "316: {",
          "317:     EVP_CHACHA_AEAD_CTX *actx = aead_data(ctx);",
          "318:     if (actx)",
          "320:     return 1;",
          "321: }",
          "",
          "[Removed Lines]",
          "319:         OPENSSL_cleanse(ctx->cipher_data, sizeof(*ctx) + Poly1305_ctx_size());",
          "",
          "[Added Lines]",
          "319:         OPENSSL_cleanse(ctx->cipher_data, sizeof(*actx) + Poly1305_ctx_size());",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eed06638c74f0dc5422e7e53cbec98d172925991",
      "candidate_info": {
        "commit_hash": "eed06638c74f0dc5422e7e53cbec98d172925991",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/eed06638c74f0dc5422e7e53cbec98d172925991",
        "files": [
          "Configure",
          "test/recipes/05-test_fuzz.t"
        ],
        "message": "Revert \"Make it possible to disable fuzz testing\"\n\nThis reverts commit eb40eaed727500bf4a15f848c99e37edd18e142e.\n\nReviewed-by: Emilia K\u00e4sper <emilia@openssl.org>\n(cherry picked from commit a5e1f1230e09b249ff94cc48aeffd1b874cb937e)",
        "before_after_code_files": [
          "test/recipes/05-test_fuzz.t||test/recipes/05-test_fuzz.t"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/recipes/05-test_fuzz.t||test/recipes/05-test_fuzz.t": [
          "File: test/recipes/05-test_fuzz.t -> test/recipes/05-test_fuzz.t",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: setup(\"test_fuzz\");",
          "21: my @fuzzers = ('asn1', 'asn1parse', 'bignum', 'bndiv', 'conf', 'crl', 'server', 'x509');",
          "22: if (!disabled(\"cms\")) {",
          "23:     push @fuzzers, 'cms';",
          "",
          "[Removed Lines]",
          "18: plan skip_all => \"Fuzz testing is disabled by this OpenSSL build\"",
          "19:     if disabled(\"fuzz-test\");",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ca0a7a9a4ebe9bb0f646930262f43372fa73254c",
      "candidate_info": {
        "commit_hash": "ca0a7a9a4ebe9bb0f646930262f43372fa73254c",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/ca0a7a9a4ebe9bb0f646930262f43372fa73254c",
        "files": [
          "crypto/asn1/a_time.c"
        ],
        "message": "Fix potential memory leak in ASN1_TIME_to_generalizedtime()\n\nIf ret is allocated, it may be leaked on error.\n\nReviewed-by: Tim Hudson <tjh@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2666)\n(cherry picked from commit 4483e23444fa18034344874ffbe67919207e9e47)",
        "before_after_code_files": [
          "crypto/asn1/a_time.c||crypto/asn1/a_time.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/asn1/a_time.c||crypto/asn1/a_time.c": [
          "File: crypto/asn1/a_time.c -> crypto/asn1/a_time.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "62: ASN1_GENERALIZEDTIME *ASN1_TIME_to_generalizedtime(ASN1_TIME *t,",
          "63:                                                    ASN1_GENERALIZEDTIME **out)",
          "64: {",
          "66:     char *str;",
          "67:     int newlen;",
          "",
          "[Removed Lines]",
          "65:     ASN1_GENERALIZEDTIME *ret;",
          "",
          "[Added Lines]",
          "65:     ASN1_GENERALIZEDTIME *ret = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "72:     if (out == NULL || *out == NULL) {",
          "73:         if ((ret = ASN1_GENERALIZEDTIME_new()) == NULL)",
          "77:     } else",
          "78:         ret = *out;",
          "81:     if (t->type == V_ASN1_GENERALIZEDTIME) {",
          "82:         if (!ASN1_STRING_set(ret, t->data, t->length))",
          "85:     }",
          "88:     if (!ASN1_STRING_set(ret, NULL, t->length + 2))",
          "91:     newlen = t->length + 2 + 1;",
          "92:     str = (char *)ret->data;",
          "",
          "[Removed Lines]",
          "74:             return NULL;",
          "75:         if (out)",
          "83:             return NULL;",
          "84:         return ret;",
          "89:         return NULL;",
          "",
          "[Added Lines]",
          "74:             goto err;",
          "81:             goto err;",
          "82:         goto done;",
          "87:         goto err;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "96:     else",
          "97:         OPENSSL_strlcpy(str, \"20\", newlen);",
          "102: }",
          "104: int ASN1_TIME_set_string(ASN1_TIME *s, const char *str)",
          "105: {",
          "106:     ASN1_TIME t;",
          "",
          "[Removed Lines]",
          "99:     OPENSSL_strlcat(str, (char *)t->data, newlen);",
          "101:     return ret;",
          "",
          "[Added Lines]",
          "97:     OPENSSL_strlcat(str, (const char *)t->data, newlen);",
          "99:  done:",
          "100:    if (out != NULL && *out == NULL)",
          "102:    return ret;",
          "104:  err:",
          "105:     if (out == NULL || *out != ret)",
          "106:         ASN1_GENERALIZEDTIME_free(ret);",
          "107:     return NULL;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ec7b16ddbb020b2f49ff7394901cd2b2bed5234b",
      "candidate_info": {
        "commit_hash": "ec7b16ddbb020b2f49ff7394901cd2b2bed5234b",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/ec7b16ddbb020b2f49ff7394901cd2b2bed5234b",
        "files": [
          "apps/speed.c"
        ],
        "message": "apps: remove some #ifndef clutter\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1643)\n(cherry picked from commit b85bf6395251dc28457b95de586a2f0a5faae4af)",
        "before_after_code_files": [
          "apps/speed.c||apps/speed.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "apps/speed.c||apps/speed.c": [
          "File: apps/speed.c -> apps/speed.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1224:     int async_init = 0;",
          "1225:     int loopargs_len = 0;",
          "1226:     char *prog;",
          "1228:     const char *engine_id = NULL;",
          "1230:     const EVP_CIPHER *evp_cipher = NULL;",
          "1231:     double d = 0.0;",
          "1232:     OPTION_CHOICE o;",
          "",
          "[Removed Lines]",
          "1227: #ifndef OPENSSL_NO_ENGINE",
          "1229: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1404:             engine_id = opt_arg();",
          "1406:             break;",
          "1407:         case OPT_MULTI:",
          "1408: #ifndef NO_FORK",
          "",
          "[Removed Lines]",
          "1403: #ifndef OPENSSL_NO_ENGINE",
          "1405: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fad4832a121cde93a126a2a3f9b336c439d1749d",
      "candidate_info": {
        "commit_hash": "fad4832a121cde93a126a2a3f9b336c439d1749d",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/fad4832a121cde93a126a2a3f9b336c439d1749d",
        "files": [
          "crypto/ui/ui_err.c",
          "crypto/ui/ui_openssl.c",
          "include/openssl/ui.h"
        ],
        "message": "VMS UI_OpenSSL: generate OpenSSL errors when things go wrong.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2063)\n(cherry picked from commit c922ebe23247ff9ee07310fa30647623c0547cd9)",
        "before_after_code_files": [
          "crypto/ui/ui_err.c||crypto/ui/ui_err.c",
          "crypto/ui/ui_openssl.c||crypto/ui/ui_openssl.c",
          "include/openssl/ui.h||include/openssl/ui.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/ui/ui_err.c||crypto/ui/ui_err.c": [
          "File: crypto/ui/ui_err.c -> crypto/ui/ui_err.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: # define ERR_REASON(reason) ERR_PACK(ERR_LIB_UI,0,reason)",
          "21: static ERR_STRING_DATA UI_str_functs[] = {",
          "22:     {ERR_FUNC(UI_F_GENERAL_ALLOCATE_BOOLEAN), \"general_allocate_boolean\"},",
          "23:     {ERR_FUNC(UI_F_GENERAL_ALLOCATE_PROMPT), \"general_allocate_prompt\"},",
          "24:     {ERR_FUNC(UI_F_OPEN_CONSOLE), \"open_console\"},",
          "25:     {ERR_FUNC(UI_F_UI_CREATE_METHOD), \"UI_create_method\"},",
          "26:     {ERR_FUNC(UI_F_UI_CTRL), \"UI_ctrl\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22:     {ERR_FUNC(UI_F_CLOSE_CONSOLE), \"close_console\"},",
          "23:     {ERR_FUNC(UI_F_ECHO_CONSOLE), \"echo_console\"},",
          "26:     {ERR_FUNC(UI_F_NOECHO_CONSOLE), \"noecho_console\"},",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45:     {ERR_REASON(UI_R_PROCESSING_ERROR), \"processing error\"},",
          "46:     {ERR_REASON(UI_R_RESULT_TOO_LARGE), \"result too large\"},",
          "47:     {ERR_REASON(UI_R_RESULT_TOO_SMALL), \"result too small\"},",
          "48:     {ERR_REASON(UI_R_UNKNOWN_CONTROL_COMMAND), \"unknown control command\"},",
          "49:     {ERR_REASON(UI_R_UNKNOWN_TTYGET_ERRNO_VALUE),",
          "50:      \"unknown ttyget errno value\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51:     {ERR_REASON(UI_R_SYSASSIGN_ERROR), \"sys$assign error\"},",
          "52:     {ERR_REASON(UI_R_SYSDASSGN_ERROR), \"sys$dassgn error\"},",
          "53:     {ERR_REASON(UI_R_SYSQIOW_ERROR), \"sys$qiow error\"},",
          "",
          "---------------"
        ],
        "crypto/ui/ui_openssl.c||crypto/ui/ui_openssl.c": [
          "File: crypto/ui/ui_openssl.c -> crypto/ui/ui_openssl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "447:     status = sys$assign(&terminal, &channel, 0, 0);",
          "451:         return 0;",
          "453:     status = sys$qiow(0, channel, IO$_SENSEMODE, &iosb, 0, 0, tty_orig, 12,",
          "454:                       0, 0, 0, 0);",
          "",
          "[Removed Lines]",
          "450:     if (status != SS$_NORMAL)",
          "",
          "[Added Lines]",
          "450:     if (status != SS$_NORMAL) {",
          "451:         char tmp_num[12];",
          "453:         BIO_snprintf(tmp_num, sizeof(tmp_num) - 1, \"%%X%08X\", status);",
          "454:         UIerr(UI_F_OPEN_CONSOLE, UI_R_SYSASSIGN_ERROR);",
          "455:         ERR_add_error_data(2, \"status=\", tmp_num);",
          "457:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "478:         tty_new[2] = tty_orig[2];",
          "479:         status = sys$qiow(0, channel, IO$_SETMODE, &iosb, 0, 0, tty_new, 12,",
          "480:                           0, 0, 0, 0);",
          "482:             return 0;",
          "483:     }",
          "484: #endif",
          "485: #if defined(_WIN32) && !defined(_WIN32_WCE)",
          "",
          "[Removed Lines]",
          "481:         if ((status != SS$_NORMAL) || (iosb.iosb$w_value != SS$_NORMAL))",
          "",
          "[Added Lines]",
          "487:         if ((status != SS$_NORMAL) || (iosb.iosb$w_value != SS$_NORMAL)) {",
          "488:             char tmp_num[2][12];",
          "490:             BIO_snprintf(tmp_num[0], sizeof(tmp_num[0]) - 1, \"%%X%08X\",",
          "491:                          status);",
          "492:             BIO_snprintf(tmp_num[1], sizeof(tmp_num[1]) - 1, \"%%X%08X\",",
          "493:                          iosb.iosb$w_value);",
          "494:             UIerr(UI_F_NOECHO_CONSOLE, UI_R_SYSQIOW_ERROR);",
          "495:             ERR_add_error_data(5, \"status=\", tmp_num[0],",
          "496:                                \",\", \"iosb.iosb$w_value=\", tmp_num[1]);",
          "498:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "510:         tty_new[2] = tty_orig[2];",
          "511:         status = sys$qiow(0, channel, IO$_SETMODE, &iosb, 0, 0, tty_new, 12,",
          "512:                           0, 0, 0, 0);",
          "514:             return 0;",
          "515:     }",
          "516: #endif",
          "517: #if defined(_WIN32) && !defined(_WIN32_WCE)",
          "",
          "[Removed Lines]",
          "513:         if ((status != SS$_NORMAL) || (iosb.iosb$w_value != SS$_NORMAL))",
          "",
          "[Added Lines]",
          "529:         if ((status != SS$_NORMAL) || (iosb.iosb$w_value != SS$_NORMAL)) {",
          "530:             char tmp_num[2][12];",
          "532:             BIO_snprintf(tmp_num[0], sizeof(tmp_num[0]) - 1, \"%%X%08X\",",
          "533:                          status);",
          "534:             BIO_snprintf(tmp_num[1], sizeof(tmp_num[1]) - 1, \"%%X%08X\",",
          "535:                          iosb.iosb$w_value);",
          "536:             UIerr(UI_F_ECHO_CONSOLE, UI_R_SYSQIOW_ERROR);",
          "537:             ERR_add_error_data(5, \"status=\", tmp_num[0],",
          "538:                                \",\", \"iosb.iosb$w_value=\", tmp_num[1]);",
          "540:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "532:         fclose(tty_out);",
          "533: #ifdef OPENSSL_SYS_VMS",
          "534:     status = sys$dassgn(channel);",
          "536:         return 0;",
          "537: #endif",
          "538:     CRYPTO_THREAD_unlock(ui->lock);",
          "",
          "[Removed Lines]",
          "535:     if (status != SS$_NORMAL)",
          "",
          "[Added Lines]",
          "561:     if (status != SS$_NORMAL) {",
          "562:         char tmp_num[12];",
          "564:         BIO_snprintf(tmp_num, sizeof(tmp_num) - 1, \"%%X%08X\", status);",
          "565:         UIerr(UI_F_CLOSE_CONSOLE, UI_R_SYSDASSGN_ERROR);",
          "566:         ERR_add_error_data(2, \"status=\", tmp_num);",
          "568:     }",
          "",
          "---------------"
        ],
        "include/openssl/ui.h||include/openssl/ui.h": [
          "File: include/openssl/ui.h -> include/openssl/ui.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "342: # define UI_F_GENERAL_ALLOCATE_BOOLEAN                    108",
          "343: # define UI_F_GENERAL_ALLOCATE_PROMPT                     109",
          "344: # define UI_F_OPEN_CONSOLE                                114",
          "345: # define UI_F_UI_CREATE_METHOD                            112",
          "346: # define UI_F_UI_CTRL                                     111",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "342: # define UI_F_CLOSE_CONSOLE                               115",
          "343: # define UI_F_ECHO_CONSOLE                                116",
          "346: # define UI_F_NOECHO_CONSOLE                              117",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "362: # define UI_R_PROCESSING_ERROR                            107",
          "363: # define UI_R_RESULT_TOO_LARGE                            100",
          "364: # define UI_R_RESULT_TOO_SMALL                            101",
          "365: # define UI_R_UNKNOWN_CONTROL_COMMAND                     106",
          "366: # define UI_R_UNKNOWN_TTYGET_ERRNO_VALUE                  108",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "368: # define UI_R_SYSASSIGN_ERROR                             109",
          "369: # define UI_R_SYSDASSGN_ERROR                             110",
          "370: # define UI_R_SYSQIOW_ERROR                               111",
          "",
          "---------------"
        ]
      }
    }
  ]
}