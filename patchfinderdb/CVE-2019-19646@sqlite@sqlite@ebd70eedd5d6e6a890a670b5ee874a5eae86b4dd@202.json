{
  "cve_id": "CVE-2019-19646",
  "cve_desc": "pragma.c in SQLite through 3.30.1 mishandles NOT NULL in an integrity_check PRAGMA command in certain cases of generated columns.",
  "repo": "sqlite/sqlite",
  "patch_hash": "ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
  "patch_info": {
    "commit_hash": "ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/pragma.c",
      "test/gencol1.test"
    ],
    "message": "Fix the NOT NULL verification logic in PRAGMA integrity_check so that it works for generated columns whose value is the result of a comparison operator. Ticket [bd8c280671ba44a7]\n\nFossilOrigin-Name: f3b39c71b88cb6721f443de56cdce4c08252453a5e340b00a2bd88dc10c42400",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/pragma.c||src/pragma.c",
      "test/gencol1.test||test/gencol1.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: e3398c5ffb060b2b26334b8598e2c63953741e2d6f5124dbd6bdfc8e94742539",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/pragma.c||src/pragma.c": [
      "File: src/pragma.c -> src/pragma.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1596:           if( j==pTab->iPKey ) continue;",
      "1597:           if( pTab->aCol[j].notNull==0 ) continue;",
      "1598:           sqlite3ExprCodeGetColumnOfTable(v, pTab, iDataCur, j, 3);",
      "1600:           jmp2 = sqlite3VdbeAddOp1(v, OP_NotNull, 3); VdbeCoverage(v);",
      "1601:           zErr = sqlite3MPrintf(db, \"NULL value in %s.%s\", pTab->zName,",
      "1602:                               pTab->aCol[j].zName);",
      "",
      "[Removed Lines]",
      "1599:           sqlite3VdbeChangeP5(v, OPFLAG_TYPEOFARG);",
      "",
      "[Added Lines]",
      "1599:           if( sqlite3VdbeGetOp(v,-1)->opcode==OP_Column ){",
      "1600:             sqlite3VdbeChangeP5(v, OPFLAG_TYPEOFARG);",
      "1601:           }",
      "",
      "---------------"
    ],
    "test/gencol1.test||test/gencol1.test": [
      "File: test/gencol1.test -> test/gencol1.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "328:   INSERT OR REPLACE INTO t0(c0, c1) VALUES (2, 1), (1, 0)",
      "329: } {1 {FOREIGN KEY constraint failed}}",
      "331: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "331: # 2019-12-09 ticket bd8c280671ba44a7",
      "332: # With generated columns, the sqlite3ExprGetColumnOfTable() routine might",
      "333: # generate a code sequence that does not end with OP_Column.  So check to",
      "334: # make sure that the last instruction generated is an OP_column prior to",
      "335: # applying the OPFLAG_TYPEOFARG optimization to NOT NULL checks in the",
      "336: # PRAGMA integrity_check code.",
      "337: #",
      "338: sqlite3 db :memory:",
      "339: do_execsql_test gencol1-12.10 {",
      "340:   CREATE TABLE t0 (c0, c1 NOT NULL AS (c0==0));",
      "341:   INSERT INTO t0(c0) VALUES (0);",
      "342:   PRAGMA integrity_check;",
      "343: } {ok}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b1af9c603c70535a61b5785a4b29ce9cecc8f78d",
      "candidate_info": {
        "commit_hash": "b1af9c603c70535a61b5785a4b29ce9cecc8f78d",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/b1af9c603c70535a61b5785a4b29ce9cecc8f78d",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c"
        ],
        "message": "Progress handler improvements: (1) Invoke the callback after OP_Program opcodes (2) Invoke the callback multiple times in a row to catch up after a long run of no progress checks.\n\nFossilOrigin-Name: 0c5db18d79366d9c23925ce3ed835500311f32a10aa7dbfdd09148b1e8a2507b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fa792714ae62fa980f1767acc6d622a6727ceb677870243c88548423795dcb5b",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "823:     assert( db->nProgressOps!=0 );",
          "825:     if( db->xProgress(db->pProgressArg) ){",
          "826:       nProgressLimit = 0xffffffff;",
          "827:       rc = SQLITE_INTERRUPT;",
          "",
          "[Removed Lines]",
          "822:   if( nVmStep>=nProgressLimit && db->xProgress!=0 ){",
          "824:     nProgressLimit = nVmStep + db->nProgressOps - (nVmStep%db->nProgressOps);",
          "",
          "[Added Lines]",
          "822:   while( nVmStep>=nProgressLimit && db->xProgress!=0 ){",
          "824:     nProgressLimit += db->nProgressOps;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6174:   }",
          "6175: #endif",
          "6176:   pOp = &aOp[-1];",
          "6179: }",
          "",
          "[Removed Lines]",
          "6178:   break;",
          "",
          "[Added Lines]",
          "6177:   goto check_for_interrupt;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "7586: vdbe_return:",
          "7587: #ifndef SQLITE_OMIT_PROGRESS_CALLBACK",
          "7589:     if( db->xProgress(db->pProgressArg) ){",
          "7590:       nProgressLimit = 0xffffffff;",
          "7591:       rc = SQLITE_INTERRUPT;",
          "",
          "[Removed Lines]",
          "7588:   if( nVmStep>=nProgressLimit && db->xProgress!=0 ){",
          "",
          "[Added Lines]",
          "7587:   while( nVmStep>=nProgressLimit && db->xProgress!=0 ){",
          "7588:     nProgressLimit += db->nProgressOps;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5bf4644f41336f85f066d009d9f67c446b439ed0",
      "candidate_info": {
        "commit_hash": "5bf4644f41336f85f066d009d9f67c446b439ed0",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/5bf4644f41336f85f066d009d9f67c446b439ed0",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "Fix the \".open --hexdb\" command in the CLI so that it works even with terminal input.\n\nFossilOrigin-Name: 9b5d943426c9273162ecb4c561eb3b25e843318dd438239c882c9db50f788454",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 48889530a9de22fee536edfd1627be62396ed18d842d5fd6d91e010b4337be95",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "3877:   }else{",
          "3878:     in = p->in;",
          "3879:     nLine = p->lineno;",
          "3880:   }",
          "3882:   nLine++;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3880:     if( in==0 ) in = stdin;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4acd754c794d601c9825301580a5af5738befe92",
      "candidate_info": {
        "commit_hash": "4acd754c794d601c9825301580a5af5738befe92",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/4acd754c794d601c9825301580a5af5738befe92",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/select.c",
          "test/with1.test"
        ],
        "message": "If the query flattener detects an error, cause the SELECT code generator to abort immediately.\n\nFossilOrigin-Name: 3d3b142f1045080beb775a9cfe88ec143aa460750132e20059fd510291449850",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/select.c||src/select.c",
          "test/with1.test||test/with1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 9dbf512d1c4627a28d60f4e7238cb100d7a4e11f976139b07ad1c59e9b584c7d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/select.c||src/select.c": [
          "File: src/select.c -> src/select.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5743:     }",
          "5745:     if( flattenSubquery(pParse, p, i, isAgg) ){",
          "5747:       i = -1;",
          "5748:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5746:       if( pParse->nErr ) goto select_end;",
          "",
          "---------------"
        ],
        "test/with1.test||test/with1.test": [
          "File: test/with1.test -> test/with1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1089:      SELECT 3 FROM c,c,c,c,c,c,c,c,c",
          "1090:   )",
          "1091:   SELECT 4 FROM c,c,c,c,c,c,c,c,c;",
          "1094: finish_test",
          "",
          "[Removed Lines]",
          "1092: } {1 {at most 64 tables in a join}}",
          "",
          "[Added Lines]",
          "1092: } {1 {too many FROM clause terms, max: 200}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "993b48e2b7990d615616843224dd994fd4866d99",
      "candidate_info": {
        "commit_hash": "993b48e2b7990d615616843224dd994fd4866d99",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/993b48e2b7990d615616843224dd994fd4866d99",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/os_unix.c"
        ],
        "message": "Call ioctl() with the correct signature on both Android and stock Linux.\n\nFossilOrigin-Name: 2422534908a85a4cd11784e4c23a74ad121404f73dade587bf27efde1e2b982b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/os_unix.c||src/os_unix.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 52f463d29407fad691c42b13462880e7605603c9be9f480d18e953a0ef78149a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/os_unix.c||src/os_unix.c": [
          "File: src/os_unix.c -> src/os_unix.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "521: #if defined(__linux__) && defined(SQLITE_ENABLE_BATCH_ATOMIC_WRITE)",
          "522: # ifdef __ANDROID__",
          "523:   { \"ioctl\", (sqlite3_syscall_ptr)(int(*)(int, int, ...))ioctl, 0 },",
          "524: # else",
          "525:   { \"ioctl\",         (sqlite3_syscall_ptr)ioctl,          0 },",
          "526: # endif",
          "527: #else",
          "528:   { \"ioctl\",         (sqlite3_syscall_ptr)0,              0 },",
          "529: #endif",
          "",
          "[Removed Lines]",
          "530: #define osIoctl ((int(*)(int,int,...))aSyscall[28].pCurrent)",
          "",
          "[Added Lines]",
          "524: #define osIoctl ((int(*)(int,int,...))aSyscall[28].pCurrent)",
          "527: #define osIoctl ((int(*)(int,unsigned long,...))aSyscall[28].pCurrent)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a3fcc000cb7bd5b12816512834e6484c68658576",
      "candidate_info": {
        "commit_hash": "a3fcc000cb7bd5b12816512834e6484c68658576",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/a3fcc000cb7bd5b12816512834e6484c68658576",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "src/resolve.c",
          "src/sqliteInt.h",
          "src/window.c",
          "test/window9.test"
        ],
        "message": "Ensure that SQLite does not attempt to process incompatible window functions in a single scan. Fix for [256741a1].\n\nFossilOrigin-Name: 4f5b2d938194fab7627486e2ced633def2c90d9d3328e3700612feb9dbfa3d9a",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "src/resolve.c||src/resolve.c",
          "src/sqliteInt.h||src/sqliteInt.h",
          "src/window.c||src/window.c",
          "test/window9.test||test/window9.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b2e79f8ff0836fcc98a2df9377aad9137307c34058030ecd1b5d4ec3277ed36a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1325:     assert( pWin );",
          "1326:     assert( IsWindowFunc(pExpr) );",
          "1327:     assert( pWin->ppThis==0 );",
          "1334:   }",
          "1335:   return WRC_Continue;",
          "1336: }",
          "",
          "[Removed Lines]",
          "1328:     if( pSelect->pWin ){",
          "1329:       pSelect->pWin->ppThis = &pWin->pNextWin;",
          "1330:     }",
          "1331:     pWin->pNextWin = pSelect->pWin;",
          "1332:     pWin->ppThis = &pSelect->pWin;",
          "1333:     pSelect->pWin = pWin;",
          "",
          "[Added Lines]",
          "1328:     sqlite3WindowLink(pSelect, pWin);",
          "",
          "---------------"
        ],
        "src/resolve.c||src/resolve.c": [
          "File: src/resolve.c -> src/resolve.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "908:           sqlite3WalkExprList(pWalker, pWin->pPartition);",
          "909:           sqlite3WalkExprList(pWalker, pWin->pOrderBy);",
          "910:           sqlite3WalkExpr(pWalker, pWin->pFilter);",
          "921:           pNC->ncFlags |= NC_HasWin;",
          "922:         }else",
          "",
          "[Removed Lines]",
          "911:           if( 0==pSel->pWin",
          "912:            || 0==sqlite3WindowCompare(pParse, pSel->pWin, pWin, 0)",
          "913:           ){",
          "914:             pWin->pNextWin = pSel->pWin;",
          "915:             if( pSel->pWin ){",
          "916:               pSel->pWin->ppThis = &pWin->pNextWin;",
          "917:             }",
          "918:             pSel->pWin = pWin;",
          "919:             pWin->ppThis = &pSel->pWin;",
          "920:           }",
          "",
          "[Added Lines]",
          "911:           sqlite3WindowLink(pSel, pWin);",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "3609: void sqlite3WindowListDelete(sqlite3 *db, Window *p);",
          "3610: Window *sqlite3WindowAlloc(Parse*, int, int, Expr*, int , Expr*, u8);",
          "3611: void sqlite3WindowAttach(Parse*, Expr*, Window*);",
          "3612: int sqlite3WindowCompare(Parse*, Window*, Window*, int);",
          "3613: void sqlite3WindowCodeInit(Parse*, Window*);",
          "3614: void sqlite3WindowCodeStep(Parse*, Select*, WhereInfo*, int, int);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3612: void sqlite3WindowLink(Select *pSel, Window *pWin);",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1229:   }",
          "1230: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1238: void sqlite3WindowLink(Select *pSel, Window *pWin){",
          "1239:   if( 0==pSel->pWin",
          "1240:    || 0==sqlite3WindowCompare(0, pSel->pWin, pWin, 0)",
          "1241:   ){",
          "1242:     pWin->pNextWin = pSel->pWin;",
          "1243:     if( pSel->pWin ){",
          "1244:       pSel->pWin->ppThis = &pWin->pNextWin;",
          "1245:     }",
          "1246:     pSel->pWin = pWin;",
          "1247:     pWin->ppThis = &pSel->pWin;",
          "1248:   }",
          "1249: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1416:     int nArg = windowArgCount(pWin);",
          "1417:     int i;",
          "1419:     for(i=0; i<nArg; i++){",
          "1420:       if( i!=1 || pFunc->zName!=nth_valueName ){",
          "1421:         sqlite3VdbeAddOp3(v, OP_Column, csr, pWin->iArgCol+i, reg+i);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1438:     assert( bInverse==0 || pWin->eStart!=TK_UNBOUNDED );",
          "",
          "---------------"
        ],
        "test/window9.test||test/window9.test": [
          "File: test/window9.test -> test/window9.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "171:   } {~/ORDER/}",
          "172: }",
          "176: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "174: #-------------------------------------------------------------------------",
          "175: reset_db",
          "176: do_execsql_test 6.0 {",
          "177:   CREATE TABLE t0(c0);",
          "178:   INSERT INTO t0(c0) VALUES (0);",
          "179: }",
          "181: do_execsql_test 6.1 {",
          "182:   SELECT * FROM t0 WHERE",
          "183:   EXISTS (",
          "184:     SELECT MIN(c0) OVER (), CUME_DIST() OVER () FROM t0",
          "185:   ) >=1 AND",
          "186:   EXISTS (",
          "187:     SELECT MIN(c0) OVER (), CUME_DIST() OVER () FROM t0",
          "188:   ) <=1;",
          "189: } {0}",
          "191: do_execsql_test 6.2 {",
          "192:   SELECT * FROM t0 WHERE EXISTS (",
          "193:     SELECT MIN(c0) OVER (), CUME_DIST() OVER () FROM t0",
          "194:   )",
          "195:   BETWEEN 1 AND 1;",
          "196: } {0}",
          "",
          "---------------"
        ]
      }
    }
  ]
}