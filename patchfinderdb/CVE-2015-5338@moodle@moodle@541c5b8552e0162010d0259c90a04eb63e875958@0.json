{
  "cve_id": "CVE-2015-5338",
  "cve_desc": "Multiple cross-site request forgery (CSRF) vulnerabilities in the lesson module in Moodle through 2.6.11, 2.7.x before 2.7.11, 2.8.x before 2.8.9, and 2.9.x before 2.9.3 allow remote attackers to hijack the authentication of arbitrary users for requests to (1) mod/lesson/mediafile.php or (2) mod/lesson/view.php.",
  "repo": "moodle/moodle",
  "patch_hash": "541c5b8552e0162010d0259c90a04eb63e875958",
  "patch_info": {
    "commit_hash": "541c5b8552e0162010d0259c90a04eb63e875958",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/541c5b8552e0162010d0259c90a04eb63e875958",
    "files": [
      "mod/lesson/mediafile.php",
      "mod/lesson/renderer.php",
      "mod/lesson/view.php"
    ],
    "message": "MDL-48109 mod_lesson: prevent CSRF on password protected lesson\n\nThis commit add a new session key hidden field on the lesson password form\nand confirm if the session key is valid on related pages to prevent CSRF on\npassword protected lessons.",
    "before_after_code_files": [
      "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
      "mod/lesson/renderer.php||mod/lesson/renderer.php",
      "mod/lesson/view.php||mod/lesson/view.php"
    ]
  },
  "patch_diff": {
    "mod/lesson/mediafile.php||mod/lesson/mediafile.php": [
      "File: mod/lesson/mediafile.php -> mod/lesson/mediafile.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "87:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
      "88:         $correctpass = false;",
      "89:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
      "91:             $USER->lessonloggedin[$lesson->id] = true;",
      "92:             $correctpass = true;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "90:             require_sesskey();",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "95:             foreach ($lesson->extrapasswords as $password) {",
      "96:                 if (strcmp($password, md5(trim($userpassword))) === 0 || strcmp($password, trim($userpassword)) === 0) {",
      "97:                     $correctpass = true;",
      "98:                     $USER->lessonloggedin[$lesson->id] = true;",
      "99:                 }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "98:                     require_sesskey();",
      "",
      "---------------"
    ],
    "mod/lesson/renderer.php||mod/lesson/renderer.php": [
      "File: mod/lesson/renderer.php -> mod/lesson/renderer.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "113:         $output .=  '<form id=\"password\" method=\"post\" action=\"'.$CFG->wwwroot.'/mod/lesson/view.php\" autocomplete=\"off\">';",
      "114:         $output .=  '<fieldset class=\"invisiblefieldset center\">';",
      "115:         $output .=  '<input type=\"hidden\" name=\"id\" value=\"'. $this->page->cm->id .'\" />';",
      "116:         if ($failedattempt) {",
      "117:             $output .=  $this->output->notification(get_string('loginfail', 'lesson'));",
      "118:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "116:         $output .=  '<input type=\"hidden\" name=\"sesskey\" value=\"'.sesskey().'\" />';",
      "",
      "---------------"
    ],
    "mod/lesson/view.php||mod/lesson/view.php": [
      "File: mod/lesson/view.php -> mod/lesson/view.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "86:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
      "87:         $correctpass = false;",
      "88:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
      "90:             $correctpass = true;",
      "91:             $USER->lessonloggedin[$lesson->id] = true;",
      "93:         } else if (isset($lesson->extrapasswords)) {",
      "95:             foreach ($lesson->extrapasswords as $password) {",
      "96:                 if (strcmp($password, md5(trim($userpassword))) === 0 || strcmp($password, trim($userpassword)) === 0) {",
      "97:                     $correctpass = true;",
      "98:                     $USER->lessonloggedin[$lesson->id] = true;",
      "99:                 }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "89:             require_sesskey();",
      "99:                     require_sesskey();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "817cae1ac7ca748ba368439a40ef67d555774485",
      "candidate_info": {
        "commit_hash": "817cae1ac7ca748ba368439a40ef67d555774485",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/817cae1ac7ca748ba368439a40ef67d555774485",
        "files": [
          "mod/lesson/mediafile.php",
          "mod/lesson/renderer.php",
          "mod/lesson/view.php"
        ],
        "message": "MDL-48109 mod_lesson: prevent CSRF on password protected lesson\n\nThis commit add a new session key hidden field on the lesson password form\nand confirm if the session key is valid on related pages to prevent CSRF on\npassword protected lessons.",
        "before_after_code_files": [
          "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
          "mod/lesson/renderer.php||mod/lesson/renderer.php",
          "mod/lesson/view.php||mod/lesson/view.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ],
          "candidate": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/lesson/mediafile.php||mod/lesson/mediafile.php": [
          "File: mod/lesson/mediafile.php -> mod/lesson/mediafile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "89:         $correctpass = false;",
          "90:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "92:             $USER->lessonloggedin[$lesson->id] = true;",
          "93:             $correctpass = true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:             require_sesskey();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "100:             foreach ($lesson->extrapasswords as $password) {",
          "101:                 if (strcmp($password, md5(trim($userpassword))) === 0 || strcmp($password, trim($userpassword)) === 0) {",
          "102:                     $correctpass = true;",
          "103:                     $USER->lessonloggedin[$lesson->id] = true;",
          "104:                     if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:                     require_sesskey();",
          "",
          "---------------"
        ],
        "mod/lesson/renderer.php||mod/lesson/renderer.php": [
          "File: mod/lesson/renderer.php -> mod/lesson/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "113:         $output .=  '<form id=\"password\" method=\"post\" action=\"'.$CFG->wwwroot.'/mod/lesson/view.php\" autocomplete=\"off\">';",
          "114:         $output .=  '<fieldset class=\"invisiblefieldset center\">';",
          "115:         $output .=  '<input type=\"hidden\" name=\"id\" value=\"'. $this->page->cm->id .'\" />';",
          "116:         if ($failedattempt) {",
          "117:             $output .=  $this->output->notification(get_string('loginfail', 'lesson'));",
          "118:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116:         $output .=  '<input type=\"hidden\" name=\"sesskey\" value=\"'.sesskey().'\" />';",
          "",
          "---------------"
        ],
        "mod/lesson/view.php||mod/lesson/view.php": [
          "File: mod/lesson/view.php -> mod/lesson/view.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "88:         $correctpass = false;",
          "89:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "91:             $correctpass = true;",
          "92:             $USER->lessonloggedin[$lesson->id] = true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "90:             require_sesskey();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:                 redirect(\"$CFG->wwwroot/mod/lesson/view.php?id=$cm->id\");",
          "96:             }",
          "97:         } else if (isset($lesson->extrapasswords)) {",
          "99:             foreach ($lesson->extrapasswords as $password) {",
          "100:                 if (strcmp($password, md5(trim($userpassword))) === 0 || strcmp($password, trim($userpassword)) === 0) {",
          "101:                     $correctpass = true;",
          "102:                     $USER->lessonloggedin[$lesson->id] = true;",
          "103:                     if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "104:                     require_sesskey();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dcb42c9ed13b0c0ec2dde22b62ef69772d7725e6",
      "candidate_info": {
        "commit_hash": "dcb42c9ed13b0c0ec2dde22b62ef69772d7725e6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/dcb42c9ed13b0c0ec2dde22b62ef69772d7725e6",
        "files": [
          "mod/lesson/mediafile.php",
          "mod/lesson/renderer.php",
          "mod/lesson/view.php"
        ],
        "message": "MDL-48109 mod_lesson: prevent CSRF on lesson\n\nThis commit add a new session key hidden field on the lesson password form\nand confirm if the session key is valid on related pages to prevent CSRF on\npassword protected lessons.",
        "before_after_code_files": [
          "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
          "mod/lesson/renderer.php||mod/lesson/renderer.php",
          "mod/lesson/view.php||mod/lesson/view.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ],
          "candidate": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/lesson/mediafile.php||mod/lesson/mediafile.php": [
          "File: mod/lesson/mediafile.php -> mod/lesson/mediafile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "85:         $correctpass = false;",
          "86:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "88:             $USER->lessonloggedin[$lesson->id] = true;",
          "89:             if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87:             require_sesskey();",
          "",
          "---------------"
        ],
        "mod/lesson/renderer.php||mod/lesson/renderer.php": [
          "File: mod/lesson/renderer.php -> mod/lesson/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "113:         $output .=  '<form id=\"password\" method=\"post\" action=\"'.$CFG->wwwroot.'/mod/lesson/view.php\" autocomplete=\"off\">';",
          "114:         $output .=  '<fieldset class=\"invisiblefieldset center\">';",
          "115:         $output .=  '<input type=\"hidden\" name=\"id\" value=\"'. $this->page->cm->id .'\" />';",
          "116:         if ($failedattempt) {",
          "117:             $output .=  $this->output->notification(get_string('loginfail', 'lesson'));",
          "118:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116:         $output .=  '<input type=\"hidden\" name=\"sesskey\" value=\"'.sesskey().'\" />';",
          "",
          "---------------"
        ],
        "mod/lesson/view.php||mod/lesson/view.php": [
          "File: mod/lesson/view.php -> mod/lesson/view.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "84:         $correctpass = false;",
          "85:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "87:             $USER->lessonloggedin[$lesson->id] = true;",
          "88:             if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:             require_sesskey();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f75333766c7295932baa72a9dbe9542baf14e107",
      "candidate_info": {
        "commit_hash": "f75333766c7295932baa72a9dbe9542baf14e107",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f75333766c7295932baa72a9dbe9542baf14e107",
        "files": [
          "mod/lesson/mediafile.php",
          "mod/lesson/renderer.php",
          "mod/lesson/view.php"
        ],
        "message": "MDL-48109 mod_lesson: prevent CSRF on lesson\n\nThis commit add a new session key hidden field on the lesson password form\nand confirm if the session key is valid on related pages to prevent CSRF on\npassword protected lessons.",
        "before_after_code_files": [
          "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
          "mod/lesson/renderer.php||mod/lesson/renderer.php",
          "mod/lesson/view.php||mod/lesson/view.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ],
          "candidate": [
            "mod/lesson/mediafile.php||mod/lesson/mediafile.php",
            "mod/lesson/renderer.php||mod/lesson/renderer.php",
            "mod/lesson/view.php||mod/lesson/view.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/lesson/mediafile.php||mod/lesson/mediafile.php": [
          "File: mod/lesson/mediafile.php -> mod/lesson/mediafile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "85:         $correctpass = false;",
          "86:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "88:             $USER->lessonloggedin[$lesson->id] = true;",
          "89:             if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87:             require_sesskey();",
          "",
          "---------------"
        ],
        "mod/lesson/renderer.php||mod/lesson/renderer.php": [
          "File: mod/lesson/renderer.php -> mod/lesson/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "113:         $output .=  '<form id=\"password\" method=\"post\" action=\"'.$CFG->wwwroot.'/mod/lesson/view.php\" autocomplete=\"off\">';",
          "114:         $output .=  '<fieldset class=\"invisiblefieldset center\">';",
          "115:         $output .=  '<input type=\"hidden\" name=\"id\" value=\"'. $this->page->cm->id .'\" />';",
          "116:         if ($failedattempt) {",
          "117:             $output .=  $this->output->notification(get_string('loginfail', 'lesson'));",
          "118:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116:         $output .=  '<input type=\"hidden\" name=\"sesskey\" value=\"'.sesskey().'\" />';",
          "",
          "---------------"
        ],
        "mod/lesson/view.php||mod/lesson/view.php": [
          "File: mod/lesson/view.php -> mod/lesson/view.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:     } else if ($lesson->usepassword && empty($USER->lessonloggedin[$lesson->id])) { // Password protected lesson code",
          "84:         $correctpass = false;",
          "85:         if (!empty($userpassword) && (($lesson->password == md5(trim($userpassword))) || ($lesson->password == trim($userpassword)))) {",
          "87:             $USER->lessonloggedin[$lesson->id] = true;",
          "88:             if ($lesson->highscores) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:             require_sesskey();",
          "",
          "---------------"
        ]
      }
    }
  ]
}