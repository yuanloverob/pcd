{
  "cve_id": "CVE-2017-1000249",
  "cve_desc": "An issue in file() was introduced in commit 9611f31313a93aa036389c5f3b15eea53510d4d1 (Oct 2016) lets an attacker overwrite a fixed 20 bytes stack buffer with a specially crafted .notes section in an ELF binary. This was fixed in commit 35c94dc6acc418f1ad7f6241a6680e5327495793 (Aug 2017).",
  "repo": "file/file",
  "patch_hash": "9611f31313a93aa036389c5f3b15eea53510d4d1",
  "patch_info": {
    "commit_hash": "9611f31313a93aa036389c5f3b15eea53510d4d1",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/9611f31313a93aa036389c5f3b15eea53510d4d",
    "files": [
      "src/readelf.c"
    ],
    "message": "Extend build-id reporting to 8-byte IDs that lld can generate (Ed Maste)",
    "before_after_code_files": [
      "src/readelf.c||src/readelf.c"
    ]
  },
  "patch_diff": {
    "src/readelf.c||src/readelf.c": [
      "File: src/readelf.c -> src/readelf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: #include \"file.h\"",
      "29: #ifndef lint",
      "31: #endif",
      "33: #ifdef BUILTIN_ELF",
      "",
      "[Removed Lines]",
      "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.126 2015/11/16 16:03:45 christos Exp $\")",
      "",
      "[Added Lines]",
      "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.127 2015/11/18 12:29:29 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "509:     size_t noff, size_t doff, int *flags)",
      "510: {",
      "511:  if (namesz == 4 && strcmp((char *)&nbuf[noff], \"GNU\") == 0 &&",
      "513:   uint8_t desc[20];",
      "514:   uint32_t i;",
      "518:    return 1;",
      "519:   (void)memcpy(desc, &nbuf[doff], descsz);",
      "520:   for (i = 0; i < descsz; i++)",
      "",
      "[Removed Lines]",
      "512:      type == NT_GNU_BUILD_ID && (descsz == 16 || descsz == 20)) {",
      "516:   if (file_printf(ms, \", BuildID[%s]=\", descsz == 16 ? \"md5/uuid\" :",
      "517:       \"sha1\") == -1)",
      "",
      "[Added Lines]",
      "512:      type == NT_GNU_BUILD_ID && (descsz >= 4 || descsz <= 20)) {",
      "514:   const char *btype;",
      "517:   switch (descsz) {",
      "518:   case 8:",
      "519:       btype = \"xxHash\";",
      "520:       break;",
      "521:   case 16:",
      "522:       btype = \"md5/uuid\";",
      "523:       break;",
      "524:   case 20:",
      "525:       btype = \"sha1\";",
      "526:       break;",
      "527:   default:",
      "528:       btype = \"unknown\";",
      "529:       break;",
      "530:   }",
      "531:   if (file_printf(ms, \", BuildID[%s]=\", btype) == -1)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1507352bc5cbdebaa9f64f1c73876ec9d8a638bc",
      "candidate_info": {
        "commit_hash": "1507352bc5cbdebaa9f64f1c73876ec9d8a638bc",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/1507352bc5cbdebaa9f64f1c73876ec9d8a638bc",
        "files": [
          "src/readelf.c"
        ],
        "message": "keep \"[not] stripped\" last since some scripts expect it to be there.",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.131 2017/02/10 18:14:01 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.132 2017/02/11 18:12:03 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1373:   }",
          "1374:  }",
          "1378:  if (has_debug_info) {",
          "1379:   if (file_printf(ms, \", with debug_info\") == -1)",
          "1380:    return -1;",
          "1381:  }",
          "1382:  if (cap_hw1) {",
          "1383:   const cap_desc_t *cdp;",
          "1384:   switch (mach) {",
          "",
          "[Removed Lines]",
          "1376:  if (file_printf(ms, \", %sstripped\", stripped ? \"\" : \"not \") == -1)",
          "1377:   return -1;",
          "",
          "[Added Lines]",
          "1380:  if (file_printf(ms, \", %sstripped\", stripped ? \"\" : \"not \") == -1)",
          "1381:   return -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dd31ee984f88b4f7e4791f75488771ac1ffdfb2a",
      "candidate_info": {
        "commit_hash": "dd31ee984f88b4f7e4791f75488771ac1ffdfb2a",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/dd31ee984f88b4f7e4791f75488771ac1ffdfb2a",
        "files": [
          "src/readelf.c"
        ],
        "message": "PR/586: Add missing section headers info message.",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.127 2015/11/18 12:29:29 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.128 2016/10/04 21:43:10 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1204:  if (pread(fd, xsh_addr, xsh_sizeof, CAST(off_t, (off + size * strtab)))",
          "1205:      < (ssize_t)xsh_sizeof) {",
          "1208:  }",
          "1209:  name_off = xsh_offset;",
          "",
          "[Removed Lines]",
          "1206:   file_badread(ms);",
          "1207:   return -1;",
          "",
          "[Added Lines]",
          "1206:   if (file_printf(ms, \", missing section headers\") == -1)",
          "1207:    return -1;",
          "1208:   return 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "21d23cb1e803cc50361f68843891c474ba9e3a82",
      "candidate_info": {
        "commit_hash": "21d23cb1e803cc50361f68843891c474ba9e3a82",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/21d23cb1e803cc50361f68843891c474ba9e3a82",
        "files": [
          "src/readelf.c",
          "src/readelf.h"
        ],
        "message": "Don't try to parse auxv vector notes for non-svr4 style core files.",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c",
          "src/readelf.h||src/readelf.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.135 2017/03/29 15:58:12 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.136 2017/03/29 19:09:52 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "310:  \"NetBSD\",",
          "311: };",
          "324: private int",
          "325: dophn_core(struct magic_set *ms, int clazz, int swap, int fd, off_t off,",
          "",
          "[Removed Lines]",
          "313: #define FLAGS_DID_CORE   0x001",
          "314: #define FLAGS_DID_OS_NOTE  0x002",
          "315: #define FLAGS_DID_BUILD_ID  0x004",
          "316: #define FLAGS_DID_CORE_STYLE  0x008",
          "317: #define FLAGS_DID_NETBSD_PAX  0x010",
          "318: #define FLAGS_DID_NETBSD_MARCH  0x020",
          "319: #define FLAGS_DID_NETBSD_CMODEL  0x040",
          "320: #define FLAGS_DID_NETBSD_UNKNOWN 0x080",
          "321: #define FLAGS_IS_CORE   0x100",
          "322: #define FLAGS_DID_AUXV   0x200",
          "",
          "[Added Lines]",
          "313: #define FLAGS_CORE_STYLE  0x003",
          "315: #define FLAGS_DID_CORE   0x004",
          "316: #define FLAGS_DID_OS_NOTE  0x008",
          "317: #define FLAGS_DID_BUILD_ID  0x010",
          "318: #define FLAGS_DID_CORE_STYLE  0x020",
          "319: #define FLAGS_DID_NETBSD_PAX  0x040",
          "320: #define FLAGS_DID_NETBSD_MARCH  0x080",
          "321: #define FLAGS_DID_NETBSD_CMODEL  0x100",
          "322: #define FLAGS_DID_NETBSD_UNKNOWN 0x200",
          "323: #define FLAGS_IS_CORE   0x400",
          "324: #define FLAGS_DID_AUXV   0x800",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "921:  int is_string;",
          "922:  size_t nval;",
          "925:   return 0;",
          "929:  nval = 0;",
          "",
          "[Removed Lines]",
          "924:  if (type != NT_AUXV || (*flags & FLAGS_IS_CORE) == 0)",
          "",
          "[Added Lines]",
          "927:  if ((*flags & (FLAGS_IS_CORE|FLAGS_DID_CORE_STYLE)) !=",
          "928:      (FLAGS_IS_CORE|FLAGS_DID_CORE_STYLE))",
          "929:   return 0;",
          "931:  switch (*flags & FLAGS_CORE_STYLE) {",
          "932:  case OS_STYLE_SVR4:",
          "933:   if (type != NT_AUXV)",
          "934:    return 0;",
          "935:   break;",
          "936: #ifdef notyet",
          "937:  case OS_STYLE_NETBSD:",
          "938:   if (type != NT_NETBSD_CORE_AUXV)",
          "939:    return 0;",
          "940:   break;",
          "941:  case OS_STYLE_FREEBSD:",
          "942:   if (type != NT_FREEBSD_PROCSTAT_AUXV)",
          "943:    return 0;",
          "944:   break;",
          "945: #endif",
          "946:  default:",
          "948:  }",
          "",
          "---------------"
        ],
        "src/readelf.h||src/readelf.h": [
          "File: src/readelf.h -> src/readelf.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "356: #define NT_NETBSD_CMODEL 6",
          "358: #if !defined(ELFSIZE) && defined(ARCH_ELFSIZE)",
          "359: #define ELFSIZE ARCH_ELFSIZE",
          "360: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361: #define NT_FREEBSD_PROCSTAT_AUXV 16",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a07a37f70c460fd8dea973ba42ba518942e35fe0",
      "candidate_info": {
        "commit_hash": "a07a37f70c460fd8dea973ba42ba518942e35fe0",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/a07a37f70c460fd8dea973ba42ba518942e35fe0",
        "files": [
          "src/readelf.c"
        ],
        "message": "Allow repeated AUXV entries: https://github.com/torvalds/linux/blob/master/arch/powerpc/include/uapi/asm/elf.h#L174",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.125 2015/11/11 21:20:18 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.126 2015/11/16 16:03:45 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "908:  size_t elsize = xauxv_sizeof;",
          "909:  const char *tag;",
          "910:  int is_string;",
          "912:  size_t nval;",
          "914:  if (type != NT_AUXV || (*flags & FLAGS_IS_CORE) == 0)",
          "",
          "[Removed Lines]",
          "911:  uint64_t val[30];",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "919:  nval = 0;",
          "920:  for (size_t off = 0; off + elsize <= descsz; off += elsize) {",
          "921:   (void)memcpy(xauxv_addr, &nbuf[doff + off], xauxv_sizeof);",
          "929:    file_error(ms, 0, \"Too many ELF Auxv elements\");",
          "930:    return 1;",
          "931:   }",
          "934:   switch(xauxv_type) {",
          "935:   case AT_LINUX_EXECFN:",
          "",
          "[Removed Lines]",
          "922:   for (size_t i = 0; i < nval; i++)",
          "923:    if (val[i] == (uint64_t)xauxv_type) {",
          "924:     file_error(ms, 0, \"Repeated ELF Auxv type %ju\",",
          "925:         (uintmax_t)val[i]);",
          "926:     return 1;",
          "927:    }",
          "928:   if (nval >= __arraycount(val)) {",
          "932:   val[nval++] = (uint64_t)xauxv_type;",
          "",
          "[Added Lines]",
          "922:   if (nval++ >= 50) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b13be14bb0287ade1b244ff4a1b5dffa3a249b3e",
      "candidate_info": {
        "commit_hash": "b13be14bb0287ade1b244ff4a1b5dffa3a249b3e",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/b13be14bb0287ade1b244ff4a1b5dffa3a249b3e",
        "files": [
          "src/readelf.c",
          "src/readelf.h"
        ],
        "message": "add AUXV section processing (Jan Kaluza)",
        "before_after_code_files": [
          "src/readelf.c||src/readelf.c",
          "src/readelf.h||src/readelf.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/readelf.c||src/readelf.c"
          ],
          "candidate": [
            "src/readelf.c||src/readelf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.122 2015/09/10 13:59:32 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.123 2015/10/09 14:38:47 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "50: private int doshn(struct magic_set *, int, int, int, off_t, int, size_t,",
          "51:     off_t, int, int, int *, uint16_t *);",
          "52: private size_t donote(struct magic_set *, void *, size_t, size_t, int,",
          "55: #define ELF_ALIGN(a) ((((a) + align - 1) / align) * align)",
          "",
          "[Removed Lines]",
          "53:     int, size_t, int *, uint16_t *);",
          "",
          "[Added Lines]",
          "53:     int, size_t, int *, uint16_t *, int, off_t, int, off_t);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "177:        elf_getu32(swap, ph32.p_align) : 4) \\",
          "178:     : (off_t) (ph64.p_align ?  \\",
          "179:        elf_getu64(swap, ph64.p_align) : 4)))",
          "180: #define xph_filesz (size_t)((clazz == ELFCLASS32  \\",
          "181:     ? elf_getu32(swap, ph32.p_filesz) \\",
          "182:     : elf_getu64(swap, ph64.p_filesz)))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "180: #define xph_vaddr (size_t)((clazz == ELFCLASS32  \\",
          "181:     ? (off_t) (ph32.p_vaddr ?   \\",
          "182:        elf_getu32(swap, ph32.p_vaddr) : 4) \\",
          "183:     : (off_t) (ph64.p_vaddr ?  \\",
          "184:        elf_getu64(swap, ph64.p_vaddr) : 4)))",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "187:     ? elf_getu32(swap, ph32.p_memsz) \\",
          "188:     : elf_getu64(swap, ph64.p_memsz)))",
          "189: #define xnh_sizeof (clazz == ELFCLASS32   \\",
          "192: #define xnh_type (clazz == ELFCLASS32   \\",
          "193:     ? elf_getu32(swap, nh32.n_type) \\",
          "194:     : elf_getu32(swap, nh64.n_type))",
          "",
          "[Removed Lines]",
          "190:     ? sizeof nh32    \\",
          "191:     : sizeof nh64)",
          "",
          "[Added Lines]",
          "195:     ? sizeof(nh32)    \\",
          "196:     : sizeof(nh64))",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "213: #define xcap_val (clazz == ELFCLASS32   \\",
          "214:     ? elf_getu32(swap, cap32.c_un.c_val) \\",
          "215:     : elf_getu64(swap, cap64.c_un.c_val))",
          "217: #ifdef ELFCORE",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "221: #define xauxv_addr (clazz == ELFCLASS32   \\",
          "222:     ? (void *)&auxv32   \\",
          "223:     : (void *)&auxv64)",
          "224: #define xauxv_sizeof (clazz == ELFCLASS32   \\",
          "225:     ? sizeof(auxv32)   \\",
          "226:     : sizeof(auxv64))",
          "227: #define xauxv_type (clazz == ELFCLASS32   \\",
          "228:     ? elf_getu32(swap, auxv32.a_type) \\",
          "229:     : elf_getu64(swap, auxv64.a_type))",
          "230: #define xauxv_val (clazz == ELFCLASS32   \\",
          "231:     ? elf_getu32(swap, auxv32.a_v)  \\",
          "232:     : elf_getu64(swap, auxv64.a_v))",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "302: #define FLAGS_DID_NETBSD_CMODEL  0x040",
          "303: #define FLAGS_DID_NETBSD_UNKNOWN 0x080",
          "304: #define FLAGS_IS_CORE   0x100",
          "306: private int",
          "307: dophn_core(struct magic_set *ms, int clazz, int swap, int fd, off_t off,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "322: #define FLAGS_DID_AUXV   0x200",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "312:  size_t offset, len;",
          "313:  unsigned char nbuf[BUFSIZ];",
          "314:  ssize_t bufsize;",
          "316:  if (size != xph_sizeof) {",
          "317:   if (file_printf(ms, \", corrupted program header size\") == -1)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "333:  off_t ph_off = off;",
          "334:  int ph_num = num;",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "351:    if (offset >= (size_t)bufsize)",
          "352:     break;",
          "353:    offset = donote(ms, nbuf, offset, (size_t)bufsize,",
          "355:    if (offset == 0)",
          "356:     break;",
          "",
          "[Removed Lines]",
          "354:        clazz, swap, 4, flags, notecount);",
          "",
          "[Added Lines]",
          "374:        clazz, swap, 4, flags, notecount, fd, ph_off,",
          "375:        ph_num, fsize);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "813:  return 0;",
          "814: }",
          "816: private size_t",
          "817: donote(struct magic_set *ms, void *vbuf, size_t offset, size_t size,",
          "819: {",
          "820:  Elf32_Nhdr nh32;",
          "821:  Elf64_Nhdr nh64;",
          "",
          "[Removed Lines]",
          "818:     int clazz, int swap, size_t align, int *flags, uint16_t *notecount)",
          "",
          "[Added Lines]",
          "837: private off_t",
          "838: get_offset_from_virtaddr(struct magic_set *ms, int swap, int clazz, int fd,",
          "839:     off_t off, int num, off_t fsize, uint64_t virtaddr)",
          "840: {",
          "841:  Elf32_Phdr ph32;",
          "842:  Elf64_Phdr ph64;",
          "843:  size_t prev_vaddr = 0;",
          "844:  size_t prev_off = 0;",
          "850:  for ( ; num; num--) {",
          "851:   if (pread(fd, xph_addr, xph_sizeof, off) < (ssize_t)xph_sizeof) {",
          "852:    file_badread(ms);",
          "853:    return -1;",
          "854:   }",
          "855:   off += xph_sizeof;",
          "857:   if (fsize != SIZE_UNKNOWN && xph_offset > fsize) {",
          "859:    continue;",
          "860:   }",
          "862:   if (virtaddr >= prev_vaddr && virtaddr < xph_vaddr) {",
          "867:    return prev_off + (virtaddr - prev_vaddr);",
          "868:   }",
          "870:   prev_vaddr = xph_vaddr;",
          "871:   prev_off = xph_offset;",
          "873:  }",
          "874:  return 0;",
          "875: }",
          "877: private size_t",
          "878: get_string_on_virtaddr(struct magic_set *ms,",
          "879:     int swap, int clazz, int fd, off_t ph_off, int ph_num,",
          "880:     off_t fsize, uint64_t virtaddr, char *buf, ssize_t buflen)",
          "881: {",
          "882:  char *bptr;",
          "883:  off_t offset;",
          "885:  if (buflen == 0)",
          "886:   return 0;",
          "888:  offset = get_offset_from_virtaddr(ms, swap, clazz, fd, ph_off, ph_num,",
          "889:      fsize, virtaddr);",
          "890:  if (pread(fd, buf, buflen, offset) != buflen) {",
          "891:   file_badread(ms);",
          "892:   return 0;",
          "893:  }",
          "895:  buf[buflen - 1] = '\\0';",
          "899:  for (bptr = buf; *bptr && isprint((unsigned char)*bptr); bptr++)",
          "900:   continue;",
          "901:  if (*bptr != '\\0')",
          "902:   return 0;",
          "904:  return bptr - buf;",
          "905: }",
          "908: private int",
          "909: do_auxv_note(struct magic_set *ms, unsigned char *nbuf, uint32_t type,",
          "910:     int swap, uint32_t namesz __attribute__((__unused__)),",
          "911:     uint32_t descsz __attribute__((__unused__)),",
          "912:     size_t noff __attribute__((__unused__)), size_t doff,",
          "913:     int *flags, size_t size __attribute__((__unused__)), int clazz,",
          "914:     int fd, off_t ph_off, int ph_num, off_t fsize)",
          "915: {",
          "916: #ifdef ELFCORE",
          "917:  Aux32Info auxv32;",
          "918:  Aux64Info auxv64;",
          "919:  size_t elsize = xauxv_sizeof;",
          "920:  const char *tag;",
          "921:  int is_string;",
          "922:  uint32_t val[30];",
          "923:  size_t nval;",
          "925:  if (type != NT_AUXV || (*flags & FLAGS_IS_CORE) == 0)",
          "926:   return 0;",
          "930:  nval = 0;",
          "931:  for (size_t off = 0; off + elsize <= descsz; off += elsize) {",
          "932:   (void)memcpy(xauxv_addr, &nbuf[doff + off], xauxv_sizeof);",
          "933:   for (size_t i = 0; i < nval; i++)",
          "934:    if (val[i] == (uint32_t)xauxv_type) {",
          "935:     file_error(ms, 0, \"Repeated ELF Auxv type %u\",",
          "936:         val[i]);",
          "937:     return 1;",
          "938:    }",
          "939:   if (nval >= __arraycount(val)) {",
          "940:    file_error(ms, 0, \"Too many ELF Auxv elements\");",
          "941:    return 1;",
          "942:   }",
          "943:   val[nval++] = (uint32_t)xauxv_type;",
          "945:   switch(xauxv_type) {",
          "946:   case AT_LINUX_EXECFN:",
          "947:    is_string = 1;",
          "948:    tag = \"from\";",
          "949:    break;",
          "950:   case AT_LINUX_PLATFORM:",
          "951:    is_string = 1;",
          "952:    tag = \"platform\";",
          "953:    break;",
          "954:   case AT_LINUX_UID:",
          "955:    is_string = 0;",
          "956:    tag = \"real uid\";",
          "957:    break;",
          "958:   case AT_LINUX_GID:",
          "959:    is_string = 0;",
          "960:    tag = \"real gid\";",
          "961:    break;",
          "962:   case AT_LINUX_EUID:",
          "963:    is_string = 0;",
          "964:    tag = \"effective uid\";",
          "965:    break;",
          "966:   case AT_LINUX_EGID:",
          "967:    is_string = 0;",
          "968:    tag = \"effective gid\";",
          "969:    break;",
          "970:   default:",
          "971:    is_string = 0;",
          "972:    tag = NULL;",
          "973:    break;",
          "974:   }",
          "976:   if (tag == NULL)",
          "977:    continue;",
          "979:   if (is_string) {",
          "980:    char buf[256];",
          "981:    ssize_t buflen;",
          "982:    buflen = get_string_on_virtaddr(ms, swap, clazz, fd,",
          "983:        ph_off, ph_num, fsize, xauxv_val, buf, sizeof(buf));",
          "985:    if (buflen == 0)",
          "986:     continue;",
          "988:    if (file_printf(ms, \", %s: '%s'\", tag, buf) == -1)",
          "989:     return 0;",
          "990:   } else {",
          "991:    if (file_printf(ms, \", %s: %d\", tag, (int) xauxv_val)",
          "992:        == -1)",
          "993:     return 0;",
          "994:   }",
          "995:  }",
          "996:  return 1;",
          "997: #else",
          "998:  return 0;",
          "999: #endif",
          "1000: }",
          "1004:     int clazz, int swap, size_t align, int *flags, uint16_t *notecount,",
          "1005:     int fd, off_t ph_off, int ph_num, off_t fsize)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "900:    return offset;",
          "901:  }",
          "903:  if (namesz == 7 && strcmp((char *)&nbuf[noff], \"NetBSD\") == 0) {",
          "904:   if (descsz > 100)",
          "905:    descsz = 100;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1091:  if ((*flags & FLAGS_DID_AUXV) == 0) {",
          "1092:   if (do_auxv_note(ms, nbuf, xnh_type, swap,",
          "1093:    namesz, descsz, noff, doff, flags, size, clazz,",
          "1094:    fd, ph_off, ph_num, fsize))",
          "1095:    return offset;",
          "1096:  }",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1080:     if (noff >= (off_t)xsh_size)",
          "1081:      break;",
          "1082:     noff = donote(ms, nbuf, (size_t)noff,",
          "1084:     if (noff == 0)",
          "1085:      break;",
          "1086:    }",
          "",
          "[Removed Lines]",
          "1083:         xsh_size, clazz, swap, 4, flags, notecount);",
          "",
          "[Added Lines]",
          "1278:         xsh_size, clazz, swap, 4, flags, notecount,",
          "1279:         fd, 0, 0, 0);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1329:      break;",
          "1330:     offset = donote(ms, nbuf, offset,",
          "1331:         (size_t)bufsize, clazz, swap, align,",
          "1333:     if (offset == 0)",
          "1334:      break;",
          "1335:    }",
          "",
          "[Removed Lines]",
          "1332:         flags, notecount);",
          "",
          "[Added Lines]",
          "1528:         flags, notecount, fd, 0, 0, 0);",
          "",
          "---------------"
        ],
        "src/readelf.h||src/readelf.h": [
          "File: src/readelf.h -> src/readelf.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "54: #define EI_NIDENT 16",
          "56: typedef struct {",
          "57:     Elf32_Char e_ident[EI_NIDENT];",
          "58:     Elf32_Half e_type;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56: typedef struct {",
          "59: } Aux32Info;",
          "61: typedef struct {",
          "64: } Aux64Info;",
          "86: #define AT_LINUX_BASE_PLATFORM 24     /* string identifying real platform, may",
          "",
          "---------------"
        ]
      }
    }
  ]
}