{
  "cve_id": "CVE-2021-29617",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can cause a denial of service via `CHECK`-fail in `tf.strings.substr` with invalid arguments. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "890f7164b70354c57d40eda52dcdd7658677c09f",
  "patch_info": {
    "commit_hash": "890f7164b70354c57d40eda52dcdd7658677c09f",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/890f7164b70354c57d40eda52dcdd7658677c09f",
    "files": [
      "tensorflow/core/kernels/substr_op.cc",
      "tensorflow/python/kernel_tests/substr_op_test.py"
    ],
    "message": "Merge pull request #46974 from yongtang:46900-tf.strings.substr\n\nPiperOrigin-RevId: 356520125\nChange-Id: Ifd11ff02aa51023007201dccfa02eb8213c08f7a",
    "before_after_code_files": [
      "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc",
      "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc": [
      "File: tensorflow/core/kernels/substr_op.cc -> tensorflow/core/kernels/substr_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:     const Tensor& len_tensor = context->input(2);",
      "52:     const TensorShape& input_shape = input_tensor.shape();",
      "53:     const TensorShape& pos_shape = pos_tensor.shape();",
      "55:     bool is_scalar = TensorShapeUtils::IsScalar(pos_shape);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "54:     const TensorShape& len_shape = len_tensor.shape();",
      "55:     OP_REQUIRES(context, (pos_shape == len_shape),",
      "56:                 errors::InvalidArgument(",
      "57:                     \"pos and len should have the same shape, got: \",",
      "58:                     pos_shape.DebugString(), \" vs. \", len_shape.DebugString()));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py": [
      "File: tensorflow/python/kernel_tests/substr_op_test.py -> tensorflow/python/kernel_tests/substr_op_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "492:       with self.assertRaises(ValueError):",
      "493:         string_ops.substr(b\"test\", 3, 1, unit=\"UTF8\")",
      "496: if __name__ == \"__main__\":",
      "497:   test.main()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "495:   def testInvalidPos(self):",
      "496:     # Test case for GitHub issue 46900.",
      "497:     with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
      "498:       x = string_ops.substr(b\"abc\", len=1, pos=[1, -1])",
      "499:       self.evaluate(x)",
      "501:     with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
      "502:       x = string_ops.substr(b\"abc\", len=1, pos=[1, 2])",
      "503:       self.evaluate(x)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7edb8c9b83ad583616406af61e0de61393996a3e",
      "candidate_info": {
        "commit_hash": "7edb8c9b83ad583616406af61e0de61393996a3e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/7edb8c9b83ad583616406af61e0de61393996a3e",
        "files": [
          "tensorflow/core/kernels/substr_op.cc",
          "tensorflow/python/kernel_tests/substr_op_test.py"
        ],
        "message": "Fix crash of tf.strings.substr when pos and len have different shapes\n\nThis PR tries to address the issue raised in 46900 where\ntf.strings.substr will crash when pos and len have different shapes.\nAccording to the documentation of tf.strings.substr, ValueError\nshould be raised instead when pos and len does not have the same shape.\n\nThis PR add shape check in kernel to allows grace error throw (instead of crash).\n\nThis PR fixes 46900.\n\nSigned-off-by: Yong Tang <yong.tang.github@outlook.com>",
        "before_after_code_files": [
          "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc",
          "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/tensorflow/tensorflow/pull/46974"
        ],
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc",
            "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc",
            "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/substr_op.cc||tensorflow/core/kernels/substr_op.cc": [
          "File: tensorflow/core/kernels/substr_op.cc -> tensorflow/core/kernels/substr_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     const Tensor& len_tensor = context->input(2);",
          "52:     const TensorShape& input_shape = input_tensor.shape();",
          "53:     const TensorShape& pos_shape = pos_tensor.shape();",
          "55:     bool is_scalar = TensorShapeUtils::IsScalar(pos_shape);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     const TensorShape& len_shape = len_tensor.shape();",
          "55:     OP_REQUIRES(",
          "56:         context, (pos_shape == len_shape),",
          "57:         errors::InvalidArgument(\"pos and len should have the same shape, got: \",",
          "58:                                 pos_shape.DebugString(), \" vs. \",",
          "59:                                 len_shape.DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/substr_op_test.py||tensorflow/python/kernel_tests/substr_op_test.py": [
          "File: tensorflow/python/kernel_tests/substr_op_test.py -> tensorflow/python/kernel_tests/substr_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "492:       with self.assertRaises(ValueError):",
          "493:         string_ops.substr(b\"test\", 3, 1, unit=\"UTF8\")",
          "496: if __name__ == \"__main__\":",
          "497:   test.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "495:   def testInvalidPos(self):",
          "496:     # Test case for GitHub issue 46900.",
          "497:     with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
          "498:       x = string_ops.substr(b\"abc\", len=1, pos=[1, -1])",
          "499:       self.evaluate(x)",
          "501:     with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
          "502:       x = string_ops.substr(b\"abc\", len=1, pos=[1, 2])",
          "503:       self.evaluate(x)",
          "",
          "---------------"
        ]
      }
    }
  ]
}