{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "37b81f21cb175282a21feb18252417373ba069c5",
      "candidate_info": {
        "commit_hash": "37b81f21cb175282a21feb18252417373ba069c5",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/37b81f21cb175282a21feb18252417373ba069c5",
        "files": [
          "ChangeLog",
          "bindings/java/capstone/Arm.java"
        ],
        "message": "Java: Fix a bug where Arm.OpInfo.memBarrier and Arm.OpInfo.op is wrongly calculated",
        "before_after_code_files": [
          "bindings/javcapstone/Arm.java||bindings/java/capstone/Arm.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javcapstone/Arm.java||bindings/java/capstone/Arm.java": [
          "File: bindings/javcapstone/Arm.java -> bindings/java/capstone/Arm.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "96:     public int mem_barrier;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8e9519c56a3a1bb014983963832595bb1310b73f",
      "candidate_info": {
        "commit_hash": "8e9519c56a3a1bb014983963832595bb1310b73f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/8e9519c56a3a1bb014983963832595bb1310b73f",
        "files": [
          "include/capstone/mips.h"
        ],
        "message": "fix merge error",
        "before_after_code_files": [
          "include/capstone/mips.h||include/capstone/mips.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/capstone/mips.h||include/capstone/mips.h": [
          "File: include/capstone/mips.h -> include/capstone/mips.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: extern \"C\" {",
          "9: #endif",
          "18: #include \"platform.h\"",
          "",
          "[Removed Lines]",
          "11: <<<<<<< HEAD",
          "12: #if !defined(_MSC_VER) || !defined(_KERNEL_MODE)",
          "13: #include <stdint.h>",
          "14: #endif",
          "16: =======",
          "17: >>>>>>> upstream/next",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7925323569769659cb21e3b0d7a2f02ad02e87e3",
      "candidate_info": {
        "commit_hash": "7925323569769659cb21e3b0d7a2f02ad02e87e3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/7925323569769659cb21e3b0d7a2f02ad02e87e3",
        "files": [
          "arch/AArch64/AArch64GenAsmWriter.inc"
        ],
        "message": "Bug fix for incorrect operand type in certain load/store instructions on AArch64. (#952)",
        "before_after_code_files": [
          "arch/AArch64/AArch64GenAsmWriter.inc||arch/AArch64/AArch64GenAsmWriter.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/AArch64/AArch64GenAsmWriter.inc||arch/AArch64/AArch64GenAsmWriter.inc": [
          "File: arch/AArch64/AArch64GenAsmWriter.inc -> arch/AArch64/AArch64GenAsmWriter.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "12578:   if (*AsmOps) {",
          "12579:     SStream_concat0(OS, \"\\t\");",
          "12580:     for (c = AsmOps; *c; c++) {",
          "12582:         c += 1;",
          "12583:         if (*c == (char)0xff) {",
          "12584:           c += 1;",
          "",
          "[Removed Lines]",
          "12581:       if (*c == '$') {",
          "",
          "[Added Lines]",
          "12581:       if (*c == '[') {",
          "12582:         SStream_concat0(OS, \"[\");",
          "12583:         set_mem_access(MI, true);",
          "12584:       }",
          "12585:       else if (*c == ']') {",
          "12586:         SStream_concat0(OS, \"]\");",
          "12587:         set_mem_access(MI, false);",
          "12588:       }",
          "12589:       else if (*c == '$') {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
      "candidate_info": {
        "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
        "files": [
          "windows/winkernel_mm.c"
        ],
        "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
        "before_after_code_files": [
          "windows/winkernel_mm.c||windows/winkernel_mm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "windows/winkernel_mm.c||windows/winkernel_mm.c": [
          "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: #include \"winkernel_mm.h\"",
          "5: #include <ntddk.h>",
          "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6: #include <Ntintsafe.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
          "38:  if (!block) {",
          "39:   return NULL;",
          "40:  }",
          "",
          "[Removed Lines]",
          "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
          "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
          "",
          "[Added Lines]",
          "37:  size_t number_of_bytes = 0;",
          "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
          "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
          "43:   return NULL;",
          "44:  }",
          "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
          "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3239acea18dd8abb2d6c3743e85bef2e54d07656",
      "candidate_info": {
        "commit_hash": "3239acea18dd8abb2d6c3743e85bef2e54d07656",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/3239acea18dd8abb2d6c3743e85bef2e54d07656",
        "files": [
          "pkgconfig.mk"
        ],
        "message": "bump package version to 3.0.5",
        "before_after_code_files": [
          "pkgconfig.mk||pkgconfig.mk"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "pkgconfig.mk||pkgconfig.mk": [
          "File: pkgconfig.mk -> pkgconfig.mk",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: PKG_MINOR = 0",
          "8: # version bugfix level. Example: PKG_EXTRA = 1",
          "",
          "[Removed Lines]",
          "9: PKG_EXTRA = 4",
          "",
          "[Added Lines]",
          "9: PKG_EXTRA = 5",
          "",
          "---------------"
        ]
      }
    }
  ]
}