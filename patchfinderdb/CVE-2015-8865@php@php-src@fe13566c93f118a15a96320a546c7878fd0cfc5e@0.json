{
  "cve_id": "CVE-2015-8865",
  "cve_desc": "The file_check_mem function in funcs.c in file before 5.23, as used in the Fileinfo component in PHP before 5.5.34, 5.6.x before 5.6.20, and 7.x before 7.0.5, mishandles continuation-level jumps, which allows context-dependent attackers to cause a denial of service (buffer overflow and application crash) or possibly execute arbitrary code via a crafted magic file.",
  "repo": "php/php-src",
  "patch_hash": "fe13566c93f118a15a96320a546c7878fd0cfc5e",
  "patch_info": {
    "commit_hash": "fe13566c93f118a15a96320a546c7878fd0cfc5e",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/fe13566c93f118a15a96320a546c7878fd0cfc5e",
    "files": [
      "ext/fileinfo/libmagic/funcs.c",
      "ext/fileinfo/tests/bug71527.magic",
      "ext/fileinfo/tests/bug71527.phpt"
    ],
    "message": "Fixed bug #71527 Buffer over-write in finfo_open with malformed magic file\n\nThe actual fix is applying the upstream patch from\nhttps://github.com/file/file/commit/6713ca45e7757297381f4b4cdb9cf5e624a9ad36",
    "before_after_code_files": [
      "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
      "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
      "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
    ]
  },
  "patch_diff": {
    "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c": [
      "File: ext/fileinfo/libmagic/funcs.c -> ext/fileinfo/libmagic/funcs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "414:  size_t len;",
      "416:  if (level >= ms->c.len) {",
      "418:   ms->c.li = CAST(struct level_info *, (ms->c.li == NULL) ?",
      "419:       emalloc(len) :",
      "420:       erealloc(ms->c.li, len));",
      "",
      "[Removed Lines]",
      "417:   len = (ms->c.len += 20) * sizeof(*ms->c.li);",
      "",
      "[Added Lines]",
      "417:   len = (ms->c.len += 20 + level) * sizeof(*ms->c.li);",
      "",
      "---------------"
    ],
    "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic": [
      "File: ext/fileinfo/tests/bug71527.magic -> ext/fileinfo/tests/bug71527.magic",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>",
      "",
      "---------------"
    ],
    "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt": [
      "File: ext/fileinfo/tests/bug71527.phpt -> ext/fileinfo/tests/bug71527.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #71527 Buffer over-write in finfo_open with malformed magic file",
      "3: --SKIPIF--",
      "4: <?php",
      "5: if (!class_exists('finfo'))",
      "6:  die('skip no fileinfo extension');",
      "7: --ENV--",
      "8: USE_ZEND_ALLOC=0",
      "9: --FILE--",
      "10: <?php",
      "11:  $finfo = finfo_open(FILEINFO_NONE, dirname(__FILE__) . DIRECTORY_SEPARATOR . \"bug71527.magic\");",
      "12:  $info = finfo_file($finfo, __FILE__);",
      "13:  var_dump($info);",
      "14: ?>",
      "15: --EXPECTF--",
      "16: Warning: finfo_open(): Failed to load magic database at '%sbug71527.magic'. in %sbug71527.php on line %d",
      "18: Warning: finfo_file() expects parameter 1 to be resource, boolean given in %sbug71527.php on line %d",
      "19: bool(false)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e93c6910fceb62d19fe143e351a86eee8df9b456",
      "candidate_info": {
        "commit_hash": "e93c6910fceb62d19fe143e351a86eee8df9b456",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/e93c6910fceb62d19fe143e351a86eee8df9b456",
        "files": [
          "ext/fileinfo/libmagic/funcs.c",
          "ext/fileinfo/tests/bug68996.phpt",
          "ext/fileinfo/tests/bug71527.magic",
          "ext/fileinfo/tests/bug71527.phpt"
        ],
        "message": "Fixed bug #71527 Buffer over-write in finfo_open with malformed magic file\n\nThe actual fix is applying the upstream patch from\nhttps://github.com/file/file/commit/6713ca45e7757297381f4b4cdb9cf5e624a9ad36",
        "before_after_code_files": [
          "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
          "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt",
          "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
          "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
            "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
            "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
          ],
          "candidate": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
            "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
            "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c": [
          "File: ext/fileinfo/libmagic/funcs.c -> ext/fileinfo/libmagic/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "403:  size_t len;",
          "405:  if (level >= ms->c.len) {",
          "407:   ms->c.li = CAST(struct level_info *, (ms->c.li == NULL) ?",
          "408:       emalloc(len) :",
          "409:       erealloc(ms->c.li, len));",
          "",
          "[Removed Lines]",
          "406:   len = (ms->c.len += 20) * sizeof(*ms->c.li);",
          "",
          "[Added Lines]",
          "406:   len = (ms->c.len += 20 + level) * sizeof(*ms->c.li);",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt": [
          "File: ext/fileinfo/tests/bug68996.phpt -> ext/fileinfo/tests/bug68996.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "2: Bug #68996 (Invalid free of CG(interned_empty_string))",
          "3: --SKIPIF--",
          "9: <?php require_once(dirname(__FILE__) . '/skipif.inc'); ?>",
          "10: --INI--",
          "11: html_errors=1",
          "12: --FILE--",
          "13: <?php",
          "14: finfo_open(FILEINFO_MIME_TYPE, \"\\xfc\\x63\");",
          "",
          "[Removed Lines]",
          "4: <?php",
          "5: if (getenv(\"USE_ZEND_ALLOC\") !== \"0\") {",
          "6:     print \"skip Need Zend MM disabled\";",
          "7: }",
          "8: ?>",
          "",
          "[Added Lines]",
          "7: --ENV--",
          "8: USE_ZEND_ALLOC=0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19: <br />",
          "20: <b>Warning</b>:  : failed to open stream: No such file or directory in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "21: <br />",
          "",
          "[Removed Lines]",
          "22: <b>Warning</b>:  finfo_open():  in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "[Added Lines]",
          "19: <b>Warning</b>:  finfo_open(): Failed to load magic database at '%s\ufffdc'. in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic": [
          "File: ext/fileinfo/tests/bug71527.magic -> ext/fileinfo/tests/bug71527.magic",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt": [
          "File: ext/fileinfo/tests/bug71527.phpt -> ext/fileinfo/tests/bug71527.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #71527 Buffer over-write in finfo_open with malformed magic file",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!class_exists('finfo'))",
          "6:  die('skip no fileinfo extension');",
          "7: --ENV--",
          "8: USE_ZEND_ALLOC=0",
          "9: --FILE--",
          "10: <?php",
          "11:  $finfo = finfo_open(FILEINFO_NONE, dirname(__FILE__) . DIRECTORY_SEPARATOR . \"bug71527.magic\");",
          "12:  $info = finfo_file($finfo, __FILE__);",
          "13:  var_dump($info);",
          "14: ?>",
          "15: --EXPECTF--",
          "16: Warning: finfo_open(): Failed to load magic database at '%sbug71527.magic'. in %sbug71527.php on line %d",
          "18: Warning: finfo_file() expects parameter 1 to be resource, boolean given in %sbug71527.php on line %d",
          "19: bool(false)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5272184a1ed0c5c6144e80bed6fb1951601ec3bc",
      "candidate_info": {
        "commit_hash": "5272184a1ed0c5c6144e80bed6fb1951601ec3bc",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/5272184a1ed0c5c6144e80bed6fb1951601ec3bc",
        "files": [
          "ext/fileinfo/tests/bug68996.phpt"
        ],
        "message": "Fixed bug #71527 Buffer over-write in finfo_open with malformed magic file\n\nThe actual fix is applying the upstream patch from\nhttps://github.com/file/file/commit/6713ca45e7757297381f4b4cdb9cf5e624a9ad36",
        "before_after_code_files": [
          "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt": [
          "File: ext/fileinfo/tests/bug68996.phpt -> ext/fileinfo/tests/bug68996.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "2: Bug #68996 (Invalid free of CG(interned_empty_string))",
          "3: --SKIPIF--",
          "9: <?php require_once(dirname(__FILE__) . '/skipif.inc'); ?>",
          "10: --INI--",
          "11: html_errors=1",
          "12: --FILE--",
          "13: <?php",
          "14: finfo_open(FILEINFO_MIME_TYPE, \"\\xfc\\x63\");",
          "",
          "[Removed Lines]",
          "4: <?php",
          "5: if (getenv(\"USE_ZEND_ALLOC\") !== \"0\") {",
          "6:     print \"skip Need Zend MM disabled\";",
          "7: }",
          "8: ?>",
          "",
          "[Added Lines]",
          "7: --ENV--",
          "8: USE_ZEND_ALLOC=0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19: <br />",
          "20: <b>Warning</b>:  : failed to open stream: No such file or directory in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "21: <br />",
          "",
          "[Removed Lines]",
          "22: <b>Warning</b>:  finfo_open():  in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "[Added Lines]",
          "19: <b>Warning</b>:  finfo_open(): Failed to load magic database at '%s\ufffdc'. in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4b0b1cec00d5c261a5eb4032862da917f93e87b7",
      "candidate_info": {
        "commit_hash": "4b0b1cec00d5c261a5eb4032862da917f93e87b7",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/4b0b1cec00d5c261a5eb4032862da917f93e87b7",
        "files": [
          "ext/fileinfo/libmagic/funcs.c"
        ],
        "message": "fix borked mainstream patch",
        "before_after_code_files": [
          "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c"
          ],
          "candidate": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c": [
          "File: ext/fileinfo/libmagic/funcs.c -> ext/fileinfo/libmagic/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "414:  size_t len;",
          "416:  if (level >= ms->c.len) {",
          "418:   ms->c.li = CAST(struct level_info *, (ms->c.li == NULL) ?",
          "419:       emalloc(len) :",
          "420:       erealloc(ms->c.li, len));",
          "",
          "[Removed Lines]",
          "417:   len = (ms->c.len += 20 + level) * sizeof(*ms->c.li);",
          "",
          "[Added Lines]",
          "417:   len = (ms->c.len = 20 + level) * sizeof(*ms->c.li);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7522335b994595f8ef28b078b4ce440eca225422",
      "candidate_info": {
        "commit_hash": "7522335b994595f8ef28b078b4ce440eca225422",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/7522335b994595f8ef28b078b4ce440eca225422",
        "files": [
          "ext/fileinfo/libmagic/funcs.c",
          "ext/fileinfo/tests/bug68996.phpt",
          "ext/fileinfo/tests/bug71527.magic",
          "ext/fileinfo/tests/bug71527.phpt"
        ],
        "message": "Fixed bug #71527 Buffer over-write in finfo_open with malformed magic file\n\nThe actual fix is applying the upstream patch from\nhttps://github.com/file/file/commit/6713ca45e7757297381f4b4cdb9cf5e624a9ad36",
        "before_after_code_files": [
          "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
          "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt",
          "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
          "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
            "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
            "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
          ],
          "candidate": [
            "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c",
            "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic",
            "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/fileinfo/libmagic/funcs.c||ext/fileinfo/libmagic/funcs.c": [
          "File: ext/fileinfo/libmagic/funcs.c -> ext/fileinfo/libmagic/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "414:  size_t len;",
          "416:  if (level >= ms->c.len) {",
          "418:   ms->c.li = CAST(struct level_info *, (ms->c.li == NULL) ?",
          "419:       emalloc(len) :",
          "420:       erealloc(ms->c.li, len));",
          "",
          "[Removed Lines]",
          "417:   len = (ms->c.len += 20) * sizeof(*ms->c.li);",
          "",
          "[Added Lines]",
          "417:   len = (ms->c.len += 20 + level) * sizeof(*ms->c.li);",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug68996.phpt||ext/fileinfo/tests/bug68996.phpt": [
          "File: ext/fileinfo/tests/bug68996.phpt -> ext/fileinfo/tests/bug68996.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "2: Bug #68996 (Invalid free of CG(interned_empty_string))",
          "3: --SKIPIF--",
          "9: <?php require_once(dirname(__FILE__) . '/skipif.inc'); ?>",
          "10: --INI--",
          "11: html_errors=1",
          "12: --FILE--",
          "13: <?php",
          "14: finfo_open(FILEINFO_MIME_TYPE, \"\\xfc\\x63\");",
          "",
          "[Removed Lines]",
          "4: <?php",
          "5: if (getenv(\"USE_ZEND_ALLOC\") !== \"0\") {",
          "6:     print \"skip Need Zend MM disabled\";",
          "7: }",
          "8: ?>",
          "",
          "[Added Lines]",
          "7: --ENV--",
          "8: USE_ZEND_ALLOC=0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19: <br />",
          "20: <b>Warning</b>:  : failed to open stream: No such file or directory in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "21: <br />",
          "",
          "[Removed Lines]",
          "22: <b>Warning</b>:  finfo_open():  in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "[Added Lines]",
          "19: <b>Warning</b>:  finfo_open(): Failed to load magic database at '%s\ufffdc'. in <b>%sbug68996.php</b> on line <b>%d</b><br />",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug71527.magic||ext/fileinfo/tests/bug71527.magic": [
          "File: ext/fileinfo/tests/bug71527.magic -> ext/fileinfo/tests/bug71527.magic",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>",
          "",
          "---------------"
        ],
        "ext/fileinfo/tests/bug71527.phpt||ext/fileinfo/tests/bug71527.phpt": [
          "File: ext/fileinfo/tests/bug71527.phpt -> ext/fileinfo/tests/bug71527.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #71527 Buffer over-write in finfo_open with malformed magic file",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!class_exists('finfo'))",
          "6:  die('skip no fileinfo extension');",
          "7: --ENV--",
          "8: USE_ZEND_ALLOC=0",
          "9: --FILE--",
          "10: <?php",
          "11:  $finfo = finfo_open(FILEINFO_NONE, dirname(__FILE__) . DIRECTORY_SEPARATOR . \"bug71527.magic\");",
          "12:  $info = finfo_file($finfo, __FILE__);",
          "13:  var_dump($info);",
          "14: ?>",
          "15: --EXPECTF--",
          "16: Warning: finfo_open(): Failed to load magic database at '%sbug71527.magic'. in %sbug71527.php on line %d",
          "18: Warning: finfo_file() expects parameter 1 to be resource, boolean given in %sbug71527.php on line %d",
          "19: bool(false)",
          "",
          "---------------"
        ]
      }
    }
  ]
}