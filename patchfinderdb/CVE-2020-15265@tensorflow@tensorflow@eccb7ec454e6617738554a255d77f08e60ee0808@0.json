{
  "cve_id": "CVE-2020-15265",
  "cve_desc": "In Tensorflow before version 2.4.0, an attacker can pass an invalid `axis` value to `tf.quantization.quantize_and_dequantize`. This results in accessing a dimension outside the rank of the input tensor in the C++ kernel implementation. However, dim_size only does a DCHECK to validate the argument and then uses it to access the corresponding element of an array. Since in normal builds, `DCHECK`-like macros are no-ops, this results in segfault and access out of bounds of the array. The issue is patched in eccb7ec454e6617738554a255d77f08e60ee0808 and TensorFlow 2.4.0 will be released containing the patch. TensorFlow nightly packages after this commit will also have the issue resolved.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "eccb7ec454e6617738554a255d77f08e60ee0808",
  "patch_info": {
    "commit_hash": "eccb7ec454e6617738554a255d77f08e60ee0808",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/eccb7ec454e6617738554a255d77f08e60ee0808",
    "files": [
      "tensorflow/core/kernels/quantize_and_dequantize_op.cc",
      "tensorflow/python/kernel_tests/array_ops_test.py"
    ],
    "message": "Prevent segfault in `quantize_and_dequantize`\n\nFixes #42105.\n\nIf `tf.quantization.quantize_and_dequantize` is called with `axis` argument pointing to outside of the input tensor, we obtain a `CHECK` fail which then aborts the application/interpreter. This change adds a condition check and returns a `Status` instead of crashing.\n\nPiperOrigin-RevId: 337972243\nChange-Id: I71ec32c00a87266e364fb017f0ad5dfd3e23542f",
    "before_after_code_files": [
      "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc",
      "tensorflow/python/kernel_tests/array_ops_test.py||tensorflow/python/kernel_tests/array_ops_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
      "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "72:   void Compute(OpKernelContext* ctx) override {",
      "73:     const Tensor& input = ctx->input(0);",
      "74:     const int depth = (axis_ == -1) ? 1 : input.dim_size(axis_);",
      "75:     Tensor input_min_tensor;",
      "76:     Tensor input_max_tensor;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "74:     OP_REQUIRES(",
      "75:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
      "76:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
      "77:                                 \" but is rank \", input.shape().dims()));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/array_ops_test.py||tensorflow/python/kernel_tests/array_ops_test.py": [
      "File: tensorflow/python/kernel_tests/array_ops_test.py -> tensorflow/python/kernel_tests/array_ops_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1628:                   axis=(axis - 4)))",
      "1629:           self.assertAllClose(fake_quantized, expected)",
      "1631:   def testQuantizeDequantizeGrad(self):",
      "1632:     shape = (2, 2)",
      "1633:     max_threshold = 0",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1631:   def testBadAxis(self):",
      "1632:     input_tensor = [2.5, 2.5]",
      "1633:     input_min = [0, 0]",
      "1634:     input_max = [1, 1]",
      "1635:     error_message_pattern = \"Shape must be at least rank 11 but is rank 1\"",
      "1636:     # TODO(b/171260356): Eager mode and graph mode throw different error types",
      "1637:     error = errors.InvalidArgumentError if context.executing_eagerly(",
      "1638:     ) else ValueError",
      "1639:     with self.assertRaisesRegex(error, error_message_pattern):",
      "1640:       self.evaluate(",
      "1641:           array_ops.quantize_and_dequantize_v2(",
      "1642:               input=input_tensor,",
      "1643:               input_min=input_min,",
      "1644:               input_max=input_max,",
      "1645:               axis=10))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
      "candidate_info": {
        "commit_hash": "c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c5b0d5f8ac19888e46ca14b0e27562e7fbbee9a9",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:   void Compute(OpKernelContext* ctx) override {",
          "74:     const Tensor& input = ctx->input(0);",
          "75:     OP_REQUIRES(",
          "76:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "77:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75:     OP_REQUIRES(",
          "76:         ctx, axis_ >= -1,",
          "77:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5d692bf5d76aa9539969652532287a318cbdc813",
      "candidate_info": {
        "commit_hash": "5d692bf5d76aa9539969652532287a318cbdc813",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5d692bf5d76aa9539969652532287a318cbdc813",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:   void Compute(OpKernelContext* ctx) override {",
          "74:     const Tensor& input = ctx->input(0);",
          "75:     OP_REQUIRES(",
          "76:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "77:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75:     OP_REQUIRES(",
          "76:         ctx, axis_ >= -1,",
          "77:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
      "candidate_info": {
        "commit_hash": "e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e7c3b04b4b0245a00ced6cafa956cf540d772bdb",
        "files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ],
        "message": "Fix the CHECK failure in tf.raw_ops.QuantizeAndDequantizeV2.\n\nPiperOrigin-RevId: 371361603\nChange-Id: Ia70e34d41adaadddf928e95e5e5c5c97d5bc60d0",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantize_and_dequantize_op.cc||tensorflow/core/kernels/quantize_and_dequantize_op.cc": [
          "File: tensorflow/core/kernels/quantize_and_dequantize_op.cc -> tensorflow/core/kernels/quantize_and_dequantize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   void Compute(OpKernelContext* ctx) override {",
          "73:     const Tensor& input = ctx->input(0);",
          "74:     OP_REQUIRES(",
          "75:         ctx, (axis_ == -1 || axis_ < input.shape().dims()),",
          "76:         errors::InvalidArgument(\"Shape must be at least rank \", axis_ + 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     OP_REQUIRES(",
          "75:         ctx, axis_ >= -1,",
          "76:         errors::InvalidArgument(\"Axis must be at least -1. Found \", axis_));",
          "",
          "---------------"
        ]
      }
    }
  ]
}