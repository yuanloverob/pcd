{
  "cve_id": "CVE-2015-7551",
  "cve_desc": "The Fiddle::Handle implementation in ext/fiddle/handle.c in Ruby before 2.0.0-p648, 2.1 before 2.1.8, and 2.2 before 2.2.4, as distributed in Apple OS X before 10.11.4 and other products, mishandles tainting, which allows context-dependent attackers to execute arbitrary code or cause a denial of service (application crash) via a crafted string, related to the DL module and the libffi library.  NOTE: this vulnerability exists because of a CVE-2009-5147 regression.",
  "repo": "ruby/ruby",
  "patch_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
  "patch_info": {
    "commit_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
    "repo": "ruby/ruby",
    "commit_url": "https://github.com/ruby/ruby/commit/339e11a7f178312d937b7c95dd3115ce7236597a",
    "files": [
      "ChangeLog",
      "ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb",
      "version.h"
    ],
    "message": "merge revision(s): 53153 and 23405@ruby_1_9_1\n\n\t* ext/fiddle/handle.c: check tainted string arguments.\n\t  Patch provided by tenderlove and nobu.\n\n\t* test/fiddle/test_handle.rb (class TestHandle): add test for above.\n\n\t* ext/dl/handle.c (rb_dlhandle_initialize): prohibits DL::dlopen\n\t  with a tainted name of library.\n\t  Patch by sheepman <sheepman AT sheepman.sakura.ne.jp>.\n\n\t* ext/dl/handle.c (rb_dlhandle_sym): ditto\n\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53156 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
    "before_after_code_files": [
      "ext/fiddle/handle.c||ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb",
      "version.h||version.h"
    ]
  },
  "patch_diff": {
    "ext/fiddle/handle.c||ext/fiddle/handle.c": [
      "File: ext/fiddle/handle.c -> ext/fiddle/handle.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #include <ruby.h>",
      "2: #include <fiddle.h>",
      "4: VALUE rb_cHandle;",
      "6: struct dl_handle {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: #define SafeStringValueCStr(v) (rb_check_safe_obj(rb_string_value(&v)), StringValueCStr(v))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "144:  break;",
      "145:       case 1:",
      "147:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "148:  break;",
      "149:       case 2:",
      "151:  cflag = NUM2INT(flag);",
      "152:  break;",
      "153:       default:",
      "",
      "[Removed Lines]",
      "146:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "150:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "",
      "[Added Lines]",
      "148:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "152:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "263:     return PTR2NUM(fiddle_handle);",
      "264: }",
      "",
      "[Removed Lines]",
      "266: static VALUE fiddle_handle_sym(void *handle, const char *symbol);",
      "",
      "[Added Lines]",
      "268: static VALUE fiddle_handle_sym(void *handle, VALUE symbol);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "282:  rb_raise(rb_eFiddleError, \"closed handle\");",
      "283:     }",
      "286: }",
      "288: #ifndef RTLD_NEXT",
      "",
      "[Removed Lines]",
      "285:     return fiddle_handle_sym(fiddle_handle->ptr, StringValueCStr(sym));",
      "",
      "[Added Lines]",
      "287:     return fiddle_handle_sym(fiddle_handle->ptr, sym);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "305: static VALUE",
      "306: rb_fiddle_handle_s_sym(VALUE self, VALUE sym)",
      "307: {",
      "309: }",
      "311: static VALUE",
      "313: {",
      "314: #if defined(HAVE_DLERROR)",
      "315:     const char *err;",
      "",
      "[Removed Lines]",
      "308:     return fiddle_handle_sym(RTLD_NEXT, StringValueCStr(sym));",
      "312: fiddle_handle_sym(void *handle, const char *name)",
      "",
      "[Added Lines]",
      "310:     return fiddle_handle_sym(RTLD_NEXT, sym);",
      "314: fiddle_handle_sym(void *handle, VALUE symbol)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "318: # define CHECK_DLERROR",
      "319: #endif",
      "320:     void (*func)();",
      "322:     rb_secure(2);",
      "323: #ifdef HAVE_DLERROR",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "323:     const char *name = SafeStringValueCStr(symbol);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "367:     }",
      "368: #endif",
      "369:     if( !func ){",
      "371:     }",
      "373:     return PTR2NUM(func);",
      "",
      "[Removed Lines]",
      "370:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%s\\\"\", name);",
      "",
      "[Added Lines]",
      "373:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%\"PRIsVALUE\"\\\"\", symbol);",
      "",
      "---------------"
    ],
    "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb": [
      "File: test/fiddle/test_handle.rb -> test/fiddle/test_handle.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:     include Test::Unit::Assertions",
      "13:     def test_to_i",
      "14:       handle = Fiddle::Handle.new(LIBC_SO)",
      "15:       assert_kind_of Integer, handle.to_i",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     def test_safe_handle_open",
      "14:       t = Thread.new do",
      "15:         $SAFE = 1",
      "16:         Fiddle::Handle.new(LIBC_SO.taint)",
      "17:       end",
      "18:       assert_raise(SecurityError) { t.value }",
      "19:     end",
      "21:     def test_safe_function_lookup",
      "22:       t = Thread.new do",
      "23:         h = Fiddle::Handle.new(LIBC_SO)",
      "24:         $SAFE = 1",
      "25:         h[\"qsort\".taint]",
      "26:       end",
      "27:       assert_raise(SecurityError) { t.value }",
      "28:     end",
      "",
      "---------------"
    ],
    "version.h||version.h": [
      "File: version.h -> version.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #define RUBY_VERSION \"2.1.8\"",
      "2: #define RUBY_RELEASE_DATE \"2015-12-16\"",
      "5: #define RUBY_RELEASE_YEAR 2015",
      "6: #define RUBY_RELEASE_MONTH 12",
      "",
      "[Removed Lines]",
      "3: #define RUBY_PATCHLEVEL 438",
      "",
      "[Added Lines]",
      "3: #define RUBY_PATCHLEVEL 439",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7cd92ce49a6d5474361190248e7caed176fae743",
      "candidate_info": {
        "commit_hash": "7cd92ce49a6d5474361190248e7caed176fae743",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/7cd92ce49a6d5474361190248e7caed176fae743",
        "files": [
          "ChangeLog",
          "version.h",
          "win32/win32.c"
        ],
        "message": "merge revision(s) r48585,r48587: [Backport #10546]\n\n\t* win32/win32.c (constat_reset): do nothing on non-standard\n\t  console emurators.  [ruby-core:66471] [Bug #10546]\n\t  console emulators.  [ruby-core:66471] [Bug #10546]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49996 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "version.h||version.h",
          "win32/win32.c||win32/win32.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "2: #define RUBY_RELEASE_DATE \"2015-03-18\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 3",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 317",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 318",
          "",
          "---------------"
        ],
        "win32/win32.c||win32/win32.c": [
          "File: win32/win32.c -> win32/win32.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5924: {",
          "5925:     st_data_t data;",
          "5926:     struct constat *p;",
          "5928:     if (!st_lookup(conlist, (st_data_t)h, &data)) return;",
          "5929:     p = (struct constat *)data;",
          "5930:     p->vt100.state = constat_init;",
          "",
          "[Removed Lines]",
          "5927:     if (!conlist) return;",
          "",
          "[Added Lines]",
          "5927:     if (!conlist || conlist == conlist_disabled) return;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1a5d5856f5bf00d26124e3fd0f87d61d059bb668",
      "candidate_info": {
        "commit_hash": "1a5d5856f5bf00d26124e3fd0f87d61d059bb668",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/1a5d5856f5bf00d26124e3fd0f87d61d059bb668",
        "files": [
          "ChangeLog",
          "lib/uri/http.rb",
          "version.h"
        ],
        "message": "merge revision(s) 54257: [Backport #12215]\n\n\t* lib/uri/http.rb (URI::HTTP#initialize): [DOC] fix example,\n\t  missing mandatory arguments.  [ruby-core:74540] [Bug #12215]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@54395 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "lib/uri/http.rb||lib/uri/http.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "lib/uri/http.rb||lib/uri/http.rb": [
          "File: lib/uri/http.rb -> lib/uri/http.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "62:       return super(tmp)",
          "63:     end",
          "65:     #",
          "66:     # == Description",
          "67:     #",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "65: =begin",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "74:     #",
          "75:     # Example:",
          "76:     #",
          "79:     #",
          "80:     #",
          "81:     # See also URI::Generic.new",
          "",
          "[Removed Lines]",
          "77:     #     uri = URI::HTTP.new('http', nil, \"www.example.com\", nil, \"/path\",",
          "78:     #       \"query\", 'fragment')",
          "",
          "[Added Lines]",
          "78:     #     uri = URI::HTTP.new(\"http\", nil, \"www.example.com\", nil, nil,",
          "79:     #                         \"/path\", nil, \"query\", \"fragment\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "83:     def initialize(*arg)",
          "84:       super(*arg)",
          "85:     end",
          "87:     #",
          "88:     # == Description",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87: =end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.9\"",
          "2: #define RUBY_RELEASE_DATE \"2016-03-29\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 3",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 487",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 488",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "54c011a92fcc93dbf3bd5f4cb587196510fb3d1f",
      "candidate_info": {
        "commit_hash": "54c011a92fcc93dbf3bd5f4cb587196510fb3d1f",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/54c011a92fcc93dbf3bd5f4cb587196510fb3d1f",
        "files": [
          "ChangeLog",
          "lib/rubygems/test_case.rb",
          "version.h"
        ],
        "message": "merge revision(s) 54307: [Backport #12193]\n\n\t* lib/rubygems/test_case.rb: Fix test on Windows for inconsistent temp path.\n\t  https://github.com/rubygems/rubygems/pull/1554\n\t  [Bug #12193][ruby-core:74431]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@54689 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "lib/rubygems/test_case.rb||lib/rubygems/test_case.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "lib/rubygems/test_case.rb||lib/rubygems/test_case.rb": [
          "File: lib/rubygems/test_case.rb -> lib/rubygems/test_case.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:       @tempdir.untaint",
          "248:     end",
          "250:     @gemhome  = File.join @tempdir, 'gemhome'",
          "251:     @userhome = File.join @tempdir, 'userhome'",
          "252:     ENV[\"GEM_SPEC_CACHE\"] = File.join @tempdir, 'spec_cache'",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "250:     # This makes the tempdir consistent on Windows.",
          "251:     # Dir.tmpdir may return short path name, but Dir[Dir.tmpdir] returns long",
          "252:     # path name. https://bugs.ruby-lang.org/issues/10819",
          "253:     # File.expand_path or File.realpath doesn't convert path name to long path",
          "254:     # name. Only Dir[] (= Dir.glob) works.",
          "255:     # Short and long path name is specific to Windows filesystem.",
          "256:     if win_platform?",
          "257:       @tempdir = Dir[@tempdir][0]",
          "258:       @tempdir.untaint",
          "259:     end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.10\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 4",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2016-04-01\"",
          "3: #define RUBY_PATCHLEVEL 492",
          "7: #define RUBY_RELEASE_DAY 1",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2016-04-22\"",
          "3: #define RUBY_PATCHLEVEL 493",
          "7: #define RUBY_RELEASE_DAY 22",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1745d2584a77306a349fc2209495aa6455763dc5",
      "candidate_info": {
        "commit_hash": "1745d2584a77306a349fc2209495aa6455763dc5",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/1745d2584a77306a349fc2209495aa6455763dc5",
        "files": [
          "ChangeLog",
          "ext/readline/extconf.rb",
          "version.h"
        ],
        "message": "merge revision(s) 52795: [Backport #11751]\n\n\t* ext/readline/extconf.rb: call dir_config(\"libedit\")\n\t  if --enable-libedit is spcified. [Bug #11751]\n\t  patched by John Hein\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@52853 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/readline/extconf.rb||ext/readline/extconf.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/readline/extconf.rb||ext/readline/extconf.rb": [
          "File: ext/readline/extconf.rb -> ext/readline/extconf.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: case enable_libedit",
          "38: when true",
          "39:   # --enable-libedit",
          "40:   unless (readline.have_header(\"editline/readline.h\") ||",
          "41:           readline.have_header(\"readline/readline.h\")) &&",
          "42:           have_library(\"edit\", \"readline\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:   dir_config(\"libedit\")",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.8\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 12",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-12-01\"",
          "3: #define RUBY_PATCHLEVEL 430",
          "7: #define RUBY_RELEASE_DAY 1",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-12-02\"",
          "3: #define RUBY_PATCHLEVEL 431",
          "7: #define RUBY_RELEASE_DAY 2",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d525dbd0d5ea6bdfe813a38cb6da4ae828b74c09",
      "candidate_info": {
        "commit_hash": "d525dbd0d5ea6bdfe813a38cb6da4ae828b74c09",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/d525dbd0d5ea6bdfe813a38cb6da4ae828b74c09",
        "files": [
          "ChangeLog",
          "version.h"
        ],
        "message": "* ChangeLog: [ci skip] correct a mail address.  cf. [Bug #11870]\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@54290 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.9\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 3",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2016-03-25\"",
          "3: #define RUBY_PATCHLEVEL 485",
          "7: #define RUBY_RELEASE_DAY 25",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2016-03-26\"",
          "3: #define RUBY_PATCHLEVEL 486",
          "7: #define RUBY_RELEASE_DAY 26",
          "",
          "---------------"
        ]
      }
    }
  ]
}