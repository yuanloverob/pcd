{
  "cve_id": "CVE-2015-4599",
  "cve_desc": "The SoapFault::__toString method in ext/soap/soap.c in PHP before 5.4.40, 5.5.x before 5.5.24, and 5.6.x before 5.6.8 allows remote attackers to obtain sensitive information, cause a denial of service (application crash), or possibly execute arbitrary code via an unexpected data type, related to a \"type confusion\" issue.",
  "repo": "php/php-src",
  "patch_hash": "51856a76f87ecb24fe1385342be43610fb6c86e4",
  "patch_info": {
    "commit_hash": "51856a76f87ecb24fe1385342be43610fb6c86e4",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/51856a76f87ecb24fe1385342be43610fb6c86e4",
    "files": [
      "ext/soap/soap.c"
    ],
    "message": "Fixed bug #69152",
    "before_after_code_files": [
      "ext/soap/soap.c||ext/soap/soap.c"
    ]
  },
  "patch_diff": {
    "ext/soap/soap.c||ext/soap/soap.c": [
      "File: ext/soap/soap.c -> ext/soap/soap.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "925:  zend_call_function(&fci, NULL TSRMLS_CC);",
      "927:  len = spprintf(&str, 0, \"SoapFault exception: [%s] %s in %s:%ld\\nStack trace:\\n%s\",",
      "928:                 Z_STRVAL_P(faultcode), Z_STRVAL_P(faultstring), Z_STRVAL_P(file), Z_LVAL_P(line),",
      "929:                 Z_STRLEN_P(trace) ? Z_STRVAL_P(trace) : \"#0 {main}\\n\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "927:  convert_to_string(faultcode);",
      "928:  convert_to_string(faultstring);",
      "929:  convert_to_string(file);",
      "930:  convert_to_long(line);",
      "931:  convert_to_string(trace);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1da9156e60d3d02cc4661244e40d95d5eb76b881",
      "candidate_info": {
        "commit_hash": "1da9156e60d3d02cc4661244e40d95d5eb76b881",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/1da9156e60d3d02cc4661244e40d95d5eb76b881",
        "files": [
          "Zend/zend_exceptions.c",
          "ext/standard/tests/serialize/bug69152.phpt"
        ],
        "message": "More fixes for bug #69152",
        "before_after_code_files": [
          "Zend/zend_exceptions.c||Zend/zend_exceptions.c",
          "ext/standard/tests/serialize/bug69152.phpt||ext/standard/tests/serialize/bug69152.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Zend/zend_exceptions.c||Zend/zend_exceptions.c": [
          "File: Zend/zend_exceptions.c -> Zend/zend_exceptions.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "591:  str = &res;",
          "593:  trace = zend_read_property(default_exception_ce, getThis(), \"trace\", sizeof(\"trace\")-1, 1 TSRMLS_CC);",
          "594:  zend_hash_apply_with_arguments(Z_ARRVAL_P(trace) TSRMLS_CC, (apply_func_args_t)_build_trace_string, 3, str, len, &num);",
          "596:  s_tmp = emalloc(1 + MAX_LENGTH_OF_LONG + 7 + 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "594:  if(Z_TYPE_P(trace) != IS_ARRAY) {",
          "595:   RETURN_FALSE;",
          "596:  }",
          "",
          "---------------"
        ],
        "ext/standard/tests/serialize/bug69152.phpt||ext/standard/tests/serialize/bug69152.phpt": [
          "File: ext/standard/tests/serialize/bug69152.phpt -> ext/standard/tests/serialize/bug69152.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #69152: Type Confusion Infoleak Vulnerability in unserialize()",
          "3: --FILE--",
          "4: <?php",
          "5: $x = unserialize('O:9:\"exception\":1:{s:16:\"'.\"\\0\".'Exception'.\"\\0\".'trace\";s:4:\"ryat\";}');",
          "6: echo $x;",
          "7: $x =  unserialize('O:4:\"test\":1:{s:27:\"__PHP_Incomplete_Class_Name\";R:1;}');",
          "8: $x->test();",
          "10: ?>",
          "11: --EXPECTF--",
          "12: exception 'Exception' in %s:%d",
          "13: Stack trace:",
          "14: #0 {main}",
          "16: Fatal error: main(): The script tried to execute a method or access a property of an incomplete object. Please ensure that the class definition \"unknown\" of the object you are trying to operate on was loaded _before_ unserialize() gets called or provide a __autoload() function to load the class definition  in %s on line %d",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a894a8155fab068d68a04bf181dbaddfa01ccbb0",
      "candidate_info": {
        "commit_hash": "a894a8155fab068d68a04bf181dbaddfa01ccbb0",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/a894a8155fab068d68a04bf181dbaddfa01ccbb0",
        "files": [
          "Zend/zend_exceptions.c",
          "ext/standard/tests/serialize/bug69152.phpt"
        ],
        "message": "More fixes for bug #69152",
        "before_after_code_files": [
          "Zend/zend_exceptions.c||Zend/zend_exceptions.c",
          "ext/standard/tests/serialize/bug69152.phpt||ext/standard/tests/serialize/bug69152.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Zend/zend_exceptions.c||Zend/zend_exceptions.c": [
          "File: Zend/zend_exceptions.c -> Zend/zend_exceptions.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "591:  str = &res;",
          "593:  trace = zend_read_property(default_exception_ce, getThis(), \"trace\", sizeof(\"trace\")-1, 1 TSRMLS_CC);",
          "594:  zend_hash_apply_with_arguments(Z_ARRVAL_P(trace) TSRMLS_CC, (apply_func_args_t)_build_trace_string, 3, str, len, &num);",
          "596:  s_tmp = emalloc(1 + MAX_LENGTH_OF_LONG + 7 + 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "594:  if(Z_TYPE_P(trace) != IS_ARRAY) {",
          "595:   RETURN_FALSE;",
          "596:  }",
          "",
          "---------------"
        ],
        "ext/standard/tests/serialize/bug69152.phpt||ext/standard/tests/serialize/bug69152.phpt": [
          "File: ext/standard/tests/serialize/bug69152.phpt -> ext/standard/tests/serialize/bug69152.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #69152: Type Confusion Infoleak Vulnerability in unserialize()",
          "3: --FILE--",
          "4: <?php",
          "5: $x = unserialize('O:9:\"exception\":1:{s:16:\"'.\"\\0\".'Exception'.\"\\0\".'trace\";s:4:\"ryat\";}');",
          "6: echo $x;",
          "7: $x =  unserialize('O:4:\"test\":1:{s:27:\"__PHP_Incomplete_Class_Name\";R:1;}');",
          "8: $x->test();",
          "10: ?>",
          "11: --EXPECTF--",
          "12: exception 'Exception' in %s:%d",
          "13: Stack trace:",
          "14: #0 {main}",
          "16: Fatal error: main(): The script tried to execute a method or access a property of an incomplete object. Please ensure that the class definition \"unknown\" of the object you are trying to operate on was loaded _before_ unserialize() gets called or provide a __autoload() function to load the class definition  in %s on line %d",
          "",
          "---------------"
        ]
      }
    }
  ]
}