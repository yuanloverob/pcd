{
  "cve_id": "CVE-2016-5769",
  "cve_desc": "Multiple integer overflows in mcrypt.c in the mcrypt extension in PHP before 5.5.37, 5.6.x before 5.6.23, and 7.x before 7.0.8 allow remote attackers to cause a denial of service (heap-based buffer overflow and application crash) or possibly have unspecified other impact via a crafted length value, related to the (1) mcrypt_generic and (2) mdecrypt_generic functions.",
  "repo": "php/php-src",
  "patch_hash": "6c5211a0cef0cc2854eaa387e0eb036e012904d0",
  "patch_info": {
    "commit_hash": "6c5211a0cef0cc2854eaa387e0eb036e012904d0",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/6c5211a0cef0cc2854eaa387e0eb036e012904d0",
    "files": [
      "ext/mcrypt/mcrypt.c"
    ],
    "message": "Fix bug #72455:  Heap Overflow due to integer overflows",
    "before_after_code_files": [
      "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c"
    ]
  },
  "patch_diff": {
    "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c": [
      "File: ext/mcrypt/mcrypt.c -> ext/mcrypt/mcrypt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "45: static int le_mcrypt;",
      "48:  MCRYPT td;",
      "49:  zend_bool init;",
      "50: } php_mcrypt;",
      "",
      "[Removed Lines]",
      "47: typedef struct _php_mcrypt {",
      "",
      "[Added Lines]",
      "47: typedef struct _php_mcrypt {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "293: zend_module_entry mcrypt_module_entry = {",
      "294:  STANDARD_MODULE_HEADER,",
      "296:  mcrypt_functions,",
      "297:  PHP_MINIT(mcrypt), PHP_MSHUTDOWN(mcrypt),",
      "298:  NULL, NULL,",
      "",
      "[Removed Lines]",
      "295:  \"mcrypt\",",
      "",
      "[Added Lines]",
      "295:  \"mcrypt\",",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "376:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"r\", &mcryptind) == FAILURE) {   \\",
      "377:   return;                \\",
      "378:  }                      \\",
      "381: #define MCRYPT_GET_MODE_DIR_ARGS(DIRECTORY)        \\",
      "382:  char *dir = NULL;                                                   \\",
      "",
      "[Removed Lines]",
      "379:  ZEND_FETCH_RESOURCE (pm, php_mcrypt *, &mcryptind, -1, \"MCrypt\", le_mcrypt);",
      "",
      "[Added Lines]",
      "379:  ZEND_FETCH_RESOURCE (pm, php_mcrypt *, &mcryptind, -1, \"MCrypt\", le_mcrypt);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "408: {",
      "409:  php_mcrypt *pm = (php_mcrypt *) rsrc->ptr;",
      "411:   mcrypt_generic_deinit(pm->td);",
      "412:   mcrypt_module_close(pm->td);",
      "413:   efree(pm);",
      "",
      "[Removed Lines]",
      "410:  if (pm) {",
      "",
      "[Added Lines]",
      "410:  if (pm) {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "563:  int   mode_len,   mode_dir_len;",
      "564:  MCRYPT td;",
      "565:  php_mcrypt *pm;",
      "567:  if (zend_parse_parameters (ZEND_NUM_ARGS() TSRMLS_CC, \"ssss\",",
      "568:   &cipher, &cipher_len, &cipher_dir, &cipher_dir_len,",
      "569:   &mode,   &mode_len,   &mode_dir,   &mode_dir_len)) {",
      "570:   return;",
      "571:  }",
      "573:  td = mcrypt_module_open (",
      "574:   cipher,",
      "575:   cipher_dir_len > 0 ? cipher_dir : MCG(algorithms_dir),",
      "577:   mode_dir_len > 0 ? mode_dir : MCG(modes_dir)",
      "578:  );",
      "",
      "[Removed Lines]",
      "576:   mode,",
      "",
      "[Added Lines]",
      "576:   mode,",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "693:   block_size = mcrypt_enc_get_block_size(pm->td);",
      "694:   data_size = (((data_len - 1) / block_size) + 1) * block_size;",
      "695:   data_s = emalloc(data_size + 1);",
      "696:   memset(data_s, 0, data_size);",
      "697:   memcpy(data_s, data, data_len);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "695:   if (data_size <= 0) {",
      "696:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Integer overflow in data size\");",
      "697:    RETURN_FALSE;",
      "698:   }",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "738:   block_size = mcrypt_enc_get_block_size(pm->td);",
      "739:   data_size = (((data_len - 1) / block_size) + 1) * block_size;",
      "740:   data_s = emalloc(data_size + 1);",
      "741:   memset(data_s, 0, data_size);",
      "742:   memcpy(data_s, data, data_len);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "744:   if (data_size <= 0) {",
      "745:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Integer overflow in data size\");",
      "746:    RETURN_FALSE;",
      "747:   }",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "829:  MCRYPT_GET_TD_ARG",
      "831:  if (mcrypt_enc_is_block_algorithm(pm->td) == 1) {",
      "833:  } else {",
      "834:   RETURN_FALSE",
      "835:  }",
      "",
      "[Removed Lines]",
      "832:   RETURN_TRUE",
      "",
      "[Added Lines]",
      "840:   RETURN_TRUE",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1058: {",
      "1059:  char *cipher;",
      "1060:  char *module;",
      "1062:  char *cipher_dir_string;",
      "1063:  char *module_dir_string;",
      "1064:  MCRYPT td;",
      "",
      "[Removed Lines]",
      "1061:  int   cipher_len, module_len;",
      "",
      "[Added Lines]",
      "1069:  int   cipher_len, module_len;",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1087: {",
      "1088:  char *cipher;",
      "1089:  char *module;",
      "1091:  char *cipher_dir_string;",
      "1092:  char *module_dir_string;",
      "1093:  MCRYPT td;",
      "",
      "[Removed Lines]",
      "1090:  int   cipher_len, module_len;",
      "",
      "[Added Lines]",
      "1098:  int   cipher_len, module_len;",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1116: {",
      "1117:  char *cipher;",
      "1118:  char *module;",
      "1120:  char *cipher_dir_string;",
      "1121:  char *module_dir_string;",
      "1122:  MCRYPT td;",
      "",
      "[Removed Lines]",
      "1119:  int   cipher_len, module_len;",
      "",
      "[Added Lines]",
      "1127:  int   cipher_len, module_len;",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1219:   for (i = 0; i < count; i++) {",
      "1221:     key_length_sizes[i] < use_key_length)",
      "1222:    {",
      "1223:     use_key_length = key_length_sizes[i];",
      "",
      "[Removed Lines]",
      "1220:    if (key_length_sizes[i] >= key_len &&",
      "",
      "[Added Lines]",
      "1228:    if (key_length_sizes[i] >= key_len &&",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5e9b4c26a5e43a4c97555b69b105c265240febd2",
      "candidate_info": {
        "commit_hash": "5e9b4c26a5e43a4c97555b69b105c265240febd2",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/5e9b4c26a5e43a4c97555b69b105c265240febd2",
        "files": [
          "ext/gd/gd.c",
          "ext/intl/locale/locale_methods.c",
          "ext/json/json.c",
          "ext/mbstring/mbstring.c",
          "ext/mcrypt/mcrypt.c",
          "ext/opcache/ZendAccelerator.c",
          "ext/pdo/pdo_stmt.c",
          "ext/session/mod_files.c",
          "ext/snmp/snmp.c",
          "ext/sockets/sockets.c",
          "ext/xml/xml.c"
        ],
        "message": "remove TSRMLS_*",
        "before_after_code_files": [
          "ext/gd/gd.c||ext/gd/gd.c",
          "ext/intl/locale/locale_methods.c||ext/intl/locale/locale_methods.c",
          "ext/json/json.c||ext/json/json.c",
          "ext/mbstring/mbstring.c||ext/mbstring/mbstring.c",
          "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c",
          "ext/opcache/ZendAccelerator.c||ext/opcache/ZendAccelerator.c",
          "ext/pdo/pdo_stmt.c||ext/pdo/pdo_stmt.c",
          "ext/session/mod_files.c||ext/session/mod_files.c",
          "ext/snmp/snmp.c||ext/snmp/snmp.c",
          "ext/sockets/sockets.c||ext/sockets/sockets.c",
          "ext/xml/xml.c||ext/xml/xml.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c"
          ],
          "candidate": [
            "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/gd.c||ext/gd/gd.c": [
          "File: ext/gd/gd.c -> ext/gd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1036:   default:",
          "1037:    type = E_ERROR;",
          "1038:  }",
          "1040: }",
          "1042: #endif",
          "",
          "[Removed Lines]",
          "1039:  php_verror(NULL, \"\", type, format, args TSRMLS_CC);",
          "",
          "[Added Lines]",
          "1039:  php_verror(NULL, \"\", type, format, args);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3040:  }",
          "3042:  if ( input <= 0.0 || output <= 0.0 ) {",
          "3044:   RETURN_FALSE;",
          "3045:  }",
          "",
          "[Removed Lines]",
          "3043:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Gamma values should be positive\");",
          "",
          "[Added Lines]",
          "3043:   php_error_docref(NULL, E_WARNING, \"Gamma values should be positive\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "4669:   case GD_CROP_THRESHOLD:",
          "4670:    if (color < 0 || (!gdImageTrueColor(im) && color >= gdImageColorsTotal(im))) {",
          "4672:     RETURN_FALSE;",
          "4673:    }",
          "4674:    im_crop = gdImageCropThreshold(im, color, (float) threshold);",
          "",
          "[Removed Lines]",
          "4671:     php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Color argument missing with threshold mode\");",
          "",
          "[Added Lines]",
          "4671:     php_error_docref(NULL, E_WARNING, \"Color argument missing with threshold mode\");",
          "",
          "---------------"
        ],
        "ext/intl/locale/locale_methods.c||ext/intl/locale/locale_methods.c": [
          "File: ext/intl/locale/locale_methods.c -> ext/intl/locale/locale_methods.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1628:    len = end ? end-start : http_accept_len-(start-http_accept);",
          "1629:    if(len > ULOC_FULLNAME_CAPACITY) {",
          "1630:     intl_error_set( NULL, U_ILLEGAL_ARGUMENT_ERROR,",
          "1632:     RETURN_FALSE;",
          "1633:    }",
          "1634:    if(end) {",
          "",
          "[Removed Lines]",
          "1631:       \"locale_accept_from_http: locale string too long\", 0 TSRMLS_CC );",
          "",
          "[Added Lines]",
          "1631:       \"locale_accept_from_http: locale string too long\", 0 );",
          "",
          "---------------"
        ],
        "ext/json/json.c||ext/json/json.c": [
          "File: ext/json/json.c -> ext/json/json.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "261:  }",
          "263:  if (depth <= 0) {",
          "265:   RETURN_NULL();",
          "266:  }",
          "268:  if (depth > INT_MAX) {",
          "270:   RETURN_NULL();",
          "271:  }",
          "",
          "[Removed Lines]",
          "264:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Depth must be greater than zero\");",
          "269:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Depth must be lower than %d\", INT_MAX);",
          "",
          "[Added Lines]",
          "264:   php_error_docref(NULL, E_WARNING, \"Depth must be greater than zero\");",
          "269:   php_error_docref(NULL, E_WARNING, \"Depth must be lower than %d\", INT_MAX);",
          "",
          "---------------"
        ],
        "ext/mbstring/mbstring.c||ext/mbstring/mbstring.c": [
          "File: ext/mbstring/mbstring.c -> ext/mbstring/mbstring.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3825:    if (elist != NULL) {",
          "3826:     efree((void *)elist);",
          "3827:    }",
          "3829:    RETURN_FALSE;",
          "3830:   }",
          "3831:   efree(stack);",
          "",
          "[Removed Lines]",
          "3828:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Cannot handle recursive references\");",
          "",
          "[Added Lines]",
          "3828:    php_error_docref(NULL, E_WARNING, \"Cannot handle recursive references\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3942:     }",
          "3943:    }",
          "3944:    efree(stack);",
          "3946:    RETURN_FALSE;",
          "3947:   }",
          "3948:   efree(stack);",
          "",
          "[Removed Lines]",
          "3945:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Cannot handle recursive references\");",
          "",
          "[Added Lines]",
          "3945:    php_error_docref(NULL, E_WARNING, \"Cannot handle recursive references\");",
          "",
          "---------------"
        ],
        "ext/mcrypt/mcrypt.c||ext/mcrypt/mcrypt.c": [
          "File: ext/mcrypt/mcrypt.c -> ext/mcrypt/mcrypt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "642:   block_size = mcrypt_enc_get_block_size(pm->td);",
          "643:   data_size = ((((int)data_len - 1) / block_size) + 1) * block_size;",
          "644:   if (data_size <= 0) {",
          "646:    RETURN_FALSE;",
          "647:   }",
          "648:   data_str = zend_string_alloc(data_size, 0);",
          "",
          "[Removed Lines]",
          "645:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Integer overflow in data size\");",
          "",
          "[Added Lines]",
          "645:    php_error_docref(NULL, E_WARNING, \"Integer overflow in data size\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "696:   block_size = mcrypt_enc_get_block_size(pm->td);",
          "697:   data_size = ((((int)data_len - 1) / block_size) + 1) * block_size;",
          "698:   if (data_size <= 0) {",
          "700:    RETURN_FALSE;",
          "701:   }",
          "702:   data_s = emalloc((size_t)data_size + 1);",
          "",
          "[Removed Lines]",
          "699:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Integer overflow in data size\");",
          "",
          "[Added Lines]",
          "699:    php_error_docref(NULL, E_WARNING, \"Integer overflow in data size\");",
          "",
          "---------------"
        ],
        "ext/opcache/ZendAccelerator.c||ext/opcache/ZendAccelerator.c": [
          "File: ext/opcache/ZendAccelerator.c -> ext/opcache/ZendAccelerator.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1769:      file_handle->type == ZEND_HANDLE_FILENAME &&",
          "1770:      UNEXPECTED(access(ZSTR_VAL(persistent_script->full_path), R_OK) != 0)) {",
          "1771:   if (type == ZEND_REQUIRE) {",
          "1773:    zend_bailout();",
          "1774:   } else {",
          "1776:   }",
          "1777:   return NULL;",
          "1778:  }",
          "",
          "[Removed Lines]",
          "1772:    zend_message_dispatcher(ZMSG_FAILED_REQUIRE_FOPEN, file_handle->filename TSRMLS_CC);",
          "1775:    zend_message_dispatcher(ZMSG_FAILED_INCLUDE_FOPEN, file_handle->filename TSRMLS_CC);",
          "",
          "[Added Lines]",
          "1772:    zend_message_dispatcher(ZMSG_FAILED_REQUIRE_FOPEN, file_handle->filename);",
          "1775:    zend_message_dispatcher(ZMSG_FAILED_INCLUDE_FOPEN, file_handle->filename);",
          "",
          "---------------"
        ],
        "ext/pdo/pdo_stmt.c||ext/pdo/pdo_stmt.c": [
          "File: ext/pdo/pdo_stmt.c -> ext/pdo/pdo_stmt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2568:      int res;",
          "2569:      zval val;",
          "2572:      res = check_empty ? i_zend_is_true(&val) : Z_TYPE(val) != IS_NULL;",
          "2573:      zval_dtor(&val);",
          "",
          "[Removed Lines]",
          "2571:      fetch_value(stmt, &val, colno, NULL TSRMLS_CC);",
          "",
          "[Added Lines]",
          "2571:      fetch_value(stmt, &val, colno, NULL);",
          "",
          "---------------"
        ],
        "ext/session/mod_files.c||ext/session/mod_files.c": [
          "File: ext/session/mod_files.c -> ext/session/mod_files.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "175:   }",
          "177:   if (!ps_files_path_create(buf, sizeof(buf), data, key)) {",
          "179:    return;",
          "180:   }",
          "",
          "[Removed Lines]",
          "178:    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Failed to create session data file path. Too short session ID, invalid save_path or path lentgth exceeds MAXPATHLEN(%d)\", MAXPATHLEN);",
          "",
          "[Added Lines]",
          "178:    php_error_docref(NULL, E_WARNING, \"Failed to create session data file path. Too short session ID, invalid save_path or path lentgth exceeds MAXPATHLEN(%d)\", MAXPATHLEN);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "200:    if (fstat(data->fd, &sbuf) || (sbuf.st_uid != 0 && sbuf.st_uid != getuid() && sbuf.st_uid != geteuid())) {",
          "201:     close(data->fd);",
          "202:     data->fd = -1;",
          "204:     return;",
          "205:    }",
          "206: #endif",
          "",
          "[Removed Lines]",
          "203:     php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Session data file is not created by your uid\");",
          "",
          "[Added Lines]",
          "203:     php_error_docref(NULL, E_WARNING, \"Session data file is not created by your uid\");",
          "",
          "---------------"
        ],
        "ext/snmp/snmp.c||ext/snmp/snmp.c": [
          "File: ext/snmp/snmp.c -> ext/snmp/snmp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2071: }",
          "2075: {",
          "2079: }",
          "",
          "[Removed Lines]",
          "2078:  return zend_std_get_properties(object TSRMLS_CC);",
          "",
          "[Added Lines]",
          "2078:  return zend_std_get_properties(object);",
          "",
          "---------------"
        ],
        "ext/sockets/sockets.c||ext/sockets/sockets.c": [
          "File: ext/sockets/sockets.c -> ext/sockets/sockets.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2370:  char *protocol = NULL;",
          "2371:  size_t protocollen = 0;",
          "2374:   return;",
          "2375:  }",
          "2376:  if ((socket = (php_socket *) zend_fetch_resource(Z_RES_P(zsocket), le_socket_name, le_socket)) == NULL) {",
          "",
          "[Removed Lines]",
          "2373:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"r\", &zsocket) == FAILURE) {",
          "",
          "[Added Lines]",
          "2373:  if (zend_parse_parameters(ZEND_NUM_ARGS(), \"r\", &zsocket) == FAILURE) {",
          "",
          "---------------"
        ],
        "ext/xml/xml.c||ext/xml/xml.c": [
          "File: ext/xml/xml.c -> ext/xml/xml.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1610:    convert_to_long_ex(val);",
          "1611:    parser->toffset = Z_LVAL_P(val);",
          "1612:    if (parser->toffset < 0) {",
          "1614:     parser->toffset = 0;",
          "1615:    }",
          "1616:    break;",
          "",
          "[Removed Lines]",
          "1613:     php_error_docref(NULL TSRMLS_CC, E_NOTICE, \"tagstart ignored, because it is out of range\");",
          "",
          "[Added Lines]",
          "1613:     php_error_docref(NULL, E_NOTICE, \"tagstart ignored, because it is out of range\");",
          "",
          "---------------"
        ]
      }
    }
  ]
}