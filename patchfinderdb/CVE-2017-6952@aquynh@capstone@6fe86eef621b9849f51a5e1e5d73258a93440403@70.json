{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "40b25108e46a6ace211342732f884c593746d086",
      "candidate_info": {
        "commit_hash": "40b25108e46a6ace211342732f884c593746d086",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/40b25108e46a6ace211342732f884c593746d086",
        "files": [
          "arch/AArch64/AArch64InstPrinter.c"
        ],
        "message": "Fix a compilation error: variable declarations must be first in scope inside a C file.",
        "before_after_code_files": [
          "arch/AArch64/AArch64InstPrinter.c||arch/AArch64/AArch64InstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/AArch64/AArch64InstPrinter.c||arch/AArch64/AArch64InstPrinter.c": [
          "File: arch/AArch64/AArch64InstPrinter.c -> arch/AArch64/AArch64InstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1642:    MI->flat_insn->detail->arm64.op_count++;",
          "1643:   }",
          "1644:  } else {",
          "1645:   printInt32Bang(O, Val);",
          "1646: #ifndef CAPSTONE_DIET",
          "1648:   MI->flat_insn->detail->arm64.operands[MI->flat_insn->detail->arm64.op_count].access = access;",
          "1649:   MI->ac_idx++;",
          "1650: #endif",
          "",
          "[Removed Lines]",
          "1647:   unsigned char access = get_op_access(MI->csh, MCInst_getOpcode(MI), MI->ac_idx);",
          "",
          "[Added Lines]",
          "1645: #ifndef CAPSTONE_DIET",
          "1646:   unsigned char access;",
          "1647: #endif",
          "1650:   access = get_op_access(MI->csh, MCInst_getOpcode(MI), MI->ac_idx);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c36a479b45409edb2603c6a3219bb5c2fce2e793",
      "candidate_info": {
        "commit_hash": "c36a479b45409edb2603c6a3219bb5c2fce2e793",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c36a479b45409edb2603c6a3219bb5c2fce2e793",
        "files": [
          "arch/X86/X86MappingInsn.inc",
          "arch/X86/X86MappingInsn_reduce.inc"
        ],
        "message": "Add X86_REG_EFLAGS to X86_CLC, X86_CLD, X86_CMC (#801)\n\n* add X86_REG_EFLAGS for X86_STC\n\n* remove wrong X86_GRP_PRIVILEGE for X86_STC ; add X86_REG_EFLAGS for X86_STD\n\n* Add X86_REG_EFLAGS to X86_CLC, X86_CLD, X86_CMC\n\n* add X86_REG_EFLAGS to X86_CLC, X86_CLD, X86_CMC for reduced instructions too",
        "before_after_code_files": [
          "arch/X86/X86MappingInsn.inc||arch/X86/X86MappingInsn.inc",
          "arch/X86/X86MappingInsn_reduce.inc||arch/X86/X86MappingInsn_reduce.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86MappingInsn.inc||arch/X86/X86MappingInsn.inc": [
          "File: arch/X86/X86MappingInsn.inc -> arch/X86/X86MappingInsn.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1852: {",
          "1853:  X86_CLC, X86_INS_CLC,",
          "1854: #ifndef CAPSTONE_DIET",
          "1856: #endif",
          "1857: },",
          "1858: {",
          "1859:  X86_CLD, X86_INS_CLD,",
          "1860: #ifndef CAPSTONE_DIET",
          "1862: #endif",
          "1863: },",
          "1864: {",
          "",
          "[Removed Lines]",
          "1855:  { 0 }, { 0 }, { 0 }, 0, 0",
          "1861:  { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "1855:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "1861:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1900: {",
          "1901:  X86_CMC, X86_INS_CMC,",
          "1902: #ifndef CAPSTONE_DIET",
          "1904: #endif",
          "1905: },",
          "1906: {",
          "",
          "[Removed Lines]",
          "1903:  { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "1903:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "",
          "---------------"
        ],
        "arch/X86/X86MappingInsn_reduce.inc||arch/X86/X86MappingInsn_reduce.inc": [
          "File: arch/X86/X86MappingInsn_reduce.inc -> arch/X86/X86MappingInsn_reduce.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1534: {",
          "1535:  X86_CLC, X86_INS_CLC,",
          "1536: #ifndef CAPSTONE_DIET",
          "1538: #endif",
          "1539: },",
          "1540: {",
          "1541:  X86_CLD, X86_INS_CLD,",
          "1542: #ifndef CAPSTONE_DIET",
          "1544: #endif",
          "1545: },",
          "1546: {",
          "",
          "[Removed Lines]",
          "1537:  { 0 }, { 0 }, { 0 }, 0, 0",
          "1543:  { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "1537:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "1543:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1576: {",
          "1577:  X86_CMC, X86_INS_CMC,",
          "1578: #ifndef CAPSTONE_DIET",
          "1580: #endif",
          "1581: },",
          "1582: {",
          "",
          "[Removed Lines]",
          "1579:  { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "1579:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "8080: {",
          "8081:  X86_STC, X86_INS_STC,",
          "8082: #ifndef CAPSTONE_DIET",
          "8084: #endif",
          "8085: },",
          "8086: {",
          "8087:  X86_STD, X86_INS_STD,",
          "8088: #ifndef CAPSTONE_DIET",
          "8090: #endif",
          "8091: },",
          "8092: {",
          "",
          "[Removed Lines]",
          "8083:  { 0 }, { 0 }, { 0 }, 0, 0",
          "8089:  { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "8083:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "8089:  { 0 }, { X86_REG_EFLAGS, 0 }, { 0 }, 0, 0",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2df9a8eab77cb651250632308de52149c2a0ab3d",
      "candidate_info": {
        "commit_hash": "2df9a8eab77cb651250632308de52149c2a0ab3d",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/2df9a8eab77cb651250632308de52149c2a0ab3d",
        "files": [
          "arch/AArch64/AArch64BaseInfo.c",
          "arch/Sparc/SparcInstPrinter.c",
          "arch/XCore/XCoreInstPrinter.c",
          "cs.c",
          "windows/winkernel_mm.c"
        ],
        "message": "suppress MSVC code analysis (PREfast) warnings\n\nSigned-off-by: Satoshi Tanda <tanda.sat@gmail.com>",
        "before_after_code_files": [
          "arch/AArch64/AArch64BaseInfo.c||arch/AArch64/AArch64BaseInfo.c",
          "arch/Sparc/SparcInstPrinter.c||arch/Sparc/SparcInstPrinter.c",
          "arch/XCore/XCoreInstPrinter.c||arch/XCore/XCoreInstPrinter.c",
          "cs.c||cs.c",
          "windows/winkernel_mm.c||windows/winkernel_mm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [
            "windows/winkernel_mm.c||windows/winkernel_mm.c"
          ],
          "candidate": [
            "windows/winkernel_mm.c||windows/winkernel_mm.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/AArch64/AArch64BaseInfo.c||arch/AArch64/AArch64BaseInfo.c": [
          "File: arch/AArch64/AArch64BaseInfo.c -> arch/AArch64/AArch64BaseInfo.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: #ifdef CAPSTONE_HAS_ARM64",
          "19: #if defined (WIN32) || defined (WIN64) || defined (_WIN32) || defined (_WIN64)",
          "21: #endif",
          "23: #include \"../../utils.h\"",
          "",
          "[Removed Lines]",
          "20: #pragma warning(disable:4996)",
          "",
          "[Added Lines]",
          "20: #pragma warning(disable:4996)   // disable MSVC's warning on strcpy()",
          "21: #pragma warning(disable:28719)  // disable MSVC's warning on strcpy()",
          "",
          "---------------"
        ],
        "arch/Sparc/SparcInstPrinter.c||arch/Sparc/SparcInstPrinter.c": [
          "File: arch/Sparc/SparcInstPrinter.c -> arch/Sparc/SparcInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: #define _CRT_SECURE_NO_WARNINGS",
          "21: #endif",
          "23: #include <stdio.h>",
          "24: #include <stdlib.h>",
          "25: #include <string.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23: #if defined (WIN32) || defined (WIN64) || defined (_WIN32) || defined (_WIN64)",
          "24: #pragma warning(disable:28719)  // disable MSVC's warning on strncpy()",
          "25: #endif",
          "",
          "---------------"
        ],
        "arch/XCore/XCoreInstPrinter.c||arch/XCore/XCoreInstPrinter.c": [
          "File: arch/XCore/XCoreInstPrinter.c -> arch/XCore/XCoreInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: #ifdef CAPSTONE_HAS_XCORE",
          "19: #include <stdio.h>",
          "20: #include <stdlib.h>",
          "21: #include <string.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: #if defined (WIN32) || defined (WIN64) || defined (_WIN32) || defined (_WIN64)",
          "20: #pragma warning(disable : 4996)   // disable MSVC's warning on strcpy()",
          "21: #pragma warning(disable : 28719)  // disable MSVC's warning on strcpy()",
          "22: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "46:  char *p, *p2;",
          "47:  char tmp[128];",
          "54:  strcpy(tmp, code); // safe because code is way shorter than 128 bytes",
          "60:  p = strchr(tmp, ' ');",
          "",
          "[Removed Lines]",
          "50: #ifdef _MSC_VER",
          "51: #pragma warning(push)",
          "52: #pragma warning(disable : 4996)",
          "53: #endif",
          "55: #ifdef _MSC_VER",
          "56: #pragma warning(pop)",
          "57: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "cs.c||cs.c": [
          "File: cs.c -> cs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: #if defined (WIN32) || defined (WIN64) || defined (_WIN32) || defined (_WIN64)",
          "5: #endif",
          "6: #if defined(CAPSTONE_HAS_OSXKERNEL)",
          "7: #include <libkern/libkern.h>",
          "",
          "[Removed Lines]",
          "4: #pragma warning(disable:4996)",
          "",
          "[Added Lines]",
          "4: #pragma warning(disable:4996)   // disable MSVC's warning on strcpy()",
          "5: #pragma warning(disable:28719)  // disable MSVC's warning on strcpy()",
          "",
          "---------------"
        ],
        "windows/winkernel_mm.c||windows/winkernel_mm.c": [
          "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:  NT_ASSERT(size);",
          "34:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
          "35:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
          "36:  if (!block) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5b84c691784b5f0adc3c100d6ec5d5bb71ec8532",
      "candidate_info": {
        "commit_hash": "5b84c691784b5f0adc3c100d6ec5d5bb71ec8532",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/5b84c691784b5f0adc3c100d6ec5d5bb71ec8532",
        "files": [
          "arch/X86/X86Mapping.c"
        ],
        "message": "x86: consistent register names ST0-ST7 with the asm output",
        "before_after_code_files": [
          "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
          "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "192:  { X86_REG_R13, \"r13\" },",
          "193:  { X86_REG_R14, \"r14\" },",
          "194:  { X86_REG_R15, \"r15\" },",
          "203:  { X86_REG_XMM0, \"xmm0\" },",
          "204:  { X86_REG_XMM1, \"xmm1\" },",
          "205:  { X86_REG_XMM2, \"xmm2\" },",
          "",
          "[Removed Lines]",
          "195:  { X86_REG_ST0, \"st0\" },",
          "196:  { X86_REG_ST1, \"st1\" },",
          "197:  { X86_REG_ST2, \"st2\" },",
          "198:  { X86_REG_ST3, \"st3\" },",
          "199:  { X86_REG_ST4, \"st4\" },",
          "200:  { X86_REG_ST5, \"st5\" },",
          "201:  { X86_REG_ST6, \"st6\" },",
          "202:  { X86_REG_ST7, \"st7\" },",
          "",
          "[Added Lines]",
          "195:  { X86_REG_ST0, \"st(0\" },",
          "196:  { X86_REG_ST1, \"st(1)\" },",
          "197:  { X86_REG_ST2, \"st(2)\" },",
          "198:  { X86_REG_ST3, \"st(3)\" },",
          "199:  { X86_REG_ST4, \"st(4)\" },",
          "200:  { X86_REG_ST5, \"st(5)\" },",
          "201:  { X86_REG_ST6, \"st(6)\" },",
          "202:  { X86_REG_ST7, \"st(7)\" },",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fca6fe4837b9539178c3c4ad5af3a1dc0894badc",
      "candidate_info": {
        "commit_hash": "fca6fe4837b9539178c3c4ad5af3a1dc0894badc",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/fca6fe4837b9539178c3c4ad5af3a1dc0894badc",
        "files": [
          "arch/ARM/ARMMappingInsn.inc"
        ],
        "message": "arm: groups for Thumb SETEND instruction. ported from #843",
        "before_after_code_files": [
          "arch/ARM/ARMMappingInsn.inc||arch/ARM/ARMMappingInsn.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/ARM/ARMMappingInsn.inc||arch/ARM/ARMMappingInsn.inc": [
          "File: arch/ARM/ARMMappingInsn.inc -> arch/ARM/ARMMappingInsn.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "13186: {",
          "13187:  ARM_tSETEND, ARM_INS_SETEND,",
          "13188: #ifndef CAPSTONE_DIET",
          "13190: #endif",
          "13191: },",
          "13192: {",
          "",
          "[Removed Lines]",
          "13189:  { 0 }, { 0 }, { ARM_GRP_NOTMCLASS, 0 }, 0, 0",
          "",
          "[Added Lines]",
          "13189:  { 0 }, { 0 }, { ARM_GRP_THUMB, ARM_GRP_V6, ARM_GRP_NOTMCLASS, 0 }, 0, 0",
          "",
          "---------------"
        ]
      }
    }
  ]
}