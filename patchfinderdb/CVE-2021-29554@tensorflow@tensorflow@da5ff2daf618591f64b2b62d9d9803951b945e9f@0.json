{
  "cve_id": "CVE-2021-29554",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can cause a denial of service via a FPE runtime error in `tf.raw_ops.DenseCountSparseOutput`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/efff014f3b2d8ef6141da30c806faf141297eca1/tensorflow/core/kernels/count_ops.cc#L123-L127) computes a divisor value from user data but does not check that the result is 0 before doing the division. Since `data` is given by the `values` argument, `num_batch_elements` is 0. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, and TensorFlow 2.3.3, as these are also affected.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "da5ff2daf618591f64b2b62d9d9803951b945e9f",
  "patch_info": {
    "commit_hash": "da5ff2daf618591f64b2b62d9d9803951b945e9f",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/da5ff2daf618591f64b2b62d9d9803951b945e9f",
    "files": [
      "tensorflow/core/kernels/count_ops.cc"
    ],
    "message": "Fix FPE issue with `tf.raw_ops.DenseCountSparseOutput`.\n\nPiperOrigin-RevId: 370946862\nChange-Id: I3752584ad04aaecb327ff6793a9640ac56acfe7a",
    "before_after_code_files": [
      "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc": [
      "File: tensorflow/core/kernels/count_ops.cc -> tensorflow/core/kernels/count_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "123:     int num_batch_elements = 1;",
      "124:     for (int i = 0; i < num_batch_dimensions; ++i) {",
      "125:       num_batch_elements *= data.shape().dim_size(i);",
      "126:     }",
      "127:     int num_value_elements = data.shape().num_elements() / num_batch_elements;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "125:       OP_REQUIRES(context, data.shape().dim_size(i) != 0,",
      "126:                   errors::InvalidArgument(",
      "127:                       \"Invalid input: Shapes dimension cannot be 0.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b86345ef5092d56a0d7f255aefa80ae260ed4bd6",
      "candidate_info": {
        "commit_hash": "b86345ef5092d56a0d7f255aefa80ae260ed4bd6",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b86345ef5092d56a0d7f255aefa80ae260ed4bd6",
        "files": [
          "tensorflow/core/kernels/count_ops.cc"
        ],
        "message": "Fix FPE issue with `tf.raw_ops.DenseCountSparseOutput`.\n\nPiperOrigin-RevId: 370946862\nChange-Id: I3752584ad04aaecb327ff6793a9640ac56acfe7a",
        "before_after_code_files": [
          "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc": [
          "File: tensorflow/core/kernels/count_ops.cc -> tensorflow/core/kernels/count_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:     int num_batch_elements = 1;",
          "124:     for (int i = 0; i < num_batch_dimensions; ++i) {",
          "125:       num_batch_elements *= data.shape().dim_size(i);",
          "126:     }",
          "127:     int num_value_elements = data.shape().num_elements() / num_batch_elements;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "125:       OP_REQUIRES(context, data.shape().dim_size(i) != 0,",
          "126:                   errors::InvalidArgument(",
          "127:                       \"Invalid input: Shapes dimension cannot be 0.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8348595c932251c28cb2f2a6e6cef74dd33c829c",
      "candidate_info": {
        "commit_hash": "8348595c932251c28cb2f2a6e6cef74dd33c829c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8348595c932251c28cb2f2a6e6cef74dd33c829c",
        "files": [
          "tensorflow/core/kernels/count_ops.cc"
        ],
        "message": "Fix FPE issue with `tf.raw_ops.DenseCountSparseOutput`.\n\nPiperOrigin-RevId: 370946862\nChange-Id: I3752584ad04aaecb327ff6793a9640ac56acfe7a",
        "before_after_code_files": [
          "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc": [
          "File: tensorflow/core/kernels/count_ops.cc -> tensorflow/core/kernels/count_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:     int num_batch_elements = 1;",
          "124:     for (int i = 0; i < num_batch_dimensions; ++i) {",
          "125:       num_batch_elements *= data.shape().dim_size(i);",
          "126:     }",
          "127:     int num_value_elements = data.shape().num_elements() / num_batch_elements;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "125:       OP_REQUIRES(context, data.shape().dim_size(i) != 0,",
          "126:                   errors::InvalidArgument(",
          "127:                       \"Invalid input: Shapes dimension cannot be 0.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7c270c3ede66d283287520403c2adf755320c0f8",
      "candidate_info": {
        "commit_hash": "7c270c3ede66d283287520403c2adf755320c0f8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/7c270c3ede66d283287520403c2adf755320c0f8",
        "files": [
          "tensorflow/core/kernels/count_ops.cc"
        ],
        "message": "Fix FPE issue with `tf.raw_ops.DenseCountSparseOutput`.\n\nPiperOrigin-RevId: 370946862\nChange-Id: I3752584ad04aaecb327ff6793a9640ac56acfe7a",
        "before_after_code_files": [
          "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/count_ops.cc||tensorflow/core/kernels/count_ops.cc": [
          "File: tensorflow/core/kernels/count_ops.cc -> tensorflow/core/kernels/count_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:     int num_batch_elements = 1;",
          "124:     for (int i = 0; i < num_batch_dimensions; ++i) {",
          "125:       num_batch_elements *= data.shape().dim_size(i);",
          "126:     }",
          "127:     int num_value_elements = data.shape().num_elements() / num_batch_elements;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "125:       OP_REQUIRES(context, data.shape().dim_size(i) != 0,",
          "126:                   errors::InvalidArgument(",
          "127:                       \"Invalid input: Shapes dimension cannot be 0.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}