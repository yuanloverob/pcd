{
  "cve_id": "CVE-2024-7806",
  "cve_desc": "A vulnerability in open-webui/open-webui versions <= 0.3.8 allows remote code execution by non-admin users via Cross-Site Request Forgery (CSRF). The application uses cookies with the SameSite attribute set to lax for authentication and lacks CSRF tokens. This allows an attacker to craft a malicious HTML that, when accessed by a victim, can modify the Python code of an existing pipeline and execute arbitrary code with the victim's privileges.",
  "repo": "open-webui/open-webui",
  "patch_hash": "7e253df17593bc12dc5cc89d28703675f05b0158",
  "patch_info": {
    "commit_hash": "7e253df17593bc12dc5cc89d28703675f05b0158",
    "repo": "open-webui/open-webui",
    "commit_url": "https://github.com/open-webui/open-webui/commit/7e253df17593bc12dc5cc89d28703675f05b0158",
    "files": [
      "backend/open_webui/apps/webui/routers/auths.py",
      "backend/open_webui/main.py"
    ],
    "message": "Merge pull request #6054 from jeeteshchel/bugfix/secure-cookie\n\nfix: set token cookie secure and samesite per config",
    "before_after_code_files": [
      "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py",
      "backend/open_webui/main.py||backend/open_webui/main.py"
    ]
  },
  "patch_diff": {
    "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py": [
      "File: backend/open_webui/apps/webui/routers/auths.py -> backend/open_webui/apps/webui/routers/auths.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "18: from open_webui.env import (",
      "19:     WEBUI_AUTH_TRUSTED_EMAIL_HEADER,",
      "20:     WEBUI_AUTH_TRUSTED_NAME_HEADER,",
      "21: )",
      "22: from fastapi import APIRouter, Depends, HTTPException, Request, status",
      "23: from fastapi.responses import Response",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "21:     WEBUI_SESSION_COOKIE_SAME_SITE,",
      "22:     WEBUI_SESSION_COOKIE_SECURE,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "53:         key=\"token\",",
      "54:         value=token,",
      "55:         httponly=True,  # Ensures the cookie is not accessible via JavaScript",
      "56:     )",
      "58:     return {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "58:         samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
      "59:         secure=WEBUI_SESSION_COOKIE_SECURE,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "166:             key=\"token\",",
      "167:             value=token,",
      "168:             httponly=True,  # Ensures the cookie is not accessible via JavaScript",
      "169:         )",
      "171:         return {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "173:             samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
      "174:             secure=WEBUI_SESSION_COOKIE_SECURE,",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "236:                 key=\"token\",",
      "237:                 value=token,",
      "238:                 httponly=True,  # Ensures the cookie is not accessible via JavaScript",
      "239:             )",
      "241:             if request.app.state.config.WEBHOOK_URL:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "245:                 samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
      "246:                 secure=WEBUI_SESSION_COOKIE_SECURE,",
      "",
      "---------------"
    ],
    "backend/open_webui/main.py||backend/open_webui/main.py": [
      "File: backend/open_webui/main.py -> backend/open_webui/main.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "2385:         key=\"token\",",
      "2386:         value=jwt_token,",
      "2387:         httponly=True,  # Ensures the cookie is not accessible via JavaScript",
      "2388:     )",
      "2390:     # Redirect back to the frontend with the JWT token",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2388:         samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
      "2389:         secure=WEBUI_SESSION_COOKIE_SECURE,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a2e889c8bba04d503977f509a3b57bd7684d5217",
      "candidate_info": {
        "commit_hash": "a2e889c8bba04d503977f509a3b57bd7684d5217",
        "repo": "open-webui/open-webui",
        "commit_url": "https://github.com/open-webui/open-webui/commit/a2e889c8bba04d503977f509a3b57bd7684d5217",
        "files": [
          "backend/open_webui/apps/webui/routers/auths.py",
          "backend/open_webui/main.py"
        ],
        "message": "fix: set oauth token secure and samesite per config",
        "before_after_code_files": [
          "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py",
          "backend/open_webui/main.py||backend/open_webui/main.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/open-webui/open-webui/pull/6054"
        ],
        "olp_code_files": {
          "patch": [
            "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py",
            "backend/open_webui/main.py||backend/open_webui/main.py"
          ],
          "candidate": [
            "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py",
            "backend/open_webui/main.py||backend/open_webui/main.py"
          ]
        }
      },
      "candidate_diff": {
        "backend/open_webui/apps/webui/routers/auths.py||backend/open_webui/apps/webui/routers/auths.py": [
          "File: backend/open_webui/apps/webui/routers/auths.py -> backend/open_webui/apps/webui/routers/auths.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: from open_webui.env import (",
          "19:     WEBUI_AUTH_TRUSTED_EMAIL_HEADER,",
          "20:     WEBUI_AUTH_TRUSTED_NAME_HEADER,",
          "21: )",
          "22: from fastapi import APIRouter, Depends, HTTPException, Request, status",
          "23: from fastapi.responses import Response",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21:     WEBUI_SESSION_COOKIE_SAME_SITE,",
          "22:     WEBUI_SESSION_COOKIE_SECURE,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "53:         key=\"token\",",
          "54:         value=token,",
          "55:         httponly=True,  # Ensures the cookie is not accessible via JavaScript",
          "56:     )",
          "58:     return {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:         samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
          "59:         secure=WEBUI_SESSION_COOKIE_SECURE,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "166:             key=\"token\",",
          "167:             value=token,",
          "168:             httponly=True,  # Ensures the cookie is not accessible via JavaScript",
          "169:         )",
          "171:         return {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "173:             samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
          "174:             secure=WEBUI_SESSION_COOKIE_SECURE,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "236:                 key=\"token\",",
          "237:                 value=token,",
          "238:                 httponly=True,  # Ensures the cookie is not accessible via JavaScript",
          "239:             )",
          "241:             if request.app.state.config.WEBHOOK_URL:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "245:                 samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
          "246:                 secure=WEBUI_SESSION_COOKIE_SECURE,",
          "",
          "---------------"
        ],
        "backend/open_webui/main.py||backend/open_webui/main.py": [
          "File: backend/open_webui/main.py -> backend/open_webui/main.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "2385:         key=\"token\",",
          "2386:         value=jwt_token,",
          "2387:         httponly=True,  # Ensures the cookie is not accessible via JavaScript",
          "2388:     )",
          "2390:     # Redirect back to the frontend with the JWT token",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2388:         samesite=WEBUI_SESSION_COOKIE_SAME_SITE,",
          "2389:         secure=WEBUI_SESSION_COOKIE_SECURE,",
          "",
          "---------------"
        ]
      }
    }
  ]
}