{
  "cve_id": "CVE-2024-27499",
  "cve_desc": "Bagisto v1.5.1 is vulnerable for Cross site scripting(XSS) via png file upload vulnerability in product review option.",
  "repo": "bagisto/bagisto",
  "patch_hash": "b01bfc5fab3933a132380f36cb2e9670d2310baf",
  "patch_info": {
    "commit_hash": "b01bfc5fab3933a132380f36cb2e9670d2310baf",
    "repo": "bagisto/bagisto",
    "commit_url": "https://github.com/bagisto/bagisto/commit/b01bfc5fab3933a132380f36cb2e9670d2310baf",
    "files": [
      "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
      "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
      "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
      "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
    ],
    "message": "Merge pull request #9474 from suraj-webkul/theme-image-xss\n\nxss theme issue fixed.",
    "before_after_code_files": [
      "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
      "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
      "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
      "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
    ]
  },
  "patch_diff": {
    "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php": [
      "File: packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php -> packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "42:     public function store()",
      "43:     {",
      "44:         if (request()->has('id')) {",
      "45:             $theme = $this->themeCustomizationRepository->find(request()->input('id'));",
      "47:             return $this->themeCustomizationRepository->uploadImage(request()->all(), $theme);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "45:             $this->validate(request(), [",
      "46:                 core()->getRequestedLocaleCode().'.options.*.image' => 'image|extensions:jpeg,jpg,png,svg,webp',",
      "47:             ]);",
      "",
      "---------------"
    ],
    "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php": [
      "File: packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php -> packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:         $currentLocale = core()->getRequestedLocale();",
      "12:     @endphp",
      "15:         :action=\"route('admin.settings.themes.update', $theme->id)\"",
      "16:         enctype=\"multipart/form-data\"",
      "17:         v-slot=\"{ errors }\"",
      "",
      "[Removed Lines]",
      "14:     <x-admin::form",
      "",
      "[Added Lines]",
      "14:     <x-admin::form",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "20:             <p class=\"text-xl text-gray-800 dark:text-white font-bold\">",
      "21:                 @lang('admin::app.settings.themes.edit.title')",
      "22:             </p>",
      "24:             <div class=\"flex gap-x-2.5 items-center\">",
      "25:                 <div class=\"flex gap-x-2.5 items-center\">",
      "27:                         href=\"{{ route('admin.settings.themes.index') }}\"",
      "28:                         class=\"transparent-button hover:bg-gray-200 dark:hover:bg-gray-800 dark:text-white\"",
      "30:                         @lang('admin::app.settings.themes.edit.back')",
      "31:                     </a>",
      "32:                 </div>",
      "35:                     type=\"submit\"",
      "36:                     class=\"primary-button\"",
      "37:                 >",
      "",
      "[Removed Lines]",
      "26:                     <a",
      "29:                     >",
      "34:                 <button",
      "",
      "[Added Lines]",
      "26:                     <a",
      "29:                     >",
      "34:                 <button",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "136:                             image_carousel: 'v-image-carousel',",
      "137:                             footer_links: 'v-footer-links',",
      "138:                             services_content: 'v-services-content'",
      "140:                     };",
      "141:                 },",
      "",
      "[Removed Lines]",
      "139:                         }",
      "",
      "[Added Lines]",
      "139:                         }",
      "",
      "---------------"
    ],
    "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php": [
      "File: packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php -> packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39:                                 class=\"hidden\"",
      "40:                                 accept=\"image/*\"",
      "41:                                 ref=\"static_image\"",
      "42:                                 @change=\"storeImage($event)\"",
      "43:                             >",
      "44:                         </div>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "42:                                 label=\"Image\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "380:                                 line: cursorPointer.line, ch: cursorPointer.ch + response.data.length",
      "381:                             });",
      "382:                         })",
      "384:                 },",
      "385:             },",
      "386:         });",
      "",
      "[Removed Lines]",
      "383:                         .catch((error) => {});",
      "",
      "[Added Lines]",
      "384:                         .catch((error) => {",
      "385:                             if (error.response.status == 422) {",
      "386:                                 this.$emitter.emit('add-flash', { type: 'warning', message: error.response.data.message });",
      "387:                             }",
      "388:                         });",
      "",
      "---------------"
    ],
    "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php": [
      "File: packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php -> packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "76:                     'title'        => $image['title'],",
      "77:                 ];",
      "78:             } elseif ($image['image'] instanceof UploadedFile) {",
      "85:                 if (($data['type'] ?? '') == 'static_content') {",
      "86:                     return Storage::url($path);",
      "",
      "[Removed Lines]",
      "79:                 $manager = new ImageManager();",
      "81:                 $path = 'theme/'.$theme->id.'/'.Str::random(40).'.webp';",
      "83:                 Storage::put($path, $manager->make($image['image'])->encode('webp'));",
      "",
      "[Added Lines]",
      "79:                 try {",
      "80:                     $manager = new ImageManager();",
      "82:                     $path = 'theme/'.$theme->id.'/'.Str::random(40).'.webp';",
      "84:                     Storage::put($path, $manager->make($image['image'])->encode('webp'));",
      "85:                 } catch (\\Exception $e) {",
      "86:                     session()->flash('error', $e->getMessage());",
      "88:                     return redirect()->back();",
      "89:                 }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "16c13fee360466b1ed463ba35d373a34ddd1b3f0",
      "candidate_info": {
        "commit_hash": "16c13fee360466b1ed463ba35d373a34ddd1b3f0",
        "repo": "bagisto/bagisto",
        "commit_url": "https://github.com/bagisto/bagisto/commit/16c13fee360466b1ed463ba35d373a34ddd1b3f0",
        "files": [
          "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php"
        ],
        "message": "minor changes.",
        "before_after_code_files": [
          "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/bagisto/bagisto/pull/9474"
        ],
        "olp_code_files": {
          "patch": [
            "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php"
          ],
          "candidate": [
            "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php"
          ]
        }
      },
      "candidate_diff": {
        "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php": [
          "File: packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php -> packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Illuminate\\Http\\JsonResponse;",
          "6: use Illuminate\\Support\\Facades\\Event;",
          "7: use Illuminate\\Support\\Facades\\Storage;",
          "9: use Webkul\\Admin\\DataGrids\\Theme\\ThemeDatagrid;",
          "10: use Webkul\\Admin\\Http\\Controllers\\Controller;",
          "11: use Webkul\\Theme\\Repositories\\ThemeCustomizationRepository;",
          "",
          "[Removed Lines]",
          "8: use Illuminate\\Support\\Facades\\Validator;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43:     public function store()",
          "44:     {",
          "45:         if (request()->has('id')) {",
          "48:             ]);",
          "54:             $theme = $this->themeCustomizationRepository->find(request()->input('id'));",
          "56:             return $this->themeCustomizationRepository->uploadImage(request()->all(), $theme);",
          "",
          "[Removed Lines]",
          "46:             $validator = Validator::make(request()->all(), [",
          "47:                 core()->getRequestedLocaleCode().'options.*.image' => 'image|extensions:jpeg,jpg,png,svg,webp',",
          "50:             if ($validator->fails()) {",
          "51:                 return redirect()->back()->withErrors($validator)->withInput();",
          "52:             }",
          "",
          "[Added Lines]",
          "45:             $this->validate(request(), [",
          "46:                 core()->getRequestedLocaleCode().'.options.*.image' => 'image|extensions:jpeg,jpg,png,svg,webp',",
          "",
          "---------------"
        ],
        "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php": [
          "File: packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php -> packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:                                 class=\"hidden\"",
          "40:                                 accept=\"image/*\"",
          "41:                                 ref=\"static_image\"",
          "42:                                 @change=\"storeImage($event)\"",
          "43:                             >",
          "44:                         </div>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42:                                 label=\"Image\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "381:                             });",
          "382:                         })",
          "383:                         .catch((error) => {",
          "385:                         });",
          "386:                 },",
          "387:             },",
          "",
          "[Removed Lines]",
          "384:                             this.$emitter.emit('add-flash', { type: 'warning', message: error.response.data.message });",
          "",
          "[Added Lines]",
          "385:                             if (error.response.status == 422) {",
          "386:                                 this.$emitter.emit('add-flash', { type: 'warning', message: error.response.data.message });",
          "387:                             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2a05ed973651fcc427f9af10a9d733c6ba434721",
      "candidate_info": {
        "commit_hash": "2a05ed973651fcc427f9af10a9d733c6ba434721",
        "repo": "bagisto/bagisto",
        "commit_url": "https://github.com/bagisto/bagisto/commit/2a05ed973651fcc427f9af10a9d733c6ba434721",
        "files": [
          "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
          "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
        ],
        "message": "xss theme issue fixed.",
        "before_after_code_files": [
          "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
          "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
          "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/bagisto/bagisto/pull/9474"
        ],
        "olp_code_files": {
          "patch": [
            "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
            "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
          ],
          "candidate": [
            "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
            "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
            "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php"
          ]
        }
      },
      "candidate_diff": {
        "packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php||packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php": [
          "File: packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php -> packages/Webkul/Admin/src/Http/Controllers/Settings/ThemeController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Illuminate\\Http\\JsonResponse;",
          "6: use Illuminate\\Support\\Facades\\Event;",
          "7: use Illuminate\\Support\\Facades\\Storage;",
          "8: use Webkul\\Admin\\DataGrids\\Theme\\ThemeDatagrid;",
          "9: use Webkul\\Admin\\Http\\Controllers\\Controller;",
          "10: use Webkul\\Theme\\Repositories\\ThemeCustomizationRepository;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: use Illuminate\\Support\\Facades\\Validator;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "42:     public function store()",
          "43:     {",
          "44:         if (request()->has('id')) {",
          "45:             $theme = $this->themeCustomizationRepository->find(request()->input('id'));",
          "47:             return $this->themeCustomizationRepository->uploadImage(request()->all(), $theme);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:             $validator = Validator::make(request()->all(), [",
          "47:                 core()->getRequestedLocaleCode().'options.*.image' => 'image|extensions:jpeg,jpg,png,svg,webp',",
          "48:             ]);",
          "50:             if ($validator->fails()) {",
          "51:                 return redirect()->back()->withErrors($validator)->withInput();",
          "52:             }",
          "",
          "---------------"
        ],
        "packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php": [
          "File: packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php -> packages/Webkul/Admin/src/Resources/views/settings/themes/edit.blade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:         $currentLocale = core()->getRequestedLocale();",
          "12:     @endphp",
          "15:         :action=\"route('admin.settings.themes.update', $theme->id)\"",
          "16:         enctype=\"multipart/form-data\"",
          "17:         v-slot=\"{ errors }\"",
          "",
          "[Removed Lines]",
          "14:     <x-admin::form",
          "",
          "[Added Lines]",
          "14:     <x-admin::form",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "20:             <p class=\"text-xl text-gray-800 dark:text-white font-bold\">",
          "21:                 @lang('admin::app.settings.themes.edit.title')",
          "22:             </p>",
          "24:             <div class=\"flex gap-x-2.5 items-center\">",
          "25:                 <div class=\"flex gap-x-2.5 items-center\">",
          "27:                         href=\"{{ route('admin.settings.themes.index') }}\"",
          "28:                         class=\"transparent-button hover:bg-gray-200 dark:hover:bg-gray-800 dark:text-white\"",
          "30:                         @lang('admin::app.settings.themes.edit.back')",
          "31:                     </a>",
          "32:                 </div>",
          "35:                     type=\"submit\"",
          "36:                     class=\"primary-button\"",
          "37:                 >",
          "",
          "[Removed Lines]",
          "26:                     <a",
          "29:                     >",
          "34:                 <button",
          "",
          "[Added Lines]",
          "26:                     <a",
          "29:                     >",
          "34:                 <button",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "136:                             image_carousel: 'v-image-carousel',",
          "137:                             footer_links: 'v-footer-links',",
          "138:                             services_content: 'v-services-content'",
          "140:                     };",
          "141:                 },",
          "",
          "[Removed Lines]",
          "139:                         }",
          "",
          "[Added Lines]",
          "139:                         }",
          "",
          "---------------"
        ],
        "packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php||packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php": [
          "File: packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php -> packages/Webkul/Admin/src/Resources/views/settings/themes/edit/static-content.blade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "380:                                 line: cursorPointer.line, ch: cursorPointer.ch + response.data.length",
          "381:                             });",
          "382:                         })",
          "384:                 },",
          "385:             },",
          "386:         });",
          "",
          "[Removed Lines]",
          "383:                         .catch((error) => {});",
          "",
          "[Added Lines]",
          "383:                         .catch((error) => {",
          "384:                             this.$emitter.emit('add-flash', { type: 'warning', message: error.response.data.message });",
          "385:                         });",
          "",
          "---------------"
        ],
        "packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php||packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php": [
          "File: packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php -> packages/Webkul/Theme/src/Repositories/ThemeCustomizationRepository.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:                     'title'        => $image['title'],",
          "77:                 ];",
          "78:             } elseif ($image['image'] instanceof UploadedFile) {",
          "85:                 if (($data['type'] ?? '') == 'static_content') {",
          "86:                     return Storage::url($path);",
          "",
          "[Removed Lines]",
          "79:                 $manager = new ImageManager();",
          "81:                 $path = 'theme/'.$theme->id.'/'.Str::random(40).'.webp';",
          "83:                 Storage::put($path, $manager->make($image['image'])->encode('webp'));",
          "",
          "[Added Lines]",
          "79:                 try {",
          "80:                     $manager = new ImageManager();",
          "82:                     $path = 'theme/'.$theme->id.'/'.Str::random(40).'.webp';",
          "84:                     Storage::put($path, $manager->make($image['image'])->encode('webp'));",
          "85:                 } catch (\\Exception $e) {",
          "86:                     session()->flash('error', $e->getMessage());",
          "88:                     return redirect()->back();",
          "89:                 }",
          "",
          "---------------"
        ]
      }
    }
  ]
}