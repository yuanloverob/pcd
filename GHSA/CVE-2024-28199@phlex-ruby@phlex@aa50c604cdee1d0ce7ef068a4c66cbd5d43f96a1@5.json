{
  "cve_id": "CVE-2024-28199",
  "cve_desc": "phlex is an open source framework for building object-oriented views in Ruby. There is a potential cross-site scripting (XSS) vulnerability that can be exploited via maliciously crafted user data. This was due to improper case-sensitivity in the code that was meant to prevent these attacks. If you render an `<a>` tag with an `href` attribute set to a user-provided link, that link could potentially execute JavaScript when clicked by another user. If you splat user-provided attributes when rendering any HTML tag, malicious event attributes could be included in the output, executing JavaScript when the events are triggered by another user. Patches are available on RubyGems for all 1.x minor versions. Users are advised to upgrade. Users unable to upgrade should consider configuring a content security policy that does not allow `unsafe-inline`.",
  "repo": "phlex-ruby/phlex",
  "patch_hash": "aa50c604cdee1d0ce7ef068a4c66cbd5d43f96a1",
  "patch_info": {
    "commit_hash": "aa50c604cdee1d0ce7ef068a4c66cbd5d43f96a1",
    "repo": "phlex-ruby/phlex",
    "commit_url": "https://github.com/phlex-ruby/phlex/commit/aa50c604cdee1d0ce7ef068a4c66cbd5d43f96a1",
    "files": [
      "lib/phlex/sgml.rb",
      "test/phlex/view/naughty_business.rb"
    ],
    "message": "Fix improper case-sensitivity\n\nSee https://github.com/phlex-ruby/phlex/security/advisories/GHSA-242p-4v39-2v8g",
    "before_after_code_files": [
      "lib/phlex/sgml.rb||lib/phlex/sgml.rb",
      "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb"
    ]
  },
  "patch_diff": {
    "lib/phlex/sgml.rb||lib/phlex/sgml.rb": [
      "File: lib/phlex/sgml.rb -> lib/phlex/sgml.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "393:     attributes = process_attributes(**attributes)",
      "394:    end",
      "404:    buffer = +\"\"",
      "405:    __build_attributes__(attributes, buffer: buffer)",
      "",
      "[Removed Lines]",
      "396:    if attributes[:href]&.start_with?(/\\s*javascript:/)",
      "397:     attributes.delete(:href)",
      "398:    end",
      "400:    if attributes[\"href\"]&.start_with?(/\\s*javascript:/)",
      "401:     attributes.delete(\"href\")",
      "402:    end",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "418:      else raise ArgumentError, \"Attribute keys should be Strings or Symbols.\"",
      "419:     end",
      "421:     # Detect unsafe attribute names. Attribute names are considered unsafe if they match an event attribute or include unsafe characters.",
      "423:      raise ArgumentError, \"Unsafe attribute name detected: #{k}.\"",
      "424:     end",
      "",
      "[Removed Lines]",
      "422:     if HTML::EVENT_ATTRIBUTES[name] || name.match?(/[<>&\"']/)",
      "",
      "[Added Lines]",
      "413:     lower_name = name.downcase",
      "414:     next if lower_name == \"href\" && v.start_with?(/\\s*javascript:/i)",
      "417:     if HTML::EVENT_ATTRIBUTES[lower_name] || name.match?(/[<>&\"']/)",
      "",
      "---------------"
    ],
    "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb": [
      "File: test/phlex/view/naughty_business.rb -> test/phlex/view/naughty_business.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: describe Phlex::HTML do",
      "4:  extend ViewHelper",
      "6:  with \"naughty text\" do",
      "7:   view do",
      "8:    def view_template",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6:  with \"naughty javascript links\" do",
      "7:   view do",
      "8:    def template",
      "9:     a(href: \"javascript:alert(1)\") { \"a\" }",
      "10:     a(href: \"JAVASCRIPT:alert(1)\") { \"b\" }",
      "11:     a(href: :\"JAVASCRIPT:alert(1)\") { \"c\" }",
      "12:     a(HREF: \"javascript:alert(1)\") { \"d\" }",
      "13:    end",
      "14:   end",
      "16:   it \"removes the href attributes\" do",
      "17:    expect(output).to be == \"<a>a</a><a>b</a><a>c</a><a>d</a>\"",
      "18:   end",
      "19:  end",
      "21:  with \"naughty uppercase event tag\" do",
      "22:   view do",
      "23:    def template",
      "24:     button ONCLICK: \"ALERT(1)\" do",
      "25:      \"naughty button\"",
      "26:     end",
      "27:    end",
      "28:   end",
      "30:   it \"raises\" do",
      "31:    expect { output }.to raise_exception ArgumentError,",
      "32:     message: be == \"Unsafe attribute name detected: ONCLICK.\"",
      "33:   end",
      "34:  end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "95ce2f58cb702c42d45c61b0101833d9468d4ad8",
      "candidate_info": {
        "commit_hash": "95ce2f58cb702c42d45c61b0101833d9468d4ad8",
        "repo": "phlex-ruby/phlex",
        "commit_url": "https://github.com/phlex-ruby/phlex/commit/95ce2f58cb702c42d45c61b0101833d9468d4ad8",
        "files": [
          "lib/phlex/sgml.rb",
          "lib/phlex/version.rb",
          "test/phlex/view/naughty_business.rb"
        ],
        "message": "Bump to 1.7.1\n\nSee https://github.com/phlex-ruby/phlex/security/advisories/GHSA-242p-4v39-2v8g",
        "before_after_code_files": [
          "lib/phlex/sgml.rb||lib/phlex/sgml.rb",
          "lib/phlex/version.rb||lib/phlex/version.rb",
          "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/phlex/sgml.rb||lib/phlex/sgml.rb",
            "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb"
          ],
          "candidate": [
            "lib/phlex/sgml.rb||lib/phlex/sgml.rb",
            "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/phlex/sgml.rb||lib/phlex/sgml.rb": [
          "File: lib/phlex/sgml.rb -> lib/phlex/sgml.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "389:      else raise ArgumentError, \"Attribute keys should be Strings or Symbols.\"",
          "390:     end",
          "392:     # Detect unsafe attribute names. Attribute names are considered unsafe if they match an event attribute or include unsafe characters.",
          "394:      raise ArgumentError, \"Unsafe attribute name detected: #{k}.\"",
          "395:     end",
          "",
          "[Removed Lines]",
          "393:     if HTML::EVENT_ATTRIBUTES[name] || name.match?(/[<>&\"']/)",
          "",
          "[Added Lines]",
          "392:     lower_name = name.downcase",
          "393:     next if lower_name == \"href\" && v.start_with?(/\\s*javascript:/i)",
          "396:     if HTML::EVENT_ATTRIBUTES[lower_name] || name.match?(/[<>&\"']/)",
          "",
          "---------------"
        ],
        "lib/phlex/version.rb||lib/phlex/version.rb": [
          "File: lib/phlex/version.rb -> lib/phlex/version.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: # frozen_string_literal: true",
          "3: module Phlex",
          "5: end",
          "",
          "[Removed Lines]",
          "4:  VERSION = \"1.7.0\"",
          "",
          "[Added Lines]",
          "4:  VERSION = \"1.7.1\"",
          "",
          "---------------"
        ],
        "test/phlex/view/naughty_business.rb||test/phlex/view/naughty_business.rb": [
          "File: test/phlex/view/naughty_business.rb -> test/phlex/view/naughty_business.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: describe Phlex::HTML do",
          "4:  extend ViewHelper",
          "6:  with \"naughty text\" do",
          "7:   view do",
          "8:    def template",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:  with \"naughty javascript links\" do",
          "7:   view do",
          "8:    def template",
          "9:     a(href: \"javascript:alert(1)\") { \"a\" }",
          "10:     a(href: \"JAVASCRIPT:alert(1)\") { \"b\" }",
          "11:     a(href: :\"JAVASCRIPT:alert(1)\") { \"c\" }",
          "12:     a(HREF: \"javascript:alert(1)\") { \"d\" }",
          "13:    end",
          "14:   end",
          "16:   it \"removes the href attributes\" do",
          "17:    expect(output).to be == \"<a>a</a><a>b</a><a>c</a><a>d</a>\"",
          "18:   end",
          "19:  end",
          "21:  with \"naughty uppercase event tag\" do",
          "22:   view do",
          "23:    def template",
          "24:     button ONCLICK: \"ALERT(1)\" do",
          "25:      \"naughty button\"",
          "26:     end",
          "27:    end",
          "28:   end",
          "30:   it \"raises\" do",
          "31:    expect { output }.to raise_exception ArgumentError,",
          "32:     message: be == \"Unsafe attribute name detected: ONCLICK.\"",
          "33:   end",
          "34:  end",
          "",
          "---------------"
        ]
      }
    }
  ]
}