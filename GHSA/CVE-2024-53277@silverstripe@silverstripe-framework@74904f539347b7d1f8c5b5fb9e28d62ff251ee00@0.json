{
  "cve_id": "CVE-2024-53277",
  "cve_desc": "Silverstripe Framework is a PHP framework which powers the Silverstripe CMS. In some cases, form messages can contain HTML markup. This is an intentional feature, allowing links and other relevant HTML markup for the given message. Some form messages include content that the user can provide. There are scenarios in the CMS where that content doesn't get correctly sanitised prior to being included in the form message, resulting in an XSS vulnerability. This issue has been addressed in silverstripe/framework version 5.3.8 and users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "silverstripe/silverstripe-framework",
  "patch_hash": "74904f539347b7d1f8c5b5fb9e28d62ff251ee00",
  "patch_info": {
    "commit_hash": "74904f539347b7d1f8c5b5fb9e28d62ff251ee00",
    "repo": "silverstripe/silverstripe-framework",
    "commit_url": "https://github.com/silverstripe/silverstripe-framework/commit/74904f539347b7d1f8c5b5fb9e28d62ff251ee00",
    "files": [
      "src/Core/XssSanitiser.php",
      "src/Forms/FormMessage.php",
      "src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
      "tests/php/Core/XssSanitiserTest.php",
      "tests/php/Forms/FormMessageTest.php",
      "tests/php/Forms/FormMessageTest/TestFormMessage.php"
    ],
    "message": "[CVE-2024-53277] Sanitise form messages against XSS attacks (#11555)\n\nIncludes some new additional XSS protection inspired by Symfony",
    "before_after_code_files": [
      "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php",
      "src/Forms/FormMessage.php||src/Forms/FormMessage.php",
      "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
      "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php",
      "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php",
      "tests/php/Forms/FormMessageTest/TestFormMessage.php||tests/php/Forms/FormMessageTest/TestFormMessage.php"
    ]
  },
  "patch_diff": {
    "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php": [
      "File: src/Core/XssSanitiser.php -> src/Core/XssSanitiser.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: namespace SilverStripe\\Core;",
      "5: use DOMAttr;",
      "6: use DOMElement;",
      "7: use SilverStripe\\Core\\Injector\\Injectable;",
      "8: use SilverStripe\\View\\Parsers\\HTMLValue;",
      "13: class XssSanitiser",
      "14: {",
      "15:     use Injectable;",
      "23:     private array $attributesToRemove = [",
      "24:         'on*',",
      "25:         'accesskey',",
      "26:     ];",
      "28:     private array $elementsToRemove = [",
      "29:         'embed',",
      "30:         'object',",
      "31:         'script',",
      "32:         'style',",
      "33:         'svg',",
      "34:     ];",
      "36:     private bool $keepInnerHtmlOnRemoveElement = true;",
      "38:     private bool $removeDataSvg = true;",
      "40:     private bool $removeSvgFile = true;",
      "45:     public function sanitiseString(string $html): string",
      "46:     {",
      "47:         $htmlValue = HTMLValue::create($html);",
      "48:         $this->sanitiseHtmlValue($htmlValue);",
      "49:         return $htmlValue->getContent();",
      "50:     }",
      "55:     public function sanitiseHtmlValue(HTMLValue $html): void",
      "56:     {",
      "57:         foreach ($html->query('//*') as $element) {",
      "58:             if (!is_a($element, DOMElement::class)) {",
      "59:                 continue;",
      "60:             }",
      "61:             $this->sanitiseElement($element);",
      "62:         }",
      "63:     }",
      "68:     public function sanitiseElement(DOMElement $element): void",
      "69:     {",
      "71:         $removed = $this->stripElement($element);",
      "72:         if ($removed) {",
      "73:             return;",
      "74:         }",
      "75:         $this->stripAttributes($element);",
      "76:         $this->stripAttributeContents($element);",
      "77:     }",
      "82:     public function getElementsToRemove(): array",
      "83:     {",
      "84:         return $this->elementsToRemove;",
      "85:     }",
      "91:     public function setElementsToRemove(array $elements): static",
      "92:     {",
      "93:         $this->elementsToRemove = $elements;",
      "94:         return $this;",
      "95:     }",
      "100:     public function getAttributesToRemove(): array",
      "101:     {",
      "102:         return $this->attributesToRemove;",
      "103:     }",
      "109:     public function setAttributesToRemove(array $attributes): static",
      "110:     {",
      "111:         $this->attributesToRemove = $attributes;",
      "112:         return $this;",
      "113:     }",
      "118:     public function getKeepInnerHtmlOnRemoveElement(): bool",
      "119:     {",
      "120:         return $this->keepInnerHtmlOnRemoveElement;",
      "121:     }",
      "126:     public function setKeepInnerHtmlOnRemoveElement(bool $keep): static",
      "127:     {",
      "128:         $this->keepInnerHtmlOnRemoveElement = $keep;",
      "129:         return $this;",
      "130:     }",
      "136:     private function stripElement(DOMElement $element): bool",
      "137:     {",
      "138:         if (!in_array($element->tagName, $this->getElementsToRemove())) {",
      "139:             return false;",
      "140:         }",
      "142:         $parentNode = $element->parentNode;",
      "143:         if ($this->getKeepInnerHtmlOnRemoveElement() && $parentNode && $element->hasChildNodes()) {",
      "145:             while ($element->hasChildNodes()) {",
      "146:                 $parentNode->insertBefore($element->firstChild, $element);",
      "147:             }",
      "148:         }",
      "149:         $element->remove();",
      "150:         return true;",
      "151:     }",
      "156:     private function stripAttributes(DOMElement $element): void",
      "157:     {",
      "158:         $attributesToRemove = $this->getAttributesToRemove();",
      "159:         if (empty($attributesToRemove)) {",
      "160:             return;",
      "161:         }",
      "162:         $attributes = $element->attributes;",
      "163:         for ($i = count($attributes) - 1; $i >= 0; $i--) {",
      "165:             $attr = $attributes->item($i);",
      "166:             foreach ($attributesToRemove as $toRemove) {",
      "167:                 if (str_starts_with($toRemove, '*') && str_ends_with($attr->name, str_replace('*', '', $toRemove))) {",
      "168:                     $element->removeAttributeNode($attr);",
      "169:                 } elseif (str_ends_with($toRemove, '*') && str_starts_with($attr->name, str_replace('*', '', $toRemove))) {",
      "170:                     $element->removeAttributeNode($attr);",
      "171:                 } elseif (!str_contains($toRemove, '*') && $attr->name === $toRemove) {",
      "172:                     $element->removeAttributeNode($attr);",
      "173:                 }",
      "174:             }",
      "175:         }",
      "176:     }",
      "183:     private function stripAttributeContents(DOMElement $element): void",
      "184:     {",
      "185:         $regex = $this->getStripAttributeContentsRegex();",
      "186:         foreach (['lowsrc', 'src', 'href', 'data'] as $dangerAttribute) {",
      "187:             if ($element->hasAttribute($dangerAttribute)) {",
      "188:                 $attrContent = $element->getAttribute($dangerAttribute);",
      "189:                 if (preg_match($regex, $attrContent)) {",
      "190:                     $element->removeAttribute($dangerAttribute);",
      "191:                 }",
      "192:             }",
      "193:         }",
      "194:     }",
      "196:     private function getStripAttributeContentsRegex(): string",
      "197:     {",
      "198:         $regexes = [",
      "199:             $this->splitWithWhitespaceRegex('javascript:'),",
      "200:             $this->splitWithWhitespaceRegex('data:text/html'),",
      "201:             $this->splitWithWhitespaceRegex('vbscript:'),",
      "202:         ];",
      "204:         return '#^\\s*(' . implode('|', $regexes) . ')#iu';",
      "205:     }",
      "207:     private function splitWithWhitespaceRegex(string $string): string",
      "208:     {",
      "211:         return implode('\\s*', str_split($string));",
      "212:     }",
      "213: }",
      "",
      "---------------"
    ],
    "src/Forms/FormMessage.php||src/Forms/FormMessage.php": [
      "File: src/Forms/FormMessage.php -> src/Forms/FormMessage.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: namespace SilverStripe\\Forms;",
      "5: use InvalidArgumentException;",
      "6: use SilverStripe\\ORM\\ValidationResult;",
      "7: use SilverStripe\\View\\ViewableData;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: use SilverStripe\\Core\\XssSanitiser;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "41:     public function getMessage()",
      "42:     {",
      "44:     }",
      "",
      "[Removed Lines]",
      "43:         return $this->message;",
      "",
      "[Added Lines]",
      "45:         $message = $this->message;",
      "46:         if ($this->getMessageCast() === ValidationResult::CAST_HTML) {",
      "47:             $message = XssSanitiser::create()->sanitiseString($message);",
      "48:         }",
      "49:         return $message;",
      "",
      "---------------"
    ],
    "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php": [
      "File: src/Forms/HTMLEditor/HTMLEditorSanitiser.php -> src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "6: use DOMElement;",
      "7: use SilverStripe\\Core\\Config\\Configurable;",
      "8: use SilverStripe\\Core\\Injector\\Injectable;",
      "9: use SilverStripe\\View\\Parsers\\HTMLValue;",
      "10: use stdClass;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "9: use SilverStripe\\Core\\XssSanitiser;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "289:     {",
      "290:         $linkRelValue = $this->config()->get('link_rel_value');",
      "291:         $doc = $html->getDocument();",
      "294:         foreach ($html->query('//body//*') as $el) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "295:         $xssSanitiser = XssSanitiser::create();",
      "296:         $xssSanitiser->setElementsToRemove([])->setAttributesToRemove([]);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "342:                     $el->setAttribute($attr, $forced);",
      "343:                 }",
      "355:             }",
      "357:             if ($el->tagName === 'a' && $linkRelValue !== null) {",
      "",
      "[Removed Lines]",
      "346:                 $regex = '#^\\s*(' . implode('\\s*', str_split('javascript:')) . '|' . implode('\\s*', str_split('data:text/html;')) . ')#i';",
      "348:                 foreach (['src', 'href', 'data'] as $dangerAttribute) {",
      "349:                     if ($el->hasAttribute($dangerAttribute)) {",
      "350:                         if (preg_match($regex, $el->getAttribute($dangerAttribute))) {",
      "351:                             $el->removeAttribute($dangerAttribute);",
      "352:                         }",
      "353:                     }",
      "354:                 }",
      "",
      "[Added Lines]",
      "351:                 $xssSanitiser->sanitiseElement($el);",
      "",
      "---------------"
    ],
    "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php": [
      "File: tests/php/Core/XssSanitiserTest.php -> tests/php/Core/XssSanitiserTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: namespace SilverStripe\\Core\\Tests;",
      "5: use DOMElement;",
      "6: use SilverStripe\\Core\\XssSanitiser;",
      "7: use SilverStripe\\Dev\\SapphireTest;",
      "8: use SilverStripe\\View\\Parsers\\HTMLValue;",
      "10: class XssSanitiserTest extends SapphireTest",
      "11: {",
      "12:     protected $usesDatabase = false;",
      "14:     public function provideSanitise(): array",
      "15:     {",
      "17:         return [",
      "19:             [",
      "20:                 'input' => '',",
      "21:                 'expected' => '',",
      "22:             ],",
      "23:             [",
      "24:                 'input' => 'hello world',",
      "25:                 'expected' => 'hello world',",
      "26:             ],",
      "27:             [",
      "28:                 'input' => '&lt;hello world&gt;',",
      "29:                 'expected' => '&lt;hello world&gt;',",
      "30:             ],",
      "31:             [",
      "32:                 'input' => '< Hello',",
      "33:                 'expected' => ' Hello',",
      "34:             ],",
      "35:             [",
      "36:                 'input' => 'Lorem & Ipsum',",
      "37:                 'expected' => 'Lorem &amp; Ipsum',",
      "38:             ],",
      "40:             [",
      "41:                 'input' => '<unknown>Lorem ipsum</unknown>',",
      "42:                 'expected' => '<unknown>Lorem ipsum</unknown>',",
      "43:             ],",
      "45:             [",
      "46:                 'input' => '<script>alert(\\'ok\\');</script>',",
      "47:                 'expected' => 'alert(\\'ok\\');',",
      "48:             ],",
      "49:             [",
      "50:                 'input' => 'javascript:/*--></title></style></textarea></script></xmp><svg/onload=\\'+/\"/+/onmouseover=1/+/[*/[]/+alert(1)//\\'>',",
      "51:                 'expected' => 'javascript:/*--&gt;',",
      "52:             ],",
      "53:             [",
      "55:                 'input' => '<scr<script>ipt>alert(1)</script>',",
      "56:                 'expected' => '<scr>ipt&gt;alert(1)</scr>',",
      "57:             ],",
      "58:             [",
      "60:                 'input' => '<scr<a>ipt>alert(1)</script>',",
      "61:                 'expected' => '<scr><a>ipt&gt;alert(1)</a></scr>',",
      "62:             ],",
      "63:             [",
      "65:                 'input' => '<noscript>Lorem ipsum</noscript>',",
      "66:                 'expected' => '<noscript>Lorem ipsum</noscript>',",
      "67:             ],",
      "68:             [",
      "69:                 'input' => '<div>Lorem ipsum dolor sit amet, consectetur adipisicing elit.<script>alert(\\'ok\\');</script></div>',",
      "70:                 'expected' => '<div>Lorem ipsum dolor sit amet, consectetur adipisicing elit.alert(\\'ok\\');</div>',",
      "71:             ],",
      "72:             [",
      "73:                 'input' => '<a href=\"javascript:alert(\\'ok\\')\">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
      "74:                 'expected' => '<a>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
      "75:             ],",
      "76:             [",
      "78:                 'input' => '<<a href=\"javascript:evil\"/>a href=\"javascript:evil\"/>',",
      "79:                 'expected' => '<a>a href=\"javascript:evil\"/&gt;</a>',",
      "80:             ],",
      "81:             [",
      "82:                 'input' => '<a href=\"javascript:alert(\\'ok\\')\">Test</a>',",
      "83:                 'expected' => '<a>Test</a>',",
      "84:             ],",
      "85:             [",
      "86:                 'input' => '<a href=\"javascript://%0Aalert(document.cookie)\">Test</a>',",
      "87:                 'expected' => '<a>Test</a>',",
      "88:             ],",
      "89:             [",
      "90:                 'input' => '<a href=\"&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;\">Lorem ipsum</a>',",
      "91:                 'expected' => '<a>Lorem ipsum</a>',",
      "92:             ],",
      "93:             [",
      "95:                 'input' => \"<a href=\\\"ja\\tva\\v\\r\\n sc\u2000\u2001\u2008\u2006\u2003r\u2002i\u202f\u2007\u205f\u3000\u2009\u2004\u200a\u2005pt:alert('foo')\\\">Lorem ipsum</a>\",",
      "96:                 'expected' => '<a>Lorem ipsum</a>',",
      "97:             ],",
      "98:             [",
      "100:                 'input' => '<a href= onmouseover=\"alert(\\\\\\'XSS\\\\\\');\">Lorem ipsum</a>',",
      "101:                 'expected' => '<a href=\"onmouseover=&quot;alert(\\&#039;XSS\\&#039;);&quot;\">Lorem ipsum</a>',",
      "102:             ],",
      "103:             [",
      "104:                 'input' => '<a href=\"http://example.com\" onclick=\"alert(\\'ok\\')\">Test</a>',",
      "105:                 'expected' => '<a href=\"http://example.com\">Test</a>',",
      "106:             ],",
      "107:             [",
      "108:                 'input' => '<a href=\"javascript:\" title=\"Link title\">Lorem ipsum</a>',",
      "109:                 'expected' => '<a title=\"Link title\">Lorem ipsum</a>',",
      "110:             ],",
      "111:             [",
      "113:                 'input' => '<figure><img src=\"https://example.com/img/example.jpg\" onclick=\"alert(\\'ok\\')\" /></figure>',",
      "114:                 'expected' => '<figure><img src=\"https://example.com/img/example.jpg\"></figure>',",
      "115:             ],",
      "116:             [",
      "118:                 'input' => '<img src= onmouseover=\"alert(\\'XSS\\');\">',",
      "119:                 'expected' => '<img src=\"onmouseover=&quot;alert(&#039;XSS&#039;);&quot;\">',",
      "120:             ],",
      "121:             [",
      "123:                 'input' => '<<img src=\"javascript:evil\"/>iframe src=\"javascript:evil\"/>',",
      "124:                 'expected' => '<img>iframe src=\"javascript:evil\"/&gt;',",
      "125:             ],",
      "126:             [",
      "128:                 'input' => '<<img src=\"javascript:evil\"/>img src=\"javascript:evil\"/>',",
      "129:                 'expected' => '<img>img src=\"javascript:evil\"/&gt;',",
      "130:             ],",
      "131:             [",
      "132:                 'input' => '<IMG SRC=\"javascript:alert(\\'XSS\\');\">',",
      "133:                 'expected' => '<img>',",
      "134:             ],",
      "135:             [",
      "136:                 'input' => '<IMG SRC=javascript:alert(\\'XSS\\')>',",
      "137:                 'expected' => '<img>',",
      "138:             ],",
      "139:             [",
      "140:                 'input' => '<IMG SRC=JaVaScRiPt:alert(\\'XSS\\')>',",
      "141:                 'expected' => '<img>',",
      "142:             ],",
      "143:             [",
      "144:                 'input' => '<IMG SRC=javascript:alert(&quot;XSS&quot;)>',",
      "145:                 'expected' => '<img>',",
      "146:             ],",
      "147:             [",
      "149:                 'input' => '<IMG SRC=`javascript:alert(\"RSnake says, \\'XSS\\'\")`>',",
      "150:                 'expected' => '<img src=\"`javascript:alert(&quot;RSnake\">',",
      "151:             ],",
      "152:             [",
      "153:                 'input' => '<IMG \"\"\"><SCRIPT>alert(\"XSS\")</SCRIPT>\"\\>',",
      "154:                 'expected' => '<img>alert(\"XSS\")\"\\&gt;',",
      "155:             ],",
      "156:             [",
      "157:                 'input' => '<IMG SRC=javascript:alert(String.fromCharCode(88,83,83))>',",
      "158:                 'expected' => '<img>',",
      "159:             ],",
      "160:             [",
      "161:                 'input' => '<IMG SRC=# onmouseover=\"alert(\\'xxs\\')\">',",
      "162:                 'expected' => '<img src=\"#\">',",
      "163:             ],",
      "164:             [",
      "165:                 'input' => '<img src=x onerror=\"&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041\">',",
      "166:                 'expected' => '<img src=\"x\">',",
      "167:             ],",
      "168:             [",
      "170:                 'input' => '<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>',",
      "171:                 'expected' => '<img>',",
      "172:             ],",
      "173:             [",
      "175:                 'input' => '<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>',",
      "176:                 'expected' => '<img src=\"&amp;#0000106&amp;#0000097&amp;#0000118&amp;#0000097&amp;#0000115&amp;#0000099&amp;#0000114&amp;#0000105&amp;#0000112&amp;#0000116&amp;#0000058&amp;#0000097&amp;#0000108&amp;#0000101&amp;#0000114&amp;#0000116&amp;#0000040&amp;#0000039&amp;#0000088&amp;#0000083&amp;#0000083&amp;#0000039&amp;#0000041\">',",
      "177:             ],",
      "178:             [",
      "180:                 'input' => '<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>',",
      "181:                 'expected' => '<img src=\"&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29\">',",
      "182:             ],",
      "183:             [",
      "186:                 'input' => '<IMG SRC=\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\">',",
      "187:                 'expected' => '<img src=\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\">',",
      "188:             ],",
      "189:             [",
      "190:                 'input' => '<IMG LOWSRC=\"javascript:alert(\\'XSS\\')\">',",
      "191:                 'expected' => '<img>',",
      "192:             ],",
      "193:             [",
      "194:                 'input' => '<IMG SRC=\\'vbscript:msgbox(\\\"XSS\")\\'>',",
      "195:                 'expected' => '<img>',",
      "196:             ],",
      "197:             [",
      "198:                 'input' => '<img src=\"javascript:\" alt=\"Image alternative text\" title=\"Image title\">',",
      "199:                 'expected' => '<img alt=\"Image alternative text\" title=\"Image title\">',",
      "200:             ],",
      "201:             [",
      "202:                 'input' => '<svg/onload=alert(\\'XSS\\')>',",
      "203:                 'expected' => '',",
      "204:             ],",
      "205:             [",
      "206:                 'input' => '<BGSOUND SRC=\"javascript:alert(\\'XSS\\');\">',",
      "207:                 'expected' => '<bgsound></bgsound>',",
      "208:             ],",
      "209:             [",
      "211:                 'input' => '<BR SIZE=\"&{alert(\\'XSS\\')}\">',",
      "212:                 'expected' => '<br size=\"&amp;{alert(&#039;XSS&#039;)}\">',",
      "213:             ],",
      "214:             [",
      "215:                 'input' => '<BR></br>',",
      "216:                 'expected' => '<br><br>',",
      "217:             ],",
      "219:             [",
      "220:                 'input' => '<OBJECT TYPE=\"text/x-scriptlet\" DATA=\"http://xss.rocks/scriptlet.html\"></OBJECT>',",
      "221:                 'expected' => '',",
      "222:             ],",
      "223:             [",
      "225:                 'input' => '<EMBED SRC=\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\" type=\"image/svg+xml\" AllowScriptAccess=\"always\"></EMBED>',",
      "226:                 'expected' => '',",
      "227:             ],",
      "228:             [",
      "230:                 'input' => '!<textarea>&lt;/textarea&gt;&lt;svg/onload=prompt`xs`&gt;</textarea>!',",
      "231:                 'expected' => '!<textarea>&lt;/textarea&gt;&lt;svg/onload=prompt`xs`&gt;</textarea>!',",
      "232:             ],",
      "233:             [",
      "234:                 'input' => '!<textarea></textarea><svg/onload=prompt`xs`></textarea>!',",
      "235:                 'expected' => '!<textarea></textarea>!',",
      "236:             ],",
      "237:             [",
      "238:                 'input' => '\"><svg/onload=confirm(1)>\"@x.y',",
      "239:                 'expected' => '\"&gt;\"@x.y',",
      "240:             ],",
      "241:             [",
      "242:                 'input' => '<div class=\"some-class\"><img src=\"https://example.com/image.jpg\"><span id=\"something025\">one</span><script>2</script>two<span id=\"something026\">three</span></div>',",
      "243:                 'expected' => '<div class=\"some-class\"><img src=\"https://example.com/image.jpg\"><span id=\"something025\">one</span>2two<span id=\"something026\">three</span></div>',",
      "244:             ],",
      "246:             [",
      "247:                 'input' => '<style>body { background: red; }</style>',",
      "248:                 'expected' => 'body { background: red; }',",
      "249:             ],",
      "250:             [",
      "251:                 'input' => '<div>Lorem ipsum dolor sit amet, consectetur.<style>body { background: red; }</style></div>',",
      "252:                 'expected' => '<div>Lorem ipsum dolor sit amet, consectetur.body { background: red; }</div>',",
      "253:             ],",
      "254:             [",
      "255:                 'input' => '<img src=\"https://example.com/img/example.jpg\" style=\"position:absolute;top:0;left:0;width:9000px;height:9000px;\">',",
      "256:                 'expected' => '<img src=\"https://example.com/img/example.jpg\" style=\"position:absolute;top:0;left:0;width:9000px;height:9000px;\">',",
      "257:             ],",
      "258:             [",
      "259:                 'input' => '<a style=\"font-size: 40px; color: red;\">Lorem ipsum dolor sit amet, consectetur.</a>',",
      "260:                 'expected' => '<a style=\"font-size: 40px; color: red;\">Lorem ipsum dolor sit amet, consectetur.</a>',",
      "261:             ],",
      "263:             [",
      "265:                 'input' => 'Lorem ipsum dolor sit amet, consectetur<!--if[true]> <script>alert(1337)</script> -->',",
      "266:                 'expected' => 'Lorem ipsum dolor sit amet, consectetur<!--if[true]> <script>alert(1337)</script> -->',",
      "267:             ],",
      "268:             [",
      "269:                 'input' => 'Lorem ipsum<![CDATA[ <!-- ]]> <script>alert(1337)</script> <!-- -->',",
      "270:                 'expected' => 'Lorem ipsum <!--  alert(1337) <!-- -->',",
      "271:             ],",
      "273:             [",
      "274:                 'input' => '<a>Lorem ipsum</a>',",
      "275:                 'expected' => '<a>Lorem ipsum</a>',",
      "276:             ],",
      "277:             [",
      "278:                 'input' => '<a href=\"/img/example.jpg\" title=\"Link title\">Lorem ipsum</a>',",
      "279:                 'expected' => '<a href=\"/img/example.jpg\" title=\"Link title\">Lorem ipsum</a>',",
      "280:             ],",
      "281:             [",
      "282:                 'input' => '<a href=\"http://example.com/index.html#this:stuff\">Lorem ipsum</a>',",
      "283:                 'expected' => '<a href=\"http://example.com/index.html#this:stuff\">Lorem ipsum</a>',",
      "284:             ],",
      "285:             [",
      "286:                 'input' => '<a href=\"mailto:test@example.com\" title=\"Link title\">Lorem ipsum</a>',",
      "287:                 'expected' => '<a href=\"mailto:test@example.com\" title=\"Link title\">Lorem ipsum</a>',",
      "288:             ],",
      "289:             [",
      "290:                 'input' => '<img src=\"/img/example.jpg\" onanything=\"\" alt=\"Image alternative text\" title=\"Image title\" height=\"150\" width=\"300\">',",
      "291:                 'expected' => '<img src=\"/img/example.jpg\" alt=\"Image alternative text\" title=\"Image title\" height=\"150\" width=\"300\">',",
      "292:             ],",
      "293:             [",
      "294:                 'input' => '<img src=\"http://example.com/img/examp:le.jpg\" alt=\"Image alternative text\" title=\"Image title\">',",
      "295:                 'expected' => '<img src=\"http://example.com/img/examp:le.jpg\" alt=\"Image alternative text\" title=\"Image title\">',",
      "296:             ],",
      "297:             [",
      "298:                 'input' => '<img>',",
      "299:                 'expected' => '<img>',",
      "300:             ],",
      "301:             [",
      "302:                 'input' => '<div class=\"some-class\"><img src=\"https://example.com/image.jpg\"><span id=\"something025\">one</span>two<span id=\"something026\">three</span></div>',",
      "303:                 'expected' => '<div class=\"some-class\"><img src=\"https://example.com/image.jpg\"><span id=\"something025\">one</span>two<span id=\"something026\">three</span></div>',",
      "304:             ],",
      "305:         ];",
      "306:     }",
      "311:     public function testSanitiseString(string $input, string $expected): void",
      "312:     {",
      "313:         $sanitiser = new XssSanitiser();",
      "314:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
      "315:     }",
      "320:     public function testSanitiseHtmlValue(string $input, string $expected): void",
      "321:     {",
      "322:         $sanitiser = new XssSanitiser();",
      "323:         $htmlValue = new HTMLValue($input);",
      "324:         $sanitiser->sanitiseHtmlValue($htmlValue);",
      "325:         $this->assertSame($expected, $htmlValue->getContent());",
      "326:     }",
      "331:     public function testSanitiseElement(string $input, string $expected): void",
      "332:     {",
      "333:         $sanitiser = new XssSanitiser();",
      "334:         $htmlValue = new HTMLValue($input);",
      "335:         foreach ($htmlValue->query('//*') as $element) {",
      "336:             if (!is_a($element, DOMElement::class)) {",
      "337:                 continue;",
      "338:             }",
      "339:             $element = $sanitiser->sanitiseElement($element);",
      "340:         }",
      "341:         $this->assertSame($expected, $htmlValue->getContent());",
      "342:     }",
      "344:     public function provideSanitiseElementsAllowed(): array",
      "345:     {",
      "346:         return [",
      "347:             'disallow these by default' => [",
      "348:                 'input' => '<script>alert(\"one\");</script><svg><circle cx=\"50\" cy=\"50\" r=\"40\" /></svg><embed src=\"image.jpg\"></embed><object data=\"image.jpg\"></object>',",
      "349:                 'removeElements' => null,",
      "350:                 'expected' => 'alert(\"one\");<circle cx=\"50\" cy=\"50\" r=\"40\"></circle>',",
      "351:             ],",
      "352:             'allow all' => [",
      "353:                 'input' => '<script>alert(\"one\");</script><svg><circle cx=\"50\" cy=\"50\" r=\"40\" /></svg><embed src=\"image.jpg\"></embed><object data=\"image.jpg\"></object>',",
      "354:                 'removeElements' => [],",
      "355:                 'expected' => '<script>alert(\"one\");</script><svg><circle cx=\"50\" cy=\"50\" r=\"40\"></circle></svg><embed src=\"image.jpg\"></embed><object data=\"image.jpg\"></object>',",
      "356:             ],",
      "357:             'disallow circle' => [",
      "358:                 'input' => '<script>alert(\"one\");</script><svg><circle cx=\"50\" cy=\"50\" r=\"40\" /></svg><embed src=\"image.jpg\"></embed><object data=\"image.jpg\"></object>',",
      "359:                 'removeElements' => ['circle'],",
      "360:                 'expected' => '<script>alert(\"one\");</script><svg></svg><embed src=\"image.jpg\"></embed><object data=\"image.jpg\"></object>',",
      "361:             ],",
      "362:         ];",
      "363:     }",
      "368:     public function testSanitiseElementsAllowed(string $input, ?array $removeElements, string $expected): void",
      "369:     {",
      "370:         $sanitiser = new XssSanitiser();",
      "371:         if ($removeElements !== null) {",
      "372:             $sanitiser->setElementsToRemove($removeElements);",
      "373:         }",
      "374:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
      "375:     }",
      "377:     public function provideSanitiseAttributesAllowed(): array",
      "378:     {",
      "379:         return [",
      "380:             'disallow these by default' => [",
      "381:                 'input' => '<span class=\"my-class\" onanything onerror onclick onetc=\"anything\" accesskey=\"A\">abcd</span>',",
      "382:                 'removeAttributes' => null,",
      "383:                 'expected' => '<span class=\"my-class\">abcd</span>',",
      "384:             ],",
      "385:             'allow all' => [",
      "386:                 'input' => '<span class=\"my-class\" onanything onerror onclick onetc=\"anything\" accesskey=\"A\">abcd</span>',",
      "387:                 'removeAttributes' => [],",
      "388:                 'expected' => '<span class=\"my-class\" onanything=\"\" onerror=\"\" onclick=\"\" onetc=\"anything\" accesskey=\"A\">abcd</span>',",
      "389:             ],",
      "390:             'disallow class' => [",
      "391:                 'input' => '<span class=\"my-class\" onanything onerror onclick onetc=\"anything\" accesskey=\"A\">abcd</span>',",
      "392:                 'removeAttributes' => ['class'],",
      "393:                 'expected' => '<span onanything=\"\" onerror=\"\" onclick=\"\" onetc=\"anything\" accesskey=\"A\">abcd</span>',",
      "394:             ],",
      "395:             'wildcard attributes' => [",
      "396:                 'input' => '<span class=\"my-class\" title=\"my title\" cattle=\"something\" car=\"a thing\" clap=\"nope\" clop=\"yep\" disabled=\"true\">abcd</span>',",
      "397:                 'removeAttributes' => [",
      "398:                     'cla*',",
      "399:                     '*tle',",
      "401:                     'di*ed',",
      "402:                 ],",
      "403:                 'expected' => '<span car=\"a thing\" clop=\"yep\" disabled>abcd</span>',",
      "404:             ],",
      "406:             'remove all attributes' => [",
      "407:                 'input' => '<span class=\"my-class\" title=\"my title\" cattle=\"something\" car=\"a thing\" clap=\"nope\" clop=\"yep\" disabled=\"true\">abcd</span>',",
      "408:                 'removeAttributes' => [",
      "409:                     '*',",
      "410:                 ],",
      "411:                 'expected' => '<span>abcd</span>',",
      "412:             ],",
      "413:         ];",
      "414:     }",
      "419:     public function testSanitiseAttributesAllowed(string $input, ?array $removeAttributes, string $expected): void",
      "420:     {",
      "421:         $sanitiser = new XssSanitiser();",
      "422:         if ($removeAttributes !== null) {",
      "423:             $sanitiser->setAttributesToRemove($removeAttributes);",
      "424:         }",
      "425:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
      "426:     }",
      "428:     public function provideSanitiseNoKeepInnerHtml(): array",
      "429:     {",
      "430:         return [",
      "431:             'keeps inner html' => [",
      "432:                 'input' => '<section>something first<div>Keep this<span>and this</span></div><span>something last</span></section>',",
      "433:                 'keepInnerHtml' => true,",
      "434:                 'expected' => '<section>something firstKeep this<span>and this</span><span>something last</span></section>',",
      "435:             ],",
      "436:             'discards inner html' => [",
      "437:                 'input' => '<section>something first<div>Keep this<span>and this</span></div><span>something last</span></section>',",
      "438:                 'keepInnerHtml' => false,",
      "439:                 'expected' => '<section>something first<span>something last</span></section>',",
      "440:             ],",
      "441:             'multiple and nested disallowed elements (keep inner html)' => [",
      "442:                 'input' => '<section>something<div></div><div><div><div>nested </div><div>nested2</div></div></div><span>last</span></section>',",
      "443:                 'keepInnerHtml' => true,",
      "444:                 'expected' => '<section>somethingnested nested2<span>last</span></section>',",
      "445:             ],",
      "446:             'multiple and nested disallowed elements (discard inner html)' => [",
      "447:                 'input' => '<section>something<div></div><div><div><div>nested </div><div>nested2</div></div></div><span>last</span></section>',",
      "448:                 'keepInnerHtml' => false,",
      "449:                 'expected' => '<section>something<span>last</span></section>',",
      "450:             ],",
      "451:         ];",
      "452:     }",
      "457:     public function testSanitiseNoKeepInnerHtml(string $input, bool $keepInnerHtml, string $expected): void",
      "458:     {",
      "459:         $sanitiser = new XssSanitiser();",
      "460:         $sanitiser->setElementsToRemove(['div'])->setKeepInnerHtmlOnRemoveElement($keepInnerHtml);",
      "461:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
      "462:     }",
      "463: }",
      "",
      "---------------"
    ],
    "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php": [
      "File: tests/php/Forms/FormMessageTest.php -> tests/php/Forms/FormMessageTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: namespace SilverStripe\\Forms\\Tests;",
      "5: use SilverStripe\\Core\\Injector\\Injector;",
      "6: use SilverStripe\\Core\\XssSanitiser;",
      "7: use SilverStripe\\Dev\\SapphireTest;",
      "8: use SilverStripe\\Forms\\Tests\\FormMessageTest\\TestFormMessage;",
      "9: use SilverStripe\\ORM\\ValidationResult;",
      "11: class FormMessageTest extends SapphireTest",
      "12: {",
      "13:     protected $usesDatabase = false;",
      "15:     public function provideGetMessage(): array",
      "16:     {",
      "17:         return [",
      "18:             'empty HTML' => [",
      "19:                 'message' => '',",
      "20:                 'type' => '',",
      "21:                 'casting' => ValidationResult::CAST_HTML,",
      "22:                 'expected' => '',",
      "23:             ],",
      "24:             'empty plain text' => [",
      "25:                 'message' => '',",
      "26:                 'type' => '',",
      "27:                 'casting' => ValidationResult::CAST_TEXT,",
      "28:                 'expected' => '',",
      "29:             ],",
      "30:             'plain HTML' => [",
      "31:                 'message' => 'just some text',",
      "32:                 'type' => '',",
      "33:                 'casting' => ValidationResult::CAST_HTML,",
      "34:                 'expected' => 'just some text',",
      "35:             ],",
      "36:             'plain plain text' => [",
      "37:                 'message' => 'just some text',",
      "38:                 'type' => '',",
      "39:                 'casting' => ValidationResult::CAST_TEXT,",
      "40:                 'expected' => 'just some text',",
      "41:             ],",
      "42:             'HTML in HTML' => [",
      "43:                 'message' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "44:                 'type' => '',",
      "45:                 'casting' => ValidationResult::CAST_HTML,",
      "46:                 'expected' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "47:             ],",
      "48:             'HTML in plain text' => [",
      "49:                 'message' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "50:                 'type' => '',",
      "51:                 'casting' => ValidationResult::CAST_TEXT,",
      "52:                 'expected' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "53:             ],",
      "54:             'Type doesnt matter HTML' => [",
      "55:                 'message' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "56:                 'type' => 'an arbitrary string here',",
      "57:                 'casting' => ValidationResult::CAST_HTML,",
      "58:                 'expected' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "59:             ],",
      "60:             'Type doesnt matter text' => [",
      "61:                 'message' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "62:                 'type' => 'an arbitrary string here',",
      "63:                 'casting' => ValidationResult::CAST_TEXT,",
      "64:                 'expected' => '<div class=\"js-my-div\"><a href=\"https://example.com\">link</a></div>',",
      "65:             ],",
      "66:         ];",
      "67:     }",
      "74:     public function testGetMessage(string $message, string $type, string $casting, string $expected): void",
      "75:     {",
      "76:         $mockSanitiserClass = get_class(new class extends XssSanitiser {",
      "77:             public static int $called = 0;",
      "78:             public function sanitiseString(string $html): string",
      "79:             {",
      "80:                 static::$called++;",
      "81:                 return parent::sanitiseString($html);",
      "82:             }",
      "83:         });",
      "84:         Injector::inst()->load([",
      "85:             XssSanitiser::class => [",
      "86:                 'class' => $mockSanitiserClass,",
      "87:             ],",
      "88:         ]);",
      "89:         $expectedSanitisationCount = $casting === ValidationResult::CAST_HTML ? 1 : 0;",
      "91:         try {",
      "92:             $formMessage = new TestFormMessage();",
      "93:             $formMessage->setMessage($message, $type, $casting);",
      "94:             $this->assertSame($expected, $formMessage->getMessage());",
      "95:             $this->assertSame($expectedSanitisationCount, $mockSanitiserClass::$called);",
      "96:         } finally {",
      "97:             $mockSanitiserClass::$called = 0;",
      "98:         }",
      "99:     }",
      "100: }",
      "",
      "---------------"
    ],
    "tests/php/Forms/FormMessageTest/TestFormMessage.php||tests/php/Forms/FormMessageTest/TestFormMessage.php": [
      "File: tests/php/Forms/FormMessageTest/TestFormMessage.php -> tests/php/Forms/FormMessageTest/TestFormMessage.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: namespace SilverStripe\\Forms\\Tests\\FormMessageTest;",
      "5: use SilverStripe\\Dev\\TestOnly;",
      "6: use SilverStripe\\Forms\\FormMessage;",
      "11: class TestFormMessage implements TestOnly",
      "12: {",
      "13:     use FormMessage;",
      "14: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b8d20dc9d531550e06fd7da7a0eafa551922e2e1",
      "candidate_info": {
        "commit_hash": "b8d20dc9d531550e06fd7da7a0eafa551922e2e1",
        "repo": "silverstripe/silverstripe-framework",
        "commit_url": "https://github.com/silverstripe/silverstripe-framework/commit/b8d20dc9d531550e06fd7da7a0eafa551922e2e1",
        "files": [
          "src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
          "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php"
        ],
        "message": "[CVE-2024-32981] Disallow `data:text/html` in data attributes",
        "before_after_code_files": [
          "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
          "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php||tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php"
          ],
          "candidate": [
            "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Forms/HTMLEditor/HTMLEditorSanitiser.php||src/Forms/HTMLEditor/HTMLEditorSanitiser.php": [
          "File: src/Forms/HTMLEditor/HTMLEditorSanitiser.php -> src/Forms/HTMLEditor/HTMLEditorSanitiser.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "347:                 }",
          "352:                 foreach (['src', 'href', 'data'] as $dangerAttribute) {",
          "353:                     if ($el->hasAttribute($dangerAttribute)) {",
          "",
          "[Removed Lines]",
          "350:                 $regex = '/^\\s*' . implode('\\s*', str_split('javascript:')) . '/i';",
          "",
          "[Added Lines]",
          "350:                 $regex = '#^\\s*(' . implode('\\s*', str_split('javascript:')) . '|' . implode('\\s*', str_split('data:text/html;')) . ')#i';",
          "",
          "---------------"
        ],
        "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php||tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php": [
          "File: tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php -> tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "120:                 'object[data]',",
          "121:                 '<object data=javascript:alert()>',",
          "122:                 '<object></object>',",
          "124:             ],",
          "125:             [",
          "126:                 'img[src]',",
          "",
          "[Removed Lines]",
          "123:                 'Object with dangerous content in data attribute is completely removed'",
          "",
          "[Added Lines]",
          "123:                 'Object with dangerous javascript content in data attribute is completely removed'",
          "124:             ],",
          "125:             [",
          "126:                 'object[data]',",
          "127:                 '<object data=\"javascript:alert()\">',",
          "128:                 '<object></object>',",
          "129:                 'Object with dangerous javascript content in data attribute with quotes is completely removed'",
          "130:             ],",
          "131:             [",
          "132:                 'object[data]',",
          "133:                 '<object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5sb2NhdGlvbik8L3NjcmlwdD4=\">',",
          "134:                 '<object></object>',",
          "135:                 'Object with dangerous html content in data attribute is completely removed'",
          "136:             ],",
          "137:             [",
          "138:                 'object[data]',",
          "139:                 '<object data=\"' . implode(\"\\n\", str_split(' DATA:TEXT/HTML;')) . 'base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5sb2NhdGlvbik8L3NjcmlwdD4=\">',",
          "140:                 '<object></object>',",
          "141:                 'Object with split upper-case dangerous html content in data attribute is completely removed'",
          "142:             ],",
          "143:             [",
          "144:                 'object[data]',",
          "145:                 '<object data=\"data:text/xml;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5sb2NhdGlvbik8L3NjcmlwdD4=\">',",
          "146:                 '<object data=\"data:text/xml;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5sb2NhdGlvbik8L3NjcmlwdD4=\"></object>',",
          "147:                 'Object with safe xml content in data attribute is retained'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e99cfd62d160d145a76fcf9631e6b11226e42358",
      "candidate_info": {
        "commit_hash": "e99cfd62d160d145a76fcf9631e6b11226e42358",
        "repo": "silverstripe/silverstripe-framework",
        "commit_url": "https://github.com/silverstripe/silverstripe-framework/commit/e99cfd62d160d145a76fcf9631e6b11226e42358",
        "files": [
          "src/Core/XssSanitiser.php",
          "tests/php/Core/XssSanitiserTest.php",
          "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php"
        ],
        "message": "[CVE-2025-30148] Handle backspace characters in XSS",
        "before_after_code_files": [
          "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php",
          "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php",
          "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php||tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php",
            "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php"
          ],
          "candidate": [
            "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php",
            "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Core/XssSanitiser.php||src/Core/XssSanitiser.php": [
          "File: src/Core/XssSanitiser.php -> src/Core/XssSanitiser.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "201:             $this->splitWithWhitespaceRegex('vbscript:'),",
          "202:         ];",
          "205:     }",
          "207:     private function splitWithWhitespaceRegex(string $string): string",
          "",
          "[Removed Lines]",
          "204:         return '#^\\s*(' . implode('|', $regexes) . ')#iu';",
          "",
          "[Added Lines]",
          "206:         return '#^(\\s|\\x08)*(' . implode('|', $regexes) . ')(\\s|\\x08)*#iu';",
          "",
          "---------------"
        ],
        "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php": [
          "File: tests/php/Core/XssSanitiserTest.php -> tests/php/Core/XssSanitiserTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: class XssSanitiserTest extends SapphireTest",
          "11: {",
          "12:     protected $usesDatabase = false;",
          "14:     public function provideSanitise(): array",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13:     private const CHAR_BACKSPACE = \"\\x08\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73:                 'input' => '<a href=\"javascript:alert(\\'ok\\')\">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "74:                 'expected' => '<a>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "75:             ],",
          "76:             [",
          "78:                 'input' => '<<a href=\"javascript:evil\"/>a href=\"javascript:evil\"/>',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "79:             [",
          "80:                 'input' => '<a href=\"' . XssSanitiserTest::CHAR_BACKSPACE . 'javascript:alert(\\'ok\\')\">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "81:                 'expected' => '<a>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "82:             ],",
          "83:             [",
          "84:                 'input' => '<a href=\"javascript:alert(\\'ok\\')' . XssSanitiserTest::CHAR_BACKSPACE . '\">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "85:                 'expected' => '<a>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</a>',",
          "86:             ],",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "132:                 'input' => '<IMG SRC=\"javascript:alert(\\'XSS\\');\">',",
          "133:                 'expected' => '<img>',",
          "134:             ],",
          "135:             [",
          "136:                 'input' => '<IMG SRC=javascript:alert(\\'XSS\\')>',",
          "137:                 'expected' => '<img>',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "146:             [",
          "147:                 'input' => '<IMG SRC=\"' . XssSanitiserTest::CHAR_BACKSPACE . 'javascript:alert(\\'XSS\\');\">',",
          "148:                 'expected' => '<img>',",
          "149:             ],",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "206:                 'input' => '<BGSOUND SRC=\"javascript:alert(\\'XSS\\');\">',",
          "207:                 'expected' => '<bgsound></bgsound>',",
          "208:             ],",
          "209:             [",
          "211:                 'input' => '<BR SIZE=\"&{alert(\\'XSS\\')}\">',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "224:             [",
          "225:                 'input' => '<BGSOUND SRC=\"' . XssSanitiserTest::CHAR_BACKSPACE . 'javascript:alert(\\'XSS\\');\">',",
          "226:                 'expected' => '<bgsound></bgsound>',",
          "227:             ],",
          "",
          "---------------"
        ],
        "tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php||tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php": [
          "File: tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php -> tests/php/Forms/HTMLEditor/HTMLEditorSanitiserTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: class HTMLEditorSanitiserTest extends FunctionalTest",
          "12: {",
          "14:     public function provideSanitise(): array",
          "15:     {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14:     private const CHAR_BACKSPACE = \"\\x08\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:                 '<a>Test</a>',",
          "81:                 'Javascript in the href attribute of a link is completely removed'",
          "82:             ],",
          "83:             [",
          "84:                 'a[href|target|rel]',",
          "85:                 '<a href=\"' . implode(\"\\n\", str_split(' javascript:')) . '\">Test</a>',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85:             [",
          "86:                 'a[href|target|rel]',",
          "87:                 '<a href=\"' . HTMLEditorSanitiserTest::CHAR_BACKSPACE . 'javascript:alert(0);\">Test</a>',",
          "88:                 '<a>Test</a>',",
          "89:                 'Javascript in the href attribute with leading backspace of a link is completely removed'",
          "90:             ],",
          "91:             [",
          "92:                 'a[href|target|rel]',",
          "93:                 '<a href=\"javascript:alert(0);' . HTMLEditorSanitiserTest::CHAR_BACKSPACE . '\">Test</a>',",
          "94:                 '<a>Test</a>',",
          "95:                 'Javascript in the href attribute with backspace in middle of a link is completely removed'",
          "96:             ],",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "110:                 '<iframe></iframe>',",
          "111:                 'Javascript with tab elements the src attribute of an iframe is completely removed'",
          "112:             ],",
          "113:             [",
          "114:                 'object[data]',",
          "115:                 '<object data=\"OK\"></object>',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "127:             [",
          "128:                 'iframe[src]',",
          "129:                 '<iframe src=\"' . HTMLEditorSanitiserTest::CHAR_BACKSPACE . 'javascript:alert(0);\"></iframe>',",
          "130:                 '<iframe></iframe>',",
          "131:                 'Javascript in the src attribute of an iframe with a backspace is completely removed'",
          "132:             ],",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "128:                 '<object></object>',",
          "129:                 'Object with dangerous javascript content in data attribute with quotes is completely removed'",
          "130:             ],",
          "131:             [",
          "132:                 'object[data]',",
          "133:                 '<object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5sb2NhdGlvbik8L3NjcmlwdD4=\">',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "151:             [",
          "152:                 'object[data]',",
          "153:                 '<object data=\"' . HTMLEditorSanitiserTest::CHAR_BACKSPACE . 'javascript:alert()\">',",
          "154:                 '<object></object>',",
          "155:                 'Object with dangerous javascript content in data attribute with backspace is completely removed'",
          "156:             ],",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c307ecc623ce3e8920a0652f2b880ffe6c1aa3e3",
      "candidate_info": {
        "commit_hash": "c307ecc623ce3e8920a0652f2b880ffe6c1aa3e3",
        "repo": "silverstripe/silverstripe-framework",
        "commit_url": "https://github.com/silverstripe/silverstripe-framework/commit/c307ecc623ce3e8920a0652f2b880ffe6c1aa3e3",
        "files": [
          "tests/php/Core/XssSanitiserTest.php",
          "tests/php/Forms/FormMessageTest.php",
          "tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php"
        ],
        "message": "MNT Make data providers static",
        "before_after_code_files": [
          "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php",
          "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php",
          "tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php||tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php",
            "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php"
          ],
          "candidate": [
            "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php",
            "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php"
          ]
        }
      },
      "candidate_diff": {
        "tests/php/Core/XssSanitiserTest.php||tests/php/Core/XssSanitiserTest.php": [
          "File: tests/php/Core/XssSanitiserTest.php -> tests/php/Core/XssSanitiserTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: use SilverStripe\\Core\\XssSanitiser;",
          "7: use SilverStripe\\Dev\\SapphireTest;",
          "8: use SilverStripe\\View\\Parsers\\HTMLValue;",
          "10: class XssSanitiserTest extends SapphireTest",
          "11: {",
          "12:     protected $usesDatabase = false;",
          "15:     {",
          "17:         return [",
          "",
          "[Removed Lines]",
          "14:     public function provideSanitise(): array",
          "",
          "[Added Lines]",
          "9: use PHPUnit\\Framework\\Attributes\\DataProvider;",
          "15:     public static function provideSanitise(): array",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "305:         ];",
          "306:     }",
          "311:     public function testSanitiseString(string $input, string $expected): void",
          "312:     {",
          "313:         $sanitiser = new XssSanitiser();",
          "314:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
          "315:     }",
          "320:     public function testSanitiseHtmlValue(string $input, string $expected): void",
          "321:     {",
          "322:         $sanitiser = new XssSanitiser();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "309:     #[DataProvider('provideSanitise')]",
          "316:     #[DataProvider('provideSanitise')]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "325:         $this->assertSame($expected, $htmlValue->getContent());",
          "326:     }",
          "331:     public function testSanitiseElement(string $input, string $expected): void",
          "332:     {",
          "333:         $sanitiser = new XssSanitiser();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "325:     #[DataProvider('provideSanitise')]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "341:         $this->assertSame($expected, $htmlValue->getContent());",
          "342:     }",
          "345:     {",
          "346:         return [",
          "347:             'disallow these by default' => [",
          "",
          "[Removed Lines]",
          "344:     public function provideSanitiseElementsAllowed(): array",
          "",
          "[Added Lines]",
          "339:     public static function provideSanitiseElementsAllowed(): array",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "362:         ];",
          "363:     }",
          "368:     public function testSanitiseElementsAllowed(string $input, ?array $removeElements, string $expected): void",
          "369:     {",
          "370:         $sanitiser = new XssSanitiser();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "360:     #[DataProvider('provideSanitiseElementsAllowed')]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "374:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
          "375:     }",
          "378:     {",
          "379:         return [",
          "380:             'disallow these by default' => [",
          "",
          "[Removed Lines]",
          "377:     public function provideSanitiseAttributesAllowed(): array",
          "",
          "[Added Lines]",
          "370:     public static function provideSanitiseAttributesAllowed(): array",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "413:         ];",
          "414:     }",
          "419:     public function testSanitiseAttributesAllowed(string $input, ?array $removeAttributes, string $expected): void",
          "420:     {",
          "421:         $sanitiser = new XssSanitiser();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "409:     #[DataProvider('provideSanitiseAttributesAllowed')]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "425:         $this->assertSame($expected, $sanitiser->sanitiseString($input));",
          "426:     }",
          "429:     {",
          "430:         return [",
          "431:             'keeps inner html' => [",
          "",
          "[Removed Lines]",
          "428:     public function provideSanitiseNoKeepInnerHtml(): array",
          "",
          "[Added Lines]",
          "419:     public static function provideSanitiseNoKeepInnerHtml(): array",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "451:         ];",
          "452:     }",
          "457:     public function testSanitiseNoKeepInnerHtml(string $input, bool $keepInnerHtml, string $expected): void",
          "458:     {",
          "459:         $sanitiser = new XssSanitiser();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "445:     #[DataProvider('provideSanitiseNoKeepInnerHtml')]",
          "",
          "---------------"
        ],
        "tests/php/Forms/FormMessageTest.php||tests/php/Forms/FormMessageTest.php": [
          "File: tests/php/Forms/FormMessageTest.php -> tests/php/Forms/FormMessageTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: use SilverStripe\\Core\\XssSanitiser;",
          "7: use SilverStripe\\Dev\\SapphireTest;",
          "8: use SilverStripe\\Forms\\Tests\\FormMessageTest\\TestFormMessage;",
          "11: class FormMessageTest extends SapphireTest",
          "12: {",
          "13:     protected $usesDatabase = false;",
          "16:     {",
          "17:         return [",
          "18:             'empty HTML' => [",
          "",
          "[Removed Lines]",
          "9: use SilverStripe\\ORM\\ValidationResult;",
          "15:     public function provideGetMessage(): array",
          "",
          "[Added Lines]",
          "9: use SilverStripe\\Core\\Validation\\ValidationResult;",
          "10: use PHPUnit\\Framework\\Attributes\\DataProvider;",
          "16:     public static function provideGetMessage(): array",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "74:     public function testGetMessage(string $message, string $type, string $casting, string $expected): void",
          "75:     {",
          "76:         $mockSanitiserClass = get_class(new class extends XssSanitiser {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:     #[DataProvider('provideGetMessage')]",
          "",
          "---------------"
        ],
        "tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php||tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php": [
          "File: tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php -> tests/php/View/Shortcodes/EmbedShortcodeProviderTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: use SilverStripe\\View\\Embed\\EmbedContainer;",
          "13: use stdClass;",
          "14: use RuntimeException;",
          "16: class EmbedShortcodeProviderTest extends EmbedUnitTest",
          "17: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: use PHPUnit\\Framework\\Attributes\\DataProvider;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "222:         );",
          "223:     }",
          "226:     {",
          "227:         return [",
          "228:             'normal' => [",
          "",
          "[Removed Lines]",
          "225:     public function provideSandboxHtml(): array",
          "",
          "[Added Lines]",
          "226:     public static function provideSandboxHtml(): array",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "365:         ];",
          "366:     }",
          "371:     public function testSandboxHtml(",
          "372:         string $url,",
          "373:         array $excluded,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "369:     #[DataProvider('provideSandboxHtml')]",
          "",
          "---------------"
        ]
      }
    }
  ]
}