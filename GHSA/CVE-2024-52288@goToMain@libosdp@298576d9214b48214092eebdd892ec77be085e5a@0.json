{
  "cve_id": "CVE-2024-52288",
  "cve_desc": "libosdp is an implementation of IEC 60839-11-5 OSDP (Open Supervised Device Protocol) and provides a C library with support for C++, Rust and Python3. In affected versions an unexpected `REPLY_CCRYPT` or `REPLY_RMAC_I` may be introduced into an active stream when they should not be. Once RMAC_I message can be sent during a session, attacker with MITM access to the communication may intercept the original RMAC_I reply and save it. While the session continues, the attacker will record all of the replies and save them, till capturing the message to be replied (can be detected by ID, length or time based on inspection of visual activity next to the reader) Once attacker captures a session with the message to be replayed, he stops resetting the connection and waits for signal to perform the replay to of the PD to CP message (ex: by signaling remotely to the MIMT device or setting a specific timing). In order to replay, the attacker will craft a specific RMAC_I message in the proper seq of the execution, which will result in reverting the RMAC to the beginning of the session. At that phase - attacker can replay all the messages from the beginning of the session. This issue has been addressed in commit `298576d9` which is included in release version 3.0.0. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "goToMain/libosdp",
  "patch_hash": "298576d9214b48214092eebdd892ec77be085e5a",
  "patch_info": {
    "commit_hash": "298576d9214b48214092eebdd892ec77be085e5a",
    "repo": "goToMain/libosdp",
    "commit_url": "https://github.com/goToMain/libosdp/commit/298576d9214b48214092eebdd892ec77be085e5a",
    "files": [
      "src/osdp_cp.c",
      "src/osdp_pd.c"
    ],
    "message": "cp: disallow unexpected SC responses\n\nWhen CP has a secure channel active, it should never receive a\nREPLY_CCRYPT or REPLY_RMAC_I. Since these responses change the SC state,\nlet's also make sure that they are accepted only when they are\nexpected: in response to commands CMD_CHLNG and CMD_SCRYPT respectively.\n\nSince this incident has some security implication, let's increase the\nlog level of such out-of-order messages to EMERGENCY so they can be\ntriaged appropriately.\n\nReported-by: Eran Jacob <eran.jacob@otorio.com>\nSigned-off-by: Siddharth Chandrasekaran <sidcha.dev@gmail.com>",
    "before_after_code_files": [
      "src/osdp_cp.c||src/osdp_cp.c",
      "src/osdp_pd.c||src/osdp_pd.c"
    ]
  },
  "patch_diff": {
    "src/osdp_cp.c||src/osdp_cp.c": [
      "File: src/osdp_cp.c -> src/osdp_cp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "639:   ret = osdp_file_cmd_stat_decode(pd, buf + pos, len);",
      "640:   break;",
      "641:  case REPLY_CCRYPT:",
      "642:   if (len != REPLY_CCRYPT_DATA_LEN) {",
      "643:    break;",
      "644:   }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "642:   if (sc_is_active(pd) || pd->cmd_id != CMD_CHLNG) {",
      "643:    LOG_EM(\"Out of order REPLY_CCRYPT; has PD gone rogue?\");",
      "644:    break;",
      "645:   }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "654:   ret = OSDP_CP_ERR_NONE;",
      "655:   break;",
      "656:  case REPLY_RMAC_I:",
      "657:   if (len != REPLY_RMAC_I_DATA_LEN) {",
      "658:    break;",
      "659:   }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "661:   if (sc_is_active(pd) || pd->cmd_id != CMD_SCRYPT) {",
      "662:    LOG_EM(\"Out of order REPLY_RMAC_I; has PD gone rogue?\");",
      "663:    break;",
      "664:   }",
      "",
      "---------------"
    ],
    "src/osdp_pd.c||src/osdp_pd.c": [
      "File: src/osdp_pd.c -> src/osdp_pd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "621:   if (sc_is_active(pd)) {",
      "622:    pd->reply_id = REPLY_NAK;",
      "623:    pd->ephemeral_data[0] = OSDP_PD_NAK_SC_COND;",
      "625:    break;",
      "626:   }",
      "627:   memcpy(pd->sc.cp_cryptogram, buf + pos, CMD_SCRYPT_DATA_LEN);",
      "",
      "[Removed Lines]",
      "624:    LOG_WRN(\"Out of order CMD_SCRYPT; has CP gone rogue?\");",
      "",
      "[Added Lines]",
      "624:    LOG_EM(\"Out of order CMD_SCRYPT; has CP gone rogue?\");",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8146dfb7232367bb3ae712440cb87461359f9084",
      "candidate_info": {
        "commit_hash": "8146dfb7232367bb3ae712440cb87461359f9084",
        "repo": "goToMain/libosdp",
        "commit_url": "https://github.com/goToMain/libosdp/commit/8146dfb7232367bb3ae712440cb87461359f9084",
        "files": [
          "src/osdp_cp.c",
          "src/osdp_pd.c"
        ],
        "message": "cp: disallow unexpected SC responses\n\nWhen CP has a secure channel active, it should never receive a\nREPLY_CCRYPT or REPLY_RMAC_I. Since these responses change the SC state,\nlet's also make sure that they are accepted only when they are\nexpected: in response to commands CMD_CHLNG and CMD_SCRYPT respectively.\n\nSince this incident has some security implication, let's increase the\nlog level of such out-of-order messages to EMERGENCY so they can be\ntriaged appropriately.\n\nReported-by: Eran Jacob <eran.jacob@otorio.com>\nSigned-off-by: Siddharth Chandrasekaran <sidcha.dev@gmail.com>\n(cherry picked from commit 298576d9214b48214092eebdd892ec77be085e5a)",
        "before_after_code_files": [
          "src/osdp_cp.c||src/osdp_cp.c",
          "src/osdp_pd.c||src/osdp_pd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/osdp_cp.c||src/osdp_cp.c",
            "src/osdp_pd.c||src/osdp_pd.c"
          ],
          "candidate": [
            "src/osdp_cp.c||src/osdp_cp.c",
            "src/osdp_pd.c||src/osdp_pd.c"
          ]
        }
      },
      "candidate_diff": {
        "src/osdp_cp.c||src/osdp_cp.c": [
          "File: src/osdp_cp.c -> src/osdp_cp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "639:   ret = osdp_file_cmd_stat_decode(pd, buf + pos, len);",
          "640:   break;",
          "641:  case REPLY_CCRYPT:",
          "642:   if (len != REPLY_CCRYPT_DATA_LEN) {",
          "643:    break;",
          "644:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "642:   if (sc_is_active(pd) || pd->cmd_id != CMD_CHLNG) {",
          "643:    LOG_EM(\"Out of order REPLY_CCRYPT; has PD gone rogue?\");",
          "644:    break;",
          "645:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "654:   ret = OSDP_CP_ERR_NONE;",
          "655:   break;",
          "656:  case REPLY_RMAC_I:",
          "657:   if (len != REPLY_RMAC_I_DATA_LEN) {",
          "658:    break;",
          "659:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "661:   if (sc_is_active(pd) || pd->cmd_id != CMD_SCRYPT) {",
          "662:    LOG_EM(\"Out of order REPLY_RMAC_I; has PD gone rogue?\");",
          "663:    break;",
          "664:   }",
          "",
          "---------------"
        ],
        "src/osdp_pd.c||src/osdp_pd.c": [
          "File: src/osdp_pd.c -> src/osdp_pd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "621:   if (sc_is_active(pd)) {",
          "622:    pd->reply_id = REPLY_NAK;",
          "623:    pd->ephemeral_data[0] = OSDP_PD_NAK_SC_COND;",
          "625:    break;",
          "626:   }",
          "627:   memcpy(pd->sc.cp_cryptogram, buf + pos, CMD_SCRYPT_DATA_LEN);",
          "",
          "[Removed Lines]",
          "624:    LOG_WRN(\"Out of order CMD_SCRYPT; has CP gone rogue?\");",
          "",
          "[Added Lines]",
          "624:    LOG_EM(\"Out of order CMD_SCRYPT; has CP gone rogue?\");",
          "",
          "---------------"
        ]
      }
    }
  ]
}